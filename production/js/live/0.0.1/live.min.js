define(function(e,t,n){e("zepto");var r=e("config"),i=e("store"),s="",o=r.streaming_api_url,u=30,a=u,f={card:{},latitude:"",longitude:"",accuracy:"",traits:[]},l=!0,c=null,h=function(e){if(l){var t=Object.prototype.toString.call(e),n=(new Date).toString();t!=="[object String]"&&t!=="[object Number]"&&(e=JSON.stringify(e)),console.log(n.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+e)}},p=function(){a=0;var e=JSON.stringify(f);h("Submitting with"+(s?" token("+s+")":"out token")+": "+e),c&&c.abort(),c=$.ajax({type:"post",url:o+"/v3/live/cards"+(s?"?token="+s:""),data:e,success:function(e){var t=JSON.parse(e);t&&(a=0,s!==t&&(h("Got new token: "+t),g.live&&(g.kill(),h("Close current stream.")),a=u),s=t)},error:function(e){s&&h("Repeal token: "+s),s="",a=u}}),!g.live&&s&&(g.init(o+"/v3/live/streaming?token="+s,d,v),h("Streaming with token("+s+")..."))},d=function(e){e&&h("Streaming pops: "+e[e.length-1])},v=function(){h("Streaming is dead.")},m=function(){++a>=u&&p()},g={prvLen:0,nxtIdx:0,http:new XMLHttpRequest,timer:0,pop:null,dead:null,live:!1,init:function(e,t,n){this.live=!0,this.pop=t,this.dead=n,this.http.open("get",e),this.http.onreadystatechange=this.listen,this.http.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){if(g.http.readyState!==4&&g.http.readyState!==3||g.http.readyState===3&&g.http.status!==200||g.http.responseText===null)return;g.http.readyState===4&&g.http.status!==200&&g.kill();while(g.prvLen!==g.http.responseText.length){if(g.http.readyState===4&&g.prvLen===g.http.responseText.length)break;g.prvLen=g.http.responseText.length;var e=g.http.responseText.substring(g.nxtIdx),t=e.split("\n");g.nxtIdx+=e.lastIndexOf("\n")+1,(e[e.length-1]!=="\n"||!t[t.length])&&t.pop(),g.pop&&g.pop(t)}g.http.readyState===4&&g.prvLen===g.http.responseText.length&&g.kill()},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}};window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)});var y=setInterval(m,1e3)});