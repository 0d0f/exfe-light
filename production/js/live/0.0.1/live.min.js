define("live",function(e){"use strict";var t=e("config"),n=e("store"),r="",i=30,s=i,o=!0,u=null,a="",f={card:{id:"",name:"",avatar:"",bio:"",identities:[]},latitude:"",longitude:"",accuracy:"",traits:[]},l=t.streaming_api_url,c=null,h=null,p=null,d=function(e,t){if(o){var n=Object.prototype.toString.call(e),r=(new Date).toString();n!=="[object String]"&&n!=="[object Number]"&&(e=JSON.stringify(e)),console.log(r.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+e),t&&console.table&&console.table(t)}},v=function(){s=0,d("Breathe with"+(r?" token: "+r:"out token")),c&&c.abort(),c=$.ajax({type:"post",url:l+"/v3/live/cards"+(r?"?token="+r:""),data:JSON.stringify(f),success:function(e){var t=e;t&&t.length&&(s=0,r!==t[0]&&(d("Got new token: "+t[0]+", id: "+t[1]),b.live&&(b.kill(),d("Close current stream")),s=i),r=t[0],f.card.id=t[1])},error:function(e){e.status&&e.status>=400&&e.status<=499?(r&&d("Repeal token: "+r),r="",s=i):(s=i-5,d("Network error"))}}),!b.live&&r&&(b.init(l+"/v3/live/streaming?token="+r,m,g),d("Streaming with token: "+r))},m=function(e){if(e&&e.length){var n=JSON.parse(e[e.length-1]);if(n&&n.length){var r={};for(var i in n)n[i].id&&(n[i].id===f.card.id?(f.card.name=n[i].name,f.card.avatar=n[i].avatar,f.card.bio=n[i].bio,f.card.identities=n[i].identities):(n[i].avatar||(n[i].avatar=encodeURI(t.api_url+"/avatar/default?name="+n[i].name)),r[n[i].id]=n[i]));var s={me:x(f.card),others:r},o=JSON.stringify(s);d("Streaming pops: "+o,r),u&&a!==o&&(d("Callback"),u(s),a=o)}else d("Data error")}},g=function(){d("Streaming is dead")},y=function(){S(f.card)&&++s>=i&&v()},b={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(e,t,n){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=t,this.dead=n,this.http=new XMLHttpRequest,this.http.open("post",e),this.http.onreadystatechange=this.listen,this.http.send(),this.timer=setInterval(this.listen,1e3),s=i-3},listen:function(){if(b.http.readyState!==4&&b.http.readyState!==3||b.http.readyState===3&&b.http.status!==200||b.http.responseText===null)return;b.http.readyState===4&&b.http.status!==200&&b.kill();while(b.prvLen!==b.http.responseText.length){if(b.http.readyState===4&&b.prvLen===b.http.responseText.length)break;b.prvLen=b.http.responseText.length;var e=b.http.responseText.substring(b.nxtIdx),t=e.split("\n");b.nxtIdx+=e.lastIndexOf("\n")+1,(e[e.length-1]!=="\n"||!t[t.length])&&t.pop(),b.pop&&b.pop(t)}b.http.readyState===4&&b.prvLen===b.http.responseText.length&&b.kill()},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},w=function(){if(typeof window.DeviceMotionEvent=="undefined")return null;var e=50,t=0,n=0,r=0,i=0,s=0,o=0;window.addEventListener("devicemotion",function(e){t=e.accelerationIncludingGravity.x,n=e.accelerationIncludingGravity.y,r=e.accelerationIncludingGravity.z},!1),setInterval(function(){var u=Math.abs(t-i+n-s+r-o);u>e&&(h&&h(),p&&setTimeout(p,1e3)),i=t,s=n,o=r},100)},E=function(e){return e&&e.external_username&&e.provider?!0:!1},S=function(e){if(e&&e.name&&e.identities&&e.identities.length){for(var t in e.identities)if(E(e.identities[t])===!1)return!1;return!0}},x=function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var n in e)t[n]=x(e[n]);break;case"[object Array]":t=[];for(n in e)t.push(x(e[n]));break;default:t=e}return t},T={init:function(e,t){S(e)?(b.kill(),f.card.name=e.name,f.card.avatar=e.avatar,f.card.bio=e.bio,f.card.identities=x(e.identities),d("Set my card: "+JSON.stringify(f.card))):d("Card error"),t&&(u=t,d("Set callback function")),s=i},shake:function(e,t){h=e,p=t}},N=setInterval(y,1e3),C=w(h,p),k=navigator.geolocation.watchPosition(function(e){e&&e.coords&&e.coords.latitude&&e.coords.longitude&&e.coords.accuracy&&(f.latitude=e.coords.latitude.toString(),f.longitude=e.coords.longitude.toString(),f.accuracy=e.coords.accuracy.toString(),s=i-5,d("Location update: lat = "+f.latitude+", "+"lng = "+f.longitude+", "+"acu = "+f.accuracy))});return window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),T});