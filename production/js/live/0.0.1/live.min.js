define("live",function(e){"use strict";var t=e("config"),n=e("store"),r="",i=30,s=i,o=!1,u=null,a="",f={card:{id:"",name:"",avatar:"",bio:"",identities:[],timestamp:0},latitude:"",longitude:"",accuracy:"",traits:[]},l=Date.now||function(){return(new Date).getTime()},c=t.streaming_api_url,h=null,p=null,d=null,v=function(e,t){if(o){var n=Object.prototype.toString.call(e),r=(new Date).toString();n!=="[object String]"&&n!=="[object Number]"&&(e=JSON.stringify(e)),console.log(r.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+e),t&&console.table&&console.table(t)}},m=function(){s=0,v("Breathe with"+(r?" token: "+r:"out token")),h&&h.abort(),h=$.ajax({type:"post",url:c+"/v3/live/cards"+(r?"?token="+r:""),data:JSON.stringify(f),success:function(e){var t=e;t&&t.length&&(s=0,r!==t[0]&&(v("Got new token: "+t[0]+", id: "+t[1]),w.live&&(w.kill(),v("Close current stream")),s=i),r=t[0],f.card.id=t[1])},error:function(e){e.status&&e.status>=400&&e.status<=499?(r&&v("Repeal token: "+r),r="",s=i):(s=i-5,v("Network error"))}}),!w.live&&r&&(w.init(c+"/v3/live/streaming?token="+r,g,y),v("Streaming with token: "+r))},g=function(e){if(e&&e.length){var n=JSON.parse(e[e.length-1]);if(n&&n.length){var r={};for(var i in n)n[i].id&&(n[i].id===f.card.id?(f.card.name=n[i].name,f.card.avatar=n[i].avatar,f.card.bio=n[i].bio,f.card.identities=n[i].identities,f.card.timestamp=n[i].timestamp):(n[i].avatar||(n[i].avatar=encodeURI(t.api_url+"/avatar/default?name="+n[i].name)),r[n[i].id]=n[i]));var s={me:T(f.card),others:r},o=JSON.stringify(s);v("Streaming pops: "+o,r),u&&a!==o&&(v("Callback"),u(s),a=o)}else v("Data error")}},y=function(){v("Streaming is dead")},b=function(){x(f.card)&&++s>=i&&m()},w={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(e,t,n){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=t,this.dead=n,this.http=new XMLHttpRequest,this.http.open("post",e),this.http.onreadystatechange=this.listen,this.http.send(),this.timer=setInterval(this.listen,1e3),s=i-3},listen:function(){if(w.http.readyState!==4&&w.http.readyState!==3||w.http.readyState===3&&w.http.status!==200||w.http.responseText===null)return;w.http.readyState===4&&w.http.status!==200&&w.kill();while(w.prvLen!==w.http.responseText.length){if(w.http.readyState===4&&w.prvLen===w.http.responseText.length)break;w.prvLen=w.http.responseText.length;var e=w.http.responseText.substring(w.nxtIdx),t=e.split("\n");w.nxtIdx+=e.lastIndexOf("\n")+1,(e[e.length-1]!=="\n"||!t[t.length])&&t.pop(),w.pop&&w.pop(t)}w.http.readyState===4&&w.prvLen===w.http.responseText.length&&w.kill()},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},E=function(){if(typeof window.DeviceMotionEvent=="undefined")return null;var e=50,t=0,n=0,r=0,i=0,s=0,o=0;window.addEventListener("devicemotion",function(e){t=e.accelerationIncludingGravity.x,n=e.accelerationIncludingGravity.y,r=e.accelerationIncludingGravity.z},!1),setInterval(function(){var u=Math.abs(t-i+n-s+r-o);u>e&&(p&&p(),d&&setTimeout(d,1e3)),i=t,s=n,o=r},100)},S=function(e){return e&&e.external_username&&e.provider?!0:!1},x=function(e){if(e&&e.name&&e.identities&&e.identities.length){for(var t in e.identities)if(S(e.identities[t])===!1)return!1;return!0}},T=function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var n in e)t[n]=T(e[n]);break;case"[object Array]":t=[];for(n in e)t.push(T(e[n]));break;default:t=e}return t},N={init:function(e,t){x(e)?(w.kill(),f.card.name=e.name,f.card.avatar=e.avatar,f.card.bio=e.bio,f.card.identities=T(e.identities),f.card.timestamp=l(),v("Set my card: "+JSON.stringify(f.card))):v("Card error"),t&&(u=t,v("Set callback function")),s=i},shake:function(e,t){p=e,d=t}},C=setInterval(b,1e3),k=E(p,d),L=navigator.geolocation.watchPosition(function(e){e&&e.coords&&e.coords.latitude&&e.coords.longitude&&e.coords.accuracy&&(f.latitude=e.coords.latitude.toString(),f.longitude=e.coords.longitude.toString(),f.accuracy=e.coords.accuracy.toString(),s=i-5,v("Location update: lat = "+f.latitude+", "+"lng = "+f.longitude+", "+"acu = "+f.accuracy))});return window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),N});