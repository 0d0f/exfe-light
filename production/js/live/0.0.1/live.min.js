define("live",function(e){"use strict";e("zepto");var t=e("config"),n=e("store"),r="",i=30,s=i,o=!0,u=null,a="",f={card:{id:Math.random()+"",name:"",avatar:"",bio:"",identities:[]},latitude:"",longitude:"",accuracy:"",traits:[]},l=t.streaming_api_url,c=null,h=function(e,t){if(o){var n=Object.prototype.toString.call(e),r=(new Date).toString();n!=="[object String]"&&n!=="[object Number]"&&(e=JSON.stringify(e)),console.log(r.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+e),t&&console.table&&console.table(t)}},p=function(){s=0,h("Breathe with"+(r?" token: "+r:"out token")),c&&c.abort(),c=$.ajax({type:"post",url:l+"/v3/live/cards"+(r?"?token="+r:""),data:JSON.stringify(f),success:function(e){var t=JSON.parse(e);t&&(s=0,r!==t&&(h("Got new token: "+t),g.live&&(g.kill(),h("Close current stream")),s=i),r=t)},error:function(e){e.status&&e.status>=400&&e.status<=499?(r&&h("Repeal token: "+r),r="",s=i):(s=i-5,h("Network error"))}}),!g.live&&r&&(g.init(l+"/v3/live/streaming?token="+r,d,v),h("Streaming with token: "+r))},d=function(e){if(e&&e.length){var t=JSON.parse(e[e.length-1]);if(t&&t.length){var n=[];for(var r in t)t[r].id&&(t[r].id===f.card.id?(f.card.name=t[r].name,f.card.avatar=t[r].avatar,f.card.bio=t[r].bio,f.card.identities=t[r].identities):n.push(t[r]));var i={me:w(f.card),others:n},s=JSON.stringify(i);h("Streaming pops: "+s,n),u&&a!==s&&(h("Callback"),u(i),a=s)}else h("Data error")}},v=function(){h("Streaming is dead")},m=function(){b(f.card)&&++s>=i&&p()},g={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(e,t,n){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=t,this.dead=n,this.http=new XMLHttpRequest,this.http.open("get",e),this.http.onreadystatechange=this.listen,this.http.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){if(g.http.readyState!==4&&g.http.readyState!==3||g.http.readyState===3&&g.http.status!==200||g.http.responseText===null)return;g.http.readyState===4&&g.http.status!==200&&g.kill();while(g.prvLen!==g.http.responseText.length){if(g.http.readyState===4&&g.prvLen===g.http.responseText.length)break;g.prvLen=g.http.responseText.length;var e=g.http.responseText.substring(g.nxtIdx),t=e.split("\n");g.nxtIdx+=e.lastIndexOf("\n")+1,(e[e.length-1]!=="\n"||!t[t.length])&&t.pop(),g.pop&&g.pop(t)}g.http.readyState===4&&g.prvLen===g.http.responseText.length&&g.kill()},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},y=function(e){return e&&e.external_username&&e.provider?!0:!1},b=function(e){if(e&&e.name&&e.identities&&e.identities.length){for(var t in e.identities)if(y(e.identities[t])===!1)return!1;return!0}},w=function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var n in e)t[n]=w(e[n]);break;case"[object Array]":t=[];for(n in e)t.push(w(e[n]));break;default:t=e}return t},E={init:function(e,t){b(e)?(f.card.name=e.name,f.card.avatar=e.avatar,f.card.bio=e.bio,f.card.identities=w(e.identities),h("Set my card: "+JSON.stringify(f.card))):h("Card error"),t&&(u=t,h("Set callback function"))}},S=setInterval(m,1e3),x=navigator.geolocation.watchPosition(function(e){e&&e.coords&&e.coords.latitude&&e.coords.longitude&&e.coords.accuracy&&(f.latitude=e.coords.latitude.toString(),f.longitude=e.coords.longitude.toString(),f.accuracy=e.coords.accuracy.toString(),s=i-5,h("Location update: lat = "+f.latitude+", "+"lng = "+f.latitude+", "+"acu = "+f.accuracy))});return window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),E});