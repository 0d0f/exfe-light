define("live",function(t){"use strict";function e(){navigator.geolocation.clearWatch(O)}function n(){O=navigator.geolocation.watchPosition(function(t){t&&t.coords&&t.coords.latitude&&t.coords.longitude&&t.coords.accuracy&&(p.latitude=""+t.coords.latitude,p.longitude=""+t.coords.longitude,p.accuracy=""+t.coords.accuracy,u=a-5,v("Location update: lat = "+p.latitude+", "+"lng = "+p.longitude+", "+"acu = "+p.accuracy))})}var i=window._ENV_,r=i.streaming_api_url,s=i.api_url;t("store");var o="",a=30,u=a,c=!1,l=null,h="",p={card:{id:"",name:"",avatar:"",bio:"",identities:[],timestamp:0},latitude:"",longitude:"",accuracy:"",traits:[]},f=Date.now||function(){return(new Date).getTime()},r=r,d=null,m=null,g=null,v=function(t,e){if(c){var n=Object.prototype.toString.call(t),i=""+new Date;"[object String]"!==n&&"[object Number]"!==n&&(t=JSON.stringify(t)),console.log(i.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+t),e&&console.table&&console.table(e)}},y=function(){u=0,v("Breathe with"+(o?" token: "+o:"out token")),d&&d.abort(),d=$.ajax({type:"post",url:r+"/v3/live/cards"+(o?"?token="+o:""),data:JSON.stringify(p),success:function(t){var e=t;e&&e.length&&(u=0,o!==e[0]&&(v("Got new token: "+e[0]+", id: "+e[1]),k.live&&(k.kill(),v("Close current stream")),u=a),o=e[0],p.card.id=e[1])},error:function(t){t.status&&t.status>=400&&499>=t.status?(o&&v("Repeal token: "+o),o="",u=a):(u=a-5,v("Network error"))}}),!k.live&&o&&(k.init(r+"/v3/live/streaming?token="+o,b,w),v("Streaming with token: "+o))},b=function(t){var e=JSON.parse(t);if(e&&e.length){var n={};for(var i in e)e[i].id&&(e[i].id===p.card.id?(p.card.name=e[i].name,p.card.avatar=e[i].avatar,p.card.bio=e[i].bio,p.card.identities=e[i].identities,p.card.timestamp=e[i].timestamp):(e[i].avatar||(e[i].avatar=encodeURI(s+"/avatar/default?name="+e[i].name)),n[e[i].id]=e[i]));var r={me:T(p.card),others:n},o=JSON.stringify(r);v("Streaming pops: "+o,n),l&&h!==o&&(v("Callback"),l(r),h=o)}else v("Data error")},w=function(){v("Streaming is dead")},x=function(){_(p.card)&&++u>=a&&y()},k={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(t,e,n){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=e,this.dead=n,this.http=new XMLHttpRequest,this.http.open("post",t),this.http.onreadystatechange=this.listen,this.http.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){if(!(4!==k.http.readyState&&3!==k.http.readyState||3===k.http.readyState&&200!==k.http.status||null===k.http.responseText)){for(4===k.http.readyState&&200!==k.http.status&&k.kill();k.prvLen!==k.http.responseText.length&&(4!==k.http.readyState||k.prvLen!==k.http.responseText.length);){k.prvLen=k.http.responseText.length;var t=k.http.responseText.substring(k.nxtIdx),e=t.split("\n");if(k.nxtIdx+=t.lastIndexOf("\n")+1,"\n"===t[t.length-1]&&e[e.length]||e.pop(),k.pop&&e&&e.length)for(var n;(n=e.shift())&&n.length;)k.pop(n)}4===k.http.readyState&&k.prvLen===k.http.responseText.length&&k.kill()}},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},E=function(){if(window.DeviceMotionEvent===void 0)return null;var t=50,e=0,n=0,i=0,r=0,s=0,o=0;window.addEventListener("devicemotion",function(t){e=t.accelerationIncludingGravity.x,n=t.accelerationIncludingGravity.y,i=t.accelerationIncludingGravity.z},!1),setInterval(function(){var a=Math.abs(e-r+n-s+i-o);a>t&&(m&&m(),g&&setTimeout(g,1e3)),r=e,s=n,o=i},100)},S=function(t){return t&&t.external_username&&t.provider?!0:!1},_=function(t){if(t&&t.name&&t.identities&&t.identities.length){for(var e in t.identities)if(S(t.identities[e])===!1)return!1;return!0}},T=function(t){switch(Object.prototype.toString.call(t)){case"[object Object]":var e={};for(var n in t)e[n]=T(t[n]);break;case"[object Array]":e=[];for(n in t)e.push(T(t[n]));break;default:e=t}return e},N={init:function(t,e){_(t)?(k.kill(),p.card.name=t.name,p.card.avatar=t.avatar,p.card.bio=t.bio,p.card.identities=T(t.identities),p.card.timestamp=f(),v("Set my card: "+JSON.stringify(p.card))):v("Card error"),e&&(l=e,v("Set callback function")),u=a},shake:function(t,e){m=t,g=e},startGeo:n,stopGeo:e};setInterval(x,1e3),E(m,g);var O;return window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),N});