define("live",function(e){"use strict";function t(){navigator.geolocation.clearWatch(M)}function i(){M=navigator.geolocation.watchPosition(function(e){e&&e.coords&&e.coords.latitude&&e.coords.longitude&&e.coords.accuracy&&(h.latitude=""+e.coords.latitude,h.longitude=""+e.coords.longitude,h.accuracy=""+e.coords.accuracy,l=o-5,v("Location update: lat = "+h.latitude+", "+"lng = "+h.longitude+", "+"acu = "+h.accuracy))})}var n=window._ENV_,r=n.streaming_api_url,a=n.api_url;e("store");var s="",o=30,l=o,c=!1,u=null,d="",h={card:{id:"",name:"",avatar:"",bio:"",identities:[],timestamp:0},latitude:"",longitude:"",accuracy:"",traits:[]},p=Date.now||function(){return(new Date).getTime()},r=r,f=null,m=null,g=null,v=function(e,t){if(c){var i=Object.prototype.toString.call(e),n=""+new Date;"[object String]"!==i&&"[object Number]"!==i&&(e=JSON.stringify(e)),console.log(n.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+e),t&&console.table&&console.table(t)}},y=function(){l=0,v("Breathe with"+(s?" token: "+s:"out token")),f&&f.abort(),f=$.ajax({type:"post",url:r+"/v3/live/cards"+(s?"?token="+s:""),data:JSON.stringify(h),success:function(e){var t=e;t&&t.length&&(l=0,s!==t[0]&&(v("Got new token: "+t[0]+", id: "+t[1]),w.live&&(w.kill(),v("Close current stream")),l=o),s=t[0],h.card.id=t[1])},error:function(e){e.status&&e.status>=400&&499>=e.status?(s&&v("Repeal token: "+s),s="",l=o):(l=o-5,v("Network error"))}}),!w.live&&s&&(w.init(r+"/v3/live/streaming?token="+s,_,b),v("Streaming with token: "+s))},_=function(e){var t=JSON.parse(e);if(t&&t.length){var i={};for(var n in t)t[n].id&&(t[n].id===h.card.id?(h.card.name=t[n].name,h.card.avatar=t[n].avatar,h.card.bio=t[n].bio,h.card.identities=t[n].identities,h.card.timestamp=t[n].timestamp):(t[n].avatar||(t[n].avatar=encodeURI(a+"/avatar/default?name="+t[n].name)),i[t[n].id]=t[n]));var r={me:T(h.card),others:i},s=JSON.stringify(r);v("Streaming pops: "+s,i),u&&d!==s&&(v("Callback"),u(r),d=s)}else v("Data error")},b=function(){v("Streaming is dead")},x=function(){C(h.card)&&++l>=o&&y()},w={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(e,t,i){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=t,this.dead=i,this.http=new XMLHttpRequest,this.http.open("post",e),this.http.onreadystatechange=this.listen,this.http.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){if(!(4!==w.http.readyState&&3!==w.http.readyState||3===w.http.readyState&&200!==w.http.status||null===w.http.responseText)){for(4===w.http.readyState&&200!==w.http.status&&w.kill();w.prvLen!==w.http.responseText.length&&(4!==w.http.readyState||w.prvLen!==w.http.responseText.length);){w.prvLen=w.http.responseText.length;var e=w.http.responseText.substring(w.nxtIdx),t=e.split("\n");if(w.nxtIdx+=e.lastIndexOf("\n")+1,"\n"===e[e.length-1]&&t[t.length]||t.pop(),w.pop&&t&&t.length)for(var i;(i=t.shift())&&i.length;)w.pop(i)}4===w.http.readyState&&w.prvLen===w.http.responseText.length&&w.kill()}},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},k=function(){if(window.DeviceMotionEvent===void 0)return null;var e=50,t=0,i=0,n=0,r=0,a=0,s=0;window.addEventListener("devicemotion",function(e){t=e.accelerationIncludingGravity.x,i=e.accelerationIncludingGravity.y,n=e.accelerationIncludingGravity.z},!1),setInterval(function(){var o=Math.abs(t-r+i-a+n-s);o>e&&(m&&m(),g&&setTimeout(g,1e3)),r=t,a=i,s=n},100)},E=function(e){return e&&e.external_username&&e.provider?!0:!1},C=function(e){if(e&&e.name&&e.identities&&e.identities.length){for(var t in e.identities)if(E(e.identities[t])===!1)return!1;return!0}},T=function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var i in e)t[i]=T(e[i]);break;case"[object Array]":t=[];for(i in e)t.push(T(e[i]));break;default:t=e}return t},S={init:function(e,t){C(e)?(w.kill(),h.card.name=e.name,h.card.avatar=e.avatar,h.card.bio=e.bio,h.card.identities=T(e.identities),h.card.timestamp=p(),v("Set my card: "+JSON.stringify(h.card))):v("Card error"),t&&(u=t,v("Set callback function")),l=o},shake:function(e,t){m=e,g=t},startGeo:i,stopGeo:t};setInterval(x,1e3),k(m,g);var M;return window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),S});