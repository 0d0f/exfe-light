define("xdialog",function(e,t){"use strict";var n=e("jquery"),i=e("rex"),r=e("bus"),a=e("api"),s=e("util"),o=e("store"),l=e("handlebars"),c=e("dialog"),u={},d=Date.now||function(){return(new Date).getTime()},h=function(e,t,i){var r,a;e.on("mousedown",i,function(i){if(3===i.which)return!1;var s=n(this);a&&(clearTimeout(a),a=void 0),r=d(),a=setTimeout(function(){e.find(t).prop("type","text"),s.addClass("icon16-pass-show").removeClass("icon16-pass-hide")},500)}).on("mouseup",i,function(i){return a&&(clearTimeout(a),a=void 0),e.find(t).prop("type","password"),n(this).removeClass("icon16-pass-show").addClass("icon16-pass-hide"),i.preventDefault(),i.stopPropagation(),!1})};t.dialogs=u,u.identification={options:{errors:{400:"Username incorrect.",403:"Password incorrect.",500:"Set up this new identity."},onCheckUser:function(){var e=o.get("lastIdentity"),t=o.get("last_external_username");e&&(this.availability=!0,this.$("#identity").val(t),this.$(".x-signin").removeClass("disabled loading"),this.$(".user-identity").removeClass("hide").find("img").attr("src",e.avatar_filename).next().attr("class","provider icon16-identity-"+e.provider),this.$(".xbtn-forgotpwd").data("source",[e]),this.switchTab("d01")),this.$(".help-subject").toggleClass("icon14-question",!this.availability)},onShowBefore:function(e){var t=n(e.currentTarget).data("source");"string"==typeof t?this.$("#identity").val(t):this.emit("checkUser")},onShowAfter:function(){("d00"===this.switchTabType||"d01"===this.switchTabType||"d02"===this.switchTabType)&&this.$("#identity").focusend()},onHideAfter:function(){this.$(".modal-body").eq(0).css("opacity",1),this.switchTabType="d00",this._oauth_&&(this._oauth_.abort(),this._oauth_=null),this.destory(),n(".popmenu").remove()},events:{"keypress .modal-main":function(e){var t=this.switchTabType,n=e.keyCode;!this.availability||"d01"!==t&&"d02"!==t||13!==n||this.$(".x-signin").click()},"click .oauth > a":function(e){e.stopPropagation(),e.preventDefault();var t=this,i=n(e.currentTarget),r=i.data("oauth");t.$(".authentication").find(".oauth-provider").text(r),t._oauth_=n.ajax({url:"/OAuth/Authenticate?provider="+r,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){t.$(".modal-body").eq(0).css("opacity",0),t.switchTab("d05"),t.$(".authentication").find("img").removeClass("hide"),t.$(".authentication").find(".redirecting").removeClass("hide"),t.$(".authentication").find(".xalert-fail").addClass("hide"),t.$(".xbtn-oauth").addClass("hide")},success:function(e){var n=e.meta.code;200===n?window.location.href=e.response.redirect:(t.$(".authentication").find("img").addClass("hide"),t.$(".authentication").find(".redirecting").addClass("hide"),t.$(".authentication").find(".xalert-fail").removeClass("hide"),t.$(".xbtn-oauth").removeClass("hide"))}})},"click .xbtn-oauth":function(){return this.$(".modal-body").eq(0).css("opacity",1),this.switchTab("d00"),!1},"click .xbtn-verify":function(e){var t=this,i=n(e.currentTarget);if(i.hasClass("xbtn-success"))return t.$(".verify-after").addClass("hide"),i.removeClass("xbtn-success").text("Verify"),t.hide(),!1;var r=t._identity.provider,s=t._identity.external_id;a.request("verifyIdentity",{type:"POST",data:{provider:r,external_username:s}},function(e){t.$(".verify-before").addClass("hide"),"VERIFYING"===e.action?(t.$(".verify-after").removeClass("hide"),i.addClass("xbtn-success").text("Done")):i.addClass("verify-error").removeClass("hide")})},"blur #identity":function(e){var t=s.trim(n(e.currentTarget).val()),i=this.$('[for="identity"]'),r=i.find("span");t.length&&!s.parseId(t).provider?(i.addClass("label-error"),r.text("Invalid identity.")):(i.removeClass("label-error"),r.text(""))},"blur #name":function(e){var t=s.trim(n(e.currentTarget).val()),i=this.$('[for="name"]'),r=i.find("span");t?s.utf8length(t)>30?(r.text("Too long."),i.addClass("label-error")):s.zh_CN.test(t)?(i.addClass("label-error"),r.text("Invalid character.")):(i.removeClass("label-error"),r.text("")):(i.addClass("label-error"),r.text(""))},"blur #password":function(e){var t=s.trim(n(e.currentTarget).val()),i=this.$('[for="password"]'),r=i.find("span");t?(i.removeClass("label-error"),r.text("")):(i.addClass("label-error"),r.text("Password incorrect."))},"click .help-subject":function(e){var t,i=n(e.currentTarget);i.hasClass("icon14-question")?(t='Identity is your online representative, such as email, <span class="strike">mobile no.</span>, and your account username on other websites like Twitter, Facebook, etc.',i.parent().find(".xalert-error:eq(0)").html(t).removeClass("hide")):(i.toggleClass("icon14-question icon14-clear"),this.resetInputs(),this.$(".phone-tip").addClass("hide"),this.$(".user-identity").addClass("hide"),o.remove("lastIdentity"),o.remove("last_external_username"),o.remove("authorization"),o.remove("user"),o.remove("identities"),this.$('[data-typeahead-type="identity"]').data("typeahead").source=null,this.switchTab("d00"))},"click .xbtn-forgotpwd":function(e){e.preventDefault(),this.element.addClass("hide"),n("#js-modal-backdrop").addClass("hide")},"click .xbtn-setup":function(e){e.preventDefault(),this.$(".modal-body").eq(0).css("opacity",.05),this.switchTab("d03")},"click .xbtn-isee":function(e){e.preventDefault(),this.$(".modal-body").eq(0).css("opacity",1),this.$("#identity").val(""),this.switchTab("d02")},"click .xbtn-startover":function(e){e.preventDefault(),this.$("#identity").val(""),this.resetInputs(),this.switchTab("d00",!0)},"click .x-signin":function(e){var t=n(e.currentTarget);if(!t.hasClass("disabled")){var i=this,r=this.switchTabType,l=this.getFormData(r);i.$("#password").trigger("blur"),"d02"===r&&i.$("#name").trigger("blur"),l.password&&("d02"!==r||l.name)&&("d01"===r||"d02"===r)&&a.request("signin",{type:"POST",data:{external_username:l.external_username,provider:l.provider,password:l.password,name:l.name||"",auto_signin:!!l.auto_signin},beforeSend:function(){t.addClass("disabled loading")},complete:function(){t.removeClass("disabled loading")}},function(e){if(delete App.request.session.browsing_authorization,delete App.request.session.browsing_user,o.set("authorization",e),o.set("last_external_username",s.printExtUserName(l)),i.hide(),"d01"===r||"d02"===r)window.location.href="/";else{var t=new c(u.welcome);t.render(),t.show({identity:{name:l.name,provider:l.provider}})}},function(e){var t=e.meta&&e.meta.code||400;i.$('[for="password"]').addClass("label-error").find("span").text(i.options.errors[t])})}}},backdrop:!0,viewData:{cls:"modal-id",title:"Start",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><div class="clearfix"><div class="pull-left authorize">Authenticate with:</div><div class="pull-left oauth"><a href="#" class="oauth-twitter" data-oauth="twitter">twitter</a><a href="#" class="oauth-facebook" data-oauth="facebook">facebook</a></div></div><div class="orspliter">or</div><form class="modal-form"><fieldset><legend>Use your online identity:</legend><div class="clearfix control-group"><label class="control-label" for="identity">Identity: <span class="xalert-message"></span></label><div class="pull-right user-identity hide"><div class="avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div></div><div class="controls"><input type="text" class="input-large identity" id="identity" autocomplete="off" data-widget="typeahead" data-typeahead-type="identity" placeholder="Enter your email or phone" /><i class="help-subject"></i><i class="help-inline small-loading hide"></i><div class="xalert xalert-error hide" style="margin-top: 5px;"></div><div class="xalert xalert-error authenticate hide" style="margin-top: 5px;"><span class="xalert-fail">Please directly authenticate identity above.</span><br />To enable password sign-in for this identity, set an <span class="x-sign">EXFE</span> password first in your profile page.</div><div class="xalert phone-tip hide" style="padding: 5px;">Please format phone number with country<br /> code prefix, e.g.: +1 555 450 0303</div></div></div><div class="form-title d d02 hide">Welcome! Please set up your new account.<span class="pull-right form-title-bd"></span></div><div class="control-group d d02 hide"><label class="control-label" for="name">Full name: <span></span></label><div class="controls"><input type="text" class="input-large" id="name" autocomplete="off" placeholder="Desired recognizable name" /></div></div><div class="control-group d d01 d02 hide"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div><div class="control-group d d01 hide"><div class="control-label"><label class="checkbox pointer"><input type="checkbox" id="auto-signin" value="1" checked />Sign in automatically</label></div></div><div class="verify-before d d04 hide"><span class="xalert-fail">This identity requires verification before using.</span><br />Confirm sending verification to your mailbox?</div><div class="verify-after hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div><div class="verify-error hide"><span class="xalert-fail">Requested too much, hold on awhile.</span><br />Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</div></fieldset></form>',footer:'<button class="xbtn-white d d01 xbtn-forgotpwd hide" data-dialog-from="identification" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="xbtn-white d d02 d04 xbtn-startover hide">Start Over</button><button class="pull-right d d04 xbtn-blue xbtn-verify hide">Verify</button><a href="#" class="pull-right xbtn-setup d d00 hide">Looking for sign-up?</a><button class="pull-right xbtn-blue d d01 d02 x-signin disabled hide">Start</button><button class="pull-right xbtn-white d d03 xbtn-isee hide">I See</button><button class="pull-right xbtn-white d hide">OK</button><button class="pull-right xbtn-white d xbtn-oauth hide">Back</button>',others:'<div class="isee d d03 hide"><div class="modal-body"><div class="shadow title">“Sign-Up-Free”</div><p>Tired of signing up all around? Just authorize through your existing accounts from other websites, such as Twitter, <span class="strike">Facebook, Google, etc.</span> (soon to support)</p><p>We hate spam, will NEVER disappoint your trust.</p><p>Alternatively, traditional registration process with email and password is also available.</p></div></div><div class="authentication d d05 hide"><div class="modal-body"><div class="shadow title">Authentication</div><div class="content"><img class="hide" src="/static/img/loading.gif" width="32" height="32" /><p class="redirecting hide">Redirecting to <span class="oauth-provider"></span>…</p><p class="xalert-fail hide">Failed to connect with <span class="oauth-provider"></span> server.</p></div></div></div>'}}},u.sandbox={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-sandbox",title:"Rome",body:'<div class="shadow title">“Rome wasn\'t built in a day.”</div><p><span class="x-sign">EXFE</span> [’ɛksfi] is still in <span class="pilot">pilot</span> period (with <span class="sandbox">Rome</span> tag). We’re building up blocks, consequently something buggy or awkward may happen. Our apologies for any trouble you may encounter. Any feedback, please email <span class="feedback">feedback@exfe.com</span>. Much appreciated.</p>'}}},u.welcome={options:{events:{"click .xbtn-go":function(){var e=this;if("email"===this._provider){if(/^\/![a-zA-z0-9]+$/.test(window.location.pathname))return window.location=window.location.pathname,void 0}else this.$("#follow").prop("checked")&&this._token&&n.ajax({url:"/OAuth/followExfe?token="+this._token,type:"POST",data:{identity_id:this._identity_id},success:function(){o.remove("oauth")}});e.hide()},"click .why":function(){this.$(".answer").toggleClass("hidden")}},onShowBefore:function(e){var t=e.identity,n=this.$(".title").eq(0);this._provider=t.provider,this._identity_id=t.id,this._token=e.token,this._following=e.following,n.text("Hi, "+t.name+"."),"email"===t.provider?this.$(".provider-email").removeClass("hide"):"twitter"===t.provider&&(this.$(".provider-other").removeClass("hide"),this.$("#follow").prop("checked",this._following))},onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-large modal-wc",title:"Welcome",body:'<div class="shadow title"></div><div class="center shadow title" style="margin-bottom: 0;">Thanks for using <span class="x-sign">EXFE</span>.</div><p class="center">The group utility for gathering.</p><div class="modal-content"><p>Save yourself from calling every one RSVP repeatedly, losing in endless emails messages off-the-point.</p><p><span class="x">·X·</span> (cross) is a gathering, for things to do together. <span class="x-sign">EXFE</span> friends for meetings, parties, sports, trips, etc. Anything you want to gather friends to do.</p><p><span class="x-sign">EXFE</span> your friends, Gather a <span class="x">·X·</span>.</p><p class="provider-email hide" style="color: #191919;">*A welcome email has been sent to your email. Please check to verify your address.*</p><div class="provider-other hide">&nbsp;&nbsp;<span class="underline why">why?</span><label class="pull-left checkbox pointer"><input type="checkbox" id="follow" value="1" checked />Follow @<span class="x-sign">EXFE</span> on Twitter.</label><p class="pull-left answer hidden">So we could send you invitation PRIVATELY through Direct Message. We hate spam, will NEVER disappoint your trust.</p></div></div>',footer:'<button class="pull-right xbtn-white xbtn-go">GO</button>'}}},u.forgotpassword={tab:"",updateIdentity:function(e){var t=e.provider,n=this.$(".context-identity");this.$(".tab").addClass("hide"),this.$(".xbtn-done").addClass("hide"),"email"===t?(this.tab="tab0",this.$(".tab0").eq(0).removeClass("hide"),this.$(".xbtn-send").removeClass("hide").data("identity",e)):"phone"===t?(this.tab="tab1",this.$(".tab1").eq(0).removeClass("hide"),this.$(".xbtn-send").removeClass("hide").data("identity",e)):(this.tab="tab2",this.$(".tab2").eq(0).removeClass("hide"),this.$(".authenticate").removeClass("hide").data("identity",e),this.$(".provider-text").text(t.substr(0,1).toUpperCase()+t.substr(1))),n.find(".avatar img").attr("src",e.avatar_filename),n.find(".provider").attr("class","provider icon16-identity-"+t),n.find(".identity").text(e.eun)},options:{onHideAfter:function(e){if(this.befer&&(this.befer.abort(),this.befer=null),e){var t=this.dialog_from;t&&n('[data-dialog-type="'+t+'"]').data("dialog").hide()}this.destory()},events:{"click .authenticate":function(e){var t=this,i=n(e.currentTarget),r=i.data("identity");r&&(t.befer=a.request("forgotPassword",{type:"POST",data:{provider:r.provider,external_username:r.external_username},beforeSend:function(){t.$(".authenticate-before.tab2").removeClass("hide"),i.addClass("disabled")},complete:function(){i.removeClass("disabled")}},function(e){"REDIRECT"===e.action&&(window.location.href=e.url)}))},"click .caret-outer":function(e){this.$(".dropdown-toggle").addClass("open"),e.stopPropagation()},"hover .dropdown-menu > li":function(e){var t=e.type,i=n(e.currentTarget);i[("mouseenter"===t?"add":"remove")+"Class"]("active")},"click .dropdown-menu > li":function(e){var t=this.$(".dropdown-menu").data("identities"),i=n(e.currentTarget).data("index");this.updateIdentity(t[i])},"click .xbtn-cancel":function(){var e=this.dialog_from;this.hide(),e&&(n('[data-dialog-type="'+e+'"]').data("dialog").element.removeClass("hide"),n("#js-modal-backdrop").removeClass("hide"))},"click .xbtn-done":function(e){this.hide(e)},"click .xbtn-send":function(e){var t=this,i=t.tab,r=n(e.currentTarget);if(!r.hasClass("disabled")){var s=r.data("identity");s&&(t.befer=a.request("forgotPassword",{type:"POST",data:{provider:s.provider,external_username:s.external_username},beforeSend:function(){t.$(".send-before."+i).removeClass("hide"),t.$(".send-after."+i).addClass("hide"),r.addClass("disabled")},complete:function(){t.$(".send-before."+i).addClass("hide"),t.$(".send-after."+i).removeClass("hide"),r.removeClass("disabled")}},function(e){"VERIFYING"===e.action&&(t.$(".identity").next().removeClass("hide"),r.addClass("hide"),t.$(".xbtn-done").removeClass("hide"),t.$(".send-before."+i).addClass("hide"),t.$(".send-after."+i).removeClass("hide"))}))}}},onShowBefore:function(e){var t,i,r,a=this,s=n(e.currentTarget).data("source"),o="email phone facebook twitter";if(s&&(t=s.length)){if(i=s[0],r=i.external_username,"twitter"===i.provider&&(r="@"+i.external_username),i.eun=r,t>1){a.$(".context-identity").addClass("switcher");for(var l="",c=0;t>c;c++){var u=s[c].provider;0>o.search(u)||(r=s[c].external_username,l+='<li data-index="'+c+'"><i class="pull-right icon16-identity-'+u+'"></i>',"twitter"===s[c].provider&&(r="@"+s[c].external_username),s[c].eun=r,l+="<span>"+r+"</span>",l+="</li>")}a.$(".dropdown-menu").html(l).data("identities",s)}this.updateIdentity(i)}},backdrop:!1,viewData:{cls:"mblack modal-fp",title:"Forgot Password",body:'<div class="shadow title">Forgot Password</div><div>You can reset your <span class="x-sign">EXFE</span> password through identity:</div><div class="context-identity"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="clearfix dropdown-toggle" data-toggle="dropdown"><div class="pull-left box identity"></div><ul class="dropdown-menu"></ul><div class="pull-left caret-outer hide"><b class="caret"></b></div></div></div><div class="alert-label"><div class="send-before tab tab0 hide">Confirm sending reset token to your mailbox?</div><div class="send-after tab tab0 hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div><div class="send-before tab tab1 hide">Confirm sending reset token to your phone?</div><div class="send-after tab tab1 hide">Verification sent, it should arrive in minutes.</div><div class="xalert-error tab hide"><p>Requested too much, hold on awhile.</p><p>Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</p></div><div class="authenticate-before tab tab2 hide">You will be directed to <span class="provider-text"></span> website to authenticate identity above, you can reset password then.</div></div>',footer:'<button class="pull-right xbtn-white xbtn-done hide">Done</button><button class="pull-right xbtn-blue xbtn-send tab tab0 tab1 hide">Send</button><button class="pull-right xbtn-blue authenticate tab tab2 hide">Authenticate</button><a class="pull-right xbtn-cancel">Cancel</a>'}}},u.changepassword={options:{onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},events:{"click .xbtn-resetpwd":function(e){var t=o.get("user"),r=t.identities,a=i.filter(r,function(e){return"CONNECTED"===e.status?!0:void 0});if(1===a.length){e.stopPropagation(),this.hide();var s=new c(u.forgotpassword);s.dialog_from="changepassword",s.render(),n(e.currentTarget).data("identity-id",a[0].id),s.show(e)}},"click .xbtn-forgotpwd":function(e){var t=o.get("user"),r=t.identities,a=r.length,s=[];1===a?s.push(r[0]):i.each(r,function(e){var t=e.status;("CONNECTED"===t||"REVOKED"===t)&&s.push(e)}),n(e.currentTarget).data("source",s)},"click .xbtn-success":function(e){var t=this,i=t.$("#cppwd").val(),r=t.$("#cp-npwd").val();if(!i||!r)return i?alert("Please input new password."):alert("Please input current password."),void 0;e.preventDefault();var s=n(e.currentTarget),l=o.get("authorization"),c=l.user_id,u=l.token;t.befer=a.request("setPassword",{type:"POST",params:{token:u},resources:{user_id:c},data:{current_password:i,new_password:r},beforeSend:function(){s&&s.addClass("disabled loading")},complete:function(){s&&s.removeClass("disabled loading")}},function(e){o.set("authorization",e),t&&t.destory()},function(e){var n=e&&e.meta;if(n)if(403===n.code){var i=e.meta.errorType;"invalid_current_password"===i&&alert("Invalid current password.")}else 401===n.code&&"authenticate_timeout"===n.errorType&&t&&t.destory()})}},onShowBefore:function(){h(this.element,"#cppwd","#cppwd-eye"),h(this.element,"#cp-npwd","#cp-npwd-eye");var e=o.get("user");this.$(".avatar > img").attr("src",e.avatar_filename),this.$(".username").text(e.name)},backdrop:!1,viewData:{cls:"modal-cp mblack modal-large",title:"Change Password",body:'<div class="shadow title">Change Password</div><form class="modal-form"><fieldset><legend>Enter your current <span class="x-sign">EXFE</span> password, and set new one. All your identities share the same password for sign-in and account management.</legend><div class="clearfix context-user"><div class="pull-left avatar"><img src="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="control-group"><label class="control-label" for="cppwd">Password:</label><div class="controls"><input class="input-large" id="cppwd" placeholder="Current password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer" id="cppwd-eye"></i></div></div><div class="control-group"><label class="control-label" for="cp-npwd">New Password:</label><div class="controls"><input class="input-large" id="cp-npwd" placeholder="Set new EXFE password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer" id="cp-npwd-eye"></i></div></div></fieldset></form>',footer:'<button class="xbtn-white xbtn-forgotpwd" data-dialog-from="changepassword" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn-blue xbtn-success">Change</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Discard</a>'}}},u.addidentity={options:{errors:{failed:"Password incorrect.",no_password:"Password incorrect.",no_external_id:"Set up this new identity."},backdrop:!1,submitStatus:!0,events:{"submit .modal-form":function(){return this.submitStatus&&(this.$(".xbtn-add").trigger("click"),this.submitStatus=!1),!1},"click .xbtn-cancel":function(){this.destory()},"click .xbtn-add":function(e){e.preventDefault();var t=this,r=t.result;if(!r)return!1;var a=r.registration_flag,s=r.identity,c=s.provider,u=s.external_username,d=o.get("user"),h=d.identities;if("AUTHENTICATE"!==a){if(i.find(h,function(e){return e.provider===c&&e.external_username===u?!0:void 0}))return t.destory(),void 0;var p=t.addIdentity;p({external_username:u,provider:c},t,null,function(e){var t=e.identity;h.push(t),o.set("user",d);var i=l.compile(n("#jst-identity-item").html()),r=i(e.identity);n(".identity-list").append(r);var a=n(".modal-ai");a.find("#identity").prop("disabled",!0),a.find(".xbtn-add").addClass("hide"),a.find(".help-subject").addClass("im-hide"),a.find(".phone-tip").addClass("hide"),a.find(".success-tip").removeClass("hide"),a.find(".xbtn-done").removeClass("hide").focus()})}else t.$('.oauth > a[data-oauth="'+c+'"]').trigger("click")},"click .xbtn-done":function(){this.hide()},"click .help-subject":function(e){e.preventDefault(),this.$(".user-identity").addClass("hide"),this.$(".help-subject").addClass("im-hide"),this.reset(),this.$("#identity").val("").focus()},"click .oauth > a":function(e){e.preventDefault();var t,i=this.result,r="",a=this;if(i){var s=i.identity;t=s.provider,r=s.external_username}else t=n(e.target).data("oauth");a.$(".authentication").find(".oauth-provider").text(t);var o=a.addIdentity;return o({refere:window.location.href,external_username:r,provider:t},a,function(){a.$(".modal-body").eq(0).css("opacity",0),a.switchTab("d1"),a.$(".authentication").find("img").removeClass("hide"),a.$(".authentication").find(".redirecting").removeClass("hide"),a.$(".authentication").find(".xalert-fail").addClass("hide")},function(e){window.location.href=e.url,a&&a.destory()}),!1}},onShowBefore:function(){this.element.removeClass("hide"),this.$("#identity").focusend()},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},viewData:{cls:"mblack modal-id modal-ai",title:"Add Identity",body:'<div class="shadow title">Add Identity</div><div class="clearfix"><div class="pull-left authorize">Authenticate with:</div><div class="pull-left oauth"><a href="#" class="oauth-twitter" data-oauth="twitter">twitter</a><a href="#" class="oauth-facebook" data-oauth="facebook">facebook</a><a href="#" class="oauth-dropbox hide" data-oauth="dropbox">dropbox</a><a href="#" class="oauth-flickr hide" data-oauth="flickr">flickr</a><a href="#" class="oauth-instagram hide" data-oauth="instagram">instagram</a></div></div><div class="orspliter">or</div><form class="modal-form"><fieldset><legend>Enter identity manually:</legend><div class="clearfix control-group"><label class="control-label" for="identity">Identity: <span class="xalert-message"></span></label><div class="pull-right user-identity hide"><div class="avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div></div><div class="controls"><input type="text" class="input-large identity" id="identity" autocomplete="off" data-widget="typeahead" data-typeahead-type="identity" placeholder="Enter your email or phone" /><i class="help-subject icon14-clear im-hide"></i><i class="help-inline small-loading hide"></i><div class="xalert xalert-error hide" style="margin-top: 5px;"></div><div class="xalert xalert-error authenticate hide" style="margin-top: 5px;"><span class="xalert-fail">Please directly authenticate identity above.</span><br />To enable password sign-in for this identity, set an <span class="x-sign">EXFE</span> password first in your profile page.</div><div class="xalert phone-tip hide" style="padding: 5px;">Please format phone number with country<br /> code prefix, e.g.: +1 555 450 0303</div><div class="xalert success-tip hide" style="padding: 5px;">Add identity request is sent, it should arrive in minutes. Please check your email for instructions.</div></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue xbtn-add d d0">Add</button><button class="pull-right xbtn-white xbtn-done d d0 hide">Done</button><a class="pull-right xbtn-cancel d d0">Cancel</a>',others:'<div class="authentication d d1 hide"><div class="modal-body"><div class="shadow title">Authentication</div><div class="content"><img class="hide" src="/static/img/loading.gif" width="32" height="32" /><p class="redirecting hide">Redirecting to <span class="oauth-provider"></span>…</p><p class="xalert-fail hide">Failed to connect with <span class="oauth-provider"></span> server.</p></div></div></div>'}},addIdentity:function p(e,t,i,r){var s=o.get("authorization"),l=s.token,c=a.request("addIdentity",{type:"POST",params:{token:l},data:e,beforeSend:function(){i&&i()}},function(e){r&&r(e)},function(i){var r=i&&i.meta;if(r&&401===r.code&&"authenticate_timeout"===r.errorType){var a=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(a);var s=n.Event("click.dialog.data-api");s._data={callback:function(){p({external_username:e.external_username,provider:e.provider})}},t&&t.destory(),a.trigger(s)}});t&&(t.defer=c)},switchTab:function(e){this.$(".d").not(".hide").addClass("hide").end().filter("."+e).removeClass("hide"),this.switchTabType=e},reset:function(){this.result=null},init:function(){var e=this;r.off("widget-dialog-identification-auto"),r.on("widget-dialog-identification-auto",function(t){var n=e.result=t;if(e&&e.$(".help-subject")[(n?"remove":"add")+"Class"]("im-hide"),n){var i=n.identity;i&&i.avatar_filename&&e.$(".user-identity").removeClass("hide").find("img").attr("src",i.avatar_filename).next().attr("class","provider icon16-identity-"+i.provider),i||e.reset(),e.$(".phone-tip").toggleClass("hide","phone"!==i.provider)}}),r.off("widget-dialog-identification-nothing"),r.on("widget-dialog-identification-nothing",function(){e.$(".phone-tip").addClass("hide")})}},u.addIdentityAfterSignIn={options:{events:{"click .xbtn-cancel":function(){this.destory()},"click .xbtn-add":function(){var e=this,t=o.get("authorization"),i=t.token,r=this._identity.external_username,s=this._identity.provider;a.request("addIdentity",{type:"POST",params:{token:i},data:{external_username:r,provider:s}},function(t){var n=t.identity,i=o.get("user"),r=i.identities;r.push(n),o.set("user",i),e.destory(),window.location.href="/"},function(t){var i=t&&t.meta;if(i&&401===i.code&&"authenticate_timeout"===i.errorType){e.destory();var r=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(r),r.trigger("click.dialog.data-api")}})}},backdrop:!1,viewData:{cls:"mblack modal-aifsi",title:"Set Up Account",body:'<div class="shadow title">Add Identity</div><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div>Please authorize identity underneath through Twitter to add into your account above.</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div>',footer:'<button class="pull-right xbtn-blue xbtn-add">Add</button><a class="pull-right xbtn-cancel">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source"),i=t.identity,r=o.get("user");this._identity=i,this.$(".context-user").find("img").attr("src",r.avatar_filename).parent().next().text(r.name),this.$(".context-identity").find("img").attr("src",i.avatar_filename).next().addClass("icon16-identity-"+i.provider),this.$(".identity").text(s.printExtUserName(i)),"email"!==i.provider&&this.$(".xbtn-done").text("Authorize")}}},u.mergeidentity={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-donot":function(){this.hide()},"click .xbtn-merge":function(){var e=this,t=this.$(".merge-list").find("input:checked"),n=[];if(t.length){for(var i=0,r=t.length;r>i;++i)n.push(t.eq(i).parents("li").data("identity-id"));return a.request("mergeIdentities",{type:"POST",params:{token:this.browsing_token},data:{identity_ids:"["+(""+n)+"]"}},function(){e.hide(),window.location.href="/"}),void 0}this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-mi",title:"Merge Identity",body:'<div class="shadow title">Merge Identity</div><div>You just successfully merged identity underneath:</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div><div class="clearfix merge-container"><div class="alert-label">Following identities might also belong to you. Merge them into your current account to avoid switching identities back and forth.</div><div class="merge-list"><ul class="unstyled"></ul></div></div>',footer:'<button class="pull-right xbtn-blue xbtn-merge" style="margin-left: 10px;">Merge</button><button class="pull-right xbtn-white xbtn-donot">Do NOT</button>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source"),i=t.merged_identity,r=t.browsing_token,a=t.mergeable_user,o=a.identities,l='<li class="clearfix" data-identity-id="{{id}}"><label for="identity-{{i}}"><input class="pull-left" id="identity-{{i}}" name="identity-{{i}}" type="checkbox" /><div class="pull-left box identity">{{external_username}}</div><div class="pull-right avatar"><img width="40" height="40" alt="" src="{{avatar_filename}}" /><i class="provider icon16-identity-{{provider}}"></i></div></label></li>',c=this.$(".merge-list ul");this.$(".context-identity").find("img").attr("src",i.avatar_filename),this.$(".context-identity").find(".identity").text(s.printExtUserName(i)),this.browsing_token=r;
for(var u=0,d=o.length;d>u;++u)c.append(n(l.replace("{{id}}",o[u].id).replace(/\{\{i\}\}/g,u).replace("{{external_username}}",s.printExtUserName(o[u])).replace("{{avatar_filename}}",o[u].avatar_filename).replace("{{provider}}",o[u].provider)))}}},u.verification_email={options:{onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},events:{"click .xbtn-verify":function(e){var t=n(e.currentTarget);if(t.hasClass("disabled")||t.hasClass("success"))return t.hasClass("success")&&this.hide(),void 0;var i=this,r=t.data("identity_id"),s=o.get("authorization"),l=s.token;this.befer=a.request("verifyUserIdentity",{type:"POST",params:{token:l},data:{identity_id:r},beforeSend:function(){t.addClass("disabled")},complete:function(){t.removeClass("disabled")}},function(e){i.$(".verify-before").addClass("hide"),"VERIFYING"===e.action?(i.$(".verify-after").removeClass("hide"),t.text("Done").addClass("success")):i.$(".xalert-error").removeClass("hide")})},"click .xbtn-cancel":function(){var e=this.dialog_from;this.hide(),e&&(n('[data-dialog-type="'+e+'"]').trigger("click.dialog.data-api"),n("#identity").focusend())}},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40"><i class="provider icon16-identity-email"></i></div><div class="box identity"></div><p class="verify-before">Confirm sending verification to your mailbox?</p><p class="verify-after hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</p><div class="xalert-error hide"><span class="xalert-fail">Requested too much, hold on awhile.</span><br />Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</div>',footer:'<button class="pull-right xbtn-blue xbtn-verify">Verify</button><a class="pull-right xbtn-cancel">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget),r=t.data("identity-id")||t.parents("li").data("identity-id"),a=o.get("user"),s=i.filter(a.identities,function(e){return e.id===r?!0:void 0})[0];this.$(".xbtn-verify").data("identity_id",s.id),this.$(".identity").text(s.external_id),this.$(".avatar").attr("src",s.avatar_filename)}}},u.verification_oauth={options:{events:{"click .xbtn-verify":function(e){var t=n(e.currentTarget),i=this;if(t.hasClass("disabled")||t.hasClass("success"))return t.hasClass("success")&&this.hide(),void 0;var r=t.data("identity_id"),s=o.get("authorization"),l=s.token;return this.befer=a.request("verifyUserIdentity",{type:"POST",params:{token:l},data:{identity_id:r},beforeSend:function(){t.addClass("disabled")},complete:function(){t.removeClass("disabled")}},function(e){window.location.href=e.url},function(e){var t=e&&e.meta&&e.meta.code;400===t&&i.hide()}),e.preventDefault(),!1},"click .xbtn-cancel":function(){this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40"><i class="provider"></i></div><div class="box identity"></div><p class="xalert-twitter hide">You will be directed to Twitter website to authenticate. Don’t forget to follow @<span class="x-sign">EXFE</span> so we could send you invitation PRIVATELY through Direct Message.</p><p>We hate spam, will NEVER disappoint your trust.</p>',footer:'<button class="pull-right xbtn-blue xbtn-verify">Verify</button><a class="pull-right xbtn-cancel">Cancel</a>'},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},onShowBefore:function(e){var t=n(e.currentTarget),r=t.parents("li").data("identity-id"),a=o.get("user"),l=i.find(a.identities,function(e){return e.id===r?!0:void 0});this.$(".xbtn-verify").data("identity_id",l.id),this.$(".identity").text(s.printExtUserName(l)),this.$(".avatar").attr("src",l.avatar_filename),this.$("i.provider").addClass("icon16-identity-"+l.provider),this.$(".xalert-"+l.provider).removeClass("hide")}}},u.setpassword={errors:{400:{weak_password:"Too short.",no_password:" Password incorrect."},401:{invalid_token:"Invalid Token"}},options:{onHideAfter:function(){this.befer&&this.befer.abort()&&(this.befer=null),this.destory()},events:{'click [data-dismiss="dialog"]':function(){var e=this.srcNode;e&&e.data("redirect")&&(window.location.href="/")},"submit .modal-form":function(){return this.$(".xbtn-success").click(),!1},"blur #password":function(){var e=this.$("#password").val(),t=this.$('[for="password"]'),n=t.find("span");e?4>e.length?(t.addClass("label-error"),n.text(this.errors["400"].weak_password)):(t.removeClass("label-error"),n.text("")):(t.addClass("label-error"),n.text(this.errors["400"].no_password))},"click .xbtn-success":function(e){var t=this,i=t.$("#password").val(),s=t.srcNode;if(!this.$('[for="password"]').hasClass("label-error")){e.preventDefault();var l=n(e.currentTarget),c=this._user,u=this._token,d=this.signed;if(this._setup){var h=function(e,t,i,s,c,u){var d=a.request("setPassword",{type:"POST",params:{token:t},resources:{user_id:i.id},data:{new_password:s},beforeSend:function(){l.addClass("disabled loading")},complete:function(){l.removeClass("disabled loading")}},function(e){o.set("authorization",e),r.emit("app:user:signin",e.token,e.user_id,!0),c&&c.data("dialog",null).data("dialog-type","changepassword").find("span").text("Change Password..."),n("#app-user-menu").find(".setup").remove(),u&&u.hide()},function(r){u&&u.hide();var a=r.meta;if(403===a.code){var l=a.errorType;"invalid_current_password"===l&&alert("Invalid current password.")}else if(401===a.code&&"authenticate_timeout"===a.errorType&&e){var c=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(c);var d=o.get("authorization");t=d.token,c.trigger("click.dialog.data-api",{callback:function(){h(e,t,i,s)}})}});u&&(u.befer=d)};h(d,u,c,i,s,t)}else{var p=function(e,t,i,r,s){var l=a.request("resetPassword",{type:"POST",data:{token:t,name:i.name,password:r}},function(e){o.set("authorization",e.authorization),s&&s.hide(),window.location.href="/"},function(a){s&&s.hide();var l=a.meta,c=l&&l.code,u=l.errorType;if(401===c&&"authenticate_timeout"===u){var d=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(d);var h=o.get("authorization");t=h.token,d.trigger("click.dialog.data-api",{callback:function(){p(e,t,i,r)}})}else 401===c&&"invalid_token"===u&&(n(".token-expired").prev().addClass("hide"),n(".token-expired").removeClass("hide"))});s&&(s.befer=l)};p(d,u,c,i,t)}}}},backdrop:!1,viewData:{cls:"mblack modal-sp",title:"Set Password",body:'<div class="shadow title">Set Password</div><form class="modal-form"><fieldset><legend>Please set your <span class="x-sign">EXFE</span> password. All identities in your account share the same password for authentication.</legend><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div class="control-group"><div class="controls"><label class="control-label" for="password">Password: <span></span></label><input class="input-large" id="password" placeholder="Set EXFE password" type="password" autocomplete="off" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue xbtn-success">Done</button>'},onShowBefore:function(e){h(this.element,"#password","#password-eye");var t=n(e.currentTarget).data("source"),i=n(e.currentTarget).data("token");this.signed=!1,this._setup=!1,t?(this._user=t.user,this._token=i||t.token,this._setup=t.setup):(this.signed=!0,this._user=o.get("user"),this._token=i||o.get("authorization").token,this._setup=!this._user.password),this.$(".avatar img").attr("src",this._user.avatar_filename),this.$(".username").text(this._user.name)}}},u.setup_verification={errors:{400:{weak_password:"Too short.",no_password:" Password incorrect."},401:{invalid_token:"Invalid Token"}},options:{onHideAfter:function(){this.defer&&(this.defer.abort(),this.defer=null),this.destory()},events:{"keypress .modal-form":function(e){return 13===e.keyCode?(this.$(".xbtn-success").focus().trigger("click"),!1):void 0},'click [data-dismiss="dialog"]':function(){var e=this.srcNode;e&&e.data("redirect")&&(window.location.href="/")},"blur #name":function(e){var t=s.trim(n(e.currentTarget).val()),i=this.$('[for="name"]'),r=i.find("span");t?s.utf8length(t)>30?(r.text("Too long."),i.addClass("label-error")):s.zh_CN.test(t)?(i.addClass("label-error"),r.text("Invalid character.")):(i.removeClass("label-error"),r.text("")):(i.addClass("label-error"),r.text(""))},"blur #password":function(e){var t=n(e.currentTarget).val(),i=this.$('[for="password"]'),r=i.find("span");t?4>t.length?(i.addClass("label-error"),r.text(this.errors["400"].weak_password)):(i.removeClass("label-error"),r.text("")):(i.addClass("label-error"),r.text(this.errors["400"].no_password))},"click .xbtn-success":function(){if(!this.$('[for="name"]').hasClass("label-error")||!this.$('[for="password"]').hasClass("label-error")){var e,t=this,i=t._settings,r=i.originToken,s="user"===i.tokenType,l=i.page,c=s?"setup":"setupUserByInvitationToken",u={name:n.trim(this.$("#name").blur().val()),password:this.$("#password").blur().val()},d={},h=t.errors;s?(d.token=i.token,u.identity_id=i.browsing.identities[0].id):u.invitation_token=r,t.defer=a.request(c,{type:"POST",params:d,data:u},function(i){if("resolve"===l)if(e=o.get("authorization")){n("#app-user-menu").find(".setup").remove();var r=n("#app-browsing-identity"),a=r.data("settings");a.setup=!1,a.originToken=i.authorization.token,r.data("settings",a).trigger("click.data-api")}else o.set("authorization",i.authorization),window.location="/";else o.set("authorization",i.authorization),window.location.reload();t&&t.hide()},function(e){var n=e.meta,i=n&&n.code,r=n&&n.errorType;if(i in h&&r in h[i]){var a=t.$('[for="password"]'),s=a.find("span");a.addClass("label-error"),s.text(h[i].errorType)}})}}},backdrop:!1,viewData:{cls:"mblack modal-su",title:"Set Up Account",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><form class="modal-form"><fieldset><legend>Please set up your <span class="x-sign">EXFE</span> account.</legend><div class="clearfix control-group"><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="identity box"></div></div><div class="control-group"><label class="control-label" for="name">Name: <span></span></label><div class="controls"><input type="text" class="input-large" id="name" autocomplete="off" placeholder="Set a recognizable name" /></div></div><div class="control-group"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Set your EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue xbtn-success">Done</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Cancel</a>'},onShowBefore:function(e){h(this.element,"#password","#password-eye");var t=n(e.currentTarget).data("source");if(t){this._settings=t;var i=t.browsing.identities[0],r=t.forward;!r&&(t.forward="/"),this.$("#name").val(i.name),this.$(".identity").text(s.printExtUserName(i)),this.$(".avatar").attr("src",i.avatar_filename).next().addClass("icon16-identity-"+i.provider),this.$(".xbtn-siea").data("source",s.printExtUserName(i))}}}},u.setup_authenticate={options:{onHideAfter:function(){this._oauth_&&(this._oauth_.abort(),this._oauth_=null),this.destory()},events:{"click .xbtn-blue":function(){var e=this._settings.browsing.identities[0].provider;this._oauth_=n.ajax({url:"/OAuth/Authenticate?provider="+e,type:"POST",dataType:"JSON",success:function(e){var t=e.meta.code;200===t&&(window.location.href=e.response.redirect)}})}},backdrop:!1,viewData:{cls:"mblack modal-su",title:"Set Up Account",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><form class="modal-form"><fieldset><legend>Please authenticate following identity to continue.</legend><div class="clearfix control-group"><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="box identity"></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue">Authenticate</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source");if(t){this._settings=t;var i=t.browsing.identities[0],r=t.forward;!r&&(t.forward="/"),this.$(".identity").text(s.printExtUserName(i)),this.$(".avatar").attr("src",i.avatar_filename).next().addClass("icon16-identity-"+i.provider),this.$(".xbtn-siea").data("source",s.printExtUserName(i))}}}},u.browsing_identity={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-dnm":function(){var e=this._settings.action;"SETUP"===e?(n('[data-user-action="'+e+'"]').trigger("click"),this.hide()):window.location="/"},"click .xbtn-merge":function(){var e=this,t=e._settings.token,r=e._settings.invitation_token,s=this.provider,l={invitation_token:r};"email"!==s&&"phone"!==s&&(l.refere=window.location.href),a.request("mergeIdentities",{type:"POST",params:{token:t},data:l,beforeSend:function(){n(".modal-footer").find("button").prop("disabled",!0)}},function(t){if(e.hide(),t.mergeable_user=null,t.mergeable_user){var r=n('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">'),a=o.get("user");r.data("source",{merged_identity:i.find(a.identities,function(e){return e.id===identity.id?!0:void 0}),browsing_token:browsing_token,mergeable_user:t.mergeable_user}),r.appendTo(n("#app-tmp")),r.trigger("click.dialog.data-api"),n(".modal-mi").css("top",230)}else window.location.reload()},function(){})}},backdrop:!1,viewData:{cls:"mblack modal-bi",title:"Browsing Identity",body:'<div class="shadow title">Merge Identity?</div><div class="user"><div class="merge-info">You’re browsing this page as <span class="buser-name"></span> <span class="oblique identity"></span>, we recommend you to merge this identity into current account <span class="user-name"></span>. Do <span class="not">NOT</span> merge if it’s not you!</div></div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div>',footer:'<button class="pull-right xbtn-blue xbtn-merge">Merge and Go</button><button class="pull-right xbtn-white xbtn-dnm">Do NOT Merge</button>'},onShowBefore:function(e){var t=n(e.currentTarget).data("settings");if(t){this._settings=t;var i,r,a,o=t.normal,l=t.browsing,c=l.identities,u=c[0],d=s.printExtUserName(u),h=this.provider=u.provider;i=this.$(".merge-info"),i.find(".buser-name").text(l.name),i.find(".identity").text(d),i.find(".user-name").text(o.name),r=this.$(".context-identity"),r.find(".avatar img").attr("src",u.avatar_filename).next().addClass("icon16-identity-"+h),r.find(".identity").text(d),a=this.$(".context-user"),a.find(".avatar img").attr("src",o.avatar_filename),a.find(".username").text(o.name)}}}},u.read_only={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-ro",title:"Read-only Browsing",body:'<div class="shadow title">Authentication</div><div>You’re browsing this page in read-only mode as identity underneath. To change anything on this page, please authenticate first.</div><div class="clearfix context-user hide"><div class="pull-left avatar"><img src="" alt="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="context-identity hide"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="pull-left box identity"></div></div>',footer:'<button class="pull-right xbtn-blue" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00">Authenticate</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget).data("settings");if(t){var i=t.isBrowsing,r=s.printExtUserName(t.identities[0]);if(this.$("legend span").eq(0).text(i?"identity":"user"),this.$(".xbtn-blue").data("source",r),i){var a=this.$(".context-identity").removeClass("hide");a.find(".identity").text(r),a.find(".avatar img").attr("src",t.identities[0].avatar_filename),a.find(".provider").addClass("icon16-identity-"+t.identities[0].provider)}else{var o=this.$(".context-user").removeClass("hide");o.find(".username").text(t.name),o.find(".avatar img").attr("src",t.avatar_filename)}}}}},u.revoked={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-re",title:"Revoked Identity",body:'<div class="shadow title">Revoked Identity</div>'}}},u.authentication={updateIdentity:function(e){var t=this.$(".context-identity");t.find(".avatar img").attr("src",e.avatar_filename),t.find(".provider").attr("class","provider icon16-identity-"+e.provider),t.find(".identity").text(e.eun),this._identity=e},options:{viewData:{cls:"mblack modal-au",title:"Authentication",body:'<div class="shadow title">Authorization</div><div class="d0 hide"><div class="detials">You’re about to change your account details, for security concerns, please authenticate your account.</div><div class="clearfix context-user"><div class="pull-left avatar"><img src="" alt="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="modal-form"><div class="control-group"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Your EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div></div></div><div class="d1 hide"><div class="detials">You’re about to change your account details. For security concern, please re-authenticate your identity and set your <span class="x-sign">EXFE</span> password first.</div><div class="context-identity"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="clearfix dropdown-toggle" data-toggle="dropdown"><div class="pull-left box identity"></div><ul class="dropdown-menu"></ul><div class="pull-left caret-outer hide"><b class="caret"></b></div></div></div><div class="why">Why I have to do this?</div><div class="answer">Sorry for the inconvenience. Sometimes, we have to compromise on experience for your account security. Re-authentication is to avoid modification by others who can possibly access your computer.</div></div>',footer:'<button class="pull-left xbtn xbtn-white xbtn-forgotpwd d0 hide" data-dialog-from="authentication" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn xbtn-blue xbtn-auth d1 hide">Authenticate</button><button class="pull-right xbtn xbtn-blue xbtn-done d0 hide">Done</button><a class="pull-right xbtn-discard d0 hide" data-dismiss="dialog">Cancel</a>'},events:{"click .xbtn-done":function(){var e=this,t=o.get("user"),n=t.identities[0],i=n.external_username,r=n.provider,l=s.trim(e.$("#password").val());a.request("signin",{type:"POST",data:{external_username:i,provider:r,password:l,name:"",auto_signin:!0}},function(t){o.set("authorization",t);var n=e.callback;e.destory(),n()})},"click .xbtn-auth":function(e){var t=this,i=n(e.currentTarget);if(i.hasClass("xbtn-success"))return t.$(".verify-after").addClass("hide"),i.removeClass("xbtn-success").text("Verify"),t.hide(),!1;var r=t._identity.provider,s=t._identity.external_username;t.befer=a.request("verifyIdentity",{type:"POST",data:{provider:r,external_username:s}},function(e){"REDIRECT"===e.action&&(window.location.href=e.url)})},"click .caret-outer":function(e){this.$(".dropdown-toggle").addClass("open"),e.stopPropagation()},"hover .dropdown-menu > li":function(e){var t=e.type,i=n(e.currentTarget);i[("mouseenter"===t?"add":"remove")+"Class"]("active")},"click .dropdown-menu > li":function(e){var t=this.$(".dropdown-menu").data("identities"),i=n(e.currentTarget).data("index");this.updateIdentity(t[i])}},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},onShowBefore:function(e){var t=this,n=o.get("user"),i=n.password;if(t.$(".d"+(i?0:1)).removeClass("hide"),e&&e._data&&(t.callback=e._data.callback),t.callback&&(t.callback=function(){}),i)t.$(".modal-body .d0").find(".avatar img").attr("src",n.avatar_filename).parent().next().text(n.name),t.$(".xbtn-forgotpwd").data("source",n.identities);else{var r,a,l=n.identities;if(l&&(r=l.length)){if(a=l[0],a.eun=s.printExtUserName(a),r>1){t.$(".context-identity").addClass("switcher");for(var c="",u=0;r>u;u++)c+='<li data-index="'+u+'"><i class="pull-right icon16-identity-'+l[u].provider+'"></i>',l[u].eun=s.printExtUserName(l[u]),c+="<span>"+l[u].eun+"</span>",c+="</li>";t.$(".dropdown-menu").html(c).data("identities",l)}t.updateIdentity(a)}}}}},u.unsubscribe={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-done":function(e){e.preventDefault(),this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-unsubscribe",title:"Unsubscribe Email",body:'<div class="shadow title">Unsubscribe update email</div><p>You just unsubscribe update email of <span class="x">·X·</span> “<span class="x-title"></span>”.</p>',footer:'<button class="pull-right xbtn-white xbtn-done">Done</button>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source");this.$(".x-title").text(t.title)}}};var f=c.extend({availability:!1,init:function(){var e=this;r.off("widget-dialog-identification-auto"),r.on("widget-dialog-identification-auto",function(t){var n=e.$('[for="identity"]'),i=n.find("span"),r=e.$('[for="password"]'),a=r.find("span");e.availability=!1,e.identityFlag=null;var s;"d24"===e.switchTabType&&(s="d01"),e.$(".xalert-error").addClass("hide"),e.$(".help-subject").removeClass("icon14-question").addClass("icon14-clear"),t?(n.removeClass("label-error"),i.text(""),t.identity&&t.identity.avatar_filename?(e._identity=t.identity,e.$(".user-identity").removeClass("hide").find("img").attr("src",t.identity.avatar_filename).next().attr("class","provider icon16-identity-"+t.identity.provider)):(e._identity=null,e.$(".user-identity").addClass("hide")),"phone"===t.identity.provider&&e.$(".phone-tip").toggleClass("hide",/\+/.test(e.$("#identity").val())),e.identityFlag=t.registration_flag,"SIGN_IN"===t.registration_flag?(s="d01",e.$(".xbtn-forgotpwd").removeClass("hide"),r.removeClass("label-error"),a.text("")):"SIGN_UP"===t.registration_flag?(s="d02",r.removeClass("label-error"),a.text("")):"AUTHENTICATE"===t.registration_flag?(s="d00",e.$(".help-subject").removeClass("icon14-question").addClass("icon14-clear"),e.$(".authenticate").removeClass("hide")):"VERIFY"===t.registration_flag&&(s="d04"),e.availability=!0):(e.$(".phone-tip").addClass("hide"),e.$(".help-subject").removeClass("icon14-clear").addClass("icon14-question")),s&&e.switchTabType!==s&&e.switchTab(s),e.$(".x-signin")[(e.availability?"remove":"add")+"Class"]("disabled"),e.$(".xbtn-forgotpwd").data("source",t?[t.identity]:t)}),r.off("widget-dialog-identification-nothing"),r.on("widget-dialog-identification-nothing",function(){e.$(".authenticate").addClass("hide"),e.$(".user-identity").addClass("hide"),e.$('[for="identity"]').removeClass("label-error").find("span").text(""),e.$(".xbtn-forgotpwd").addClass("hide").data("source",null),e.availability=!1,e.$(".x-signin")[(e.availability?"remove":"add")+"Class"]("disabled")}),h(this.element,"#password","#password-eye")},resetInputs:function(){this.$("input").val(""),this.$(".label-error").removeClass("label-error").find("span").text(""),this.$(".icon16-pass-show").toggleClass("icon16-pass-show icon16-pass-hide").prev().prop("type","password"),this.$("#identity").focusend()},setPasswordPlaceHolder:function(e){"d02"===e?this.$("#password").attr("placeholder","Set your EXFE Password"):"d01"===e&&this.$("#password").attr("placeholder","Your EXFE Password")},getFormData:function(e){var t=s.trim(this.$("#identity").val()),n=s.parseId(t);return("d01"===e||"d02"===e)&&(n.password=this.$("#password").val()),"d01"===e&&(n.auto_signin=this.$("#auto-signin").prop("checked")),"d02"===e&&(n.name=s.trim(this.$("#name").val())),n},switchTab:function(e){if(this.$(".d").not(".hide").addClass("hide").end().filter("."+e).removeClass("hide"),this.$(".x-signin")[(this.availability?"remove":"add")+"Class"]("disabled"),this.switchTabType=e,this.isShown&&("d00"===this.switchTabType||"d01"===this.switchTabType||"d02"===this.switchTabType)){var t=this.$("#identity");t.focusend()}this.setPasswordPlaceHolder(e)}});t.Identification=f});