define("xdialog",function(t,e){"use strict";var i=t("jquery"),a=t("rex"),s=t("bus"),n=t("api"),r=t("util"),d=t("store"),o=t("handlebars"),l=t("dialog"),c={};e.dialogs=c,c.identification={options:{errors:{400:"Username incorrect.",403:"Password incorrect.",500:"Set up this new identity."},onCheckUser:function(){var t=d.get("lastIdentity"),e=d.get("last_external_username");t&&(this.availability=!0,this.$("#identity").val(e),this.$(".x-signin").removeClass("disabled loading"),this.$(".user-identity").removeClass("hide").find("img").attr("src",t.avatar_filename).next().attr("class","provider icon16-identity-"+t.provider),this.$(".xbtn-forgotpwd").data("source",[t]),this.switchTab("d01")),this.$(".help-subject").toggleClass("icon14-question",!this.availability)},onShowBefore:function(t){var e=i(t.currentTarget).data("source");e?this.$("#identity").val(e):this.emit("checkUser")},onShowAfter:function(){("d00"===this.switchTabType||"d01"===this.switchTabType||"d02"===this.switchTabType)&&this.$("#identity").focusend()},onHideAfter:function(){this.$(".modal-body").eq(0).css("opacity",1),this.switchTabType="d00",this._oauth_&&(this._oauth_.abort(),this._oauth_=null),this.destory(),i(".popmenu").remove()},events:{"keypress .modal-main":function(t){var e=this.switchTabType,i=t.keyCode;!this.availability||"d01"!==e&&"d02"!==e||13!==i||this.$(".x-signin").click()},"click .oauth > a":function(t){t.stopPropagation(),t.preventDefault();var e=this,a=i(t.currentTarget),s=a.data("oauth");e.$(".authentication").find(".oauth-provider").text(s),e._oauth_=i.ajax({url:"/OAuth/Authenticate?provider="+s,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){e.$(".modal-body").eq(0).css("opacity",0),e.switchTab("d05"),e.$(".authentication").find("img").removeClass("hide"),e.$(".authentication").find(".redirecting").removeClass("hide"),e.$(".authentication").find(".xalert-fail").addClass("hide"),e.$(".xbtn-oauth").addClass("hide")},success:function(t){var i=t.meta.code;200===i?window.location.href=t.response.redirect:(e.$(".authentication").find("img").addClass("hide"),e.$(".authentication").find(".redirecting").addClass("hide"),e.$(".authentication").find(".xalert-fail").removeClass("hide"),e.$(".xbtn-oauth").removeClass("hide"))}})},"click .xbtn-oauth":function(){return this.$(".modal-body").eq(0).css("opacity",1),this.switchTab("d00"),!1},"click .xbtn-verify":function(t){var e=this,a=i(t.currentTarget);if(a.hasClass("xbtn-success"))return e.$(".verify-after").addClass("hide"),a.removeClass("xbtn-success").text("Verify"),e.hide(),!1;var s=e._identity.provider,r=e._identity.external_id;n.request("verifyIdentity",{type:"POST",data:{provider:s,external_username:r}},function(t){e.$(".verify-before").addClass("hide"),"VERIFYING"===t.action?(e.$(".verify-after").removeClass("hide"),a.addClass("xbtn-success").text("Done")):a.addClass("verify-error").removeClass("hide")})},"blur #identity":function(t){var e=r.trim(i(t.currentTarget).val()),a=this.$('[for="identity"]'),s=a.find("span");e.length&&!r.parseId(e).provider?(a.addClass("label-error"),s.text("Invalid identity.")):(a.removeClass("label-error"),s.text(""))},"blur #name":function(t){var e=r.trim(i(t.currentTarget).val()),a=this.$('[for="name"]'),s=a.find("span");e?r.utf8length(e)>30?(s.text("Too long."),a.addClass("label-error")):r.zh_CN.test(e)?(a.addClass("label-error"),s.text("Invalid character.")):(a.removeClass("label-error"),s.text("")):(a.addClass("label-error"),s.text(""))},"blur #password":function(t){var e=r.trim(i(t.currentTarget).val()),a=this.$('[for="password"]'),s=a.find("span");e?(a.removeClass("label-error"),s.text("")):(a.addClass("label-error"),s.text("Password incorrect."))},"click .help-subject":function(t){var e,a=i(t.currentTarget);a.hasClass("icon14-question")?(e='Identity is your online representative, such as email, <span class="strike">mobile no.</span>, and your account username on other websites like Twitter, Facebook, etc.',a.parent().find(".xalert-error:eq(0)").html(e).removeClass("hide")):(a.toggleClass("icon14-question icon14-clear"),this.resetInputs(),this.$(".user-identity").addClass("hide"),d.remove("lastIdentity"),d.remove("last_external_username"),d.remove("authorization"),d.remove("user"),d.remove("identities"),this.$('[data-typeahead-type="identity"]').data("typeahead").source=null,this.switchTab("d00"))},"click #password-eye":function(t){var e=i(t.currentTarget),a=e.prev();a.prop("type",function(t,e){return"password"===e?"text":"password"}),e.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-forgotpwd":function(t){t.preventDefault(),this.element.addClass("hide"),i("#js-modal-backdrop").addClass("hide")},"click .xbtn-setup":function(t){t.preventDefault(),this.$(".modal-body").eq(0).css("opacity",.05),this.switchTab("d03")},"click .xbtn-isee":function(t){t.preventDefault(),this.$(".modal-body").eq(0).css("opacity",1),this.$("#identity").val(""),this.switchTab("d02")},"click .xbtn-startover":function(t){t.preventDefault(),this.$("#identity").val(""),this.resetInputs(),this.switchTab("d00",!0)},"click .x-signin":function(t){var e=i(t.currentTarget);if(!e.hasClass("disabled")){var a=this,o=this.switchTabType,u=this.getFormData(o);a.$("#password").trigger("blur"),"d02"===o&&a.$("#name").trigger("blur"),u.password&&("d02"!==o||u.name)&&("d01"===o||"d02"===o)&&n.request("signin",{type:"POST",data:{external_username:u.external_username,provider:u.provider,password:u.password,name:u.name||"",auto_signin:!!u.auto_signin},beforeSend:function(){e.addClass("disabled loading")},complete:function(){e.removeClass("disabled loading")}},function(t){if(delete App.request.session.browsing_authorization,delete App.request.session.browsing_user,d.set("authorization",t),d.set("last_external_username",r.printExtUserName(u)),a.hide(),"d01"===o||"d02"===o)s.emit("app:user:signin",t.token,t.user_id,!1,!0);else{var e=new l(c.welcome);e.render(),e.show({identity:{name:u.name,provider:u.provider}})}},function(t){var e=t.meta&&t.meta.code||400;a.$('[for="password"]').addClass("label-error").find("span").text(a.options.errors[e])})}}},backdrop:!0,viewData:{cls:"modal-id",title:"Start",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><div class="clearfix"><div class="pull-left authorize">Authenticate with:</div><div class="pull-left oauth"><a href="#" class="oauth-twitter" data-oauth="twitter">twitter</a><a href="#" class="oauth-facebook" data-oauth="facebook">facebook</a></div></div><div class="orspliter">or</div><form class="modal-form"><fieldset><legend>Use your online identity:</legend><div class="clearfix control-group"><label class="control-label" for="identity">Identity: <span class="xalert-message"></span></label><div class="pull-right user-identity hide"><div class="avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div></div><div class="controls"><input type="text" class="input-large identity" id="identity" autocomplete="off" data-widget="typeahead" data-typeahead-type="identity" placeholder="Enter your email or phone" /><i class="help-subject"></i><i class="help-inline small-loading hide"></i><div class="xalert xalert-error hide" style="margin-top: 5px;"></div><div class="xalert xalert-error authenticate hide" style="margin-top: 5px;"><span class="xalert-fail">Please directly authenticate identity above.</span><br />To enable password sign-in for this identity, set an <span class="x-sign">EXFE</span> password first in your profile page.</div></div></div><div class="form-title d d02 hide">Welcome! Please set up your new account.<span class="pull-right form-title-bd"></span></div><div class="control-group d d02 hide"><label class="control-label" for="name">Display name: <span></span></label><div class="controls"><input type="text" class="input-large" id="name" autocomplete="off" placeholder="Desired recognizable name" /></div></div><div class="control-group d d01 d02 hide"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div><div class="control-group d d01 hide"><div class="control-label"><label class="checkbox pointer"><input type="checkbox" id="auto-signin" value="1" checked />Sign in automatically</label></div></div><div class="control-group phone-tip hide"><div class="xalert">Please include country code prefix, e.g.: +1 555 450 0303</div></div><div class="verify-before d d04 hide"><span class="xalert-fail">This identity requires verification before using.</span><br />Confirm sending verification to your mailbox?</div><div class="verify-after hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div><div class="verify-error hide"><span class="xalert-fail">Requested too much, hold on awhile.</span><br />Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</div></fieldset></form>',footer:'<button class="xbtn-white d d01 xbtn-forgotpwd hide" data-dialog-from="identification" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="xbtn-white d d02 d04 xbtn-startover hide">Start Over</button><button class="pull-right d d04 xbtn-blue xbtn-verify hide">Verify</button><a href="#" class="pull-right xbtn-setup d d00 hide">Looking for sign-up?</a><button class="pull-right xbtn-blue d d01 d02 x-signin disabled hide">Start</button><button class="pull-right xbtn-white d d03 xbtn-isee hide">I See</button><button class="pull-right xbtn-white d hide">OK</button><button class="pull-right xbtn-white d xbtn-oauth hide">Back</button>',others:'<div class="isee d d03 hide"><div class="modal-body"><div class="shadow title">“Sign-Up-Free”</div><p>Tired of signing up all around? Just authorize through your existing accounts from other websites, such as Twitter, <span class="strike">Facebook, Google, etc.</span> (soon to support)</p><p>We hate spam, will NEVER disappoint your trust.</p><p>Alternatively, traditional registration process with email and password is also available.</p></div></div><div class="authentication d d05 hide"><div class="modal-body"><div class="shadow title">Authentication</div><div class="content"><img class="hide" src="/static/img/loading.gif" width="32" height="32" /><p class="redirecting hide">Redirecting to <span class="oauth-provider"></span>…</p><p class="xalert-fail hide">Failed to connect with <span class="oauth-provider"></span> server.</p></div></div></div>'}}},c.sandbox={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-sandbox",title:"Rome",body:'<div class="shadow title">“Rome wasn\'t built in a day.”</div><p><span class="x-sign">EXFE</span> [’ɛksfi] is still in <span class="pilot">pilot</span> period (with <span class="sandbox">Rome</span> tag). We’re building up blocks, consequently something buggy or awkward may happen. Our apologies for any trouble you may encounter. Any feedback, please email <span class="feedback">feedback@exfe.com</span>. Much appreciated.</p>'}}},c.welcome={options:{events:{"click .xbtn-go":function(){var t=this;if("email"===this._provider){if(/^\/![a-zA-z0-9]+$/.test(window.location.pathname))return window.location=window.location.pathname,void 0}else this.$("#follow").prop("checked")&&this._token&&i.ajax({url:"/OAuth/followExfe?token="+this._token,type:"POST",data:{identity_id:this._identity_id},success:function(){d.remove("oauth")}});t.hide()},"click .why":function(){this.$(".answer").toggleClass("hidden")}},onShowBefore:function(t){var e=t.identity,i=this.$(".title").eq(0);this._provider=e.provider,this._identity_id=e.id,this._token=t.token,this._following=t.following,i.text("Hi, "+e.name+"."),"email"===e.provider?this.$(".provider-email").removeClass("hide"):"twitter"===e.provider&&(this.$(".provider-other").removeClass("hide"),this.$("#follow").prop("checked",this._following))},onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-large modal-wc",title:"Welcome",body:'<div class="shadow title"></div><div class="center shadow title" style="margin-bottom: 0;">Thanks for using <span class="x-sign">EXFE</span>.</div><p class="center">A utility for gathering with friends.</p><div class="modal-content"><p>Save yourself from calling every one RSVP repeatedly, losing in endless emails messages off-the-point.</p><p><span class="x">·X·</span> (cross) is a gathering, for things to do together. <span class="x-sign">EXFE</span> friends for meetings, parties, sports, trips, etc. Anything you want to gather friends to do.</p><p><span class="x-sign">EXFE</span> your friends, Gather a <span class="x">·X·</span>.</p><p class="provider-email hide" style="color: #191919;">*A welcome email has been sent to your email. Please check to verify your address.*</p><div class="provider-other hide">&nbsp;&nbsp;<span class="underline why">why?</span><label class="pull-left checkbox pointer"><input type="checkbox" id="follow" value="1" checked />Follow @<span class="x-sign">EXFE</span> on Twitter.</label><p class="pull-left answer hidden">So we could send you invitation PRIVATELY through Direct Message. We hate spam, will NEVER disappoint your trust.</p></div></div>',footer:'<button class="pull-right xbtn-white xbtn-go">GO</button>'}}},c.forgotpassword={updateIdentity:function(t){var e=t.provider,i=this.$(".context-identity");this.$(".tab").addClass("hide"),this.$(".xbtn-done").addClass("hide"),"email"===e?(this.$(".tab1").removeClass("hide"),this.$(".xbtn-send").data("identity",t)):(this.$(".tab2").removeClass("hide"),this.$(".authenticate").data("identity",t)),i.find(".avatar img").attr("src",t.avatar_filename),i.find(".provider").attr("class","provider icon16-identity-"+t.provider),i.find(".identity").text(t.eun)},options:{onHideAfter:function(t){if(this.befer&&(this.befer.abort(),this.befer=null),t){var e=this.dialog_from;e&&i('[data-dialog-type="'+e+'"]').data("dialog").hide()}this.destory()},events:{"click .authenticate":function(t){var e=this,a=i(t.currentTarget),s=a.data("identity");s&&(e.befer=n.request("forgotPassword",{type:"POST",data:{provider:s.provider,external_username:s.external_username},beforeSend:function(){e.$(".send-before").removeClass("hide"),e.$(".send-after").addClass("hide"),a.addClass("disabled")},complete:function(){a.removeClass("disabled")}},function(t){"REDIRECT"===t.action&&(window.location.href=t.url)}))},"click .caret-outer":function(t){this.$(".dropdown-toggle").addClass("open"),t.stopPropagation()},"hover .dropdown-menu > li":function(t){var e=t.type,a=i(t.currentTarget);a[("mouseenter"===e?"add":"remove")+"Class"]("active")},"click .dropdown-menu > li":function(t){var e=this.$(".dropdown-menu").data("identities"),a=i(t.currentTarget).data("index");this.updateIdentity(e[a])},"click .xbtn-cancel":function(){var t=this.dialog_from;this.hide(),t&&(i('[data-dialog-type="'+t+'"]').data("dialog").element.removeClass("hide"),i("#js-modal-backdrop").removeClass("hide"))},"click .xbtn-done":function(t){this.hide(t)},"click .xbtn-send":function(t){var e=this,a=i(t.currentTarget);if(!a.hasClass("disabled")){var s=a.data("identity");s&&(e.befer=n.request("forgotPassword",{type:"POST",data:{provider:s.provider,external_username:s.external_username},beforeSend:function(){e.$(".send-before").removeClass("hide"),e.$(".send-after").addClass("hide"),a.addClass("disabled")},complete:function(){a.removeClass("disabled")}},function(t){"VERIFYING"===t.action&&(e.$(".identity").next().removeClass("hide"),a.addClass("hide"),e.$(".xbtn-done").removeClass("hide"),e.$(".send-before").addClass("hide"),e.$(".send-after").removeClass("hide"))}))}}},onShowBefore:function(t){var e,a,s,n=this,r=i(t.currentTarget).data("source");if(r&&(e=r.length)){if(a=r[0],s=a.external_username,"twitter"===a.provider&&(s="@"+a.external_username),a.eun=s,e>1){n.$(".context-identity").addClass("switcher");for(var d="",o=0;e>o;o++)s=r[o].external_username,d+='<li data-index="'+o+'"><i class="pull-right icon16-identity-'+r[o].provider+'"></i>',"twitter"===r[o].provider&&(s="@"+r[o].external_username),r[o].eun=s,d+="<span>"+s+"</span>",d+="</li>";n.$(".dropdown-menu").html(d).data("identities",r)}this.updateIdentity(a)}},backdrop:!1,viewData:{cls:"mblack modal-fp",title:"Forgot Password",body:'<div class="shadow title">Forgot Password</div><div>You can reset your <span class="x-sign">EXFE</span> password through identity:</div><div class="context-identity"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="clearfix dropdown-toggle" data-toggle="dropdown"><div class="pull-left box identity"></div><ul class="dropdown-menu"></ul><div class="pull-left caret-outer hide"><b class="caret"></b></div></div></div><div class="alert-label"><div class="send-before tab tab1 hide">Confirm sending reset token to your mailbox?</div><div class="send-after tab hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div><div class="xalert-error tab hide"><p>Requested too much, hold on awhile.</p><p>Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</p></div><div class="authenticate-before tab tab2 hide">You will be directed to Twitter website to authenticate identity above, you can reset password then.</div></div>',footer:'<button class="pull-right xbtn-white xbtn-done hide">Done</button><button class="pull-right xbtn-blue xbtn-send tab tab1 hide">Send</button><button class="pull-right xbtn-blue authenticate tab tab2 hide">Authenticate</button><a class="pull-right xbtn-cancel">Cancel</a>'}}},c.changepassword={options:{onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},events:{"click .xbtn-resetpwd":function(t){var e=d.get("user"),s=e.identities,n=a.filter(s,function(t){return"CONNECTED"===t.status?!0:void 0});if(1===n.length){t.stopPropagation(),this.hide();var r=new l(c.forgotpassword);r.dialog_from="changepassword",r.render(),i(t.currentTarget).data("identity-id",n[0].id),r.show(t)}},"click .password-eye":function(t){var e=i(t.currentTarget),a=e.prev();a.prop("type",function(t,e){return"password"===e?"text":"password"}),e.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-forgotpwd":function(t){var e=d.get("user"),s=e.identities,n=s.length,r=[];1===n?r.push(s[0]):a.each(s,function(t){var e=t.status;("CONNECTED"===e||"REVOKED"===e)&&r.push(t)}),i(t.currentTarget).data("source",r)},"click .xbtn-success":function(t){var e=this,a=e.$("#cppwd").val(),s=e.$("#cp-npwd").val();if(!a||!s)return a?alert("Please input new password."):alert("Please input current password."),void 0;t.preventDefault();var r=i(t.currentTarget),o=d.get("authorization"),l=o.user_id,c=o.token;e.befer=n.request("setPassword",{type:"POST",params:{token:c},resources:{user_id:l},data:{current_password:a,new_password:s},beforeSend:function(){r&&r.addClass("disabled loading")},complete:function(){r&&r.removeClass("disabled loading")}},function(t){d.set("authorization",t),e&&e.destory()},function(t){var i=t&&t.meta;if(i)if(403===i.code){var a=t.meta.errorType;"invalid_current_password"===a&&alert("Invalid current password.")}else 401===i.code&&"authenticate_timeout"===i.errorType&&e&&e.destory()})}},onShowBefore:function(){var t=d.get("user");this.$(".avatar > img").attr("src",t.avatar_filename),this.$(".username").text(t.name)},backdrop:!1,viewData:{cls:"modal-cp mblack modal-large",title:"Change Password",body:'<div class="shadow title">Change Password</div><form class="modal-form"><fieldset><legend>Enter your current <span class="x-sign">EXFE</span> password, and set new one. All your identities share the same password for sign-in and account management.</legend><div class="clearfix context-user"><div class="pull-left avatar"><img src="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="control-group"><label class="control-label" for="cppwd">Password:</label><div class="controls"><input class="input-large" id="cppwd" placeholder="Current password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer"></i></div></div><div class="control-group"><label class="control-label" for="cp-npwd">New Password:</label><div class="controls"><input class="input-large" id="cp-npwd" placeholder="Set new EXFE password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer"></i></div></div></fieldset></form>',footer:'<button class="xbtn-white xbtn-forgotpwd" data-dialog-from="changepassword" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn-blue xbtn-success">Change</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Discard</a>'}}},c.addidentity={options:{errors:{failed:"Password incorrect.",no_password:"Password incorrect.",no_external_id:"Set up this new identity."},backdrop:!1,events:{"click #password-eye":function(t){var e=i(t.currentTarget),a=e.prev();a.prop("type",function(t,e){return"password"===e?"text":"password"}),e.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-forgotpwd":function(t){var e=i(t.currentTarget),a=e.hasClass("disabled");return a?(t.stopPropagation(),!1):void 0},"click .xbtn-startover":function(){this.$(".d1, d2, d3").addClass("hide"),this.$(".d0").removeClass("hide"),this.$("#identity").val("").focus()},"click .xbtn-add":function(t){t.preventDefault();var e=this,s=e.registration_flag,r=e._identity;if(!r)return!1;var l=r.provider,c=r.external_username||"",u=d.get("user");if(a.find(u.identities,function(t){return t.provider===l&&t.external_username===c?!0:void 0}))return e.destory(),void 0;if("SIGN_IN"===s){var h=i.trim(e.$("#password").val()),p=!1,v="",f=n.request("signin",{type:"POST",data:{external_username:r.external_username,provider:r.provider,password:h,name:r.name||"",auto_signin:!1}},function(t){p=!0,v=t.token,e.$('[for="password"]').removeClass("label-error").find("span").text(""),e.$("#name").nextAll(".xalert-info").addClass("hide")},function(t){var i=t.meta.errorType,a=t.meta.errorDetail;"no_password"===i||"failed"===i?e.$('[for="password"]').addClass("label-error").find("span").text(a||e.options.errors[i]):"no_external_id"===i&&e.$("#name").nextAll(".xalert-info").removeClass("hide")});f.done(function(){if(p){var t=d.get("authorization"),a=t.token,s=r.id;e.defer=n.request("mergeIdentities",{type:"POST",params:{token:a},data:{browsing_identity_token:v,identity_ids:"["+s+"]"}},function(t){var a=t.status[s];if(a){var n,r,l=d.get("user"),c=l.identities;c.push(a),d.set("user",l),n=o.compile(i("#jst-identity-item").html()),r=n(a),i(".identity-list").append(r),e&&e.destory()}})}}),e.defer=f}else if("SIGN_UP"===s){var g=function(t,e,a){var s=d.get("authorization"),r=s.token,l=n.request("addIdentity",{type:"POST",params:{token:r},data:{external_username:t,provider:e}},function(t){var e=t.identity,s=d.get("user"),n=s.identities;n.push(e),d.set("user",s);var r=o.compile(i("#jst-identity-item").html()),l=r(t.identity);i(".identity-list").append(l),a&&a.destory()},function(s){var n=s&&s.meta;if(n&&401===n.code&&"authenticate_timeout"===n.errorType){a&&a.destory();var r=i('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');i("#app-tmp").append(r);var d=i.Event("click.dialog.data-api");d._data={callback:function(){g(t,e)}},r.trigger(d)}});a&&(a.defer=l)};g(c,l,e)}else"AUTHENTICATE"===s&&e.$('.oauth > a[data-oauth="'+r.provider+'"]').trigger("click")},"click .xbtn-verify":function(t){function e(t,a,s){var r=d.get("authorization"),l=r.token,c=n.request("addIdentity",{type:"POST",params:{token:l},data:{external_username:t,provider:a}},function(t){var e=t.identity,a=d.get("user"),n=a.identities;n.push(e),d.set("user",a);var r=o.compile(i("#jst-identity-item").html()),l=r(t.identity);i(".identity-list").append(l),s&&s.$(".verify-before").addClass("hide"),s&&s.$(".verify-after").removeClass("hide"),s&&s.$(".xbtn-verify").addClass("hide"),s&&s.$(".xbtn-done").removeClass("hide")},function(n){s&&(s.$(".verify-before").removeClass("hide"),s.$(".verify-after").addClass("hide"),s.$(".xbtn-verify").removeClass("hide"),s.$(".xbtn-done").addClass("hide"));var r=n&&n.meta;if(r&&401===r.code&&"authenticate_timeout"===r.errorType){s&&s.destory();var d=i('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');i("#app-tmp").append(d);var o=i.Event("click.dialog.data-api");o._data={callback:function(){e(t,a)}},d.trigger(o)}});s&&(s.defer=c)}t.preventDefault();var s=this,r=s._identity,l=i(t.currentTarget);if(l.hasClass("xbtn-success"))return s.$(".verify-after").addClass("hide"),s.hide(),!1;if(!r)return!1;var c=r.provider,u=r.external_username||"",h=d.get("user");return a.find(h.identities,function(t){return t.provider===c&&t.external_username===u?!0:void 0})?(s.destory(),void 0):(e(u,c,s),void 0)},"click .xbtn-done":function(){this.hide()},"click .oauth > a":function(t){function e(t,a,s){var r=d.get("authorization"),o=r.token,l=n.request("addIdentity",{type:"POST",params:{token:o},data:{refere:window.location.href,external_username:t,provider:a},beforeSend:function(){s.$(".modal-body").eq(0).css("opacity",0),s.switchTab("d05"),s.$(".authentication").find("img").removeClass("hide"),s.$(".authentication").find(".redirecting").removeClass("hide"),s.$(".authentication").find(".xalert-fail").addClass("hide")}},function(t){window.location.href=t.url,s&&s.destory()},function(n){var r=n&&n.meta;if(r&&401===r.code&&"authenticate_timeout"===r.errorType){s&&s.destory();var d=i('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');i("#app-tmp").append(d);var o=i.Event("click.dialog.data-api");o._data={callback:function(){e(t,a)}},d.trigger(o)}});s&&(s.defer=l)}t.preventDefault();var a="",s=i(t.currentTarget).data("oauth"),r=this;return r.$(".authentication").find(".oauth-provider").text(s),e(a,s,r),!1}},onShowBefore:function(){this.element.removeClass("hide"),this.$("#identity").focusend()},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},viewData:{cls:"mblack modal-id modal-ai",title:"Add Identity",body:'<div class="shadow title">Add Identity</div><div class="clearfix"><div class="pull-left authorize">Authenticate with:</div><div class="pull-left oauth"><a href="#" class="oauth-twitter" data-oauth="twitter">twitter</a><a href="#" class="oauth-facebook" data-oauth="facebook">facebook</a><a href="#" class="oauth-dropbox hide" data-oauth="dropbox">dropbox</a><a href="#" class="oauth-flickr hide" data-oauth="flickr">flickr</a><a href="#" class="oauth-instagram hide" data-oauth="instagram">instagram</a></div></div><div class="orspliter">or</div><form class="modal-form"><fieldset><legend>Use your online identity:</legend><div class="clearfix control-group"><label class="control-label" for="identity">Identity: <span class="xalert-message"></span></label><div class="pull-right user-identity hide"><div class="avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div></div><div class="controls"><input type="text" class="input-large identity" id="identity" autocomplete="off" data-widget="typeahead" data-typeahead-type="identity" placeholder="Enter your email or phone" /><i class="help-subject"></i><i class="help-inline small-loading hide"></i><div class="xalert xalert-error hide" style="margin-top: 5px;"></div><div class="xalert xalert-error authenticate hide" style="margin-top: 5px;"><span class="xalert-fail">Please directly authenticate identity above.</span><br />To enable password sign-in for this identity, set an <span class="x-sign">EXFE</span> password first in your profile page.</div></div></div><div class="control-group d d0"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Identity\'s EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div><div class="control-group phone-tip hide"><div class="xalert">Please include country code prefix, e.g.: +1 555 450 0303</div></div><div class="verify-before d d1 hide"><span class="xalert-fail">This identity requires verification before using.</span><br />Confirm sending verification to your mailbox?</div><div class="verify-after d2 hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div></fieldset></form>',footer:'<button class="xbtn-white xbtn-startover d d1 hide">Start Over</button><button class="xbtn-white xbtn-forgotpwd d d0 disabled" data-dialog-from="addidentity" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn-blue xbtn-add d d0">Add</button><button class="pull-right xbtn-blue xbtn-verify d d1 hide">Verify</button><button class="pull-right xbtn-white xbtn-done d d2 hide">Done</button>',others:'<div class="authentication d d05 hide"><div class="modal-body"><div class="shadow title">Authentication</div><div class="content"><img class="hide" src="/static/img/loading.gif" width="32" height="32" /><p class="redirecting hide">Redirecting to <span class="oauth-provider"></span>…</p><p class="xalert-fail hide">Failed to connect with <span class="oauth-provider"></span> server.</p></div></div></div>'}},switchTab:function(t){this.$(".d").not(".hide").addClass("hide").end().filter("."+t).removeClass("hide"),this.switchTabType=t},availability:!1,init:function(){var t=this;t.registration_flag="",s.off("widget-dialog-identification-auto"),s.on("widget-dialog-identification-auto",function(e){if(e){e.identity&&e.identity.avatar_filename?(t._identity=e.identity,t.$(".user-identity").removeClass("hide").find("img").attr("src",e.identity.avatar_filename).next().attr("class","provider icon16-identity-"+e.identity.provider)):(t.$(".user-identity").addClass("hide"),t._identity=null),"phone"===e.identity.provider&&t.$(".phone-tip").toggleClass("hide",/\+/.test(t.$("#identity").val()));var i=e.registration_flag;t.registration_flag=i||"","SIGN_IN"===i?(t.$(".d1, .d2, .d3").addClass("hide"),t.$(".d0").removeClass("hide"),t.$(".xbtn-forgotpwd").removeClass("disabled").data("source",[t._identity])):"SIGN_UP"===i?(t._identity=r.parseId(t.$("#identity").val()),t.$(".d0, .d1, .d3").addClass("hide"),t.$(".xbtn-add").removeClass("hide")):"AUTHENTICATE"===i?(t._identity=r.parseId(t.$("#identity").val()),t.$(".d1, .d2").addClass("hide"),t.$(".d0, .d3").removeClass("hide"),t.$('label[for="password"]').parent().addClass("hide")):"VERIFY"===i&&(t.$(".d0, .d2, .d3").addClass("hide"),t.$(".d1").removeClass("hide")),t.$(".xbtn-success").removeClass("disabled")}else t.$(".xbtn-success").addClass("disabled"),t.$(".phone-tip").addClass("hide"),t.$(".xbtn-forgotpwd").addClass("disabled").data("source",null)}),s.off("widget-dialog-identification-nothing"),s.on("widget-dialog-identification-nothing",function(){t.$(".control-group.d").removeClass("hide"),t.$(".phone-tip").addClass("hide")})}},c.addIdentityAfterSignIn={options:{events:{"click .xbtn-cancel":function(){this.destory()},"click .xbtn-add":function(){var t=this,e=d.get("authorization"),a=e.token,s=this._identity.external_username,r=this._identity.provider;n.request("addIdentity",{type:"POST",params:{token:a},data:{external_username:s,provider:r}},function(e){var i=e.identity,a=d.get("user"),s=a.identities;s.push(i),d.set("user",a),t.destory(),window.location.href="/"},function(e){var a=e&&e.meta;if(a&&401===a.code&&"authenticate_timeout"===a.errorType){t.destory();var s=i('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');
i("#app-tmp").append(s),s.trigger("click.dialog.data-api")}})}},backdrop:!1,viewData:{cls:"mblack modal-aifsi",title:"Set Up Account",body:'<div class="shadow title">Add Identity</div><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div>Please authorize identity underneath through Twitter to add into your account above.</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div>',footer:'<button class="pull-right xbtn-blue xbtn-add">Add</button><a class="pull-right xbtn-cancel">Cancel</a>'},onShowBefore:function(t){var e=i(t.currentTarget).data("source"),a=e.identity,s=d.get("user");this._identity=a,this.$(".context-user").find("img").attr("src",s.avatar_filename).parent().next().text(s.name),this.$(".context-identity").find("img").attr("src",a.avatar_filename).next().addClass("icon16-identity-"+a.provider),this.$(".identity").text(r.printExtUserName(a)),"email"!==a.provider&&this.$(".xbtn-done").text("Authorize")}}},c.mergeidentity={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-donot":function(){this.hide()},"click .xbtn-merge":function(){var t=this,e=this.$(".merge-list").find("input:checked"),i=[];if(e.length){for(var a=0,s=e.length;s>a;++a)i.push(e.eq(a).parents("li").data("identity-id"));return n.request("mergeIdentities",{type:"POST",params:{token:this.browsing_token},data:{identity_ids:"["+(""+i)+"]"}},function(){t.hide(),window.location.href="/"}),void 0}this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-mi",title:"Merge Identity",body:'<div class="shadow title">Merge Identity</div><div>You just successfully merged identity underneath:</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div><div class="clearfix merge-container"><div class="alert-label">Following identities might also belong to you. Merge them into your current account to avoid switching identities back and forth.</div><div class="merge-list"><ul class="unstyled"></ul></div></div>',footer:'<button class="pull-right xbtn-blue xbtn-merge" style="margin-left: 10px;">Merge</button><button class="pull-right xbtn-white xbtn-donot">Do NOT</button>'},onShowBefore:function(t){var e=i(t.currentTarget).data("source"),a=e.merged_identity,s=e.browsing_token,n=e.mergeable_user,d=n.identities,o='<li class="clearfix" data-identity-id="{{id}}"><label for="identity-{{i}}"><input class="pull-left" id="identity-{{i}}" name="identity-{{i}}" type="checkbox" /><div class="pull-left box identity">{{external_username}}</div><div class="pull-right avatar"><img width="40" height="40" alt="" src="{{avatar_filename}}" /><i class="provider icon16-identity-{{provider}}"></i></div></label></li>',l=this.$(".merge-list ul");this.$(".context-identity").find("img").attr("src",a.avatar_filename),this.$(".context-identity").find(".identity").text(r.printExtUserName(a)),this.browsing_token=s;for(var c=0,u=d.length;u>c;++c)l.append(i(o.replace("{{id}}",d[c].id).replace(/\{\{i\}\}/g,c).replace("{{external_username}}",r.printExtUserName(d[c])).replace("{{avatar_filename}}",d[c].avatar_filename).replace("{{provider}}",d[c].provider)))}}},c.verification_email={options:{onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},events:{"click .xbtn-verify":function(t){var e=i(t.currentTarget);if(e.hasClass("disabled")||e.hasClass("success"))return e.hasClass("success")&&this.hide(),void 0;var a=this,s=e.data("identity_id"),r=d.get("authorization"),o=r.token;this.befer=n.request("verifyUserIdentity",{type:"POST",params:{token:o},data:{identity_id:s},beforeSend:function(){e.addClass("disabled")},complete:function(){e.removeClass("disabled")}},function(t){a.$(".verify-before").addClass("hide"),"VERIFYING"===t.action?(a.$(".verify-after").removeClass("hide"),e.text("Done").addClass("success")):a.$(".xalert-error").removeClass("hide")})},"click .xbtn-cancel":function(){var t=this.dialog_from;this.hide(),t&&(i('[data-dialog-type="'+t+'"]').trigger("click.dialog.data-api"),i("#identity").focusend())}},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40"><i class="provider icon16-identity-email"></i></div><div class="box identity"></div><p class="verify-before">Confirm sending verification to your mailbox?</p><p class="verify-after hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</p><div class="xalert-error hide"><span class="xalert-fail">Requested too much, hold on awhile.</span><br />Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</div>',footer:'<button class="pull-right xbtn-blue xbtn-verify">Verify</button><a class="pull-right xbtn-cancel">Cancel</a>'},onShowBefore:function(t){var e=i(t.currentTarget),s=e.data("identity-id")||e.parents("li").data("identity-id"),n=d.get("user"),r=a.filter(n.identities,function(t){return t.id===s?!0:void 0})[0];this.$(".xbtn-verify").data("identity_id",r.id),this.$(".identity").text(r.external_id),this.$(".avatar").attr("src",r.avatar_filename)}}},c.verification_oauth={options:{events:{"click .xbtn-verify":function(t){var e=i(t.currentTarget),a=this;if(e.hasClass("disabled")||e.hasClass("success"))return e.hasClass("success")&&this.hide(),void 0;var s=e.data("identity_id"),r=d.get("authorization"),o=r.token;return this.befer=n.request("verifyUserIdentity",{type:"POST",params:{token:o},data:{identity_id:s},beforeSend:function(){e.addClass("disabled")},complete:function(){e.removeClass("disabled")}},function(t){window.location.href=t.url},function(t){var e=t&&t.meta&&t.meta.code;400===e&&a.hide()}),t.preventDefault(),!1},"click .xbtn-cancel":function(){this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40"><i class="provider"></i></div><div class="box identity"></div><p class="xalert-twitter hide">You will be directed to Twitter website to authenticate. Don’t forget to follow @<span class="x-sign">EXFE</span> so we could send you invitation PRIVATELY through Direct Message.</p><p>We hate spam, will NEVER disappoint your trust.</p>',footer:'<button class="pull-right xbtn-blue xbtn-verify">Verify</button><a class="pull-right xbtn-cancel">Cancel</a>'},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},onShowBefore:function(t){var e=i(t.currentTarget),s=e.parents("li").data("identity-id"),n=d.get("user"),o=a.find(n.identities,function(t){return t.id===s?!0:void 0});this.$(".xbtn-verify").data("identity_id",o.id),this.$(".identity").text(r.printExtUserName(o)),this.$(".avatar").attr("src",o.avatar_filename),this.$("i.provider").addClass("icon16-identity-"+o.provider),this.$(".xalert-"+o.provider).removeClass("hide")}}},c.verification_phone={options:{events:{},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div>'}}},c.setpassword={options:{onHideAfter:function(){this.befer&&this.befer.abort()&&(this.befer=null),this.destory()},events:{'click [data-dismiss="dialog"]':function(){window.location.href="/"},"submit .modal-form":function(){return this.$(".xbtn-success").click(),!1},"click .password-eye":function(t){var e=i(t.currentTarget);e.prev().prop("type",function(t,e){return"password"===e?"text":"password"}).focus(),e.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-success":function(t){var e=this,a=e.$("#stpwd").val(),r=e.srcNode;if(!a)return a||alert("Please set EXFE password."),void 0;t.preventDefault();var o=i(t.currentTarget),l=this._user,c=this._token,u=this.signed;if(this._setup){var h=function(t,e,a,r,l,c){var u=n.request("setPassword",{type:"POST",params:{token:e},resources:{user_id:a.id},data:{new_password:r},beforeSend:function(){o.addClass("disabled loading")},complete:function(){o.removeClass("disabled loading")}},function(t){d.set("authorization",t),s.on("app:user:signin",t.token,t.user_id,!0),l&&l.data("dialog",null).data("dialog-type","changepassword").find("span").text("Change Password..."),i(".set-up").remove(),c&&c.hide()},function(s){c&&c.hide();var n=s.meta;if(403===n.code){var o=n.errorType;"invalid_current_password"===o&&alert("Invalid current password.")}else if(401===n.code&&"authenticate_timeout"===n.errorType&&t){var l=i('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');i("#app-tmp").append(l);var u=d.get("authorization");e=u.token,l.trigger("click.dialog.data-api",{callback:function(){h(t,e,a,r)}})}});c&&(c.befer=u)};h(u,c,l,a,r,e)}else{var p=function(t,e,a,s,r){var o=n.request("resetPassword",{type:"POST",data:{token:e,name:a.name,password:s}},function(t){d.set("authorization",t.authorization),r&&r.hide(),window.location.href="/"},function(n){r&&r.hide();var o=n.meta;if(o&&401===o.code&&"authenticate_timeout"===o.errorType){var l=i('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');i("#app-tmp").append(l);var c=d.get("authorization");e=c.token,l.trigger("click.dialog.data-api",{callback:function(){p(t,e,a,s)}})}});r&&(r.befer=o)};p(u,c,l,a,e)}}},backdrop:!1,viewData:{cls:"mblack modal-sp",title:"Set Password",body:'<div class="shadow title">Set Password</div><form class="modal-form"><fieldset><legend>Please set <span class="x-sign">EXFE</span> password of your account.<br />All your identities share the same password for sign-in and account management.</legend><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div class="control-group"><label class="control-label" for="stpwd">Password:</label><div class="controls"><input class="input-large" id="stpwd" placeholder="Set EXFE password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer"></i></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue xbtn-success">Done</button>'},onShowBefore:function(t){var e=i(t.currentTarget).data("source"),a=i(t.currentTarget).data("token");this.signed=!1,this._setup=!1,e?(this._user=e.user,this._token=a||e.token,this._setup=e.setup):(this.signed=!0,this._user=d.get("user"),this._token=a||d.get("authorization").token,this._setup=!this._user.password),this.$(".avatar img").attr("src",this._user.avatar_filename),this.$(".username").text(this._user.name)}}},c.setup_email={options:{onHideAfter:function(){this.destory()},events:{'click [data-dismiss="dialog"]':function(){window.location.href="/"},"blur #name":function(t){var e=r.trim(i(t.currentTarget).val()),a=this.$('[for="name"]'),s=a.find("span");e?r.utf8length(e)>30?(s.text("Too long."),a.addClass("label-error")):r.zh_CN.test(e)?(a.addClass("label-error"),s.text("Invalid character.")):(a.removeClass("label-error"),s.text("")):(a.addClass("label-error"),s.text(""))},"blur #password":function(t){var e=r.trim(i(t.currentTarget).val()),a=this.$('[for="password"]'),s=a.find("span");e?(a.removeClass("label-error"),s.text("")):(a.addClass("label-error"),s.text("Password incorrect."))},"click #password-eye":function(t){var e=i(t.currentTarget),a=e.prev();a.prop("type",function(t,e){return"password"===e?"text":"password"}),e.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-success":function(){var t=this,e="user"===this._tokenType,a=this._page,r=e?"resetPassword":"setupUserByInvitationToken",o={};if(o.name=i.trim(this.$("#name").blur().val()),o.password=this.$("#password").blur().val(),e?o.token=this._originToken:o.invitation_token=this._originToken,!this.$('[for="name"]').hasClass("label-error")||!this.$('[for="password"]').hasClass("label-error")){var l;n.request(r,{type:"POST",data:o},function(e){if("resolve"===a)if(l=d.get("authorization")){i("#app-user-menu").find(".set-up").remove();var n=i("#app-browsing-identity"),r=n.data("settings");r.setup=!1,r.originToken=e.authorization.token,n.data("settings",r).trigger("click.data-api")}else d.set("authorization",e.authorization),d.set("user",t._browsing_user),window.location.href="/";else l=e.authorization,s.emit("app:user:signin:after",function(){window.location.href="/"}),s.emit("app:user:signin",l.token,l.user_id);t.hide()})}}},backdrop:!1,viewData:{cls:"mblack modal-su",title:"Set Up Account",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><form class="modal-form"><fieldset><legend>For easier further use, please set up account of your identity underneath. Otherwise, <span class="underline">sign in</span> your existing account to merge with this identity.</legend><div class="clearfix control-group"><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="identity box"></div></div><div class="control-group"><label class="control-label" for="name">Display name: <span></span></label><div class="controls"><input type="text" class="input-large" id="name" autocomplete="off" placeholder="Your recognizable name" /></div></div><div class="control-group"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Set EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue xbtn-success">Done</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Cancel</a>'},onShowBefore:function(t){var e=i(t.currentTarget).data("source");if(e){var a=e.identity;this._browsing_user=e.browsing_user,this._tokenType=e.tokenType,this._originToken=e.originToken,this._forward=e.forward||"/",this._page=e.page,this.$("#name").val(e.user_name||""),this.$(".identity").text(r.printExtUserName(a)),this.$(".avatar").attr("src",a.avatar_filename).next().addClass("icon16-identity-"+a.provider),this.$(".xbtn-siea").data("source",r.printExtUserName(a))}}}},c.setup_twitter={options:{onHideAfter:function(){this._oauth_&&(this._oauth_.abort(),this._oauth_=null),this.destory()},events:{"click .authorize":function(){this._oauth_=i.ajax({url:"/OAuth/Authenticate?provider=twitter",type:"POST",dataType:"JSON",success:function(t){var e=t.meta.code;200===e&&(window.location.href=t.response.redirect)}})}},backdrop:!1,viewData:{cls:"mblack modal-su",title:"Set Up Account",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><form class="modal-form"><fieldset><legend>You’re browsing as identity underneath, please authorize through Twitter to set up your <span class="x-sign">EXFE</span> account.</legend><div class="clearfix control-group"><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="box identity"></div></div><div class="clearfix"><button class="pull-right xbtn-blue authorize">Authorize</button><a class="pull-right underline pointer cancel" data-dismiss="dialog">Cancel</a></div></fieldset></form>',footer:""},onShowBefore:function(t){var e=i(t.currentTarget).data("source");if(e){var a=e.identity;this._tokenType=e.tokenType,this._originToken=e.originToken,this.$(".identity").text(r.printExtUserName(a)),this.$(".avatar").attr("src",a.avatar_filename).next().addClass("icon16-identity-"+a.provider),this.$(".xbtn-siea").data("source",r.printExtUserName(a))}}}},c.browsing_identity={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-go":function(){window.location.href="/"},"click .xbtn-merge":function(){var t=this,e=d.get("authorization"),s=e.token,r=this._token,o=this._identity,l={browsing_identity_token:r,identity_ids:"["+o.id+"]"};n.request("mergeIdentities",{type:"POST",params:{token:s},data:l},function(e){if(t.hide(),e.mergeable_user=null,e.mergeable_user){var s=i('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">'),n=d.get("user");s.data("source",{merged_identity:a.find(n.identities,function(t){return t.id===o.id?!0:void 0}),browsing_token:r,mergeable_user:e.mergeable_user}),s.appendTo(i("#app-tmp")),s.trigger("click.dialog.data-api"),i(".modal-mi").css("top",230)}else window.location.href="/"})}},backdrop:!1,viewData:{cls:"mblack modal-bi",title:"Browsing Identity",body:'<div class="shadow title">Browsing Identity</div><div class="user hide"><div>You’re currently signed in account underneath, you can continue with this account.</div><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div class="clearfix"><button class="pull-right xbtn-white xbtn-go">Go</button><a class="pull-right xbtn-cancel" data-dismiss="dialog">Cancel</a></div><div class="spliterline"></div></div><div class="browsing-tips"><span class="tip-0 hide">Otherwise, you’re</span><span class="tip-1 hide">You’re</span> currently browsing this page as identity underneath, please choose an option to continue.</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div>',footer:'<button class="xbtn-white xbtn-sias hide" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00">Sign In and Switch</button><button class="xbtn-white xbtn-sui hide" data-widget="dialog" data-dialog-type="setup_email">Set Up Identity</button>'},onShowBefore:function(t){var e=i(t.currentTarget).data("settings");if(e){var a=e.normal,s=e.browsing,n=e.setup,d=e.action;this._token=e.originToken,this._user=a,this._browsing_user=s,this._setup=n,this._action=d,this._tokenType=e.tokenType,this._user?(this.$(".user").removeClass("hide").find("img").attr("src",a.avatar_filename).parent().next().text(a.name||a.nickname),this.$(".xbtn-merge").removeClass("hide"),this.$(".browsing-tips").find(".tip-0").removeClass("hide")):(this.$(".xbtn-sias, .xbtn-sui").addClass("pull-right"),this.$(".browsing-tips").find(".tip-1").removeClass("hide")),this.$("browsing-tips").find("span").eq(this._user?0:1).removeClass("hide");var o=s.identities[0];this._identity=o;var l=r.printExtUserName(o);this.$(".context-identity").find("img").attr("src",o.avatar_filename).next().addClass("icon16-identity-"+o.provider),this.$(".context-identity").find(".identity").text(l),this._setup?this.$(".xbtn-sui").removeClass("hide").attr("data-dialog-type","setup_"+o.provider).data("source",{identity:o,originToken:e.originToken,tokenType:e.tokenType}):this.$(".xbtn-sias").removeClass("hide").data("source",l)}}}},c.read_only={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-ro",title:"Read-only Browsing",body:'<div class="shadow title">Read-only Browsing</div><div>You’re browsing this page in read-only mode as <span></span> underneath. To change anything on this page, please <span class="underline">sign in</span> first.</div><div class="clearfix context-user hide"><div class="pull-left avatar"><img src="" alt="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="context-identity hide"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="pull-left box identity"></div></div>',footer:'<button class="pull-right xbtn-blue" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00">Sign In...</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Cancel</a>'},onShowBefore:function(t){var e=i(t.currentTarget).data("settings");if(e){var a=e.isBrowsing,s=r.printExtUserName(e.identities[0]);if(this.$("legend span").eq(0).text(a?"identity":"user"),this.$(".xbtn-blue").data("source",s),a){var n=this.$(".context-identity").removeClass("hide");n.find(".identity").text(s),n.find(".avatar img").attr("src",e.identities[0].avatar_filename),n.find(".provider").addClass("icon16-identity-"+e.identities[0].provider)}else{var d=this.$(".context-user").removeClass("hide");d.find(".username").text(e.name),d.find(".avatar img").attr("src",e.avatar_filename)}}}}},c.revoked={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-re",title:"Revoked Identity",body:'<div class="shadow title">Revoked Identity</div>'}}},c.authentication={updateIdentity:function(t){var e=this.$(".context-identity");e.find(".avatar img").attr("src",t.avatar_filename),e.find(".provider").attr("class","provider icon16-identity-"+t.provider),e.find(".identity").text(t.eun),this._identity=t},options:{viewData:{cls:"mblack modal-au",title:"Authentication",body:'<div class="shadow title">Authorization</div><div class="d0 hide"><div class="detials">You’re about to change your account details, for security concerns, please authenticate your account.</div><div class="clearfix context-user"><div class="pull-left avatar"><img src="" alt="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="modal-form"><div class="control-group"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Your EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div></div></div><div class="d1 hide"><div class="detials">You’re about to change your account details. For security concern, please re-authenticate your identity and set your <span class="x-sign">EXFE</span> password first.</div><div class="context-identity"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="clearfix dropdown-toggle" data-toggle="dropdown"><div class="pull-left box identity"></div><ul class="dropdown-menu"></ul><div class="pull-left caret-outer hide"><b class="caret"></b></div></div></div><div class="why">Why I have to do this?</div><div class="answer">Sorry for the inconvenience. Sometimes, we have to compromise on experience for your account security. Re-authentication is to avoid modification by others who can possibly access your computer.</div></div>',footer:'<button class="pull-left xbtn xbtn-white xbtn-forgotpwd d0 hide" data-dialog-from="authentication" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn xbtn-blue xbtn-auth d1 hide">Authenticate</button><button class="pull-right xbtn xbtn-blue xbtn-done d0 hide">Done</button><a class="pull-right xbtn-discard d0 hide" data-dismiss="dialog">Cancel</a>'},events:{"click .xbtn-done":function(){var t=this,e=d.get("user"),i=e.identities[0],a=i.external_username,s=i.provider,o=r.trim(t.$("#password").val());n.request("signin",{type:"POST",data:{external_username:a,provider:s,password:o,name:"",auto_signin:!0}},function(e){d.set("authorization",e);var i=t.callback;t.destory(),i()})},"click .xbtn-auth":function(t){var e=this,a=i(t.currentTarget);if(a.hasClass("xbtn-success"))return e.$(".verify-after").addClass("hide"),a.removeClass("xbtn-success").text("Verify"),e.hide(),!1;var s=e._identity.provider,r=e._identity.external_username;e.befer=n.request("verifyIdentity",{type:"POST",data:{provider:s,external_username:r}},function(t){"REDIRECT"===t.action&&(window.location.href=t.url)})},"click .caret-outer":function(t){this.$(".dropdown-toggle").addClass("open"),t.stopPropagation()},"hover .dropdown-menu > li":function(t){var e=t.type,a=i(t.currentTarget);a[("mouseenter"===e?"add":"remove")+"Class"]("active")},"click .dropdown-menu > li":function(t){var e=this.$(".dropdown-menu").data("identities"),a=i(t.currentTarget).data("index");this.updateIdentity(e[a])}},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},onShowBefore:function(t){var e=this,i=d.get("user"),a=i.password;if(e.$(".d"+(a?0:1)).removeClass("hide"),t&&t._data&&(e.callback=t._data.callback),e.callback&&(e.callback=function(){}),a)e.$(".modal-body .d0").find(".avatar img").attr("src",i.avatar_filename).parent().next().text(i.name),e.$(".xbtn-forgotpwd").data("source",i.identities);else{var s,n,o=i.identities;if(o&&(s=o.length)){if(n=o[0],n.eun=r.printExtUserName(n),s>1){e.$(".context-identity").addClass("switcher");for(var l="",c=0;s>c;c++)l+='<li data-index="'+c+'"><i class="pull-right icon16-identity-'+o[c].provider+'"></i>',o[c].eun=r.printExtUserName(o[c]),l+="<span>"+o[c].eun+"</span>",l+="</li>";e.$(".dropdown-menu").html(l).data("identities",o)}e.updateIdentity(n)}}}}},c.unsubscribe={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-done":function(t){t.preventDefault(),this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-unsubscribe",title:"Unsubscribe Email",body:'<div class="shadow title">Unsubscribe update email</div><p>You just unsubscribe update email of <span class="x">·X·</span> “<span class="x-title"></span>”.</p>',footer:'<button class="pull-right xbtn-white xbtn-done">Done</button>'},onShowBefore:function(t){var e=i(t.currentTarget).data("source");this.$(".x-title").text(e.title)}}};var u=l.extend({availability:!1,init:function(){var t=this;s.off("widget-dialog-identification-auto"),s.on("widget-dialog-identification-auto",function(e){var i=t.$('[for="identity"]'),a=i.find("span"),s=t.$('[for="password"]'),n=s.find("span");t.availability=!1,t.identityFlag=null;var r;"d24"===t.switchTabType&&(r="d01"),t.$(".xalert-error").addClass("hide"),t.$(".help-subject").removeClass("icon14-question").addClass("icon14-clear"),e?(i.removeClass("label-error"),a.text(""),e.identity&&e.identity.avatar_filename?(t._identity=e.identity,t.$(".user-identity").removeClass("hide").find("img").attr("src",e.identity.avatar_filename).next().attr("class","provider icon16-identity-"+e.identity.provider)):(t._identity=null,t.$(".user-identity").addClass("hide")),"phone"===e.identity.provider&&t.$(".phone-tip").toggleClass("hide",/\+/.test(t.$("#identity").val())),t.identityFlag=e.registration_flag,"SIGN_IN"===e.registration_flag?(r="d01",t.$(".xbtn-forgotpwd").removeClass("hide"),s.removeClass("label-error"),n.text("")):"SIGN_UP"===e.registration_flag?(r="d02",s.removeClass("label-error"),n.text("")):"AUTHENTICATE"===e.registration_flag?(r="d00",t.$(".help-subject").removeClass("icon14-question").addClass("icon14-clear"),t.$(".authenticate").removeClass("hide")):"VERIFY"===e.registration_flag&&(r="d04"),t.availability=!0):(t.$(".phone-tip").addClass("hide"),t.$(".help-subject").removeClass("icon14-clear").addClass("icon14-question")),r&&t.switchTabType!==r&&t.switchTab(r),t.$(".x-signin")[(t.availability?"remove":"add")+"Class"]("disabled"),t.$(".xbtn-forgotpwd").data("source",e?[e.identity]:e)}),s.off("widget-dialog-identification-nothing"),s.on("widget-dialog-identification-nothing",function(){t.$(".authenticate").addClass("hide"),t.$(".user-identity").addClass("hide"),t.$('[for="identity"]').removeClass("label-error").find("span").text(""),t.$(".xbtn-forgotpwd").addClass("hide").data("source",null),t.availability=!1,t.$(".x-signin")[(t.availability?"remove":"add")+"Class"]("disabled")})},resetInputs:function(){this.$("input").val(""),this.$(".label-error").removeClass("label-error").find("span").text(""),this.$(".icon16-pass-show").toggleClass("icon16-pass-show icon16-pass-hide").prev().prop("type","password"),this.$("#identity").focusend()},setPasswordPlaceHolder:function(t){"d02"===t?this.$("#password").attr("placeholder","Set your EXFE Password"):"d01"===t&&this.$("#password").attr("placeholder","Your EXFE Password")},getFormData:function(t){var e=r.trim(this.$("#identity").val()),i=r.parseId(e);return("d01"===t||"d02"===t)&&(i.password=this.$("#password").val()),"d01"===t&&(i.auto_signin=this.$("#auto-signin").prop("checked")),"d02"===t&&(i.name=r.trim(this.$("#name").val())),i},switchTab:function(t){if(this.$(".d").not(".hide").addClass("hide").end().filter("."+t).removeClass("hide"),this.$(".x-signin")[(this.availability?"remove":"add")+"Class"]("disabled"),this.switchTabType=t,this.isShown&&("d00"===this.switchTabType||"d01"===this.switchTabType||"d02"===this.switchTabType)){var e=this.$("#identity");e.focusend()}this.setPasswordPlaceHolder(t)}});e.Identification=u});