define("xdialog",function(e,t){"use strict";var n=e("jquery"),r=e("rex"),i=e("bus"),s=e("api"),o=e("util"),u=e("store"),a=e("handlebars"),f=e("dialog"),l={};t.dialogs=l,l.identification={options:{errors:{failed:"Password incorrect.",no_password:"Password incorrect.",no_external_id:"Set up this new identity."},onCheckUser:function(){var e=u.get("lastIdentity"),t=u.get("last_external_username");e&&(this.availability=!0,this.$("#identity").val(t),this.$(".x-signin").removeClass("disabled loading"),this.$(".user-identity").removeClass("hide").find("img").attr("src",e.avatar_filename).next().attr("class","provider icon16-identity-"+e.provider),this.$(".xbtn-forgotpwd").data("source",[e]),this.switchTab("d01")),this.$(".help-subject").toggleClass("icon14-question",!this.availability)},onShowBefore:function(e){var t=n(e.currentTarget).data("source");t?this.$("#identity").val(t):this.emit("checkUser")},onShowAfter:function(){(this.switchTabType==="d00"||this.switchTabType==="d01"||this.switchTabType==="d02")&&this.$("#identity").focusend()},onHideAfter:function(){this.$(".modal-body").eq(0).css("opacity",1),this.switchTabType="d00",this._oauth_&&(this._oauth_.abort(),this._oauth_=null),this.destory(),n(".popmenu").remove()},events:{"keypress .modal-main":function(e){var t=this.switchTabType,n=e.keyCode;this.availability&&(t==="d01"||t==="d02")&&n===13&&this.$(".x-signin").click()},"click .oauth > a":function(e){e.stopPropagation(),e.preventDefault();var t=this,r=n(e.currentTarget),i=r.data("oauth");t.$(".authentication").find(".oauth-provider").text(i),t._oauth_=n.ajax({url:"/OAuth/Authenticate?provider="+i,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){t.$(".modal-body").eq(0).css("opacity",0),t.switchTab("d05"),t.$(".authentication").find("img").removeClass("hide"),t.$(".authentication").find(".redirecting").removeClass("hide"),t.$(".authentication").find(".xalert-fail").addClass("hide"),t.$(".xbtn-oauth").addClass("hide")},success:function(e){var n=e.meta.code;n===200?window.location.href=e.response.redirect:(t.$(".authentication").find("img").addClass("hide"),t.$(".authentication").find(".redirecting").addClass("hide"),t.$(".authentication").find(".xalert-fail").removeClass("hide"),t.$(".xbtn-oauth").removeClass("hide"))}})},"click .xbtn-oauth":function(){return this.$(".modal-body").eq(0).css("opacity",1),this.switchTab("d00"),!1},"click .xbtn-verify":function(e){var t=this,r=n(e.currentTarget);if(r.hasClass("xbtn-success"))return t.$(".verify-after").addClass("hide"),r.removeClass("xbtn-success").text("Verify"),t.hide(),!1;var i=t._identity.provider,o=t._identity.external_id;s.request("verifyIdentity",{type:"POST",data:{provider:i,external_username:o}},function(e){t.$(".verify-before").addClass("hide"),e.action==="VERIFYING"?(t.$(".verify-after").removeClass("hide"),r.addClass("xbtn-success").text("Done")):r.addClass("verify-error").removeClass("hide")})},"blur #identity":function(e){var t=o.trim(n(e.currentTarget).val()),r=this.$('[for="identity"]'),i=r.find("span");t.length&&!o.parseId(t).provider?(r.addClass("label-error"),i.text("Invalid identity.")):(r.removeClass("label-error"),i.text(""))},"blur #name":function(e){var t=o.trim(n(e.currentTarget).val()),r=this.$('[for="name"]'),i=r.find("span");t?o.utf8length(t)>30?(i.text("Too long."),r.addClass("label-error")):o.zh_CN.test(t)?(r.addClass("label-error"),i.text("Invalid character.")):(r.removeClass("label-error"),i.text("")):(r.addClass("label-error"),i.text(""))},"blur #password":function(e){var t=o.trim(n(e.currentTarget).val()),r=this.$('[for="password"]'),i=r.find("span");t?(r.removeClass("label-error"),i.text("")):(r.addClass("label-error"),i.text("Password incorrect."))},"click .help-subject":function(e){var t=n(e.currentTarget),r;t.hasClass("icon14-question")?(r='Identity is your online representative, such as email, <span class="strike">mobile no.</span>, and your account username on other websites like Twitter, Facebook, etc.',t.parent().find(".xalert-error:eq(0)").html(r).removeClass("hide")):(t.toggleClass("icon14-question icon14-clear"),this.resetInputs(),this.$(".user-identity").addClass("hide"),u.remove("lastIdentity"),u.remove("last_external_username"),u.remove("authorization"),u.remove("user"),u.remove("identities"),this.$('[data-typeahead-type="identity"]').data("typeahead").source=null,this.switchTab("d00"))},"click #password-eye":function(e){var t=n(e.currentTarget),r=t.prev();r.prop("type",function(e,t){return t==="password"?"text":"password"}),t.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-forgotpwd":function(e){e.preventDefault(),this.element.addClass("hide"),n("#js-modal-backdrop").addClass("hide")},"click .xbtn-setup":function(e){e.preventDefault(),this.$(".modal-body").eq(0).css("opacity",.05),this.switchTab("d03")},"click .xbtn-isee":function(e){e.preventDefault(),this.$(".modal-body").eq(0).css("opacity",1),this.$("#identity").val(""),this.switchTab("d02")},"click .xbtn-startover":function(e){e.preventDefault(),this.$("#identity").val(""),this.resetInputs(),this.switchTab("d00",!0)},"click .x-signin":function(e){var t=n(e.currentTarget);if(t.hasClass("disabled"))return;var r=this,a=this.switchTabType,c=this.getFormData(a);r.$("#password").trigger("blur"),a==="d02"&&r.$("#name").trigger("blur");if(!c.password||a==="d02"&&!c.name)return;(a==="d01"||a==="d02")&&s.request("signin",{type:"POST",data:{external_username:c.external_username,provider:c.provider,password:c.password,name:c.name||"",auto_signin:!!c.auto_signin},beforeSend:function(){t.addClass("disabled loading")},complete:function(){t.removeClass("disabled loading")}},function(e){delete App.request.session.browsing_authorization,delete App.request.session.browsing_user,u.set("authorization",e),u.set("last_external_username",o.printExtUserName(c)),r.hide();if(a==="d01"||a==="d02")i.emit("app:user:signin",e.token,e.user_id,!1,!0);else{var t=new f(l.welcome);t.render(),t.show({identity:{name:c.name,provider:c.provider}})}},function(e){var t=e&&e.meta,n=t&&t.errorType||"",i=t&&t.errorDetail||"";n==="no_password"||n==="failed"?r.$('[for="password"]').addClass("label-error").find("span").text(i||r.options.errors[n]):n==="no_external_id"&&r.$("#name").nextAll(".xalert-info").removeClass("hide")})}},backdrop:!0,viewData:{cls:"modal-id",title:"Start",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><div class="clearfix"><div class="pull-left authorize">Authenticate with:</div><div class="pull-left oauth"><a href="#" class="oauth-twitter" data-oauth="twitter">twitter</a><a href="#" class="oauth-facebook" data-oauth="facebook">facebook</a></div></div><div class="orspliter">or</div><form class="modal-form"><fieldset><legend>Use your online identity:</legend><div class="clearfix control-group"><label class="control-label" for="identity">Identity: <span class="xalert-message"></span></label><div class="pull-right user-identity hide"><div class="avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div></div><div class="controls"><input type="text" class="input-large identity" id="identity" autocomplete="off" data-widget="typeahead" data-typeahead-type="identity" placeholder="Enter your email" /><i class="help-subject"></i><i class="help-inline small-loading hide"></i><div class="xalert xalert-error hide" style="margin-top: 5px;"></div><div class="xalert xalert-error authenticate hide" style="margin-top: 5px;"><span class="xalert-fail">Please directly authenticate identity above.</span><br />To enable password sign-in for this identity, set an <span class="x-sign">EXFE</span> password first in your profile page.</div></div></div><div class="form-title d d02 hide">Welcome! Please set up your new account.<span class="pull-right form-title-bd"></span></div><div class="control-group d d02 hide"><label class="control-label" for="name">Display name: <span></span></label><div class="controls"><input type="text" class="input-large" id="name" autocomplete="off" placeholder="Desired recognizable name" /></div></div><div class="control-group d d01 d02 hide"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div><div class="control-group d d01 hide"><div class="control-label"><label class="checkbox pointer"><input type="checkbox" id="auto-signin" value="1" checked />Sign in automatically</label></div></div><div class="verify-before d d04 hide"><span class="xalert-fail">This identity requires verification before using.</span><br />Confirm sending verification to your mailbox?</div><div class="verify-after hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div><div class="verify-error hide"><span class="xalert-fail">Requested too much, hold on awhile.</span><br />Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</div></fieldset></form>',footer:'<button class="xbtn-white d d01 xbtn-forgotpwd hide" data-dialog-from="identification" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="xbtn-white d d02 d04 xbtn-startover hide">Start Over</button><button class="pull-right d d04 xbtn-blue xbtn-verify hide">Verify</button><a href="#" class="pull-right xbtn-setup d d00 hide">Looking for sign-up?</a><button class="pull-right xbtn-blue d d01 d02 x-signin disabled hide">Start</button><button class="pull-right xbtn-white d d03 xbtn-isee hide">I See</button><button class="pull-right xbtn-white d hide">OK</button><button class="pull-right xbtn-white d xbtn-oauth hide">Back</button>',others:'<div class="isee d d03 hide"><div class="modal-body"><div class="shadow title">“Sign-Up-Free”</div><p>Tired of signing up all around? Just authorize through your existing accounts from other websites, such as Twitter, <span class="strike">Facebook, Google, etc.</span> (soon to support)</p><p>We hate spam, will NEVER disappoint your trust.</p><p>Alternatively, traditional registration process with email and password is also available.</p></div></div><div class="authentication d d05 hide"><div class="modal-body"><div class="shadow title">Authentication</div><div class="content"><img class="hide" src="/static/img/loading.gif" width="32" height="32" /><p class="redirecting hide">Redirecting to <span class="oauth-provider"></span>…</p><p class="xalert-fail hide">Failed to connect with <span class="oauth-provider"></span> server.</p></div></div></div>'}}},l.sandbox={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-sandbox",title:"Rome",body:'<div class="shadow title">“Rome wasn\'t built in a day.”</div><p><span class="x-sign">EXFE</span> [’ɛksfi] is still in <span class="pilot">pilot</span> stage (with <span class="sandbox">Rome</span> tag). We’re building up blocks, consequently some bugs or unfinished pages may happen. Our apologies for any trouble you may encounter. Any feedback, please email <span class="feedback">feedback@exfe.com</span>. Much appreciated.</p>'}}},l.welcome={options:{events:{"click .xbtn-go":function(){var e=this;if(this._provider==="email"){if(/^\/![a-zA-z0-9]+$/.test(window.location.pathname)){window.location=window.location.pathname;return}}else this.$("#follow").prop("checked")&&this._token&&n.ajax({url:"/OAuth/followExfe?token="+this._token,type:"POST",data:{identity_id:this._identity_id},success:function(){u.remove("oauth")}});e.hide()},"click .why":function(){this.$(".answer").toggleClass("hidden")}},onShowBefore:function(e){var t=e.identity,n=this.$(".title").eq(0);this._provider=t.provider,this._identity_id=t.id,this._token=e.token,this._following=e.following,n.text("Hi, "+t.name+"."),t.provider==="email"?this.$(".provider-email").removeClass("hide"):t.provider==="twitter"&&(this.$(".provider-other").removeClass("hide"),this.$("#follow").prop("checked",this._following))},onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-large modal-wc",title:"Welcome",body:'<div class="shadow title"></div><div class="center shadow title" style="margin-bottom: 0;">Thanks for using <span class="x-sign">EXFE</span>.</div><p class="center">A utility for gathering with friends.</p><div class="modal-content"><p>We save you from calling up every one RSVP, losing in endless emails and messages off the point.</p><p><span class="x">·X·</span> (cross) is a gathering of people, for any purpose. When you get an idea to call up friends to do something together, just <span class="oblique">Gather a <span class="x">·X·</span></span>.</p><p><span class="x-sign">EXFE</span> your friends.</p><p class="provider-email hide" style="color: #191919;">*A welcome email has been sent to your mailbox. Please check to verify your address.*</p><div class="provider-other hide">&nbsp;&nbsp;<span class="underline why">why?</span><label class="pull-left checkbox pointer"><input type="checkbox" id="follow" value="1" checked />Follow @<span class="x-sign">EXFE</span> on Twitter.</label><p class="pull-left answer hidden">So we could send you invitation PRIVATELY through Direct Message. We hate spam, will NEVER disappoint your trust.</p></div></div>',footer:'<button class="pull-right xbtn-white xbtn-go">GO</button>'}}},l.forgotpassword={updateIdentity:function(e){var t=e.provider,n=this.$(".context-identity");this.$(".tab").addClass("hide"),t==="email"?(this.$(".tab1").removeClass("hide"),this.$(".xbtn-send").data("identity",e)):(this.$(".tab2").removeClass("hide"),this.$(".authenticate").data("identity",e)),n.find(".avatar img").attr("src",e.avatar_filename),n.find(".provider").attr("class","provider icon16-identity-"+e.provider),n.find(".identity").text(e.eun)},options:{onHideAfter:function(e){this.befer&&(this.befer.abort(),this.befer=null);if(e){var t=this.dialog_from;t&&n('[data-dialog-type="'+t+'"]').data("dialog").hide()}this.destory()},events:{"click .authenticate":function(e){var t=this,r=n(e.currentTarget),i=r.data("identity");i&&(t.befer=s.request("forgotPassword",{type:"POST",data:{provider:i.provider,external_username:i.external_username},beforeSend:function(){t.$(".send-before").removeClass("hide"),t.$(".send-after").addClass("hide"),r.addClass("disabled")}},function(e){e.action==="REDIRECT"&&(window.location.href=e.url)}))},"click .caret-outer":function(e){this.$(".dropdown-toggle").addClass("open"),e.stopPropagation()},"hover .dropdown-menu > li":function(e){var t=e.type,r=n(e.currentTarget);r[(t==="mouseenter"?"add":"remove")+"Class"]("active")},"click .dropdown-menu > li":function(e){var t=this.$(".dropdown-menu").data("identities"),r=n(e.currentTarget).data("index");this.updateIdentity(t[r])},"click .xbtn-cancel":function(){var e=this.dialog_from;this.hide(),e&&(n('[data-dialog-type="'+e+'"]').data("dialog").element.removeClass("hide"),n("#js-modal-backdrop").removeClass("hide"))},"click .xbtn-done":function(e){this.hide(e);return},"click .xbtn-send":function(e){var t=this,r=n(e.currentTarget);if(r.hasClass("disabled"))return;var i=r.data("identity");i&&(t.befer=s.request("forgotPassword",{type:"POST",data:{provider:i.provider,external_username:i.external_username},beforeSend:function(){t.$(".send-before").removeClass("hide"),t.$(".send-after").addClass("hide"),r.addClass("disabled")},complete:function(){r.removeClass("disabled")}},function(e){e.action==="VERIFYING"&&(t.$(".identity").next().removeClass("hide"),r.addClass("hide"),t.$(".xbtn-done").removeClass("hide"),t.$(".send-before").addClass("hide"),t.$(".send-after").removeClass("hide"))}))}},onShowBefore:function(e){var t=this,r=n(e.currentTarget).data("source"),i,s,o;if(r&&(i=r.length)){s=r[0],o=s.external_username,s.provider==="twitter"&&(o="@"+s.external_username),s.eun=o;if(1<i){t.$(".context-identity").addClass("switcher");var u="";for(var a=0;a<i;a++)o=r[a].external_username,u+='<li data-index="'+a+'"><i class="pull-right icon16-identity-'+r[a].provider+'"></i>',r[a].provider==="twitter"&&(o="@"+r[a].external_username),r[a].eun=o,u+="<span>"+o+"</span>",u+="</li>";t.$(".dropdown-menu").html(u).data("identities",r)}this.updateIdentity(s)}},backdrop:!1,viewData:{cls:"mblack modal-fp",title:"Forgot Password",body:'<div class="shadow title">Forgot Password</div><div>You can reset your <span class="x-sign">EXFE</span> password through identity:</div><div class="context-identity"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="clearfix dropdown-toggle" data-toggle="dropdown"><div class="pull-left box identity"></div><ul class="dropdown-menu"></ul><div class="pull-left caret-outer hide"><b class="caret"></b></div></div></div><div class="alert-label"><div class="send-before tab tab1 hide">Confirm sending reset token to your mailbox?</div><div class="send-after tab hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div><div class="xalert-error tab hide"><p>Requested too much, hold on awhile.</p><p>Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</p></div><div class="authenticate-before tab tab2 hide">You will be directed to Twitter website to authenticate identity above, you can reset password then.</div></div>',footer:'<button class="pull-right xbtn-white xbtn-done hide">Done</button><button class="pull-right xbtn-blue xbtn-send tab tab1 hide">Send</button><button class="pull-right xbtn-blue authenticate tab tab2 hide">Authenticate</button><a class="pull-right xbtn-cancel">Cancel</a>'}}},l.changepassword={options:{onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},events:{"click .xbtn-resetpwd":function(e){var t=u.get("user"),i=t.identities,s=r.filter(i,function(e){if(e.status==="CONNECTED")return!0});if(s.length===1){e.stopPropagation(),this.hide();var o=new f(l.forgotpassword);o.dialog_from="changepassword",o.render(),n(e.currentTarget).data("identity-id",s[0].id),o.show(e)}},"click .password-eye":function(e){var t=n(e.currentTarget),r=t.prev();r.prop("type",function(e,t){return t==="password"?"text":"password"}),t.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-forgotpwd":function(e){var t=u.get("user"),i=t.identities,s=[];r.each(i,function(e){e.status==="CONNECTED"&&s.push(e)}),n(e.currentTarget).data("source",s)},"click .xbtn-success":function(e){var t=this,r=t.$("#cppwd").val(),i=t.$("#cp-npwd").val();if(!r||!i){r?alert("Please input new password."):alert("Please input current password.");return}e.preventDefault();var o=n(e.currentTarget),a=u.get("authorization"),f=a.user_id,l=a.token;t.befer=s.request("setPassword",{type:"POST",params:{token:l},resources:{user_id:f},data:{current_password:r,new_password:i},beforeSend:function(){o&&o.addClass("disabled loading")},complete:function(){o&&o.removeClass("disabled loading")}},function(e){u.set("authorization",e),t&&t.destory()},function(e){var n=e&&e.meta;if(n)if(n.code===403){var r=e.meta.errorType;r==="invalid_current_password"&&alert("Invalid current password.")}else n.code===401&&n.errorType==="authenticate_timeout"&&t&&t.destory()})}},onShowBefore:function(){var e=u.get("user");this.$(".avatar > img").attr("src",e.avatar_filename),this.$(".username").text(e.name)},backdrop:!1,viewData:{cls:"modal-cp mblack modal-large",title:"Change Password",body:'<div class="shadow title">Change Password</div><form class="modal-form"><fieldset><legend>Enter your current <span class="x-sign">EXFE</span> password, and set new one. All your identities share the same password for sign-in and account management.</legend><div class="clearfix context-user"><div class="pull-left avatar"><img src="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="control-group"><label class="control-label" for="cppwd">Password:</label><div class="controls"><input class="input-large" id="cppwd" placeholder="Current password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer"></i></div></div><div class="control-group"><label class="control-label" for="cp-npwd">New Password:</label><div class="controls"><input class="input-large" id="cp-npwd" placeholder="Set new EXFE password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer"></i></div></div></fieldset></form>',footer:'<button class="xbtn-white xbtn-forgotpwd" data-dialog-from="changepassword" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn-blue xbtn-success">Change</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Discard</a>'}}},l.addidentity={options:{errors:{failed:"Password incorrect.",no_password:"Password incorrect.",no_external_id:"Set up this new identity."},backdrop:!1,events:{"click #password-eye":function(e){var t=n(e.currentTarget),r=t.prev();r.prop("type",function(e,t){return t==="password"?"text":"password"}),t.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-forgotpwd":function(e){var t=n(e.currentTarget),r=t.hasClass("disabled");if(r)return e.stopPropagation(),!1},"click .xbtn-startover":function(){this.$(".d1, d2, d3").addClass("hide"),this.$(".d0").removeClass("hide"),this.$("#identity").val("").focus()},"click .xbtn-add":function(e){e.preventDefault();var t=this,i=t.registration_flag,o=t._identity;if(!o)return!1;if(i==="SIGN_IN"){var f=n.trim(t.$("#password").val()),l=!1,c="",h=s.request("signin",{type:"POST",data:{external_username:o.external_username,provider:o.provider,password:f,name:o.name||"",auto_signin:!1}},function(e){l=!0,c=e.token,t.$('[for="password"]').removeClass("label-error").find("span").text(""),t.$("#name").nextAll(".xalert-info").addClass("hide")},function(e){var n=e.meta.errorType,r=e.meta.errorDetail;n==="no_password"||n==="failed"?t.$('[for="password"]').addClass("label-error").find("span").text(r||t.options.errors[n]):n==="no_external_id"&&t.$("#name").nextAll(".xalert-info").removeClass("hide")});h.done(function(){if(l){var e=u.get("authorization"),r=e.token,i=o.id;t.defer=s.request("mergeIdentities",{type:"POST",params:{token:r},data:{browsing_identity_token:c,identity_ids:"["+i+"]"}},function(e){var r=e.status[i];if(r){var s=u.get("user"),o=s.identities;o.push(r),u.set("user",s);var f=a.compile(n("#jst-identity-item").html()),l=f(r);n(".identity-list").append(l),t&&t.destory()}})}}),t.defer=h}else if(i==="SIGN_UP"){var p=o.provider,d=o.external_username||"",v=u.get("user");if(r.find(v.identities,function(e){if(e.provider===p&&e.external_username===d)return!0})){t.destory();return}function m(e,t,r){var i=u.get("authorization"),o=i.token,f=s.request("addIdentity",{type:"POST",params:{token:o},data:{external_username:e,provider:t}},function(e){var t=e.identity,i=u.get("user"),s=i.identities;s.push(t),u.set("user",i);var o=a.compile(n("#jst-identity-item").html()),f=o(e.identity);n(".identity-list").append(f),r&&r.destory()},function(i){var s=i&&i.meta;if(s&&s.code===401&&s.errorType==="authenticate_timeout"){r&&r.destory();var o=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(o);var u=n.Event("click.dialog.data-api");u._data={callback:function(){m(e,t)}},o.trigger(u)}});r&&(r.defer=f)}m(d,p,t)}else i==="AUTHENTICATE"&&t.$('.oauth > a[data-oauth="'+o.provider+'"]').trigger("click")},"click .xbtn-verify":function(e){function h(e,t,r){var i=u.get("authorization"),o=i.token,f=s.request("addIdentity",{type:"POST",params:{token:o},data:{external_username:e,provider:t}},function(e){var t=e.identity,i=u.get("user"),s=i.identities;s.push(t),u.set("user",i);var o=a.compile(n("#jst-identity-item").html()),f=o(e.identity);n(".identity-list").append(f),r&&r.$(".verify-before").addClass("hide"),r&&r.$(".verify-after").removeClass("hide"),r&&r.$(".xbtn-verify").addClass("hide"),r&&r.$(".xbtn-done").removeClass("hide")},function(i){r&&(r.$(".verify-before").removeClass("hide"),r.$(".verify-after").addClass("hide"),r.$(".xbtn-verify").removeClass("hide"),r.$(".xbtn-done").addClass("hide"));var s=i&&i.meta;if(s&&s.code===401&&s.errorType==="authenticate_timeout"){r&&r.destory();var o=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(o);var u=n.Event("click.dialog.data-api");u._data={callback:function(){h(e,t)}},o.trigger(u)}});r&&(r.defer=f)}e.preventDefault();var t=n(e.currentTarget);if(t.hasClass("xbtn-success"))return i.$(".verify-after").addClass("hide"),i.hide(),!1;var i=this,o=i._identity;if(!o)return!1;var f=o.provider,l=o.external_username||"",c=u.get("user");if(r.find(c.identities,function(e){if(e.provider===f&&e.external_username===l)return!0})){i.destory();return}h(l,f,i)},"click .xbtn-done":function(){this.hide()},"click .oauth > a":function(e){function o(e,t,r){var i=u.get("authorization"),a=i.token,f=s.request("addIdentity",{type:"POST",params:{token:a},data:{external_username:e,provider:t}},function(e){window.location.href=e.url,r&&r.destory()},function(i){var s=i&&i.meta;if(s&&s.code===401&&s.errorType==="authenticate_timeout"){r&&r.destory();var u=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(u);var a=n.Event("click.dialog.data-api");a._data={callback:function(){o(e,t)}},u.trigger(a)}});r&&(r.defer=f)}e.preventDefault();var t="",r=n(e.currentTarget).data("oauth"),i=this;return o(t,r,i),!1}},onShowBefore:function(){this.element.removeClass("hide"),this.$("#identity").focusend()},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},viewData:{cls:"mblack modal-id modal-ai",title:"Add Identity",body:'<div class="shadow title">Add Identity</div><div class="clearfix"><div class="pull-left authorize">Authenticate with:</div><div class="pull-left oauth"><a href="#" class="oauth-twitter" data-oauth="twitter">twitter</a><a href="#" class="oauth-facebook" data-oauth="facebook">facebook</a></div></div><div class="orspliter">or</div><form class="modal-form"><fieldset><legend>Use your online identity:</legend><div class="clearfix control-group"><label class="control-label" for="identity">Identity: <span class="xalert-message"></span></label><div class="pull-right user-identity hide"><div class="avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div></div><div class="controls"><input type="text" class="input-large identity" id="identity" autocomplete="off" data-widget="typeahead" data-typeahead-type="identity" placeholder="Enter your email" /><i class="help-subject"></i><i class="help-inline small-loading hide"></i><div class="xalert xalert-error hide" style="margin-top: 5px;"></div><div class="xalert xalert-error authenticate hide" style="margin-top: 5px;"><span class="xalert-fail">Please directly authenticate identity above.</span><br />To enable password sign-in for this identity, set an <span class="x-sign">EXFE</span> password first in your profile page.</div></div></div><div class="control-group d d0"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Identity\'s EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div><div class="verify-before d d1 hide"><span class="xalert-fail">This identity requires verification before using.</span><br />Confirm sending verification to your mailbox?</div><div class="verify-after d2 hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</div></fieldset></form>',footer:'<button class="xbtn-white xbtn-startover d d1 hide">Start Over</button><button class="xbtn-white xbtn-forgotpwd d d0 disabled" data-dialog-from="addidentity" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn-blue xbtn-add d d0">Add</button><button class="pull-right xbtn-blue xbtn-verify d d1 hide">Verify</button><button class="pull-right xbtn-white xbtn-done d d2 hide">Done</button>'}},availability:!1,init:function(){var e=this;e.registration_flag="",i.off("widget-dialog-identification-auto"),i.on("widget-dialog-identification-auto",function(t){if(t){t.identity&&t.identity.avatar_filename?(e._identity=t.identity,e.$(".user-identity").removeClass("hide").find("img").attr("src",t.identity.avatar_filename).next().attr("class","provider icon16-identity-"+t.identity.provider)):(e.$(".user-identity").addClass("hide"),e._identity=null);var n=t.registration_flag;e.registration_flag=n||"",n==="SIGN_IN"?(e.$(".d1, .d2, .d3").addClass("hide"),e.$(".d0").removeClass("hide"),e.$(".xbtn-forgotpwd").removeClass("disabled").data("source",[e._identity])):n==="SIGN_UP"?(e._identity=o.parseId(e.$("#identity").val()),e.$(".d0, .d1, .d3").addClass("hide"),e.$(".xbtn-add").removeClass("hide")):n==="AUTHENTICATE"?(e._identity=o.parseId(e.$("#identity").val()),e.$(".d1, .d2").addClass("hide"),e.$(".d0, .d3").removeClass("hide"),e.$('label[for="password"]').parent().addClass("hide")):n==="VERIFY"&&(e.$(".d0, .d2, .d3").addClass("hide"),e.$(".d1").removeClass("hide")),e.$(".xbtn-success").removeClass("disabled")}else e.$(".xbtn-success").addClass("disabled"),e.$(".xbtn-forgotpwd").addClass("disabled").data("source",null)}),i.off("widget-dialog-identification-nothing"),i.on("widget-dialog-identification-nothing",function(){})}},l.addIdentityAfterSignIn={options:{events:{"click .xbtn-cancel":function(){this.destory()},"click .xbtn-add":function(){var e=this,t=u.get("authorization"),r=t.token,i=this._identity.external_username,o=this._identity.provider;s.request("addIdentity",{type:"POST",params:{token:r},data:{external_username:i,provider:o}},function(t){var n=t.identity,r=u.get("user"),i=r.identities;i.push(n),u.set("user",r),e.destory(),window.location.href="/"},function(t){var r=t&&t.meta;if(r&&r.code===401&&r.errorType==="authenticate_timeout"){e.destory();var i=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(i),i.trigger("click.dialog.data-api")}})}},backdrop:!1,viewData:{cls:"mblack modal-aifsi",title:"Set Up Account",body:'<div class="shadow title">Add Identity</div><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div>Please authorize identity underneath through Twitter to add into your account above.</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div>',footer:'<button class="pull-right xbtn-blue xbtn-add">Add</button><a class="pull-right xbtn-cancel">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source"),r=t.identity,i=u.get("user");this._identity=r,this.$(".context-user").find("img").attr("src",i.avatar_filename).parent().next().text(i.name),this.$(".context-identity").find("img").attr("src",r.avatar_filename).next().addClass("icon16-identity-"+r.provider),this.$(".identity").text(o.printExtUserName(r)),r.provider!=="email"&&this.$(".xbtn-done").text("Authorize")}}},l.mergeidentity={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-donot":function(){this.hide()},"click .xbtn-merge":function(){var e=this,t=this.$(".merge-list").find("input:checked"),n=[];if(t.length){for(var r=0,i=t.length;r<i;++r)n.push(t.eq(r).parents("li").data("identity-id"));s.request("mergeIdentities",{type:"POST",params:{token:this.browsing_token},data:{identity_ids:"["+n.toString()+"]"}},function(){e.hide(),window.location.href="/"});return}this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-mi",title:"Merge Identity",body:'<div class="shadow title">Merge Identity</div><div>You just successfully merged identity underneath:</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div><div class="clearfix merge-container"><div class="alert-label">Following identities might also belong to you. Merge them into your current account to avoid switching identities back and forth.</div><div class="merge-list"><ul class="unstyled"></ul></div></div>',footer:'<button class="pull-right xbtn-blue xbtn-merge" style="margin-left: 10px;">Merge</button><button class="pull-right xbtn-white xbtn-donot">Do NOT</button>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source"),r=t.merged_identity,i=t.browsing_token,s=t.mergeable_user,u=s.identities,a='<li class="clearfix" data-identity-id="{{id}}"><label for="identity-{{i}}"><input class="pull-left" id="identity-{{i}}" name="identity-{{i}}" type="checkbox" /><div class="pull-left box identity">{{external_username}}</div><div class="pull-right avatar"><img width="40" height="40" alt="" src="{{avatar_filename}}" /><i class="provider icon16-identity-{{provider}}"></i></div></label></li>',f=this.$(".merge-list ul");this.$(".context-identity").find("img").attr("src",r.avatar_filename),this.$(".context-identity").find(".identity").text(o.printExtUserName(r)),this.browsing_token=i;for(var l=0,c=u.length;l<c;++l)f.append(n(a.replace("{{id}}",u[l].id).replace(/\{\{i\}\}/g,l).replace("{{external_username}}",o.printExtUserName(u[l])).replace("{{avatar_filename}}",u[l].avatar_filename).replace("{{provider}}",u[l].provider)))}}},l.verification_email={options:{onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},events:{"click .xbtn-verify":function(e){var t=n(e.currentTarget);if(t.hasClass("disabled")||t.hasClass("success")){t.hasClass("success")&&this.hide();return}var r=this,i=t.data("identity_id"),o=u.get("authorization"),a=o.token;this.befer=s.request("verifyUserIdentity",{type:"POST",params:{token:a},data:{identity_id:i},beforeSend:function(){t.addClass("disabled")},complete:function(){t.removeClass("disabled")}},function(e){r.$(".verify-before").addClass("hide"),e.action==="VERIFYING"?(r.$(".verify-after").removeClass("hide"),t.text("Done").addClass("success")):r.$(".xalert-error").removeClass("hide")})},"click .xbtn-cancel":function(){var e=this.dialog_from;this.hide(),e&&(n('[data-dialog-type="'+e+'"]').trigger("click.dialog.data-api"),n("#identity").focusend())}},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40"><i class="provider icon16-identity-email"></i></div><div class="box identity"></div><p class="verify-before">Confirm sending verification to your mailbox?</p><p class="verify-after hide">Verification sent, it should arrive in minutes. Please check your mailbox and follow the instruction.</p><div class="xalert-error hide"><span class="xalert-fail">Requested too much, hold on awhile.</span><br />Receive no verification email? It might be mistakenly filtered as spam, please check and un-spam. Alternatively, use ‘Manual Verification’.</div>',footer:'<button class="pull-right xbtn-blue xbtn-verify">Verify</button><a class="pull-right xbtn-cancel">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget),i=t.data("identity-id")||t.parents("li").data("identity-id"),s=u.get("user"),o=r.filter(s.identities,function(e){if(e.id===i)return!0})[0];this.$(".xbtn-verify").data("identity_id",o.id),this.$(".identity").text(o.external_id),this.$(".avatar").attr("src",o.avatar_filename)}}},l.verification_oauth={options:{events:{"click .xbtn-verify":function(e){var t=n(e.currentTarget),r=this;if(t.hasClass("disabled")||t.hasClass("success")){t.hasClass("success")&&this.hide();return}var i=t.data("identity_id"),o=u.get("authorization"),a=o.token;return this.befer=s.request("verifyUserIdentity",{type:"POST",params:{token:a},data:{identity_id:i},beforeSend:function(){t.addClass("disabled")},complete:function(){t.removeClass("disabled")}},function(e){window.location.href=e.url},function(e){var t=e&&e.meta&&e.meta.code;t===400&&r.hide()}),e.preventDefault(),!1},"click .xbtn-cancel":function(){this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40"><i class="provider"></i></div><div class="box identity"></div><p class="xalert-twitter hide">You will be directed to Twitter website to authenticate. Don’t forget to follow @<span class="x-sign">EXFE</span> so we could send you invitation PRIVATELY through Direct Message.</p><p>We hate spam, will NEVER disappoint your trust.</p>',footer:'<button class="pull-right xbtn-blue xbtn-verify">Verify</button><a class="pull-right xbtn-cancel">Cancel</a>'},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},onShowBefore:function(e){var t=n(e.currentTarget),i=t.parents("li").data("identity-id"),s=u.get("user"),a=r.find(s.identities,function(e){if(e.id===i)return!0});this.$(".xbtn-verify").data("identity_id",a.id),this.$(".identity").text(o.printExtUserName(a)),this.$(".avatar").attr("src",a.avatar_filename),this.$("i.provider").addClass("icon16-identity-"+a.provider),this.$(".xalert-"+a.provider).removeClass("hide")}}},l.verification_phone={options:{events:{},backdrop:!1,viewData:{cls:"mblack modal-ve",title:"Verification",body:'<div class="shadow title">Identity Verification</div><div>Identity to verify:</div>'}}},l.setpassword={options:{onHideAfter:function(){this.befer&&this.befer.abort()&&(this.befer=null),this.destory()},events:{"click .password-eye":function(e){var t=n(e.currentTarget),r=t.prev();r.prop("type",function(e,t){return t==="password"?"text":"password"}),t.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-success":function(e){var t=this,r=t.$("#stpwd").val(),o=t.srcNode;if(!r){r||alert("Please set EXFE password.");return}e.preventDefault();var a=n(e.currentTarget),f=this._user,l=this._token,c=this.signed;if(this._setup){function h(e,t,r,o,f,l){var c=s.request("setPassword",{type:"POST",params:{token:t},resources:{user_id:r.id},data:{new_password:o},beforeSend:function(){a.addClass("disabled loading")},complete:function(){a.removeClass("disabled loading")}},function(e){u.set("authorization",e),i.on("app:user:signin",e.token,e.user_id,!0),f&&f.data("dialog",null).data("dialog-type","changepassword").find("span").text("Change Password..."),n(".set-up").remove(),l&&l.hide()},function(i){l&&l.hide();var s=i.meta;if(s.code===403){var a=s.errorType;a==="invalid_current_password"&&alert("Invalid current password.")}else if(s.code===401&&s.errorType==="authenticate_timeout"&&e){var f=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(f);var c=u.get("authorization");t=c.token,f.trigger("click.dialog.data-api",{callback:function(){h(e,t,r,o)}})}});l&&(l.befer=c)}h(c,l,f,r,o,t)}else{function p(e,t,r,i,o){var a=s.request("resetPassword",{type:"POST",data:{token:t,name:r.name,password:i}},function(e){u.set("authorization",e.authorization),o&&o.hide(),window.location.href="/"},function(s){o&&o.hide();var a=s.meta;if(a&&a.code===401&&a.errorType==="authenticate_timeout"){var f=n('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');n("#app-tmp").append(f);var l=u.get("authorization");t=l.token,f.trigger("click.dialog.data-api",{callback:function(){p(e,t,r,i)}})}});o&&(o.befer=a)}p(c,l,f,r,t)}}},backdrop:!1,viewData:{cls:"mblack modal-sp",title:"Set Password",body:'<div class="shadow title">Set Password</div><form class="modal-form"><fieldset><legend>Please set <span class="x-sign">EXFE</span> password of your account.<br />All your identities share the same password for sign-in and account management.</legend><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div class="control-group"><label class="control-label" for="stpwd">Password:</label><div class="controls"><input class="input-large" id="stpwd" placeholder="Set EXFE password" type="password" autocomplete="off" /><i class="help-inline password-eye icon16-pass-hide pointer"></i></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue xbtn-success">Done</button>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source"),r=n(e.currentTarget).data("token");this.signed=!1,this._setup=!1,t?(this._user=t.user,this._token=r||t.token,this._setup=t.setup):(this.signed=!0,this._user=u.get("user"),this._token=r||u.get("authorization").token,this._setup=!this._user.password),this.$(".avatar img").attr("src",this._user.avatar_filename),this.$(".username").text(this._user.name)}}},l.setup_email={options:{onHideAfter:function(){this.destory()},events:{"blur #name":function(e){var t=o.trim(n(e.currentTarget).val()),r=this.$('[for="name"]'),i=r.find("span");t?o.utf8length(t)>30?(i.text("Too long."),r.addClass("label-error")):o.zh_CN.test(t)?(r.addClass("label-error"),i.text("Invalid character.")):(r.removeClass("label-error"),i.text("")):(r.addClass("label-error"),i.text(""))},"blur #password":function(e){var t=o.trim(n(e.currentTarget).val()),r=this.$('[for="password"]'),i=r.find("span");t?(r.removeClass("label-error"),i.text("")):(r.addClass("label-error"),i.text("Password incorrect."))},"click #password-eye":function(e){var t=n(e.currentTarget),r=t.prev();r.prop("type",function(e,t){return t==="password"?"text":"password"}),t.toggleClass("icon16-pass-hide icon16-pass-show")},"click .xbtn-success":function(){var e=this,t=this._tokenType==="user",r=this._page,o=t?"resetPassword":"setupUserByInvitationToken",a={};a.name=n.trim(this.$("#name").blur().val()),a.password=this.$("#password").blur().val(),t?a.token=this._originToken:a.invitation_token=this._originToken;if(this.$('[for="name"]').hasClass("label-error")&&this.$('[for="password"]').hasClass("label-error"))return;s.request(o,{type:"POST",data:a},function(t){if(r==="resolve"){var s=u.get("authorization");if(!s)u.set("authorization",t.authorization),u.set("user",e._browsing_user),window.location.href="/";else{n("#app-user-menu").find(".set-up").remove();var o=n("#app-browsing-identity"),a=o.data("settings");a.setup=!1,a.originToken=t.authorization.token,o.data("settings",a).trigger("click.data-api")}}else{var s=t.authorization;i.emit("app:user:signin:after",function(){window.location.href="/"}),i.emit("app:user:signin",s.token,s.user_id)}e.hide()})}},backdrop:!1,viewData:{cls:"mblack modal-su",title:"Set Up Account",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><form class="modal-form"><fieldset><legend>For easier further use, please set up account of your identity underneath. Otherwise, <span class="underline">sign in</span> your existing account to merge with this identity.</legend><div class="clearfix control-group"><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="identity box"></div></div><div class="control-group"><label class="control-label" for="name">Display name: <span></span></label><div class="controls"><input type="text" class="input-large" id="name" autocomplete="off" placeholder="Your recognizable name" /></div></div><div class="control-group"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Set EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div></fieldset></form>',footer:'<button class="pull-right xbtn-blue xbtn-success">Done</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source");if(!t)return;var r=t.identity;this._browsing_user=t.browsing_user,this._tokenType=t.tokenType,this._originToken=t.originToken,this._forward=t.forward||"/",this._page=t.page,this.$("#name").val(t.user_name||""),this.$(".identity").text(o.printExtUserName(r)),this.$(".avatar").attr("src",r.avatar_filename).next().addClass("icon16-identity-"+r.provider),this.$(".xbtn-siea").data("source",o.printExtUserName(r))}}},l.setup_twitter={options:{onHideAfter:function(){this._oauth_&&(this._oauth_.abort(),this._oauth_=null),this.destory()},events:{"click .authorize":function(){this._oauth_=n.ajax({url:"/OAuth/Authenticate?provider=twitter",type:"POST",dataType:"JSON",success:function(e){var t=e.meta.code;t===200&&(window.location.href=e.response.redirect)}})}},backdrop:!1,viewData:{cls:"mblack modal-su",title:"Set Up Account",body:'<div class="shadow title">Welcome to <span class="x-sign">EXFE</span></div><form class="modal-form"><fieldset><legend>You’re browsing as identity underneath, please authorize through Twitter to set up your <span class="x-sign">EXFE</span> account.</legend><div class="clearfix control-group"><div class="pull-right user-identity"><img class="avatar" src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="box identity"></div></div><div class="clearfix"><button class="pull-right xbtn-blue authorize">Authorize</button><a class="pull-right underline pointer cancel" data-dismiss="dialog">Cancel</a></div></fieldset></form>',footer:""},onShowBefore:function(e){var t=n(e.currentTarget).data("source");if(!t)return;var r=t.identity;this._tokenType=t.tokenType,this._originToken=t.originToken,this.$(".identity").text(o.printExtUserName(r)),this.$(".avatar").attr("src",r.avatar_filename).next().addClass("icon16-identity-"+r.provider),this.$(".xbtn-siea").data("source",o.printExtUserName(r))}}},l.browsing_identity={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-go":function(){window.location.href="/"},"click .xbtn-merge":function(){var e=this,t=u.get("authorization"),i=t.token,o=this._token,a=this._identity,f={browsing_identity_token:o,identity_ids:"["+a.id+"]"};s.request("mergeIdentities",{type:"POST",params:{token:i},data:f},function(t){e.hide(),t.mergeable_user=null;if(t.mergeable_user){var i=n('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">'),s=u.get("user");i.data("source",{merged_identity:r.find(s.identities,function(e){if(e.id===a.id)return!0}),browsing_token:o,mergeable_user:t.mergeable_user}),i.appendTo(n("#app-tmp")),i.trigger("click.dialog.data-api"),n(".modal-mi").css("top",230)}else window.location.href="/"})}},backdrop:!1,viewData:{cls:"mblack modal-bi",title:"Browsing Identity",body:'<div class="shadow title">Browsing Identity</div><div class="user hide"><div>You’re currently signed in account underneath, you can continue with this account.</div><div class="clearfix context-user"><div class="pull-left avatar"><img width="40" height="40" alt="" src="" /></div><div class="pull-left username"></div></div><div class="clearfix"><button class="pull-right xbtn-white xbtn-go">Go</button><a class="pull-right xbtn-cancel" data-dismiss="dialog">Cancel</a></div><div class="spliterline"></div></div><div class="browsing-tips"><span class="tip-0 hide">Otherwise, you’re</span><span class="tip-1 hide">You’re</span> currently browsing this page as identity underneath, please choose an option to continue.</div><div class="context-identity"><div class="pull-right avatar"><img width="40" height="40" alt="" src="" /><i class="provider"></i></div><div class="clearfix"><div class="pull-left box identity"></div></div></div>',footer:'<button class="xbtn-white xbtn-sias hide" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00">Sign In and Switch</button><button class="xbtn-white xbtn-sui hide" data-widget="dialog" data-dialog-type="setup_email">Set Up Identity</button>'},onShowBefore:function(e){var t=n(e.currentTarget).data("settings");if(!t)return;var r=t.normal,i=t.browsing,s=t.setup,u=t.action;this._token=t.originToken,this._user=r,this._browsing_user=i,this._setup=s,this._action=u,this._tokenType=t.tokenType,this._user?(this.$(".user").removeClass("hide").find("img").attr("src",r.avatar_filename).parent().next().text(r.name||r.nickname),this.$(".xbtn-merge").removeClass("hide"),this.$(".browsing-tips").find(".tip-0").removeClass("hide")):(this.$(".xbtn-sias, .xbtn-sui").addClass("pull-right"),this.$(".browsing-tips").find(".tip-1").removeClass("hide")),this.$("browsing-tips").find("span").eq(this._user?0:1).removeClass("hide");var a=i.identities[0];this._identity=a;var f=o.printExtUserName(a);this.$(".context-identity").find("img").attr("src",a.avatar_filename).next().addClass("icon16-identity-"+a.provider),this.$(".context-identity").find(".identity").text(f),this._setup?this.$(".xbtn-sui").removeClass("hide").attr("data-dialog-type","setup_"+a.provider).data("source",{identity:a,originToken:t.originToken,tokenType:t.tokenType}):this.$(".xbtn-sias").removeClass("hide").data("source",f)}}},l.read_only={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-ro",title:"Read-only Browsing",body:'<div class="shadow title">Read-only Browsing</div><div>You’re browsing this page in read-only mode as <span></span> underneath. To change anything on this page, please <span class="underline">sign in</span> first.</div><div class="clearfix context-user hide"><div class="pull-left avatar"><img src="" alt="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="context-identity hide"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="pull-left box identity"></div></div>',footer:'<button class="pull-right xbtn-blue" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00">Sign In...</button><a class="pull-right xbtn-discard" data-dismiss="dialog">Cancel</a>'},onShowBefore:function(e){var t=n(e.currentTarget).data("settings");if(!t)return;var r=t.isBrowsing,i=o.printExtUserName(t.identities[0]);this.$("legend span").eq(0).text(r?"identity":"user"),this.$(".xbtn-blue").data("source",i);if(r){var s=this.$(".context-identity").removeClass("hide");s.find(".identity").text(i),s.find(".avatar img").attr("src",t.identities[0].avatar_filename),s.find(".provider").addClass("icon16-identity-"+t.identities[0].provider)}else{var u=this.$(".context-user").removeClass("hide");u.find(".username").text(t.name),u.find(".avatar img").attr("src",t.avatar_filename)}}}},l.revoked={options:{onHideAfter:function(){this.destory()},backdrop:!1,viewData:{cls:"mblack modal-re",title:"Revoked Identity",body:'<div class="shadow title">Revoked Identity</div>'}}},l.authentication={updateIdentity:function(e){var t=this.$(".context-identity");t.find(".avatar img").attr("src",e.avatar_filename),t.find(".provider").attr("class","provider icon16-identity-"+e.provider),t.find(".identity").text(e.eun),this._identity=e},options:{viewData:{cls:"mblack modal-au",title:"Authentication",body:'<div class="shadow title">Authorization</div><div class="d0 hide"><div class="detials">You’re about to change your account details, for security concerns, please authenticate your account.</div><div class="clearfix context-user"><div class="pull-left avatar"><img src="" alt="" width="40" height="40" /></div><div class="pull-left username"></div></div><div class="modal-form"><div class="control-group"><label class="control-label" for="password">Password: <span></span></label><div class="controls"><input type="password" class="input-large" id="password" autocomplete="off" placeholder="Your EXFE password" /><i class="help-inline icon16-pass-hide pointer" id="password-eye"></i></div></div></div></div><div class="d1 hide"><div class="detials">You’re about to change your account details. For security concern, please re-authenticate your identity and set your <span class="x-sign">EXFE</span> password first.</div><div class="context-identity"><div class="pull-right avatar"><img src="" alt="" width="40" height="40" /><i class="provider"></i></div><div class="clearfix dropdown-toggle" data-toggle="dropdown"><div class="pull-left box identity"></div><ul class="dropdown-menu"></ul><div class="pull-left caret-outer hide"><b class="caret"></b></div></div></div><div class="why">Why I have to do this?</div><div class="answer">Sorry for the inconvenience. Sometimes, we have to compromise on experience for your account security. Re-authentication is to avoid modification by others who can possibly access your computer.</div></div>',footer:'<button class="pull-left xbtn xbtn-white xbtn-forgotpwd d0 hide" data-dialog-from="authentication" data-widget="dialog" data-dialog-type="forgotpassword">Forgot Password...</button><button class="pull-right xbtn xbtn-blue xbtn-auth d1 hide">Authenticate</button><button class="pull-right xbtn xbtn-blue xbtn-done d0 hide">Done</button><a class="pull-right xbtn-discard d0 hide" data-dismiss="dialog">Cancel</a>'},events:{"click .xbtn-done":function(){var e=this,t=u.get("user"),n=t.identities[0],r=n.external_username,i=n.provider,a=o.trim(e.$("#password").val());s.request("signin",{type:"POST",data:{external_username:r,provider:i,password:a,name:"",auto_signin:!0}},function(t){u.set("authorization",t);var n=e.callback;e.destory(),n()})},"click .xbtn-auth":function(e){var t=this,r=n(e.currentTarget);if(r.hasClass("xbtn-success"))return t.$(".verify-after").addClass("hide"),r.removeClass("xbtn-success").text("Verify"),t.hide(),!1;var i=t._identity.provider,o=t._identity.external_username;t.befer=s.request("verifyIdentity",{type:"POST",data:{provider:i,external_username:o}},function(e){e.action==="REDIRECT"&&(window.location.href=e.url)})},"click .caret-outer":function(e){this.$(".dropdown-toggle").addClass("open"),e.stopPropagation()},"hover .dropdown-menu > li":function(e){var t=e.type,r=n(e.currentTarget);r[(t==="mouseenter"?"add":"remove")+"Class"]("active")},"click .dropdown-menu > li":function(e){var t=this.$(".dropdown-menu").data("identities"),r=n(e.currentTarget).data("index");this.updateIdentity(t[r])}},onHideAfter:function(){this.befer&&(this.befer.abort(),this.befer=null),this.destory()},onShowBefore:function(e){var t=this,n=u.get("user"),r=n.password;t.$(".d"+(r?0:1)).removeClass("hide"),e&&e._data&&(t.callback=e._data.callback),t.callback&&(t.callback=function(){});if(r)t.$(".modal-body .d0").find(".avatar img").attr("src",n.avatar_filename).parent().next().text(n.name),t.$(".xbtn-forgotpwd").data("source",n.identities);else{var i=n.identities,s,a;if(i&&(s=i.length)){a=i[0],a.eun=o.printExtUserName(a);if(1<s){t.$(".context-identity").addClass("switcher");var f="";for(var l=0;l<s;l++)f+='<li data-index="'+l+'"><i class="pull-right icon16-identity-'+i[l].provider+'"></i>',i[l].eun=o.printExtUserName(i[l]),f+="<span>"+i[l].eun+"</span>",f+="</li>";t.$(".dropdown-menu").html(f).data("identities",i)}t.updateIdentity(a)}}}}},l.unsubscribe={options:{onHideAfter:function(){this.destory()},events:{"click .xbtn-done":function(e){e.preventDefault(),this.hide()}},backdrop:!1,viewData:{cls:"mblack modal-unsubscribe",title:"Unsubscribe Email",body:'<div class="shadow title">Unsubscribe update email</div><p>You just unsubscribe update email of <span class="x">·X·</span> “<span class="x-title"></span>”.</p>',footer:'<button class="pull-right xbtn-white xbtn-done">Done</button>'},onShowBefore:function(e){var t=n(e.currentTarget).data("source");this.$(".x-title").text(t.title)}}};var c=f.extend({availability:!1,init:function(){var e=this;i.off("widget-dialog-identification-auto"),i.on("widget-dialog-identification-auto",function(t){var n=e.$('[for="identity"]'),r=n.find("span"),i=e.$('[for="password"]'),s=i.find("span");e.availability=!1,e.identityFlag=null;var o;e.switchTabType==="d24"&&(o="d01"),e.$(".xalert-error").addClass("hide"),e.$(".help-subject").removeClass("icon14-question").addClass("icon14-clear"),t?(n.removeClass("label-error"),r.text(""),t.identity&&t.identity.avatar_filename?(e._identity=t.identity,e.$(".user-identity").removeClass("hide").find("img").attr("src",t.identity.avatar_filename).next().attr("class","provider icon16-identity-"+t.identity.provider)):(e._identity=null,e.$(".user-identity").addClass("hide")),e.identityFlag=t.registration_flag,t.registration_flag==="SIGN_IN"?(o="d01",e.$(".xbtn-forgotpwd").removeClass("hide"),i.removeClass("label-error"),s.text("")):t.registration_flag==="SIGN_UP"?(o="d02",i.removeClass("label-error"),s.text("")):t.registration_flag==="AUTHENTICATE"?(o="d00",e.$(".help-subject").removeClass("icon14-question").addClass("icon14-clear"),e.$(".authenticate").removeClass("hide")):t.registration_flag==="VERIFY"&&(o="d04"),e.availability=!0):e.$(".help-subject").removeClass("icon14-clear").addClass("icon14-question"),o&&e.switchTabType!==o&&e.switchTab(o),e.$(".x-signin")[(e.availability?"remove":"add")+"Class"]("disabled"),e.$(".xbtn-forgotpwd").data("source",t?[t.identity]:t)}),i.off("widget-dialog-identification-nothing"),i.on("widget-dialog-identification-nothing",function(){e.$(".authenticate").addClass("hide"),e.$(".user-identity").addClass("hide"),e.$('[for="identity"]').removeClass("label-error").find("span").text(""),e.$(".xbtn-forgotpwd").addClass("hide").data("source",null),e.availability=!1,e.$(".x-signin")[(e.availability?"remove":"add")+"Class"]("disabled")})},resetInputs:function(){this.$("input").val(""),this.$(".label-error").removeClass("label-error").find("span").text(""),this.$(".icon16-pass-show").toggleClass("icon16-pass-show icon16-pass-hide").prev().prop("type","password"),this.$("#identity").focusend()},setPasswordPlaceHolder:function(e){e==="d02"?this.$("#password").attr("placeholder","Set your EXFE Password"):e==="d01"&&this.$("#password").attr("placeholder","Your EXFE Password")},getFormData:function(e){var t=o.trim(this.$("#identity").val()),n=o.parseId(t);if(e==="d01"||e==="d02")n.password=this.$("#password").val();return e==="d01"&&(n.auto_signin=this.$("#auto-signin").prop("checked")),e==="d02"&&(n.name=o.trim(this.$("#name").val())),n},switchTab:function(e){this.$(".d").not(".hide").addClass("hide").end().filter("."+e).removeClass("hide"),this.$(".x-signin")[(this.availability?"remove":"add")+"Class"]("disabled"),this.switchTabType=e;if(this.isShown&&(this.switchTabType==="d00"||this.switchTabType==="d01"||this.switchTabType==="d02")){var t=this.$("#identity");t.focusend()}this.setPasswordPlaceHolder(e)}});t.Identification=c});