define("photoxwidget",function(e){"use strict";var t=e("api").request,n=e("rex"),r=e("bus"),i=e("store"),s=e("photox"),o=e("mnemosyne"),u=e("widget"),a=function(e,n){return t("photox_getPhotoX",{resources:{photox_id:e}},n)},f=u.extend({options:{template:'<div class="widget photox-widget"><div class="tab tab-0 hide"><div class="table-wrapper"><table cellspacing="0" cellpadding="0" border-spacing="0" border="0"><tbody><tr></tr></tbody></table></div><div class="btn-open"><i class="ix-wall ix-wall-blue"></i></div></div><div class="tab tab-1 hide"><i class="ix-wall ix-wall-gay"></i>Share photos, save memory.</div></div>',tdTmp:'<td><figure><img class="pic" src="{{url}}" width="{{width}}" height="{{height}}" /></figure></td>',tdTmpMore:'<td class="more"><figure>...</figure></td>',parentNode:null,onShowBefore:function(){this.emit("load")},onLoad:function(){this.load()}},init:function(){this.render()},render:function(){var e=this.options;this.parentNode=e.parentNode,this.srcNode=e.srcNode,this.crossId=e.crossId,delete e.parentNode,delete e.srcNode,delete e.crossId,this.limited=10,this.$tr=this.element.find("tr"),this.listen()},listen:function(){var e=this;r.on("update-photoxwidget",function(){e.load()}),this.element.on("click.photoxwidget",".btn-open, .tab-1",function(t){t.preventDefault(),t.stopPropagation();if($("#photox-panel").size())return;var r=i.get("user"),o=r.identities,u=["facebook","instagram","flickr","dropbox"],a=u.slice(0),f=[],l;n.each(o,function(e){l=n.indexOf(a,e.provider),-1!==l&&(a.splice(l,1),f.push(e.provider+":"+e.id))}),f.push(""),a.push(""),a=f.join(" ")+a.join(":0 ");var c=new s({options:{parentNode:$("#app-tmp"),srcNode:$(".cross-photox"),crossId:Cross.id,providers:a}});c.show(),e.photoxPanel=c}),this.element.on("click.photoxwidget",".table-wrapper",function(e){e.preventDefault();if($(".mnemosyne-panel").size())return;var t=i.get("user"),n=new o({options:{parentNode:$("#app-tmp"),srcNode:$(".table-wrapper"),crossId:Cross.id,userId:t.id}});n.show()}),$(document.body).on("click.photoxwidget",function(t){var n=$("#photox-panel");if(n.length&&n[0]!==t.target&&!$.contains(n[0],t.target)){t.preventDefault(),t.stopPropagation(),e.photoxPanel.hide(),e.photoxPanel=null;return}})},generate:function(e,t){var n=this.options.tdTmp,r=0,i=e.length,s="",o;for(;r<i;++r)o=e[r].images.preview,s+=n.replace("{{url}}",o.url).replace("{{height}}",64).replace("{{width}}",64*o.width/o.height);return t&&(s+=this.options.tdTmpMore),s},load:function(){var e=this,t=e.$tr,n=e.element.find(".tab"),r=n.eq(0),i=n.eq(1),s=e.limited;this.defer&&this.defer.abort(),this.defer=a(this.crossId,function(n){var o=n.photox.photos,u=o.length,a=u>s;u?(r.removeClass("hide"),i.addClass("hide"),a&&(o=o.slice(0,s)),t.html(e.generate(o,a))):(r.addClass("hide"),i.removeClass("hide"))})},show:function(){return this.emit("showBefore"),this.element.appendTo(this.parentNode),this.emit("showAfter"),this}});return f});