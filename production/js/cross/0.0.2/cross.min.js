define(function(e){ExfeUtilities={trim:function(e){return e?e.replace(/^\s+|\s+$/g,""):""},escape:function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},clone:function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var i in e)t[i]=this.clone(e[i]);break;case"[object Array]":t=[];for(i in e)t.push(this.clone(e[i]));break;default:t=e}return t},getTimezone:function(){var e=""+Date(),t=e.replace(/^.+([+-]\d{2})(\d{2}).+$/i,"$1:$2"),i=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return i="UTC"===i||"GMT"===i?"":i,t+(i===e?"":" "+i)},parsePlacestring:function(e){for(var t=e?e.split(/\r\n|\r|\n/g):[],i=[],s=0;t.length>s;s++)t[s]&&i.push(t[s]);var n=i.shift();return n=n?n:"",{title:n,description:i.join("\r"),lng:"",lat:"",provider:"",external_id:"",id:Cross.place.id,type:"Place"}}},ExfeeCache={identities:[],tried_key:{},updated_identity:[],init:function(){var e=Store.get("exfee_cache_user_id"),t=Store.get("exfee_cache_identities");User&&User.id&&e&&User.id===e&&t||(t=[]),this.identities=[];for(var i=0;t.length>i;i++)t[i].external_username&&this.identities.push(t[i])},saveCache:function(){User&&User.id&&(Store.set("exfee_cache_user_id",User.id),Store.set("exfee_cache_identities",this.identities))},search:function(e){var t=function(e,t){return t?-1!==t.toLowerCase().indexOf(e):!1},i=function(e,i){return t(e,i.external_id)||t(e,i.external_username)||t(e,i.name)},s=[];e=e.toLowerCase();for(var n=0;this.identities.length>n;n++)i(e,this.identities[n])&&!ExfeeWidget.isMyIdentity(this.identities[n])&&ExfeeWidget.checkExistence(this.identities[n])===!1&&s.push(ExfeUtilities.clone(this.identities[n]));return s},cacheIdentities:function(e,t){e=ExfeUtilities.clone(e);for(var i=0;e.length>i;i++){for(var s=0;this.identities.length>s;s++)ExfeeWidget.compareIdentity(e[i],this.identities[s])&&this.identities.splice(s,1);t?this.identities.unshift(e[i]):this.identities.push(e[i]),this.identities.length>233&&this.identities.splice(233),this.updated_identity.push(e[i])}this.saveCache()},fetchIdentity:function(e){for(var t=0;this.identities.length>t;t++)if(ExfeeWidget.compareIdentity(e,this.identities[t]))return ExfeUtilities.clone(this.identities[t]);return null}},ExfeeWidget={dom_id:"",rsvp_status:["Pending","Accepted","Unavailable","Interested"],editable:!1,complete_timer:0,complete_key:"",complete_exfee:[],complete_request:0,selected:"",completing:!1,callback:function(){},last_inputed:{},base_info_timer:0,api_url:"",focus:{},soft_limit:12,hard_limit:50,blur:!0,make:function(e,t,i){return this.dom_id=e,this.editable=t,this.callback=i,$("#"+this.dom_id+" .total").css("visibility","hidden"),$("#"+this.dom_id+" .avatar .rb").hide(),$("#"+this.dom_id).bind("mouseenter mouseleave",function(t){switch(t.type){case"mouseenter":$("#"+e+" .total").css("visibility","visible"),$("#"+e+" .avatar .rb").show();break;case"mouseleave":ExfeeWidget.focus[e+"-input"]||""!==$("#"+e+" .exfee-input").val()||($("#"+e+" .total").css("visibility","hidden"),$("#"+e+" .avatar .rb").hide(),ExfeeWidget.showLimitWarning(!1))}}),$("#"+this.dom_id+" .input-xlarge").bind("focus keydown blur",this.inputEvent),$("#"+this.dom_id+" .pointer").bind("mousedown",function(t){return t.preventDefault(),t.stopPropagation(),ExfeeWidget.checkInput($("#"+e+" .input-xlarge"),!0),ExfeeWidget.blur=!1,!1}).bind("click",function(e){return e.preventDefault(),e.stopPropagation(),!1}),$(document).on("mousedown","#"+this.dom_id+" .thumbnails > li.identity > .avatar",function(){ExfeeWidget.showPanel(this.parentNode)}),this.complete_timer=setInterval("ExfeeWidget.checkInput($('#"+this.dom_id+" .input-xlarge'))",50),ExfeUtilities.clone(this)},showAll:function(e,t){var i=0,s=0,n=["ACCEPTED","INTERESTED","NORESPONSE","DECLINED","IGNORED"];$("#"+this.dom_id+" .thumbnails").html("");for(var o=0;n.length>o;o++)for(var a=0;Exfee.invitations.length>a;a++)if(Exfee.invitations[a].rsvp_status===n[o]){var r=Exfee.invitations[a].mates+1;e&&ExfeeWidget.isMyIdentity(Exfee.invitations[a].identity)||this.showOne(Exfee.invitations[a],t),"ACCEPTED"===Exfee.invitations[a].rsvp_status&&(i+=r),s+=r}$("#"+this.dom_id+" .attended").html(i),$("#"+this.dom_id+" .total").html("of "+s)},showOne:function(e,t){var i={ACCEPTED:"icon14-rsvp-accepted-blue",DECLINED:"icon14-rsvp-declined",INTERESTED:"icon14-rsvp-interested",NORESPONSE:"icon14-rsvp-noresponse"};$("#"+this.dom_id+" .thumbnails").append('<li class="identity" id="'+e.identity.id+'" provider="'+e.identity.provider.toLowerCase()+'" external_id="'+e.identity.external_id.toLowerCase()+'" external_username="'+e.identity.external_username.toLowerCase()+'">'+'<span class="pointer avatar'+(t&&"ACCEPTED"!==e.rsvp_status?" unconfirmed":"")+'">'+'<img src="'+e.identity.avatar_filename+'" alt="'+e.identity.external_id+'" width="50" height="50" />'+'<i class="rt'+(e.host?" icon10-host-h":"")+'"></i>'+'<i class="icon10-plus-'+e.mates+' lt"></i>'+("cross-exfee"===this.dom_id?'<span class="rb rb-bg'+(ExfeeWidget.focus[this.dom_id+"-input"]?"":" hide")+'">'+'<i class="'+i[e.rsvp_status]+'"></i>'+"</span>":"")+"</span>"+'<div class="identity-name">'+e.identity.name+"</div>"+"</li>")},showLimitWarning:function(e){$(".exfee-warning").toggleClass("hide",e===!1)},showTip:function(e){var t=$(e),i=t.offset(),s={},n=t.attr("id"),o=t.attr("provider"),a=t.attr("external_id"),r=t.attr("external_username");(n=~~n)&&(s.id=n),o&&(s.provider=o),a&&(s.external_id=a),r&&(s.external_username=r);var d=this.getInvitationByIdentity(s);ExfeePanel.showTip(d,i.left,i.top+50)},showPanel:function(e){var t=$(e),i=t.offset(),s={},n=t.attr("id"),o=t.attr("provider"),a=t.attr("external_id"),r=t.attr("external_username");(n=~~n)&&(s.id=n),o&&(s.provider=o),a&&(s.external_id=a),r&&(s.external_username=r);var d=this.getInvitationByIdentity(s);ExfeePanel.showPanel(d,i.left+5,i.top+5)},compareIdentity:function(e,t){if(e.id&&t.id&&e.id===t.id)return!0;if(ExfeUtilities.trim(e.provider).toLowerCase()===ExfeUtilities.trim(t.provider).toLowerCase()){if(e.external_id&&t.external_id&&ExfeUtilities.trim(e.external_id).toLowerCase()===ExfeUtilities.trim(t.external_id).toLowerCase())return!0;if(e.external_username&&t.external_username&&ExfeUtilities.trim(e.external_username).toLowerCase()===ExfeUtilities.trim(t.external_username).toLowerCase())return!0}return!1},checkExistence:function(e){for(var t=0;Exfee.invitations.length>t;t++)if(this.compareIdentity(Exfee.invitations[t].identity,e))return t;return!1},addExfee:function(e,t,i){var s=ExfeeWidget.summary().items;if(ExfeeWidget.hard_limit>s&&e){var n=this.checkExistence(e);return n===!1?(Exfee.invitations.push({identity:ExfeUtilities.clone(e),rsvp_status:i?i:"NORESPONSE",host:!!t,mates:0}),this.callback()):"REMOVED"===Exfee.invitations[n].rsvp_status&&(Exfee.invitations[n].rsvp_status="NORESPONSE",this.callback()),!0}return!1},delExfee:function(e){this.rsvpExfee(e,"REMOVED")},rsvpExfee:function(e,t){var i=this.checkExistence(e);if(i!==!1){Exfee.invitations[i].rsvp_status=t,Exfee.invitations[i].by_identity=ExfeUtilities.clone(curIdentity);var s=!1;"REMOVED"===t&&curIdentity&&ExfeeWidget.compareIdentity(Exfee.invitations[i].identity,curIdentity)&&(s=!0),this.callback(s)}},changeMates:function(e,t){var i=this.checkExistence(e);i!==!1&&(t>9&&(t=9),0>t&&(t=0),Exfee.invitations[i].mates=t,this.callback())},rsvpMe:function(e){this.rsvpExfee(curIdentity,e)},summary:function(){for(var e={items:0,accepted:0,total:0,accepted_invitations:[]},t=0;Exfee.invitations.length>t;t++)if("REMOVED"!==Exfee.invitations[t].rsvp_status&&"NOTIFICATION"!==Exfee.invitations[t].rsvp_status){e.items++;var i=1+Exfee.invitations[t].mates;e.total+=i,"ACCEPTED"===Exfee.invitations[t].rsvp_status&&(e.accepted+=i,e.accepted_invitations.push(Exfee.invitations[t]))}return e},getUTF8Length:function(e){var t=0;if(e)for(var i=0;e.length>i;i++)charCode=e.charCodeAt(i),127>charCode?t+=1:charCode>=128&&2047>=charCode?t+=2:charCode>=2048&&65535>=charCode&&(t+=3);return t},cutLongName:function(e){for(e=e?e.replace(/[^0-9a-zA-Z_\u4e00-\u9fa5\ \'\.]+/g," "):"";this.getUTF8Length(e)>30;)e=e.substring(0,e.length-1);return e},parseAttendeeInfo:function(e){e=ExfeUtilities.trim(e);var t={id:0,name:"",external_id:"",external_username:"",provider:"",type:"identity"};if(/^[^@]*<[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?>$/.test(e)){var i=e.indexOf("<"),s=e.indexOf(">");t.external_id=ExfeUtilities.trim(e.substring(++i,s)),t.external_username=t.external_id,t.name=ExfeUtilities.trim(this.cutLongName(ExfeUtilities.trim(e.substring(0,i)).replace(/^"|^'|"$|'$/g,""))),t.provider="email"}else if(/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e))t.external_id=e,t.external_username=e,t.name=ExfeUtilities.trim(this.cutLongName(e.split("@")[0])),t.provider="email";else if(/^@[a-z0-9_]{1,15}$|^@[a-z0-9_]{1,15}@twitter$|^[a-z0-9_]{1,15}@twitter$/i.test(e))t.external_id="",t.external_username=e.replace(/^@|@twitter$/gi,""),t.name=t.external_username,t.provider="twitter";else{if(!/^[a-z0-9\.]{5,}@facebook$/i.test(e))return null;t.external_id="",t.external_username=e.replace(/@facebook$/gi,""),t.name=t.external_username,t.provider="facebook"}return t.avatar_filename=encodeURI(ExfeeWidget.api_url+"/avatar/default?name="+t.name),t},checkComplete:function(e,t,i){this.showCompleteItems(e,t,t?ExfeeCache.search(t):[],i),this.ajaxComplete(e,t)},displayIdentity:function(e,t){switch(e?e.provider:""){case"email":case"phone":return/^\+1.{10}$/.test(e.external_id)?e.external_id.replace(/^(\+1)(.{3})(.{3})(.{4})$/,"$1 ($2) $3-$4"):/^\+86.{11}$/.test(e.external_id)?e.external_id.replace(/^(\+86)(.{3})(.{4})(.{4})$/,"$1 $2 $3 $4"):e.external_id;case"twitter":return"@"+e.external_username+(t?"":"@twitter");case"facebook":return e.external_username+(t?"":"@facebook");default:return""}},displayCompletePanel:function(e,t){if(this.completing=t){var i=e.offset();$(".ids-popmenu").css({left:i.left+"px",top:i.top+e.height()+10+"px","max-height":"352px","overflow-y":"scroll"}).slideDown(50)}else $(".ids-popmenu").slideUp(50)},showCompleteItems:function(t,i,s,n){var o=function(e){var t=RegExp("("+i.replace(/^\+/,"")+")");return e?e.replace(t,'<span class="highlight">$1</span>'):""},a=$(".ids-popmenu > ol"),r="";i=i?i.toLowerCase():"",ExfeeWidget.complete_key!==i&&(ExfeeWidget.complete_exfee=[],a.html("")),ExfeeWidget.complete_key=i;for(var d=0;s.length>d;d++){for(var c=!1,l=0;ExfeeWidget.complete_exfee.length>l;l++)if(this.compareIdentity(ExfeeWidget.complete_exfee[l],s[d])){c=!0;break}if(!c){var p=ExfeeWidget.complete_exfee.push(ExfeUtilities.clone(s[d]))-1,f=s[d].provider;r+="<li"+(p?"":' class="active"')+">"+'<span class="pull-left avatar">'+'<img src="'+s[d].avatar_filename+'" alt="" width="40" height="40">'+'<span class="rb"><i class="icon16-identity-'+s[d].provider+'"></i></span>'+"</span>"+'<div class="identity">'+'<div class="name">'+o(s[d].name)+"</div>"+"<div>"+'<span class="oblique external">'+o(this.displayIdentity(s[d],!0))+"</span>"+("email"===f||"phone"===f?"":' <span class="provider">@'+f.charAt(0).toUpperCase()+f.substr(1)+"</span>")+"</div>"+"</div>"+"</li>"}}a.append(r),this.displayCompletePanel(t,i&&ExfeeWidget.complete_exfee.length);var u=i.replace(/\-|\(|\)|\ /g,"");if(u&&n&&!ExfeeWidget.complete_exfee.length&&!$("#phone-panel").length&&/^[\+＋]?[0-9\uFF10-\uFF19]{5,15}$/.test(u)){var h={"＋":"+","０":"0","１":"1","２":"2","３":"3","４":"4","５":"5","６":"6","７":"7","８":"8","９":"9"},v=u.split("");for(u="",d=0;v.length>d;d++)u+=h[v[d]]===void 0?v[d]:h[v[d]];t.val(u);var m=e("phonepanel"),g=new m({options:{parentNode:$("#app-tmp"),srcNode:t},add:function(e){ExfeeWidget.addExfee(e),t.val("")}});g.show()}},isMyIdentity:function(e){return curIdentity&&(this.compareIdentity(e,curIdentity)||e.connected_user_id===curIdentity.connected_user_id)},getInvitationByIdentity:function(e){for(var t=0;Exfee.invitations.length>t;t++)if(this.compareIdentity(Exfee.invitations[t].identity,e))return Exfee.invitations[t];return null},getMyInvitation:function(){return curIdentity?this.getInvitationByIdentity(curIdentity):null},ajaxComplete:function(e,t){User&&t&&void 0===ExfeeCache.tried_key[t]&&(this.complete_request&&this.complete_request.abort(),this.complete_request=Api.request("complete",{type:"get",data:{key:t}},function(i){for(var s=[],n=0;i.identities.length>n;n++)ExfeeWidget.isMyIdentity(i.identities[n])||ExfeeWidget.checkExistence(i.identities[n])!==!1||s.push(i.identities[n]),ExfeeCache.cacheIdentities(s),ExfeeCache.tried_key[t]=!0,ExfeeWidget.complete_key===t&&ExfeeWidget.showCompleteItems(e,t,s)}))},ajaxIdentity:function(e){e&&e.length&&Api.request("getIdentity",{type:"POST",data:{identities:JSON.stringify(e)}},function(e){for(var t=[],i=0;e.identities.length>i;i++){var s=ExfeeWidget.checkExistence(e.identities[i]);s!==!1&&(Exfee.invitations[s].identity=e.identities[i]),t.push(e.identities[i])}t.length&&(ExfeeCache.cacheIdentities(t),window.GatherExfeeWidget.showAll(!0),window.CrossExfeeWidget.showAll(!1,!0))})},checkInput:function(e,t){if(e&&e.length){var i=e.val(),s=i.split(/,|;|\r|\n|\t/),n=[],o=[],a="",r="";if(ExfeeWidget.last_inputed[e[0].id]!==i||t){ExfeeWidget.last_inputed[e[0].id]=i;for(var d=0;s.length>d;d++)if(a=ExfeUtilities.trim(s[d])){var c=ExfeeWidget.parseAttendeeInfo(a);c&&(s.length-1>~~d||t)&&this.addExfee(c)?n.push(c):(o.push(s[d]),r=s[d])}var l=o.join("; ");l!==i&&e.val(l),this.ajaxIdentity(n),ExfeeWidget.summary().items>=ExfeeWidget.hard_limit&&i?(r="",this.showLimitWarning()):this.showLimitWarning(!1);var p=!!ExfeeWidget.parseAttendeeInfo(r)||/^\+?[0-9]{5,15}$/.test(r);e.parent().find(".pointer").toggleClass("icon16-exfee-plus-blue",p).toggleClass("icon16-exfee-plus",!p),this.checkComplete(e,r.replace(/^@/,""),t)}}},selectCompleteItem:function(e){var t="active";$(".ids-popmenu > ol > li").removeClass(t).eq(e).addClass(t)},useCompleteItem:function(e){var t=ExfeeCache.fetchIdentity(this.complete_exfee[e]);t?(this.complete_exfee.splice(e,1),ExfeeCache.cacheIdentities(t)):t=ExfeUtilities.clone(this.complete_exfee[e]),this.addExfee(t)},inputEvent:function(e){var t=$(e.target);switch(ExfeeWidget.blur=!0,e.type){case"focus":ExfeeWidget.focus[e.target.id]=!0;break;case"keydown":switch(e.which){case 9:ExfeeWidget.checkInput(t,!0);break;case 13:var i=$(".ids-popmenu > ol > .active"),s=i.length?~~i.index():null;ExfeeWidget.completing&&null!==s?(ExfeeWidget.useCompleteItem(s),ExfeeWidget.displayCompletePanel(t,!1),t.val("")):ExfeeWidget.checkInput(t,!0),ExfeeWidget.blur=!1;break;case 27:ExfeeWidget.completing&&ExfeeWidget.displayCompletePanel(t,!1);break;case 38:case 40:e.preventDefault();var n=$(".ids-popmenu"),o=352,a=50,r=n.scrollTop();if(!ExfeeWidget.completing)return;var i=n.find("ol .active"),s=~~i.index(),d=ExfeeWidget.complete_exfee.length-1;switch(e.which){case 38:0>--s&&(s=d);break;case 40:++s>d&&(s=0)}ExfeeWidget.selectCompleteItem(s);var c=s*a,l=c-r;0>l?n.scrollTop(c):l+a>o&&n.scrollTop(c+a-o+1)}break;case"blur":ExfeeWidget.focus[e.target.id]=!1,ExfeeWidget.displayCompletePanel(t,!1);var p=function(){t.parent().find(".pointer").hasClass("icon16-exfee-plus-blue")&&(t.parent().toggleClass("a-bounce"),setTimeout(function(){t.parent().toggleClass("a-bounce",!1)},1e3))};setTimeout(function(){ExfeeWidget.blur&&p(),ExfeeWidget.blur=!0},50)}}}}),define("exfeepanel",function(){var e=$("body");return e.bind("click",function(e){for(var t=e.target;t&&!$(t).hasClass("exfee_pop_up")&&!$(t).hasClass("exfee_pop_up_save")&&"BODY"!==t.tagName;)t=t.parentNode;$(t).hasClass("exfee_pop_up")||$(t).hasClass("exfee_pop_up_save")||$(".exfee_pop_up").hide().remove()}),{objBody:e,tipId:"",panelId:"",arrRsvp:{NORESPONSE:["Pending"],ACCEPTED:["Accepted"],INTERESTED:["Interested"],DECLINED:["Unavailable"],IGNORED:["Pending"]},invitation:{},editing:"",pre_delete:!1,newId:function(e){return"id_"+e.identity.id+"provider_"+e.identity.provider+"external_id_"+e.identity.external_id+"external_username_"+e.identity.external_username},showTip:function(e,t,i){var s=this.newId(e),n='<div class="tooltip tip-exfee  exfee_pop_up" style="left: '+t+"px; top: "+i+'px;">'+'<div class="tooltip-inner">'+"<h5>"+e.identity.name+"</h5>"+"<div>"+'<i class="icon16-identity-'+e.identity.provider+'"></i>'+'<span class="oblique">'+ExfeeWidget.displayIdentity(e.identity,!0)+"</span>"+"</div>"+"</div>"+"</div>";this.tipId===s&&$(".tip-exfee").length||(this.tipId=s,this.hideTip(),this.objBody.append(n),$(".exfeetip").show())},showPanel:function(e,t,i){var s=this.newId(e),n='<div class="exfeepanel exfee_pop_up" style="left: '+t+"px; top: "+i+'px; z-index: 10">'+'<div class="tooltip-inner">'+'<div class="avatar-name">'+'<span class="pull-left pointer avatar">'+'<img src="'+e.identity.avatar_filename+'" alt="" width="60" height="60" />'+'<i class="lt"></i>'+"</span>"+"<h4>"+e.identity.name+"</h4>"+"</div>"+'<div class="clearfix rsvp-actions">'+'<div class="pull-right invited">'+'<div class="mates-num hide"></div>'+'<div class="pull-left together-with hide">Mates&nbsp;</div>'+'<div class="pull-right mates-info">'+'<i class="mates-add icon-plus-blue"></i>'+"</div>"+'<div class="pull-left mates-edit hide">'+'<i class="pull-left mates-minus icon14-mates-minus"></i>'+'<span class="pull-left num"></span>'+'<i class="pull-left mates-add icon14-mates-add"></i>'+"</div>"+"</div>"+'<div class="rsvp-info">'+'<div class="rsvp-content">'+'<div class="attendance"></div>'+'<div class="by">by <span class="name"></span></div>'+"</div>"+'<div class="pull-right pointer underline setto">'+(readOnly?"":'<span>set to</span> <i class="icon-rsvp-declined-red"></i>')+"</div>"+"</div>"+"</div>"+'<div class="identities">'+'<ul class="identities-list">'+"<li>"+'<i class="pull-left icon16-identity-'+e.identity.provider+'"></i>'+'<span class="oblique identity">'+ExfeeWidget.displayIdentity(e.identity,!0)+"</span>"+(readOnly?"":'<div class="identity-btn delete"><i class="icon-minus-red"></i><button class="btn-leave">Leave</button></div>')+"</li>"+"</ul>"+'<div class="identity-actions">'+"<p>"+'<span class="xalert-fail">Remove yourself?</span>'+"<br />"+'<span class="xalter-info">You will <strong>NOT</strong> be able to access any information in this <span class="x">·X·</span>. Confirm leaving?</span>'+'<button class="pull-right btn-cancel">Cancel</button>'+"</p>"+"</div>"+"</div>"+'<!--i class="expand nomore"></i-->'+"</div>"+"</div>";this.invitation=ExfeUtilities.clone(e),this.panelId===s&&$(".exfeepanel").length||(this.panelId=s,this.editing="",this.pre_delete=!1,this.hideTip(),this.hidePanel(),this.objBody.append(n),this.bindEvents(),$(".exfeepanel").show()),this.showRsvp()},hideTip:function(){$(".tip-exfee").hide().remove()},hidePanel:function(){$(".exfeepanel").hide().remove()},showRsvp:function(){var e=this.invitation.by_identity?this.invitation.by_identity:curIdentity,t="",i=$(".exfee_pop_up .rsvp-info .setto i");switch(this.invitation.rsvp_status){case"ACCEPTED":t="DECLINED",i.toggleClass("icon-rsvp-accepted-blue",!1),i.toggleClass("icon-rsvp-declined-red",!0),i.toggleClass("icon-rsvp-noresponse",!1);break;case"DECLINED":t="NORESPONSE",i.toggleClass("icon-rsvp-accepted-blue",!1),i.toggleClass("icon-rsvp-declined-red",!1),i.toggleClass("icon-rsvp-noresponse",!0);break;case"NORESPONSE":case"IGNORED":default:t="ACCEPTED",i.toggleClass("icon-rsvp-accepted-blue",!0),i.toggleClass("icon-rsvp-declined-red",!1),i.toggleClass("icon-rsvp-noresponse",!1)}$(".exfee_pop_up .rsvp-info .setto").attr("rsvp",t),$(".exfee_pop_up .rsvp-info .attendance").html(this.arrRsvp[this.invitation.rsvp_status][0]);for(var s=1;10>s;s++)$(".exfee_pop_up .avatar-name .lt").toggleClass("icon10-plus-"+s,this.invitation.mates===s);switch($(".exfee_pop_up .rsvp-info .by .name").html(e?e.name:""),$(".exfee_pop_up .invited .mates-num").html("+"+this.invitation.mates),$(".exfee_pop_up .mates-edit .num").html(this.invitation.mates),e&&this.invitation.identity.id!==e.id&&"rsvp"===this.editing?$(".exfee_pop_up .rsvp-info .by").show():$(".exfee_pop_up .rsvp-info .by").hide(),this.editing){case"rsvp":$(".exfee_pop_up .rsvp-info").show(),$(".exfee_pop_up .rsvp-info .setto").show(),$(".exfee_pop_up .invited").hide();break;case"mates":$(".exfee_pop_up .rsvp-info").hide(),$(".exfee_pop_up .invited").show(),$(".exfee_pop_up .invited .together-with").show(),this.invitation.mates?($(".exfee_pop_up .mates-edit").show(),$(".exfee_pop_up .invited .mates-info").hide()):($(".exfee_pop_up .mates-edit").hide(),$(".exfee_pop_up .invited .mates-info").show()),$(".exfee_pop_up .invited .mates-num").hide();break;default:$(".exfee_pop_up .rsvp-info").show(),$(".exfee_pop_up .rsvp-info .setto").hide(),$(".exfee_pop_up .invited").show(),$(".exfee_pop_up .mates-edit").hide(),$(".exfee_pop_up .invited .together-with").hide(),this.invitation.mates?($(".exfee_pop_up .invited .mates-num").show(),$(".exfee_pop_up .invited .mates-info").hide()):($(".exfee_pop_up .invited .mates-num").hide(),readOnly?$(".exfee_pop_up .invited .mates-info").hide():$(".exfee_pop_up .invited .mates-info").show())}this.invitation.host?($(".exfee_pop_up .identities-list .delete i").hide(),$(".exfee_pop_up .identities-list .delete button").hide(),$(".exfee_pop_up .identity-actions").hide()):this.pre_delete?($(".exfee_pop_up .identities-list .delete i").hide(),$(".exfee_pop_up .identities-list .delete button").show(),curIdentity&&this.invitation.identity.id===curIdentity.id?($(".exfee_pop_up .identity-actions").show(),$(".exfee_pop_up .identities-list .btn-leave").html("Leave")):($(".exfee_pop_up .identity-actions").hide(),$(".exfee_pop_up .identities-list .btn-leave").html("Remove"))):($(".exfee_pop_up .identities-list .delete i").show(),$(".exfee_pop_up .identities-list .delete button").hide(),$(".exfee_pop_up .identity-actions").hide())},bindEvents:function(){$(".exfee_pop_up .mates-add").bind("click",this.matesAdd),$(".exfee_pop_up .mates-minus").bind("click",this.matesMinus),$(".exfee_pop_up .rsvp-info .setto").bind("click",this.rsvp),$(".exfee_pop_up .invited").bind("hover",function(e){if(!readOnly){switch(e.type){case"mouseenter":ExfeePanel.editing="mates";break;case"mouseleave":ExfeePanel.editing=""}ExfeePanel.showRsvp()}}),$(".exfee_pop_up .rsvp-info").bind("hover",function(e){switch(e.type){case"mouseenter":ExfeePanel.editing="rsvp";break;case"mouseleave":ExfeePanel.editing=""}ExfeePanel.showRsvp()}),$(".exfee_pop_up .identities-list .delete i").bind("click",function(e){e.stopPropagation(),ExfeePanel.pre_delete=!0,ExfeePanel.showRsvp()}),$(".exfee_pop_up .identities-list .delete button").bind("click",function(){ExfeeWidget.delExfee(ExfeePanel.invitation.identity),ExfeePanel.hidePanel()}),$(".exfee_pop_up .identity-actions .btn-cancel").bind("click",function(){ExfeePanel.pre_delete=!1,ExfeePanel.showRsvp()}),$(".exfee_pop_up").bind("click",function(){ExfeePanel.pre_delete=!1,ExfeePanel.showRsvp()}),$(".exfee_pop_up").on("click","span.avatar > img",function(){window.open($(this).attr("src").replace(/\/(80_80)_/,"/original_"))}).on("mouseleave",function(){$(this).hide(144,function(){ExfeePanel.hidePanel()})})},matesAdd:function(){9>ExfeePanel.invitation.mates&&(ExfeeWidget.changeMates(ExfeePanel.invitation.identity,++ExfeePanel.invitation.mates),ExfeePanel.showRsvp())},matesMinus:function(){ExfeePanel.invitation.mates>0&&(ExfeeWidget.changeMates(ExfeePanel.invitation.identity,--ExfeePanel.invitation.mates),ExfeePanel.showRsvp())},rsvp:function(){var e=$(this).attr("rsvp");e&&(ExfeePanel.invitation.rsvp_status=e,ExfeePanel.invitation.by_identity=ExfeUtilities.clone(curIdentity),ExfeeWidget.rsvpExfee(ExfeePanel.invitation.identity,e),ExfeePanel.showRsvp())}}}),define(function(e){var t=e("jquery"),i=[],s={title:"",description:"",by_identity:{id:0},time:{begin_at:{date_word:"",date:"",time_word:"",time:"",timezone:"",id:0,type:"EFTime"},origin:"",outputformat:1,id:0,type:"CrossTime"},place:{title:"",description:"",lng:"",lat:"",provider:"",external_id:"",id:0,type:"Place"},attribute:{state:"published"},exfee_id:0,widget:[{image:"",widget_id:0,id:0,type:"Background"}],relative:{id:0,relation:""},type:"Cross"},n={id:0,type:"Exfee",invitations:[]},o=function(e){Cross.id&&(t(".cross-opts .saving").show(),Api.request("editExfee",{type:"POST",resources:{exfee_id:Exfee.id},data:{by_identity_id:curIdentity.id,exfee:JSON.stringify(Exfee)}},function(){t(".cross-opts .saving").hide(),e?window.location.href="/":V.emit("app:cross:edited")},function(e){t(".cross-opts .saving").hide();var i=!e.meta||401!==e.meta.code&&403!==e.meta.code?"":"no_permission";V.emit("app:cross:edited",{error:i})}))},a=function(e){$(),o(e)},r=function(){ExfeeCache.init(),ExfeeWidget.api_url=window._ENV_.api_url,window.GatherExfeeWidget=ExfeeWidget.make("gather-exfee",!0,a),window.CrossExfeeWidget=ExfeeWidget.make("cross-exfee",!0,a)},d=function(e){if(e){var i={by_identity_id:curIdentity.id,content:e.substr(0,233),id:0,relative:[],type:"Post",via:"exfe.com"};t(".cross-opts .saving").show(),Api.request("addConversation",{resources:{exfee_id:Exfee.id},type:"POST",data:JSON.stringify(i)},function(e){k=e.post.created_at,t(".cross-opts .saving").hide(),T(e.post),V.emit("app:cross:edited")},function(e){t(".cross-opts .saving").hide();var i=!e.meta||401!==e.meta.code&&403!==e.meta.code?"":"no_permission";V.emit("app:cross:edited",{error:i})})}},c=function(){t("#cross-form-discard").bind("click",function(){window.location="/"}),t("#cross-form-gather").bind("click",function(){if(t("body").trigger("click"),curIdentity)t(this).hasClass("disabled")||(t(this).prop("disabled",!0).toggleClass("disabled",!0),Z());else{var e=t.trim(t("#gather-title").val());0===e.length?(t(".choose-identity .placeholder").addClass("text-error"),t(".add-identity").addClass("hide"),t(".please-identity").removeClass("hide")):t(".choose-identity .placeholder").trigger("click")}}),t(".cross-conversation .comment-form .pointer").bind("click",function(){var e=t(".cross-conversation .comment-form textarea");d(e.val()),e.val("")}),t(".cross-conversation .comment-form textarea").bind("keydown",function(e){switch(e.which){case 13:var i=t(this);e.shiftKey||(e.preventDefault(),d(i.val()),i.val(""))}})},l=function(){var e=t("#gather-title");e.bind("focus keydown keyup blur",function(){g(e.val(),"gather")})},p=function(i){if(t(".cross-container").length&&!readOnly){var s=Editing,n=i?i.target:null,o={title:[function(){t(".cross-title").removeAttr("editable"),t(".cross-title .show").show(),g(t(".cross-title .edit").val(),"cross"),t(".cross-title .edit").hide(),B()},function(){t(".cross-title").attr("editable",!0),t(".cross-title .show").hide(),t(".cross-title .edit").show().focus()}],description:[function(){t(".cross-description-outer").removeAttr("editable"),t(".cross-description .show").show(),t(".cross-description .edit").hide(),x(t(".cross-description .edit").val()),B()},function(){t(".cross-description-outer").attr("editable",!0),t(".cross-description .show").hide(),t(".cross-description .xbtn-more").hide(),t(".cross-description .edit").show().focus()}],time:[function(){var e=t("#date-panel");if(e.size()){var i=e.data("widget-id"),n=App.widgetCaches[i];t.trim(t("#date-string").data("date")),("date-panel"===s||"time"===s)&&B(),n&&n.hide()}t(".cross-date").removeAttr("editable")},function(){var i=t("#date-panel");if(!i.size()){var s=e("datepanel"),n=new s({options:{parentNode:t("#app-tmp"),srcNode:t(".cross-date"),eftime:Cross.time}});n.show(),t(".cross-date").attr("editable",!0)}}],place:[function(){t(".cross-place").removeAttr("editable");var e=t("#map-panel");if(e.size()){var i=e.data("widget-id"),n=App.widgetCaches[i];("map-panel"===s||"place"===s)&&(Cross.place=n.place,B()),n&&n.hide()}},function(){var i=t("#map-panel");if(!i.size()){var s=e("mappanel"),n=new s({options:{parentNode:t("#app-tmp"),srcNode:t(".cross-place"),place:Cross.place},update:function(e){C(e),N(e)}});n.show(),t(".cross-place").attr("editable",!0)}}],rsvp:[function(){U()},function(){U(!0)}],background:[function(){},function(){!i||"dblclick"!==i.type||!s&&Cross.id||v(i?i.shiftKey:!1)}],exfee:[function(){t("#cross-exfee .exfee-input").val()||(t("#cross-exfee .total").css("visibility","hidden"),t("#cross-exfee .thumbnails .avatar .rb").hide()),t("#gather-exfee .exfee-input").val()||t("#gather-exfee .thumbnails .avatar .rb").hide(),ExfeeWidget.showLimitWarning(!1)},function(){}]};if(i){var a=t(n).attr("editarea");switch(a){case"rsvp":case"exfee":Editing=a}if("click"===i.type&&(Editing||!Cross.id)||"dblclick"===i.type)for(Editing=a;n&&!Editing&&"BODY"!==n.tagName;)n=n.parentNode,Editing=t(n).attr("editarea");else Editing=""}if("background"===Editing)o.background[1](),Editing=s;else{if("map-panel"===Editing)return;if("date-panel"===Editing)return;for(var r in o)o[r][~~(r===Editing)]()}}},f=function(){t("body").on("click",p),t("body").on("dblclick.data-link","[editarea]",p),t(".cross-title .edit").bind("focus keydown keyup blur",function(e){if("keydown"===e.type)switch(e.which){case 13:e.shiftKey||(e.preventDefault(),p())}g(t(e.target).val(),"cross")}),t(".cross-title, .cross-description-outer, .cross-date, .cross-place").bind("hover",function(e){var i=e.type;Editing&&"rsvp"!==Editing&&("mouseenter"!==i||t(this).attr("editable")?t(this).removeClass("cross-hover"):t(this).addClass("cross-hover"))});var e=0;t(".cross-description").bind("mousedown mouseup",function(t){"mousedown"===t.type?e=t.clientX+t.clientY:e-=t.clientX+t.clientY}),t(".cross-description").bind("click",function(){if(!Editing&&!e){e=0;var i=t(this),s=!i.hasClass("more");i.toggleClass("more",s).find(".xbtn-more").toggleClass("xbtn-less",s)}}),t(".cross-description .xbtn-more").bind("click",function(e){e.stopPropagation();var i=!t(this).hasClass("xbtn-less");t(".cross-description").toggleClass("more",i),t(this).toggleClass("xbtn-less",i)}),t(".cross-rsvp").bind("mouseenter mouseover mouseleave",function(e){if(!readOnly)switch(e.type){case"mouseenter":case"mouseover":t(".cross-rsvp .show .accepted").hide(),t(".cross-rsvp .show .change").show(),t(".cross-rsvp .show .by strong").html()&&t(".cross-rsvp .show .by").show();break;case"mouseleave":t(".cross-rsvp .show .accepted").show(),t(".cross-rsvp .show .change").hide(),t(".cross-rsvp .show .by").hide()}}),t(".cross-rsvp .edit .accept").bind("click",function(){ExfeeWidget.rsvpMe("ACCEPTED"),U()}),t(".cross-rsvp .edit .decline").bind("click",function(){ExfeeWidget.rsvpMe("DECLINED"),U()}),t(".cross-rsvp .edit .interested").bind("click",function(){ExfeeWidget.rsvpMe("INTERESTED"),U()}),t(".cross-place .edit").bind("keydown",function(e){e.shiftKey&&13===e.which&&(e.which=4)}),t(".cross-place .xbtn-more").bind("click",function(e){e.stopPropagation();var i=!t(this).hasClass("xbtn-less");t(".cross-dp.cross-place > address").toggleClass("more",i),t(this).toggleClass("xbtn-less",i)}),t(".ids-popmenu > ol > li").live("mouseenter mousedown",function(e){switch(e.type){case"mouseenter":ExfeeWidget.selectCompleteItem(t(this).index());break;case"mousedown":ExfeeWidget.useCompleteItem(t(this).index()),t(".exfee-input").val("")}})},u=function(){Cross.title.length||(Cross.title=curIdentity?"Meet "+curIdentity.name:"Gather a ·X·")},h=function(){var e=new Date,i=X.formatDate(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate());Cross.time={begin_at:{date_word:"",date:i,time_word:"",time:"",timezone:ExfeUtilities.getTimezone(),id:0,type:"EFTime"},origin:i,outputformat:0,id:0,type:"CrossTime"},t(".cross-date .edit").val(i)},v=function(e){var t=ExfeUtilities.clone(window._ENV_.backgrounds);t.push("");for(var i=0;Cross.widget.length>i&&"Background"!==Cross.widget[i].type;i++);if(e)Cross.widget[i].image="";else{var s=Cross.widget[i].image;do Cross.widget[i].image=t[parseInt(Math.random()*t.length)];while(s===Cross.widget[i].image)}I()},m=function(){ExfeeWidget.addExfee(curIdentity,!0,"ACCEPTED")
},g=function(e,t){Cross.title=ExfeUtilities.trim(e),E(t)},x=function(e){Cross.description=ExfeUtilities.trim(e),y()},_=function(){curIdentity&&t(".choose-identity").html('<img src="'+curIdentity.avatar_filename+'">')},E=function(e){Cross.title.length&&t(".choose-identity .placeholder").hasClass("text-error")&&(t(".choose-identity .placeholder").removeClass("text-error"),t(".add-identity").removeClass("hide"),t(".please-identity").addClass("hide"));var i=Cross.title.length?ExfeUtilities.escape(Cross.title):"Gathering for what?";switch(t(".cross-title .show").html(i),t(".cross-title").removeClass("single-line").removeClass("double-line"),t(".cross-title h1").height()>50?t(".cross-title").addClass("double-line").removeClass("single-line"):t(".cross-title").addClass("single-line").removeClass("double-line"),document.title="EXFE - "+Cross.title,e){case"gather":t(".cross-title .edit").val(Cross.title);break;case"cross":t("#gather-title").val(Cross.title);break;default:t(".cross-title .edit").val(Cross.title),t("#gather-title").val(Cross.title)}},y=function(){var e=t(".cross-description .xbtn-more").hasClass("xbtn-less"),i="";t(".cross-description").toggleClass("more",!0),t(".cross-description .xbtn-more").toggleClass("xbtn-less",!1),Cross.description?(i=ExfeUtilities.escape(Cross.description).replace(/\r\n|\r|\n/g,"<br>"),t(".cross-description .show").toggleClass("gray",!1).toggleClass("gsd",!1)):(i="Click here to describe something about this ·X·.",t(".cross-description .show").toggleClass("gray",!0).toggleClass("gsd",!Cross.id)),t(".cross-description .show").html()!==i&&t(".cross-description .show").html(i),t(".cross-description .show").height()>180?(t(".cross-description").toggleClass("more",!1),t(".cross-description .xbtn-more").show(),e&&(t(".cross-description").toggleClass("more",!0),t(".cross-description .xbtn-more").toggleClass("xbtn-less",!0))):t(".cross-description .xbtn-more").hide(),t(".cross-description .edit").val(Cross.description),Editing&&"rsvp"!==Editing||Cross.description||!Cross.id?t(".cross-description").show():t(".cross-description").hide()},w=function(){b(),A()},b=function(){function e(e){if(e=ExfeUtilities.trim(e)){var t=e.split(":");if(2===t.length){var i=60*60*parseInt(t[0],10),s=60*parseInt(t[1],10);return i+(i>0?s:-s)}}return null}var i=e(Cross.time.begin_at.timezone),s=e(ExfeUtilities.getTimezone()),n=(i===s&&window._ENV_.timevalid,""),o="",a="Pick a time.",r=!1;if(Cross.time.origin){var d=X.printEFTime(Cross.time,"X");n=d.content,o=d.title}else n=a,o="Sometime",r=!0;t(".cross-date h2").html(o),t(".cross-time").html(n).toggleClass("gray",r)},C=function(e){t(".cross-dp.cross-place > h2").html(e.title?ExfeUtilities.escape(e.title):"Somewhere"),t(".cross-dp.cross-place > address").toggleClass("more",!0),t(".cross-dp.cross-place .xbtn-more").toggleClass("xbtn-less",!1),e.description?t(".cross-dp.cross-place > address").html(ExfeUtilities.escape(e.description).replace(/\r\n|\r|\n/g,"<br>")).toggleClass("gray",!1):t(".cross-dp.cross-place > address").html("Choose a place.").toggleClass("gray",!0),t(".cross-dp.cross-place > address").height()>80?(t(".cross-dp.cross-place > address").toggleClass("more",!1),t(".cross-dp.cross-place .xbtn-more").show()):t(".cross-dp.cross-place .xbtn-more").hide(),e.description||e.title?t(".cross-dp.cross-place > address").css("display","none"):t(".cross-dp.cross-place > address").text("Choose a place.").css("display","block")},$=function(){window.GatherExfeeWidget.showAll(!0),window.CrossExfeeWidget.showAll(!1,!0)},I=function(){for(var e=0;Cross.widget.length>e&&"Background"!==Cross.widget[e].type;e++);t(".x-gather").toggleClass("no-bg",!1),t(".cross-background").css("background-image","url(/static/img/xbg/"+(Cross.widget[e].image?Cross.widget[e].image:"default.jpg")+")")},k="",W={},P=function(e,t){i=e;for(var s=i.length-1;s>=0;s--)s||(k=i[s].created_at),T(i[s],t)},T=function(e,i){if(void 0===W[e.id]){W[e.id]=!0;var s=ExfeUtilities.escape(e.content).replace(/\r\n|\n\r|\r|\n/g,"\n"),n='<div class="avatar-comment"><span class="pull-left avatar"><img alt="" src="'+e.by_identity.avatar_filename+'" width="40" height="40" />'+"</span>"+'<div class="comment">'+"<p>"+'<span class="author"><strong>'+e.by_identity.name+"</strong>:&nbsp;</span>"+ExfeUtilities.escape(e.content).replace(/\r\n|\n\r|\r|\n/g,"<br>")+'<span class="pull-right date">'+'<time data-iso-time="'+X.toISO(e.created_at)+'"></time>'+"</span>"+"</p>"+"</div>"+"</div>";t(".conversation-timeline").prepend(n),i&&window.webkitNotifications&&0===window.webkitNotifications.checkPermission()&&window.webkitNotifications.createNotification(null,"EXFE - "+Cross.title,e.by_identity.name+": "+s).show()}},A=function(){t("time[data-iso-time]").each(function(){var e=t(this);e.text(X(e.data("iso-time")))})},U=function(e){var i=ExfeeWidget.getMyInvitation();if(i){var s=i.by_identity?i.by_identity:curIdentity,n=i.identity.id===s.id;if("NORESPONSE"===i.rsvp_status||"IGNORED"===i.rsvp_status||e)return n?t(".cross-rsvp .edit .by").hide():(t(".cross-rsvp .edit .by .avatar img").attr("src",i.by_identity.avatar_filename),t(".cross-rsvp .edit .by strong").html(i.by_identity.name),t(".cross-rsvp .edit .by").show()),t(".cross-rsvp .show").hide(),t(".cross-rsvp .edit").fadeIn(233),void 0;if("ACCEPTED"===i.rsvp_status||"INTERESTED"===i.rsvp_status||"DECLINED"===i.rsvp_status){var o="";switch(i.rsvp_status){case"ACCEPTED":o="Accepted";break;case"DECLINED":o="Unavailable";break;case"INTERESTED":o="Interested"}n||"INTERESTED"===i.rsvp_status?(t(".cross-rsvp .show .by").hide(),t(".cross-rsvp .show .by strong").html("")):(t(".cross-rsvp .show .by .avatar img").attr("src",i.by_identity.avatar_filename),t(".cross-rsvp .show .by strong").html(i.by_identity.name),t(".cross-rsvp .show .by").show());for(var a=ExfeeWidget.summary(),r="",d=0;Math.min(a.accepted_invitations.length,5)>d;d++)r+='<li><span class="avatar alt40"><img height="20" width="20" alt="" src="'+a.accepted_invitations[d].identity.avatar_filename+'">'+(a.accepted_invitations[d].mates?'<i class="icon10-plus-'+a.accepted_invitations[d].mates+'"></i>':"")+"</span></li>";r+=a.accepted?"<li><span>"+a.accepted+" accepted.</span></li>":"";var c=t(".cross-rsvp .show .accepted");return c.text()!==t(r).text()&&c.html(r),t(".cross-rsvp .show .by").hide(),t(".cross-rsvp .show .change").hide(),t(".cross-rsvp .show .attendance").html(o),t(".cross-rsvp .show").fadeIn(233),t(".cross-rsvp .edit").hide(),void 0}}t(".cross-rsvp .show").hide(),t(".cross-rsvp .edit").hide()},N=function(e){function i(i){var s=i.coords;n=n.replace(/\{\{lat\}\}/gi,s.latitude).replace(/\{\{lng\}\}/gi,s.longitude).replace(/\{\{title\}\}/gi,(""===e.provider?s.latitude+","+s.longitude+" ":"")+encodeURIComponent(e.title)),t(".cross-map").append(n)}t(".cross-map").empty();var s=e.lat.length&&e.lng.length,n='<a target="_blank" href="https://maps.google.com/maps?key='+_ENV_.MAP_KEY+'&q={{title}}&hl=en&ie=UTF8&sll={{lat}},{{lng}}&t=m&z=16"><img style="border-radius: 3px; box-shadow: 2px 2px 4px rgba(0, 0, 0, .25);" src="https://maps.googleapis.com/maps/api/staticmap?center={{lat}},{{lng}}&markers=icon%3a'+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+'%7C{{lat}},{{lng}}&zoom=13&size=280x140&maptype=road&sensor=false" alt="" width="280" height="140" /></a>';s&&i({coords:{latitude:e.lat,longitude:e.lng}})},D=function(){E(),y(),C(Cross.place),$(),I(),U(),N(Cross.place)},O=function(e){var t={resources:{exfee_id:Exfee.id}};k&&(t.params={updated_at:k}),Api.request("conversation",t,function(t){P(t.conversation,e)})},S=function(){O(!0)},z=function(){t("#conversation-form span.avatar img").attr("src",curIdentity.avatar_filename),t("#conversation-form").show(),t(".conversation-timeline").html(""),t(".cross-conversation").slideDown(233),k="",W={},O(),convTimer=setInterval(S,233e3)},R=function(e,i){Cross.id=e.id,Cross.title=e.title,Cross.description=e.description,Cross.time=e.time,Cross.place=e.place,Cross.widget=e.widget,Cross.exfee_id=e.exfee.id,Exfee=e.exfee,readOnly=i,Y=F(),void 0===Cross.time||void 0===Cross.time.begin_at||Cross.time.begin_at.timezone||(Cross.time.begin_at.timezone=ExfeUtilities.getTimezone()),t(".cross-date  .edit").val(Cross.time.origin),t(".cross-place .edit").val(Cross.place.title+(Cross.place.description?"\n"+Cross.place.description:""));for(var s=0;Exfee.invitations.length>s;s++)if(ExfeeWidget.isMyIdentity(Exfee.invitations[s].identity)){curIdentity=ExfeUtilities.clone(Exfee.invitations[s].identity);break}D(),z()},L=function(e){Api.request("getCross",{resources:{cross_id:e}},function(e){R(e.cross,!1)},function(){V.emit("app:cross:forbidden",e)})},M=function(){window.Cross=ExfeUtilities.clone(s),window.Exfee=ExfeUtilities.clone(n)},q=function(){readOnly=!1,M(),v(),u(),h(),m(),D(),G()},Z=function(){t(".cross-opts .saving").show();var e=ExfeUtilities.clone(Cross);e.exfee=ExfeUtilities.clone(Exfee),e.by_identity={id:curIdentity.id},Api.request("gather",{type:"POST",data:JSON.stringify(e)},function(e){t(".cross-opts .saving").hide(),document.location="/#!"+e.cross.id},function(){t(".cross-opts .saving").hide(),t("#cross-form-gather").prop("disabled",!1).toggleClass("disabled",!1)})},j=function(){t(".cross-opts .saving").show();var e=ExfeUtilities.clone(Cross);e.by_identity={id:curIdentity.id},Api.request("editCross",{type:"POST",resources:{cross_id:Cross.id},data:JSON.stringify(e)},function(){t(".cross-opts .saving").hide(),V.emit("app:cross:edited")},function(e){t(".cross-opts .saving").hide();var i=!e.meta||401!==e.meta.code&&403!==e.meta.code?"":"no_permission";V.emit("app:cross:edited",{error:i})})},F=function(){return JSON.stringify({id:Cross.id,title:Cross.title,description:Cross.description,time:Cross.time.origin+", "+Cross.time.begin_at.date+", "+Cross.time.begin_at.time,place:{title:Cross.place.title,description:Cross.place.description,lat:Cross.place.lat,lng:Cross.place.lng,updated_at:Cross.place.updated_at},background:Cross.widget[0].image})},B=function(){if(Cross.id){var e=F();Y!==e&&(j(),Y=e)}},G=function(e){e?(t(".cross-form").slideUp(233),t(".cross-edit").show(233)):(_(),t(".cross-form").slideDown(233),t(".cross-edit").hide(233),t("#gather-title").select(),t("#gather-title").focus())};window.Store=e("store"),window.Api=e("api"),window.webkitNotifications&&window.webkitNotifications.requestPermission(function(){});var X=e("humantime");window.curIdentity=null,window.readOnly=!1;var V=e("bus"),Y="";V.on("xapp:cross:main",function(){var t=Store.get("authorization");window.User=t?Store.get("user"):null,User&&(Api.setToken(t.token),curIdentity=ExfeUtilities.clone(User.identities[0])),M(),r(),c(),l(),Editing="",f(),Marked=e("marked"),window.ExfeePanel=e("exfeepanel"),window.showtimeTimer=setInterval(w,50),window.convTimer=null}),V.on("xapp:cross",function(e,t,i,s,n,o){if(e>0)L(e);else if(null===e)switch(t&&(curIdentity=t,Api.setToken(n)),R(i,s),o){case"accept":ExfeeWidget.rsvpMe("ACCEPTED"),U();break;case"decline":ExfeeWidget.rsvpMe("DECLINED"),U()}else q()}),V.on("app:user:signin:after",function(){if(window.Cross&&!window.Cross.id){var e=Store.get("authorization");window.User=e?Store.get("user"):null,User&&(Api.setToken(e.token),curIdentity=ExfeUtilities.clone(User.identities[0]),_(),m())}}),V.on("xapp:cross:end",function(){clearTimeout(window.showtimeTimer),clearTimeout(window.convTimer)}),t(document.body).on("hover","div.lock-tag",function(e){var i=e.type,s=t(this).offset();"mouseenter"===i?t('<div class="tooltip tip-lock" id="app-tip-lock"><div class="inner"><div>This <span class="x">·X·</span> is private.</div><div>Accessible to only attendees.</div></div></div>').css({left:s.left-135,top:s.top+25}).appendTo(document.body):t("#app-tip-lock").remove()})});var MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function i(e,t){var i,s,n,o,a;return n=2147483648&e,o=2147483648&t,i=1073741824&e,s=1073741824&t,a=(1073741823&e)+(1073741823&t),i&s?2147483648^a^n^o:i|s?1073741824&a?3221225472^a^n^o:1073741824^a^n^o:a^n^o}function s(e,t,i){return e&t|~e&i}function n(e,t,i){return e&i|t&~i}function o(e,t,i){return e^t^i}function a(e,t,i){return t^(e|~i)}function r(e,n,o,a,r,d,c){return e=i(e,i(i(s(n,o,a),r),c)),i(t(e,d),n)}function d(e,s,o,a,r,d,c){return e=i(e,i(i(n(s,o,a),r),c)),i(t(e,d),s)}function c(e,s,n,a,r,d,c){return e=i(e,i(i(o(s,n,a),r),c)),i(t(e,d),s)}function l(e,s,n,o,r,d,c){return e=i(e,i(i(a(s,n,o),r),c)),i(t(e,d),s)}function p(e){for(var t,i=e.length,s=i+8,n=(s-s%64)/64,o=16*(n+1),a=Array(o-1),r=0,d=0;i>d;)t=(d-d%4)/4,r=8*(d%4),a[t]=a[t]|e.charCodeAt(d)<<r,d++;return t=(d-d%4)/4,r=8*(d%4),a[t]=a[t]|128<<r,a[o-2]=i<<3,a[o-1]=i>>>29,a}function f(e){var t,i,s="",n="";for(i=0;3>=i;i++)t=255&e>>>8*i,n="0"+t.toString(16),s+=n.substr(n.length-2,2);return s}function u(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;e.length>i;i++){var s=e.charCodeAt(i);128>s?t+=String.fromCharCode(s):s>127&&2048>s?(t+=String.fromCharCode(192|s>>6),t+=String.fromCharCode(128|63&s)):(t+=String.fromCharCode(224|s>>12),t+=String.fromCharCode(128|63&s>>6),t+=String.fromCharCode(128|63&s))}return t}var h,v,m,g,x,_,E,y,w,b=[],C=7,$=12,I=17,k=22,W=5,P=9,T=14,A=20,U=4,N=11,D=16,O=23,S=6,z=10,R=15,L=21;for(e=u(e),b=p(e),_=1732584193,E=4023233417,y=2562383102,w=271733878,h=0;b.length>h;h+=16)v=_,m=E,g=y,x=w,_=r(_,E,y,w,b[h+0],C,3614090360),w=r(w,_,E,y,b[h+1],$,3905402710),y=r(y,w,_,E,b[h+2],I,606105819),E=r(E,y,w,_,b[h+3],k,3250441966),_=r(_,E,y,w,b[h+4],C,4118548399),w=r(w,_,E,y,b[h+5],$,1200080426),y=r(y,w,_,E,b[h+6],I,2821735955),E=r(E,y,w,_,b[h+7],k,4249261313),_=r(_,E,y,w,b[h+8],C,1770035416),w=r(w,_,E,y,b[h+9],$,2336552879),y=r(y,w,_,E,b[h+10],I,4294925233),E=r(E,y,w,_,b[h+11],k,2304563134),_=r(_,E,y,w,b[h+12],C,1804603682),w=r(w,_,E,y,b[h+13],$,4254626195),y=r(y,w,_,E,b[h+14],I,2792965006),E=r(E,y,w,_,b[h+15],k,1236535329),_=d(_,E,y,w,b[h+1],W,4129170786),w=d(w,_,E,y,b[h+6],P,3225465664),y=d(y,w,_,E,b[h+11],T,643717713),E=d(E,y,w,_,b[h+0],A,3921069994),_=d(_,E,y,w,b[h+5],W,3593408605),w=d(w,_,E,y,b[h+10],P,38016083),y=d(y,w,_,E,b[h+15],T,3634488961),E=d(E,y,w,_,b[h+4],A,3889429448),_=d(_,E,y,w,b[h+9],W,568446438),w=d(w,_,E,y,b[h+14],P,3275163606),y=d(y,w,_,E,b[h+3],T,4107603335),E=d(E,y,w,_,b[h+8],A,1163531501),_=d(_,E,y,w,b[h+13],W,2850285829),w=d(w,_,E,y,b[h+2],P,4243563512),y=d(y,w,_,E,b[h+7],T,1735328473),E=d(E,y,w,_,b[h+12],A,2368359562),_=c(_,E,y,w,b[h+5],U,4294588738),w=c(w,_,E,y,b[h+8],N,2272392833),y=c(y,w,_,E,b[h+11],D,1839030562),E=c(E,y,w,_,b[h+14],O,4259657740),_=c(_,E,y,w,b[h+1],U,2763975236),w=c(w,_,E,y,b[h+4],N,1272893353),y=c(y,w,_,E,b[h+7],D,4139469664),E=c(E,y,w,_,b[h+10],O,3200236656),_=c(_,E,y,w,b[h+13],U,681279174),w=c(w,_,E,y,b[h+0],N,3936430074),y=c(y,w,_,E,b[h+3],D,3572445317),E=c(E,y,w,_,b[h+6],O,76029189),_=c(_,E,y,w,b[h+9],U,3654602809),w=c(w,_,E,y,b[h+12],N,3873151461),y=c(y,w,_,E,b[h+15],D,530742520),E=c(E,y,w,_,b[h+2],O,3299628645),_=l(_,E,y,w,b[h+0],S,4096336452),w=l(w,_,E,y,b[h+7],z,1126891415),y=l(y,w,_,E,b[h+14],R,2878612391),E=l(E,y,w,_,b[h+5],L,4237533241),_=l(_,E,y,w,b[h+12],S,1700485571),w=l(w,_,E,y,b[h+3],z,2399980690),y=l(y,w,_,E,b[h+10],R,4293915773),E=l(E,y,w,_,b[h+1],L,2240044497),_=l(_,E,y,w,b[h+8],S,1873313359),w=l(w,_,E,y,b[h+15],z,4264355552),y=l(y,w,_,E,b[h+6],R,2734768916),E=l(E,y,w,_,b[h+13],L,1309151649),_=l(_,E,y,w,b[h+4],S,4149444226),w=l(w,_,E,y,b[h+11],z,3174756917),y=l(y,w,_,E,b[h+2],R,718787259),E=l(E,y,w,_,b[h+9],L,3951481745),_=i(_,v),E=i(E,m),y=i(y,g),w=i(w,x);var M=f(_)+f(E)+f(y)+f(w);return M.toLowerCase()};