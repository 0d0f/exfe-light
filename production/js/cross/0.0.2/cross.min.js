define(function(e){ExfeUtilities={trim:function(e){return e?e.replace(/^\s+|\s+$/g,""):""},escape:function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},clone:function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var i in e)t[i]=this.clone(e[i]);break;case"[object Array]":t=[];for(i in e)t.push(this.clone(e[i]));break;default:t=e}return t},getTimezone:function(){var e=""+Date(),t=e.replace(/^.+([+-]\d{2})(\d{2}).+$/i,"$1:$2"),i=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return i="UTC"===i||"GMT"===i?"":i,t+(i===e?"":" "+i)},parsePlacestring:function(e){for(var t=e?e.split(/\r\n|\r|\n/g):[],i=[],n=0;t.length>n;n++)t[n]&&i.push(t[n]);var a=i.shift();return a=a?a:"",{title:a,description:i.join("\r"),lng:"",lat:"",provider:"",external_id:"",id:Cross.place.id,type:"Place"}}},ExfeeCache={identities:[],tried_key:{},updated_identity:[],init:function(){var e=Store.get("exfee_cache_user_id"),t=Store.get("exfee_cache_identities");User&&User.id&&e&&User.id===e&&t||(t=[]),this.identities=[];for(var i=0;t.length>i;i++)t[i].external_username&&this.identities.push(t[i])},saveCache:function(){User&&User.id&&(Store.set("exfee_cache_user_id",User.id),Store.set("exfee_cache_identities",this.identities))},search:function(e){var t=function(e,t){return t?-1!==t.toLowerCase().indexOf(e):!1},i=function(e,i){return t(e,i.external_id)||t(e,i.external_username)||t(e,i.name)},n=[];e=e.toLowerCase();for(var a=0;this.identities.length>a;a++)i(e,this.identities[a])&&!ExfeeWidget.isMyIdentity(this.identities[a])&&ExfeeWidget.checkExistence(this.identities[a])===!1&&n.push(ExfeUtilities.clone(this.identities[a]));return n},cacheIdentities:function(e,t){e=ExfeUtilities.clone(e);for(var i=0;e.length>i;i++){for(var n=0;this.identities.length>n;n++)ExfeeWidget.compareIdentity(e[i],this.identities[n])&&this.identities.splice(n,1);t?this.identities.unshift(e[i]):this.identities.push(e[i]),this.identities.length>233&&this.identities.splice(233),this.updated_identity.push(e[i])}this.saveCache()},fetchIdentity:function(e){for(var t=0;this.identities.length>t;t++)if(ExfeeWidget.compareIdentity(e,this.identities[t]))return ExfeUtilities.clone(this.identities[t]);return null}},ExfeeWidget={dom_id:"",rsvp_status:["Pending","Accepted","Unavailable","Interested"],editable:!1,complete_timer:0,complete_key:"",complete_exfee:[],complete_request:0,selected:"",completing:!1,callback:function(){},last_inputed:{},base_info_timer:0,api_url:"",focus:{},soft_limit:12,hard_limit:50,blur:!0,make:function(e,t,i){return this.dom_id=e,this.editable=t,this.callback=i,$("#"+this.dom_id+" .total").css("visibility","hidden"),$("#"+this.dom_id+" .avatar .rb").hide(),$("#"+this.dom_id).bind("mouseenter mouseleave",function(t){switch(t.type){case"mouseenter":$("#"+e+" .total").css("visibility","visible"),$("#"+e+" .avatar .rb").show();break;case"mouseleave":ExfeeWidget.focus[e+"-input"]||""!==$("#"+e+" .exfee-input").val()||($("#"+e+" .total").css("visibility","hidden"),$("#"+e+" .avatar .rb").hide())}}),$("#"+this.dom_id+" .input-xlarge").bind("focus keydown blur",this.inputEvent),$("#"+this.dom_id+" .pointer").bind("mousedown",function(t){return t.preventDefault(),t.stopPropagation(),ExfeeWidget.checkInput($("#"+e+" .input-xlarge"),!0),ExfeeWidget.blur=!1,!1}).bind("click",function(e){return e.preventDefault(),e.stopPropagation(),!1}),$(document).on("mousedown","#"+this.dom_id+" .thumbnails > li.identity > .avatar",function(){ExfeeWidget.showPanel(this.parentNode)}),this.complete_timer=setInterval("ExfeeWidget.checkInput($('#"+this.dom_id+" .input-xlarge'))",50),ExfeUtilities.clone(this)},showAll:function(e,t){var i=0,n=0,a=["ACCEPTED","INTERESTED","NORESPONSE","DECLINED","IGNORED"];$("#"+this.dom_id+" .thumbnails").html("");for(var r=0;a.length>r;r++)for(var s=0;Exfee.invitations.length>s;s++)if(Exfee.invitations[s].rsvp_status===a[r]){var o=Exfee.invitations[s].mates+1;e&&ExfeeWidget.isMyIdentity(Exfee.invitations[s].identity)||this.showOne(Exfee.invitations[s],t),"ACCEPTED"===Exfee.invitations[s].rsvp_status&&(i+=o),n+=o}$("#"+this.dom_id+" .attended").html(i),$("#"+this.dom_id+" .total").html("of "+n)},showOne:function(e,t){var i={ACCEPTED:"icon14-rsvp-accepted-blue",DECLINED:"icon14-rsvp-declined",INTERESTED:"icon14-rsvp-interested",NORESPONSE:"icon14-rsvp-noresponse"};$("#"+this.dom_id+" .thumbnails").append('<li class="identity" id="'+e.identity.id+'" provider="'+e.identity.provider.toLowerCase()+'" external_id="'+e.identity.external_id.toLowerCase()+'" external_username="'+e.identity.external_username.toLowerCase()+'">'+'<span class="pointer avatar'+(t&&"ACCEPTED"!==e.rsvp_status?" unconfirmed":"")+'">'+'<img src="'+e.identity.avatar_filename+'" alt="'+e.identity.external_id+'" width="50" height="50" />'+'<i class="rt'+(e.host?" icon10-host-h":"")+'"></i>'+'<i class="icon10-plus-'+e.mates+' lt"></i>'+("cross-exfee"===this.dom_id?'<span class="rb rb-bg'+(ExfeeWidget.focus[this.dom_id+"-input"]?"":" hide")+'">'+'<i class="'+i[e.rsvp_status]+'"></i>'+"</span>":"")+"</span>"+'<div class="identity-name">'+e.identity.name+"</div>"+"</li>")},showLimitWarning:function(e){$(".exfee-warning").toggleClass("hide",e===!1)},showTip:function(e){var t=$(e),i=t.offset(),n={},a=t.attr("id"),r=t.attr("provider"),s=t.attr("external_id"),o=t.attr("external_username");(a=~~a)&&(n.id=a),r&&(n.provider=r),s&&(n.external_id=s),o&&(n.external_username=o);var l=this.getInvitationByIdentity(n);ExfeePanel.showTip(l,i.left,i.top+50)},showPanel:function(e){var t=$(e),i=t.offset(),n={},a=t.attr("id"),r=t.attr("provider"),s=t.attr("external_id"),o=t.attr("external_username");(a=~~a)&&(n.id=a),r&&(n.provider=r),s&&(n.external_id=s),o&&(n.external_username=o);var l=this.getInvitationByIdentity(n);ExfeePanel.showPanel(l,i.left+5,i.top+5)},compareIdentity:function(e,t){if(e.id&&t.id&&e.id===t.id)return!0;if(ExfeUtilities.trim(e.provider).toLowerCase()===ExfeUtilities.trim(t.provider).toLowerCase()){if(e.external_id&&t.external_id&&ExfeUtilities.trim(e.external_id).toLowerCase()===ExfeUtilities.trim(t.external_id).toLowerCase())return!0;if(e.external_username&&t.external_username&&ExfeUtilities.trim(e.external_username).toLowerCase()===ExfeUtilities.trim(t.external_username).toLowerCase())return!0}return!1},checkExistence:function(e){for(var t=0;Exfee.invitations.length>t;t++)if(this.compareIdentity(Exfee.invitations[t].identity,e))return t;return!1},addExfee:function(e,t,i){var n=ExfeeWidget.summary().items;if(ExfeeWidget.hard_limit>n&&e){var a=this.checkExistence(e);return a===!1?(Exfee.invitations.push({identity:ExfeUtilities.clone(e),rsvp_status:i?i:"NORESPONSE",host:!!t,mates:0}),this.callback()):"REMOVED"===Exfee.invitations[a].rsvp_status&&(Exfee.invitations[a].rsvp_status="NORESPONSE",this.callback()),!0}return!1},delExfee:function(e){this.rsvpExfee(e,"REMOVED")},rsvpExfee:function(e,t){var i=this.checkExistence(e);if(i!==!1){Exfee.invitations[i].rsvp_status=t,Exfee.invitations[i].by_identity=ExfeUtilities.clone(curIdentity);var n=!1;"REMOVED"===t&&curIdentity&&ExfeeWidget.compareIdentity(Exfee.invitations[i].identity,curIdentity)&&(n=!0),this.callback(n)}},changeMates:function(e,t){var i=this.checkExistence(e);i!==!1&&(t>9&&(t=9),0>t&&(t=0),Exfee.invitations[i].mates=t,this.callback())},rsvpMe:function(e){this.rsvpExfee(curIdentity,e)},summary:function(){for(var e={items:0,accepted:0,total:0,accepted_invitations:[]},t=0;Exfee.invitations.length>t;t++)if("REMOVED"!==Exfee.invitations[t].rsvp_status&&"NOTIFICATION"!==Exfee.invitations[t].rsvp_status){e.items++;var i=1+Exfee.invitations[t].mates;e.total+=i,"ACCEPTED"===Exfee.invitations[t].rsvp_status&&(e.accepted+=i,e.accepted_invitations.push(Exfee.invitations[t]))}return e},getUTF8Length:function(e){var t=0;if(e)for(var i=0;e.length>i;i++)charCode=e.charCodeAt(i),127>charCode?t+=1:charCode>=128&&2047>=charCode?t+=2:charCode>=2048&&65535>=charCode&&(t+=3);return t},cutLongName:function(e){for(e=e?e.replace(/[^0-9a-zA-Z_\u4e00-\u9fa5\ \'\.]+/g," "):"";this.getUTF8Length(e)>30;)e=e.substring(0,e.length-1);return e},parseAttendeeInfo:function(e){e=ExfeUtilities.trim(e);var t={id:0,name:"",external_id:"",external_username:"",provider:"",type:"identity"};if(/^[^@]*<[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?>$/.test(e)){var i=e.indexOf("<"),n=e.indexOf(">");t.external_id=ExfeUtilities.trim(e.substring(++i,n)),t.external_username=t.external_id,t.name=ExfeUtilities.trim(this.cutLongName(ExfeUtilities.trim(e.substring(0,i)).replace(/^"|^'|"$|'$/g,""))),t.provider="email"}else if(/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e))t.external_id=e,t.external_username=e,t.name=ExfeUtilities.trim(this.cutLongName(e.split("@")[0])),t.provider="email";else if(/^@[a-z0-9_]{1,15}$|^@[a-z0-9_]{1,15}@twitter$|^[a-z0-9_]{1,15}@twitter$/i.test(e))t.external_id="",t.external_username=e.replace(/^@|@twitter$/gi,""),t.name=t.external_username,t.provider="twitter";else{if(!/^[a-z0-9\.]{5,}@facebook$/i.test(e))return null;t.external_id="",t.external_username=e.replace(/@facebook$/gi,""),t.name=t.external_username,t.provider="facebook"}return t.avatar_filename=encodeURI(ExfeeWidget.api_url+"/avatar/default?name="+t.name),t},checkComplete:function(e,t,i){this.showCompleteItems(e,t,t?ExfeeCache.search(t):[],i),this.ajaxComplete(e,t)},displayIdentity:function(e,t){switch(e?e.provider:""){case"email":case"phone":return/^\+1.{10}$/.test(e.external_id)?e.external_id.replace(/^(\+1)(.{3})(.{3})(.{4})$/,"$1 ($2) $3-$4"):/^\+86.{11}$/.test(e.external_id)?e.external_id.replace(/^(\+86)(.{3})(.{4})(.{4})$/,"$1 $2 $3 $4"):e.external_id;case"twitter":return"@"+e.external_username+(t?"":"@twitter");case"facebook":return e.external_username+(t?"":"@facebook");default:return""}},displayCompletePanel:function(e,t){if(this.completing=t){var i=e.offset();$(".ids-popmenu").css({left:i.left+"px",top:i.top+e.height()+10+"px","max-height":"352px","overflow-y":"scroll"}).slideDown(50)}else $(".ids-popmenu").slideUp(50)},showCompleteItems:function(t,i,n,a){var r=function(e){var t=RegExp("("+i.replace(/^\+/,"")+")");return e?e.replace(t,'<span class="highlight">$1</span>'):""},s=$(".ids-popmenu > ol"),o="";i=i?i.toLowerCase():"",ExfeeWidget.complete_key!==i&&(ExfeeWidget.complete_exfee=[],s.html("")),ExfeeWidget.complete_key=i;for(var l=0;n.length>l;l++){for(var c=!1,d=0;ExfeeWidget.complete_exfee.length>d;d++)if(this.compareIdentity(ExfeeWidget.complete_exfee[d],n[l])){c=!0;break}if(!c){ExfeeWidget.complete_exfee.push(ExfeUtilities.clone(n[l]))-1;var u=n[l].provider;o+='<li><span class="pull-left avatar"><img src="'+n[l].avatar_filename+'" alt="" width="40" height="40">'+'<span class="rb"><i class="icon16-identity-'+n[l].provider+'"></i></span>'+"</span>"+'<div class="identity">'+'<div class="name">'+r(n[l].name)+"</div>"+"<div>"+'<span class="oblique external">'+r(this.displayIdentity(n[l],!0))+"</span>"+("email"===u||"phone"===u?"":' <span class="provider">@'+u.charAt(0).toUpperCase()+u.substr(1)+"</span>")+"</div>"+"</div>"+"</li>"}}s.append(o),this.displayCompletePanel(t,i&&ExfeeWidget.complete_exfee.length);var h=i.replace(/\-|\(|\)|\ /g,"");if(h&&a&&!ExfeeWidget.complete_exfee.length&&!$("#phone-panel").length&&/^[\+＋]?[0-9\uFF10-\uFF19]{5,15}$/.test(h)){var p={"＋":"+","０":"0","１":"1","２":"2","３":"3","４":"4","５":"5","６":"6","７":"7","８":"8","９":"9"},f=h.split("");for(h="",l=0;f.length>l;l++)h+=p[f[l]]===void 0?f[l]:p[f[l]];t.val(h);var m=e("phonepanel"),g=new m({options:{parentNode:$("#app-tmp"),srcNode:t},add:function(e){ExfeeWidget.addExfee(e),t.val("")}});g.show()}},isMyIdentity:function(e){return curIdentity&&(this.compareIdentity(e,curIdentity)||e.connected_user_id===curIdentity.connected_user_id)},getInvitationByIdentity:function(e){for(var t=0;Exfee.invitations.length>t;t++)if(this.compareIdentity(Exfee.invitations[t].identity,e))return Exfee.invitations[t];return null},getMyInvitation:function(){return curIdentity?this.getInvitationByIdentity(curIdentity):null},ajaxComplete:function(e,t){User&&t&&void 0===ExfeeCache.tried_key[t]&&(this.complete_request&&this.complete_request.abort(),this.complete_request=Api.request("complete",{type:"get",data:{key:t}},function(i){for(var n=[],a=0;i.identities.length>a;a++)ExfeeWidget.isMyIdentity(i.identities[a])||ExfeeWidget.checkExistence(i.identities[a])!==!1||n.push(i.identities[a]),ExfeeCache.cacheIdentities(n),ExfeeCache.tried_key[t]=!0,ExfeeWidget.complete_key===t&&ExfeeWidget.showCompleteItems(e,t,n)}))},ajaxIdentity:function(e){e&&e.length&&Api.request("getIdentity",{type:"POST",data:{identities:JSON.stringify(e)}},function(e){for(var t=[],i=0;e.identities.length>i;i++){var n=ExfeeWidget.checkExistence(e.identities[i]);n!==!1&&(Exfee.invitations[n].identity=e.identities[i]),t.push(e.identities[i])}t.length&&(ExfeeCache.cacheIdentities(t),window.GatherExfeeWidget.showAll(!0),window.CrossExfeeWidget.showAll(!1,!0))})},checkInput:function(e,t){if(e&&e.length){var i=e.val(),n=i.split(/,|;|\r|\n|\t/),a=[],r=[],s="",o="";if(ExfeeWidget.last_inputed[e[0].id]!==i||t){ExfeeWidget.last_inputed[e[0].id]=i;for(var l=0;n.length>l;l++)if(s=ExfeUtilities.trim(n[l])){var c=ExfeeWidget.parseAttendeeInfo(s);c&&(n.length-1>~~l||t)&&this.addExfee(c)?a.push(c):(r.push(n[l]),o=n[l])}var d=r.join("; ");d!==i&&e.val(d),this.ajaxIdentity(a),ExfeeWidget.summary().items>=ExfeeWidget.hard_limit&&i&&(o="");var u=!!ExfeeWidget.parseAttendeeInfo(o)||/^\+?[0-9]{5,15}$/.test(o);e.parent().find(".pointer").toggleClass("icon16-exfee-plus-blue",u).toggleClass("icon16-exfee-plus",!u),this.checkComplete(e,o.replace(/^@/,""),t)}}},selectCompleteItem:function(e){var t="active";$(".ids-popmenu > ol > li").removeClass(t).eq(e).addClass(t)},useCompleteItem:function(e){var t=ExfeeCache.fetchIdentity(this.complete_exfee[e]);t?(this.complete_exfee.splice(e,1),ExfeeCache.cacheIdentities(t)):t=ExfeUtilities.clone(this.complete_exfee[e]),this.addExfee(t)},inputEvent:function(e){var t=$(e.target);switch(ExfeeWidget.blur=!0,e.type){case"focus":ExfeeWidget.focus[e.target.id]=!0;break;case"keydown":switch(e.which){case 9:ExfeeWidget.checkInput(t,!0);break;case 13:var i=$(".ids-popmenu > ol > .active"),n=i.length?~~i.index():null;ExfeeWidget.completing&&null!==n?(ExfeeWidget.useCompleteItem(n),ExfeeWidget.displayCompletePanel(t,!1),t.val("")):ExfeeWidget.checkInput(t,!0),ExfeeWidget.blur=!1;break;case 27:ExfeeWidget.completing&&ExfeeWidget.displayCompletePanel(t,!1);break;case 38:case 40:e.preventDefault();var a=$(".ids-popmenu"),r=352,s=50,o=a.scrollTop();if(!ExfeeWidget.completing)return;var i=a.find("ol .active"),n=~~i.index(),l=ExfeeWidget.complete_exfee.length-1;switch(e.which){case 38:0>--n&&(n=l);break;case 40:++n>l&&(n=0)}ExfeeWidget.selectCompleteItem(n);var c=n*s,d=c-o;0>d?a.scrollTop(c):d+s>r&&a.scrollTop(c+s-r+1)}break;case"blur":ExfeeWidget.focus[e.target.id]=!1,ExfeeWidget.displayCompletePanel(t,!1);var u=function(){t.parent().find(".pointer").hasClass("icon16-exfee-plus-blue")&&(t.parent().toggleClass("a-bounce"),setTimeout(function(){t.parent().toggleClass("a-bounce",!1)},1e3))};setTimeout(function(){ExfeeWidget.blur&&u(),ExfeeWidget.blur=!0},50)}}}}),define("exfeepanel",function(){var e=$("body");return e.bind("click",function(e){for(var t=e.target;t&&!$(t).hasClass("exfee_pop_up")&&!$(t).hasClass("exfee_pop_up_save")&&"BODY"!==t.tagName;)t=t.parentNode;$(t).hasClass("exfee_pop_up")||$(t).hasClass("exfee_pop_up_save")||$(".exfee_pop_up").hide().remove()}),{objBody:e,tipId:"",panelId:"",arrRsvp:{NORESPONSE:["Pending"],ACCEPTED:["Accepted"],INTERESTED:["Interested"],DECLINED:["Unavailable"],IGNORED:["Pending"]},invitation:{},editing:"",pre_delete:!1,newId:function(e){return"id_"+e.identity.id+"provider_"+e.identity.provider+"external_id_"+e.identity.external_id+"external_username_"+e.identity.external_username},showTip:function(e,t,i){var n=this.newId(e),a='<div class="tooltip tip-exfee  exfee_pop_up" style="left: '+t+"px; top: "+i+'px;">'+'<div class="tooltip-inner">'+"<h5>"+e.identity.name+"</h5>"+"<div>"+'<i class="icon16-identity-'+e.identity.provider+'"></i>'+'<span class="oblique">'+ExfeeWidget.displayIdentity(e.identity,!0)+"</span>"+"</div>"+"</div>"+"</div>";this.tipId===n&&$(".tip-exfee").length||(this.tipId=n,this.hideTip(),this.objBody.append(a),$(".exfeetip").show())},showPanel:function(e,t,i){var n=this.newId(e),a='<div class="exfeepanel exfee_pop_up" style="left: '+t+"px; top: "+i+'px; z-index: 10">'+'<div class="tooltip-inner">'+'<div class="avatar-name">'+'<span class="pull-left pointer avatar">'+'<img src="'+e.identity.avatar_filename+'" alt="" width="60" height="60" />'+'<i class="lt"></i>'+"</span>"+"<h4>"+e.identity.name+"</h4>"+"</div>"+'<div class="clearfix rsvp-actions">'+'<div class="pull-right invited">'+'<div class="mates-num hide"></div>'+'<div class="pull-left together-with hide">Mates&nbsp;</div>'+'<div class="pull-right mates-info">'+'<i class="mates-add icon-plus-blue"></i>'+"</div>"+'<div class="pull-left mates-edit hide">'+'<i class="pull-left mates-minus icon14-mates-minus"></i>'+'<span class="pull-left num"></span>'+'<i class="pull-left mates-add icon14-mates-add"></i>'+"</div>"+"</div>"+'<div class="rsvp-info">'+'<div class="rsvp-content">'+'<div class="attendance"></div>'+'<div class="by">by <span class="name"></span></div>'+"</div>"+'<div class="pull-right pointer underline setto">'+(readOnly?"":'<span>set to</span> <i class="icon-rsvp-declined-red"></i>')+"</div>"+"</div>"+"</div>"+'<div class="identities">'+'<ul class="identities-list">'+"<li>"+'<i class="pull-left icon16-identity-'+e.identity.provider+'"></i>'+'<span class="oblique identity">'+ExfeeWidget.displayIdentity(e.identity,!0)+"</span>"+(readOnly?"":'<div class="identity-btn delete"><i class="icon-minus-red"></i><button class="btn-leave">Leave</button></div>')+"</li>"+"</ul>"+'<div class="identity-actions">'+"<p>"+'<span class="xalert-fail">Remove yourself?</span>'+"<br />"+'<span class="xalter-info">You will <strong>NOT</strong> be able to access any information in this <span class="x">·X·</span>. Confirm leaving?</span>'+'<button class="pull-right btn-cancel">Cancel</button>'+"</p>"+"</div>"+"</div>"+'<!--i class="expand nomore"></i-->'+"</div>"+"</div>";this.invitation=ExfeUtilities.clone(e),this.panelId===n&&$(".exfeepanel").length||(this.panelId=n,this.editing="",this.pre_delete=!1,this.hideTip(),this.hidePanel(),this.objBody.append(a),this.bindEvents(),$(".exfeepanel").show()),this.showRsvp()},hideTip:function(){$(".tip-exfee").hide().remove()},hidePanel:function(){$(".exfeepanel").hide().remove()},showRsvp:function(){var e=this.invitation.by_identity?this.invitation.by_identity:curIdentity,t="",i=$(".exfee_pop_up .rsvp-info .setto i");switch(this.invitation.rsvp_status){case"ACCEPTED":t="DECLINED",i.toggleClass("icon-rsvp-accepted-blue",!1),i.toggleClass("icon-rsvp-declined-red",!0),i.toggleClass("icon-rsvp-noresponse",!1);break;case"DECLINED":t="NORESPONSE",i.toggleClass("icon-rsvp-accepted-blue",!1),i.toggleClass("icon-rsvp-declined-red",!1),i.toggleClass("icon-rsvp-noresponse",!0);break;case"NORESPONSE":case"IGNORED":default:t="ACCEPTED",i.toggleClass("icon-rsvp-accepted-blue",!0),i.toggleClass("icon-rsvp-declined-red",!1),i.toggleClass("icon-rsvp-noresponse",!1)}$(".exfee_pop_up .rsvp-info .setto").attr("rsvp",t),$(".exfee_pop_up .rsvp-info .attendance").html(this.arrRsvp[this.invitation.rsvp_status][0]);for(var n=1;10>n;n++)$(".exfee_pop_up .avatar-name .lt").toggleClass("icon10-plus-"+n,this.invitation.mates===n);switch($(".exfee_pop_up .rsvp-info .by .name").html(e?e.name:""),$(".exfee_pop_up .invited .mates-num").html("+"+this.invitation.mates),$(".exfee_pop_up .mates-edit .num").html(this.invitation.mates),e&&this.invitation.identity.id!==e.id&&"rsvp"===this.editing?$(".exfee_pop_up .rsvp-info .by").show():$(".exfee_pop_up .rsvp-info .by").hide(),this.editing){case"rsvp":$(".exfee_pop_up .rsvp-info").show(),$(".exfee_pop_up .rsvp-info .setto").show(),$(".exfee_pop_up .invited").hide();break;case"mates":$(".exfee_pop_up .rsvp-info").hide(),$(".exfee_pop_up .invited").show(),$(".exfee_pop_up .invited .together-with").show(),this.invitation.mates?($(".exfee_pop_up .mates-edit").show(),$(".exfee_pop_up .invited .mates-info").hide()):($(".exfee_pop_up .mates-edit").hide(),$(".exfee_pop_up .invited .mates-info").show()),$(".exfee_pop_up .invited .mates-num").hide();break;default:$(".exfee_pop_up .rsvp-info").show(),$(".exfee_pop_up .rsvp-info .setto").hide(),$(".exfee_pop_up .invited").show(),$(".exfee_pop_up .mates-edit").hide(),$(".exfee_pop_up .invited .together-with").hide(),this.invitation.mates?($(".exfee_pop_up .invited .mates-num").show(),$(".exfee_pop_up .invited .mates-info").hide()):($(".exfee_pop_up .invited .mates-num").hide(),readOnly?$(".exfee_pop_up .invited .mates-info").hide():$(".exfee_pop_up .invited .mates-info").show())}this.invitation.host?($(".exfee_pop_up .identities-list .delete i").hide(),$(".exfee_pop_up .identities-list .delete button").hide(),$(".exfee_pop_up .identity-actions").hide()):this.pre_delete?($(".exfee_pop_up .identities-list .delete i").hide(),$(".exfee_pop_up .identities-list .delete button").show(),curIdentity&&this.invitation.identity.id===curIdentity.id?($(".exfee_pop_up .identity-actions").show(),$(".exfee_pop_up .identities-list .btn-leave").html("Leave")):($(".exfee_pop_up .identity-actions").hide(),$(".exfee_pop_up .identities-list .btn-leave").html("Remove"))):($(".exfee_pop_up .identities-list .delete i").show(),$(".exfee_pop_up .identities-list .delete button").hide(),$(".exfee_pop_up .identity-actions").hide())},bindEvents:function(){$(".exfee_pop_up .mates-add").bind("click",this.matesAdd),$(".exfee_pop_up .mates-minus").bind("click",this.matesMinus),$(".exfee_pop_up .rsvp-info .setto").bind("click",this.rsvp),$(".exfee_pop_up .invited").bind("hover",function(e){if(!readOnly){switch(e.type){case"mouseenter":ExfeePanel.editing="mates";break;case"mouseleave":ExfeePanel.editing=""}ExfeePanel.showRsvp()}}),$(".exfee_pop_up .rsvp-info").bind("hover",function(e){switch(e.type){case"mouseenter":ExfeePanel.editing="rsvp";break;case"mouseleave":ExfeePanel.editing=""}ExfeePanel.showRsvp()}),$(".exfee_pop_up .identities-list .delete i").bind("click",function(e){e.stopPropagation(),ExfeePanel.pre_delete=!0,ExfeePanel.showRsvp()}),$(".exfee_pop_up .identities-list .delete button").bind("click",function(){ExfeeWidget.delExfee(ExfeePanel.invitation.identity),ExfeePanel.hidePanel()}),$(".exfee_pop_up .identity-actions .btn-cancel").bind("click",function(){ExfeePanel.pre_delete=!1,ExfeePanel.showRsvp()}),$(".exfee_pop_up").bind("click",function(){ExfeePanel.pre_delete=!1,ExfeePanel.showRsvp()}),$(".exfee_pop_up").on("click","span.avatar > img",function(){window.open($(this).attr("src").replace(/\/(80_80)_/,"/original_"))}).on("mouseleave",function(){$(this).hide(144,function(){ExfeePanel.hidePanel()})})},matesAdd:function(){9>ExfeePanel.invitation.mates&&(ExfeeWidget.changeMates(ExfeePanel.invitation.identity,++ExfeePanel.invitation.mates),ExfeePanel.showRsvp())},matesMinus:function(){ExfeePanel.invitation.mates>0&&(ExfeeWidget.changeMates(ExfeePanel.invitation.identity,--ExfeePanel.invitation.mates),ExfeePanel.showRsvp())},rsvp:function(){var e=$(this).attr("rsvp");e&&(ExfeePanel.invitation.rsvp_status=e,ExfeePanel.invitation.by_identity=ExfeUtilities.clone(curIdentity),ExfeeWidget.rsvpExfee(ExfeePanel.invitation.identity,e),ExfeePanel.showRsvp())}}}),define(function(e){var t=e("jquery"),i=[],n={title:"",description:"",by_identity:{id:0},time:{begin_at:{date_word:"",date:"",time_word:"",time:"",timezone:"",id:0,type:"EFTime"},origin:"",outputformat:1,id:0,type:"CrossTime"},place:{title:"",description:"",lng:"",lat:"",provider:"",external_id:"",id:0,type:"Place"},attribute:{state:"published"},exfee_id:0,widget:[{image:"",widget_id:0,id:0,type:"Background"}],relative:{id:0,relation:""},type:"Cross"},a={id:0,type:"Exfee",invitations:[]},r=!1,s=function(e){Cross.id&&(t(".cross-opts .saving").show(),Api.request("editExfee",{type:"POST",resources:{exfee_id:Exfee.id},data:{by_identity_id:curIdentity.id,exfee:JSON.stringify(Exfee)}},function(){t(".cross-opts .saving").hide(),e?window.location.href="/":V.emit("app:cross:edited")},function(e){t(".cross-opts .saving").hide();var i=!e.meta||401!==e.meta.code&&403!==e.meta.code?"":"no_permission";V.emit("app:cross:edited",{error:i})}).always(function(){ExfeeWidget.showLimitWarning(ExfeeWidget.summary().items>ExfeeWidget.soft_limit)}))},o=function(e){if(T(),s(e),r){for(var t,i,n="·X· ",a=3,o=[],l=0;(t=Exfee.invitations[l++])&&(i=t.identity)&&("REMOVED"!==t.rsvp_status&&a--&&o.push(i.name),0!=a););n+=o.join(", "),y(n)}},l=function(){ExfeeCache.init(),ExfeeWidget.api_url=window._ENV_.api_url,window.GatherExfeeWidget=ExfeeWidget.make("gather-exfee",!0,o),window.CrossExfeeWidget=ExfeeWidget.make("cross-exfee",!0,o)},c=function(e){if(e){var i={by_identity_id:curIdentity.id,content:e.substr(0,233),id:0,relative:[],type:"Post",via:"exfe.com"};t(".cross-opts .saving").show(),Api.request("addConversation",{resources:{exfee_id:Exfee.id},type:"POST",data:JSON.stringify(i)},function(e){S=e.post.created_at,t(".cross-opts .saving").hide(),D(e.post),V.emit("app:cross:edited")},function(e){t(".cross-opts .saving").hide();var i=!e.meta||401!==e.meta.code&&403!==e.meta.code?"":"no_permission";V.emit("app:cross:edited",{error:i})})}},d=function(){t("#cross-form-discard").bind("click",function(){window.location="/"}),t("#cross-form-gather").bind("click",function(){if(curIdentity){if(JSON.stringify(InitCross)===JSON.stringify(Cross)&&1===Exfee.invitations.length)return!1;t(this).hasClass("disabled")||(t(this).prop("disabled",!0).toggleClass("disabled",!0),B())}else{var e=t.trim(t("#gather-title").val());0===e.length?(t(".choose-identity .placeholder").addClass("text-error"),t(".add-identity").addClass("hide"),t(".please-identity").removeClass("hide")):t(".choose-identity .placeholder").trigger("click")}}),t(".cross-conversation .comment-form .pointer").bind("click",function(){var e=t(".cross-conversation .comment-form textarea");c(e.val()),e.val("")}),t(".cross-conversation .comment-form textarea").bind("keydown",function(e){switch(e.which){case 13:var i=t(this);e.shiftKey||(e.preventDefault(),c(i.val()),i.val(""))}})},u=function(){var e=t("#gather-title");e.on("focus keydown keyup blur",function(t){"keydown"===t.type&&(r=!1),y(e.val(),"gather")})},h=function(i){if(t(".cross-container").length&&!readOnly){var n=Editing,a=i?i.target:null,r={title:[function(){t(".cross-title").removeAttr("editable"),t(".cross-title .show").show(),y(t(".cross-title .edit").val(),"cross"),t(".cross-title .edit").hide(),Y()},function(){t(".cross-title").attr("editable",!0),t(".cross-title .show").hide(),t(".cross-title .edit").show().focus()}],description:[function(){t(".cross-description-outer").removeAttr("editable"),t(".cross-description .show").show(),t(".cross-description .edit").hide(),_(t(".cross-description .edit").val()),Y()},function(){t(".cross-description-outer").attr("editable",!0),t(".cross-description .show").hide(),t(".cross-description .xbtn-more").hide(),t(".cross-description .edit").show().focus()}],time:[function(){var e=t("#date-panel");if(e.size()){var i=e.data("widget-id"),a=App.widgetCaches[i];t.trim(t("#date-string").data("date")),("date-panel"===n||"time"===n)&&Y(),a&&a.hide()}t(".cross-date").removeAttr("editable")},function(){var i=t("#date-panel");if(!i.size()){var n=e("datepanel"),a=new n({options:{parentNode:t("#app-tmp"),srcNode:t(".cross-date"),eftime:Cross.time}});a.show(),t(".cross-date").attr("editable",!0)}}],place:[function(){t(".cross-place").removeAttr("editable");var e=t("#map-panel");if(e.size()){var i=e.data("widget-id"),a=App.widgetCaches[i];("map-panel"===n||"place"===n)&&(Cross.place=a.place,Y()),a&&a.hide()}},function(){var i=t("#map-panel");if(!i.size()){var n=e("mappanel"),a=new n({options:{parentNode:t("#app-tmp"),srcNode:t(".cross-place"),place:Cross.place},update:function(e){E(e),P(e)}});a.show(),t(".cross-place").attr("editable",!0)}}],rsvp:[function(){I()},function(){I(!0)}],background:[function(){},function(){!i||"dblclick"!==i.type||!n&&Cross.id||g(i?i.shiftKey:!1)}],exfee:[function(){t("#cross-exfee .exfee-input").val()||(t("#cross-exfee .total").css("visibility","hidden"),t("#cross-exfee .thumbnails .avatar .rb").hide()),t("#gather-exfee .exfee-input").val()||t("#gather-exfee .thumbnails .avatar .rb").hide()},function(){}]};if(i){var s=t(a).attr("editarea");switch(s){case"rsvp":case"exfee":Editing=s}if("click"===i.type||"dblclick"===i.type&&"background"===s)for(Editing=s;a&&!Editing&&"BODY"!==a.tagName;)a=a.parentNode,Editing=t(a).attr("editarea");else Editing=""}if("background"===Editing)r.background[1](),Editing=n;else{if("map-panel"===Editing)return;if("date-panel"===Editing)return;for(var o in r)r[o][~~(o===Editing)]()}}},p=function(){t("body").on("click save-cross",h),t("body").on("click.data-link","[editarea]",h),t("body").on("dblclick.data-link",'[editarea="background"]',h),t(".cross-title .edit").bind("focus keydown keyup blur",function(e){if("keydown"===e.type)switch(r=!1,e.which){case 13:e.shiftKey||(e.preventDefault(),h())}y(t(e.target).val(),"cross")}),t(".cross-title, .cross-description-outer, .cross-date, .cross-place").bind("hover",function(e){var i=e.type;Editing&&"rsvp"!==Editing&&("mouseenter"!==i||t(this).attr("editable")?t(this).removeClass("cross-hover"):t(this).addClass("cross-hover"))});var e=0;t(".cross-description").bind("mousedown mouseup",function(t){"mousedown"===t.type?e=t.clientX+t.clientY:e-=t.clientX+t.clientY}),t(".cross-description").bind("click",function(){if(!Editing&&!e){e=0;var i=t(this),n=!i.hasClass("more");i.toggleClass("more",n).find(".xbtn-more").toggleClass("xbtn-less",n)}}),t(".cross-description .xbtn-more").bind("click",function(e){e.stopPropagation();var i=!t(this).hasClass("xbtn-less");t(".cross-description").toggleClass("more",i),t(this).toggleClass("xbtn-less",i)}),t(".cross-description .editing").on("keydown",function(e){var i=e.keyCode;switch(i){case 27:t(this).val(Cross.description),t("body").trigger("save-cross");break;case 13:(e.ctrlKey||e.metaKey)&&(e.preventDefault(),t("body").trigger("save-cross"))}}),t(".cross-rsvp").bind("mouseenter mouseover mouseleave",function(e){if(!readOnly)switch(e.type){case"mouseenter":case"mouseover":t(".cross-rsvp .show .accepted").hide(),t(".cross-rsvp .show .change").show(),t(".cross-rsvp .show .by strong").html()&&t(".cross-rsvp .show .by").show();break;case"mouseleave":t(".cross-rsvp .show .accepted").show(),t(".cross-rsvp .show .change").hide(),t(".cross-rsvp .show .by").hide()}}),t(".cross-rsvp .edit .accept").bind("click",function(){ExfeeWidget.rsvpMe("ACCEPTED"),I()}),t(".cross-rsvp .edit .decline").bind("click",function(){ExfeeWidget.rsvpMe("DECLINED"),I()}),t(".cross-rsvp .edit .interested").bind("click",function(){ExfeeWidget.rsvpMe("INTERESTED"),I()}),t(".cross-place .edit").bind("keydown",function(e){e.shiftKey&&13===e.which&&(e.which=4)}),t(".cross-place .xbtn-more").bind("click",function(e){e.stopPropagation();var i=!t(this).hasClass("xbtn-less");t(".cross-dp.cross-place > address").toggleClass("more",i),t(this).toggleClass("xbtn-less",i)}),t(".ids-popmenu > ol > li").live("mouseenter mousedown",function(e){switch(e.type){case"mouseenter":ExfeeWidget.selectCompleteItem(t(this).index());break;case"mousedown":ExfeeWidget.useCompleteItem(t(this).index()),t(".exfee-input").val("")}})},f=function(){Cross.title.length||(Cross.title="·X· "+(curIdentity?curIdentity.name:""))},m=function(){var e=new Date,i=G.formatDate(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate());Cross.time={begin_at:{date_word:"",date:i,time_word:"",time:"",timezone:ExfeUtilities.getTimezone(),id:0,type:"EFTime"},origin:i,outputformat:0,id:0,type:"CrossTime"},t(".cross-date .edit").val(i)
},g=function(e){var t=ExfeUtilities.clone(window._ENV_.backgrounds);t.push("");for(var i=0;Cross.widget.length>i&&"Background"!==Cross.widget[i].type;i++);if(e)Cross.widget[i].image="";else{var n=Cross.widget[i].image;do Cross.widget[i].image=t[parseInt(Math.random()*t.length)];while(n===Cross.widget[i].image)}M()},v=function(){ExfeeWidget.addExfee(curIdentity,!0,"ACCEPTED")},y=function(e,t){Cross.title=ExfeUtilities.trim(e),x(t)},_=function(e){Cross.description=ExfeUtilities.trim(e),w()},b=function(){curIdentity&&t(".choose-identity").html('<img src="'+curIdentity.avatar_filename+'">')},x=function(e){Cross.title.length&&t(".choose-identity .placeholder").hasClass("text-error")&&(t(".choose-identity .placeholder").removeClass("text-error"),t(".add-identity").removeClass("hide"),t(".please-identity").addClass("hide"));var i=Cross.title.length?ExfeUtilities.escape(Cross.title):"Gathering for what?";switch(t(".cross-title .show").html(i),t(".cross-title").removeClass("single-line").removeClass("double-line"),t(".cross-title h1").height()>50?t(".cross-title").addClass("double-line").removeClass("single-line"):t(".cross-title").addClass("single-line").removeClass("double-line"),document.title="EXFE - "+Cross.title,e){case"gather":t(".cross-title .edit").val(Cross.title);break;case"cross":t("#gather-title").val(Cross.title);break;default:t(".cross-title .edit").val(Cross.title),t("#gather-title").val(Cross.title)}},w=function(){var e=t(".cross-description .xbtn-more").hasClass("xbtn-less"),i="";t(".cross-description").toggleClass("more",!0),t(".cross-description .xbtn-more").toggleClass("xbtn-less",!1),Cross.description?(i=ExfeUtilities.escape(Cross.description).replace(/\r\n|\r|\n/g,"<br>"),t(".cross-description .show").toggleClass("gray",!1).toggleClass("gsd",!1)):(i="Take some notes here.",t(".cross-description .show").toggleClass("gray",!0).toggleClass("gsd",!Cross.id)),t(".cross-description .show").html()!==i&&t(".cross-description .show").html(i),t(".cross-description .show").height()>180?(t(".cross-description").toggleClass("more",!1),t(".cross-description .xbtn-more").show(),e&&(t(".cross-description").toggleClass("more",!0),t(".cross-description .xbtn-more").toggleClass("xbtn-less",!0))):t(".cross-description .xbtn-more").hide(),t(".cross-description .edit").val(Cross.description),Editing&&"rsvp"!==Editing||Cross.description||!Cross.id?t(".cross-description").show():t(".cross-description").hide()},k=function(){C(),N()},C=function(){function e(e){if(e=ExfeUtilities.trim(e)){var t=e.split(":");if(2===t.length){var i=60*60*parseInt(t[0],10),n=60*parseInt(t[1],10);return i+(i>0?n:-n)}}return null}var i=e(Cross.time.begin_at.timezone),n=e(ExfeUtilities.getTimezone()),a=(i===n&&window._ENV_.timevalid,""),r="",s="Pick a time.",o=!1;if(Cross.time.origin){var l=G.printEFTime(Cross.time,"X");a=l.content,r=l.title}else a=s,r="Sometime",o=!0;t(".cross-date h2").html(r),t(".cross-time").html(a).toggleClass("gray",o)},E=function(e){t(".cross-dp.cross-place > h2").html(e.title?ExfeUtilities.escape(e.title):"Somewhere"),t(".cross-dp.cross-place > address").toggleClass("more",!0),t(".cross-dp.cross-place .xbtn-more").toggleClass("xbtn-less",!1),e.description?t(".cross-dp.cross-place > address").html(ExfeUtilities.escape(e.description).replace(/\r\n|\r|\n/g,"<br>")).toggleClass("gray",!1):t(".cross-dp.cross-place > address").html("Choose a place.").toggleClass("gray",!0),t(".cross-dp.cross-place > address").height()>80?(t(".cross-dp.cross-place > address").toggleClass("more",!1),t(".cross-dp.cross-place .xbtn-more").show()):t(".cross-dp.cross-place .xbtn-more").hide(),t(".cross-dp.cross-place > address").css("display","block"),e.description||e.title?!e.description&&e.title&&t(".cross-dp.cross-place > address").css("display","none"):t(".cross-dp.cross-place > address").text("Choose a place.").css("display","block")},T=function(){window.GatherExfeeWidget.showAll(!0),window.CrossExfeeWidget.showAll(!1,!0)},M=function(){for(var e=0;Cross.widget.length>e&&"Background"!==Cross.widget[e].type;e++);t(".x-gather").toggleClass("no-bg",!1),t(".cross-background").css("background-image","url(/static/img/xbg/"+(Cross.widget[e].image?Cross.widget[e].image:"default.jpg")+")")},S="",$={},A=function(e,t){i=e;for(var n=i.length-1;n>=0;n--)n||(S=i[n].created_at),D(i[n],t)},D=function(e,i){if(void 0===$[e.id]){$[e.id]=!0;var n=ExfeUtilities.escape(e.content).replace(/\r\n|\n\r|\r|\n/g,"\n"),a='<div class="avatar-comment"><span class="pull-left avatar"><img alt="" src="'+e.by_identity.avatar_filename+'" width="40" height="40" />'+"</span>"+'<div class="comment">'+"<p>"+'<span class="author"><strong>'+e.by_identity.name+"</strong>:&nbsp;</span>"+ExfeUtilities.escape(e.content).replace(/\r\n|\n\r|\r|\n/g,"<br>")+'<span class="pull-right date">'+'<time data-iso-time="'+G.toISO(e.created_at)+'"></time>'+"</span>"+"</p>"+"</div>"+"</div>";t(".conversation-timeline").prepend(a),i&&window.webkitNotifications&&0===window.webkitNotifications.checkPermission()&&window.webkitNotifications.createNotification(null,"EXFE - "+Cross.title,e.by_identity.name+": "+n).show()}},N=function(){t("time[data-iso-time]").each(function(){var e=t(this);e.text(G(e.data("iso-time")))})},I=function(e){var i=ExfeeWidget.getMyInvitation();if(i){var n=i.by_identity?i.by_identity:curIdentity,a=i.identity.id===n.id;if("NORESPONSE"===i.rsvp_status||"IGNORED"===i.rsvp_status||e)return a?t(".cross-rsvp .edit .by").hide():(t(".cross-rsvp .edit .by .avatar img").attr("src",i.by_identity.avatar_filename),t(".cross-rsvp .edit .by strong").html(i.by_identity.name),t(".cross-rsvp .edit .by").show()),t(".cross-rsvp .show").hide(),t(".cross-rsvp .edit").fadeIn(233),void 0;if("ACCEPTED"===i.rsvp_status||"INTERESTED"===i.rsvp_status||"DECLINED"===i.rsvp_status){var r="";switch(i.rsvp_status){case"ACCEPTED":r="Accepted";break;case"DECLINED":r="Unavailable";break;case"INTERESTED":r="Interested"}a||"INTERESTED"===i.rsvp_status?(t(".cross-rsvp .show .by").hide(),t(".cross-rsvp .show .by strong").html("")):(t(".cross-rsvp .show .by .avatar img").attr("src",i.by_identity.avatar_filename),t(".cross-rsvp .show .by strong").html(i.by_identity.name),t(".cross-rsvp .show .by").show());for(var s=ExfeeWidget.summary(),o="",l=0;Math.min(s.accepted_invitations.length,5)>l;l++)o+='<li><span class="avatar alt40"><img height="20" width="20" alt="" src="'+s.accepted_invitations[l].identity.avatar_filename+'">'+(s.accepted_invitations[l].mates?'<i class="icon10-plus-'+s.accepted_invitations[l].mates+'"></i>':"")+"</span></li>";o+=s.accepted?"<li><span>"+s.accepted+" accepted.</span></li>":"";var c=t(".cross-rsvp .show .accepted");return c.text()!==t(o).text()&&c.html(o),t(".cross-rsvp .show .by").hide(),t(".cross-rsvp .show .change").hide(),t(".cross-rsvp .show .attendance").html(r),t(".cross-rsvp .show").fadeIn(233),t(".cross-rsvp .edit").hide(),void 0}}t(".cross-rsvp .show").hide(),t(".cross-rsvp .edit").hide()},P=function(e){function i(i){var n=i.coords;a=a.replace(/\{\{lat\}\}/gi,n.latitude).replace(/\{\{lng\}\}/gi,n.longitude).replace(/\{\{title\}\}/gi,(""===e.provider?n.latitude+","+n.longitude+" ":"")+encodeURIComponent(e.title)),t(".cross-map").append(a)}t(".cross-map").empty();var n=e.lat.length&&e.lng.length,a='<a target="_blank" href="https://maps.google.com/maps?key='+_ENV_.MAP_KEY+'&q={{title}}&hl=en&ie=UTF8&sll={{lat}},{{lng}}&t=m&z=16"><img class="gm0" src="https://maps.googleapis.com/maps/api/staticmap?scale=2&center={{lat}},{{lng}}&markers=scale:2|icon%3a'+encodeURIComponent("http://img.exfe.com/web/map_mark_diamond_blue@2x.png")+'%7C{{lat}},{{lng}}&zoom=13&size=280x200&maptype=road&sensor=false" alt="" width="280" height="200" /><img  class="gm1" src="https://maps.googleapis.com/maps/api/staticmap?scale=2&center={{lat}},{{lng}}&markers=scale:2|icon%3a'+encodeURIComponent("http://img.exfe.com/web/map_mark_diamond_blue@2x.png")+'%7C{{lat}},{{lng}}&zoom=13&size=280x140&maptype=road&sensor=false" alt="" width="280" height="140" /></a>';n&&i({coords:{latitude:e.lat,longitude:e.lng}})},L=function(){x(),w(),E(Cross.place),T(),M(),I(),P(Cross.place)},O=function(e){var t={resources:{exfee_id:Exfee.id}};S&&(t.params={updated_at:S}),Api.request("conversation",t,function(t){A(t.conversation,e)})},z=function(){O(!0)},H=function(){t("#conversation-form span.avatar img").attr("src",curIdentity.avatar_filename),t("#conversation-form").show(),t(".conversation-timeline").html(""),t(".cross-conversation").slideDown(233),S="",$={},O(),convTimer=setInterval(z,233e3)},F=function(e,i){Cross.id=e.id,Cross.title=e.title,Cross.description=e.description,Cross.time=e.time,Cross.place=e.place,Cross.widget=e.widget,Cross.exfee_id=e.exfee.id,Exfee=e.exfee,readOnly=i,K=W(),void 0===Cross.time||void 0===Cross.time.begin_at||Cross.time.begin_at.timezone||(Cross.time.begin_at.timezone=ExfeUtilities.getTimezone()),t(".cross-date  .edit").val(Cross.time.origin),t(".cross-place .edit").val(Cross.place.title+(Cross.place.description?"\n"+Cross.place.description:""));for(var n=0;Exfee.invitations.length>n;n++)if(ExfeeWidget.isMyIdentity(Exfee.invitations[n].identity)){curIdentity=ExfeUtilities.clone(Exfee.invitations[n].identity);break}L(),H()},j=function(e){Api.request("getCross",{resources:{cross_id:e}},function(e){F(e.cross,!1)},function(){V.emit("app:cross:forbidden",e)})},R=function(){window.Cross=ExfeUtilities.clone(n),window.Exfee=ExfeUtilities.clone(a)},q=function(){r=!0,readOnly=!1,R(),g(),f(),m(),v(),L(),X()},B=function(){var e=ExfeUtilities.clone(Cross);e.exfee=ExfeUtilities.clone(Exfee),e.by_identity={id:curIdentity.id},Api.request("gather",{type:"POST",data:JSON.stringify(e),beforeSend:function(){t(".cross-opts .saving").show()},complete:function(){t(".cross-opts .saving").hide()}},function(e){document.location="/#!"+e.cross.id},function(){t("#cross-form-gather").prop("disabled",!1).toggleClass("disabled",!1)})},U=function(){t(".cross-opts .saving").show();var e=ExfeUtilities.clone(Cross);e.by_identity={id:curIdentity.id},Api.request("editCross",{type:"POST",resources:{cross_id:Cross.id},data:JSON.stringify(e)},function(){t(".cross-opts .saving").hide(),V.emit("app:cross:edited")},function(e){t(".cross-opts .saving").hide();var i=!e.meta||401!==e.meta.code&&403!==e.meta.code?"":"no_permission";V.emit("app:cross:edited",{error:i})})},W=function(){return JSON.stringify({id:Cross.id,title:Cross.title,description:Cross.description,time:Cross.time.origin+", "+Cross.time.begin_at.date+", "+Cross.time.begin_at.time,place:{title:Cross.place.title,description:Cross.place.description,lat:Cross.place.lat,lng:Cross.place.lng,updated_at:Cross.place.updated_at},background:Cross.widget[0].image})},Y=function(){if(Cross.id){var e=W();K!==e&&(U(),K=e)}},X=function(e){e?(t(".cross-form").slideUp(233),t(".cross-edit").show(233)):(b(),t("#gather").addClass("gathering-x"),t(".cross-form").slideDown(233),t(".cross-edit").hide(233),t("#gather-title").select(),t("#gather-title").focus())};window.Store=e("store"),window.Api=e("api"),window.webkitNotifications&&window.webkitNotifications.requestPermission(function(){});var G=e("humantime");window.curIdentity=null,window.readOnly=!1;var V=e("bus"),K="";V.on("xapp:cross:main",function(){var t=Store.get("authorization");window.User=t?Store.get("user"):null,User&&(Api.setToken(t.token),curIdentity=ExfeUtilities.clone(User.identities[0])),R(),l(),d(),u(),Editing="",p(),Marked=e("marked"),window.ExfeePanel=e("exfeepanel"),window.showtimeTimer=setInterval(k,50),window.convTimer=null}),V.on("xapp:cross",function(e,t,i,n,a,r){if(e>0)j(e);else if(null===e)switch(t&&(curIdentity=t,Api.setToken(a)),F(i,n),r){case"accept":ExfeeWidget.rsvpMe("ACCEPTED"),I();break;case"decline":ExfeeWidget.rsvpMe("DECLINED"),I()}else q(),window.InitCross=ExfeUtilities.clone(Cross)}),V.on("app:user:signin:after",function(){if(window.Cross&&!window.Cross.id){var e=Store.get("authorization");window.User=e?Store.get("user"):null,User&&(Api.setToken(e.token),curIdentity=ExfeUtilities.clone(User.identities[0]),b(),v())}}),V.on("xapp:cross:end",function(){clearTimeout(window.showtimeTimer),clearTimeout(window.convTimer)}),t(document.body).on("hover","div.lock-tag",function(e){var i=e.type,n=t(this).offset();"mouseenter"===i?t('<div class="tooltip tip-lock" id="app-tip-lock"><div class="inner"><div>This <span class="x">·X·</span> is private.</div><div>Accessible to only attendees.</div></div></div>').css({left:n.left-135,top:n.top+25}).appendTo(document.body):t("#app-tip-lock").remove()})});var MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function i(e,t){var i,n,a,r,s;return a=2147483648&e,r=2147483648&t,i=1073741824&e,n=1073741824&t,s=(1073741823&e)+(1073741823&t),i&n?2147483648^s^a^r:i|n?1073741824&s?3221225472^s^a^r:1073741824^s^a^r:s^a^r}function n(e,t,i){return e&t|~e&i}function a(e,t,i){return e&i|t&~i}function r(e,t,i){return e^t^i}function s(e,t,i){return t^(e|~i)}function o(e,a,r,s,o,l,c){return e=i(e,i(i(n(a,r,s),o),c)),i(t(e,l),a)}function l(e,n,r,s,o,l,c){return e=i(e,i(i(a(n,r,s),o),c)),i(t(e,l),n)}function c(e,n,a,s,o,l,c){return e=i(e,i(i(r(n,a,s),o),c)),i(t(e,l),n)}function d(e,n,a,r,o,l,c){return e=i(e,i(i(s(n,a,r),o),c)),i(t(e,l),n)}function u(e){for(var t,i=e.length,n=i+8,a=(n-n%64)/64,r=16*(a+1),s=Array(r-1),o=0,l=0;i>l;)t=(l-l%4)/4,o=8*(l%4),s[t]=s[t]|e.charCodeAt(l)<<o,l++;return t=(l-l%4)/4,o=8*(l%4),s[t]=s[t]|128<<o,s[r-2]=i<<3,s[r-1]=i>>>29,s}function h(e){var t,i,n="",a="";for(i=0;3>=i;i++)t=255&e>>>8*i,a="0"+t.toString(16),n+=a.substr(a.length-2,2);return n}function p(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;e.length>i;i++){var n=e.charCodeAt(i);128>n?t+=String.fromCharCode(n):n>127&&2048>n?(t+=String.fromCharCode(192|n>>6),t+=String.fromCharCode(128|63&n)):(t+=String.fromCharCode(224|n>>12),t+=String.fromCharCode(128|63&n>>6),t+=String.fromCharCode(128|63&n))}return t}var f,m,g,v,y,_,b,x,w,k=[],C=7,E=12,T=17,M=22,S=5,$=9,A=14,D=20,N=4,I=11,P=16,L=23,O=6,z=10,H=15,F=21;for(e=p(e),k=u(e),_=1732584193,b=4023233417,x=2562383102,w=271733878,f=0;k.length>f;f+=16)m=_,g=b,v=x,y=w,_=o(_,b,x,w,k[f+0],C,3614090360),w=o(w,_,b,x,k[f+1],E,3905402710),x=o(x,w,_,b,k[f+2],T,606105819),b=o(b,x,w,_,k[f+3],M,3250441966),_=o(_,b,x,w,k[f+4],C,4118548399),w=o(w,_,b,x,k[f+5],E,1200080426),x=o(x,w,_,b,k[f+6],T,2821735955),b=o(b,x,w,_,k[f+7],M,4249261313),_=o(_,b,x,w,k[f+8],C,1770035416),w=o(w,_,b,x,k[f+9],E,2336552879),x=o(x,w,_,b,k[f+10],T,4294925233),b=o(b,x,w,_,k[f+11],M,2304563134),_=o(_,b,x,w,k[f+12],C,1804603682),w=o(w,_,b,x,k[f+13],E,4254626195),x=o(x,w,_,b,k[f+14],T,2792965006),b=o(b,x,w,_,k[f+15],M,1236535329),_=l(_,b,x,w,k[f+1],S,4129170786),w=l(w,_,b,x,k[f+6],$,3225465664),x=l(x,w,_,b,k[f+11],A,643717713),b=l(b,x,w,_,k[f+0],D,3921069994),_=l(_,b,x,w,k[f+5],S,3593408605),w=l(w,_,b,x,k[f+10],$,38016083),x=l(x,w,_,b,k[f+15],A,3634488961),b=l(b,x,w,_,k[f+4],D,3889429448),_=l(_,b,x,w,k[f+9],S,568446438),w=l(w,_,b,x,k[f+14],$,3275163606),x=l(x,w,_,b,k[f+3],A,4107603335),b=l(b,x,w,_,k[f+8],D,1163531501),_=l(_,b,x,w,k[f+13],S,2850285829),w=l(w,_,b,x,k[f+2],$,4243563512),x=l(x,w,_,b,k[f+7],A,1735328473),b=l(b,x,w,_,k[f+12],D,2368359562),_=c(_,b,x,w,k[f+5],N,4294588738),w=c(w,_,b,x,k[f+8],I,2272392833),x=c(x,w,_,b,k[f+11],P,1839030562),b=c(b,x,w,_,k[f+14],L,4259657740),_=c(_,b,x,w,k[f+1],N,2763975236),w=c(w,_,b,x,k[f+4],I,1272893353),x=c(x,w,_,b,k[f+7],P,4139469664),b=c(b,x,w,_,k[f+10],L,3200236656),_=c(_,b,x,w,k[f+13],N,681279174),w=c(w,_,b,x,k[f+0],I,3936430074),x=c(x,w,_,b,k[f+3],P,3572445317),b=c(b,x,w,_,k[f+6],L,76029189),_=c(_,b,x,w,k[f+9],N,3654602809),w=c(w,_,b,x,k[f+12],I,3873151461),x=c(x,w,_,b,k[f+15],P,530742520),b=c(b,x,w,_,k[f+2],L,3299628645),_=d(_,b,x,w,k[f+0],O,4096336452),w=d(w,_,b,x,k[f+7],z,1126891415),x=d(x,w,_,b,k[f+14],H,2878612391),b=d(b,x,w,_,k[f+5],F,4237533241),_=d(_,b,x,w,k[f+12],O,1700485571),w=d(w,_,b,x,k[f+3],z,2399980690),x=d(x,w,_,b,k[f+10],H,4293915773),b=d(b,x,w,_,k[f+1],F,2240044497),_=d(_,b,x,w,k[f+8],O,1873313359),w=d(w,_,b,x,k[f+15],z,4264355552),x=d(x,w,_,b,k[f+6],H,2734768916),b=d(b,x,w,_,k[f+13],F,1309151649),_=d(_,b,x,w,k[f+4],O,4149444226),w=d(w,_,b,x,k[f+11],z,3174756917),x=d(x,w,_,b,k[f+2],H,718787259),b=d(b,x,w,_,k[f+9],F,3951481745),_=i(_,m),b=i(b,g),x=i(x,v),w=i(w,y);var j=h(_)+h(b)+h(x)+h(w);return j.toLowerCase()};