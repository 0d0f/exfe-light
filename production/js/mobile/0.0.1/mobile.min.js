define(function(e){"use strict";function _(){return"Controller-"+M++}var t=e("base"),n=e("store"),r=e("handlebars"),i=e("humantime"),s=e("util"),o=s.trim,u=s.parseId,a=e("af"),f=a.request,l=a.cancel,c=e("tween"),h=e("config"),p=e("live"),d=function(){console.log.apply(console,arguments)},v=function(e){console.dir(e)},m=Date.now||function(){return(new Date).getTime()},g="webkitTransform"in document.body.style,y;g?y=function(e,t){var n=t.length===6?"":"3d";e.style.webkitTransform="matrix"+n+"("+t.join(",")+")"}:y=function(e,t){var n=t.length===6?"":"3d";e.style.transform="matrix"+n+"("+t.join(",")+")"};var b=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},w=function(e){var t=i.printEFTime(e,"X");return t},E=0,S=m(),x=function(){window.location="itms://itunes.apple.com/us/app/exfe/id514026604"},T=function(e){E=m(),window.location="exfe://crosses/"+(e||"")},N=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],C=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],k=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],L=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("sms-token")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},A={setHtmlHeight:function(e,t,n){setTimeout(function(){window.scrollTo(0,0)},0);var r=document.documentElement,i=r.style,s=window.innerHeight,o=e.app;s>=444?s=508:s<=356&&(s=420,o.ios="iphone4"),o.screen={width:320,height:s},v(o),d(o.ios),i.minHeight=s+"px",n()},checkStorageSupported:function(){try{var e=window.localStorage;e&&(e.setItem("storage",0),e.removeItem("storage"))}catch(t){alert("EXFE cannot be used in private browsing mode.")}next()},checkSMSToken:function(e,t,n){var r=L();if(r){var i=r.action;e.smsToken=r,"VERIFIED"===i?t.redirect("/#verify"):"INPUT_NEW_PASSWORD"===i&&t.redirect("/#set_password");return}n()},cleanup:function(e,t,n){delete e.smsToken,$("#app-header").addClass("hide"),$("#app-footer").removeClass("ft-bg");var r=e.switchPageCallback;r?r():$("#app-body .page").addClass("hide"),delete e.switchPageCallback,n()}},O={index:function(e,t){d("index `Home`");var n=e.error,r=e.app,i=r.controllers,s=i.home,o=i.footer,u=r.screen;s||(s=r.controllers.home=new j({options:{template:$("#home-tmpl").html()}})),s.emit("show",u),o.emit("show",u,!1,!1,n),delete e.error,r.currPageName="HOME"},verify:function(e,t){d("verify");var n=e.smsToken,r=e.app;if(n){$("#app-header").removeClass("hide");var i=new H({options:{template:$("#verify-tmpl").html()},smsToken:n});i.emit("show",e,t)}else e.error=!0,t.redirect("/");r.currPageName="VERIFY"},setPassword:function(e,t){d("set-password");var n=e.smsToken,r=e.app;if(n){$("#app-header").removeClass("hide");var i=new B({options:{template:$("#setpassword-tmpl").html()},smsToken:n,token:n.origin_token});i.emit("show",e,t)}else e.error=!0,t.redirect("/");r.currPageName="SET_PASSWORD"},resolveToken:function(e,t){d("`resolve token`");var n=e.app,r=e.params[0];r?$.ajax({type:"POST",url:h.api_url+"/Users/ResolveToken",data:{token:r},success:function(n){if(n&&n.meta&&n.meta.code===200){e.smsToken=response;var i=e.smsToken.action;i==="VERIFIED"?t.redirect("/#verify"):i==="INPUT_NEW_PASSWORD"&&(re.smsToken.origin_token=r,t.redirect("/#set_password"))}},error:function(){e.error=!0,t.redirect("/")}}):(e.error=!0,t.redirect("/")),n.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(e,t){d("cross `phone token`");var r=e.app,i=e.params,s=i[0],o=i[1];d("cross",s,o);var u=n.get("cats"),a,f,l;f={invitation_token:o,cross_id:s},u&&(l=u[o])&&(f.cross_access_token=l),showCross(e,t,f),r.currPageName="CROSS"},crossToken:function(e,t){d("cross `normal token`");var r=e.app,i=e.params[0],s=n.get("cats"),o={invitation_token:i},u;s&&(u=s[i])&&(o.cross_access_token=u),showCross(e,t,o),r.currPageName="CROSS"},showCross:function(t,i,s){$.ajax({type:"POST",url:h.api_url+"/Crosses/GetCrossByInvitationToken",data:s,success:function(e){var s=e.meta,o=s&&s.code;if(o&&o===200){var u=e.response,a=u.cross,f={id:a.id,title:b(a.title),description:b(a.description.replace(/\r\n|\r|\n/g,"<br />")),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!u.read_only},l=a.time;l&&l.begin_at&&l.begin_at.origin&&l.begin_at.timezone?f.time=w(l):f.time.tobe=!0;var c=a.place;c&&c.title&&(f.place={title:c.title,description:c.description.replace(/\r\n|\r|\n/g,"<br />")});var h=c.lat,p=c.lng;if(h&&p){var d=window.devicePixelRatio>=2?2:1;f.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+h+","+p+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+h+","+p+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+d,f.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(f.place.title)+"@"+h+","+p}var m=a.widget,g;if(m&&(g=m.length))for(var y=0;y<g;++y)if(m[y].type==="Background"){f.background=m[y].image;break}var E=0,S=0,x=u.authorization;x?(E=x.user_id,u.browsing_identity&&(S=u.browsing_identity.id)):u.browsing_identity&&u.browsing_identity.connected_user_id&&(E=u.browsing_identity.connected_user_id,S=u.browsing_identity.id),u.cross_access_token&&(token=cats[ctoken]=u.cross_access_token,n.set("cats",cats));var T=a.exfee.invitations,N=[],C={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]};for(var k=0,L=T.length;k<L;++k){var A=T[k],O="pending",M=A.rsvp_status;M==="ACCEPTED"?O="accepted":M==="DECLINED"&&(O="declined"),A.rsvp_style=O,E&&E===A.identity.connected_user_id||S===A.identity.id?(A.is_me=!0,S=A.identity.id,S!==A.invited_by.id&&(f.inviter=A.invited_by),A.isphone=A.provider==="phone",f.identity=A,C.ACCEPTED.unshift(A)):C[A.rsvp_status].push(A)}N=[].concat(C.ACCEPTED,C.INTERESTED,C.NORESPONSE,C.IGNORED,C.DECLINED),f.invitations=[];var _=0,L=N.length;while(_<L)f.invitations.push(N.splice(0,5)),_+=5;var L=f.invitations.length,D=f.invitations[L-1],P=D.length;if(P&&P<5)while(5-P++)D.push(void 0);var H="";E&&(x?(H=f.id+"?user_id="+E+"&token="+x.token+"&identity_id="+S,token=x.token,n.set("authorization",x)):(x=n.get("authorization"),x&&x.user_id===E&&(H=f.id+"?user_id="+E+"&token="+x.token+"&identity_id="+S,token=x.token))),v(f);var B=t.app,j=B.controllers,I=j.cross;I&&I.destory();var q=r.compile($("#cross-tmpl").html());I=B.controllers.cross=new F({options:{template:q(f)},cross:f,exfee_id:a.exfee.id,token:token}),I.emit("show"),B.controllers.footer.emit("show-from-cross",a.exfee.id,token,H)}else t.error=!0,i.redirect("/")},error:function(e){t.error=!0,i.redirect("/")}})},live:function(e,t){d("`live`");var n=e.app,r=n.controllers,i=r.live;i&&i.destory(),i=n.controllers.live=new I({options:{template:$("#live-tmpl").html()}}),i.emit("show",n.screen,n.ios),n.currPageName="LIVE"}},M=0,D=t.extend({initialize:function(e){this.cid=_(),this.initOptions(e),this.parseElement(),this.init(),D.caches[this.cid]=this},parseElement:function(){var e=this.element,t=this.options.template;e?this.element=e instanceof $?e:$(e):t&&(this.element=$(t));if(!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(e){this.setOptions(e);for(var t in e)t!=="options"&&(this[t]=e[t])},init:function(){},_destory:function(){this.element.off(),delete D.caches[this.cid],D.superclass.destory.call(this)},$:function(e){return this.element.find(e)}});D.caches=[];var P=D.extend(),H=D.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-verify").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.smsToken;this.on("show",function(n,r){var i=function(){n.error=!0,r.redirect("/")};this.element.removeClass("hide"),$.ajax({type:"POST",url:h.api_url+"/Users/"+t.user_id+"?token="+t.token,data:{token:t.token},success:function(n){if(n&&n.meta&&n.meta.code===200){var r=n.response.user,s=r.identities;for(var o=0,u=s.length;o<u;++o){var a=s[o];if(a.id===t.identity_id){e.showIdentity(a),redirecting("?user_id="+r.user_id+"&token="+result.token);return}}}i()},error:function(){i()}})})},showIdentity:function(e){var t=this.$(".identity");t.find(".name").text(e.name),t.find(".avatar").attr("src",e.avatar_filename),t.find(".provider").attr("src","/static/img/identity_"+e.provider+"_18_grey@2x.png"),t.next().removClass("hide")}}),B=D.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-setpassword").length||this.element.appendTo($("#app-body"))},submitPassword:function(){var e=this,t=this.token,n=this.$(".eye").addClass("hide"),r=this.$(".loading").removeClass("hide"),i=this.$(".set-button button"),s=this.$(".error-info"),u=o(this.$("#name").val()),a=this.$("#password").val();a.length>=4?(i.addClass("disabled").prop("disabled",!0),$.ajax({type:"POST",url:h.api_url+"/Users/ResetPassword",data:{token:t,name:u,password:a},success:function(e){r.addClass("hide"),n.removeClass("hide"),s.html("Failed to set password. Please try later.").removeClass("hide"),i.removeClass("disabled").prop("disabled",!1)},error:function(e){r.addClass("hide"),n.removeClass("hide"),s-info.html("Failed to set password. Please try later.").removeClass("hide"),i.removeClass("disabled").prop("disabled",!1)}})):(s.html("Password must be longer than four!").removeClass("hide"),r.addClass("hide"),n.removeClass("hide"))},listen:function(){var e=this,t=this.element,n=this.smsToken,r=this.token;t.on("touchstart.setpassword",".eye",function(){var e=$(this).prev();e.prop("type",function(e,t){return t==="password"?"text":"password"}),$(this).toggleClass("icon16-pass-hide icon16-pass-show")}).on("keydown.setpassword","#password",function(t){t.keyCode===13?e.submitPassword():e.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){e.submitPassword()}),this.on("show",function(e,r){var i=function(){e.error=!0,r.redirect("/")};t.removeClass("hide"),$.ajax({type:"POST",url:h.api_url+"/Users/"+n.user_id+"?token="+n.token,data:{token:n.token},success:function(e){var t=e.response.user;if(e&&e.meta&&e.meta.code===200){$(".identity .avatar").attr("src",t.avatar_filename),$(".identity .name").val(t.name);return}i()},error:function(){i()}})})}}),j=D.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-home").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element;t.on("touchstart.home","#home-card",function(t){clearInterval(z),clearInterval(U),z=U=void 0,e.stopAnimate(),e.emit("goto-live")}),this.on("goto-live",function(){R.controllers.footer.emit("stop-redirect"),R.request.switchPageCallback=function(){t.addClass("hide")},R.response.redirect("/#live")}),this.on("show",function(e){d(this.$("#home-card")[0]);var n=e.height;k[13]=(n-64)/2,this.$(".logo-box .inner").css("top",(n-300)/2+"px"),y(this.$("#home-card")[0],k),t.removeClass("hide"),this.startAnimate()})},aopts:{o:1},createAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),n=document.getElementById("home-card"),r=function(){t.style.opacity=e.o,n.style.opacity=1-e.o},i=this._a=(new c.Tween(e)).delay(1377).to({o:0},1377).easing(c.Easing.Cubic.InOut).onUpdate(r),s=this._b=(new c.Tween(e)).delay(1377).to({o:1},1377).easing(c.Easing.Cubic.InOut).onUpdate(r)},startAnimate:function(){!this._a&&!this._b&&this.createAnimate(),this._a.chain(this._b),this._b.chain(this._a),this._a.start()},stopAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),n=document.getElementById("home-card");this._a.chain(),this._b.chain(),this._b.stop(),this._a.stop(),e.o=t.style.opacity=1,n.style.opacity=0}}),F=D.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-cross").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element,n=this.token,r=this.cross,i=e.$(".rsvp_toolbar");t.on("touchstart.cross",".portrait.me",function(e){i.toggleClass("rsvp_toolbar_off",!i.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(t){var i=prompt("Change my display name:");i!==null&&(i===""?alert("Display name cannot be empty."):$.ajax({type:"POST",url:h.api_url+"/Identities/"+r.identity.id+"/Update"+"?token="+n,data:{name:i},success:function(t){t&&t.meta&&t.meta.code===200&&e.$(".name_me").html(b(t.response.identity.name))},error:function(){alert("Failed, please retry later.")}}))}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var t=$(this).hasClass("accepted")?"ACCEPTED":"DECLINED";e.rsvp(t)}).on("touchstart.cross",".inf_area .description",function(){var e=$(this),t=e.hasClass("clickable");if(t){var n=e.hasClass("limit");e.toggleClass("limit",!n),e.find(".xbtn-more .rb").toggleClass("hidden",n),e.find(".xbtn-more .lt").toggleClass("hidden",!n)}}),this.on("show",function(){t.removeClass("hide");var e=this.$(".inf_area .description");e.height()>130&&(e.addClass("limit clickable"),e.find(".xbtn-more").removeClass("hide"),e.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(e){var t=this.cross.identity.id,n=this.exfee_id,r=this.token,i=[{rsvp_status:e,identity_id:t,by_identity_id:t}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var s=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(e){case"ACCEPTED":s.addClass("accepted");break;case"DECLINED":s.addClass("declined");break;default:s.addClass("pending")}$.ajax({type:"post",url:h.api_url+"/Exfee/"+n+"/Rsvp?token="+r,data:{rsvp:JSON.stringify(i)},success:function(e){},error:function(){alert("RSVP failed!")}})}}),I=D.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-live").length?this.element=$("#app-live"):this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element,n;t.on("touchstart.live","#card-name",function(e){e.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus()}).on("touchstart.live",".live-form",function(e){e.stopPropagation(),$(e.target).hasClass("live-form")&&R.response.redirect("/")}).on("keydown.live","#card-name",function(t){var n=t.keyCode,r=o(this.value);r&&n===13&&e.addEmailOrPhone(this,r)}).on("blur.live","#card-name",function(t){var n=o(this.value);n?e.addEmailOrPhone(this,n):e.setCardName(this)}).on("keydown.live blur.live","#add-identity",function(t){var n=t.keyCode,r=o(this.value);if(r&&n===13||t.type==="blur")e.addEmailOrPhone(this,r,!0),this.value=""}).on("keydown.live blur.live","#facebook-identity",function(t){var n=t.keyCode,r=o(this.value);if(r&&n===13||t.type==="blur")r+="@facebook",e.addFacebook(this,r)&&$("#add-identity-facebook").addClass("hide"),this.value=""}).on("touchstart.live",".list .input-item",function(e){$(this).next().removeClass("hidden")}).on("blur.live",".list .input-item",function(e){$(this).next().addClass("hidden")}).on("touchstart.live",".list .delete",function(t){var n=$(this).prev()[0],r=o(n.value),i=n.getAttribute("data-provider"),s;i==="facebook"&&(r+="@facebook"),s=u(r),s&&s.provider&&($(this).parent().remove(),e.removeIdentity(s))}).on("touchstart.live",".btn-start",function(t){var n=this.disabled;n||(setTimeout(function(){$(".input-item").blur()},0),e.inspectFields()&&(e.emit("post-card"),e.emit("live-gather")))}).on("hold:live",".card .avatar",function(e){var t=this,n=t.parentNode,r=$(n).data("card"),i=n.style.transform||n.style.webkitTransform,s=i.match(/([\-\d\.]+)/g).slice(1),o=document.getElementById("card-tip"),u="";if(r&&r.identities){for(var a=0,f=r.identities.length;a<f;++a){var l=r.identities[a],c=l.provider,h=l.external_username,p="";c!=="email"&&c!=="phone"&&(c=c.substr(0,1).toUpperCase()+c.substr(1),p='<span class="provider">'+c+"</span>"),u+='<li><span class="external-username'+(p?"":" normal")+'">'+h+"</span>"+p+"</li>"}o.querySelector("ul").innerHTML=u;var d=o.clientHeight,v=~~s[12]-68,m=~~s[13]-(6+d),g=93;v<0?v=10:v+200>=320&&(v=110);if(v===10||v===110)g=~~s[12]+32-7-v;s[12]=v,s[13]=m,s[14]=7,y(o,s),o.querySelector(".ang").style.left=g+"px",o.querySelector(".bio").innerText=r.bio,o.className="card-tip"}}).on("touchstart.live",".card .avatar",function(e){var t=$(this),r=250,i=e.touches.length;n&&clearTimeout(n),i===1&&i>=1&&(n=setTimeout(function(){t.trigger("hold:live")},r))}).on("touchend.live",".card .avatar",function(e){n&&clearTimeout(n),document.getElementById("card-tip").className="card-tip hidden"}).on("touchstart.live",".back",function(){e.$(".live-gather").addClass("hide"),R.response.redirect("/")}),this.on("show-add-email",function(){this.$("#add-identity").removeClass("hide")}),this.on("show-add-facebook",function(){if(this.$('.list input[data-provider="facebook"]').length)return;this.$("#add-identity-facebook").removeClass("hide")}),this.on("show",function(e,t){this.screen=e,this.ios=t,alert(this.ios),$("#app-footer").addClass("hide"),this.element.removeClass("hide");var n=e.height;k[13]=(n-64)/2,y(this.$("#icard")[0],k),this.$(".live-form, .live-gahter").css("min-height",n),this.$(".live-form").removeClass("hide"),this.$("#live-discover").css("opacity",0),this.$("#card-form").css({opacity:0,"min-height":(n-100)/n*100+"%"}),this.$(".identities .list").empty(),this.liveCard=this.getLiveCard(),this.updateMyCardForm(),this.startAnimate()}),this.on("post-card",function(e){d("post-card"),this.postMyCard()}),this.on("disabled-live-btn",function(e){this.$(".btn-start").toggleClass("disabled",e).prop("disabled",e)}),this.on("live-gather",function(){d("live-gahter"),this.$(".live-form").addClass("hide"),this.$(".live-gather").removeClass("hide"),this.measurePositions(this.screen.width,this.screen.height-10,32,32),this.MAPS=this._MAPS.slice(0),this.$(".live-gather").find(".card").remove();var e=this.liveCard.card,t=this.genCard(e,this.coords[0][0],0,0,!0,this.ios).appendTo(this.$(".live-gather"));d(t[0]),this.updateCard(t[0],e),this._others={0:{id:0,name:"adbds fds"},1:{id:1,name:"adbd sffdsfs fds"},2:{id:2,name:"adbds fds"},3:{id:3,name:"adbds fdsfds ffds"},4:{id:4,name:"adbds fds fds fds"},5:{id:5,name:"adbds  fdsf dsfds"},6:{id:6,name:"ad fdsfds bds fds"},7:{id:7,name:"adbds  fdsfds df fds"},8:{id:8,name:"adbds  fdsfds fds fds"},9:{id:9,name:"adbds fdsf dsf ds fds fds"},10:{id:10,name:"adbd sdfdsf s fds"}},this._others&&this.updateOthers()})},inspectFields:function(){var e=this.liveCard.card;return e.name&&e.identities.length},updateMe:function(e){var t=document.getElementById("icard"),n=t.getAttribute("data-url"),r;n!==e.avatar&&(r=e.avatar,r||(r=e.name?h.api_url+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),n!==r&&(t.querySelector(".avatar").style.backgroundImage="url("+r+")",t.setAttribute("data-url",r))),e.name&&(document.getElementById("card-name").value=e.name);var i=document.getElementById("card-bio");e.bio&&(i.innerText=e.bio),i.className=e.bio?"":"hide"},postMyCard:function(){n.set("livecard",this.liveCard);var e=this.liveCard.card;e.identities.length&&(e._time=(new Date).getTime(),p.init(e,$.proxy(this.liveCallback,this)))},state:0,liveCallback:function(e){this.state===1&&(this.updateMe(this.liveCard.card=e.me),n.set("livecard",this.liveCard)),this._others=e.others,this.updateOthers()},updateMyCardForm:function(){var e=this.liveCard,t=e.card,n=t.identities,r;if(n&&(r=n.length)){this.updateMe(t),this.postMyCard(),n=n.slice(0);var i,s;while(i=n.shift())s=i.provider,(s==="email"||s==="phone"||s==="facebook")&&this.addIdentity(i,!0);this.emit("show-add-email"),this.emit("show-add-facebook")}else this.emit("disabled-live-btn",!0)},getLiveCard:function(){var e=n.get("livecard");if(!e){var t={id:"",name:"",avatar:"",bio:"",identities:[]};e={card:t,latitude:"",longitude:"",accuracy:"",traits:[]};var r=n.get("user");r&&(t.name=r.name,t.avatar=r.avatar_filename,t.bio=r.bio,t.identities=r.identities),n.set("livecard",e)}return e.card.id="",e},resetLiveCard:function(){n.clear("livecard"),this.liveCard=this.getLiveCard()},updateLiveCard:function(e,t){var r=this.liveCard.card,i=r.identities;if(t==="+")i.push(e);else{for(var s=0,o=i.length;s<o;++s){var u=i[s];if(u.provider===e.provider&&u.external_username===e.external_username){i.splice(s,1);break}}i.length===0&&this.resetLiveCard()}n.set("livecard",this.liveCard)},setCardName:function(e){var t=this.packedIdentities();if(t.length){var n=t[0],r="",i=n.external_username,s=n.provider;s==="phone"?r="Anonym_"+i.slice(i.length-4):r=i.split("@")[0],this.liveCard.card.name=e.value=r,e.setAttribute("placeholder","Name"),$(e).addClass("normal")}},addFacebook:function(e,t){var n=u(t),r=n.provider;return r&&r==="facebook"&&!this.existsByIdentity(n)?(this.addIdentity(n),!0):!1},addEmailOrPhone:function(e,t,n){var n=!n,r=u(t),i=r.provider;i&&(i==="email"||i==="phone")&&!this.existsByIdentity(r)&&(this.addIdentity(r),n&&this.setCardName(e)),n&&(this.emit("show-add-email"),this.emit("show-add-facebook")),this.emit("post-card")},genIdentity:function(){var e='<li class="identity"><span class="provider">{{provider_alias}}</span><input data-provider="{{provider}}" style="" autocapitalize="none" class="external_username input-item normal" value="{{external_username}}" type="email"/><div class="delete hidden"><div class="delete-x">x</div></div></li>';return function(n){var r=n.provider;r==="email"?r="Email":r==="phone"?r="Mobile":r==="facebook"&&(r="Facebook");var i=$(e.replace(/\{\{provider\}\}/g,n.provider).replace(/\{\{provider_alias\}\}/g,r).replace(/\{\{external_username\}\}/g,n.external_username));return i}}(),resetCard:function(){this.state=0,this.$("#icard").removeAttr("data-url").find(".avatar").css("background",""),this.$("#card-name").attr("placeholder","Your email or mobile no.").removeClass("normal").val(""),this.$("#add-identity").addClass("hide"),this.$("#add-identity-facebook").addClass("hide")},removeIdentity:function(e){var t=this.$(".identities .list li");0===t.length?(this.resetCard(),this.emit("disabled-live-btn",!0)):e.provider==="facebook"&&this.emit("show-add-facebook"),this.updateLiveCard(e,"-"),this.emit("post-card")},addIdentity:function(e,t){this.state=1;var t=!t,n=this.$(".identities .list"),r=this.genIdentity(e);n.append(r),this.emit("disabled-live-btn",!1),t&&(this.updateLiveCard(e,"+"),this.emit("post-card"))},packedIdentities:function(){var e=this.$(".identities .list").find("input"),t=0,n=e.length,r=[],i,s,a,f,l;for(;t<n;++t){i=e.eq(t),s=i.attr("data-provider"),a=o(e.eq(t).val());if(!a)continue;s==="facebook"&&(a+="@facebook"),f=u(a),l=f.provider,l&&(l==="email"||l==="phone"||l==="facebook")&&r.push(f)}return r},existsByIdentity:function(e){var t=this.packedIdentities(),n=e.external_username,r=e.provider,i;if(0===t.length)return!1;while(i=t.shift())if(i.external_username===n&&i.provider===r)return!0;return!1},coords:"".split(),_MAPS:[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],measurePositions:function(e,t,n,r){var i=this.coords;i[0]=[[e*.5-n,t*.88-r]],i[1]=new Array(3),i[1][0]=[e*.25-5-n,t*.66+30-r],i[1][1]=[e*.5-n,t*.66-r],i[1][2]=[e*.75+5-n,t*.66+30-r],i[2]=new Array(4),i[2][0]=[e*.125+5-n,t*.44+40-r],i[2][1]=[e*.375-n,t*.44-r],i[2][2]=[e*.625-n,t*.44-r],i[2][3]=[e*.875-5-n,t*.44+40-r],i[3]=new Array(4),i[3][0]=[e*.125-n,t*.22+40-r],i[3][1]=[e*.375-n,t*.22-r],i[3][2]=[e*.625-n,t*.22-r],i[3][3]=[e*.875-n,t*.22+40-r]},genCard:function(){var e='<div data-url="{{avatar}}" id="{{id}}" data-g="{{g}}" data-i="{{i}}" class="card {{class}}" style="-webkit-transform: matrix3d({{matrix}});"><div class="avatar" style="background-image: url({{avatar}})"></div><div class="name">{{name}}</div></div>';return function(t,n,r,i,s,o){var u=N.slice(0);u[12]=n[0],u[13]=n[1];var a=$(e.replace(/\{\{avatar\}\}/g,t.avatar).replace("{{id}}",t.id).replace("{{class}}",(s?"card-me":"card-other hide")+(o==="iphone4"?" card-iphone4":"")).replace("{{g}}",r).replace("{{i}}",i).replace("{{name}}",t.name).replace("{{matrix}}",u.join(",")));return a.data("card",t),a}}(),addCard:function(e){var t=this.MAPS;if(t.length===0)return!1;var n=t.shift(),r=n[0],i=n[1],s=this.coords[r][i],o=this.genCard(e,s,r,i,!1,this.ios),u=o[0],a=u.style,f=N.slice(0);f[0]=f[5]=0,f[12]=s[0],f[13]=s[1],o.data("card",e),this.$(".live-gather").append(o),(new c.Tween({o:0})).to({o:1},250).easing(c.Easing.Bounce.In).onStart(function(){y(u,f),o.removeClass("hide")}).onUpdate(function(){a.opacity=this.o,f[0]=f[5]=this.o,y(u,f)}).onComplete(function(){c.remove(this)}).start()},delCard:function(e){var t=this.MAPS,n=e.getAttribute("data-g"),r=e.getAttribute("data-i"),i=N.slice(0),s=this.coords[n][r],o=e.style;i[12]=s[0],i[13]=s[1],(new c.Tween({o:1})).to({o:0},250).easing(c.Easing.Bounce.Out).onUpdate(function(){o.opacity=this.o,y(e,i)}).onComplete(function(){t.unshift([n,r]),e.remove(),c.remove(this)}).start()},updateCard:function(e,t){var n=e.getAttribute("data-url"),r="";if(!n||n!==t.avatar)r=t.avatar,r||(r=t.name?h.api_url+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),n!==r&&(e.querySelector(".avatar").style.backgroundImage="url("+r+")",e.setAttribute("data-url",r));e.querySelector(".name").innerText=t.name,$(e).data("card",t)},updateOthers:function(){var e=this._others,t=document.querySelectorAll(".card-other"),n=t.length,r=0,i,s,o,u;for(;r<n;++r)i=t[r],s=i.getAttribute("id"),s in e||this.delCard(i);for(o in e)u=e[o],i=document.getElementById(u.id),i?this.updateCard(i,u):this.addCard(u)},createAnimate:function(){var e=this.afrom,t=this.ato,n=this.$("#icard")[0],r=this.$("#card-form")[0],i=this.$("#live-discover")[0],s=k[13],o=C[13],u=k.slice(0),a=this.a=(new c.Tween({o:0})).to({o:1},500).easing(c.Easing.Cubic.In).onStart(function(){}).onUpdate(function(){i.style.opacity=this.o,u[13]=(s-o)*(1-this.o)+o,y(n,u)}),f=this.b=(new c.Tween({o:0})).delay(250).to({o:1},500).onUpdate(function(){r.style.opacity=this.o})},startAnimate:function(){!this.a&&!this.b&&this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}}),q=e("lightsaber"),R=q();R.use(A.setHtmlHeight),R.use(A.checkSMSToken),R.use(A.cleanup),R.initRouter(),R.controllers={};var U;R.controllers.footer=new P({countDown:5e5,element:$("#app-footer"),init:function(){this.listen()},enableTimer:!0,listen:function(){var e=this,t=e.element;t.on("click.footer",".redirecting, .web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(){x()}).on("keydown.footer","#email",function(t){if(t.keyCode===13){var n=e.$("#email").val();e.addNotificationIdentity(n)}}).on("click.footer",".subscribe .btn_mail",function(t){var n=e.$("#email").val();e.addNotificationIdentity(n)}),this.on("show",function(e,t,n,r){var i=e.height-96-(t?60:0);this.element.removeClass("hide"),this.element.css("top",i+"px"),this.enableTimer&&(this.$(".redirecting").removeClass("hide"),this.emit("start-redirect")),this.$(".error-info").toggleClass("hide",!r),d("show footer bar")}),this.on("show-from-cross",function(e,t,n){this.element.addClass("ft-bg"),this.cross={exfee_id:e,token:t},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),t&&this.$(".subscribe").removeClass("hide"),this.$(".redirecting").removeClass("hide"),this.element.removeClass("hide"),$("#app-footer").addClass("ft-bg"),n?this.emit("start-redirect",n):(this.$(".get-button, .web-version").removeClass("hide"),this.emit("stop-redirect"))}),this.on("start-redirect",function(t){var n=$(".redirecting"),r=n.find(".sec"),i=e.countDown,s;r.text(s=i),U=setInterval(function(){s-=1,s>=1?r.text(s):(clearInterval(U),T(t))},1e3)}),this.on("stop-redirect",function(){this.enableTimer=!1,this.$(".get-button").removeClass("hide"),$(".redirecting").addClass("hide"),clearInterval(U),U=void 0})},addNotificationIdentity:function(e,t,n){t=this.cross.exfee_id,n=this.cross.token;if(!/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e)){$("#email.email").attr("placeholder","Bad email Address.");return}$.ajax({type:"POST",url:h.api_url+"/Exfee/"+t+"/AddNotificationIdentity"+"?token="+n,data:{provider:"email",external_username:e},success:function(e){e&&e.meta&&e.meta.code===200&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}})}}),R.get(/^\/+(?:\?)?#{0,}$/,O.index),R.get(/^\/+(?:\?)?#live\/?$/,O.live),R.get(/^\/+(?:\?)?#verify\/?$/,O.verify),R.get(/^\/+(?:\?)?#set_password\/?$/,O.setPassword),R.get(/^\/+(?:\?)?#token=([a-zA-Z0-9]{64})\/?$/,O.resolveToken),R.get(/^\/+(?:\?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,O.crossPhoneToken),R.get(/^\/+(?:\?)?#!token=([a-zA-Z0-9]{32})\/?$/,O.crossToken);var z;R.on("launched",function(){function e(){f(e),c.update()}d("app launched"),z=setInterval(function(){var e=m();E&&(e-S>1500&&Math.abs(E-S)<1500?(clearInterval(z),$(".get-button button").html('Open <span class="exfe">EXFE</span> app').removeClass("hide"),$("#app-footer").off("click.footer",".get-button button").on("click.footer",".get-button button",function(){T()})):e-E<2e3&&($(".get-button").removeClass("hide"),$(".redirecting").addClass("hide"))),S=e},500),e()}),R.run(),window.App=R});