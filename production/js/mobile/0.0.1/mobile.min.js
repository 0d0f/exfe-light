define(function(e,t,n){e("zepto");var r=e("config"),i=e("store"),s=e("live"),o=null,u=0,a=null,f=0,l="",c=5e9,h=+(new Date),p=function(e){return e?e.replace(/^\s+|\s+$/g,""):""},d=function(e,t){var n=window.innerHeight;n>460?n=460:n<350&&(n=350),$("html").css("min-height",n+"px"),$(".dialog-box").css("min-height",window.innerHeight-(e?50:0)+"px"),t||$(".actions").css("top",n-86-(e?50:0)+"px"),$(".big-x").css("height",n-86-(e?50:0)+"px"),navigator.userAgent.match(/iPad/)?($(".redirecting").unbind("click").bind("click",function(){location.href="/?ipad"+location.hash}),$(".web-version").unbind("click").bind("click",function(){location.href="/?ipad"+location.hash}).show()):$(".web-version").hide(),$(".get-button button").unbind("click").bind("click",b)},v=function(e){$(".redirecting").show(),o=setInterval(function(){var t=~~$(".redirecting .sec").html()-1;t>=0?$(".redirecting .sec").html(t):(clearTimeout(o),S(e),$(".actions .error-info").hide())},1e3)},m=function(){$(".redirecting").hide(),$("footer").hide()},g=function(e){var t=["home","x","verify"];for(var n in t)$("body").toggleClass(t[n],t[n]===e)},y=function(e){g("home"),$("#app-main").html('<div class="dialog-box"><div class="big-x"><div class="img"><img width="182" height="182" src="/static/img/exfe.png"/></div></div><div class="actions"><div class="error-info">You just opened an invalid link.</div><div class="get-button"><button>Get <span class="exfe">EXFE</span> app <span class="free">free</span></button><div class="redirecting">Redirecting to EXFE app in <span class="sec">'+c+"</span>s.</div>"+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+"</div>"),e?$(".actions .error-info").show():$(".actions .error-info").hide(),d(),v()},b=function(){window.location="itms://itunes.apple.com/us/app/exfe/id514026604"},w=function(e){window.location="exfe://crosses/"+(e?e:"")},E=setInterval(function(){var e=+(new Date);u&&(e-h>1500&&Math.abs(u-h)<1500?(clearTimeout(E),$(".get-button button").html('Open <span class="exfe">EXFE</span> app'),$(".get-button button").unbind("click").bind("click",w)):e-u<2e3&&($(".get-button button").show(),$(".redirecting").hide())),h=e},500),S=function(e){u=+(new Date),w(e)},x=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},T=function(e,t){g("x"),$("#app-main").html('<div class="cross redirecting">Redirecting to <span class="exfe_blue3">EXFE</span> app in <span class="sec">'+c+"</span>s.</div>"+'<div class="content">'+'<div class="title_area">'+'<div class="title_wrap_a">'+'<div class="title_wrap_b">'+'<div class="title_text"></div>'+"</div>"+"</div>"+'<div class="inviter"><div class="ribbon"></div><div class="textoverflow">Invited by <span class="inviter_highlight"></span></div></div>'+'<div class="title_overlay"></div>'+"</div>"+'<div class="inf_area">'+'<div class="description"><div class="xbtn-more"><span class="rb"></span><span class="lt"></span></div></div>'+'<div class="time_area">'+'<div class="time_major"></div>'+'<div class="time_minor"></div>'+"</div>"+'<div class="place_area">'+'<div class="place_major"></div>'+'<div class="place_minor"></div>'+'<a class="map_link" href="#">'+'<div class="map">'+'<img class="place_mark" src="http://img.exfe.com/web/map_pin_blue@2x.png">'+"</div>"+"</a>"+"</div>"+'<div class="rsvp_toolbar rsvp_toolbar_off">'+'<div class="tri"></div>'+"<table>"+"<tr>"+'<td class="rsvp accepted">I\'m in</td>'+'<td class="rsvp unavailable">Unavailable</td>'+"</tr>"+"</table>"+"</div>"+'<div class="exfee"><table><tr></tr></table></div>'+"</div>"+"</div>"+"<footer>"+'<div class="footer-wrap">'+'<div class="footer_frame">'+'<div class="actions" id="cross_actions">'+'<div class="subscribe">Subscribe to updates and engage in:'+'<div class="subscribe-frame">'+'<input type="text" class="email" id="email" placeholder="Enter your email">'+'<button class="btn_mail"></button>'+"</div>"+"</div>"+'<div class="get-button">'+'<button class="btn_w">Get <span class="exfe">EXFE</span> app <span class="free">free</span></button>'+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+"</div>"+"</div>"+"</footer>"),d(!0,!0);var n=i.get("cats");n||(n={});var s={invitation_token:e};n[e]?l=s.cross_access_token=n[e]:t&&(s.cross_id=t),$(".rsvp.accepted").bind("click",function(){A("ACCEPTED")}),$(".rsvp.unavailable").bind("click",function(){A("DECLINED")}),$.ajax({type:"post",url:r.api_url+"/Crosses/GetCrossByInvitationToken",data:s,success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200){$(".title_area  .title_text").html(x(t.response.cross.title)),$(".inf_area   .description").prepend(x(t.response.cross.description).replace(/\r\n|\r|\n/g,"<br>")),$(".inf_area .description").height()>130?($(".inf_area .description .xbtn-more").show(),$(".inf_area .description .xbtn-more .rb").show(),$(".inf_area .description .xbtn-more .lt").hide(),$(".inf_area .description").toggleClass("limit",!0).on("click",function(){$(".inf_area .description").hasClass("limit")?($(".inf_area .description").toggleClass("limit",!1),$(".inf_area .description .xbtn-more .rb").hide(),$(".inf_area .description .xbtn-more .lt").show()):($(".inf_area .description").toggleClass("limit",!0),$(".inf_area .description .xbtn-more .rb").show(),$(".inf_area .description .xbtn-more .lt").hide())})):$(".inf_area .description .xbtn-more").hide(),t.response.cross.description||$(".time_area").addClass("no_prepend");var s="Sometime",o="To be decided";if(t.response.cross.time&&t.response.cross.time.begin_at&&t.response.cross.time.begin_at.origin&&t.response.cross.time.begin_at.timezone){var u=C(t.response.cross.time);s=x(u.title),o=x(u.content)}else $(".time_area .time_minor").toggleClass("time_tobe",!0);$(".time_area   .time_major").html(s),$(".time_area   .time_minor").html(o);var c="Somewhere",h="To be decided";t.response.cross.place&&t.response.cross.place.title?(c=x(t.response.cross.place.title),h=x(t.response.cross.place.description).replace(/\r\n|\r|\n/g,"<br>")):$(".place_area .place_minor").toggleClass("place_tobe",!0),$(".place_area .place_major").html(c),$(".place_area .place_minor").html(h);if(t.response.cross.place.lat&&t.response.cross.place.lng){var p=typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio<=2?window.devicePixelRatio:1;$(".place_area .map").css("background-image","url(https://maps.googleapis.com/maps/api/staticmap?center="+t.response.cross.place.lat+","+t.response.cross.place.lng+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+t.response.cross.place.lat+","+t.response.cross.place.lng+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+p+")"),$(".map_link").attr("href","http://maps.google.com/maps?daddr="+encodeURIComponent(c)+"@"+t.response.cross.place.lat+","+t.response.cross.place.lng)}else $(".place_area .map").hide();var d="default.jpg";for(var g=0;g<t.response.cross.widget.length;g++)if(t.response.cross.widget[g].type==="Background"){d=t.response.cross.widget[g].image;break}$(".title_area").css("background","url(/static/img/xbg/"+d+") no-repeat 50% 50%");var b=0,w=0;t.response.authorization?(b=t.response.authorization.user_id,t.response.browsing_identity&&(w=t.response.browsing_identity.id)):t.response.browsing_identity&&t.response.browsing_identity.connected_user_id>0&&(b=t.response.browsing_identity.connected_user_id,w=t.response.browsing_identity.id),typeof t.response.cross_access_token!="undefined"&&(n[e]=t.response.cross_access_token,i.set("cats",n),l=t.response.cross_access_token),$(".inviter").hide();var E=-1,S="";f=t.response.cross.exfee.id;for(g in t.response.cross.exfee.invitations)if(b&&b===t.response.cross.exfee.invitations[g].identity.connected_user_id||w===t.response.cross.exfee.invitations[g].identity.id){E=g,w=t.response.cross.exfee.invitations[g].identity.id,$(".inviter .inviter_highlight").html(x(t.response.cross.exfee.invitations[g].invited_by.name)),$(".inviter").show(),a=t.response.cross.exfee.invitations[g];switch(t.response.cross.exfee.invitations[g].rsvp_status){case"ACCEPTED":S="accepted";break;case"DECLINED":S="declined";break;default:S="pending"}$(".exfee table tbody tr").first().append('<td><div class="portrait me" style="background: url('+t.response.cross.exfee.invitations[g].identity.avatar_filename+'); background-size: 50px 50px;">'+"</div>"+'<div class="portrait_rsvp_me '+S+'">'+"</div>"+(t.response.cross.exfee.invitations[g].mates?'<div class="portrait_mymate">+'+t.response.cross.exfee.invitations[g].mates+"</div>":"")+'<div class="name_me textcut">'+x(t.response.cross.exfee.invitations[g].identity.name)+"</div>"+"</td>");break}var T=["ACCEPTED","INTERESTED","NORESPONSE","IGNORED","DECLINED"],k=null;for(g in T)for(var L in t.response.cross.exfee.invitations){if(t.response.cross.exfee.invitations[L].rsvp_status!==T[g]||E==L)continue;switch(t.response.cross.exfee.invitations[L].rsvp_status){case"ACCEPTED":S="accepted";break;case"DECLINED":S="declined";break;default:S="pending"}k=$(".exfee table tbody tr").last(),k.children().length===5&&$(".exfee table tbody").append("<tr></tr>"),k=$(".exfee table tbody tr").last(),k.append('<td><div class="portrait" style="background: url('+t.response.cross.exfee.invitations[L].identity.avatar_filename+'); background-size: 50px 50px;">'+(t.response.cross.exfee.invitations[L].mates?'<div class="portrait_mate">+'+t.response.cross.exfee.invitations[L].mates+"</div>":"")+"</div>"+'<div class="portrait_rsvp '+S+'">'+"</div>"+'<div class="name textcut">'+x(t.response.cross.exfee.invitations[L].identity.name)+"</div>"+"</td>")}k=$(".exfee table tr").last(),count=5-k.children().length;for(g=0;g<count;g++)k.append("<td></td>");var A=null;if(b)if(typeof t.response.authorization!="undefined")i.set("authorization",t.response.authorization),A=t.response.cross.id+"?user_id="+b+"&token="+t.response.authorization.token+"&identity_id="+w,l=t.response.authorization.token;else{var O=i.get("authorization");O&&typeof O.user_id!="undefined"&&O.user_id===b&&(A=t.response.cross.id+"?user_id="+b+"&token="+O.token+"&identity_id="+w,l=O.token)}l&&E!==-1?(t.response.cross.exfee.invitations[E].identity.id===t.response.cross.exfee.invitations[E].invited_by.id?$(".inviter").hide():$(".rsvp_toolbar").toggleClass("rsvp_toolbar_off",!1),$(".portrait.me").on("click",function(){$(".rsvp_toolbar").toggleClass("rsvp_toolbar_off",!$(".rsvp_toolbar").hasClass("rsvp_toolbar_off"))}),t.response.cross.exfee.invitations[E].identity.provider==="phone"&&($(".rsvp_toolbar tr").append('<td class="rsvp changename">Change my display name</td>'),$(".rsvp_toolbar td").css("width","98px"),$(".changename").on("click",function(){var e=prompt("Change my display name:");e!==null&&(e===""?alert("Display name cannot be empty."):$.ajax({type:"post",url:r.api_url+"/Identities/"+t.response.cross.exfee.invitations[E].identity.id+"/Update"+"?token="+l,data:{name:e},success:function(e){e&&(e=JSON.parse(e))&&e.meta.code===200&&$(".name_me").html(x(e.response.identity.name))},error:function(){alert("Failed, please retry later.")}}))}),$(".subscribe").show(),$("#email.email").on("keyup",function(e){e.keyCode===13&&N(t)}),$(".subscribe .btn_mail").on("click",function(){N(t)}))):$(".inviter").hide(),A?v(A):m();return}y(!0)},error:function(){y(!0)}})},N=function(e){var t=$("#email.email").val();if(!/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(t)){$("#email.email").attr("placeholder","Bad email Address.");return}$.ajax({type:"post",url:r.api_url+"/Exfee/"+e.response.cross.exfee.id+"/AddNotificationIdentity"+"?token="+l,data:{provider:"email",external_username:t},success:function(e){e&&(e=JSON.parse(e))&&e.meta.code===200&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}})},C=function(t){var n=e("humantime"),r=n.printEFTime(t,"X");return r},k=function(e,t){g("verify"),$("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><input type="text" class="name" id="name" placeholder="Set EXFE User Name" /></div><div><input type="password" id="password" placeholder="Set EXFE Password" /><i class="eye icon16-pass-show"></i><img width="18" height="18" class="loading" src="/static/img/loading.gif" /></div><div class="error-info"></div><div class="set-button"><button>Done</button></div><div class="done-info"><span class="status">Password set successfully.</span><span class="redirecting">Redirecting to app in <span class="sec">'+c+"</span>s.</span>"+"</div>"+"</div>"+'<div class="actions">'+'<div class="get-button">'+'<button>Get <span class="exfe">EXFE</span> app <span class="free">free</span></button>'+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+"</div>"),d(!0),$(".eye").click(function(e){var t=$(this).prev();t.prop("type",function(e,t){return t==="password"?"text":"password"}),$(this).toggleClass("icon16-pass-hide icon16-pass-show")}),$.ajax({type:"post",url:r.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(e){if(e&&(e=JSON.parse(e))&&e.meta.code===200){$(".identity .avatar").attr("src",e.response.user.avatar_filename),$(".identity .name").val(e.response.user.name);return}y(!0)},error:function(){y(!0)}}),$("#password").bind("keydown",function(e){e.which===13?L(t):$(".error-info").html("")}),$(".set-button button").bind("click",function(){L(t)})},L=function(e){$(".loading").show(),$(".eye").hide();var t=p($("#name").val()),n=$("#password").val();n.length>=4?($(".set-button button").prop("disabled",!0),$(".set-button button").toggleClass("disabled",!0),$.ajax({type:"post",url:r.api_url+"/Users/ResetPassword",data:{token:e,name:t,password:n},success:function(e){$(".loading").hide(),$(".eye").show();if(e&&(e=JSON.parse(e))&&e.meta.code===200&&e.response.authorization){$(".error-info").hide(),$(".set-button").hide(),$(".done-info").show(),v("?user_id="+e.response.authorization.user_id+"&token="+e.response.authorization.token);return}$(".loading").hide(),$(".eye").show(),$(".error-info").html("Failed to set password. Please try later.").show(),$(".set-button button").prop("disabled",!1),$(".set-button button").toggleClass("disabled",!1)},error:function(){$(".loading").hide(),$(".eye").show(),$(".error-info").html("Failed to set password. Please try later.").show(),$(".set-button button").prop("disabled",!1),$(".set-button button").toggleClass("disabled",!1)}})):($(".error-info").html("Password must be longer than four!").show(),$(".loading").hide(),$(".eye").show())},A=function(e){var t=[{rsvp_status:e,identity_id:a.identity.id,by_identity_id:a.identity.id}];$(".rsvp_toolbar").addClass("rsvp_toolbar_off");switch(e){case"ACCEPTED":$(".portrait_rsvp_me").toggleClass("accepted",!0),$(".portrait_rsvp_me").toggleClass("declined",!1),$(".portrait_rsvp_me").toggleClass("pending",!1);break;case"DECLINED":$(".portrait_rsvp_me").toggleClass("accepted",!1),$(".portrait_rsvp_me").toggleClass("declined",!0),$(".portrait_rsvp_me").toggleClass("pending",!1);break;default:$(".portrait_rsvp_me").toggleClass("accepted",!1),$(".portrait_rsvp_me").toggleClass("declined",!1),$(".portrait_rsvp_me").toggleClass("pending",!0)}$.ajax({type:"post",url:r.api_url+"/Exfee/"+f+"/Rsvp?token="+l,data:{rsvp:JSON.stringify(t)},success:function(e){},error:function(){alert("RSVP failed!")}})},O=function(e){g("verify"),$("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><img class="provider" width="18" height="18" src="" /><span class="name"></span></div><div class="done-info"><span class="status">Verification succeeded.</span><span class="redirecting">Redirecting to app in <span class="sec">'+c+"</span>s.</span>"+"</div>"+"</div>"+'<div class="space"></div>'+'<div class="actions">'+'<div class="get-button">'+'<button>Get <span class="exfe">EXFE</span> app <span class="free">free</span></button>'+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+"<div>"),d(!0),$.ajax({type:"post",url:r.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)for(var n in t.response.user.identities)if(t.response.user.identities[n].id===e.identity_id){$(".identity .avatar").attr("src",t.response.user.identities[n].avatar_filename),$(".identity .provider").attr("src","/static/img/identity_"+t.response.user.identities[n].provider+"_18_grey@2x.png"),$(".identity .name").html(t.response.user.identities[n].external_username),$(".done-info").show(),v("?user_id="+t.response.user.user_id+"&token="+e.token);return}y(!0)},error:function(){y(!0)}})},M=function(e){$.ajax({type:"post",url:r.api_url+"/Users/ResolveToken",data:{token:e},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)switch(t.response.action){case"VERIFIED":O(t.response);return;case"INPUT_NEW_PASSWORD":k(t.response,e);return}y(!0)},error:function(){y(!0)}})},_=function(e){e=p(e);var t={id:0,name:"",external_id:"",external_username:"",provider:"",type:"identity"};if(/^[^@]*<[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?>$/.test(e)){var n=e.indexOf("<"),i=e.indexOf(">");t.external_id=p(e.substring(++n,i)),t.external_username=t.external_id,t.name=p(H(p(e.substring(0,n)).replace(/^"|^'|"$|'$/g,""))),t.provider="email"}else if(/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e))t.external_id=e,t.external_username=e,t.name=p(H(e.split("@")[0])),t.provider="email";else if(/^@[a-z0-9_]{1,15}$|^@[a-z0-9_]{1,15}@twitter$|^[a-z0-9_]{1,15}@twitter$/i.test(e))t.external_id="",t.external_username=e.replace(/^@|@twitter$/ig,""),t.name=t.external_username,t.provider="twitter";else if(/^[a-z0-9\.]{5,}@facebook$/i.test(e))t.external_id="",t.external_username=e.replace(/@facebook$/ig,""),t.name=t.external_username,t.provider="facebook";else{if(!/^\+[\d\-]{5,15}$/.test(e))return null;e=e.replace(/\-|\(|\)|\ /g,""),t.external_id=e,t.external_username=e,t.name=e.replace(/^.*([\d]{4})$/,"$1"),t.provider="phone"}return t.avatar_filename=encodeURI(r.api_url+"/avatar/default?name="+t.name),t},D=function(e){$("#app-main").html('<div class="here-main"><ol class="near-by"></ol><div class="my-card"><img class="my-avatar" src="'+r.api_url+"/avatar/default"+'">'+'<div class="name-input">'+'<input type="text" class="name" value="">'+'<button class="ok">OK</button>'+"</div>"+'<div class="identities-list">'+"<ol></ol>"+'<button class="add">Enter your email or mobile</button>'+"</div>"+"</div>"+"</div>");var t=i.get("user");if(t&&t.identities&&t.identities.length){$(".here-main .name-input .name").val(t.name),$(".here-main .my-card .my-avatar").attr("src",t.avatar_filename);for(var n in t.identities)switch(t.identities[n].provider){case"email":case"phone":R(t.identities[n].external_username)}}$(".here-main .name-input .ok").on("click",j),$(".here-main .name-input .name").on("keyup",function(){$(".here-main .name-input .ok").prop("disabled",!B())}),$(".here-main .identities-list").on("keyup",".new-identity",function(){$(".here-main .name-input .ok").prop("disabled",!B())}),$(".here-main .identities-list .add").on("click",R),s.shake(function(){alert("shake start!")},function(){alert("shake end!")})},P=function(e){var t=0;if(e)for(var n=0;n<e.length;n++)charCode=e.charCodeAt(n),charCode<127?t+=1:128<=charCode&&charCode<=2047?t+=2:2048<=charCode&&charCode<=65535&&(t+=3);return t},H=function(e){e=e?e.replace(/[^0-9a-zA-Z_\u4e00-\u9fa5\ \'\.]+/g," "):"";while(P(e)>30)e=e.substring(0,e.length-1);return e},B=function(){if(!$(".here-main .name-input .name").val())return!1;var e=$(".here-main .identities-list li"),t=0;for(var n=0;n<e.length;n++){var r=$(e[n]).find(".new-identity").val();if(r){if(!_(r))return!1;t++}}return t?!0:!1},j=function(){var e=$(".here-main .name-input .name"),t=$(".here-main .my-card .my-avatar");t.attr("src")===r.api_url+"/avatar/default"&&t.attr("src",encodeURI(r.api_url+"/avatar/default?name="+e.val()));var n={name:e.val(),avatar:t.attr("src"),identities:[]},i=$(".here-main .identities-list li");for(var o=0;o<i.length;o++){var u=_($(i[o]).find(".new-identity").val());u&&n.identities.push(u)}n.name&&n.identities.length&&s.init(n,q)},F=function(e){var t=$(".here-main .name-input .name"),n=p(t.val()).toLowerCase(),r=p(e.name);n!==r.toLowerCase()&&t.val(r);var i=$(".here-main .my-card .my-avatar"),s=p(i.attr("src")).toLowerCase(),o=p(e.avatar);s!==o.toLowerCase()&&i.attr("arc",o);var u=$(".here-main .identities-list li"),a={};for(var f=0;f<u.length;f++){var l=p($(u[f]).find(".new-identity").val()).toLowerCase();for(var c=0;c<e.identities.length;c++){var h=p(e.identities[c].external_username).toLowerCase();l===h&&(a[e.identities[c].external_username]=!0)}}for(f=0;f<e.identities.length;f++)typeof a[e.identities[f].external_username]=="undefined"&&R(p(e.identities[f].external_username))},I=function(e){var t=$(".here-main .near-by li"),n={};for(var r=0;r<t.length;r++){var i=$(t[r]),s=i.data("id");s&&(typeof e[s]=="undefined"?i.remove():(z(e[s]),n[s]=!0))}for(r in e)typeof n[r]=="undefined"&&U(e[r])},q=function(e){typeof e["me"]!="undefined"&&F(e.me),typeof e["others"]!="undefined"&&I(e.others)},R=function(e){$(".here-main .identities-list").append('<li><input class="new-identity" type="text" value="'+(Object.prototype.toString.call(e)==="[object String]"?x(e):"")+'"></li>')},U=function(e){var t=$('<li data-id="'+e.id+'">'+'<img calss="avatar" src="'+e.avatar+'"/>'+'<div class="name">'+x(e.name)+"</div>"+"</li>");t.data("card",e),$(".here-main .near-by").append(t)},z=function(e){var t=$('.here-main .near-by [data-id="'+e.id+'"]'),n=t.data("card");t.data("card",e),p(n.name).toLowerCase()!==p(e.name).toLowerCase()&&t.find(".name").html(e.name),p(n.avatar).toLowerCase()!==p(e.avatar).toLowerCase()&&t.find(".avatar").attr("src",e.avatar)};window.addEventListener("load",function(){function e(){try{var e=typeof window.localStorage!="undefined";return e&&(window.localStorage.setItem("storage",0),window.localStorage.removeItem("storage")),e}catch(t){return!1}}setTimeout(function(){window.scrollTo(0,0)},0),e()||alert("EXFE cannot be used in private browsing mode.")});if(sms_token){switch(sms_token.action){case"VERIFIED":O(sms_token);return;case"INPUT_NEW_PASSWORD":k(sms_token,sms_token.origin_token);return}y(!0);return}if(sms_token===!1){y(!0);return}var W=document.location.hash.replace(/^#/,"");if(W){W=W.split("/");for(var X=0;X<W.length;X++){if(W[X].match(/^token=.*/)){M(W[X].replace(/^token=(.*)/,"$1",W[X]));return}if(W[X].match(/^\!token=.*/)){T(W[X].replace(/^\!token=(.*)/,"$1",W[X]));return}if(W[X].match(/^\![0-9]{1,}/)&&typeof W[X+1]!="undefined"&&W[X+1].match(/^.{4}/)){T(W[X+1],W[X].replace(/^\!(.*)/,"$1",W[X]));return}if(W[X].match(/^here/)){D();return}y(!0);return}}y()});