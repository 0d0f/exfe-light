define(function(e){"use strict";function O(){return"Controller-"+A++}var t=e("base"),n=e("store"),r=e("handlebars"),i=e("humantime"),s=e("util"),o=s.trim,u=s.parseId,a=e("af"),f=a.request,l=a.cancel,c=e("tween"),h=e("config"),p=function(){console.log.apply(console,arguments)},d=function(e){console.dir(e)},v=Date.now||function(){return(new Date).getTime()},m="webkitTransform"in document.body.style,g;m?g=function(e,t){var n=t.length===6?"":"3d";e.style.webkitTransform="matrix"+n+"("+t.join(",")+")"}:g=function(e,t){var n=t.length===6?"":"3d";e.style.transform="matrix"+n+"("+t.join(",")+")"};var y=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},b=function(e){var t=i.printEFTime(e,"X");return t},w=0,E=v(),S=function(){window.location="itms://itunes.apple.com/us/app/exfe/id514026604"},x=function(e){w=v(),window.location="exfe://crosses/"+(e||"")},T=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],N=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],C=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("sms-token")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},k={setHtmlHeight:function(e,t,n){setTimeout(function(){window.scrollTo(0,0)},0);var r=document.documentElement,i=r.style,s=window.innerHeight;s>=444?s=508:s<=356&&(s=420),e.app.screen={width:320,height:s},i.minHeight=s+"px",n()},checkStorageSupported:function(){try{var e=window.localStorage;e&&(e.setItem("storage",0),e.removeItem("storage"))}catch(t){alert("EXFE cannot be used in private browsing mode.")}next()},checkSMSToken:function(e,t,n){var r=C();if(r){var i=r.action;e.smsToken=r,"VERIFIED"===i?t.redirect("/#verify"):"INPUT_NEW_PASSWORD"===i&&t.redirect("/#set_password");return}n()},cleanup:function(e,t,n){delete e.smsToken,$("#app-header").addClass("hide"),$("#app-footer").removeClass("ft-bg");var r=e.switchPageCallback;r?r():$("#app-body .page").addClass("hide"),delete e.switchPageCallback,n()}},L={index:function(e,t){p("index `Home`");var n=e.error,r=e.app,i=r.controllers,s=i.home,o=i.footer,u=r.screen;s||(s=r.controllers.home=new H({options:{template:$("#home-tmpl").html()}})),s.emit("show",u),o.emit("show",u,!1,!1,n),delete e.error},verify:function(e,t){p("verify");var n=e.smsToken;if(n){$("#app-header").removeClass("hide");var r=new D({options:{template:$("#verify-tmpl").html()},smsToken:n});r.emit("show",e,t)}else e.error=!0,t.redirect("/")},setPassword:function(e,t){p("set-password");var n=e.smsToken;if(n){$("#app-header").removeClass("hide");var r=new P({options:{template:$("#setpassword-tmpl").html()},smsToken:n,token:n.origin_token});r.emit("show",e,t)}else e.error=!0,t.redirect("/")},resolveToken:function(e,t){p("`resolve token`");var n=e.params[0];n?$.ajax({type:"POST",url:h.api_url+"/Users/ResolveToken",data:{token:n},success:function(r){if(r&&r.meta&&r.meta.code===200){e.smsToken=response;var i=e.smsToken.action;i==="VERIFIED"?t.redirect("/#verify"):i==="INPUT_NEW_PASSWORD"&&(re.smsToken.origin_token=n,t.redirect("/#set_password"))}},error:function(){e.error=!0,t.redirect("/")}}):(e.error=!0,t.redirect("/"))},crossPhoneToken:function(e,t){p("cross `phone token`");var r=e.params,i=r[0],s=r[1];p("cross",i,s);var o=n.get("cats"),u,a,f;a={invitation_token:s,cross_id:i},o&&(f=o[s])&&(a.cross_access_token=f),showCross(e,t,a)},crossToken:function(e,t){p("cross `normal token`");var r=e.params[0],i=n.get("cats"),s={invitation_token:r},o;i&&(o=i[r])&&(s.cross_access_token=o),showCross(e,t,s)},showCross:function(t,i,s){$.ajax({type:"POST",url:h.api_url+"/Crosses/GetCrossByInvitationToken",data:s,success:function(e){var s=e.meta,o=s&&s.code;if(o&&o===200){var u=e.response,a=u.cross,f={id:a.id,title:y(a.title),description:y(a.description.replace(/\r\n|\r|\n/g,"<br />")),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!u.read_only},l=a.time;l&&l.begin_at&&l.begin_at.origin&&l.begin_at.timezone?f.time=b(l):f.time.tobe=!0;var c=a.place;c&&c.title&&(f.place={title:c.title,description:c.description.replace(/\r\n|\r|\n/g,"<br />")});var h=c.lat,p=c.lng;if(h&&p){var v=window.devicePixelRatio>=2?2:1;f.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+h+","+p+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+h+","+p+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+v,f.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(f.place.title)+"@"+h+","+p}var m=a.widget,g;if(m&&(g=m.length))for(var w=0;w<g;++w)if(m[w].type==="Background"){f.background=m[w].image;break}var E=0,S=0,x=u.authorization;x?(E=x.user_id,u.browsing_identity&&(S=u.browsing_identity.id)):u.browsing_identity&&u.browsing_identity.connected_user_id&&(E=u.browsing_identity.connected_user_id,S=u.browsing_identity.id),u.cross_access_token&&(token=cats[ctoken]=u.cross_access_token,n.set("cats",cats));var T=a.exfee.invitations,N=[],C={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]};for(var k=0,L=T.length;k<L;++k){var A=T[k];console.log(A);var O="pending",M=A.rsvp_status;M==="ACCEPTED"?O="accepted":M==="DECLINED"&&(O="declined"),A.rsvp_style=O,E&&E===A.identity.connected_user_id||S===A.identity.id?(A.is_me=!0,S=A.identity.id,S!==A.invited_by.id&&(f.inviter=A.invited_by),A.isphone=A.provider==="phone",f.identity=A,C.ACCEPTED.unshift(A)):C[A.rsvp_status].push(A)}N=[].concat(C.ACCEPTED,C.INTERESTED,C.NORESPONSE,C.IGNORED,C.DECLINED),f.invitations=[];var _=0,L=N.length;while(_<L)f.invitations.push(N.splice(0,5)),_+=5;var L=f.invitations.length,D=f.invitations[L-1],P=D.length;if(P&&P<5)while(5-P++)D.push(void 0);var H="";E&&(x?(H=f.id+"?user_id="+E+"&token="+x.token+"&identity_id="+S,token=x.token,n.set("authorization",x)):(x=n.get("authorization"),x&&x.user_id===E&&(H=f.id+"?user_id="+E+"&token="+x.token+"&identity_id="+S,token=x.token))),d(f);var j=t.app,F=j.controllers,I=F.cross;I&&I.destory();var q=r.compile($("#cross-tmpl").html());I=j.controllers.cross=new B({options:{template:q(f)},cross:f,exfee_id:a.exfee.id,token:token}),I.emit("show"),j.controllers.footer.emit("show-from-cross",a.exfee.id,token,H)}else t.error=!0,i.redirect("/")},error:function(e){t.error=!0,i.redirect("/")}})},live:function(e,t){p("`live`");var n=e.app,r=n.controllers,i=r.live;i&&i.destory(),i=n.controllers.live=new j({options:{template:$("#live-tmpl").html()}}),i.emit("show",n.screen)}},A=0,M=t.extend({initialize:function(e){this.cid=O(),this.initOptions(e),this.parseElement(),this.init(),M.caches[this.cid]=this},parseElement:function(){var e=this.element,t=this.options.template;e?this.element=e instanceof $?e:$(e):t&&(this.element=$(t));if(!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(e){this.setOptions(e);for(var t in e)t!=="options"&&(this[t]=e[t])},init:function(){},_destory:function(){delete M.caches[this.cid],M.superclass.destory.call(this)},$:function(e){return this.element.find(e)}});M.caches=[];var _=M.extend(),D=M.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-verify").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.smsToken;this.on("show",function(n,r){var i=function(){n.error=!0,r.redirect("/")};this.element.removeClass("hide"),$.ajax({type:"POST",url:h.api_url+"/Users/"+t.user_id+"?token="+t.token,data:{token:t.token},success:function(n){if(n&&n.meta&&n.meta.code===200){var r=n.response.user,s=r.identities;for(var o=0,u=s.length;o<u;++o){var a=s[o];if(a.id===t.identity_id){e.showIdentity(a),redirecting("?user_id="+r.user_id+"&token="+result.token);return}}}i()},error:function(){i()}})})},showIdentity:function(e){var t=this.$(".identity");t.find(".name").text(e.name),t.find(".avatar").attr("src",e.avatar_filename),t.find(".provider").attr("src","/static/img/identity_"+e.provider+"_18_grey@2x.png"),t.next().removClass("hide")}}),P=M.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-setpassword").length||this.element.appendTo($("#app-body"))},submitPassword:function(){var e=this,t=this.token,n=this.$(".eye").addClass("hide"),r=this.$(".loading").removeClass("hide"),i=this.$(".set-button button"),s=this.$(".error-info"),u=o(this.$("#name").val()),a=this.$("#password").val();a.length>=4?(i.addClass("disabled").prop("disabled",!0),$.ajax({type:"POST",url:h.api_url+"/Users/ResetPassword",data:{token:t,name:u,password:a},success:function(e){r.addClass("hide"),n.removeClass("hide"),s.html("Failed to set password. Please try later.").removeClass("hide"),i.removeClass("disabled").prop("disabled",!1)},error:function(e){r.addClass("hide"),n.removeClass("hide"),s-info.html("Failed to set password. Please try later.").removeClass("hide"),i.removeClass("disabled").prop("disabled",!1)}})):(s.html("Password must be longer than four!").removeClass("hide"),r.addClass("hide"),n.removeClass("hide"))},listen:function(){var e=this,t=this.element,n=this.smsToken,r=this.token;t.on("touchstart.setpassword",".eye",function(){var e=$(this).prev();e.prop("type",function(e,t){return t==="password"?"text":"password"}),$(this).toggleClass("icon16-pass-hide icon16-pass-show")}).on("keydown.setpassword","#password",function(t){t.keyCode===13?e.submitPassword():e.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){e.submitPassword()}),this.on("show",function(e,r){var i=function(){e.error=!0,r.redirect("/")};t.removeClass("hide"),$.ajax({type:"POST",url:h.api_url+"/Users/"+n.user_id+"?token="+n.token,data:{token:n.token},success:function(e){var t=e.response.user;if(e&&e.meta&&e.meta.code===200){$(".identity .avatar").attr("src",t.avatar_filename),$(".identity .name").val(t.name);return}i()},error:function(){i()}})})}}),H=M.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-home").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element;t.on("touchstart.home","#home-card",function(n){clearInterval(R),clearInterval(q),R=q=void 0,e.stopAnimate(),I.request.switchPageCallback=function(){t.addClass("hide")},I.response.redirect("/#live")}),this.on("show",function(e){p(this.$("#home-card")[0]);var n=e.height;N[13]=(n-64)/2,this.$(".logo-box .inner").css("top",(n-300)/2+"px"),g(this.$("#home-card")[0],N),t.removeClass("hide"),this.startAnimate()})},aopts:{o:1},createAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),n=document.getElementById("home-card"),r=function(){t.style.opacity=e.o,n.style.opacity=1-e.o},i=this._a=(new c.Tween(e)).delay(1377).to({o:0},1377).easing(c.Easing.Cubic.InOut).onUpdate(r),s=this._b=(new c.Tween(e)).delay(1377).to({o:1},1377).easing(c.Easing.Cubic.InOut).onUpdate(r);i.chain(s),s.chain(i)},startAnimate:function(){!this._a&&!this._b&&this.createAnimate(),this._a.start()},stopAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),n=document.getElementById("home-card");this._a.stop(),this._b.stop(),e.o=t.style.opacity=1,n.style.opacity=0}}),B=M.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-cross").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element,n=this.token,r=this.cross,i=e.$(".rsvp_toolbar");t.on("touchstart.cross",".portrait.me",function(e){i.toggleClass("rsvp_toolbar_off",!i.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(t){var i=prompt("Change my display name:");i!==null&&(i===""?alert("Display name cannot be empty."):$.ajax({type:"POST",url:h.api_url+"/Identities/"+r.identity.id+"/Update"+"?token="+n,data:{name:i},success:function(t){t&&t.meta&&t.meta.code===200&&e.$(".name_me").html(y(t.response.identity.name))},error:function(){alert("Failed, please retry later.")}}))}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var t=$(this).hasClass("accepted")?"ACCEPTED":"DECLINED";e.rsvp(t)}).on("touchstart.cross",".inf_area .description",function(){var e=$(this),t=e.hasClass("clickable");if(t){var n=e.hasClass("limit");e.toggleClass("limit",!n),e.find(".xbtn-more .rb").toggleClass("hidden",n),e.find(".xbtn-more .lt").toggleClass("hidden",!n)}}),this.on("show",function(){t.removeClass("hide");var e=this.$(".inf_area .description");e.height()>130&&(e.addClass("limit clickable"),e.find(".xbtn-more").removeClass("hide"),e.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(e){var t=this.cross.identity.id,n=this.exfee_id,r=this.token,i=[{rsvp_status:e,identity_id:t,by_identity_id:t}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var s=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(e){case"ACCEPTED":s.addClass("accepted");break;case"DECLINED":s.addClass("declined");break;default:s.addClass("pending")}$.ajax({type:"post",url:h.api_url+"/Exfee/"+n+"/Rsvp?token="+r,data:{rsvp:JSON.stringify(i)},success:function(e){},error:function(){alert("RSVP failed!")}})}}),j=M.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-live").length?this.element=$("#app-live"):this.element.appendTo($("#app-body"))},listen:function(){var e=this.element,t;$(document).scroll(function(e){return e.preventDefault(),e.stopPropagation(),window.scrollY===25&&(console.log("232323"),t=setInterval(function(){console.log(t),window.scrollTo(0,0)},0)),console.log(window.scrollY),!1}),e.on("touchstart.live","#card-name",function(e){return e.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus(),!1}),this.on("show",function(e){this.element.removeClass("hide");var t=e.height;N[13]=(t-64)/2,g(this.$("#icard")[0],N),this.$(".live-form, .live-gahter").css("min-height",t),this.$("#live-discover").css("opacity",0),this.$("#card-form").css("opacity",0),this.startAnimate()})},createAnimate:function(){var e=this.afrom,t=this.ato,n=this.$("#icard")[0],r=this.$("#card-form")[0],i=this.$("#live-discover")[0],s=N[13],o=T[13],u=T.slice(0),a=this.a=(new c.Tween({o:0})).to({o:1},500).easing(c.Easing.Cubic.In).onStart(function(){}).onUpdate(function(){i.style.opacity=this.o,u[13]=(s-o)*(1-this.o)+o,g(n,u)}),f=this.b=(new c.Tween({o:0})).delay(250).to({o:1},500).onUpdate(function(){r.style.opacity=this.o})},startAnimate:function(){!this.a&&!this.b&&this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}}),F=e("lightsaber"),I=F();I.use(k.setHtmlHeight),I.use(k.checkSMSToken),I.use(k.cleanup),I.initRouter(),I.controllers={};var q;I.controllers.footer=new _({countDown:5e5,element:$("#app-footer"),init:function(){this.listen()},listen:function(){var e=this,t=e.element;t.on("click.footer",".redirecting, .web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(){S()}).on("keydown.footer","#email",function(t){if(t.keyCode===13){var n=e.$("#email").val();e.addNotificationIdentity(n)}}).on("click.footer",".subscribe .btn_mail",function(t){var n=e.$("#email").val();e.addNotificationIdentity(n)}),this.on("show",function(e,t,n,r){var i=e.height-86-(t?50:0);this.element.removeClass("hide"),this.element.css("top",i+"px"),this.$(".redirecting").removeClass("hide"),this.emit("start-redirect"),this.$(".error-info").toggleClass("hide",!r),p("show footer bar")}),this.on("show-from-cross",function(e,t,n){this.element.addClass("ft-bg"),this.cross={exfee_id:e,token:t},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),t&&this.$(".subscribe").removeClass("hide"),this.$(".redirecting").removeClass("hide"),this.element.removeClass("hide"),$("#app-footer").addClass("ft-bg"),n?this.emit("start-redirect",n):(this.$(".get-button, .web-version").removeClass("hide"),this.emit("stop-redirect"))}),this.on("start-redirect",function(t){var n=$(".redirecting"),r=n.find(".sec"),i=e.countDown,s;r.text(s=i),q=setInterval(function(){s-=1,s>=1?r.text(s):(clearInterval(q),x(t))},1e3)}),this.on("stop-redirect",function(){$(".redirecting").addClass("hide"),clearInterval(q),q=void 0})},addNotificationIdentity:function(e,t,n){t=this.cross.exfee_id,n=this.cross.token;if(!/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e)){$("#email.email").attr("placeholder","Bad email Address.");return}$.ajax({type:"POST",url:h.api_url+"/Exfee/"+t+"/AddNotificationIdentity"+"?token="+n,data:{provider:"email",external_username:e},success:function(e){e&&e.meta&&e.meta.code===200&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}})}}),I.get(/^\/+(?:\?)?#{0,}$/,L.index),I.get(/^\/+(?:\?)?#live\/?$/,L.live),I.get(/^\/+(?:\?)?#verify\/?$/,L.verify),I.get(/^\/+(?:\?)?#set_password\/?$/,L.setPassword),I.get(/^\/+(?:\?)?#token=([a-zA-Z0-9]{64})\/?$/,L.resolveToken),I.get(/^\/+(?:\?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,L.crossPhoneToken),I.get(/^\/+(?:\?)?#!token=([a-zA-Z0-9]{32})\/?$/,L.crossToken);var R;I.on("launched",function(){function e(){f(e),c.update()}p("app launched"),R=setInterval(function(){var e=v();w&&(e-E>1500&&Math.abs(w-E)<1500?(clearInterval(R),$(".get-button button").html('Open <span class="exfe">EXFE</span> app').removeClass("hide"),$("#app-footer").off("click.footer",".get-button button").on("click.footer",".get-button button",function(){x()})):e-w<2e3&&($(".get-button").removeClass("hide"),$(".redirecting").addClass("hide"))),E=e},500),e()}),I.run(),console.dir(I),window.App=I});