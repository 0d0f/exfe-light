define(function(e,t,n){e("zepto"),e("moment");var r=e("config"),i=e("store"),s=null,o=0,u=+(new Date),a=function(e){var t=window.innerHeight;t>460?t=460:t<350&&(t=350),$("html").css("min-height",t+"px"),$(".dialog-box").css("min-height",window.innerHeight-(e?50:0)+"px"),$(".actions").css("top",t-86-(e?50:0)+"px"),$(".big-x").css("height",t-86-(e?50:0)+"px"),$(".redirecting").unbind("click").bind("click",function(){}),$(".web-version").unbind("click").bind("click",function(){}),$(".get-button button").unbind("click").bind("click",c)},f=function(e){s=setInterval(function(){var t=~~$(".redirecting .sec").html()-1;t>=0?$(".redirecting .sec").html(t):(clearTimeout(s),d(e),$(".actions .error-info").hide())},1e3)},l=function(e){$("#app-main").html('<div class="dialog-box"><div class="big-x"><div class="img"><img width="182" height="182" src="/static/img/exfe.png"/></div></div><div class="actions"><div class="error-info">You just opened an invalid link.</div><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button><div class="redirecting">Redirecting to EXFE app in <span class="sec">5</span>s.</div></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div></div>'),e?$(".actions .error-info").show():$(".actions .error-info").hide(),a(),f()},c=function(){window.location="itms://itunes.apple.com/us/app/facebook/id514026604"},h=function(e){window.location="exfex://crosses/"+(e?e:"")},p=setInterval(function(){var e=+(new Date);o&&(e-u>1500&&Math.abs(o-u)<1500?(clearTimeout(p),$(".get-button button").html('Open <span class="exfe">EXFE</span> app'),$(".get-button button").unbind("click").bind("click",h)):e-o<2e3&&($(".get-button button").show(),$(".redirecting").hide())),u=e},500),d=function(e){o=+(new Date),h(e)},v=function(e){$("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="base-info"><span class="by"></span> sends you an invitation, engage in easily with <span class="exfe">EXFE</span> app.</div><div class="cross"><div class="title"></div><div class="time"></div><div class="place"></div></div><div class="actions"><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button><div class="redirecting">Redirecting to EXFE app in <span class="sec">5</span>s.</div></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div></div>'),a(!0);var t=i.get("cats");t||(t={});var n={};t[e]?n={cross_access_token:t[e]}:n={invitation_token:e},$.ajax({type:"post",url:r.api_url+"/Crosses/GetCrossByInvitationToken",data:n,success:function(n){if(n&&(n=JSON.parse(n))&&n.meta.code===200){$(".cross .title").html(n.response.cross.title),$(".cross .time").html(m(n.response.cross.time)),$(".cross .place").html(n.response.cross.place.title);var r=0;n.response.authorization?r=n.response.authorization.user_id:n.response.browsing_identity.connected_user_id&&(r=n.response.browsing_identity.connected_user_id);if(r===0)$(".base-info .by").hide();else for(var s in n.response.cross.exfee.invitations){if(n.response.cross.exfee.invitations[s].identity.connected_user_id===r){$(".base-info .by").html(n.response.cross.exfee.invitations[s].by_identity.name),$(".base-info .by").show();break}$(".base-info .by").hide()}var o="?read_only="+n.response.read_only+(n.response.action?"&action="+n.response.action:"")+"&invitation_token="+e;typeof n.response.cross_access_token!="undefined"&&(o+="&cross_access_token="+n.response.cross_access_token,t[e]=n.response.cross_access_token,i.set("cats",t)),typeof n.authorization!="undefined"&&(o+="&token"+n.response.authorization.token,i.set("authorization",n.response.authorization)),f(o);return}l(!0)},error:function(){l(!0)}})},m=function(t){function n(e){return e?e.replace(/^\s+|\s+$/g,""):""}function r(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function i(){var e=Date().toString(),t=e.replace(/^.+([+-]\d{2})(\d{2}).+$/i,"$1:$2"),n=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return n=n==="UTC"||n==="GMT"?"":n,t+(n===e?"":" "+n)}function s(e){if(e=n(e)){var t=e.split(":");if(t.length===2){var r=parseInt(t[0],10)*60*60,i=parseInt(t[1],10)*60;return r+(r>0?i:-i)}}return null}var o=e("eftime"),u=s(t.begin_at.timezone),a=s(i()),f=u===a&&e("config").timevalid,l="",c="",h="YYYY-MM-DD",p="";if(t.origin){var d=t.begin_at.date,v=t.begin_at.time,m=t.begin_at.timezone;if(t.outputformat)l=p,c=r(t.origin);else if(d&&v){var g=new Date,y=d.match(/^\d\d\d\d/m),b=moment((moment.utc(t.begin_at.date+" "+t.begin_at.time,h+" HH:mm:ss").unix()+(f?0:u-a))*1e3);l=b.format("h:mmA on ddd, MMM D"+(y&&y[0]==g.getFullYear()?"":" YYYY"))+(f?"":" "+t.begin_at.timezone),c=o.timeAgo(d+" "+v+" Z",undefined,"X")}else if(d&&!v){var g=new Date,y=d.match(/^\d\d\d\d/m);l=moment(d).format("On ddd, MMM D"+(y&&y[0]==g.getFullYear()?"":" YYYY"))+(f?"":" "+Cross.time.begin_at.timezone),g=new Date(g.getFullYear(),g.getMonth(),g.getDate()),c=o.timeAgo(d+" "+m[0]+m[1]+m[2]+m[4]+m[5],+g),c==="Seconds ago"&&(c="Today")}else!d&&v&&(l="",c=v)}else l=p,c="Sometime";return l?l:r(t.origin)},g=function(e,t){$("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><span class="name">Steve Exfer</span></div><div><input type="password" id="password" placeholder="Set EXFE Password" /><div><div class="error-info"></div><div class="done-info"><span class="status">Password set successfully.</span><span class="redirecting">Redirecting to app in <span class="sec">5</span>s.</span></div></div><div class="actions"><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div><div>'),a(!0),$.ajax({type:"post",url:r.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(e){if(e&&(e=JSON.parse(e))&&e.meta.code===200){$(".identity .avatar").attr("src",e.response.user.avatar_filename),$(".identity .name").html(e.response.user.name);return}l(!0)},error:function(){l(!0)}}),$("#password").bind("keydown",function(e){if(e.which===13){var n=$("#password").val();n.length>=4?$.ajax({type:"post",url:r.api_url+"/Users/ResetPassword",data:{token:t,password:n},success:function(e){if(e&&(e=JSON.parse(e))&&e.meta.code===200&&e.response.authorization){$(".done-info").show(),f("?user_id="+e.response.authorization.user_id+"&token="+e.response.authorization.token);return}$(".error-info").html("Failed to set password. Please try later.").show()},error:function(){$(".error-info").html("Failed to set password. Please try later.").show()}}):$(".error-info").html("Password must be longer than four!").show()}else $(".error-info").hide()})},y=function(e){$("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><img class="provider" width="18" height="18" src="" /><span class="name"></span></div><div class="done-info"><span class="status">Verification succeeded.</span><span class="redirecting">Redirecting to app in <span class="sec">5</span>s.</span></div></div><div class="space"></div><div class="actions"><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div><div>'),a(!0),$.ajax({type:"post",url:r.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)for(var n in t.response.user.identities)if(t.response.user.identities[n].id===e.identity_id){$(".identity .avatar").attr("src",t.response.user.identities[n].avatar_filename),$(".identity .provider").attr("src","/static/img/identity_"+t.response.user.identities[n].provider+"_18_grey@2x.png"),$(".identity .name").html(t.response.user.identities[n].external_username),$(".done-info").show(),f("?user_id="+t.response.user.user_id+"&token="+e.token);return}l(!0)},error:function(){l(!0)}})},b=function(e){$.ajax({type:"post",url:r.api_url+"/Users/ResolveToken",data:{token:e},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)switch(t.response.action){case"VERIFIED":y(t.response);return;case"INPUT_NEW_PASSWORD":g(t.response,e);return}l(!0)},error:function(){l(!0)}})},w=document.location.hash.replace(/^#/,"");if(w){w=w.split("/");for(var E=0;E<w.length;E++){if(w[E].match(/^token=.*/)){b(w[E].replace(/^token=(.*)/,"$1",w[E]));return}if(w[E].match(/^\!token=.*/)){v(w[E].replace(/^\!token=(.*)/,"$1",w[E]));return}l(!0);return}}l()});