define(function(e,t,n){e("zepto"),e("moment");var r=e("config"),i=e("store"),s=null,o=0,u=null,a=0,f="",l=+(new Date),c=function(e){return e?e.replace(/^\s+|\s+$/g,""):""},h=function(e,t){var n=window.innerHeight;n>460?n=460:n<350&&(n=350),$("html").css("min-height",n+"px"),$(".dialog-box").css("min-height",window.innerHeight-(e?50:0)+"px"),t||$(".actions").css("top",n-86-(e?50:0)+"px"),$(".big-x").css("height",n-86-(e?50:0)+"px"),navigator.userAgent.match(/iPad/)?($(".redirecting").unbind("click").bind("click",function(){location.href="/?ipad"+location.hash}),$(".web-version").unbind("click").bind("click",function(){location.href="/?ipad"+location.hash}).show()):$(".web-version").hide(),$(".get-button button").unbind("click").bind("click",m)},p=function(e){$(".redirecting").show(),s=setInterval(function(){var t=~~$(".redirecting .sec").html()-1;t>=0?$(".redirecting .sec").html(t):(clearTimeout(s),b(e),$(".actions .error-info").hide())},1e3)},d=function(e){var t=["home","x","verify"];for(var n in t)$("body").toggleClass(t[n],t[n]===e)},v=function(e){d("home"),$("#app-main").html('<div class="dialog-box"><div class="big-x"><div class="img"><img width="182" height="182" src="/static/img/exfe.png"/></div></div><div class="actions"><div class="error-info">You just opened an invalid link.</div><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button><div class="redirecting">Redirecting to EXFE app in <span class="sec">5</span>s.</div></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div></div>'),e?$(".actions .error-info").show():$(".actions .error-info").hide(),h(),p()},m=function(){window.location="itms://itunes.apple.com/us/app/exfe/id514026604"},g=function(e){window.location="exfe://crosses/"+(e?e:"")},y=setInterval(function(){var e=+(new Date);o&&(e-l>1500&&Math.abs(o-l)<1500?(clearTimeout(y),$(".get-button button").html('Open <span class="exfe">EXFE</span> app'),$(".get-button button").unbind("click").bind("click",g)):e-o<2e3&&($(".get-button button").show(),$(".redirecting").hide())),l=e},500),b=function(e){o=+(new Date),g(e)},w=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},E=function(e,t){d("x"),$("#app-main").html('<div class="cross redirecting">Redirecting to <span class="exfe_blue3">EXFE</span> app in <span class="sec">5</span>s.</div><div class="content"><div class="title_area"><div class="title_text"></div><div class="inviter"><span class="inviter_highlight"></span> invites you</div><div class="title_overlay"></div></div><div class="inf_area"><div class="description"><div class="xbtn-more"><span class="rb"></span><span class="lt"></span></div></div><div class="time_area"><div class="time_major"></div><div class="time_minor"></div></div><div class="place_area"><div class="place_major"></div><div class="place_minor"></div><div class="map"></div></div><div class="rsvp_toolbar"><div class="tri"></div><table><tr><td class="rsvp accepted">I\'m in</td><td class="rsvp unavailable">Unavailable</td></tr></table></div><div class="exfee"><table><tr></tr></table></div></div></div><footer><div class="footer-wrap"><div class="footer_frame"><div class="actions" id="cross_actions"><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div></div></div></footer>'),h(!0,!0);var n=i.get("cats");n||(n={});var s={invitation_token:e};n[e]?f=s.cross_access_token=n[e]:t&&(s.cross_id=t),$(".rsvp.accepted").bind("click",function(){N("ACCEPTED")}),$(".rsvp.unavailable").bind("click",function(){N("DECLINED")}),$.ajax({type:"post",url:r.api_url+"/Crosses/GetCrossByInvitationToken",data:s,success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200){$(".title_area  .title_text").html(w(t.response.cross.title)),$(".inf_area   .description").prepend(w(t.response.cross.description).replace(/\r\n|\r|\n/g,"<br>")),$(".inf_area .description").height()>130?($(".inf_area .description .xbtn-more").show(),$(".inf_area .description .xbtn-more .rb").show(),$(".inf_area .description .xbtn-more .lt").hide(),$(".inf_area .description").toggleClass("limit",!0).on("click",function(){$(".inf_area .description").hasClass("limit")?($(".inf_area .description").toggleClass("limit",!1),$(".inf_area .description .xbtn-more .rb").hide(),$(".inf_area .description .xbtn-more .lt").show()):($(".inf_area .description").toggleClass("limit",!0),$(".inf_area .description .xbtn-more .rb").show(),$(".inf_area .description .xbtn-more .lt").hide())})):$(".inf_area .description .xbtn-more").hide();var r="Sometime",s="To be decided";if(t.response.cross.time&&t.response.cross.time.begin_at&&t.response.cross.time.begin_at.origin&&t.response.cross.time.begin_at.timezone){var o=S(t.response.cross.time);r=w(o.title),s=w(o.content)}$(".time_area   .time_major").html(r),$(".time_area   .time_minor").html(s);var l="Somewhere",c="To be decided";t.response.cross.place&&t.response.cross.place.title&&(l=w(t.response.cross.place.title),c=w(t.response.cross.place.description).replace(/\r\n|\r|\n/g,"<br>")),$(".place_area .place_major").html(l),$(".place_area .place_minor").html(c);if(t.response.cross.place.lat&&t.response.cross.place.lng){var h=typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio<=2?window.devicePixelRatio:1;$(".place_area .map").css("background-image","url(https://maps.googleapis.com/maps/api/staticmap?center="+t.response.cross.place.lat+","+t.response.cross.place.lng+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+t.response.cross.place.lat+","+t.response.cross.place.lng+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+h+")")}else $(".place_area .map").hide();var d="default.jpg";for(var m=0;m<t.response.cross.widget.length;m++)if(t.response.cross.widget[m].type==="Background"){d=t.response.cross.widget[m].image;break}$(".title_area").css("background","url(/static/img/xbg/"+d+") no-repeat 50% 50%");var g=0;t.response.authorization?g=t.response.authorization.user_id:t.response.browsing_identity.connected_user_id&&(g=t.response.browsing_identity.connected_user_id),typeof t.response.cross_access_token!="undefined"&&(n[e]=t.response.cross_access_token,i.set("cats",n),f=t.response.cross_access_token),$(".inviter").hide();var y=-1,b="";a=t.response.cross.exfee.id;for(m in t.response.cross.exfee.invitations)if(g&&g===t.response.cross.exfee.invitations[m].identity.connected_user_id){y=m,$(".inviter .inviter_highlight").html(w(t.response.cross.exfee.invitations[m].invited_by.name)),$(".inviter").show(),u=t.response.cross.exfee.invitations[m];switch(t.response.cross.exfee.invitations[m].rsvp_status){case"ACCEPTED":b="accepted";break;case"DECLINED":b="declined";break;default:b="pending"}$(".exfee table tbody tr").first().append('<td><div class="portrait me" style="background: url('+t.response.cross.exfee.invitations[m].identity.avatar_filename+'); background-size: 50px 50px;">'+"</div>"+'<div class="portrait_rsvp_me '+b+'">'+"</div>"+(t.response.cross.exfee.invitations[m].mates?'<div class="portrait_mymate">+'+t.response.cross.exfee.invitations[m].mates+"</div>":"")+'<div class="name_me">'+w(t.response.cross.exfee.invitations[m].identity.name)+"</div>"+"</td>");break}var E=["ACCEPTED","INTERESTED","NORESPONSE","IGNORED","DECLINED"],x=null;for(m in E)for(var T in t.response.cross.exfee.invitations){if(t.response.cross.exfee.invitations[T].rsvp_status!==E[m]||y==T)continue;switch(t.response.cross.exfee.invitations[T].rsvp_status){case"ACCEPTED":b="accepted";break;case"DECLINED":b="declined";break;default:b="pending"}x=$(".exfee table tbody tr").last(),x.children().length===5&&$(".exfee table tbody").append("<tr></tr>"),x=$(".exfee table tbody tr").last(),x.append('<td><div class="portrait" style="background: url('+t.response.cross.exfee.invitations[T].identity.avatar_filename+'); background-size: 50px 50px;">'+(t.response.cross.exfee.invitations[T].mates?'<div class="portrait_mate">+'+t.response.cross.exfee.invitations[T].mates+"</div>":"")+"</div>"+'<div class="portrait_rsvp '+b+'">'+"</div>"+'<div class="name">'+w(t.response.cross.exfee.invitations[T].identity.name)+"</div>"+"</td>")}x=$(".exfee table tr").last(),count=5-x.children().length;for(m=0;m<count;m++)x.append("<td></td>");var N=null;typeof t.response.authorization!="undefined"&&(i.set("authorization",t.response.authorization),N=t.response.cross.id+"?user_id="+g+"&token="+t.response.authorization.token+"&identity_id="+t.response.cross.exfee.invitations[m].identity.id,f=t.response.authorization.token),f?($(".rsvp_toolbar").show(),$(".portrait.me").on("click",function(){$(".rsvp_toolbar").toggleClass("rsvp_toolbar_off",!$(".rsvp_toolbar").hasClass("rsvp_toolbar_off"))})):$(".rsvp_toolbar").hide(),p(N);return}v(!0)},error:function(){v(!0)}})},S=function(t){var n=e("humantime"),r=n.printEFTime(t,"X");return r},x=function(e,t){d("verify"),$("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><input type="text" class="name" id="name" placeholder="Set EXFE User Name" /></div><div><input type="password" id="password" placeholder="Set EXFE Password" /><i class="eye icon16-pass-show"></i><img width="18" height="18" class="loading" src="/static/img/loading.gif" /></div><div class="error-info"></div><div class="set-button"><button>Done</button></div><div class="done-info"><span class="status">Password set successfully.</span><span class="redirecting">Redirecting to app in <span class="sec">5</span>s.</span></div></div><div class="actions"><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div></div>'),h(!0),$(".eye").click(function(e){var t=$(this).prev();t.prop("type",function(e,t){return t==="password"?"text":"password"}),$(this).toggleClass("icon16-pass-hide icon16-pass-show")}),$.ajax({type:"post",url:r.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(e){if(e&&(e=JSON.parse(e))&&e.meta.code===200){$(".identity .avatar").attr("src",e.response.user.avatar_filename),$(".identity .name").val(e.response.user.name);return}v(!0)},error:function(){v(!0)}}),$("#password").bind("keydown",function(e){e.which===13?T(t):$(".error-info").html("")}),$(".set-button button").bind("click",function(){T(t)})},T=function(e){$(".loading").show(),$(".eye").hide();var t=c($("#name").val()),n=$("#password").val();n.length>=4?($(".set-button button").prop("disabled",!0),$(".set-button button").toggleClass("disabled",!0),$.ajax({type:"post",url:r.api_url+"/Users/ResetPassword",data:{token:e,name:t,password:n},success:function(e){$(".loading").hide(),$(".eye").show();if(e&&(e=JSON.parse(e))&&e.meta.code===200&&e.response.authorization){$(".error-info").hide(),$(".set-button").hide(),$(".done-info").show(),p("?user_id="+e.response.authorization.user_id+"&token="+e.response.authorization.token);return}$(".loading").hide(),$(".eye").show(),$(".error-info").html("Failed to set password. Please try later.").show(),$(".set-button button").prop("disabled",!1),$(".set-button button").toggleClass("disabled",!1)},error:function(){$(".loading").hide(),$(".eye").show(),$(".error-info").html("Failed to set password. Please try later.").show(),$(".set-button button").prop("disabled",!1),$(".set-button button").toggleClass("disabled",!1)}})):($(".error-info").html("Password must be longer than four!").show(),$(".loading").hide(),$(".eye").show())},N=function(e){var t=[{rsvp_status:e,identity_id:u.identity.id,by_identity_id:u.identity.id}];$(".rsvp_toolbar").addClass("rsvp_toolbar_off");switch(e){case"ACCEPTED":$(".portrait_rsvp_me").toggleClass("accepted",!0),$(".portrait_rsvp_me").toggleClass("declined",!1),$(".portrait_rsvp_me").toggleClass("pending",!1);break;case"DECLINED":$(".portrait_rsvp_me").toggleClass("accepted",!1),$(".portrait_rsvp_me").toggleClass("declined",!0),$(".portrait_rsvp_me").toggleClass("pending",!1);break;default:$(".portrait_rsvp_me").toggleClass("accepted",!1),$(".portrait_rsvp_me").toggleClass("declined",!1),$(".portrait_rsvp_me").toggleClass("pending",!0)}$.ajax({type:"post",url:r.api_url+"/Exfee/"+a+"/Rsvp?token="+f,data:{rsvp:JSON.stringify(t)},success:function(e){},error:function(){alert("RSVP failed!")}})},C=function(e){d("verify"),$("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><img class="provider" width="18" height="18" src="" /><span class="name"></span></div><div class="done-info"><span class="status">Verification succeeded.</span><span class="redirecting">Redirecting to app in <span class="sec">5</span>s.</span></div></div><div class="space"></div><div class="actions"><div class="get-button"><button>Get <span class="exfe">EXFE</span> App <span class="free">free</span></button></div><div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div></div><div>'),h(!0),$.ajax({type:"post",url:r.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)for(var n in t.response.user.identities)if(t.response.user.identities[n].id===e.identity_id){$(".identity .avatar").attr("src",t.response.user.identities[n].avatar_filename),$(".identity .provider").attr("src","/static/img/identity_"+t.response.user.identities[n].provider+"_18_grey@2x.png"),$(".identity .name").html(t.response.user.identities[n].external_username),$(".done-info").show(),p("?user_id="+t.response.user.user_id+"&token="+e.token);return}v(!0)},error:function(){v(!0)}})},k=function(e){$.ajax({type:"post",url:r.api_url+"/Users/ResolveToken",data:{token:e},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)switch(t.response.action){case"VERIFIED":C(t.response);return;case"INPUT_NEW_PASSWORD":x(t.response,e);return}v(!0)},error:function(){v(!0)}})};window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)});if(sms_token){switch(sms_token.action){case"VERIFIED":C(sms_token);return;case"INPUT_NEW_PASSWORD":x(sms_token,sms_token.origin_token);return}v(!0);return}if(sms_token===!1){v(!0);return}var L=document.location.hash.replace(/^#/,"");if(L){L=L.split("/");for(var A=0;A<L.length;A++){if(L[A].match(/^token=.*/)){k(L[A].replace(/^token=(.*)/,"$1",L[A]));return}if(L[A].match(/^\!token=.*/)){E(L[A].replace(/^\!token=(.*)/,"$1",L[A]));return}if(L[A].match(/^\![0-9]{1,}/)&&typeof L[A+1]!="undefined"&&L[A+1].match(/^.{4}/)){E(L[A+1],L[A]);return}v(!0);return}}v()});