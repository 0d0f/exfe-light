define(function(e,t,n){var r=0,i=["ms","moz","webkit","o"];for(var s=0;s<i.length&&!window.requestAnimationFrame;++s)window.requestAnimationFrame=window[i[s]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[s]+"CancelAnimationFrame"]||window[i[s]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,t){var n=(new Date).getTime(),i=Math.max(0,16-(n-r)),s=window.setTimeout(function(){e(n+i)},i);return r=n+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});var o=e("zepto"),u=e("config"),a=e("tween"),f=e("store"),l=e("live"),c=function(){var e=f.get("livecard");if(!e){var t={id:"",name:"",avatar:"",bio:"",identities:[]};e={card:t,latitude:"",longitude:"",accuracy:"",traits:[]};var n=f.get("user");n&&(t.name=n.name,t.avatar=n.avatar_filename,t.bio=n.bio,t.identities=n.identities),f.set("livecard",e)}return e.card.id="",e},h=c(),p=e("util"),d=p.trim,v=p.parseId,m={},g=!1,y=function(e,t,n,r){m[0]=[e*.5-n,t*.88-r],m[1]=[],m[1][0]=[e*.25-5-n,t*.66+30-r],m[1][1]=[e*.5-n,t*.66-r],m[1][2]=[e*.75+5-n,t*.66+30-r],m[2]=[],m[2][0]=[e*.125+5-n,t*.44+40-r],m[2][1]=[e*.375-n,t*.44-r],m[2][2]=[e*.625-n,t*.44-r],m[2][3]=[e*.875-5-n,t*.44+40-r],m[3]=[],m[3][0]=[e*.125-n,t*.22+40-r],m[3][1]=[e*.375-n,t*.22-r],m[3][2]=[e*.625-n,t*.22-r],m[3][3]=[e*.875-n,t*.22+40-r]},b=[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],w=[128,28,0],E=[128,0,0],S,x,T,N,C,k={o:1},L=!1,A=0,O=null,M=0,_=null,D=0,P="",H=5,B=+(new Date),j=function(e,t){var n=window.innerHeight;n>460?n=460:n<350&&(n=350),n+=60,o("html, body").css("min-height",n+"px"),o("body").css("height",n+"px");var r=n-86-(e?50:0);t||o(".actions").css("top",r+"px"),o(".box .inner").css("top",(n-300)/2+"px");var i=document.querySelector(".live-gather");i.style.height=n+"px",o("#icard").css({"-webkit-transform":"translate3d(128px, "+(E[1]=(n-64)/2)+"px, 0)",transform:"translate3d(128px, "+E[1]+"px, 0)"});var s=i.clientWidth,f=i.clientHeight-44,l=32,c=0;y(s,f,l,c),navigator.userAgent.match(/iPad/)?(o(".redirecting").unbind("click").bind("click",function(){location.href="/?ipad"+location.hash}),o(".web-version").unbind("click").bind("click",function(){location.href="/?ipad"+location.hash}).show()):o(".web-version").hide(),o(".get-button button").unbind("click").bind("click",U),ut();var p=o(".card-form .list");o(function(){o(document).on("touchstart.live",".live-gather",function(e){o(e.target).hasClass("live-gather")&&(A===1?(o(".input-item").blur(),A=0,x.stop(),S.stop(),C.start()):A===2&&(o(".live-tip").addClass("live-tip-close"),(new a.Tween({o:0})).delay(288).to({o:1},0).onUpdate(function(){o(".wave").css("opacity",this.o)}).start()))}).on("touchstart.live",".live-tip",function(e){e.preventDefault(),e.stopPropagation(),o(".live-tip").addClass("live-tip-close"),(new a.Tween({o:0})).delay(288).to({o:1},0).onUpdate(function(){o(".wave").css("opacity",this.o)}).start()}).on("touchstart.live",".input-item",function(e){var t=e.target;return L?!1:(t.id==="card-name"&&setTimeout(function(){window.scrollTo(0,0)},0),t.id!=="facebook-identity"&&t.id!=="add-identity"||!!g?o("#add-identity-facebook").addClass("hide"):o("#add-identity-facebook").removeClass("hide"),t.focus(),!1)}).on("focus.live",".input-item",function(e){e.preventDefault(),e.stopPropagation();var t=e.target;return t.id==="card-name"&&setTimeout(function(){window.scrollTo(0,0)},0),t.getAttribute("data-provider")&&o(t).next().removeClass("hidden"),!1}).on("blur.live",".input-item",function(e){var t=e.target,n=t.id;t.getAttribute("data-provider")&&o(t).next().addClass("hidden");if(n==="facebook-identity"&&!g||n==="add-identity"){var r=n==="facebook-identity",i=d(t.value),s;if(!i)return;r&&(i+="@facebook"),s=v(i);var a=o(".card-form .list");s.provider&&a.find('[data-external-username="'+s.external_username+'"]').length===0&&(s.avatar_filename=u.api_url+"/avatar/default?name="+s.name,a.append(rt(s)),r&&(g=!0),at(s),mt()),o("#add-identity-facebook").addClass("hide"),t.value=""}}).on("keydown.live","#add-identity, #facebook-identity",function(e){var t=d(this.value),n=e.keyCode,r=this.id==="facebook-identity",i;if(!t)return;r&&(t+="@facebook");switch(n){case 13:i=v(t);var s=o(".card-form .list");i.provider&&s.find('[data-external-username="'+i.external_username+'"]').length===0&&(i.avatar_filename=u.api_url+"/avatar/default?name="+i.name,s.append(rt(i)),r&&(g=!0),g&&o("#add-identity-facebook").addClass("hide"),mt(),at(i)),this.value=""}}).on("touchstart.live","#icard",function(e){e.preventDefault(),e.stopPropagation();if(A)return;A=1,x.stop(),S.stop(),T.start(),N.start()}).on("tap.live touchstart.live",".btn-start",function(e){e.stopPropagation();var t=vt();setTimeout(function(){o(".input-item").blur()},0);if(t){o(".discover").addClass("hide"),o(".card-form").addClass("hide"),o(".live-title").removeClass("hide");var n=document.getElementById("icard"),r=n.style;n.querySelector(".name").className="name",r.webkitTransform=r.transform="translate3d("+m[0][0]+"px, "+m[0][1]+"px, 0)",A=2,mt()}return!1})}).on("tap.live",".live-title h2",function(e){o(".wave").css("opacity",0),o(".live-tip").removeClass("live-tip-close")}).on("touchstart.live","#facebook-label",function(e){return e.preventDefault(),e.stopPropagation(),document.getElementById("facebook-identity").focus(),!1}).on("touchstart.live",".delete",function(e){var t=o(this).prev(),n=t.attr("data-provider"),r=d(t.val()),i;n==="facebook"&&(g=!1,r+="facebook"),i=v(r),i&&i.provider&&ft(i.external_username),t.blur(),o(this).parents("li").remove()}).on("touchstart.live",".back",function(e){A=0;var t=document.getElementById("icard"),n=t.style;t.querySelector(".name").className="name hide",n.opacity=0,n.webkitTransform=n.transform="translate3d("+E[0]+"px, "+E[1]+"px, 0)",o(".live-title").addClass("hide"),o(".card-other").addClass("hide"),o(".box").css("opacity",1),o(".actions").css({opacity:1,"z-index":3}),o(".big-logo").css("opacity",1),S.start()});var b=o(".box .inner").offset(),O=document.querySelector(".big-logo"),M=document.querySelector("#icard"),_=function(){O.style.opacity=k.o,M.style.opacity=1-k.o};S=(new a.Tween(k)).delay(1377).to({o:0},1377).easing(a.Easing.Cubic.InOut).onStart(function(){k.o=1,O.style.opacity=1,M.style.opacity=0,L=!0}).onUpdate(_).onComplete(function(){L=!1}),x=(new a.Tween(k)).delay(1377).to({o:1},1377).easing(a.Easing.Cubic.InOut).onStart(function(){L=!0}).onUpdate(_).onComplete(function(){L=!1}),S.chain(x),x.chain(S),S.start();var D=document.querySelector(".discover"),P=document.querySelector(".card-form");T=(new a.Tween({o:0})).to({o:1},500).easing(a.Easing.Cubic.In).onStart(function(){window.scrollTo(0,0),o(".tap-tip").addClass("hide"),o(".discover").css("opacity",0).removeClass("hide"),o(".card-form").css("opacity",0).removeClass("hide"),M.style.opacity=1,o(".actions").css("z-index",0),L=!0}).onUpdate(function(){o(".box").css("opacity",1-this.o),o(".actions").css("opacity",1-this.o),D.style.opacity=this.o,M.style.transform=M.style.webkitTransform="translate3d(128px, "+((E[1]-w[1])*(1-this.o)+w[1])+"px, 0)"}).onComplete(function(){this.o=0,L=!1,a.remove(this)}),N=(new a.Tween({o:0})).delay(250).to({o:1},500).onStart(function(){document.getElementById("card-name").value=h.card.name,L=!0}).onUpdate(function(){P.style.opacity=this.o}).onComplete(function(){this.o=0,L=!1,a.remove(this)}),C=(new a.Tween({o:1})).to({o:0},500).easing(a.Easing.Cubic.Out).onStart(function(){L=!0}).onUpdate(function(){P.style.opacity=this.o,M.style.opacity=this.o,o(".box").css("opacity",1-this.o),o(".actions").css("opacity",1-this.o),o(".big-logo").css("opacity",1-this.o),D.style.opacity=this.o}).onComplete(function(){this.o=1,M.style.transform=M.style.webkitTransform="translate3d(128px, "+E[1]+"px, 0)",S.start(),o(".discover").addClass("hide"),o(".tap-tip").removeClass("hide"),o(".card-form").addClass("hide"),o(".actions").css("z-index",3),L=!1,a.remove(this)})},F=function(e){var t=o(".redirecting"),n=t.find(".sec");t.show(),O=setInterval(function(){var t=~~n.html()-1;t>=0?n.html(t):(clearInterval(O),X(e),o(".actions .error-info").hide())},1e3)},I=function(){o(".redirecting").hide(),o("footer").hide()},q=function(e){var t=["home","x","verify"],n=o("body");for(var r=0,i=t.length;r<i;++r)n.toggleClass(t[r],t[r]===e)},R=function(e){q("home"),o("#app-main").html('<div class="dialog-box"><div class="box"><div class="title"><h1>EXFE</h1><p>A utility for gathering with friends.</p></div><div class="inner"><img class="big-logo" width="320" height="300" src="/static/img/EXFE_glossy@2x.png"/></div></div><div class="actions"><div class="error-info">You just opened an invalid link.</div><div class="get-button"><button>Get <span class="exfe">EXFE</span> app <span class="free">free</span></button><div class="redirecting">Redirecting to EXFE app in <span class="sec">'+H+"</span>s.</div>"+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+'<div class="live-gather">'+'<div class="live-title hide">'+'<div class="back"><img width="20" height="44" src="/static/img/back@2x.png" alt="" /></div>'+'<h2>Live <span class="x">路X路</span></h2>'+'<div id="live-tip" class="live-tip live-tip-close">'+"<h4>Gather people nearby</h4>"+"<p>Close two phones together to capture people using Live 路X路. For those accessing exfe.com, max their speaker volume.</p>"+"</div>"+'<div id="wave" class="wave"><div class="win">'+'<div class="circle"></div>'+'<div class="circle"></div>'+'<div class="circle"></div></div>'+"</div>"+"</div>"+'<div class="discover hide">Discover people nearby and share contacts.</div>'+'<div id="icard" class="card" data-g="0" data-i="0">'+'<div class="avatar"></div>'+'<div class="name hide"></div>'+'<div class="tap-tip">Tap to start</div>'+"</div>"+'<div class="card-form hide">'+'<div class="controls" style="-webkit-transform: matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1); -webkit-backface-visibility: hidden;">'+'<input class="input-item" type="text" autocapitalize="none" tabindex="1" id="card-name" placeholder="Name"/>'+'<button class="btn btn-start" type="button">Start</button>'+"</div>"+'<div class="hide" id="card-bio"></div>'+'<div class="identities"><ul class="list"></ul>'+'<input class="input-item" id="add-identity" autocapitalize="none" data-status="1" type="email" placeholder="Add your email or mobile" />'+'<div class="identity facebook-identity hide" id="add-identity-facebook">'+'<label id="facebook-label" for="facebook-identity">facebook.com/'+'<input name="facebook-identity" autocapitalize="off" id="facebook-identity" class="input-item" type="text" /></label>'+"</div>"+'<div class="detail detail-invent hide">The best way to predict the future is to invent it.</div>'+'<div class="detail detail-concat">*People nearby can see your public contacts.</div>'+"<div>"+"</div>"+"</div>"+"</div>"),e?o(".actions .error-info").show():o(".actions .error-info").hide(),j(),F()},U=function(){window.location="itms://itunes.apple.com/us/app/exfe/id514026604"},z=function(e){window.location="exfe://crosses/"+(e?e:"")},W=setInterval(function(){var e=+(new Date);M&&(e-B>1500&&Math.abs(M-B)<1500?(clearTimeout(W),o(".get-button button").html('Open <span class="exfe">EXFE</span> app'),o(".get-button button").unbind("click").bind("click",z)):e-M<2e3&&(o(".get-button button").show(),o(".redirecting").hide())),B=e},500),X=function(e){M=+(new Date),z(e)},V=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},$=function(e,t){q("x"),o("#app-main").html('<div class="cross redirecting">Redirecting to <span class="exfe_blue3">EXFE</span> app in <span class="sec">'+H+"</span>s.</div>"+'<div class="content">'+'<div class="title_area">'+'<div class="title_wrap_a">'+'<div class="title_wrap_b">'+'<div class="title_text"></div>'+"</div>"+"</div>"+'<div class="inviter"><div class="ribbon"></div><div class="textoverflow">Invited by <span class="inviter_highlight"></span></div></div>'+'<div class="title_overlay"></div>'+"</div>"+'<div class="inf_area">'+'<div class="description"><div class="xbtn-more"><span class="rb"></span><span class="lt"></span></div></div>'+'<div class="time_area">'+'<div class="time_major"></div>'+'<div class="time_minor"></div>'+"</div>"+'<div class="place_area">'+'<div class="place_major"></div>'+'<div class="place_minor"></div>'+'<a class="map_link" href="#">'+'<div class="map">'+'<img class="place_mark" src="http://img.exfe.com/web/map_pin_blue@2x.png">'+"</div>"+"</a>"+"</div>"+'<div class="rsvp_toolbar rsvp_toolbar_off">'+'<div class="tri"></div>'+"<table>"+"<tr>"+'<td class="rsvp accepted">I\'m in</td>'+'<td class="rsvp unavailable">Unavailable</td>'+"</tr>"+"</table>"+"</div>"+'<div class="exfee"><table><tr></tr></table></div>'+"</div>"+"</div>"+"<footer>"+'<div class="footer-wrap">'+'<div class="footer_frame">'+'<div class="actions" id="cross_actions">'+'<div class="subscribe">Subscribe to updates and engage in:'+'<div class="subscribe-frame">'+'<input type="text" class="email" id="email" placeholder="Enter your email">'+'<button class="btn_mail"></button>'+"</div>"+"</div>"+'<div class="get-button">'+'<button class="btn_w">Get <span class="exfe">EXFE</span> app <span class="free">free</span></button>'+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+"</div>"+"</div>"+"</footer>"),j(!0,!0);var n=f.get("cats");n||(n={});var r={invitation_token:e};n[e]?P=r.cross_access_token=n[e]:t&&(r.cross_id=t),o(".rsvp.accepted").bind("click",function(){Y("ACCEPTED")}),o(".rsvp.unavailable").bind("click",function(){Y("DECLINED")}),o.ajax({type:"post",url:u.api_url+"/Crosses/GetCrossByInvitationToken",data:r,success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200){o(".title_area  .title_text").html(V(t.response.cross.title)),o(".inf_area   .description").prepend(V(t.response.cross.description).replace(/\r\n|\r|\n/g,"<br>")),o(".inf_area .description").height()>130?(o(".inf_area .description .xbtn-more").show(),o(".inf_area .description .xbtn-more .rb").show(),o(".inf_area .description .xbtn-more .lt").hide(),o(".inf_area .description").toggleClass("limit",!0).on("click",function(){o(".inf_area .description").hasClass("limit")?(o(".inf_area .description").toggleClass("limit",!1),o(".inf_area .description .xbtn-more .rb").hide(),o(".inf_area .description .xbtn-more .lt").show()):(o(".inf_area .description").toggleClass("limit",!0),o(".inf_area .description .xbtn-more .rb").show(),o(".inf_area .description .xbtn-more .lt").hide())})):o(".inf_area .description .xbtn-more").hide(),t.response.cross.description||o(".time_area").addClass("no_prepend");var r="Sometime",i="To be decided";if(t.response.cross.time&&t.response.cross.time.begin_at&&t.response.cross.time.begin_at.origin&&t.response.cross.time.begin_at.timezone){var s=K(t.response.cross.time);r=V(s.title),i=V(s.content)}else o(".time_area .time_minor").toggleClass("time_tobe",!0);o(".time_area   .time_major").html(r),o(".time_area   .time_minor").html(i);var a="Somewhere",l="To be decided";t.response.cross.place&&t.response.cross.place.title?(a=V(t.response.cross.place.title),l=V(t.response.cross.place.description).replace(/\r\n|\r|\n/g,"<br>")):o(".place_area .place_minor").toggleClass("place_tobe",!0),o(".place_area .place_major").html(a),o(".place_area .place_minor").html(l);if(t.response.cross.place.lat&&t.response.cross.place.lng){var c=typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio<=2?window.devicePixelRatio:1;o(".place_area .map").css("background-image","url(https://maps.googleapis.com/maps/api/staticmap?center="+t.response.cross.place.lat+","+t.response.cross.place.lng+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+t.response.cross.place.lat+","+t.response.cross.place.lng+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+c+")"),o(".map_link").attr("href","http://maps.google.com/maps?daddr="+encodeURIComponent(a)+"@"+t.response.cross.place.lat+","+t.response.cross.place.lng)}else o(".place_area .map").hide();var h="default.jpg";for(var p=0;p<t.response.cross.widget.length;p++)if(t.response.cross.widget[p].type==="Background"){h=t.response.cross.widget[p].image;break}o(".title_area").css("background","url(/static/img/xbg/"+h+") no-repeat 50% 50%");var d=0,v=0;t.response.authorization?(d=t.response.authorization.user_id,t.response.browsing_identity&&(v=t.response.browsing_identity.id)):t.response.browsing_identity&&t.response.browsing_identity.connected_user_id>0&&(d=t.response.browsing_identity.connected_user_id,v=t.response.browsing_identity.id),typeof t.response.cross_access_token!="undefined"&&(n[e]=t.response.cross_access_token,f.set("cats",n),P=t.response.cross_access_token),o(".inviter").hide();var m=-1,g="";D=t.response.cross.exfee.id;for(p in t.response.cross.exfee.invitations)if(d&&d===t.response.cross.exfee.invitations[p].identity.connected_user_id||v===t.response.cross.exfee.invitations[p].identity.id){m=p,v=t.response.cross.exfee.invitations[p].identity.id,o(".inviter .inviter_highlight").html(V(t.response.cross.exfee.invitations[p].invited_by.name)),o(".inviter").show(),_=t.response.cross.exfee.invitations[p];switch(t.response.cross.exfee.invitations[p].rsvp_status){case"ACCEPTED":g="accepted";break;case"DECLINED":g="declined";break;default:g="pending"}o(".exfee table tbody tr").first().append('<td><div class="portrait me" style="background: url('+t.response.cross.exfee.invitations[p].identity.avatar_filename+'); background-size: 50px 50px;">'+"</div>"+'<div class="portrait_rsvp_me '+g+'">'+"</div>"+(t.response.cross.exfee.invitations[p].mates?'<div class="portrait_mymate">+'+t.response.cross.exfee.invitations[p].mates+"</div>":"")+'<div class="name_me textcut">'+V(t.response.cross.exfee.invitations[p].identity.name)+"</div>"+"</td>");break}var y=["ACCEPTED","INTERESTED","NORESPONSE","IGNORED","DECLINED"],b=null;for(p in y)for(var w in t.response.cross.exfee.invitations){if(t.response.cross.exfee.invitations[w].rsvp_status!==y[p]||m==w)continue;switch(t.response.cross.exfee.invitations[w].rsvp_status){case"ACCEPTED":g="accepted";break;case"DECLINED":g="declined";break;default:g="pending"}b=o(".exfee table tbody tr").last(),b.children().length===5&&o(".exfee table tbody").append("<tr></tr>"),b=o(".exfee table tbody tr").last(),b.append('<td><div class="portrait" style="background: url('+t.response.cross.exfee.invitations[w].identity.avatar_filename+'); background-size: 50px 50px;">'+(t.response.cross.exfee.invitations[w].mates?'<div class="portrait_mate">+'+t.response.cross.exfee.invitations[w].mates+"</div>":"")+"</div>"+'<div class="portrait_rsvp '+g+'">'+"</div>"+'<div class="name textcut">'+V(t.response.cross.exfee.invitations[w].identity.name)+"</div>"+"</td>")}b=o(".exfee table tr").last(),count=5-b.children().length;for(p=0;p<count;p++)b.append("<td></td>");var E=null;if(d)if(typeof t.response.authorization!="undefined")f.set("authorization",t.response.authorization),E=t.response.cross.id+"?user_id="+d+"&token="+t.response.authorization.token+"&identity_id="+v,P=t.response.authorization.token;else{var S=f.get("authorization");S&&typeof S.user_id!="undefined"&&S.user_id===d&&(E=t.response.cross.id+"?user_id="+d+"&token="+S.token+"&identity_id="+v,P=S.token)}P&&m!==-1?(t.response.cross.exfee.invitations[m].identity.id===t.response.cross.exfee.invitations[m].invited_by.id?o(".inviter").hide():o(".rsvp_toolbar").toggleClass("rsvp_toolbar_off",!1),o(".portrait.me").on("click",function(){o(".rsvp_toolbar").toggleClass("rsvp_toolbar_off",!o(".rsvp_toolbar").hasClass("rsvp_toolbar_off"))}),t.response.cross.exfee.invitations[m].identity.provider==="phone"&&(o(".rsvp_toolbar tr").append('<td class="rsvp changename">Change my display name</td>'),o(".rsvp_toolbar td").css("width","98px"),o(".changename").on("click",function(){var e=prompt("Change my display name:");e!==null&&(e===""?alert("Display name cannot be empty."):o.ajax({type:"post",url:u.api_url+"/Identities/"+t.response.cross.exfee.invitations[m].identity.id+"/Update"+"?token="+P,data:{name:e},success:function(e){e&&(e=JSON.parse(e))&&e.meta.code===200&&o(".name_me").html(V(e.response.identity.name))},error:function(){alert("Failed, please retry later.")}}))}),o(".subscribe").show(),o("#email.email").on("keyup",function(e){e.keyCode===13&&J(t)}),o(".subscribe .btn_mail").on("click",function(){J(t)}))):o(".inviter").hide(),E?F(E):I();return}R(!0)},error:function(){R(!0)}})},J=function(e){var t=o("#email.email").val();if(!/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(t)){o("#email.email").attr("placeholder","Bad email Address.");return}o.ajax({type:"post",url:u.api_url+"/Exfee/"+e.response.cross.exfee.id+"/AddNotificationIdentity"+"?token="+P,data:{provider:"email",external_username:t},success:function(e){e&&(e=JSON.parse(e))&&e.meta.code===200&&o(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}})},K=function(t){var n=e("humantime"),r=n.printEFTime(t,"X");return r},Q=function(e,t){q("verify"),o("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><input type="text" class="name" id="name" placeholder="Set EXFE User Name" /></div><div><input type="password" id="password" placeholder="Set EXFE Password" /><i class="eye icon16-pass-show"></i><img width="18" height="18" class="loading" src="/static/img/loading.gif" /></div><div class="error-info"></div><div class="set-button"><button>Done</button></div><div class="done-info"><span class="status">Password set successfully.</span><span class="redirecting">Redirecting to app in <span class="sec">'+H+"</span>s.</span>"+"</div>"+"</div>"+'<div class="actions">'+'<div class="get-button">'+'<button>Get <span class="exfe">EXFE</span> app <span class="free">free</span></button>'+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+"</div>"),j(!0),o(".eye").click(function(e){var t=o(this).prev();t.prop("type",function(e,t){return t==="password"?"text":"password"}),o(this).toggleClass("icon16-pass-hide icon16-pass-show")}),o.ajax({type:"post",url:u.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(e){if(e&&(e=JSON.parse(e))&&e.meta.code===200){o(".identity .avatar").attr("src",e.response.user.avatar_filename),o(".identity .name").val(e.response.user.name);return}R(!0)},error:function(){R(!0)}}),o("#password").bind("keydown",function(e){e.which===13?G(t):o(".error-info").html("")}),o(".set-button button").bind("click",function(){G(t)})},G=function(e){o(".loading").show(),o(".eye").hide();var t=d(o("#name").val()),n=o("#password").val();n.length>=4?(o(".set-button button").prop("disabled",!0),o(".set-button button").toggleClass("disabled",!0),o.ajax({type:"post",url:u.api_url+"/Users/ResetPassword",data:{token:e,name:t,password:n},success:function(e){o(".loading").hide(),o(".eye").show();if(e&&(e=JSON.parse(e))&&e.meta.code===200&&e.response.authorization){o(".error-info").hide(),o(".set-button").hide(),o(".done-info").show(),F("?user_id="+e.response.authorization.user_id+"&token="+e.response.authorization.token);return}o(".loading").hide(),o(".eye").show(),o(".error-info").html("Failed to set password. Please try later.").show(),o(".set-button button").prop("disabled",!1),o(".set-button button").toggleClass("disabled",!1)},error:function(){o(".loading").hide(),o(".eye").show(),o(".error-info").html("Failed to set password. Please try later.").show(),o(".set-button button").prop("disabled",!1),o(".set-button button").toggleClass("disabled",!1)}})):(o(".error-info").html("Password must be longer than four!").show(),o(".loading").hide(),o(".eye").show())},Y=function(e){var t=[{rsvp_status:e,identity_id:_.identity.id,by_identity_id:_.identity.id}];o(".rsvp_toolbar").addClass("rsvp_toolbar_off");switch(e){case"ACCEPTED":o(".portrait_rsvp_me").toggleClass("accepted",!0),o(".portrait_rsvp_me").toggleClass("declined",!1),o(".portrait_rsvp_me").toggleClass("pending",!1);break;case"DECLINED":o(".portrait_rsvp_me").toggleClass("accepted",!1),o(".portrait_rsvp_me").toggleClass("declined",!0),o(".portrait_rsvp_me").toggleClass("pending",!1);break;default:o(".portrait_rsvp_me").toggleClass("accepted",!1),o(".portrait_rsvp_me").toggleClass("declined",!1),o(".portrait_rsvp_me").toggleClass("pending",!0)}o.ajax({type:"post",url:u.api_url+"/Exfee/"+D+"/Rsvp?token="+P,data:{rsvp:JSON.stringify(t)},success:function(e){},error:function(){alert("RSVP failed!")}})},Z=function(e){q("verify"),o("#app-main").html('<div class="top-banner"><div class="center"><div class="welcome">Welcome to <span class="exfe">EXFE</span></div><div class="exfe-logo"><img src="/static/img/exfe.png" width="30" height="30" /></div></div></div><div class="dialog-box"><div class="verify-actions"><div class="identity"><img class="avatar" width="40" height="40" src="" /><img class="provider" width="18" height="18" src="" /><span class="name"></span></div><div class="done-info"><span class="status">Verification succeeded.</span><span class="redirecting">Redirecting to app in <span class="sec">'+H+"</span>s.</span>"+"</div>"+"</div>"+'<div class="space"></div>'+'<div class="actions">'+'<div class="get-button">'+'<button>Get <span class="exfe">EXFE</span> app <span class="free">free</span></button>'+"</div>"+'<div class="web-version"><span class="underline">Proceed</span> with desktop web version.</div>'+"</div>"+"<div>"),j(!0),o.ajax({type:"post",url:u.api_url+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)for(var n in t.response.user.identities)if(t.response.user.identities[n].id===e.identity_id){o(".identity .avatar").attr("src",t.response.user.identities[n].avatar_filename),o(".identity .provider").attr("src","/static/img/identity_"+t.response.user.identities[n].provider+"_18_grey@2x.png"),o(".identity .name").html(t.response.user.identities[n].external_username),o(".done-info").show(),F("?user_id="+t.response.user.user_id+"&token="+e.token);return}R(!0)},error:function(){R(!0)}})},et=function(e){o.ajax({type:"post",url:u.api_url+"/Users/ResolveToken",data:{token:e},success:function(t){if(t&&(t=JSON.parse(t))&&t.meta.code===200)switch(t.response.action){case"VERIFIED":Z(t.response);return;case"INPUT_NEW_PASSWORD":Q(t.response,e);return}R(!0)},error:function(){R(!0)}})},tt=function(e){e=d(e);var t={id:0,name:"",external_id:"",external_username:"",provider:"",type:"identity"};if(/^[^@]*<[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?>$/.test(e)){var n=e.indexOf("<"),r=e.indexOf(">");t.external_id=d(e.substring(++n,r)),t.external_username=t.external_id,t.name=d(cutLongName(d(e.substring(0,n)).replace(/^"|^'|"$|'$/g,""))),t.provider="email"}else if(/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e))t.external_id=e,t.external_username=e,t.name=d(cutLongName(e.split("@")[0])),t.provider="email";else if(/^@[a-z0-9_]{1,15}$|^@[a-z0-9_]{1,15}@twitter$|^[a-z0-9_]{1,15}@twitter$/i.test(e))t.external_id="",t.external_username=e.replace(/^@|@twitter$/ig,""),t.name=t.external_username,t.provider="twitter";else if(/^[a-z0-9\.]{5,}@facebook$/i.test(e))t.external_id="",t.external_username=e.replace(/@facebook$/ig,""),t.name=t.external_username,t.provider="facebook";else{if(!/^\+[\d\-]{5,15}$/.test(e))return null;e=e.replace(/\-|\(|\)|\ /g,""),t.external_id=e,t.external_username=e,t.name=e.replace(/^.*([\d]{4})$/,"$1"),t.provider="phone"}return t.avatar_filename=encodeURI(u.api_url+"/avatar/default?name="+t.name),t},nt='<li class="identity" style="-webkit-transform: translate3d(0, 0, 0);"><span class="provider">{{provider_alias}}</span><input data-provider="{{provider}}" style="-webkit-transform: translate3d(0, 0, 0);" autocapitalize="none" class="external_username input-item normal" value="{{external_username}}" type="email"/><div class="delete hidden">x</div></li>',rt=function(e,t){var n=e.provider;n==="email"?n="Email":n==="phone"?n="Mobile":n==="facebook"&&(n="Facebook");var r=o(nt.replace(/\{\{provider\}\}/g,e.provider).replace(/\{\{provider_alias\}\}/g,n).replace(/\{\{external_username\}\}/g,e.external_username));return r.data("card",e),r},it=function(e){var t='<div class="tip">',n="</div>";t+='<div class="bio">'+(e.bio||"")+"</div>";var r=e.identities;t+="<ul>";for(var i=0,s=r;i<s;++i)t+="<li><span>"+r[i].external_username+"</span><span>"+r[i].provider+"</span></li>";return t+="</ul>",t+=n,t},st='<div data-url="{{avatar}}" id="{{id}}" data-g="{{g}}" data-i="{{i}}" class="card card-other hide" style="-webkit-transform: translate3d({{left}}px, {{top}}px, 0); opacity: 1;"><div class="avatar" style="background-image: url({{avatar}})"></div><div class="name">{{name}}</div>{{tip-html}}</div>',ot=function(e,t,n,r){var i=o(st.replace(/\{\{avatar\}\}/g,e.avatar).replace("{{id}}",e.id).replace("{{g}}",n).replace("{{i}}",r).replace("{{name}}",e.name).replace("{{left}}",t[0]).replace("{{top}}",t[1]).replace("{{tip-html}}",it(e)));return i.data("card",e),i},ut=function(){var e=h.card,t=e.identities,n;ht(e);if(t&&(n=t.length)){var r=o(".card-form").find(".list"),i=0,s;for(;i<n;++i)s=t[i],(s.provider==="email"||s.provider==="phone")&&r.append(rt(t[i]))}},at=function(e){var t=h.card.identities;t.push(e),f.set("livecard",h)},ft=function(e){var t=h.card.identities,n=t.length,r=0,i;for(;r<n;++r)if(t[r].external_username===e){i=!0,t.splice(r,1);break}i&&f.set("livecard",h)},lt=function(e){var t=e.getAttribute("data-g"),n=e.getAttribute("data-i"),r=e.style,i=r.transform||r.webkitTransform;(new a.Tween({o:1})).to({o:0},233).easing(a.Easing.Cubic.Out).onUpdate(function(){r.opacity=this.o,r.transform=r.webkitTransform=i+" scale("+this.o+","+this.o+")"}).onComplete(function(){b.unshift([t,n]),e.remove(),a.remove(this)}).start()},ct=function(e){var t=b.shift(),n=t[0],r=t[1],i=m[n][r],s=ot(e,i,n,r),u=s[0],f=u.style,l=f.transform||f.webkitTransform;o("#icard").before(s),(new a.Tween({o:0})).to({o:1},233).easing(a.Easing.Bounce.In).onStart(function(){s.removeClass("hide")}).onUpdate(function(){f.opacity=this.o,f.transform=f.webkitTransform=l+" scale("+this.o+","+this.o+")"}).onComplete(function(){a.remove(this)}).start()},ht=function(e){var t=document.getElementById("icard"),n=t.getAttribute("data-url");h.card=e,n!==e.avatar&&(n=e.avatar,n||(n=e.name?u.api_url+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),t.querySelector(".avatar").style.backgroundImage="url("+n+")",t.setAttribute("data-url",n)),e.name&&(t.querySelector(".name").innerText=e.name),e.bio&&(document.getElementById("card-bio").innerText=e.bio),f.set("livecard",h)},pt=function(e,t){var n=e.getAttribute("data-url");n!==t.avatar&&(n=t.avatar,n||(n=t.name?u.api_url+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),e.querySelector(".avatar").style.backgroundImage="url("+n+")",e.setAttribute("data-url",n)),e.querySelector(".name").innerText=t.name},dt=function(e){var t=document.querySelectorAll(".card-other"),n=t.length,r=0,i,s,o,u;for(;r<n;++r)i=t[r],s=i.getAttribute("id"),s in e||lt(i);for(o in e)u=e[o],i=document.getElementById(u.id),i?pt(i,u):ct(u)},vt=function(){var e=d(o("#card-name").val()),t=!1;if(!e)return t;var n=h.card;n.name=e,ht(n);var r=o(".list .input-item"),i=[];for(var s=0,u=r.length;s<u;++s){var a=r.eq(s),l=d(a.val()),c=a.attr("data-provider");if(l){c==="facebook"&&(l+="@facebook");var p=v(l);p&&p.provider&&i.push(p)}}return i.length&&(n.identities=i,t=!0),f.set("livecard",h),t},mt=function(){var e=h.card;e.identities.length&&l.init(e,gt)},gt=function(e){e.me&&ht(e.me),e.others&&(dt(e.others),A==2?o(".card-other").removeClass("hide"):o(".card-other").addClass("hide"))};window.addEventListener("load",function(){function e(){requestAnimationFrame(e),a.update()}function t(){try{var e=typeof window.localStorage!="undefined";return e&&(window.localStorage.setItem("storage",0),window.localStorage.removeItem("storage")),e}catch(t){return!1}}e(),setTimeout(function(){window.scrollTo(0,0)},0),t()||alert("EXFE cannot be used in private browsing mode.")});if(sms_token){switch(sms_token.action){case"VERIFIED":Z(sms_token);return;case"INPUT_NEW_PASSWORD":Q(sms_token,sms_token.origin_token);return}R(!0);return}if(sms_token===!1){R(!0);return}var yt=document.location.hash.replace(/^#/,"");if(yt){yt=yt.split("/");for(var bt=0;bt<yt.length;bt++){if(yt[bt].match(/^token=.*/)){et(yt[bt].replace(/^token=(.*)/,"$1",yt[bt]));return}if(yt[bt].match(/^\!token=.*/)){$(yt[bt].replace(/^\!token=(.*)/,"$1",yt[bt]));return}if(yt[bt].match(/^\![0-9]{1,}/)&&typeof yt[bt+1]!="undefined"&&yt[bt+1].match(/^.{4}/)){$(yt[bt+1],yt[bt].replace(/^\!(.*)/,"$1",yt[bt]));return}if(yt[bt].match(/^here/)){here();return}R(!0);return}}R()});