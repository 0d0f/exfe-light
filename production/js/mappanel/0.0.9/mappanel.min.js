define("mappanel",function(e){"use strict";var t=e("jquery"),i=t.proxy,s=t.extend,a=window._ENV_,n=a.MAP_KEY,r=a.location,l=a.site_url,o=e("humantime").lead0,c=e("rex"),h=/[\r\n]+/g,p="\r",m=window.navigator.geolocation,d=t(window),u=t.browser.msie,f=!1,g=e("panel"),v=g.extend({options:{template:'<div class="panel map-panel" tabindex="-1" data-widget="panel" id="map-panel"><div class="panel-body"><div class="map-container"><div class="gmap-wrap"><div class="map-box" id="gmap"></div></div><div class="map-mask"></div><div class="map-resize"><span class="expand">Expand</span><span class="compact">Compact</span><span class="rb"></span><span class="lt"></span></div><div class="map-place"><div class="place-editor"><i class="pointer icon-enter-blue place-submit"></i><div class="place-filter"></div><textarea class="normal" name="place-text" id="place-text" placeholder="Enter place here."></textarea></div><div class="map-places hide"><ul class="unstyled places-list" tabindex="-1"></ul></div></div></div></div></div>',parentNode:null,srcNode:null,place:null},isGeoSupported:!!m,setGeos:function(e,t,i){this.xmap.initMap(e,t,i)},init:function(){var e,t=this.options;this.render(),e=this.element,this.originPlace=t.place,this.place=s({},t.place),delete t.place,this.placeInput=new k(this,"#place-text"),this.placesList=new M(this,".places-list"),this.xmap=new w(this,"#gmap"),this.listen(),this.$resize=e.find(".map-resize"),this.$mask=e.find(".map-mask")},listen:function(){var e=this;this.on("update-place",this.update),this.on("change-place",this.change),this.on("geos",this.setGeos),this.on("search-completed",this.searchCompleted),this.on("placeinput-tab",this.placeInputTab),this.on("placeslist-tab",this.placesListTab),this.on("cleanup",function(){e.placesList.clear(),e.xmap.clear()}),this.on("clear-marker",this.clearMarker),this.on("enter-marker",this.enterMarker),this.on("enter-placeitem",this.enterPlaceItem),this.on("click-placeitem",this.clickPlaceItem),this.on("zoom-map",this.zoomMap),this.element.on("click.mappanel",".place-submit",function(){Cross.place=e.place,t("body").trigger("save-cross")}),this.element.on("keydown.mappanel",i(this.keydown,this)),this.element.on("click.mappanel",".map-mask",function(t){t.preventDefault(),e.emit("zoom-map",!1)}),this.element.on("click.mappanel",".map-resize",function(i){i.preventDefault();var s=t(this).hasClass("map-rc");e.emit("zoom-map",s)})},save:function(){this.$(".place-submit").trigger("click.mappanel")},keydown:function(e){var t=this,i=e.altKey,s=e.ctrlKey,a=e.shiftKey,n=e.metaKey,r=e.keyCode;27===r?t.revert():13===r&&!(i|a)&(s|n)?(t.emit("update-place",t.place),t.save()):187===r&&s?t.emit("zoom-map",0):189===r&&s&&t.emit("zoom-map",1)},zoomMap:function(e){this.xmap.zoom(e)},clickPlaceItem:function(e){this.emit("change-place",e,"map"),this.element.focus()},enterPlaceItem:function(e){this.placesList.selectItem(e)},enterMarker:function(e,t){this.xmap.showMarker(e,t)},clearMarker:function(e){this.xmap.saveMarker(e||0)},searchCompleted:function(e,t){this.placesList.update(e,t)},placeInputTab:function(){var e=this.placesList,t=e.$element,i=e.status;i&&setTimeout(function(){t.focus()},0)},placesListTab:function(){var e=this.placeInput.$element;setTimeout(function(){e.focusend()},0)},resetPlace:function(e){return e.title=e.description=e.lat=e.lng=e.external_id=e.provider="",e},change:function(e,t){var i=this.place,s=i.title,a=i.description,n=i.lat,r=i.lng,l=!e.title,o=this.placeInput,c=this.placesList,h=!1,p=this.xmap;i.updated_at=x(new Date),l?(i=this.resetPlace(i),c.clear(),p.clear()):(i.title=e.title,i.description=e.description,i.external_id=e.external_id||"",i.provider=e.provider||"","map"===t||"list"===t?(i.lat=e.lat,i.lng=e.lng,o.change(y(e.title,e.description)),h=!0):"input"===t&&(s===e.title||e.description||(c.clear(),p.textSearch(e.title)))),(s!==e.title||a!==e.description||n!==e.lat||r!==e.lng||h)&&this.emit("update-place",i)},revert:function(){this.emit("update-place",this.originPlace)},showPlace:function(){var e,t,i=this,s=this.placeInput,a=this.place,n=a.title,l=a.description,o=a.lat&&a.lng;this.focus(),s.change(y(n,l)),s.$element.focusend(),o&&(t={coords:{latitude:a.lat,longitude:a.lng,title:a.title}});var c=function(e,t,i,s){e&&e.emit&&e.emit("geos",t,i,s)},h=function(){e={coords:r},o||(t=e),c(i,e,t,o)};this.isGeoSupported?m.getCurrentPosition(function(s){e=s,o||(t=e),c(i,e,t,o)},h,{enableHighAccuracy:!0}):h()},showBefore:function(){this.element.attr("editarea","map-panel")},showAfter:function(){var e=this,t=e.srcNode;if(t){var i=t.offset(),s=e.element,a=s.outerWidth();s.css({left:this.oleft=i.left-a-15,top:this.otop=i.top})}f?e.showPlace():$(function(){f=!0,e&&e.showPlace&&e.showPlace()})},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),k=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=e.$(t),this.listen()};k.prototype={getPlace:function(){var e=this.$element.val();return _(e)},change:function(e){this.$element.val(e)},listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,i(this.blur,this)).on("keypress.mappanel",t,i(this.keypress,this)).on("keyup.mappanel",t,i(this.keyup,this)).on("keydown.mappanel",t,i(this.keydown,this)).on("focus.mappanel",t,i(this.focus,this))},lookup:function(){var e=this.trim();this.component.emit("change-place",e,"input")},trim:function(){var e=this.getPlace();return!e.title&&e.description&&(this.change(e.description),e=this.getPlace()),e},blur:function(){this.$element.addClass("normal")},focus:function(){this.$element.removeClass("normal")},keyup:function(e){switch(e.keyCode){case 40:case 38:case 16:case 17:case 18:case 9:case 27:break;case 13:this.component.emit("cleanup");break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this.component,i=e.keyCode;switch(i){case 9:e.preventDefault(),t.emit("placeinput-tab");break;case 40:var s=this.$element.val(),a=s.length,n=this.$element[0],r=P(n);a===r&&(e.preventDefault(),t.emit("placeinput-tab"))}},keypress:function(e){this.suppressKeyPressRepeat||this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~c.indexOf([9,40],e.keyCode),this.keyHandler(e)}};var M=function(e,t){this.template='<li class="place-item{{css-class}}" data-lat="{{lat}}" data-lng="{{lng}}" data-external-id="{{external_id}}"><address><div class="title">{{title}}</div><div class="description">{{address}}</div></address></li>',this.component=e,this.$container=this.component.element,this.selector=t,this.$element=e.$(t),this.$items=null,this.len=0,this.curr=0,this.viewportRows=12,this.viewportIndex=0,this.scrollIndexs=[0,11],this.scrollNum=1,this.itemPX=40,this.listen()};M.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,i(this.blur,this)).on("keypress.mappanel",t,i(this.keypress,this)).on("keyup.mappanel",t,i(this.keyup,this)).on("keydown.mappanel",t,i(this.keydown,this)).on("focus.mappanel",t,i(this.focus,this)).on("click.mappanel",t+" > li",i(this.click,this)).on("mouseenter.mappanel",t+" > li",i(this.mouseenter,this))},update:function(e,t){this.status=!!e.length||t,this.$element.empty(),this.curr=0;var i,s="",a=this.template;this.hasPlace=!1,this.status&&(t&&(s+=a.replace("{{css-class}}"," place-marker").replace("{{title}}",t.title).replace("{{address}}",t.description).replace("{{lat}}",t.lat).replace("{{lng}}",t.lng).replace("{{external_id}}",t.external_id),this.hasPlace=!0),c.each(e,function(e){i=e.geometry.location,s+=a.replace("{{css-class}}","").replace("{{title}}",e.name).replace("{{address}}",e.formatted_address).replace("{{lat}}",i.lat()).replace("{{lng}}",i.lng()).replace("{{external_id}}",e.id)}),this.$element.html(s)),this.$items=this.$element.find(" > li"),this.len=this.$items.length,this.$element.parent().toggleClass("hide",!this.status)},blur:function(){this.removeCurrStyle("hover")},mouseenter:function(e){var i=t(e.currentTarget),s=i.index();this.selectItem(s,!0),this.component.emit("enter-marker",s,this.hasPlace)},selectItem:function(e,t){0===this.len&&(this.$items=this.$element.find(" > li"),this.len=this.$items.length),this.removeCurrStyle("hover"),this.curr=e,!t&&this.$element.scrollTop(Math.floor(e/this.viewportRows)*this.itemPX*this.viewportRows),this.addCurrStyle("hover")},focus:function(){this.$items=this.$element.find(" > li"),this.len=this.$items.length,this.addCurrStyle("hover"),this.component.emit("enter-marker",this.curr,this.hasPlace)},addCurrStyle:function(e){this.$items.eq(this.curr).addClass(e)},removeCurrStyle:function(e){this.len&&this.$items.eq(this.curr).removeClass(e)},clear:function(){this.curr=0,this.len=0,this.viewportIndex=0,this.$items=null,this.$element.empty().parent().addClass("hide")},setPlace:function(){if(0!==this.len){var e=this.component,t=this.$items.eq(this.curr),i={title:t.find("div.title").text(),description:t.find("div.description").text(),lat:t.data("lat")+"",lng:t.data("lng")+"",external_id:t.data("external-id"),provider:"google"};this.hasPlace=!0,e.emit("clear-marker",this.curr),e.emit("change-place",i,"list"),this.clear()}},scroll:function(e){var t=this.scrollIndexs,i=this.viewportRows,s=this.len,a=this.scrollNum,n=this.itemPX,r=this.curr,l=this.viewportIndex+=e;if(l===t[1]+1&&r===s-1)this.$element.scrollTop(0),this.viewportIndex=0;else if(l===t[0]-1&&0===r)this.$element.scrollTop((s-i)*n),this.viewportIndex=11;else if(l===t[0]-1&&r>t[0]||s-(i-t[1])>r&&l===t[1]+1){var o=this.$element.scrollTop();this.$element.scrollTop(o+=e*n*a),this.viewportIndex=t[(e+1)/2]}},prev:function(){this.removeCurrStyle("hover"),0===this.curr&&(this.curr=this.len),this.curr--,this.addCurrStyle("hover")},next:function(){this.removeCurrStyle("hover"),this.curr++,this.len===this.curr&&(this.curr=0),this.addCurrStyle("hover")},keyup:function(e){e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this,i=t.component,s=t.hasPlace,a=e.ctrlKey,n=e.keyCode;switch(n){case 9:e.preventDefault(),i.emit("placeslist-tab");break;case 13:case 32:a||(e.preventDefault(),t.setPlace(),i.emit("enter-marker",t.curr,s));break;case 38:e.stopPropagation(),e.preventDefault(),t.scroll(-1),t.prev(),i.emit("enter-marker",t.curr,s);break;case 40:e.stopPropagation(),e.preventDefault(),t.scroll(1),t.next(),i.emit("enter-marker",t.curr,s)}},keypress:function(e){return this.suppressKeyPressRepeat?!1:(this.keyHandler(e),void 0)},keydown:function(e){this.suppressKeyPressRepeat=!!~c.indexOf([9,13,32,38,40],e.keyCode),this.keyHandler(e)},click:function(e){e.stopPropagation(),e.preventDefault(),this.curr=t(e.currentTarget).index(),this.setPlace()}};var w=function(e,t){this.component=e,this.selector=t,this.$element=e.$(t),this.$wrap=this.$element.parent(),this.GMaps=null,this.sizeStatus=!0,this.zoom2=2,this.zoom12=12,this.zoom16=16,this.zoomN=16,this.a=.05,this.owidth=this.$element.width(),this.oheight=this.$element.height(),this.cbid=0,this.redMarkers=[],this.curr=0};w.prototype={resize:function(e,t){880>e&&(e=880),500>t&&(t=500),this.$element.width(e).height(t)},initMap:function(e,t,i){var s,a,n=this,r=this.component,l=r.place,o=t.coords,c=e.coords,h=i;o||(t.coords=o={}),o.latitude||(o.latitude="0"),o.longitude||(o.longitude="0"),this.isGo=!0,this.hasLocation=!!c,this.hasPlace=h;try{if(s=this.GMaps=window.google.maps,a=s.ControlPosition,this._center=new s.LatLng(o.latitude,o.longitude),this._request={radius:5e4,location:this._center},this.enableOptions={zoomControl:!0,zoomControlOptions:{position:a.RIGHT_TOP},scaleControl:!0,scaleControlOptions:{position:a.BOTTOM_LEFT}},this.zoomN=this.hasPlace?this.zoom16:this.hasLocation?this.zoom12:this.zoom2,this._map=new s.Map(this.$element[0],this.defaultOptions={zoom:this.zoomN,center:this._center,disableDefaultUI:!0,MapTypeId:s.MapTypeId.ROADMAP,panControl:!1,zoomControl:!1,scaleControl:!1}),this._overlay=new s.OverlayView,this._overlay.draw=function(){},this._overlay.setMap(this._map),this.createIcons(),this.hasLocation&&(this._userMarker=new s.Marker({map:this._map,position:new s.LatLng(c.latitude,c.longitude),icon:this.sbicon,title:c.title||""})),this._service=new s.places.PlacesService(this._map),this.hasPlace){this._map.panBy(-100,0);var p=this.createBlueMarker(s.Marker,{map:this._map,position:this._center,icon:this.bicon,draggable:!0,title:o.title||""},l);this.GMaps.event.addListener(p,"dragend",function(e){var t=e.latLng;this._place.lat=""+t.lat(),this._place.lng=""+t.lng(),this._place.provider="",r.emit("change-place",this._place,"map")}),this.GMaps.event.addListener(p,"click",function(){n.clearMarkers(),r.emit("change-place",this._place,"map")},!1),this.GMaps.event.addListener(p,"mouseover",function(){n.selectMarker(this),r.emit("enter-placeitem",0)})}var m,d=new s.Geocoder,u=function(e){n._timer=setTimeout(function(){var t,i=r.placeInput.getPlace(),a=e.latLng;r.placesList.clear(),n.clearBlueMarker(),n.clearMarkers(),i.lat=""+a.lat(),i.lng=""+a.lng(),t=n.createBlueMarker(s.Marker,{map:n._map,position:a,icon:n.bicon,draggable:!0,title:i.title||""},i),s.event.addListener(t,"dragend",function(e){var t=e.latLng;this._place.lat=""+t.lat(),this._place.lng=""+t.lng(),this._place.provider="",r.emit("change-place",this._place,"map")}),s.event.trigger(t,"mouseover"),m=function(e,s){n._timer&&m.id===n.cbid&&s===window.google.maps.GeocoderStatus.OK&&e.length&&(clearTimeout(n._timer),n.hasPlace=!0,n.cbid=0,i.title="Right there on map",i.description=e[0].formatted_address,i.provider="",i.external_id="",r.emit("change-place",t._place=i,"map"))},m.id=++n.cbid,d.geocode({latLng:new s.LatLng(i.lat,i.lng)},m)},610)},f=function(){clearTimeout(n._timer)};c&&(s.event.addListener(this._userMarker,"mousedown",u),s.event.addListener(this._userMarker,"mouseup",u)),s.event.addListener(this._map,"click",function(e){e.stopPropagation&&e.stopPropagation()}),s.event.addListener(this._map,"mousedown",u),s.event.addListener(this._map,"mouseup",f),s.event.addListener(this._map,"dragstart",f)}catch(g){this.isGo=!1}},createBlueMarker:function(e,t,i){return this._placeMarker=this.createMarker(e,t,i),this._placeMarker.isBlue=!0,this._placeMarker},clearBlueMarker:function(){this.removeMarker(this._placeMarker),this._placeMarker=null},textSearch:function(e){var t,i,s=this,a=s.GMaps,n=s.isGo,r=s.component,l=s._service,o=s._request;n&&(s.clearMarkers(),e&&e!==o.query&&(o.query=e,t=function(e,n){t.id===s.cbid&&n===a.places.PlacesServiceStatus.OK&&(s.cbid=0,i=s._placeMarker,s.createMarkers(e),r.emit("search-completed",e,i?i._place:null))},t.id=++s.cbid,l.textSearch(o,t)))},panToRight:function(){var e=this.GMaps,t=this._map,i=this._overlay,s=i.getProjection(),a=e.Point,n=s.fromLatLngToContainerPixel(t.getCenter()),r=s.fromContainerPixelToLatLng(new a(n.x-100,n.y));t.setCenter(r)},showMarker:function(e,t){var i,s;i=t&&-1===--e?this._placeMarker:this.redMarkers[e],i&&(this.selectMarker(i),s=i.getPosition(),this._map.panTo(s)),this.sizeStatus&&(this._map.setZoom(this.zoomN=this.zoom16),this.panToRight())},selectMarker:function(e){var t=this.ricon,i=this.bicon,s=this.currMarker;s&&(s.setZIndex(null),s.isBlue||s.setIcon(t)),e&&(e.setZIndex(377),e.isBlue||e.setIcon(i),this.currMarker=e)},createIcons:function(){var e=this.GMaps,t=l+"/static/img/icons.png",i=e.Size,s=e.Point,a=e.MarkerImage;this.bicon=new a(t,new i(26,36),new s(0,78)),this.ricon=new a(t,new i(26,36),new s(26,78)),this.sbicon=new a(t,new i(12,14),new s(52,100))},saveMarker:function(e){var t=this,i=t.hasPlace;if(!i||0!==e){i&&(this.clearBlueMarker(),e-=1);var s=this.component,a=this.GMaps.event,n=this._placeMarker=this.redMarkers.splice(e,1)[0];this.hasPlace=!0,this.selectMarker(n),this.defaultOptions.zoom=this.zoomN=this.zoom16,a.clearListeners(n),n.isBlue=!0,n.setDraggable(!0),a.addListener(n,"click",function(){t.clearMarkers(),s.emit("change-place",this._place,"map")},!1),a.addListener(n,"dragend",function(e){var t=e.latLng;this._place.lat=""+t.lat(),this._place.lng=""+t.lng(),this._place.provider="",s.emit("change-place",this._place,"map")}),a.addListener(n,"mouseover",function(){t.selectMarker(this),s.emit("enter-placeitem",0)})}this.clearMarkers()},clear:function(){this._placeMarker&&this.clearBlueMarker(),this.clearMarkers(),this.hasPlace=!1,this.defaultOptions.zoom=this.zoomN=this.hasLocation?this.zoom12:this.zoom2},removeMarker:function(e){e&&(e.setMap(null),e=null)},clearMarkers:function(){var e,t=this.redMarkers,i=this.removeMarker;if(t){for(;e=t.shift();)i(e);this.curr=0}},createMarkers:function(e,t){for(var i,s,a,n=this,r=!t,l=this.component,o=this.createMarker,c=this.GMaps,h=c.event,p=c.LatLng,m=c.Marker,d=new c.LatLngBounds,u=this.redMarkers,f=this._map,g=this.ricon,v=0,k=function(){var e=n.indexOf(n.redMarkers,this);l.placesList.clear(),l.emit("clear-marker",e),l.emit("click-placeitem",this._place)},M=function(){var e=n.indexOf(n.redMarkers,this);n.selectMarker(this),l.emit("enter-placeitem",e+=n._placeMarker?1:0)};i=e[v];++v)a=i.lat?new p(i.lat,i.lng):i.geometry.location,s=o(m,{map:f,icon:g,title:i.name,position:a,zIndex:0},{title:i.title||i.name,description:i.description||i.formatted_address,lat:""+a.lat(),lng:""+a.lng(),external_id:i.id||"",provider:"google"}),h.addListener(s,"click",k,!1),h.addListener(s,"mouseover",M),u.push(s),r&&d.extend(a);r&&f.fitBounds(d)},createMarker:function(e,t,i,s){return s=new e(t),s._place=i,s},zoom:function(e){if(this.isGo){this.sizeStatus=e;var t=this,i=t.component,s=i.element,a=t.GMaps,n=t._map,r=t.redMarkers;if(this.$wrap.toggleClass("gmap-big",!e),i.$resize.toggleClass("map-rc"),i.$mask.toggleClass("hide",!e),e)s.css({top:i.otop,left:i.oleft}),t.$element.width(t.owidth).height(t.oheight),setTimeout(function(){n.setOptions(t.defaultOptions),n.setCenter(t._placeMarker?t._placeMarker.getPosition():t._userMarker.getPosition()),t.hasPlace&&t.panToRight()},0);else{var l=d.width(),o=d.height(),c=t.a,h=d.scrollTop(),p=d.scrollLeft();t.resize(l*(1-2*c),o*(1-c)-56),s.css({top:56+h,left:l*c+p}),setTimeout(function(){n.setOptions(t.enableOptions)},0)}a.event.trigger(n,"resize"),!t._placeMarker&&r.length&&(t._placeMarker=r[0]),n.setCenter(t._placeMarker?t._placeMarker.getPosition():t._userMarker?t._userMarker.getPosition():null),i.placeInput.$element.focusend()}},indexOf:function(e,t){return c.indexOf(e,t)}};var _=function(e){var i=e.split(h),s=i.length?t.trim(i.shift()):"",a=t.trim(i.join(p)).replace(h,"");return{title:s,description:a}},y=function(e,t){return e+(t?p+t.replace(h,p):"")},x=function(e){return e.getUTCFullYear()+"-"+o(e.getUTCMonth()+1)+"-"+o(e.getUTCDate())+" "+o(e.getUTCHours())+":"+o(e.getUTCMinutes())+":"+o(e.getUTCSeconds())+" +0000"},P=function(e){return u?b(e):e.selectionEnd},b=function(e){var t=document.selection.createRange(),i=e.createTextRange(),s=i.duplicate();return i.moveToBookmark(t.getBookmark()),s.setEndPoint("EndToStart",i),s.text.length+t.text.length},$=function(e){if(!window.google||!window.google.maps){window._loadMaps=function(){};var i="google-maps-jsapi";t(i).remove();var s=document.getElementsByTagName("body")[0],a=document.createElement("script");window._gmap=function(){delete window._gmap},window._loadMaps=function(){window.google.load("maps","3",{other_params:"key="+n+"&sensor=false&libraries=places",callback:function(){e()}})},a.async="async",a.className=i,a.src="//www.google.com/jsapi?callback=_loadMaps",s.appendChild(a)}};return v});