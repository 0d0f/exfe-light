define("mappanel",function(e,t,n){var r=e("jquery"),i=e("rex"),s=e("config"),o=r.proxy,u=/[\r\n]+/g,a="\r",f=window.navigator.geolocation,l=r(window),c=e("panel"),h=c.extend({options:{template:'<div class="panel map-panel" tabindex="-1" data-widget="panel" id="map-panel"><div class="panel-body"><div class="map-container"><div class="map-box" id="gmap"></div><div class="map-place"><div class="place-editor"><i class="pointer icon24-enter place-submit"></i><textarea class="normal" name="place-text" id="place-text" placeholder="Enter place here."></textarea></div><div class="map-places hide"><ul class="unstyled places-list" tabindex="-1"></ul></div></div></div></div></div>',parentNode:null,srcNode:null,place:null},isGeoSupported:!!f,setGeos:function(e,t,n){this.userPosition=e,this.placePosition=t,this.hasLatLng=n,this.xmap.initMap()},init:function(){var e=this.options;this.render(),this.originPlace=e.place,this.place=r.extend({},e.place),delete e.place,this.placeInput=new p(this,"#place-text"),this.placesList=new d(this,".places-list"),this.xmap=new v(this,"#gmap"),this.listen()},listen:function(){var e=this,t=this.place;this.on("update-place",this.update),this.on("change-place",this.change),this.on("geos",this.setGeos),this.on("search-completed",this.searchCompleted),this.on("placeinput-tab",this.placeInputTab),this.on("placeslist-tab",this.placesListTab),this.on("clear-marker",this.clearMarker),this.on("enter-marker",this.enterMarker),this.on("enter-placeitem",this.enterPlaceItem),this.on("click-placeitem",this.clickPlaceItem),this.on("zoomup-map",this.zoomUpMap),this.on("zoomdown-map",this.zoomDownMap),this.element.on("click.mappanel",".place-submit",function(e){r("body").click()}),this.element.on("keydown.mappanel",o(this.keydown,this))},save:function(){this.$(".place-submit").trigger("click.mappanel")},keydown:function(e){var t=this,n=e.altKey,r=e.ctrlKey,i=e.shiftKey,s=e.metaKey,o=e.keyCode;27===o?t.revert():13===o&&!(n|i)&(r|s)?(t.emit("update-place",t.place),t.save()):r&&187===o&&t.emit("zoomup-map",0)},zoomUpMap:function(e){this.xmap.zoom(e)},zoomDownMap:function(e){this.xmap.zoom(e)},clickPlaceItem:function(e){this.placesList.setPlace(),this.element.focus()},enterPlaceItem:function(e){this.placesList.selectItem(e)},enterMarker:function(e){this.xmap.showMarker(e)},clearMarker:function(e){this.xmap.saveMarker(e)},searchCompleted:function(e){this.placesList.update(e)},placeInputTab:function(){var e=this.placesList,t=e.$element,n=this.placeInput,r=e.status;r&&setTimeout(function(){t.focus()},0)},placesListTab:function(){var e=this.placeInput.$element;setTimeout(function(){e.focusend()},0)},change:function(e,t){var n=this.place,r=n.title;n.title=e.title,n.description=e.description,n.lat=e.lat||"",n.lng=e.lng||"",t=!!t,t?r!==e.title&&this.xmap.textSearch(e.title):this.placeInput.change(g(e.title,e.description)),this.emit("update-place",n)},revert:function(e){this.emit("update-place",this.originPlace)},showPlace:function(){var e=this,t=this.place,n=t.title,r=t.description,i=!n&&!r,o=t.lat&&t.lng,u,a;this.placeInput.change(g(n,r)),this.element.focus(),i&&this.placeInput.$element.focusend(),o&&(a={coords:{latitude:t.lat,longitude:t.lng,title:t.title}}),this.isGeoSupported?f.getCurrentPosition(function(t){u=t,o||(a=u),e.setGeos(u,a,o)},function(t){u={coords:s.location},o||(a=u),e.setGeos(u,a,o)}):(u={coords:s.location},o||(a=u),e.setGeos(u,a,o))},showBefore:function(){this.element.attr("editarea","map-panel")},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),n=this.element.outerWidth();this.element.css({left:t.left-n-15,top:t.top})}this.showPlace()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),p=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.listen()};p.prototype={change:function(e){this.$element.val(e)},listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,o(this.blur,this)).on("keypress.mappanel",t,o(this.keypress,this)).on("keyup.mappanel",t,o(this.keyup,this)).on("keydown.mappanel",t,o(this.keydown,this)).on("focus.mappanel",t,o(this.focus,this))},lookup:function(){var e=this.$element.val(),t=m(e);this.component.emit("change-place",t,!0)},blur:function(e){this.$element.addClass("normal")},focus:function(e){this.$element.removeClass("normal")},keyup:function(e){switch(e.keyCode){case 40:case 38:case 16:case 17:case 18:case 9:case 13:case 27:break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this.component,n=e.keyCode;switch(n){case 9:e.preventDefault(),t.emit("placeinput-tab")}},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~i.indexOf([9],e.keyCode),this.keyHandler(e)}};var d=function(e,t){this.template='<li class="place-item" data-latitude="{{lat}}" data-longitude="{{lng}}"><address><div class="title">{{title}}</div><div class="description">{{address}}</div></address></li>',this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.$items=null,this.len=0,this.curr=0,this.viewportRows=12,this.viewportIndex=0,this.scrollIndexs=[0,11],this.scrollNum=1,this.itemPX=40,this.listen()};d.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,o(this.blur,this)).on("keypress.mappanel",t,o(this.keypress,this)).on("keyup.mappanel",t,o(this.keyup,this)).on("keydown.mappanel",t,o(this.keydown,this)).on("focus.mappanel",t,o(this.focus,this)).on("click.mappanel",t+" > li",o(this.click,this)).on("mouseenter.mappanel",t+" > li",o(this.mouseenter,this))},update:function(e){this.status=!!e.length,this.$element.empty(),this.curr=0;var t="",n,r=this.template;this.status&&(i.each(e,function(e,i){n=r,t+=n.replace("{{title}}",e.name).replace("{{address}}",e.formatted_address).replace("{{lat}}",e.geometry.location.Ya).replace("{{lng}}",e.geometry.location.Za)}),this.$element.html(t)),this.$element.parent().toggleClass("hide",!this.status)},blur:function(){this.removeCurrStyle("hover")},mouseenter:function(e){var t=r(e.currentTarget),n=t.index();this.selectItem(n,!0),this.component.emit("enter-marker",n)},selectItem:function(e,t){0===this.len&&(this.$items=this.$element.find(" > li"),this.len=this.$items.length),this.removeCurrStyle("hover"),this.curr=e,!t&&this.$element.scrollTop(Math.floor(e/this.viewportRows)*this.itemPX*this.viewportRows),this.addCurrStyle("hover")},focus:function(e){this.$items=this.$element.find(" > li"),this.len=this.$items.length,this.addCurrStyle("hover"),this.component.emit("enter-marker",this.curr)},addCurrStyle:function(e){this.$items.eq(this.curr).addClass(e)},removeCurrStyle:function(e){this.len&&this.$items.eq(this.curr).removeClass(e)},clear:function(){this.curr=0,this.len=0,this.viewportIndex=0,this.$items=null,this.$element.empty().parent().addClass("hide")},setPlace:function(){if(0===this.len)return;var e=this.component,t=this.$items.eq(this.curr),n={title:t.find("div.title").text(),description:t.find("div.description").text(),lat:String(t.data("latitude")),lng:String(t.data("longitude"))};e.emit("clear-marker",this.curr),e.emit("change-place",n,!1),this.clear()},scroll:function(e){var t=this.scrollIndexs,n=this.viewportRows,r=this.len,i=this.scrollNum,s=this.itemPX,o=this.curr,u=this.viewportIndex+=e;if(u===t[1]+1&&o===r-1)this.$element.scrollTop(0),this.viewportIndex=0;else if(u===t[0]-1&&o===0)this.$element.scrollTop((r-n)*s),this.viewportIndex=11;else if(u===t[0]-1&&o>t[0]||o<r-(n-t[1])&&u===t[1]+1){var a=this.$element.scrollTop();this.$element.scrollTop(a+=e*s*i),this.viewportIndex=t[(e+1)/2]}},prev:function(){this.removeCurrStyle("hover"),0===this.curr&&(this.curr=this.len),this.curr--,this.addCurrStyle("hover")},next:function(){this.removeCurrStyle("hover"),this.curr++,this.len===this.curr&&(this.curr=0),this.addCurrStyle("hover")},keyup:function(e){e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this,n=t.component,r=e.ctrlKey,i=e.keyCode;switch(i){case 9:e.preventDefault(),n.emit("placeslist-tab");break;case 13:case 32:r||(e.preventDefault(),t.setPlace(),n.emit("enter-marker",t.curr));break;case 38:e.stopPropagation(),e.preventDefault(),t.scroll(-1),t.prev(),n.emit("enter-marker",t.curr);break;case 40:e.stopPropagation(),e.preventDefault(),t.scroll(1),t.next(),n.emit("enter-marker",t.curr)}},keypress:function(e){if(this.suppressKeyPressRepeat)return!1;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~i.indexOf([9,13,32,38,40],e.keyCode),this.keyHandler(e)},click:function(e){this.curr=r(e.currentTarget).index(),this.setPlace(),this.component.save()}};var v=function(e,t){this.component=e,this.selector=t,this.$element=this.component.$(t),this.GMaps=null,this.sizeStatus=1,this.zoomNum=16,this.a=.8,this.cbid=0,this.markers=[],this.curr=0};v.prototype={resize:function(e,t){e<880&&(e=880),t<500&&(t=500),this.$element.width(e).height(t)},initMap:function(){var e=this.component;this.userPosition=e.userPosition,this.placePosition=e.placePosition,this.hasLatLng=e.hasLatLng;var t=this.placePosition.coords;t||(this.placePosition.coords=t={}),t.latitude||(t.latitude=""),t.longitude||(t.longitude=""),this.isGo=!0,this._request={radius:5e4};try{var n=this.GMaps=google.maps;this._center=new n.LatLng(t.latitude,t.longitude),this._request.location=this._center,this.createIcons(),this.disableOptions={panControl:!1,zoomControl:!1,scaleControl:!1,mapTypeControl:!1,overviewMapControl:!1},this.enableOptions={panControl:!0,panControlOptions:{position:n.ControlPosition.RIGHT_TOP},zoomControl:!0,zoomControlOptions:{position:n.ControlPosition.RIGHT_TOP},scaleControl:!0,scaleControlOptions:{position:n.ControlPosition.RIGHT_TOP}},this._map=new n.Map(this.$element[0],{zoom:this.zoomNum,center:this._center,MapTypeId:n.MapTypeId.ROADMAP}),this._map.setOptions(this.disableOptions),this._overlay=new n.OverlayView,this._overlay.draw=function(){},this._overlay.setMap(this._map),this.hasLatLng&&(this._placeMarker=new n.Marker({position:new n.LatLng(this.placePosition.coords.latitude,this.placePosition.coords.longitude),map:this._map,icon:this.bicon,title:this.placePosition.coords.title||""}),this.markers.push(this._placeMarker),this._map.panBy(-100,0)),this._userMarker=new n.Marker({position:new n.LatLng(this.userPosition.coords.latitude,this.userPosition.coords.longitude),map:this._map,icon:this.sbicon,title:this.userPosition.coords.title||""}),this._service=new n.places.PlacesService(this._map);var r=this;google.maps.event.addListener(this._map,"click",function(){r.sizeStatus&&r.zoom(0)})}catch(i){this.isGo=!1}},updateCenter:function(e){if(this.isGo){var t=this.GMaps;this._center=new t.LatLng(e.lat,e.lng),this._map.setCenter(this._center)}},textSearch:function(e){var t=this,n=this.GMaps,r=t.isGo,i=t.component,s=t._service,o=t._request,u;r&&e&&e!==o.query?(o.query=e,u=function(e,r){u.id===t.cbid&&r===n.places.PlacesServiceStatus.OK&&(t.cbid=0,t.clearMarkers(),t.createMarkers(e),i.emit("search-completed",e))},u.id=++t.cbid,s.textSearch(o,u)):i.emit("search-completed",[])},panToRight:function(){var e=this.GMaps,t=this._map,n=this._overlay,r=n.getProjection(),i=e.Point,s=r.fromLatLngToContainerPixel(t.getCenter()),o=r.fromContainerPixelToLatLng(new i(s.x-100,s.y));t.setCenter(o)},showMarker:function(e){this.sizeStatus&&this.zoomNum!==this._map.getZoom()&&this._map.setZoom(this.zoomNum),this.selectMarker(e,this.sizeStatus);if(this.sizeStatus){var t=this.markers[this.curr];this._map.setCenter(t.getPosition()),this.panToRight()}},selectMarker:function(e,t){var n=this._map,r=this.markers[this.curr],i=this.markers[this.curr=e],s=this.ricon,o=this.bicon;r&&(r.setZIndex(null),r.setIcon(s)),i.setIcon(o),i.setZIndex(377),this._placeMarker=i,!t&&n.panTo(i.getPosition())},createIcons:function(){var e=this.GMaps,t=s.site_url+"/static/img/icons.png",n=e.Size,r=e.Point;this.bicon=new e.MarkerImage(t,new n(26,36),new r(0,78)),this.ricon=new e.MarkerImage(t,new n(26,36),new r(26,78)),this.sbicon=new e.MarkerImage(t,new n(12,14),new r(52,100))},saveMarker:function(e,t){this.selectMarker(e,t);var n=this.markers.splice(e,1)[0];this.clearMarkers(),this.markers.push(n)},clearMarkers:function(){var e=this.markers,t;while(t=e.shift())t.setMap(null),t=null;this.curr=0},createMarkers:function(e){var t=this,n=this.component,r=this.GMaps,i=new r.LatLngBounds,s=this.markers,o=this._map,u=this.ricon,a,f,l,c=0;for(;a=e[c];++c)l=a.geometry.location,f=new r.Marker({map:o,icon:u,title:a.name,position:l,zIndex:0}),r.event.addListener(f,"click",function(){var e=t.indexOf(s,this);n.emit("click-placeitem",e)},!1),r.event.addListener(f,"mouseover",function(){var e=t.indexOf(s,this);t.selectMarker(e,!0),n.emit("enter-placeitem",e)}),s.push(f),i.extend(l);o.fitBounds(i)},zoom:function(e){if(!this.isGo)return;this.sizeStatus=e;var t=l.width(),n=l.height(),r=this.GMaps,i=this.markers,s=this.a,o=this.component,u=this,a=l.scrollTop(),f=l.scrollLeft();t*=s,n*=s,u.resize(t,n),o.element.css({top:n*(1-s)/2+a,left:t*(1-s)/2+f}),r.event.trigger(u._map,"resize"),!u._placeMarker&&i.length&&(u._placeMarker=i[0]),u._map.setCenter(u._placeMarker?u._placeMarker.getPosition():u._userMarker.getPosition()),setTimeout(function(){u._map.setOptions(u.enableOptions)},0)},indexOf:function(e,t){return i.indexOf(e,t)}};var m=function(e){e||(e="");var t=e.split(u),n=t.length?r.trim(t.shift()):"",i=r.trim(t.join(a));return{title:n,description:i}},g=function(e,t){return e+(t?a+t.replace(u,a):"")};return h});