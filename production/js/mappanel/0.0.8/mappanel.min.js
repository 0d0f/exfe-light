define("mappanel",function(e){"use strict";var t=e("jquery"),n=e("config").MAP_KEY,r=e("rex"),i=e("humantime").lead0,s=e("config"),o=t.proxy,u=/[\r\n]+/g,a="\r",f=window.navigator.geolocation,l=t(window),c=t.browser.msie,h=!1,p=e("panel"),d=p.extend({options:{template:'<div class="panel map-panel" tabindex="-1" data-widget="panel" id="map-panel"><div class="panel-body"><div class="map-container"><div class="gmap-wrap"><div class="map-box" id="gmap"></div></div><div class="map-mask"></div><div class="map-resize"><span class="expand">Expand</span><span class="compact">Compact</span><span class="rb"></span><span class="lt"></span></div><div class="map-place"><div class="place-editor"><i class="pointer icon-enter-blue place-submit"></i><div class="place-filter"></div><textarea class="normal" name="place-text" id="place-text" placeholder="Enter place here."></textarea></div><div class="map-places hide"><ul class="unstyled places-list" tabindex="-1"></ul></div></div></div></div></div>',parentNode:null,srcNode:null,place:null},isGeoSupported:!!f,setGeos:function(e,t,n){this.userPosition=e,this.placePosition=t,this.hasLatLng=n,this.xmap.initMap()},init:function(){var e=this.options;this.render(),this.originPlace=e.place,this.place=t.extend({},e.place),delete e.place,this.placeInput=new v(this,"#place-text"),this.placesList=new m(this,".places-list"),this.xmap=new g(this,"#gmap"),this.listen(),this.$resize=this.element.find(".map-resize"),this.$mask=this.element.find(".map-mask")},listen:function(){var e=this;this.on("update-place",this.update),this.on("change-place",this.change),this.on("geos",this.setGeos),this.on("search-completed",this.searchCompleted),this.on("placeinput-tab",this.placeInputTab),this.on("placeslist-tab",this.placesListTab),this.on("cleanup",function(){e.placesList.clear(),e.xmap.clear()}),this.on("clear-marker",this.clearMarker),this.on("enter-marker",this.enterMarker),this.on("enter-placeitem",this.enterPlaceItem),this.on("click-placeitem",this.clickPlaceItem),this.on("zoom-map",this.zoomMap),this.element.on("click.mappanel",".place-submit",function(){Cross.place=e.place,t("body").click()}),this.element.on("keydown.mappanel",o(this.keydown,this)),this.element.on("click.mappanel",".map-mask",function(t){t.preventDefault(),e.emit("zoom-map",!1)}),this.element.on("click.mappanel",".map-resize",function(n){n.preventDefault();var r=t(this).hasClass("map-rc");e.emit("zoom-map",r)})},save:function(){this.$(".place-submit").trigger("click.mappanel")},keydown:function(e){var t=this,n=e.altKey,r=e.ctrlKey,i=e.shiftKey,s=e.metaKey,o=e.keyCode;27===o?t.revert():13===o&&!(n|i)&(r|s)?(t.emit("update-place",t.place),t.save()):187===o&&r?t.emit("zoom-map",0):189===o&&r&&t.emit("zoom-map",1)},zoomMap:function(e){this.xmap.zoom(e)},clickPlaceItem:function(e){this.emit("change-place",e,"map"),this.element.focus()},enterPlaceItem:function(e){this.placesList.selectItem(e)},enterMarker:function(e,t){this.xmap.showMarker(e,t)},clearMarker:function(e){this.xmap.saveMarker(e||0)},searchCompleted:function(e,t){this.placesList.update(e,t)},placeInputTab:function(){var e=this.placesList,t=e.$element,n=e.status;n&&setTimeout(function(){t.focus()},0)},placesListTab:function(){var e=this.placeInput.$element;setTimeout(function(){e.focusend()},0)},resetPlace:function(e){return e.title=e.description=e.lat=e.lng=e.external_id=e.provider="",e},change:function(e,t,n){var r=this.place,i=r.title,s=r.description,o=r.lat,u=r.lng,a=!e.title,f=this.placeInput,l=this.placesList,c=!1,h=this.xmap;r.updated_at=w(new Date),a?(r=this.resetPlace(r),l.clear(),h.clear()):(r.title=e.title,r.description=e.description,r.external_id=e.external_id||"",r.provider=e.provider||"",t==="map"||t==="list"?(r.lat=e.lat,r.lng=e.lng,f.change(b(e.title,e.description)),c=!0):t==="input"&&i!==e.title&&!e.description&&(l.clear(),h.textSearch(e.title))),(i!==e.title||s!==e.description||o!==e.lat||u!==e.lng||c)&&this.emit("update-place",r)},revert:function(){this.emit("update-place",this.originPlace)},showPlace:function(){var e=this,t=this.place,n=t.title,r=t.description,i=t.lat&&t.lng,o,u;this.placeInput.change(b(n,r)),this.element.focus(),this.placeInput.$element.focusend(),i&&(u={coords:{latitude:t.lat,longitude:t.lng,title:t.title}}),this.isGeoSupported?f.getCurrentPosition(function(t){o=t,i||(u=o),e.setGeos(o,u,i)},function(){o={coords:s.location},i||(u=o),e.setGeos(o,u,i)}):(o={coords:s.location},i||(u=o),e.setGeos(o,u,i))},showBefore:function(){this.element.attr("editarea","map-panel")},showAfter:function(){var e=this,t=e.srcNode;if(t){var n=t.offset(),r=this.element.outerWidth();this.element.css({left:this.oleft=n.left-r-15,top:this.otop=n.top})}h?e.showPlace():x(function(){h=!0,e&&e.showPlace&&e.showPlace()})},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),v=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=e.$(t),this.listen()};v.prototype={getPlace:function(){var e=this.$element.val();return y(e)},change:function(e){this.$element.val(e)},listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,o(this.blur,this)).on("keypress.mappanel",t,o(this.keypress,this)).on("keyup.mappanel",t,o(this.keyup,this)).on("keydown.mappanel",t,o(this.keydown,this)).on("focus.mappanel",t,o(this.focus,this))},lookup:function(){var e=this.trim();this.component.emit("change-place",e,"input")},trim:function(){var e=this.getPlace();return!e.title&&e.description&&(this.change(e.description),e=this.getPlace()),e},blur:function(){this.$element.addClass("normal")},focus:function(){this.$element.removeClass("normal")},keyup:function(e){switch(e.keyCode){case 40:case 38:case 16:case 17:case 18:case 9:case 27:break;case 13:this.component.emit("cleanup");break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this.component,n=e.keyCode;switch(n){case 9:e.preventDefault(),t.emit("placeinput-tab");break;case 40:var r=this.$element.val(),i=r.length,s=this.$element[0],o=E(s);i===o&&(e.preventDefault(),t.emit("placeinput-tab"))}},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~r.indexOf([9,40],e.keyCode),this.keyHandler(e)}};var m=function(e,t){this.template='<li class="place-item{{css-class}}" data-lat="{{lat}}" data-lng="{{lng}}" data-external-id="{{external_id}}"><address><div class="title">{{title}}</div><div class="description">{{address}}</div></address></li>',this.component=e,this.$container=this.component.element,this.selector=t,this.$element=e.$(t),this.$items=null,this.len=0,this.curr=0,this.viewportRows=12,this.viewportIndex=0,this.scrollIndexs=[0,11],this.scrollNum=1,this.itemPX=40,this.listen()};m.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,o(this.blur,this)).on("keypress.mappanel",t,o(this.keypress,this)).on("keyup.mappanel",t,o(this.keyup,this)).on("keydown.mappanel",t,o(this.keydown,this)).on("focus.mappanel",t,o(this.focus,this)).on("click.mappanel",t+" > li",o(this.click,this)).on("mouseenter.mappanel",t+" > li",o(this.mouseenter,this))},update:function(e,t){this.status=!!e.length||t,this.$element.empty(),this.curr=0;var n="",i=this.template,s;this.hasBlue=!1,this.status&&(t&&(n+=i.replace("{{css-class}}"," place-marker").replace("{{title}}",t.title).replace("{{address}}",t.description).replace("{{lat}}",t.lat).replace("{{lng}}",t.lng).replace("{{external_id}}",t.external_id),this.hasBlue=!0),r.each(e,function(e){s=e.geometry.location,n+=i.replace("{{css-class}}","").replace("{{title}}",e.name).replace("{{address}}",e.formatted_address).replace("{{lat}}",s.lat()).replace("{{lng}}",s.lng()).replace("{{external_id}}",e.id)}),this.$element.html(n)),this.$items=this.$element.find(" > li"),this.len=this.$items.length,this.$element.parent().toggleClass("hide",!this.status)},blur:function(){this.removeCurrStyle("hover")},mouseenter:function(e){var n=t(e.currentTarget),r=n.index();this.selectItem(r,!0),this.component.emit("enter-marker",r,this.hasBlue)},selectItem:function(e,t){0===this.len&&(this.$items=this.$element.find(" > li"),this.len=this.$items.length),this.removeCurrStyle("hover"),this.curr=e,!t&&this.$element.scrollTop(Math.floor(e/this.viewportRows)*this.itemPX*this.viewportRows),this.addCurrStyle("hover")},focus:function(){this.$items=this.$element.find(" > li"),this.len=this.$items.length,this.addCurrStyle("hover"),this.component.emit("enter-marker",this.curr,this.hasBlue)},addCurrStyle:function(e){this.$items.eq(this.curr).addClass(e)},removeCurrStyle:function(e){this.len&&this.$items.eq(this.curr).removeClass(e)},clear:function(){this.curr=0,this.len=0,this.viewportIndex=0,this.$items=null,this.$element.empty().parent().addClass("hide")},setPlace:function(){if(0===this.len)return;var e=this.component,t=this.$items.eq(this.curr),n={title:t.find("div.title").text(),description:t.find("div.description").text(),lat:String(t.data("lat")),lng:String(t.data("lng")),external_id:t.data("external-id"),provider:"google"};this.hasBlue=!0,e.emit("clear-marker",this.curr),e.emit("change-place",n,"list"),this.clear()},scroll:function(e){var t=this.scrollIndexs,n=this.viewportRows,r=this.len,i=this.scrollNum,s=this.itemPX,o=this.curr,u=this.viewportIndex+=e;if(u===t[1]+1&&o===r-1)this.$element.scrollTop(0),this.viewportIndex=0;else if(u===t[0]-1&&o===0)this.$element.scrollTop((r-n)*s),this.viewportIndex=11;else if(u===t[0]-1&&o>t[0]||o<r-(n-t[1])&&u===t[1]+1){var a=this.$element.scrollTop();this.$element.scrollTop(a+=e*s*i),this.viewportIndex=t[(e+1)/2]}},prev:function(){this.removeCurrStyle("hover"),0===this.curr&&(this.curr=this.len),this.curr--,this.addCurrStyle("hover")},next:function(){this.removeCurrStyle("hover"),this.curr++,this.len===this.curr&&(this.curr=0),this.addCurrStyle("hover")},keyup:function(e){e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this,n=t.component,r=t.hasBlue,i=e.ctrlKey,s=e.keyCode;switch(s){case 9:e.preventDefault(),n.emit("placeslist-tab");break;case 13:case 32:i||(e.preventDefault(),t.setPlace(),n.emit("enter-marker",t.curr,r));break;case 38:e.stopPropagation(),e.preventDefault(),t.scroll(-1),t.prev(),n.emit("enter-marker",t.curr,r);break;case 40:e.stopPropagation(),e.preventDefault(),t.scroll(1),t.next(),n.emit("enter-marker",t.curr,r)}},keypress:function(e){if(this.suppressKeyPressRepeat)return!1;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~r.indexOf([9,13,32,38,40],e.keyCode),this.keyHandler(e)},click:function(e){e.stopPropagation(),e.preventDefault(),this.curr=t(e.currentTarget).index(),this.setPlace()}};var g=function(e,t){this.component=e,this.selector=t,this.$element=e.$(t),this.$wrap=this.$element.parent(),this.GMaps=null,this.sizeStatus=!0,this.zoom12=12,this.zoom16=16,this.zoomN=16,this.a=.8,this.owidth=this.$element.width(),this.oheight=this.$element.height(),this.cbid=0,this.redMarkers=[],this.curr=0};g.prototype={resize:function(e,t){e<880&&(e=880),t<500&&(t=500),this.$element.width(e).height(t)},initMap:function(){var e=this.component,t=this,n=e.place,r=this.placePosition=e.placePosition,i=this.userPosition=e.userPosition,s=r.coords,o=i.coords,u=e.hasLatLng,a,f;s||(r.coords=s={}),s.latitude||(s.latitude=""),s.longitude||(s.longitude=""),o||(i.coords=o={}),o.latitude||(o.latitude=""),o.longitude||(o.longitude=""),this.isGo=!0,this.hasPlace=u;try{a=this.GMaps=google.maps,f=a.ControlPosition,this._center=new a.LatLng(s.latitude,s.longitude),this._request={radius:5e4,location:this._center},this.enableOptions={zoomControl:!0,zoomControlOptions:{position:f.RIGHT_TOP},scaleControl:!0,scaleControlOptions:{position:f.BOTTOM_LEFT}},this._map=new a.Map(this.$element[0],this.defaultOptions={zoom:this.zoomN,center:this._center,disableDefaultUI:!0,MapTypeId:a.MapTypeId.ROADMAP,panControl:!1,zoomControl:!1,scaleControl:!1}),this._overlay=new a.OverlayView,this._overlay.draw=function(){},this._overlay.setMap(this._map),this.createIcons(),this._userMarker=new a.Marker({map:this._map,position:new a.LatLng(o.latitude,o.longitude),icon:this.sbicon,title:o.title||""}),this._service=new a.places.PlacesService(this._map);if(u){this._map.setZoom(this.zoomN=this.zoom16),this._map.panBy(-100,0);var l=this.createBlueMarker(a.Marker,{map:this._map,position:this._center,icon:this.bicon,draggable:!0,title:s.title||""},n);this.hasBlue=!0,this.GMaps.event.addListener(l,"dragend",function(t){var n=t.latLng;this._place.lat=""+n.lat(),this._place.lng=""+n.lng(),this._place.provider="",e.emit("change-place",this._place,"map")}),this.GMaps.event.addListener(l,"click",function(){t.clearMarkers(),e.emit("change-place",this._place,"map")},!1),this.GMaps.event.addListener(l,"mouseover",function(){t.selectMarker(this),e.emit("enter-placeitem",0)})}else this._map.setZoom(this.zoomN=this.zoom12);var t=this,c=new a.Geocoder,h,p=function(n){t._timer=setTimeout(function(){var r=e.placeInput.getPlace(),i=n.latLng,s;e.placesList.clear(),t.clearBlueMarker(),t.clearMarkers(),r.lat=""+i.lat(),r.lng=""+i.lng(),s=t.createBlueMarker(a.Marker,{map:t._map,position:i,icon:t.bicon,draggable:!0,title:r.title||""},r),a.event.addListener(s,"dragend",function(t){var n=t.latLng;this._place.lat=""+n.lat(),this._place.lng=""+n.lng(),this._place.provider="",e.emit("change-place",this._place,"map")}),a.event.trigger(s,"mouseover"),h=function(n,i){t._timer&&h.id===t.cbid&&i===google.maps.GeocoderStatus.OK&&n.length&&(clearTimeout(t._timer),t.hasBlue=!0,t.cbid=0,r.title="Right there on map",r.description=n[0].formatted_address,r.provider="",r.external_id="",e.emit("change-place",s._place=r,"map"))},h.id=++t.cbid,c.geocode({latLng:new a.LatLng(r.lat,r.lng)},h)},610)},d=function(){clearTimeout(t._timer)};a.event.addListener(this._userMarker,"mousedown",p),a.event.addListener(this._userMarker,"mouseup",p),a.event.addListener(this._map,"mousedown",p),a.event.addListener(this._map,"mouseup",d),a.event.addListener(this._map,"dragstart",d)}catch(v){this.isGo=!1}},bindGMapsEvents:function(e){},createBlueMarker:function(e,t,n){return this._placeMarker=this.createMarker(e,t,n),this._placeMarker.isBlue=!0,this._placeMarker},clearBlueMarker:function(){this.removeMarker(this._placeMarker),this._placeMarker=null},textSearch:function(e){var t=this,n=t.GMaps,r=t.isGo,i=t.component,s=t._service,o=t._request,u,a;r&&(t.clearMarkers(),e&&e!==o.query&&(o.query=e,u=function(e,r){u.id===t.cbid&&r===n.places.PlacesServiceStatus.OK&&(t.cbid=0,a=t._placeMarker,t.createMarkers(e),i.emit("search-completed",e,a?a._place:null))},u.id=++t.cbid,s.textSearch(o,u)))},panToRight:function(){var e=this.GMaps,t=this._map,n=this._overlay,r=n.getProjection(),i=e.Point,s=r.fromLatLngToContainerPixel(t.getCenter()),o=r.fromContainerPixelToLatLng(new i(s.x-100,s.y));t.setCenter(o)},showMarker:function(e,t){var n,r;t&&-1===--e?n=this._placeMarker:n=this.redMarkers[e],n&&(this.selectMarker(n),r=n.getPosition()),this.sizeStatus&&this._map.setZoom(this.zoomN=this.zoom16),this._map.setCenter(r),this.sizeStatus&&this.panToRight()},selectMarker:function(e){var t=this.ricon,n=this.bicon,r=this.currMarker;r&&(r.setZIndex(null),r.isBlue||r.setIcon(t)),e&&(e.setZIndex(377),e.isBlue||e.setIcon(n),this.currMarker=e)},createIcons:function(){var e=this.GMaps,t=s.site_url+"/static/img/icons.png",n=e.Size,r=e.Point;this.bicon=new e.MarkerImage(t,new n(26,36),new r(0,78)),this.ricon=new e.MarkerImage(t,new n(26,36),new r(26,78)),this.sbicon=new e.MarkerImage(t,new n(12,14),new r(52,100))},saveMarker:function(e){var t=this,n=t.hasBlue;if(!n||0!==e){n&&(this.clearBlueMarker(),e-=1);var r=this.component,i=this.GMaps.event,s=this._placeMarker=this.redMarkers.splice(e,1)[0];this.hasBlue=!0,this.selectMarker(s),i.clearListeners(s),s.isBlue=!0,s.setDraggable(!0),i.addListener(s,"click",function(){t.clearMarkers(),r.emit("change-place",this._place,"map")},!1),i.addListener(s,"dragend",function(e){var t=e.latLng;this._place.lat=""+t.lat(),this._place.lng=""+t.lng(),this._place.provider="",r.emit("change-place",this._place,"map")}),i.addListener(s,"mouseover",function(){t.selectMarker(this),r.emit("enter-placeitem",0)})}this.clearMarkers()},clear:function(){this._placeMarker&&this.clearBlueMarker(),this.clearMarkers(),this.hasBlue=!1},removeMarker:function(e){e.setMap(null),e=null},clearMarkers:function(){var e=this.redMarkers,t=this.removeMarker,n;if(!e)return;while(n=e.shift())t(n);this.curr=0},createMarkers:function(e,t){var n=this,r=!t,i=this.component,s=this.createMarker,o=this.GMaps,u=o.event,a=o.LatLng,f=o.Marker,l=new o.LatLngBounds,c=this.redMarkers,h=this._map,p=this.ricon,d,v,m,g=0,y=function(){var e=n.indexOf(n.redMarkers,this);i.placesList.clear(),i.emit("clear-marker",e),i.emit("click-placeitem",this._place)},b=function(){var e=n.indexOf(n.redMarkers,this);n.selectMarker(this),i.emit("enter-placeitem",e+=n._placeMarker?1:0)};for(;d=e[g];++g)m=d.lat?new a(d.lat,d.lng):d.geometry.location,v=s(f,{map:h,icon:p,title:d.name,position:m,zIndex:0},{title:d.title||d.name,description:d.description||d.formatted_address,lat:""+m.lat(),lng:""+m.lng(),external_id:d.id||"",provider:"google"}),u.addListener(v,"click",y,!1),u.addListener(v,"mouseover",b),c.push(v),r&&l.extend(m);r&&h.fitBounds(l)},createMarker:function(e,t,n,r){return r=new e(t),r._place=n,r},zoom:function(e){if(!this.isGo)return;this.sizeStatus=e;var t=this.component,n=this.GMaps,r=this.redMarkers,i=this;this.$wrap.toggleClass("gmap-big",!e),t.$resize.toggleClass("map-rc"),t.$mask.toggleClass("hide",!e);if(e)t.element.css({top:t.otop,left:t.oleft}),i.$element.width(i.owidth).height(i.oheight),setTimeout(function(){i._map.setOptions(i.defaultOptions),i._map.setCenter(i._placeMarker?i._placeMarker.getPosition():i._userMarker.getPosition()),i.panToRight()},0);else{var s=l.width(),o=l.height(),u=this.a,a=l.scrollTop(),f=l.scrollLeft();s*=u,o*=u,i.resize(s,o),t.element.css({top:o*(1-u)/2+a,left:s*(1-u)/2+f}),setTimeout(function(){i._map.setOptions(i.enableOptions)},0)}n.event.trigger(i._map,"resize"),!i._placeMarker&&r.length&&(i._placeMarker=r[0]),i._map.setCenter(i._placeMarker?i._placeMarker.getPosition():i._userMarker.getPosition()),t.placeInput.$element.focusend()},indexOf:function(e,t){return r.indexOf(e,t)}};var y=function(e){var n=e.split(u),r=n.length?t.trim(n.shift()):"",i=t.trim(n.join(a)).replace(u,"");return{title:r,description:i}},b=function(e,t){return e+(t?a+t.replace(u,a):"")},w=function(e){return e.getUTCFullYear()+"-"+i(e.getUTCMonth()+1)+"-"+i(e.getUTCDate())+" "+i(e.getUTCHours())+":"+i(e.getUTCMinutes())+":"+i(e.getUTCSeconds())+" +0000"},E=function(e){return c?S(e):e.selectionEnd},S=function(e){var t=document.selection.createRange(),n=e.createTextRange(),r=n.duplicate();return n.moveToBookmark(t.getBookmark()),r.setEndPoint("EndToStart",n),r.text.length+t.text.length},x=function(e){if(window.google&&window.google.maps)return;window._loadMaps=function(){},t('[src^="https://www.google.com"]').remove();var r=document.getElementsByTagName("body")[0],i=document.createElement("script");window._gmap=function(){delete window._gmap},window._loadMaps=function(){window.google.load("maps","3",{other_params:"key="+n+"&sensor=false&libraries=places",callback:function(){e()}})},i.async="async",i.src="https://www.google.com/jsapi?callback=_loadMaps",r.appendChild(i)};return d});