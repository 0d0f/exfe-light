(function(){"use strict";if(!window.DEBUG){var e=window.Debugger={};e.log=e.dir=e.warn=e.table=e.alert=function(){}}var t,n,o,i=Date.now||function(){return(new Date).getTime()},a=window._ENV_,r=a.api_url,s=a.app_scheme,d=window.history,c=window.localStorage,u=d?"popstate":"hashchange",_=window.location,f=function(){},p={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/,toapp:/^\/+toapp.*$/,wechatAboutRoutex:/^\/+wechat\/aboutroutex$/},m="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.isWeixin=!!/MicroMessenger/i.test(navigator.userAgent),window.launchApp=function(e,n){e=e||s,t=i(),l(n,200),w(e)},window.openExfe=function(e){e=e||"",t=i(),window.launchApp(e,function(){w(m)})};var w=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},l=function(e,a){o=setTimeout(function(){clearTimeout(o),n=i(),500>n-t&&(e?e():window.location.href="/"),clearTimeout(o)},a||200)},h=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},v=function(e){e()},g=function(){var e=V.getPath();("/"===e||e!==V.url)&&(v(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),V.url=e)},y=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},k=function(e){var t=new XMLHttpRequest,n=e.done||f,o=e.fail||f;return t.open(e.type||"GET",e.url,!0),t.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(t.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),t.withCredentials=!0,t.onreadystatechange=function(){if(4===t.readyState){t.onreadystatechange=void 0;var i,a=!1;if(t.status>=200&&300>t.status||304===t.status){try{i=JSON.parse(t.responseText)}catch(r){a=r}a?o(i,"parsererror",t,e):n(i,t,e)}else o(i,t.status?"error":"abort",t,e)}},t.send(e.data?y(e.data):null),t},N=function(){return!!c.getItem("error")},x=function(e){c.setItem("error",JSON.stringify(e))},I=function(){c.removeItem("error")},E=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id),c.setItem("authorization",JSON.stringify(i))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var a=t.exfee.invitations,r=0,s=a.length;s>r;++r){var d=a[r];(n&&n===d.identity.connected_user_id||o===d.identity.id)&&(o=d.identity.id)}var u=t.id||"",_="";return n&&(i?(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,_=i.token):(i=c.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(_=i.token,u+="?user_id="+n+"&token="+_+"&identity_id="+o))),[_,u]},T=function(e){var t,n,o,i,a=e.authorization;if(a?(o=a.token,t=a.user_id,c.setItem("authorization",JSON.stringify(a))):(a=JSON.parse(c.getItem("authorization")))&&(o=a.token,t=a.user_id),o)for(var r,s=e.cross.exfee.invitations,d=0,u=s.length;u>d;++d)if(r=s[d],t===r.identity.connected_user_id){i=o,n=r.identity.id;break}return[i,n]},S=function(e){x(e),window.location="/"},O=function(e,t){k({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(a._data_=e,e.meta&&200===e.meta.code){var n=E(e.response);a._data_.tokenInfos=T(e.response),n[0]&&n[1]?t||window.noExfeApp?g():window.launchApp(s+n[1],function(){setTimeout(function(){window.location="/?redirect"+_.hash},200)}):g()}else S(e.meta)},fail:function(e){S(e.meta)}})},b=function(e,t,n){for(var o=e.invitations,i=0,a=o.length;a>i;++i){var r=o[i];if(t&&t===r.identity.connected_user_id||n===r.identity.id)return r.identity}},z=function(e,t,n,o){k({url:r+"/Crosses/"+t+"?token="+e,type:"GET",done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},J=function(e,t,n){var o,i={invitation_token:e},a=JSON.parse(c.getItem("cats"));a&&(o=a[e])&&(i.cross_access_token=o),k({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:i,done:function(e){var o=e.meta.code;200===o?t(e):n(e)},error:function(e){n(e)}})},A=function(e,t,n,o,i){k({url:"/oauth/authenticate?"+(e?"base=true&":"")+"provider="+t,type:"POST",data:n,done:function(e){var t=e.meta.code;200===t?o(e):i(e)},error:function(e){i(e)}})},C=function(e,t,n,o){k({url:r+"/exfee/"+e+"/join",type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},L=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},V=function(){};V.dispatch=function(e){var t="mobile";delete a._data_;var n;if(p.home.test(e))g();else if(n=e.match(p.smsToken)){window.noExfeApp=!!n[1];var o;window.noExfeApp?(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))):(o=h(),c.setItem("tmp-token",JSON.stringify(o))),o?(a._data_=o,g()):S({code:400})}else if(n=e.match(p.resolveToken)){window.noExfeApp=!!n[1];var o;if(window.noExfeApp&&(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))),o)a._data_=o,g();else{var i=n[2];k({url:r+"/Users/ResolveToken",type:"POST",data:{token:i},done:function(e){i&&e.meta&&200===e.meta.code?(o=a._data_=e.response,c.setItem("tmp-token",JSON.stringify(o)),g()):S(e.meta)},fail:function(e){S(e.meta)}})}}else if(n=e.match(p.crossTokenForPhone)){window.noExfeApp=!!n[1];var i,d=n[2],u=n[3],f=c.cats;f&&(f=JSON.parse(f));var m={invitation_token:u,cross_id:d};f&&(i=f[u])&&(m.cross_access_token=i),O(m)}else if(n=e.match(p.crossToken)){window.noExfeApp=!!n[1];var i,u=n[2],f=c.cats,m={invitation_token:u};f&&(i=f[u])&&(m.cross_access_token=i),O(m)}else if(n=e.match(p.routex0)){var i,u=n[2],f=c.getItem("cats"),m={invitation_token:u};f&&(f=JSON.parse(f)),f&&(i=f[u])&&(m.cross_access_token=i),O(m,!0)}else if(n=e.match(p.routex1)){t="";for(var w,l,v,y=_.search.substr(1),N=y.split("&"),x={};w=N.shift();)w=w.split("="),l=w[0].toLowerCase(),v=w[1]||"",x[decodeURIComponent(l.replace(/\+/g," "))]=decodeURIComponent(v.replace(/\+/g," "));var d=n[1],I=x.xcode,E=x.via,T=JSON.parse(c.getItem("authorization")),V=T&&T.user_id,R=T&&T.token,B=T&&T.name||"",P=L();if(P&&P.authorization&&(T=P.authorization,V=T.user_id,R=T.token,B=T.name,c.setItem("authorization",JSON.stringify({user_id:V,token:R,name:B||""}))),window.isWeixin)if(V&&R)if(window._ENV_.smith_id&&window._ENV_.exfee_id){var U={xcode:I,user_token:R,widget_type:"routex"};E&&(U.via=E),C(window._ENV_.exfee_id,U,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=b(e.response.cross.exfee,V);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",g()},function(e){var t=e.meta.code;400===t?A(!1,"wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}):401===t&&(alert("无法打开“活点地图”，因为您已经从这张地图中被移除了。"),window.location.href="/")})}else z(R,d,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=b(e.response.cross.exfee,V);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",g()},function(){P&&I?J(I,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token,name:n.name}));var o=t.cross_access_token;if(o){var i=JSON.parse(c.getItem("cats"));i||(i={}),i[I]=o}a._data_=e;var r=b(e.response.cross.exfee,V);a._data_.response.browsing_identity=r,a._data_.tokenInfos=[n?n.token:null,r.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=n&&n.name||"",g()},function(e){S(e.meta)}):A(!1,"wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})});else A(!1,"wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")});else if(T)if(window._ENV_.exfee_id){var U={xcode:I,user_token:R,widget_type:"routex"};E&&(U.via=E),C(window._ENV_.exfee_id,U,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=b(e.response.cross.exfee,V);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",g()},function(e){var t=e.meta.code;400===t?S(e.meta):401===t&&(alert("无法打开“活点地图”，因为您已经从这张地图中被移除了。"),window.location.href="/")})}else z(R,d,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=b(e.response.cross.exfee,V);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",g()},function(){I&&J(I,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token,name:n.name}));var o=t.cross_access_token;if(o){var i=JSON.parse(c.getItem("cats"));i||(i={}),i[I]=o}a._data_=e;var r=b(e.response.cross.exfee,V);a._data_.response.browsing_identity=r,a._data_.tokenInfos=[n?n.token:null,r.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=n&&n.name||"",g()},function(e){S(e.meta)})})}else if(p.toapp.test(e)){t="";for(var w,l,v,y=_.search.substr(1),N=y.split("&"),n={};w=N.shift();)w=w.split("="),l=w[0].toLowerCase(),v=w[1]||"",n[decodeURIComponent(l.replace(/\+/g," "))]=decodeURIComponent(v.replace(/\+/g," "));if(n.hasOwnProperty("authenticate"))A(!0,"wechat",{refere:_.protocol+"//"+_.hostname+"/toapp"+(n.cross_id?"?cross_id="+n.cross_id:"")},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")});else{var T,V,R,B,P=L();P&&P.authorization?(T=P.authorization,V=T.user_id,R=T.token,B=T.name,c.setItem("authorization",JSON.stringify({user_id:V,token:R,name:B||""}))):(T=JSON.parse(c.getItem("authorization")))&&(V=T.user_id,R=T.token,B=T.name);var e=s,M="";n.cross_id&&(e+="!"+n.cross_id+"/routex"),T&&(M+="?user_id="+V+"&token="+R+"&username="+B),window.openExfe(e+M)}}else if(p.wechatAboutRoutex.test(e)){t="";var T,P=L();if(P&&P.authorization?(window._ENV_.authorization=P.authorization,c.setItem("authorization",JSON.stringify({user_id:T.user_id,token:T.token,name:T.name||""}))):(T=JSON.parse(c.getItem("authorization")))&&(window._ENV_.authorization=T),!T)return A(!1,"wechat",{refere:_.protocol+_.hostname+e},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}),void 0;g()}else window.location="/";t&&(document.documentElement.className=t)},V.getPath=function(){return _.pathname+_.search+_.hash},V._status=0,V.firstLoad=!1,V.handle=function(e){N()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),I());var t=V.getPath();V.dispatch(t,e)},V.start=function(){window.addEventListener(u,function(e){return V.firstLoad?V.firstLoad=!1:(e.preventDefault(),e.stopPropagation(),V.handle(e),!1)}),window.addEventListener("load",function(e){V._status||(V._status=2,V.firstLoad=!0,V.handle(e))}),document.addEventListener("DOMContentLoaded",function(e){V._status||(V._status=1,V.firstLoad=!0,V.handle(e))})},V.start()})();