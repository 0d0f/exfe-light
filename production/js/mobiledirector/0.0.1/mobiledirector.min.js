(function(){"use strict";var e,t,n,i=Date.now||function(){return(new Date).getTime()},o=window._ENV_,r=o.api_url,a=o.app_scheme,s=window.history,d=window.localStorage,c=s?"popstate":"hashchange",u=window.location,f=function(){},_=a+"://crosses/",p={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/},m="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.isWeixin=!!/MicroMessenger/.test(navigator.userAgent),window.launchApp=function(t,n){t=t||_,e=i(),h(n,200),l(t)},window.openExfe=function(t){t=t||"",e=i(),window.launchApp(t,function(){l(m)})};var l=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},h=function(o,r){n=setTimeout(function(){t=i(),1e3>t-e&&(o?o():window.location.href="/"),clearTimeout(n)},r||200)},w=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},v=function(e){e()},g=function(){var e=V.getPath();("/"===e||e!==V.url)&&(v(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),V.url=e)},y=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},k=function(e){var t,n=new XMLHttpRequest,i=e.done||f,o=e.fail||f;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var r,a=!1;if(n.status>=200&&300>n.status||304===n.status){try{r=JSON.parse(n.responseText)}catch(s){a=s}a?o(r,"parsererror",n,e):i(r,n,e)}else o(r,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?y(e.data):null),n},N=function(){return!!d.getItem("error")},I=function(e){d.setItem("error",JSON.stringify(e))},x=function(){d.removeItem("error")},S=function(e){var t=e.cross,n=0,i=0,o=e.authorization;o?(n=o.user_id,e.browsing_identity&&(i=e.browsing_identity.id),d.setItem("authorization",JSON.stringify(o))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,i=e.browsing_identity.id);for(var r=t.exfee.invitations,a=0,s=r.length;s>a;++a){var c=r[a];(n&&n===c.identity.connected_user_id||i===c.identity.id)&&(i=c.identity.id)}var u=t.id||"",f="";return n&&(o?(u+="?user_id="+n+"&token="+o.token+"&identity_id="+i,f=o.token):(o=d.getItem("authorization"))&&(o=JSON.parse(o),o.user_id===n&&(f=o.token,u+="?user_id="+n+"&token="+f+"&identity_id="+i))),[f,u]},T=function(e){var t,n,i,o,r=e.authorization;if(r?(i=r.token,t=r.user_id,d.setItem("authorization",JSON.stringify(r))):(r=JSON.parse(d.getItem("authorization")))&&(i=r.token,t=r.user_id),i)for(var a,s=e.cross.exfee.invitations,c=0,u=s.length;u>c;++c)if(a=s[c],t===a.identity.connected_user_id){o=i,n=a.identity.id;break}return[o,n]},O=function(e){I(e),window.location="/"},E=function(e,t){k({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(o._data_=e,e.meta&&200===e.meta.code){var n=S(e.response);o._data_.tokenInfos=T(e.response),n[0]&&n[1]?t||window.noExfeApp?g():window.launchApp(_+n[1],function(){window.location="/?redirect"+u.hash},500):g()}else O(e.meta)},fail:function(e){O(e.meta)}})},b=function(e,t,n){for(var i=e.invitations,o=0,r=i.length;r>o;++o){var a=i[o];if(t&&t===a.identity.connected_user_id||n===a.identity.id)return a.identity}},A=function(e,t,n,i){k({url:r+"/Crosses/"+t+"?token="+e,type:"GET",done:function(e){var t=e.meta.code;200===t?n(e):i(e)},error:function(e){i(e)}})},J=function(e,t,n){var i,o={invitation_token:e},a=JSON.parse(d.getItem("cats"));a&&(i=a[e])&&(o.cross_access_token=i),k({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:o,done:function(e){var i=e.meta.code;200===i?t(e):n(e)},error:function(e){n(e)}})},z=function(e,t,n,i){k({url:"/oauth/authenticate?provider="+e,type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):i(e)},error:function(e){i(e)}})},C=function(e,t,n,i){k({url:r+"/exfee/"+e+"/invite",type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):i(e)},error:function(e){i(e)}})},P=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},V=function(){};V.dispatch=function(e){delete o._data_,window.noExfeApp=!!e.match(/\?redirect/);var t;if(p.home.test(e))g();else if(t=e.match(p.smsToken)){window.noExfeApp=!!t[1];var n;window.noExfeApp?(n=d.getItem("tmp-token"),n&&(n=JSON.parse(n))):(n=w(),d.setItem("tmp-token",JSON.stringify(n))),n?(o._data_=n,g()):O({code:400})}else if(t=e.match(p.resolveToken)){var n;if(window.noExfeApp&&(n=d.getItem("tmp-token"),n&&(n=JSON.parse(n))),n)o._data_=n,g();else{var i=t[2];k({url:r+"/Users/ResolveToken",type:"POST",data:{token:i},done:function(e){i&&e.meta&&200===e.meta.code?(n=o._data_=e.response,d.setItem("tmp-token",JSON.stringify(n)),g()):O(e.meta)},fail:function(e){O(e.meta)}})}}else if(t=e.match(p.crossTokenForPhone)){var i,a=t[2],s=t[3],c=d.getItem("cats");c&&(c=JSON.parse(c));var f={invitation_token:s,cross_id:a};c&&(i=c[s])&&(f.cross_access_token=i),E(f)}else if(t=e.match(p.crossToken)){var i,s=t[2],c=d.getItem("cats"),f={invitation_token:s};c&&(c=JSON.parse(c)),c&&(i=c[s])&&(f.cross_access_token=i),E(f)}else if(t=e.match(p.routex0)){var i,s=t[2],c=d.getItem("cats"),f={invitation_token:s};c&&(c=JSON.parse(c)),c&&(i=c[s])&&(f.cross_access_token=i),E(f,!0)}else if(t=e.match(p.routex1)){for(var _,m,l,h=u.search.substr(1),v=h.split("&"),y={};_=v.shift();)_=_.split("="),m=_[0],l=_[1]||"",y[decodeURIComponent(m.replace(/\+/g," "))]=decodeURIComponent(l.replace(/\+/g," "));var a=t[1],N=y.xcode,I=y.via,x=JSON.parse(d.getItem("authorization")),S=x&&x.user_id,T=x&&x.token,V=P();if(V&&V.authorization&&(x=V.authorization,S=x.user_id,T=x.token,d.setItem("authorization",JSON.stringify({user_id:S,token:T}))),window.isWeixin)if(S&&T)if(window._ENV_.smith_id&&window._ENV_.exfee_id){var R={user_id:S,xcode:N,widget:"routex"};I&&(R.via=I),C(window._ENV_.exfee_id,R,function(e){o._data_=e;var t=b(e.response.cross.exfee,S);o._data_.response.browsing_identity=t,o._data_.tokenInfos=[T,t.id],o._data_.smith_id=window._ENV_.smith_id,g()},function(e){var t=e.meta.code,n=e.meta.errorType;if(400===t)switch(n){case"already_in":}A(T,a,function(e){o._data_=e;var t=b(e.response.cross.exfee,S);o._data_.response.browsing_identity=t,o._data_.tokenInfos=[T,t.id],o._data_.smith_id=window._ENV_.smith_id,g()},function(){V?J(N,function(e){var t=e.response,n=t.authorization;n&&d.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token}));var i=t.cross_access_token;if(i){var r=JSON.parse(d.getItem("cats"));r||(r={}),r[N]=i}o._data_=e;var a=b(e.response.cross.exfee,S);o._data_.response.browsing_identity=a,o._data_.tokenInfos=[n?n.token:null,a.id],o._data_.smith_id=window._ENV_.smith_id,g()},function(e){O(e.meta)}):z("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){})})})}else A(T,a,function(e){o._data_=e;var t=b(e.response.cross.exfee,S);o._data_.response.browsing_identity=t,o._data_.tokenInfos=[T,t.id],o._data_.smith_id=window._ENV_.smith_id,g()},function(){V?J(N,function(e){var t=e.response,n=t.authorization;n&&d.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token}));var i=t.cross_access_token;if(i){var r=JSON.parse(d.getItem("cats"));r||(r={}),r[N]=i}o._data_=e;var a=b(e.response.cross.exfee,S);o._data_.response.browsing_identity=a,o._data_.tokenInfos=[n?n.token:null,a.id],o._data_.smith_id=window._ENV_.smith_id,g()},function(e){O(e.meta)}):z("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("Wechat OAuth fail.")})});else z("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("Wechat OAuth fail.")})}else window.location="/"},V.getPath=function(){return u.pathname+u.search+u.hash},V.handle=function(e){N()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),x());var t=V.getPath();V.dispatch(t,e)},V.start=function(){window.addEventListener("pageshow",function(e){e.persisted&&g()}),document.addEventListener("webkitvisibilitychange",function(){"visible"===document.webkitVisibilityState&&g()}),window.addEventListener(c,function(e){return V.handle(e),e.stopPropagation(),e.preventDefault(),!1})},V.start()})();