(function(){"use strict";if(!window.DEBUG){var e=window.Debugger={};e.log=e.dir=e.warn=e.table=e.alert=function(){}}var t,n,o,i=Date.now||function(){return(new Date).getTime()},a=window._ENV_,r=a.api_url,s=a.app_scheme,d=window.history,c=window.localStorage,u=d?"popstate":"hashchange",_=window.location,f=function(){},p=s+":///",m={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/,toapp:/^\/+toapp.*$/,wechatAboutRoutex:/^\/+wechat\/aboutroutex$/},w="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.isWeixin=!!/MicroMessenger/i.test(navigator.userAgent),window.launchApp=function(e,n){e=e||p,t=i(),h(n,200),l(e)},window.openExfe=function(e){e=e||"",t=i(),window.launchApp(e,function(){l(w)})};var l=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},h=function(e,a){o=setTimeout(function(){clearTimeout(o),n=i(),500>n-t&&(e?e():window.location.href="/"),clearTimeout(o)},a||200)},v=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},g=function(e){e()},y=function(){var e=R.getPath();("/"===e||e!==R.url)&&(g(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),R.url=e)},k=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},N=function(e){var t,n=new XMLHttpRequest,o=e.done||f,i=e.fail||f;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var a,r=!1;if(n.status>=200&&300>n.status||304===n.status){try{a=JSON.parse(n.responseText)}catch(s){r=s}r?i(a,"parsererror",n,e):o(a,n,e)}else i(a,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?k(e.data):null),n},x=function(){return!!c.getItem("error")},I=function(e){c.setItem("error",JSON.stringify(e))},E=function(){c.removeItem("error")},T=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id),c.setItem("authorization",JSON.stringify(i))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var a=t.exfee.invitations,r=0,s=a.length;s>r;++r){var d=a[r];(n&&n===d.identity.connected_user_id||o===d.identity.id)&&(o=d.identity.id)}var u=t.id||"",_="";return n&&(i?(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,_=i.token):(i=c.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(_=i.token,u+="?user_id="+n+"&token="+_+"&identity_id="+o))),[_,u]},S=function(e){var t,n,o,i,a=e.authorization;if(a?(o=a.token,t=a.user_id,c.setItem("authorization",JSON.stringify(a))):(a=JSON.parse(c.getItem("authorization")))&&(o=a.token,t=a.user_id),o)for(var r,s=e.cross.exfee.invitations,d=0,u=s.length;u>d;++d)if(r=s[d],t===r.identity.connected_user_id){i=o,n=r.identity.id;break}return[i,n]},b=function(e){I(e),window.location="/"},O=function(e,t){N({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(a._data_=e,e.meta&&200===e.meta.code){var n=T(e.response);a._data_.tokenInfos=S(e.response),n[0]&&n[1]?t||window.noExfeApp?y():window.launchApp(p+n[1],function(){setTimeout(function(){window.location="/?redirect"+_.hash},200)}):y()}else b(e.meta)},fail:function(e){b(e.meta)}})},z=function(e,t,n){for(var o=e.invitations,i=0,a=o.length;a>i;++i){var r=o[i];if(t&&t===r.identity.connected_user_id||n===r.identity.id)return r.identity}},J=function(e,t,n,o){N({url:r+"/Crosses/"+t+"?token="+e,type:"GET",done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},A=function(e,t,n){var o,i={invitation_token:e},a=JSON.parse(c.getItem("cats"));a&&(o=a[e])&&(i.cross_access_token=o),N({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:i,done:function(e){var o=e.meta.code;200===o?t(e):n(e)},error:function(e){n(e)}})},C=function(e,t,n,o,i){N({url:"/oauth/authenticate?"+(e?"base=true&":"")+"provider="+t,type:"POST",data:n,done:function(e){var t=e.meta.code;200===t?o(e):i(e)},error:function(e){i(e)}})},L=function(e,t,n,o){N({url:r+"/exfee/"+e+"/join",type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},V=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},R=function(){};R.dispatch=function(e){var t="mobile";delete a._data_;var n;if(m.home.test(e))y();else if(n=e.match(m.smsToken)){window.noExfeApp=!!n[1];var o;window.noExfeApp?(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))):(o=v(),c.setItem("tmp-token",JSON.stringify(o))),o?(a._data_=o,y()):b({code:400})}else if(n=e.match(m.resolveToken)){window.noExfeApp=!!n[1];var o;if(window.noExfeApp&&(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))),o)a._data_=o,y();else{var i=n[2];N({url:r+"/Users/ResolveToken",type:"POST",data:{token:i},done:function(e){i&&e.meta&&200===e.meta.code?(o=a._data_=e.response,c.setItem("tmp-token",JSON.stringify(o)),y()):b(e.meta)},fail:function(e){b(e.meta)}})}}else if(n=e.match(m.crossTokenForPhone)){window.noExfeApp=!!n[1];var i,s=n[2],d=n[3],u=c.cats;u&&(u=JSON.parse(u));var f={invitation_token:d,cross_id:s};u&&(i=u[d])&&(f.cross_access_token=i),O(f)}else if(n=e.match(m.crossToken)){window.noExfeApp=!!n[1];var i,d=n[2],u=c.cats,f={invitation_token:d};u&&(i=u[d])&&(f.cross_access_token=i),O(f)}else if(n=e.match(m.routex0)){var i,d=n[2],u=c.getItem("cats"),f={invitation_token:d};u&&(u=JSON.parse(u)),u&&(i=u[d])&&(f.cross_access_token=i),O(f,!0)}else if(n=e.match(m.routex1)){t="";for(var w,l,h,g=_.search.substr(1),k=g.split("&"),x={};w=k.shift();)w=w.split("="),l=w[0].toLowerCase(),h=w[1]||"",x[decodeURIComponent(l.replace(/\+/g," "))]=decodeURIComponent(h.replace(/\+/g," "));var s=n[1],I=x.xcode,E=x.via,T=JSON.parse(c.getItem("authorization")),S=T&&T.user_id,R=T&&T.token,B=T&&T.name||"",P=V();if(P&&P.authorization&&(T=P.authorization,S=T.user_id,R=T.token,B=T.name,c.setItem("authorization",JSON.stringify({user_id:S,token:R,name:B||""}))),window.isWeixin)if(S&&R)if(window._ENV_.smith_id&&window._ENV_.exfee_id){var U={xcode:I,user_token:R,widget_type:"routex"};E&&(U.via=E),L(window._ENV_.exfee_id,U,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",y()},function(e){var t=e.meta.code;400===t?C(!1,"wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}):401===t&&(alert("无法打开“活点地图”，因为您已经从这张地图中被移除了。"),window.location.href="/")})}else J(R,s,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",y()},function(){P&&I?A(I,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token,name:n.name}));var o=t.cross_access_token;if(o){var i=JSON.parse(c.getItem("cats"));i||(i={}),i[I]=o}a._data_=e;var r=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=r,a._data_.tokenInfos=[n?n.token:null,r.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=n&&n.name||"",y()},function(e){b(e.meta)}):C(!1,"wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})});else C(!1,"wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")});else if(T)if(window._ENV_.exfee_id){var U={xcode:I,user_token:R,widget_type:"routex"};E&&(U.via=E),L(window._ENV_.exfee_id,U,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",y()},function(e){var t=e.meta.code;400===t?b(e.meta):401===t&&(alert("无法打开“活点地图”，因为您已经从这张地图中被移除了。"),window.location.href="/")})}else J(R,s,function(e){document.getElementById("app-body").innerHTML='<div id="app-status" class="page">加载中……</div>',a._data_=e;var t=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[R,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=B||"",y()},function(){I&&A(I,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token,name:n.name}));var o=t.cross_access_token;if(o){var i=JSON.parse(c.getItem("cats"));i||(i={}),i[I]=o}a._data_=e;var r=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=r,a._data_.tokenInfos=[n?n.token:null,r.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=n&&n.name||"",y()},function(e){b(e.meta)})})}else if(m.toapp.test(e)){t="";for(var w,l,h,g=_.search.substr(1),k=g.split("&"),n={};w=k.shift();)w=w.split("="),l=w[0].toLowerCase(),h=w[1]||"",n[decodeURIComponent(l.replace(/\+/g," "))]=decodeURIComponent(h.replace(/\+/g," "));if(n.hasOwnProperty("authenticate"))C(!0,"wechat",{refere:_.protocol+"//"+_.hostname+"/toapp"+(n.cross_id?"?cross_id="+n.cross_id:"")},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")});else{var T,S,R,B,P=V();P&&P.authorization?(T=P.authorization,S=T.user_id,R=T.token,B=T.name,c.setItem("authorization",JSON.stringify({user_id:S,token:R,name:B||""}))):(T=JSON.parse(c.getItem("authorization")))&&(S=T.user_id,R=T.token,B=T.name);var e=p,M="";n.cross_id&&(e+="!"+n.cross_id+"/routex"),T&&(M+="?user_id="+S+"&token="+R+"&username="+B),window.openExfe(e+M)}}else if(m.wechatAboutRoutex.test(e)){t="";var T,P=V();if(P&&P.authorization?(window._ENV_.authorization=P.authorization,c.setItem("authorization",JSON.stringify({user_id:T.user_id,token:T.token,name:T.name||""}))):(T=JSON.parse(c.getItem("authorization")))&&(window._ENV_.authorization=T),!T)return C(!1,"wechat",{refere:_.protocol+_.hostname+e},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}),void 0;y()}else window.location="/";t&&(document.documentElement.className=t)},R.getPath=function(){return _.pathname+_.search+_.hash},R._status=0,R.firstLoad=!1,R.handle=function(e){x()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),E());var t=R.getPath();R.dispatch(t,e)},R.start=function(){window.addEventListener(u,function(e){return R.firstLoad?R.firstLoad=!1:(e.preventDefault(),e.stopPropagation(),R.handle(e),!1)}),window.addEventListener("load",function(e){R._status||(R._status=2,R.firstLoad=!0,R.handle(e))}),document.addEventListener("DOMContentLoaded",function(e){R._status||(R._status=1,R.firstLoad=!0,R.handle(e))})},R.start()})();