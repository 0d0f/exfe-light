(function(){"use strict";var e,t,n,o=Date.now||function(){return(new Date).getTime()},i=window._ENV_,r=i.api_url,a=i.app_scheme,s=i.JSFILE,d=(i.CSSFILE,window.history),c=window.localStorage,u=d?"popstate":"hashchange",f=window.location,_=function(){},p=a+"://crosses/",m={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/},l="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.isWeixin=!!/MicroMessenger/.test(navigator.userAgent),window.launchApp=function(t,n){t=t||p,e=o(),h(n,200),w(t)},window.openExfe=function(){e=o(),window.launchApp("",function(){w(l)},1e3)};var w=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},h=function(i,r){n=setTimeout(function(){clearTimeout(n),t=o(),500>t-e&&(i?i():window.location.href="/"),clearTimeout(n)},r||200)},v=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},y=function(e){var t=document.getElementById(e);return!!t},g=function(e,t,n,o){var i=document.createElement("script");i.src=e,i.id=t,i.async=!0,i.onload=n||_,i.onerror=o||_,document.body.appendChild(i)},k=function(e){var t="mobile-js";y(t)?e():g("/static/js/"+s,t,e)},I=function(){var e=q.getPath();("/"===e||e!==q.url)&&(k(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),q.url=e)},N=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},x=function(e){var t,n=new XMLHttpRequest,o=e.done||_,i=e.fail||_;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var r,a=!1;if(n.status>=200&&300>n.status||304===n.status){try{r=JSON.parse(n.responseText)}catch(s){a=s}a?i(r,"parsererror",n,e):o(r,n,e)}else i(r,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?N(e.data):null),n},E=function(){return!!c.getItem("error")},S=function(e){c.setItem("error",JSON.stringify(e))},T=function(){c.removeItem("error")},O=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id),c.setItem("authorization",JSON.stringify(i))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var r=t.exfee.invitations,a=0,s=r.length;s>a;++a){var d=r[a];(n&&n===d.identity.connected_user_id||o===d.identity.id)&&(o=d.identity.id)}var u=t.id||"",f="";return n&&(i?(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,f=i.token):(i=c.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(f=i.token,u+="?user_id="+n+"&token="+f+"&identity_id="+o))),[f,u]},b=function(e){var t,n,o,i,r=e.authorization;if(r?(o=r.token,t=r.user_id,c.setItem("authorization",JSON.stringify(r))):(r=JSON.parse(c.getItem("authorization")))&&(o=r.token,t=r.user_id),o)for(var a,s=e.cross.exfee.invitations,d=0,u=s.length;u>d;++d)if(a=s[d],t===a.identity.connected_user_id){i=o,n=a.identity.id;break}return[i,n]},A=function(e){S(e),window.location="/"},J=function(e,t){x({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(i._data_=e,e.meta&&200===e.meta.code){var n=O(e.response);i._data_.tokenInfos=b(e.response),n[0]&&n[1]?t||window.noExfeApp?I():window.launchApp(p+n[1],function(){setTimeout(function(){window.location="/?redirect"+f.hash},200)}):I()}else A(e.meta)},fail:function(e){A(e.meta)}})},z=function(e,t,n){for(var o=e.invitations,i=0,r=o.length;r>i;++i){var a=o[i];if(t&&t===a.identity.connected_user_id||n===a.identity.id)return a.identity}},C=function(e,t,n,o){x({url:r+"/Crosses/"+t+"?token="+e,type:"GET",done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},P=function(e,t,n){var o,i={invitation_token:e},a=JSON.parse(c.getItem("cats"));a&&(o=a[e])&&(i.cross_access_token=o),x({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:i,done:function(e){var o=e.meta.code;200===o?t(e):n(e)},error:function(e){n(e)}})},V=function(e,t,n,o){x({url:"/oauth/authenticate?provider="+e,type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},R=function(e,t,n,o){x({url:r+"/exfee/"+e+"/invite",type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},B=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},q=function(){};q.dispatch=function(e){delete i._data_;var t;if(m.home.test(e))I();else if(t=e.match(m.smsToken)){window.noExfeApp=!!t[1];var n;window.noExfeApp?(n=c.getItem("tmp-token"),n&&(n=JSON.parse(n))):(n=v(),c.setItem("tmp-token",JSON.stringify(n))),n?(i._data_=n,I()):A({code:400})}else if(t=e.match(m.resolveToken)){window.noExfeApp=!!t[1];var n;if(window.noExfeApp&&(n=c.getItem("tmp-token"),n&&(n=JSON.parse(n))),n)i._data_=n,I();else{var o=t[2];x({url:r+"/Users/ResolveToken",type:"POST",data:{token:o},done:function(e){o&&e.meta&&200===e.meta.code?(n=i._data_=e.response,c.setItem("tmp-token",JSON.stringify(n)),I()):A(e.meta)},fail:function(e){A(e.meta)}})}}else if(t=e.match(m.crossTokenForPhone)){window.noExfeApp=!!t[1];var o,a=t[2],s=t[3],d=c.cats;d&&(d=JSON.parse(d));var u={invitation_token:s,cross_id:a};d&&(o=d[s])&&(u.cross_access_token=o),J(u)}else if(t=e.match(m.crossToken)){window.noExfeApp=!!t[1];var o,s=t[2],d=c.cats,u={invitation_token:s};d&&(o=d[s])&&(u.cross_access_token=o),J(u)}else if(t=e.match(m.routex0)){var o,s=t[2],d=c.getItem("cats"),u={invitation_token:s};d&&(d=JSON.parse(d)),d&&(o=d[s])&&(u.cross_access_token=o),J(u,!0)}else if(t=e.match(m.routex1)){for(var _,p,l,w=f.search.substr(1),h=w.split("&"),y={};_=h.shift();)_=_.split("="),p=_[0],l=_[1]||"",y[decodeURIComponent(p.replace(/\+/g," "))]=decodeURIComponent(l.replace(/\+/g," "));var a=t[1],g=y.xcode,k=y.via,N=JSON.parse(c.getItem("authorization")),E=N&&N.user_id,S=N&&N.token,T=B();if(T&&T.authorization&&(N=T.authorization,E=N.user_id,S=N.token,c.setItem("authorization",JSON.stringify({user_id:E,token:S}))),window.isWeixin)if(E&&S)if(window._ENV_.smith_id&&window._ENV_.exfee_id){var O={user_id:E,xcode:g,widget:"routex"};k&&(O.via=k),R(window._ENV_.exfee_id,O,function(e){i._data_=e;var t=z(e.response.cross.exfee,E);i._data_.response.browsing_identity=t,i._data_.tokenInfos=[S,t.id],i._data_.smith_id=window._ENV_.smith_id,I()},function(e){var t=e.meta.code,n=e.meta.errorType;if(400===t)switch(n){case"already_in":}C(S,a,function(e){i._data_=e;var t=z(e.response.cross.exfee,E);i._data_.response.browsing_identity=t,i._data_.tokenInfos=[S,t.id],i._data_.smith_id=window._ENV_.smith_id,I()},function(){T?P(g,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token}));var o=t.cross_access_token;if(o){var r=JSON.parse(c.getItem("cats"));r||(r={}),r[g]=o}i._data_=e;var a=z(e.response.cross.exfee,E);i._data_.response.browsing_identity=a,i._data_.tokenInfos=[n?n.token:null,a.id],i._data_.smith_id=window._ENV_.smith_id,I()},function(e){A(e.meta)}):V("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){})})})}else C(S,a,function(e){i._data_=e;var t=z(e.response.cross.exfee,E);i._data_.response.browsing_identity=t,i._data_.tokenInfos=[S,t.id],i._data_.smith_id=window._ENV_.smith_id,I()},function(){T?P(g,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token}));var o=t.cross_access_token;if(o){var r=JSON.parse(c.getItem("cats"));r||(r={}),r[g]=o}i._data_=e;var a=z(e.response.cross.exfee,E);i._data_.response.browsing_identity=a,i._data_.tokenInfos=[n?n.token:null,a.id],i._data_.smith_id=window._ENV_.smith_id,I()},function(e){A(e.meta)}):V("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("Wechat OAuth fail.")})});else V("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("Wechat OAuth fail.")})}else window.location="/"},q.getPath=function(){return f.pathname+f.search+f.hash},q.handle=function(e){E()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),T());var t=q.getPath();q.dispatch(t,e)},q.start=function(){window.addEventListener("pageshow",function(e){e.persisted&&I()}),document.addEventListener("webkitvisibilitychange",function(){"visible"===document.webkitVisibilityState&&I()}),window.addEventListener(u,function(e){return q.handle(e),e.stopPropagation(),e.preventDefault(),!1})},q.start()})();