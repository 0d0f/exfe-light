(function(){"use strict";if(!window.DEBUG){var e=window.Debugger={};e.log=e.dir=e.warn=e.table=e.alert=function(){}}var t,n,o,i=Date.now||function(){return(new Date).getTime()},a=window._ENV_,r=a.api_url,s=a.app_scheme,d=window.history,c=window.localStorage,u=d?"popstate":"hashchange",p=window.location,f=function(){},m=s+":///",_={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/,toapp:/^\/+toapp.*$/,wechatAboutRoutex:/^\/+wechat\/aboutroutex$/},l="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.isWeixin=!!/MicroMessenger/i.test(navigator.userAgent),window.launchApp=function(e,n){e=e||m,t=i(),h(n,200),w(e)},window.openExfe=function(e){e=e||"",t=i(),window.launchApp(e,function(){w(l)})};var w=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},h=function(e,a){o=setTimeout(function(){clearTimeout(o),n=i(),500>n-t&&(e?e():window.location.href="/"),clearTimeout(o)},a||200)},v=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},y=function(e){e()},g=function(){var e=P.getPath();("/"===e||e!==P.url)&&(y(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),P.url=e)},k=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},I=function(e){var t,n=new XMLHttpRequest,o=e.done||f,i=e.fail||f;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var a,r=!1;if(n.status>=200&&300>n.status||304===n.status){try{a=JSON.parse(n.responseText)}catch(s){r=s}r?i(a,"parsererror",n,e):o(a,n,e)}else i(a,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?k(e.data):null),n},N=function(){return!!c.getItem("error")},x=function(e){c.setItem("error",JSON.stringify(e))},T=function(){c.removeItem("error")},E=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id),c.setItem("authorization",JSON.stringify(i))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var a=t.exfee.invitations,r=0,s=a.length;s>r;++r){var d=a[r];(n&&n===d.identity.connected_user_id||o===d.identity.id)&&(o=d.identity.id)}var u=t.id||"",p="";return n&&(i?(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,p=i.token):(i=c.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(p=i.token,u+="?user_id="+n+"&token="+p+"&identity_id="+o))),[p,u]},b=function(e){var t,n,o,i,a=e.authorization;if(a?(o=a.token,t=a.user_id,c.setItem("authorization",JSON.stringify(a))):(a=JSON.parse(c.getItem("authorization")))&&(o=a.token,t=a.user_id),o)for(var r,s=e.cross.exfee.invitations,d=0,u=s.length;u>d;++d)if(r=s[d],t===r.identity.connected_user_id){i=o,n=r.identity.id;break}return[i,n]},S=function(e){x(e),window.location="/"},O=function(e,t){I({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(a._data_=e,e.meta&&200===e.meta.code){var n=E(e.response);a._data_.tokenInfos=b(e.response),n[0]&&n[1]?t||window.noExfeApp?g():window.launchApp(m+n[1],function(){setTimeout(function(){window.location="/?redirect"+p.hash},200)}):g()}else S(e.meta)},fail:function(e){S(e.meta)}})},z=function(e,t,n){for(var o=e.invitations,i=0,a=o.length;a>i;++i){var r=o[i];if(t&&t===r.identity.connected_user_id||n===r.identity.id)return r.identity}},A=function(e,t,n,o){I({url:r+"/Crosses/"+t+"?token="+e,type:"GET",done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},J=function(e,t,n){var o,i={invitation_token:e},a=JSON.parse(c.getItem("cats"));a&&(o=a[e])&&(i.cross_access_token=o),I({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:i,done:function(e){var o=e.meta.code;200===o?t(e):n(e)},error:function(e){n(e)}})},C=function(e,t,n,o){document.getElementById("app-body").innerHTML='<div id="app-status">微信鉴权中……</div>',I({url:"/oauth/authenticate?provider="+e,type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},R=function(e,t,n,o){I({url:r+"/exfee/"+e+"/join",type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},B=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},P=function(){};P.dispatch=function(e){var t="mobile";delete a._data_;var n;if(_.home.test(e))g();else if(n=e.match(_.smsToken)){window.noExfeApp=!!n[1];var o;window.noExfeApp?(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))):(o=v(),c.setItem("tmp-token",JSON.stringify(o))),o?(a._data_=o,g()):S({code:400})}else if(n=e.match(_.resolveToken)){window.noExfeApp=!!n[1];var o;if(window.noExfeApp&&(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))),o)a._data_=o,g();else{var i=n[2];I({url:r+"/Users/ResolveToken",type:"POST",data:{token:i},done:function(e){i&&e.meta&&200===e.meta.code?(o=a._data_=e.response,c.setItem("tmp-token",JSON.stringify(o)),g()):S(e.meta)},fail:function(e){S(e.meta)}})}}else if(n=e.match(_.crossTokenForPhone)){window.noExfeApp=!!n[1];var i,s=n[2],d=n[3],u=c.cats;u&&(u=JSON.parse(u));var f={invitation_token:d,cross_id:s};u&&(i=u[d])&&(f.cross_access_token=i),O(f)}else if(n=e.match(_.crossToken)){window.noExfeApp=!!n[1];var i,d=n[2],u=c.cats,f={invitation_token:d};u&&(i=u[d])&&(f.cross_access_token=i),O(f)}else if(n=e.match(_.routex0)){var i,d=n[2],u=c.getItem("cats"),f={invitation_token:d};u&&(u=JSON.parse(u)),u&&(i=u[d])&&(f.cross_access_token=i),O(f,!0)}else if(n=e.match(_.routex1)){t="",document.getElementById("app-body").innerHTML='<div id="app-status">页面加载中……</div>';for(var l,w,h,y=p.search.substr(1),k=y.split("&"),N={};l=k.shift();)l=l.split("="),w=l[0].toLowerCase(),h=l[1]||"",N[decodeURIComponent(w.replace(/\+/g," "))]=decodeURIComponent(h.replace(/\+/g," "));var s=n[1],x=N.xcode,T=N.via,E=JSON.parse(c.getItem("authorization")),b=E&&E.user_id,P=E&&E.token,L=E&&E.name||"",U=B();if(U&&U.authorization&&(E=U.authorization,b=E.user_id,P=E.token,L=E.name,c.setItem("authorization",JSON.stringify({user_id:b,token:P,name:L||""}))),window.isWeixin)if(b&&P)if(window._ENV_.smith_id&&window._ENV_.exfee_id){var V={xcode:x,user_token:P,widget_type:"routex"};T&&(V.via=T),R(window._ENV_.exfee_id,V,function(e){a._data_=e;var t=z(e.response.cross.exfee,b);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[P,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=L||"",g()},function(e){var t=e.meta.code;e.meta.errorType,400===t&&C("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})})}else A(P,s,function(e){a._data_=e;var t=z(e.response.cross.exfee,b);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[P,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=L||"",g()},function(){U&&x?J(x,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token,name:n.name}));var o=t.cross_access_token;if(o){var i=JSON.parse(c.getItem("cats"));i||(i={}),i[x]=o}a._data_=e;var r=z(e.response.cross.exfee,b);a._data_.response.browsing_identity=r,a._data_.tokenInfos=[n?n.token:null,r.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=n&&n.name||"",g()},function(e){S(e.meta)}):C("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})});else C("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})}else if(_.toapp.test(e)){t="",document.getElementById("app-body").innerHTML='<div id="app-status">页面加载中……</div>';for(var l,w,h,y=p.search.substr(1),k=y.split("&"),n={};l=k.shift();)l=l.split("="),w=l[0].toLowerCase(),h=l[1]||"",n[decodeURIComponent(w.replace(/\+/g," "))]=decodeURIComponent(h.replace(/\+/g," "));if(n.hasOwnProperty("authenticate"))C("wechat",{refere:p.protocol+"//"+p.hostname+"/toapp"+(n.cross_id?"?cross_id="+n.cross_id:"")},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")});else{var E,b,P,L,U=B();U&&U.authorization?(E=U.authorization,b=E.user_id,P=E.token,L=E.name,c.setItem("authorization",JSON.stringify({user_id:b,token:P,name:L||""}))):(E=JSON.parse(c.getItem("authorization")))&&(b=E.user_id,P=E.token,L=E.name);var e=m,$="";n.cross_id&&(e+="!"+n.cross_id+"/routex"),E&&($+="?user_id="+b+"&token="+P+"&username="+L),openExfe(e+$)}}else if(_.wechatAboutRoutex.test(e)){t="",document.getElementById("app-body").innerHTML='<div id="app-status">页面加载中……</div>';var E,U=B();if(U&&U.authorization?(window._ENV_.authorization=U.authorization,c.setItem("authorization",JSON.stringify({user_id:E.user_id,token:E.token,name:E.name||""}))):(E=JSON.parse(c.getItem("authorization")))&&(window._ENV_.authorization=E),!E)return C("wechat",{refere:p.protocol+p.hostname+e},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}),void 0;g()}else window.location="/";t&&(document.documentElement.className=t)},P.getPath=function(){return p.pathname+p.search+p.hash},P.handle=function(e){N()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),T());var t=P.getPath();P.dispatch(t,e)},P.start=function(){window.addEventListener("pageshow",function(e){e.persisted&&g()}),document.addEventListener("webkitvisibilitychange",function(){"visible"===document.webkitVisibilityState&&g()}),window.addEventListener(u,function(e){return P.handle(e),e.stopPropagation(),e.preventDefault(),!1})},P.start()})();