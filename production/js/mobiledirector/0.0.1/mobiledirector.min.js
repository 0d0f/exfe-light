(function(){"use strict";var e,t,n,o=Date.now||function(){return(new Date).getTime()},i=window._ENV_,a=i.api_url,r=i.app_scheme,s=window.history,d=window.localStorage,c=s?"popstate":"hashchange",u=window.location,f=function(){},p=r+":///",_={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/,toapp:/^\+toapp.*$/,wechatAboutRoutex:/^\wechat\/aboutroutex$/},m="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.isWeixin=!!/MicroMessenger/i.test(navigator.userAgent),window.launchApp=function(t,n){t=t||p,e=o(),w(n,200),l(t)},window.openExfe=function(t){t=t||"",e=o(),window.launchApp(t,function(){l(m)})};var l=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},w=function(i,a){n=setTimeout(function(){clearTimeout(n),t=o(),500>t-e&&(i?i():window.location.href="/"),clearTimeout(n)},a||200)},h=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},v=function(e){e()},y=function(){var e=P.getPath();("/"===e||e!==P.url)&&(v(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),P.url=e)},g=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},k=function(e){var t,n=new XMLHttpRequest,o=e.done||f,i=e.fail||f;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var a,r=!1;if(n.status>=200&&300>n.status||304===n.status){try{a=JSON.parse(n.responseText)}catch(s){r=s}r?i(a,"parsererror",n,e):o(a,n,e)}else i(a,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?g(e.data):null),n},x=function(){return!!d.getItem("error")},N=function(e){d.setItem("error",JSON.stringify(e))},I=function(){d.removeItem("error")},T=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id),d.setItem("authorization",JSON.stringify(i))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var a=t.exfee.invitations,r=0,s=a.length;s>r;++r){var c=a[r];(n&&n===c.identity.connected_user_id||o===c.identity.id)&&(o=c.identity.id)}var u=t.id||"",f="";return n&&(i?(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,f=i.token):(i=d.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(f=i.token,u+="?user_id="+n+"&token="+f+"&identity_id="+o))),[f,u]},E=function(e){var t,n,o,i,a=e.authorization;if(a?(o=a.token,t=a.user_id,d.setItem("authorization",JSON.stringify(a))):(a=JSON.parse(d.getItem("authorization")))&&(o=a.token,t=a.user_id),o)for(var r,s=e.cross.exfee.invitations,c=0,u=s.length;u>c;++c)if(r=s[c],t===r.identity.connected_user_id){i=o,n=r.identity.id;break}return[i,n]},S=function(e){N(e),window.location="/"},b=function(e,t){k({url:a+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(i._data_=e,e.meta&&200===e.meta.code){var n=T(e.response);i._data_.tokenInfos=E(e.response),n[0]&&n[1]?t||window.noExfeApp?y():window.launchApp(p+n[1],function(){setTimeout(function(){window.location="/?redirect"+u.hash},200)}):y()}else S(e.meta)},fail:function(e){S(e.meta)}})},z=function(e,t,n){for(var o=e.invitations,i=0,a=o.length;a>i;++i){var r=o[i];if(t&&t===r.identity.connected_user_id||n===r.identity.id)return r.identity}},O=function(e,t,n,o){k({url:a+"/Crosses/"+t+"?token="+e,type:"GET",done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},A=function(e,t,n){var o,i={invitation_token:e},r=JSON.parse(d.getItem("cats"));r&&(o=r[e])&&(i.cross_access_token=o),k({url:a+"/Crosses/GetCrossByInvitationToken",type:"POST",data:i,done:function(e){var o=e.meta.code;200===o?t(e):n(e)},error:function(e){n(e)}})},J=function(e,t,n,o){document.getElementById("app-body").innerHTML='<div id="app-status">微信鉴权中……</div>',k({url:"/oauth/authenticate?provider="+e,type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},C=function(e,t,n,o){k({url:a+"/exfee/"+e+"/join",type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},R=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},P=function(){};P.dispatch=function(e){var t="mobile";delete i._data_;var n;if(_.home.test(e))y();else if(n=e.match(_.smsToken)){window.noExfeApp=!!n[1];var o;window.noExfeApp?(o=d.getItem("tmp-token"),o&&(o=JSON.parse(o))):(o=h(),d.setItem("tmp-token",JSON.stringify(o))),o?(i._data_=o,y()):S({code:400})}else if(n=e.match(_.resolveToken)){window.noExfeApp=!!n[1];var o;if(window.noExfeApp&&(o=d.getItem("tmp-token"),o&&(o=JSON.parse(o))),o)i._data_=o,y();else{var r=n[2];k({url:a+"/Users/ResolveToken",type:"POST",data:{token:r},done:function(e){r&&e.meta&&200===e.meta.code?(o=i._data_=e.response,d.setItem("tmp-token",JSON.stringify(o)),y()):S(e.meta)},fail:function(e){S(e.meta)}})}}else if(n=e.match(_.crossTokenForPhone)){window.noExfeApp=!!n[1];var r,s=n[2],c=n[3],f=d.cats;f&&(f=JSON.parse(f));var m={invitation_token:c,cross_id:s};f&&(r=f[c])&&(m.cross_access_token=r),b(m)}else if(n=e.match(_.crossToken)){window.noExfeApp=!!n[1];var r,c=n[2],f=d.cats,m={invitation_token:c};f&&(r=f[c])&&(m.cross_access_token=r),b(m)}else if(n=e.match(_.routex0)){var r,c=n[2],f=d.getItem("cats"),m={invitation_token:c};f&&(f=JSON.parse(f)),f&&(r=f[c])&&(m.cross_access_token=r),b(m,!0)}else if(n=e.match(_.routex1)){t="",document.getElementById("app-body").innerHTML='<div id="app-status">页面加载中……</div>';for(var l,w,v,g=u.search.substr(1),x=g.split("&"),N={};l=x.shift();)l=l.split("="),w=l[0].toLowerCase(),v=l[1]||"",N[decodeURIComponent(w.replace(/\+/g," "))]=decodeURIComponent(v.replace(/\+/g," "));var s=n[1],I=N.xcode,T=N.via,E=JSON.parse(d.getItem("authorization")),P=E&&E.user_id,V=E&&E.token,B=E&&E.name||"",U=R();if(U&&U.authorization&&(E=U.authorization,P=E.user_id,V=E.token,B=E.name,d.setItem("authorization",JSON.stringify({user_id:P,token:V,name:B||""}))),window.isWeixin)if(P&&V)if(window._ENV_.smith_id&&window._ENV_.exfee_id){var $={xcode:I,user_token:V,widget_type:"routex"};T&&($.via=T),C(window._ENV_.exfee_id,$,function(e){i._data_=e;var t=z(e.response.cross.exfee,P);i._data_.response.browsing_identity=t,i._data_.tokenInfos=[V,t.id],i._data_.smith_id=window._ENV_.smith_id,i._data_.username=B||"",y()},function(e){var t=e.meta.code;e.meta.errorType,400===t&&J("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})})}else O(V,s,function(e){i._data_=e;var t=z(e.response.cross.exfee,P);i._data_.response.browsing_identity=t,i._data_.tokenInfos=[V,t.id],i._data_.smith_id=window._ENV_.smith_id,i._data_.username=B||"",y()},function(){U&&I?A(I,function(e){var t=e.response,n=t.authorization;n&&d.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token,name:n.name}));var o=t.cross_access_token;if(o){var a=JSON.parse(d.getItem("cats"));a||(a={}),a[I]=o}i._data_=e;var r=z(e.response.cross.exfee,P);i._data_.response.browsing_identity=r,i._data_.tokenInfos=[n?n.token:null,r.id],i._data_.smith_id=window._ENV_.smith_id,i._data_.username=n&&n.name||"",y()},function(e){S(e.meta)}):J("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})});else J("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})}else if(_.toapp.test(e)){for(var l,w,v,g=u.search.substr(1),x=g.split("&"),n={};l=x.shift();)l=l.split("="),w=l[0].toLowerCase(),v=l[1]||"",n[decodeURIComponent(w.replace(/\+/g," "))]=decodeURIComponent(v.replace(/\+/g," "));if(n.authenticate)J("wechat",{refere:u.protocol+u.hostname+"/toapp"+(n.cross_id?"?cross_id="+n.cross_id:"")},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")});else{var E,P,V,B,U=R();U&&U.authorization?(E=U.authorization,P=E.user_id,V=E.token,B=E.name,d.setItem("authorization",JSON.stringify({user_id:P,token:V,name:B||""}))):(E=JSON.parse(d.getItem("authorization")))&&(P=E.user_id,V=E.token,B=E.name);var e=p,L="";n.cross_id&&(e+="!"+n.cross_id+"/routex"),E&&(L+="?user_id="+P+"&token="+V+"&username="+B),openExfe(e+L)}}else if(routex.wechatAboutRoutex.test(e)){var E,U=R();if(U&&U.authorization?(window._ENV_.authorization=U.authorization,d.setItem("authorization",JSON.stringify({user_id:E.user_id,token:E.token,name:E.name||""}))):(E=JSON.parse(d.getItem("authorization")))&&(window._ENV_.authorization=E),!E)return J("wechat",{refere:u.protocol+u.hostname+e},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}),void 0;y()}else window.location="/";t&&(document.documentElement.className=t)},P.getPath=function(){return u.pathname+u.search+u.hash},P.handle=function(e){x()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),I());var t=P.getPath();P.dispatch(t,e)},P.start=function(){window.addEventListener("pageshow",function(e){e.persisted&&y()}),document.addEventListener("webkitvisibilitychange",function(){"visible"===document.webkitVisibilityState&&y()}),window.addEventListener(c,function(e){return P.handle(e),e.stopPropagation(),e.preventDefault(),!1})},P.start()})();