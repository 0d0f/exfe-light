(function(){"use strict";if(!window.DEBUG){var e=window.Debugger={};e.log=e.dir=e.warn=e.table=e.alert=function(){}}var t,n,o,i=Date.now||function(){return(new Date).getTime()},a=window._ENV_,r=a.api_url,s=a.app_scheme,d=window.history,c=window.localStorage,u=d?"popstate":"hashchange",f=window.location,p=function(){},_=s+":///",m={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/,toapp:/^\/+toapp.*$/,wechatAboutRoutex:/^\/+wechat\/aboutroutex$/},l="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.isWeixin=!!/MicroMessenger/i.test(navigator.userAgent),window.launchApp=function(e,n){e=e||_,t=i(),h(n,200),w(e)},window.openExfe=function(e){e=e||"",t=i(),window.launchApp(e,function(){w(l)})};var w=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},h=function(e,a){o=setTimeout(function(){clearTimeout(o),n=i(),500>n-t&&(e?e():window.location.href="/"),clearTimeout(o)},a||200)},v=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},y=function(e){e()},g=function(){var e=B.getPath();("/"===e||e!==B.url)&&(y(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),B.url=e)},k=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},I=function(e){var t,n=new XMLHttpRequest,o=e.done||p,i=e.fail||p;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var a,r=!1;if(n.status>=200&&300>n.status||304===n.status){try{a=JSON.parse(n.responseText)}catch(s){r=s}r?i(a,"parsererror",n,e):o(a,n,e)}else i(a,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?k(e.data):null),n},N=function(){return!!c.getItem("error")},x=function(e){c.setItem("error",JSON.stringify(e))},T=function(){c.removeItem("error")},E=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id),c.setItem("authorization",JSON.stringify(i))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var a=t.exfee.invitations,r=0,s=a.length;s>r;++r){var d=a[r];(n&&n===d.identity.connected_user_id||o===d.identity.id)&&(o=d.identity.id)}var u=t.id||"",f="";return n&&(i?(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,f=i.token):(i=c.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(f=i.token,u+="?user_id="+n+"&token="+f+"&identity_id="+o))),[f,u]},S=function(e){var t,n,o,i,a=e.authorization;if(a?(o=a.token,t=a.user_id,c.setItem("authorization",JSON.stringify(a))):(a=JSON.parse(c.getItem("authorization")))&&(o=a.token,t=a.user_id),o)for(var r,s=e.cross.exfee.invitations,d=0,u=s.length;u>d;++d)if(r=s[d],t===r.identity.connected_user_id){i=o,n=r.identity.id;break}return[i,n]},O=function(e){x(e),window.location="/"},b=function(e,t){I({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(a._data_=e,e.meta&&200===e.meta.code){var n=E(e.response);a._data_.tokenInfos=S(e.response),n[0]&&n[1]?t||window.noExfeApp?g():window.launchApp(_+n[1],function(){setTimeout(function(){window.location="/?redirect"+f.hash},200)}):g()}else O(e.meta)},fail:function(e){O(e.meta)}})},z=function(e,t,n){for(var o=e.invitations,i=0,a=o.length;a>i;++i){var r=o[i];if(t&&t===r.identity.connected_user_id||n===r.identity.id)return r.identity}},A=function(e,t,n,o){I({url:r+"/Crosses/"+t+"?token="+e,type:"GET",done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},J=function(e,t,n){var o,i={invitation_token:e},a=JSON.parse(c.getItem("cats"));a&&(o=a[e])&&(i.cross_access_token=o),I({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:i,done:function(e){var o=e.meta.code;200===o?t(e):n(e)},error:function(e){n(e)}})},C=function(e,t,n,o){document.getElementById("app-body").innerHTML='<div id="app-status">微信鉴权中……</div>',I({url:"/oauth/authenticate?provider="+e,type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},L=function(e,t,n,o){I({url:r+"/exfee/"+e+"/join",type:"POST",data:t,done:function(e){var t=e.meta.code;200===t?n(e):o(e)},error:function(e){o(e)}})},R=function(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n},B=function(){};B.dispatch=function(e){var t="mobile";delete a._data_;var n;if(m.home.test(e))g();else if(n=e.match(m.smsToken)){window.noExfeApp=!!n[1];var o;window.noExfeApp?(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))):(o=v(),c.setItem("tmp-token",JSON.stringify(o))),o?(a._data_=o,g()):O({code:400})}else if(n=e.match(m.resolveToken)){window.noExfeApp=!!n[1];var o;if(window.noExfeApp&&(o=c.getItem("tmp-token"),o&&(o=JSON.parse(o))),o)a._data_=o,g();else{var i=n[2];I({url:r+"/Users/ResolveToken",type:"POST",data:{token:i},done:function(e){i&&e.meta&&200===e.meta.code?(o=a._data_=e.response,c.setItem("tmp-token",JSON.stringify(o)),g()):O(e.meta)},fail:function(e){O(e.meta)}})}}else if(n=e.match(m.crossTokenForPhone)){window.noExfeApp=!!n[1];var i,s=n[2],d=n[3],u=c.cats;u&&(u=JSON.parse(u));var p={invitation_token:d,cross_id:s};u&&(i=u[d])&&(p.cross_access_token=i),b(p)}else if(n=e.match(m.crossToken)){window.noExfeApp=!!n[1];var i,d=n[2],u=c.cats,p={invitation_token:d};u&&(i=u[d])&&(p.cross_access_token=i),b(p)}else if(n=e.match(m.routex0)){var i,d=n[2],u=c.getItem("cats"),p={invitation_token:d};u&&(u=JSON.parse(u)),u&&(i=u[d])&&(p.cross_access_token=i),b(p,!0)}else if(n=e.match(m.routex1)){t="",document.getElementById("app-body").innerHTML='<div id="app-status">页面加载中……</div>';for(var l,w,h,y=f.search.substr(1),k=y.split("&"),N={};l=k.shift();)l=l.split("="),w=l[0].toLowerCase(),h=l[1]||"",N[decodeURIComponent(w.replace(/\+/g," "))]=decodeURIComponent(h.replace(/\+/g," "));var s=n[1],x=N.xcode,T=N.via,E=JSON.parse(c.getItem("authorization")),S=E&&E.user_id,B=E&&E.token,P=E&&E.name||"",U=R();if(U&&U.authorization&&(E=U.authorization,S=E.user_id,B=E.token,P=E.name,c.setItem("authorization",JSON.stringify({user_id:S,token:B,name:P||""}))),window.isWeixin)if(S&&B)if(window._ENV_.smith_id&&window._ENV_.exfee_id){var M={xcode:x,user_token:B,widget_type:"routex"};T&&(M.via=T),L(window._ENV_.exfee_id,M,function(e){a._data_=e;var t=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[B,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=P||"",g()},function(e){var t=e.meta.code;e.meta.errorType,400===t?C("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}):401===t&&(alert("无法打开“活点地图”，因为您已经从这张地图中被移除了。"),window.location.href="/")})}else A(B,s,function(e){a._data_=e;var t=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=t,a._data_.tokenInfos=[B,t.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=P||"",g()},function(){U&&x?J(x,function(e){var t=e.response,n=t.authorization;n&&c.setItem("authorization",JSON.stringify({user_id:n.user_id,token:n.token,name:n.name}));var o=t.cross_access_token;if(o){var i=JSON.parse(c.getItem("cats"));i||(i={}),i[x]=o}a._data_=e;var r=z(e.response.cross.exfee,S);a._data_.response.browsing_identity=r,a._data_.tokenInfos=[n?n.token:null,r.id],a._data_.smith_id=window._ENV_.smith_id,a._data_.username=n&&n.name||"",g()},function(e){O(e.meta)}):C("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})});else C("wechat",{refere:window.location.href},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")})}else if(m.toapp.test(e)){t="",document.getElementById("app-body").innerHTML='<div id="app-status">页面加载中……</div>';for(var l,w,h,y=f.search.substr(1),k=y.split("&"),n={};l=k.shift();)l=l.split("="),w=l[0].toLowerCase(),h=l[1]||"",n[decodeURIComponent(w.replace(/\+/g," "))]=decodeURIComponent(h.replace(/\+/g," "));if(n.hasOwnProperty("authenticate"))C("wechat",{refere:f.protocol+"//"+f.hostname+"/toapp"+(n.cross_id?"?cross_id="+n.cross_id:"")},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")});else{var E,S,B,P,U=R();U&&U.authorization?(E=U.authorization,S=E.user_id,B=E.token,P=E.name,c.setItem("authorization",JSON.stringify({user_id:S,token:B,name:P||""}))):(E=JSON.parse(c.getItem("authorization")))&&(S=E.user_id,B=E.token,P=E.name);var e=_,V="";n.cross_id&&(e+="!"+n.cross_id+"/routex"),E&&(V+="?user_id="+S+"&token="+B+"&username="+P),openExfe(e+V)}}else if(m.wechatAboutRoutex.test(e)){t="",document.getElementById("app-body").innerHTML='<div id="app-status">页面加载中……</div>';var E,U=R();if(U&&U.authorization?(window._ENV_.authorization=U.authorization,c.setItem("authorization",JSON.stringify({user_id:E.user_id,token:E.token,name:E.name||""}))):(E=JSON.parse(c.getItem("authorization")))&&(window._ENV_.authorization=E),!E)return C("wechat",{refere:f.protocol+f.hostname+e},function(e){window.location.href=e.response.redirect},function(){alert("授权失败\n未能获得微信授权，无法继续。\n请尝试重新打开链接并同意授权。")}),void 0;g()}else window.location="/";t&&(document.documentElement.className=t)},B.getPath=function(){return f.pathname+f.search+f.hash},B._status=0,B.firstLoad=!1,B.handle=function(e){N()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),T());var t=B.getPath();B.dispatch(t,e)},B.start=function(){document.addEventListener("DOMContentLoaded",function(e){B._status||(B._status=1,B.firstLoad=!0,B.handle(e))}),window.addEventListener("load",function(e){B._status||(B._status=2,B.firstLoad=!0,B.handle(e))}),window.addEventListener(u,function(e){return B.firstLoad?B.firstLoad=!1:(e.preventDefault(),e.stopPropagation(),B.handle(e),!1)})},B.start()})();