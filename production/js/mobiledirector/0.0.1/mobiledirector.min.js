(function(){"use strict";var e,t,n,o=Date.now||function(){return(new Date).getTime()},i=window._ENV_,r=i.api_url,a=i.app_scheme,s=i.JSFILE,c=i.CSSFILE,d=window.history,u=window.localStorage,p=d?"popstate":"hashchange",m=window.location,f=function(){},l=a+"://crosses/",h={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/,routex0:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{4,})\/routex\/?$/,routex1:/^\/+!(\d+)\/routex\/?.*$/},v="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.launchApp=function(t,n,i){t=t||l,e=o(),_(n,i),w(t)},window.openExfe=function(){e=o(),window.launchApp("",function(){w(v)},1e3)};var w=function(e,t){!t&&(t="app-redirect");var n=document.getElementById(t);return n&&document.body.removeChild(n),n=document.createElement("iframe"),document.body.appendChild(n),n.id=t,n.src=e,n.setAttribute("frameborder",0),n.className="hide",n.style.display="none",n},_=function(i,r){n=setTimeout(function(){t=o(),1e3>t-e&&(i?i():window.location.href="/"),clearTimeout(n)},r||200)},y=function(){var e,t=document.getElementsByTagName("head")[0],n=document.getElementsByName("sms-token")[0];return n&&(e=JSON.parse(n.content),t.removeChild(n)),e},g=function(e){var t=document.getElementById(e);return!!t},k=function(e,t,n,o){var i=document.createElement("script");i.src=e,i.id=t,i.async=!0,i.onload=n||f,i.onerror=o||f,document.body.appendChild(i)},I=function(e,t){var n=document.createElement("link");n.id=t,n.rel="stylesheet",n.media="screen",n.type="text/css",n.href=e,document.getElementsByTagName("head")[0].appendChild(n)},T=function(e){var t="mobile-css";g(t)||I("/static/css/"+c,t);var n="mobile-js";g(n)?e():k("/static/js/"+s,n,e)},S=function(){var e=R.getPath();("/"===e||e!==R.url)&&(T(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),R.url=e)},b=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},E=function(e){var t,n=new XMLHttpRequest,o=e.done||f,i=e.fail||f;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var r,a=!1;if(n.status>=200&&300>n.status||304===n.status){try{r=JSON.parse(n.responseText)}catch(s){a=s}a?i(r,"parsererror",n,e):o(r,n,e)}else i(r,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?b(e.data):null),n},x=function(){return!!u.getItem("error")},N=function(e){u.setItem("error",JSON.stringify(e))},A=function(){u.removeItem("error")},O=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id),u.setItem("authorization",JSON.stringify(i))):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var r=t.exfee.invitations,a=0,s=r.length;s>a;++a){var c=r[a];(n&&n===c.identity.connected_user_id||o===c.identity.id)&&(o=c.identity.id)}var d=t.id||"",p="";return n&&(i?(d+="?user_id="+n+"&token="+i.token+"&identity_id="+o,p=i.token):(i=u.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(p=i.token,d+="?user_id="+n+"&token="+p+"&identity_id="+o))),[p,d]},J=function(e){var t,n,o,i,r=e.authorization;if(r?(o=r.token,t=r.user_id,u.setItem("authorization",JSON.stringify(r))):(r=JSON.parse(u.getItem("authorization")))&&(o=r.token,t=r.user_id),o)for(var a,s=e.cross.exfee.invitations,c=0,d=s.length;d>c;++c)if(a=s[c],t===a.identity.connected_user_id){i=o,n=a.identity.id;break}return[i,n]},C=function(e){N(e),window.location="/"},z=function(e,t){E({url:r+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(i._data_=e,e.meta&&200===e.meta.code){var n=O(e.response);i._data_.tokenInfos=J(e.response),n[0]&&n[1]?t||window.noExfeApp?S():window.launchApp(l+n[1],function(){window.location="/?redirect"+m.hash},500):S()}else C(e.meta)},fail:function(e){C(e.meta)}})},R=function(){};R.dispatch=function(e){delete i._data_,window.noExfeApp=!!e.match(/\?redirect/);var t;if(h.home.test(e))S();else if(t=e.match(h.smsToken)){window.noExfeApp=!!t[1];var n;window.noExfeApp?(n=u.getItem("tmp-token"),n&&(n=JSON.parse(n))):(n=y(),u.setItem("tmp-token",JSON.stringify(n))),n?(i._data_=n,S()):C({code:400})}else if(t=e.match(h.resolveToken)){var n;if(window.noExfeApp&&(n=u.getItem("tmp-token"),n&&(n=JSON.parse(n))),n)i._data_=n,S();else{var o=t[2];E({url:r+"/Users/ResolveToken",type:"POST",data:{token:o},done:function(e){o&&e.meta&&200===e.meta.code?(n=i._data_=e.response,u.setItem("tmp-token",JSON.stringify(n)),S()):C(e.meta)},fail:function(e){C(e.meta)}})}}else if(t=e.match(h.crossTokenForPhone)){var o,a=t[2],s=t[3],c=u.getItem("cats");c&&(c=JSON.parse(c));var d={invitation_token:s,cross_id:a};c&&(o=c[s])&&(d.cross_access_token=o),z(d)}else if(t=e.match(h.crossToken)){var o,s=t[2],c=u.getItem("cats"),d={invitation_token:s};c&&(c=JSON.parse(c)),c&&(o=c[s])&&(d.cross_access_token=o),z(d)}else if(t=e.match(h.routex0)){var o,s=t[2],c=u.getItem("cats"),d={invitation_token:s};c&&(c=JSON.parse(c)),c&&(o=c[s])&&(d.cross_access_token=o),z(d,!0)}else if(t=e.match(h.routex1)){for(var p,f,l,v=m.search.substr(1),w=v.split("&"),_={};p=w.shift();)p=p.split("="),f=p[0],l=p[1]||"",_[decodeURIComponent(f.replace(/\+/g," "))]=decodeURIComponent(l.replace(/\+/g," "));var o,s=_.xcode,c=u.getItem("cats"),d={invitation_token:s};c&&(c=JSON.parse(c)),c&&(o=c[s])&&(d.cross_access_token=o),z(d,!0)}else window.location="/"},R.getPath=function(){return m.pathname+m.search+m.hash},R.handle=function(e){x()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),A());var t=R.getPath();R.dispatch(t,e)},R.start=function(){window.addEventListener("pageshow",function(e){e.persisted&&S()}),document.addEventListener("webkitvisibilitychange",function(){"visible"===document.webkitVisibilityState&&S()}),window.addEventListener(p,function(e){return R.handle(e),e.stopPropagation(),e.preventDefault(),!1})},R.start()})();