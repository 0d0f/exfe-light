(function(){"use strict";var e,t,i,a=Date.now||function(){return(new Date).getTime()},n=window._ENV_,s=n.api_url,o=n.app_scheme,r=n.JSFILE,d=window.history,l=window.localStorage,c=d?"popstate":"hashchange",h=window.location,u=function(){},p=document.getElementById("xframe"),m=o+"://crosses/",v={home:/^\/+(?:\?)?#{0,}$/,smsToken:/^\/+\?(?:(redirect)?&)?t=([a-zA-Z0-9]{3,})$/,resolveToken:/^\/+(?:\?(redirect)?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?(redirect)?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?(redirect)?)?#!token=([a-zA-Z0-9]{32})\/?$/},f="itms-apps://itunes.apple.com/us/app/exfe/id514026604";window.launchApp=function(t,i,n){t=t||m,e=a(),p.src=t,y(i,n)},window.openExfe=function(){window.launchApp("",function(){p.src=f})};var y=function(n,s){i=setTimeout(function(){clearTimeout(i),t=a(),500>t-e&&(n?n():window.location="/")},s||200)},b=function(){var e,t=document.getElementsByTagName("head")[0],i=document.getElementsByName("sms-token")[0];return i&&(e=JSON.parse(i.content),t.removeChild(i)),e},g=function(e){var t=document.getElementById(e);return!!t},C=function(e,t,i,a){var n=document.createElement("script");n.src=e,n.id=t,n.async=!0,n.onload=i||u,n.onerror=a||u,document.body.appendChild(n)},w=function(e,t){var i=document.createElement("link");i.id=t,i.rel="stylesheet",i.media="screen",i.type="text/css",i.href=e,document.getElementsByTagName("head")[0].appendChild(i)},$=function(e){var t="mobile-css";g(t)||w("/static/css/exfe_mobile.min.css",t);var i="mobile-js";g(i)?e():C("/static/js/"+r,i,e)},k=function(){var e=N.getPath();("/"===e||e!==N.url)&&($(function(){App.request.updateUrl(),App.handle(App.request,App.response)}),N.url=e)},_=function(e){var t,i=[];for(t in e)i.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return i.join("&").replace(/%20/g,"+")},x=function(e){var t,i=new XMLHttpRequest,a=e.done||u,n=e.fail||u;return i.open(e.type||"GET",e.url,!0),i.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(i.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),i.withCredentials=!0,i.onreadystatechange=function(){if(4===i.readyState){i.onreadystatechange=void 0,clearTimeout(t);var s,o=!1;if(i.status>=200&&300>i.status||304===i.status){try{s=JSON.parse(i.responseText)}catch(r){o=r}o?n(s,"parsererror",i,e):a(s,i,e)}else n(s,i.status?"error":"abort",i,e)}},t=setTimeout(function(){i.onreadystatechange=void 0,i.abort(),i=void 0},5e3),i.send(e.data?_(e.data):null),i},A=function(){return!!l.getItem("error")},T=function(e){l.setItem("error",JSON.stringify(e))},I=function(){l.removeItem("error")},E=function(e){var t=e.cross,i=0,a=0,n=e.authorization;n?(i=n.user_id,e.browsing_identity&&(a=e.browsing_identity.id)):e.browsing_identity&&e.browsing_identity.connected_user_id&&(i=e.browsing_identity.connected_user_id,a=e.browsing_identity.id);for(var s=t.exfee.invitations,o=0,r=s.length;r>o;++o){var d=s[o];(i&&i===d.identity.connected_user_id||a===d.identity.id)&&(a=d.identity.id)}var c=t.id||"",h="";return i&&(n?(c+="?user_id="+i+"&token="+n.token+"&identity_id="+a,h=n.token):(n=l.getItem("authorization"))&&(n=JSON.parse(n),n.user_id===i&&(c+="?user_id="+i+"&token="+n.token+"&identity_id="+a,h=n.token))),[h,c]},P=function(e){T(e),window.location="/"},S=function(e){x({url:s+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){if(n._data_=e,e.meta&&200===e.meta.code){var t=E(e.response);t[0]&&t[1]?window.noExfeApp?k():window.launchApp(m+t[1],function(){window.location="/?redirect"+h.hash},400):k()}else P(e.meta)},fail:function(e){P(e.meta)}})},N=function(){};N.dispatch=function(e){delete n._data_;var t;if(v.home.test(e))k();else if(e.match(v.smsToken)){window.noExfeApp=!!t[1];var i;window.noExfeApp?(i=l.getItem("tmp-token"),i&&(i=JSON.parse(i))):(i=b(),l.setItem("tmp-token",JSON.stringify(i))),i?(n._data_=i,k()):P({code:400})}else if(t=e.match(v.resolveToken)){window.noExfeApp=!!t[1];var i;if(window.noExfeApp&&(i=l.getItem("tmp-token"),i&&(i=JSON.parse(i))),i)n._data_=i,k();else{var a=t[2];x({url:s+"/Users/ResolveToken",type:"POST",data:{token:a},done:function(e){a&&e.meta&&200===e.meta.code?(i=n._data_=e.response,l.setItem("tmp-token",JSON.stringify(i)),k()):P(e.meta)},fail:function(e){P(e.meta)}})}}else if(t=e.match(v.crossTokenForPhone)){window.noExfeApp=!!t[1];var a,o=t[2],r=t[3],d=l.cats;d&&(d=JSON.parse(d));var c={invitation_token:r,cross_id:o};d&&(a=d[r])&&(c.cross_access_token=a),S(c)}else if(t=e.match(v.crossToken)){window.noExfeApp=!!t[1];var a,r=t[2],d=l.cats,c={invitation_token:r};d&&(a=d[r])&&(c.cross_access_token=a),S(c)}else window.location="/"},N.getPath=function(){return"/"+h.search+h.hash},N.handle=function(e){A()&&(alert("Sorry. Your link is invalid or expired. Requested page was not found."),I());var t=N.getPath();N.dispatch(t,e)},N.start=function(){window.addEventListener("pageshow",function(e){e.persisted&&k()}),document.addEventListener("webkitvisibilitychange",function(){"visible"===document.webkitVisibilityState&&k()}),window.addEventListener(c,function(e){return N.handle(e),e.stopPropagation(),e.preventDefault(),!1})},N.start()})();