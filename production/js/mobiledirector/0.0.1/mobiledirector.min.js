(function(){"use strict";var e,t,n,o=Date.now||function(){return(new Date).getTime()},i=window._ENV_,a=i.api_url,s=i.app_scheme,r=i.JSFILE,c=window.history,d=window.localStorage,u=c?"popstate":"hashchange",l=window.location,p=function(){},f=document.getElementById("mframe"),m=document.getElementById("xframe"),_=s+"://crosses/",w={home:/^\/+(?:\?)?#{0,}$/,resolveToken:/^\/+(?:\?)?#token=([a-zA-Z0-9]{64})\/?$/,crossTokenForPhone:/^\/+(?:\?)?#!([1-9][0-9]*)\/([a-zA-Z0-9]{4})\/?$/,crossToken:/^\/+(?:\?)?#!token=([a-zA-Z0-9]{32})\/?$/},h=function(i){n=setTimeout(function(){clearTimeout(n),t=o(),500>t-e&&(i?i():window.location="/")},400)},v=function(t,n){e=o(),m.src=t||_,h(n)},y=function(e){var t=document.getElementById(e);return!!t},k=function(e,t,n,o){var i=document.createElement("script");i.src=e,i.id=t,i.async=!0,i.onload=n||p,i.onerror=o||p,document.body.appendChild(i)},g=function(e,t){var n=document.createElement("link");n.id=t,n.rel="stylesheet",n.media="screen",n.type="text/css",n.href=e,document.getElementsByTagName("head")[0].appendChild(n)},T=function(e){var t="mobile-css";y(t)||g("/static/css/exfe_mobile.min.css",t);var n="mobile-js";y(n)?e():k("/static/js/"+r,n,e)},b=function(){T(function(){f.className="hide",App.request.updateUrl(),App.handle(App.request,App.response)})},E=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")},S=function(e){var t,n=new XMLHttpRequest,o=e.done||p,i=e.fail||p;return n.open(e.type||"GET",e.url,!0),n.overrideMimeType("application/json"),"GET"!==e.type&&e.data&&(n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),n.withCredentials=!0,n.onreadystatechange=function(){if(4===n.readyState){n.onreadystatechange=void 0,clearTimeout(t);var a,s=!1;if(n.status>=200&&300>n.status||304===n.status){try{a=JSON.parse(n.responseText)}catch(r){s=r}s?i(a,"parsererror",n,e):o(a,n,e)}else i(a,n.status?"error":"abort",n,e)}},t=setTimeout(function(){n.onreadystatechange=void 0,n.abort(),n=void 0},5e3),n.send(e.data?E(e.data):null),n},A=function(e){var t=e.cross,n=0,o=0,i=e.authorization;i?(n=i.user_id,e.browsing_identity&&(o=e.browsing_identity.id)):e.browsing_identity&&e.browsing_identity.connected_user_id&&(n=e.browsing_identity.connected_user_id,o=e.browsing_identity.id);for(var a=t.exfee.invitations,s=0,r=a.length;r>s;++s){var c=a[s];(n&&n===c.identity.connected_user_id||o===c.identity.id)&&(o=c.identity.id)}var u=t.id||"",l="";return n&&(i?(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,l=i.token):(i=d.getItem("authorization"))&&(i=JSON.parse(i),i.user_id===n&&(u+="?user_id="+n+"&token="+i.token+"&identity_id="+o,l=i.token))),u},C=function(e){S({url:a+"/Crosses/GetCrossByInvitationToken",type:"POST",data:e,done:function(e){i._data_=e,e.meta&&200===e.meta.code?v(_+A(e.response),function(){b()}):window.location="/"},fail:function(e){i._data_=e,window.location="/"}})},I=function(){};I.dispatch=function(e){f.className="",delete i._data_;var t;if(w.home.test(e))b();else if(t=e.match(w.resolveToken))S({url:a+"/Users/ResolveToken",type:"POST",data:{token:t[1]},done:function(e){i._data_=e,e.meta&&200===e.meta.code?b():window.location="/"},fail:function(e){i._data_=e,b()}});else if(t=e.match(w.crossTokenForPhone)){var n,o=t[1],s=t[2],r=d.cats,c={};r&&(r=JSON.parse(r)),c={invitation_token:s,cross_id:o},r&&(n=r[s])&&(c.cross_access_token=n),C(c)}else if(t=e.match(w.crossToken)){var n,s=t[1],r=d.cats,c={invitation_token:s};r&&(n=r[s])&&(c.cross_access_token=n),C(c)}else window.location="/"},I.handle=function(e){var t=l.hash;I.dispatch("/"+t,e)},I.start=function(){window.addEventListener("pageshow",function(e){e.persisted&&b()}),document.addEventListener("webkitvisibilitychange",function(){"visible"===document.webkitVisibilityState&&b()}),window.addEventListener(u,function(e){return I.handle(e),e.stopPropagation(),e.preventDefault(),!1})},I.start()})();