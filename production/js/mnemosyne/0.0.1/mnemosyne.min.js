define("mnemosyne",function(e){"use strict";for(var t=0,n=["ms","moz","webkit","o"],r=0;n.length>r&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[n[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n[r]+"CancelAnimationFrame"]||window[n[r]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var n=(new Date).getTime(),r=Math.max(0,16-(n-t)),i=window.setTimeout(function(){e(n+r)},r);return t=n+r,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});var i,a,s,o=void 0,l=function(e,t,n,r,i,a){return(e>=0&&i>=e||n>=0&&i>=n)&&(r>=0&&a>=r||t>=0&&a>=t)},c=function(e){var t=e.getBoundingClientRect();return l(t.top,t.right,t.bottom,t.left,a,i)},u=function(e,t){for(var n=e.length,r=[];n>t;++t)r.push(e[t]);return t},h=Math.cos,p=Math.sin,f=Math.tan,m=Math.abs,g=Math.asin,v=Math.sqrt,y=Math.atan,_=Math.atan2,b=Math.min,x=Math.PI,w=1e-6,k={precision:w,identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiply:function T(e,t){var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1];return n[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8],n[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9],n[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10],n[4]=e[4]*t[0]+e[5]*t[4]+e[6]*t[8],n[5]=e[4]*t[1]+e[5]*t[5]+e[6]*t[9],n[6]=e[4]*t[2]+e[5]*t[6]+e[6]*t[10],n[8]=e[8]*t[0]+e[9]*t[4]+e[10]*t[8],n[9]=e[8]*t[1]+e[9]*t[5]+e[10]*t[9],n[10]=e[8]*t[2]+e[9]*t[6]+e[10]*t[10],n[12]=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+t[12],n[13]=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+t[13],n[14]=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+t[14],2>=arguments.length?n:T([n].concat(u(arguments,2)))},move:function(e,t){return t[2]||(t[2]=0),[e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,e[12]+t[0],e[13]+t[1],e[14]+t[2],1]},translate:function(e,t,n){return"number"!=typeof n&&(n=0),[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1]},scale:function(e,t,n){return"number"!=typeof n&&(n=1),[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1]},rotateX:function(e,t){return t=h(e),e=p(e),[1,0,0,0,0,t,e,0,0,-e,t,0,0,0,0,1]},rotateY:function(e,t){return t=h(e),e=p(e),[t,0,-e,0,0,1,0,0,e,0,t,0,0,0,0,1]},rotateZ:function(e,t){return t=h(e),e=p(e),[t,e,0,0,-e,t,0,0,0,0,1,0,0,0,0,1]},rotate:function(e,t,n,r,i,a,s){return r=h(e),e=p(e),i=h(t),t=p(t),a=h(n),n=p(n),s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],s[0]=i*a,s[1]=r*n+e*t*a,s[2]=e*n-r*t*a,s[4]=-i*n,s[5]=r*a-e*t*n,s[6]=e*a+r*t*n,s[8]=t,s[9]=-e*i,s[10]=r*i,s},skew:function(e,t,n){return[1,0,0,0,f(n),1,0,0,f(t),f(e),1,0,0,0,0,1]},equal:function(e,t){if(!e||!t)return!1;if(e==t)return!0;for(var n=0,r=e.length;r>n;++n)if(m(e[n]-t[n])>=w)return!1;return!0},random:function(e){for(e=e.slice(0),(e[0]==x/2||e[0]==-x/2)&&(e[0]=-e[0],e[1]=x-e[1],e[2]-=x),e[0]>x/2&&(e[0]-=x,e[1]=x-e[1],e[2]-=x),-x/2>e[0]&&(e[0]+=x,e[1]=-x-e[1],e[2]-=x);-x>e[1];)e[1]+=2*x;for(;e[1]>=x;)e[1]-=2*x;for(;-x>e[2];)e[2]+=2*x;for(;e[2]>=x;)e[2]-=2*x;return e},inverse:function(e,t,n,r,i,a,s,o,l,c,u,d){return t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],n=e[5]*e[10]-e[6]*e[9],r=e[4]*e[10]-e[6]*e[8],i=e[4]*e[9]-e[5]*e[8],a=e[1]*e[10]-e[2]*e[9],s=e[0]*e[10]-e[2]*e[8],o=e[0]*e[9]-e[1]*e[8],l=e[1]*e[6]-e[2]*e[5],c=e[0]*e[6]-e[2]*e[4],u=e[0]*e[5]-e[1]*e[4],d=1/(e[0]*n-e[1]*r+e[2]*i),t[0]=d*n,t[1]=-d*a,t[2]=d*l,t[4]=-d*r,t[5]=d*s,t[6]=-d*c,t[8]=d*i,t[9]=-d*o,t[10]=d*u,t[12]=-e[12]*t[0]-e[13]*t[4]-e[14]*t[8],t[13]=-e[12]*t[1]-e[13]*t[5]-e[14]*t[9],t[14]=-e[12]*t[2]-e[13]*t[6]-e[14]*t[10],t},translateValues:function(e){return[e[12],e[13],e[14]]},create:function(e){var t=function(e,t,r){return n||(n=0),v(e*e+t*t+r*r)},n=e[0]+t(e[0],e[1],e[2]),r=2/(n*n+e[1]*e[1]+e[2]*e[2]),i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1];i[0]=1-r*n*n,i[1]=-r*n*e[1],i[2]=-r*n*e[2],i[5]=1-r*e[1]*e[1],i[6]=-r*e[1]*e[2],i[10]=1-r*e[2]*e[2],i[4]=i[1],i[8]=i[2],i[9]=i[6],n=k.multiply(e,i),r=t(n[5],n[6]),n[5]>0&&n[5]!=r&&(r*=-1),r=n[5]+r;var a=2/(r*r+n[6]*n[6]),s=[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1];return s[5]=1-a*r*r,s[6]=-a*r*n[6],s[9]=s[6],s[10]=1-a*n[6]*n[6],i=k.multiply(i,s),n=k.multiply(e,i),r=k.scale(0>n[0]?-1:1,0>n[5]?-1:1,0>n[10]?-1:1),n=k.multiply(r,n),i=k.multiply(i,r),r={},r.translate=k.translateValues(e),r.rotate=[_(-i[6],i[10]),g(i[2]),_(-i[1],i[0])],r.rotate[0]||(r.rotate[0]=0,r.rotate[2]=_(i[4],i[5])),r.scale=[n[0],n[5],n[10]],r.skew=[y(n[9]/r.scale[2]),y(n[8]/r.scale[2]),y(n[4]/r.scale[0])],r},translateTo:function(e){var t=k.scale(e.scale[0],e.scale[1],e.scale[2]),n=k.skew(e.skew[0],e.skew[1],e.skew[2]),r=k.rotate(e.rotate[0],e.rotate[1],e.rotate[2]);return k.move(k.multiply(t,n,r),e.translate)},toCSSMatrix3d:function(e,t,n){for(e=e.slice(0),t=0,n=e.length;n>t;++t)w>m(e[t])&&(e[t]=0);return"matrix3d("+e.join()+")"}},C=e("jquery"),M=e("tween"),S=e("rex"),$=e("humantime"),E=e("handlebars"),N=e("panel"),A=e("api").request,D=function(e,t,n){return A("photox_like",{type:"POST",data:{id:e}},t,n)},P=function(e,t,n){return A("photox_like",{type:"POST",data:{id:e,LIKE:!1}},t,n)},I=function(e,t,n,r){return A("photox_getPhotoX",{resources:{photox_id:e},beforeSend:t},n,r)},H=Math.random;E.registerHelper("photoxPrintTime",function(e){var t=$.parseISO($.toISO(e));return $.printTime(t)});var L=function(e,t,n,r){var i=new Image,a=function(t){t.onload=t.onerror=t=e=void 0};i.onload=function(){n&&n(i,e),a(i)},i.onerror=function(){r&&r(i,e),a(i)},i.src=t},O=0,z=function(e,t,n){for(n in t)e.hasOwnProperty(n)||(e[n]=t[n]);return e},j=function(e){return parseInt(e*H())+1},F=function(e,t){return e*t},q=function(e,t,n,r){var i=n/r,a=n/e,s=r/t,n=b(e,n),r=b(t,r);return s>a?n=r*i:r=n/i,[n,r]},B=function(e,t,n,r){var i=n/r,a=e/t;return a>i?(n=e,r=n/i):(r=t,n=r*i),[n,r]},R=function(e){return z({id:O++},e)},U=function(e,t,n,r,i,a,s,o,l){e.setAttribute("data-gid",t),e.style.opacity=1,e.style.width=a+"px",e.style.height=i+"px";var c=k.translate(o,s,6);if(e.style.webkitTransform=k.toCSSMatrix3d(c),e.style.transform=k.toCSSMatrix3d(c),e._m4=c,"instagram"===l&&(r*=1.1,n*=1.1),"-1"===e.getAttribute("data-lazy"))e.setAttribute("data-whlt",[r,n,(a-r)/2,(i-n)/2].join(","));else{var u=e.querySelector("img").style;u.width=r+"px",u.height=n+"px",u.top=(i-n)/2+"px",u.left=(a-r)/2+"px"}},W=[[{type:"G",name:"1",aspect_ratio:0,cells:[{type:"Rect",x:0,y:0,width:1,height:1,margin:{top:6,right:6,bottom:6,left:6}}]}],[{type:"G",name:"2A1",aspect_ratio:.5,cells:[{type:"Rect",x:0,y:0,width:1,height:.5,margin:{top:6,right:6,bottom:6,left:6}},{type:"Rect",x:0,y:.5,width:1,height:.5,margin:{top:6,right:6,bottom:6,left:6}}]},{type:"G",name:"2A2",aspect_ratio:.75,cells:[{type:"Rect",x:0,y:0,width:1,height:.5,margin:{top:6,right:6,bottom:6,left:6}},{type:"Rect",x:0,y:.5,width:1,height:.5,margin:{top:6,right:6,bottom:6,left:6}}]},{type:"G",name:"2B1",aspect_ratio:4/3,cells:[{type:"Rect",x:0,y:0,width:.5,height:1,margin:{top:6,right:6,bottom:6,left:6}},{type:"Rect",x:.5,y:0,width:.5,height:1,margin:{top:6,right:6,bottom:6,left:6}}]}],[{type:"G",name:"3A1",aspect_ratio:2/3,cells:[{type:"Rect",x:0,y:0,width:1,height:.666666,margin:{top:6,right:6,bottom:6,left:6}},{type:"Rect",x:0,y:.666666,width:.5,height:.333333,margin:{top:6,right:6,bottom:6,left:6}},{type:"Rect",x:.5,y:.666666,width:.5,height:.333333,margin:{top:6,right:6,bottom:6,left:6}}]},{type:"G",name:"3B1",aspect_ratio:1,cells:[{type:"Rect",x:0,y:0,width:.382,height:.382,margin:{top:6,right:6,bottom:6,left:6}},{type:"Rect",x:.382,y:0,width:.618,height:.382,margin:{top:6,right:6,bottom:6,left:6}},{type:"Rect",x:0,y:.382,width:1,height:.618,margin:{top:6,right:6,bottom:6,left:6}}]}]],G={},X='<figure class="surface" data-lazy="-1" data-id="{{id}}" data-preview-url="{{images.preview.url}}" data-preview-height="{{images.preview.height}}" data-preview-width="{{images.preview.width}}" data-fullsize-url="{{images.fullsize.url}}" data-fullsize-height="{{images.fullsize.height}}" data-fullsize-width="{{images.fullsize.width}}" data-liked="{{like}}" data-provider="{{provider}}" ><div class="photo"></div><div class="mask"></div><div class="btn-like ix-{{#unless like}}un{{/unless}}like"{{#unless like}} style="opacity: 0;"{{/unless}}></div><div class="meta"><div class="avatar"><img width="24" height="24" src="{{by_identity.avatar_filename}}" alt="" /></div><div class="title">{{caption}}</div><time>{{photoxPrintTime updated_at}}</time><div class="place"></div></div></figure>',V=G.Rect=function(e){this.html=E.compile(X)(e)};V.prototype.toString=function(){return this.html};var Y=function(e,t){return new G[e](t)},K=function(e,t){for(var n,r,i,a=0,s="";n=e[a];a++)r=t[a],i=Y(r.type,n),s+=""+i;return s},J=function(){};s=J.prototype,s.defaultLayouts=W,s.genLayouts=function(e){for(var t,n,r,i=W.slice(0),a=i.length,s=[];e;)t=j(a>e?e:a),e-=t,n=i[t-1],r=n[j(n.length)-1],s.push(R(r));return s};var Z=function(e,t){this.component=e,this.$element=t,this.animate=!0};Z.prototype.show=function(e){var t=this.$element,n=t[0].style;n.webkitTransform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+C("#app-tmp").scrollLeft()+", 0, 10, 1)",n.transform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+C("#app-tmp").scrollLeft()+", 0, 10, 1)",this.$element.attr("tabindex","-1").focus(),this.clone(e)},Z.prototype.exit=function(){var e=this.$element,t=e[0].style;e.attr("tabindex","none"),new M.Tween({o:1}).to({o:0},400).interpolation(M.Interpolation.Bezier).easing(M.Easing.Exponential.Out).onUpdate(function(){t.opacity=this.o}).onComplete(function(){e.empty()}).start(),this.img=this.curr=o,this.lockup=!1},Z.prototype._clone_0=function(e){this.$element.empty(),this.lockup=!0;var t=this,n=e.getBoundingClientRect(),r=e.clientWidth,i=e.clientHeight,a=n.left,s=n.top,l=this.$element[0].style,c=e.getAttribute("data-preview-url"),u=e.getAttribute("data-fullsize-url"),h=+e.getAttribute("data-fullsize-width"),p=+e.getAttribute("data-fullsize-height"),f=r/h,m=i/p,g=document.createElement("div");g.setAttribute("class","pic"),g.style.width=h+"px",g.style.height=p+"px";var v=new Image;v.src=c;var y=k.move(k.multiply(k.scale(f,m),k.identity()),[a,s,1]);g.style.webkitTransform=g.style.transform=y,L(g,u,function(e,t){e.width=h,e.height=p,e.src=u,t.appendChild(e),e=o},function(){d.setAttribute("class","load-failed")}),this.$element.append(g),this.curr=e;var _=this.cal(h,p),b=g.style;return g._m4=_,new M.Tween(y).to(_,400).interpolation(M.Interpolation.Bezier).easing(M.Easing.Exponential.Out).onUpdate(function(e){var t=k.toCSSMatrix3d(this);b.webkitTransform=b.transform=t,l.opacity=e}).onComplete(function(){t.lockup=!1,g._tween=null,M.remove(this)}).start(),g},Z.prototype.prev=function(){if(!this.lockup){var e,t=this.img,n=C(this.curr),r=n.prev(".surface");this.curr=(r.length?r:n.parent().find(".surface").last())[0],e=this.clone(this.curr),this.effect(t,e,-1)}},Z.prototype.next=function(){if(!this.lockup){var e,t=this.img,n=C(this.curr),r=n.next(".surface");this.curr=(r.length?r:n.parent().find(".surface").first())[0],e=this.clone(this.curr),this.effect(t,e,1)}},Z.prototype.effect=function(e,t,n){this.lookup=!0;var r=this,i=e._m4,a=t._m4,s=e.style,o=t.style,l=50*n;a=k.move(a,[-l,0,0]),o.webkitTransform=o.transform=k.toCSSMatrix3d(a),new M.Tween({x:0}).to({x:l},400).easing(M.Easing.Quadratic.InOut).onStart(function(){r.lockup=!0,C(e).prevAll().remove()}).onUpdate(function(e){s.opacity=1-e,s.webkitTransform=s.transform=k.toCSSMatrix3d(k.move(i,[this.x,0,1-e])),o.opacity=e,o.webkitTransform=o.transform=k.toCSSMatrix3d(k.move(a,[this.x,0,e]))}).onComplete(function(){o.opacity=1,r.lockup=!1,M.remove(this)}).start()},Z.prototype.update=function(){var e=this.img,t=e.style,n=e._m4,r=this.curr,i=+r.getAttribute("data-fullsize-width"),a=+r.getAttribute("data-fullsize-height"),s=this.cal(i,a),o=k.toCSSMatrix3d;new M.Tween(n).to(s,144).easing(M.Easing.Quadratic.InOut).onUpdate(function(){t.webkitTransform=t.transform=o([].slice.call(this))}).onComplete(function(){M.remove(this)}).start()},Z.prototype.cal=function(e,t){var n=this.vw,r=this.vh,i=q(n,r,e,t),a=i[0],s=i[1],o=a/e,l=s/t,c=(n-a)/2,u=(r-s)/2;return k.move(k.multiply(k.scale(o,l),k.identity()),[c,u,1])},Z.prototype._clone_1=function(e){var t=e.getAttribute("data-preview-url"),n=e.getAttribute("data-fullsize-url"),r=+e.getAttribute("data-fullsize-width"),i=+e.getAttribute("data-fullsize-height"),a=this.cal(r,i),s=document.createElement("div");s.setAttribute("class","pic"),s.style.width=r+"px",s.style.height=i+"px",s._m4=a;var l=new Image;return l.src=t,a=k.toCSSMatrix3d(a),s.style.webkitTransform=s.style.transform=a,s.style.opacity=0,L(s,n,function(e,t){e.width=r,e.height=i,e.src=n,t.appendChild(e),e=o},function(e,t){t.setAttribute("class","load-failed")}),this.$element.append(s),s},Z.prototype.resize=function(e,t){this.vw=e,this.vh=t,this.img&&this.update()},Z.prototype.clone=function(e){var t=!!this.curr;return this.curr=e,this.img=this["_clone_"+(t?1:0)](e)};var Q=N.extend({options:{template:'<div class="panel mnemosyne-panel perspective" tabindex="-1"><div class="panel-body perspective"><div class="gallery perspective group"></div></div></div><div class="slideshow-panel perspective group"></div>'},init:function(){var e,t=this.options;this.crossId=t.crossId,this.userId=t.userId,delete t.crossId,this.render(),e=this.element,this.$appTmp=C("#app-tmp"),this.$mnemosyne=e.eq(0),this.$gallery=this.$mnemosyne.find(".gallery"),this.$slideshow=e.eq(1),this.typesetting=new J,this.slideshow=new Z(this,this.$slideshow),this.i=0,this.n=0,this.offsetTop=0,this.offsetLeft=24,this.paddingRight=30,this.scrollLeft=0,this.showPhotoStatus=!1,this.listen()},listen:function(){function e(){t.frame=requestAnimationFrame(e),M.update()}var t=this,n=t.typesetting,r=t.slideshow,i=t.$mnemosyne,a=t.$gallery,s=t.$slideshow,o=t.$appTmp,l=C(window);e(),i.on("mouseenter.mnemosyne mouseleave.mnemosyne",".gallery .surface",function(e){e.preventDefault();var t=this,n=t.style,r=C(t),i=this._m4,a="mouseenter"===e.type,s=r.data("tween"),o=+r.attr("data-liked"),l=t.querySelector(".mask").style,c=t.querySelector(".btn-like").style,u=t.querySelector(".meta").style,d=k.multiply,h=k.scale,p=k.toCSSMatrix3d;s||(s=new M.Tween({v:1}).easing(M.Easing.Cubic.InOut),r.data("tween",s)),s.stop(),a?s.delay(233).to({v:1.01},150).onUpdate(function(e){l.opacity=4*(this.v-1),u.opacity=e,1!==o&&(c.opacity=e),n.transform=n.webkitTransform=p(d(h(this.v,this.v),i))}):s.delay(0).to({v:1},150).onUpdate(function(e){l.opacity=4*(this.v-1),u.opacity=.99*(1-e),1!==o&&(c.opacity=1-e),t.style.transform=n.webkitTransform=p(d(h(this.v,this.v),i))}).onComplete(function(){r.data("tween",null),M.remove(this)}),s.start()}).on("click.mnemosyne",".gallery .surface",function(e){e.preventDefault(),t.scrollLeft=o.scrollLeft(),o.addClass("show-slideshow"),t.emit("launch-slideshow",this)}).on("click.mnemosyne",".surface .btn-like",function(e){e.preventDefault(),e.stopPropagation();var t=C(this),n=t.parent(),r=+n.data("id"),i=+n.attr("data-liked");return-2!==i?(n.attr("data-liked",-2),1===i?(P(r,function(){n.attr("data-liked",0),t.addClass("ix-unlike").removeClass("ix-like")},function(){n.attr("data-liked",1)}),void 0):(D(r,function(){n.attr("data-liked",1),t.addClass("ix-like").removeClass("ix-unlike")},function(){n.attr("data-liked",0)}),void 0)):void 0}),s.on("keydown.mnemosyne",function(e){e.preventDefault();var n=e.keyCode;switch(n){case 39:case 40:r.next();break;case 38:case 37:r.prev();break;case 27:e.stopPropagation(),t.emit("exit-slideshow")}}),s.on("click.mnemosyne",function(e){e.preventDefault(),"IMG"!==e.target.tagName&&t.emit("exit-slideshow")}),C("html, body").bind("mousewheel.mnemosyne",function(){return!1}),o.bind("mousewheel.mnemosyne",function(e,t,n){var r=C(this).scrollLeft(),i=r+n;return C(this).scrollLeft(i),!1}),o.on("scroll.mnemosyne",function(e){e.preventDefault(),e.stopPropagation();var t,n=a.find('[data-lazy="-1"]');if(0!==n.length)for(var r=function(e,t){if(t){C(t).removeClass("load-failed");var n=t.getAttribute("data-whlt").split(","),r=e.style;t.setAttribute("data-lazy","1"),e.setAttribute("class","pic"),r.width=n[0]+"px",r.height=n[1]+"px",r.left=n[2]+"px",r.top=n[3]+"px",r.opacity=0,t.querySelector(".photo").appendChild(e),new M.Tween({v:0}).to({v:1}).easing(M.Easing.Cubic.InOut).onUpdate(function(){r.opacity=this.v}).onComplete(function(){M.remove(this)}).start()}},i=function(e,t){t&&(t.setAttribute("data-lazy","-1"),C(t).addClass("load-failed"))};(t=n.splice(0,1)[0])&&c(t);)t.setAttribute("data-lazy","0"),L(t,t.getAttribute("data-fullsize-url"),r,i)}),l.on("throttledresize.mnemosyne",function(){t.getViewport(),t.getGallery(),t.updateViewport(),t.update(),o.trigger("scroll.mnemosyne")}),t.on("load-photos",function(e){var t=e.photox.photos,n=t.length;n&&this.emit("draw",t,n)}),t.on("launch-slideshow",function(e){t.showPhotoStatus=!0;var n=a[0].style;new M.Tween({z:3}).to({z:-610},400).easing(M.Easing.Exponential.Out).onUpdate(function(e){n.transform=n.webkitTransform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, "+this.z+", 1)",n.opacity=.1*e}).onComplete(function(){M.remove(this)}).start(),t.slideshow.show(e)}),t.on("exit-slideshow",function(){t.showPhotoStatus=!1,i.focus(),t.slideshow.exit();var e=a[0].style;new M.Tween({z:-610}).to({z:1},400).interpolation(M.Interpolation.Bezier).easing(M.Easing.Exponential.Out).onUpdate(function(n){o.scrollLeft(t.scrollLeft),e.transform=e.webkitTransform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, "+this.z+", 1)",e.opacity=.5*(n+1)}).onComplete(function(){o.removeClass("show-slideshow"),M.remove(this)}).start()}),t.on("draw",function(e,t){var r=n.genLayouts(t);this.drawPhotos(e,r,t),l.trigger("throttledresize.mnemosyne")}),C("body").on("click.mnemosyne",".mnemosyne-exit",function(e){e.preventDefault(),e.stopPropagation(),t.hide()})},updateViewport:function(){var e=window.scrollX,t=window.scrollY,n="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+e+", "+t+", 1, 1)",r="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+e+", "+t+", 3, 1)",i="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+e+", "+t+", 17, 1)",a=C(".mnemosyne-bg")[0].style;a.transform=a.webkitTransform=n;var s=this.$appTmp[0].style;s.transform=s.webkitTransform=r;var o=C(".mnemosyne-exit")[0].style;o.transform=o.webkitTransform=i},addMBG:function(){var e="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+window.scrollX+", "+window.scrollY+", 1, 1)",t="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+window.scrollX+", "+window.scrollY+", 20, 1)";t="-webkit-transform:"+t+";transform:"+t+";",C('<div class="mnemosyne-exit ix-exit" style="'+t+'"></div><div class="mnemosyne-bg perspective" style="-webkit-transform: '+e+"; transform: "+e+';"><div class="mnemosyne-bg-in"></div></div>').prependTo(C("body"))},delMBG:function(){C(".mnemosyne-exit").remove(),C(".mnemosyne-bg").remove()},drawPhotos:function(e,t,n){var r,i,a,s=this.$gallery,o=0,l=0;for(this.layouts||(this.layouts=[]),this.gid=this.layouts.length;r=t[o++];)i=r.cells,a=K(e.slice(l,l+=i.length),i),s.append(a);this.layouts=this.layouts.concat(t),this.i=this.n,this.n+=n},update:function(){for(var e,t,n,r,i,a,s,o,l,c,u,d,h,p,f=this.$gallery,m=f.find("figure").slice(this.i,this.n),g=this.gvw,v=this.gvh,y=this.gid,_=this.layouts.slice(y),b=this.offsetTop,x=this.offsetLeft,w=0,k=v,T=g;e=_.shift();){for(y=e.id,i=e.aspect_ratio,t=e.cells.slice(),n=t.length,i&&(T=F(v,i));r=t.shift();){a=m.eq(w),o=+a.data("preview-height"),s=+a.data("preview-width"),l=a.data("provider"),1===n&&(T=F(v,s/o)),c=r.margin,d=r.height*k-c.top-c.bottom,u=r.width*T-c.left-c.right,p=b+r.y*k+c.top+(v-k)/2,h=x+r.x*T+c.left;var C=B(u,d,s,o);s=C[0],o=C[1],U(a[0],y,o,s,d,u,p,h,l),w++}x+=T}this.addPaddingRight(0,x)},addPaddingRight:function(e,t){var n=this.$gallery,r=n.find(".photos-padding-right");r.size()||(r=C('<div class="photos-padding-right"></div>').css({width:this.paddingRight})),r.css({"-webkit-transform":"translate3d("+t+"px, "+e+"px, 0)","-moz-transform":"translate3d("+t+"px, "+e+"px, 0)","-ms-transform":"translate3d("+t+"px, "+e+"px, 0)","-o-transform":"translate3d("+t+"px, "+e+"px, 0)",transform:"translate3d("+t+"px, "+e+"px, 0)"}),n.append(r)},getPhotos:function(){var e=this,t=this.userId;I(e.crossId,null,function(n){var r=n.likes,i=n.photox.photos;S.each(i,function(e){var n=r[e.id];e.like=0,n&&n.length&&S.each(n,function(n){n.object_id===e.id&&n.by_identity.connected_user_id===t&&(e.like=1)})}),e.emit("load-photos",n)})},getViewport:function(){var e=this.element;this.vw=i=e.width(),this.vh=a=e.height(),this.slideshow.resize(this.vw,this.vh)},getGallery:function(){this.gvw=this.vw,this.gvh=this.vh-40-60},showBefore:function(){C("body").addClass("mnemosyne-start"),C("#app-tmp").css("-webkit-transform","matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+window.scrollX+", "+window.scrollY+", 3, 1)"),C("#app-tmp").css("transform","matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+window.scrollX+", "+window.scrollY+", 3, 1)"),this.getPhotos()},showAfter:function(){var e=C(".mnemosyne-bg"),t=e[0].style,n=e.find(".mnemosyne-bg-in")[0].style,r=this.$mnemosyne,i=(r[0].style,this.$appTmp),a=this.$gallery,s=a[0].style,o=new M.Tween({v:0}).to({v:1},750).interpolation(M.Interpolation.Bezier).easing(M.Easing.Cubic.In).onUpdate(function(){t.opacity=this.v}).onComplete(function(){M.remove(this)}),l=new M.Tween({v:0}).delay(250).to({v:1},1e3).interpolation(M.Interpolation.Bezier).easing(M.Easing.Cubic.In).onUpdate(function(){n.opacity=this.v}).onComplete(function(){M.remove(this)}),c=new M.Tween({v:2584}).delay(250).to({v:3},1500).interpolation(M.Interpolation.Bezier).easing(M.Easing.Cubic.In).onUpdate(function(){s.webkitTransform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, "+this.v+", 1)"}).onComplete(function(){i.trigger("scroll.mnemosyne"),M.remove(this)});o.start(),l.start(),c.start()},show:function(){return this.emit("showBefore"),this.escapable(),this.element.prependTo(this.parentNode),this.addMBG(),this.emit("showAfter"),this},hide:function(){M.removeAll();var e=this,t=C(".mnemosyne-bg")[0].style,n=e.$mnemosyne[0].style,r=e.$slideshow[0].style;C(document).off("keydown.panel"),this.element.off(),new M.Tween({o:1}).to({o:0},250).easing(M.Easing.Cubic.In).onUpdate(function(){t.opacity=n.opacity=r.opacity=this.o}).onComplete(function(){e.destory(),M.removeAll()}).start()},destory:function(){this.delMBG(),C("html, body").unbind("mousewheel.mnemosyne"),C("body").off(".mnemosyne").removeClass("mnemosyne-start"),C(".mnemosyne-exit").off("click.mnemosyne"),this.$appTmp.removeClass(".show-mnemosyne").off(".mnemosyne").css({"-webkit-transform":"none",transform:"none"}),C(window).off("throttledresize.mnemosyne"),cancelAnimationFrame(this.frame),this.element.off(),this.element.remove(),this._destory()}});return Q});