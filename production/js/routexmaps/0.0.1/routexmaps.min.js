define("routexmaps",function(t){"use strict";function e(e){e=this.options=e||{},this.svgLayer=this.options.svg,delete this.options.svg,this.latOffset=0,this.lngOffset=0,this.routes={},this.places={},this.locations={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.updated={},this.boundsOffset={left:50,top:0},window._loadmaps_=function(e,i,r,s){return function o(){var a=google.maps,u=a.event;a.InfoBox=t("infobox"),a.TextLabel=t("maplabel");var c=e.icons;c.dotGrey=new a.MarkerImage(n+"/static/img/map_dot_grey@2x.png",new a.Size(36,36),new a.Point(0,0),new a.Point(9,9),new a.Size(18,18)),c.dotRed=new a.MarkerImage(n+"/static/img/map_dot_red@2x.png",new a.Size(36,36),new a.Point(0,0),new a.Point(9,9),new a.Size(18,18)),c.arrowBlue=new a.MarkerImage(n+"/static/img/map_arrow_blue@2x.png",new a.Size(40,40),new a.Point(0,0),new a.Point(10,10),new a.Size(20,20)),c.arrowGrey=new a.MarkerImage(n+"/static/img/map_arrow_g5@2x.png",new a.Size(40,40),new a.Point(0,0),new a.Point(10,10),new a.Size(20,20)),a.visualRefresh=!0,r.center=e.toLatLng(35.86166,104.195397),r.mapTypeId=a.MapTypeId.ROADMAP,r.disableDefaultUI=!0,r.minZoom=2;var l=e.map=new a.Map(i,r),h=e.overlay=new a.OverlayView;h.draw=function(){},h.setMap(l);var p=u.addListener(l,"tilesloaded",function(){u.addListener(l,"bounds_changed",function(){u.trigger(l,"zoom_changed")}),u.addListener(l,"zoom_changed",function(){e.contains()}),u.addDomListener(i,"touchstart",function(){u.clearListeners(i,"touchmove"),u.addDomListenerOnce(i,"touchmove",function(){e.hideTiplines()})}),u.removeListener(p)});s(l),o=null}}(this,e.mapDiv,e.mapOptions,e.callback)}var n=window._ENV_.site_url,i=6378137,r=function(t,e,n,r){var s=i,o=(n-t)*Math.PI/180,a=(r-e)*Math.PI/180,u=Math.sin(o/2)*Math.sin(o/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(a/2)*Math.sin(a/2),c=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),l=s*c;return l},s=function(t){return t*Math.PI/180},o=function(t){return 180*t/Math.PI},a=function(t,e,n,i){t=s(t),e=s(e),n=s(n),i=s(i);var r=i-e,a=Math.sin(r)*Math.cos(n),u=Math.cos(t)*Math.sin(n)-Math.sin(t)*Math.cos(n)*Math.cos(r),c=Math.atan2(a,u);return 0>c&&(c+=2*Math.PI),o(c)},u=function(t,e,n,i){return n='<span class="unit">{{u}}</span>',t=Math.floor(t),i={text:"",status:0,distance:t},30>t?(i.status=4,i.text="抵达"):i.text=1e3>t?t+n.replace("{{u}}","米"):9e3>t?(t/1e3+"").slice(0,3)+n.replace("{{u}}","公里"):"9+"+n.replace("{{u}}","公里"),i},c=function(t){return(1*t).toString(16)},l=function(t){return t+="",t+(t.length>1?"":"0")},h=610,p="destination",f=e.prototype;return f.load=function(t){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.onload=e.onerror=e.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(e.readyState)&&(e=e.onload=e.onerror=e.onreadystatechange=null,t&&t())},e.src=this.options.url,document.body.appendChild(e)},f.fromContainerPixelToLatLng=function(t){return this.overlay.getProjection().fromContainerPixelToLatLng(t)},f.fromLatLngToContainerPixel=function(t){return this.overlay.getProjection().fromLatLngToContainerPixel(t)},f.draw=function(t,e){if(console.log(t,e),"geomarks"===t){var n,i,r=[],s=[];for(e=e.slice(0);n=e.shift();)i=n.type,"route"===i?r.push(n):"location"===i&&s.push(n);this.drawRoutes(r),this.drawPlaces(s)}else"breadcrumbs"===t&&this.drawIdentityPaths(e)},f.drawRoutes=function(t){var e,n,i,r=this.routes;for(n in r)e=r[n],e.setMap(null),e=null,delete r[n];if(t.length)for(;i=t.shift();)this.addRoute(i)},f.addRoute=function(t){var e,n,i=[],r=t.created_by,s=t.positions.slice(0);for(n=this.routes[r]=this.addPolyline(t);e=s.shift();)i.push(this.toLatLng(e.latitude,e.longitude));n.setPath(i)},f.addPolyline=function(t){var e=t.color&&t.color.split(",")||[],n="#"+(e.length?l(c(e[0]))+l(c(e[1]))+l(c(e[2])):"007BFF"),i=e[3]||1,r=new google.maps.Polyline({map:this.map,index:h-4,geodesic:!0,strokeColor:n,strokeWeight:4,strokeOpacity:i});return r},f.drawPlaces=function(t){var e,n,i,r=this.places;this.destinationPlace=null;for(n in r)e=r[n],e.setMap(null),e=null,delete r[n];if(t.length)for(;i=t.shift();)this.addPlace(i)},f.addPlace=function(t){var e,n,i,r=t.id,s=this.toLatLng(t.latitude,t.longitude);if(e=this.places[r]=this.addPoint(t),e.setPosition(s),!this.destinationPlace)for(n=t.tags.slice(0);i=n.shift();)if(p===i){var o=this.geoLocation;return(!o||o&&0==o._status)&&this.panToDestination(s),e.setZIndex(h),this.destinationPlace=e,void 0}},f.monit=function(){var t,e,n,i,r,s,o,a,u=this.updated,c=this.breadcrumbs,l=this.icons,h=this.geoMarkers,p=this.tiplines,f=this.destinationPlace,d=this.geoLocation,m=this.myuid,g=Math.round((new Date).getTime()/1e3);for(t in u)if(u.hasOwnProperty(t))if(n=u[t],e=m===t,i=Math.floor((g-n.timestamp)/60),r=e?d:h[t],this.distanceMatrix(t,r,f,i),s=c[t],a=p[t],o=$('#identities-overlay .identity[data-uid="'+t+'"]').find(".icon"),console.log(i),1>=i){if(o.length&&(o.hasClass("icon-arrow-grey")||o.hasClass("icon-arrow-red")?o.attr("class","icon icon-arrow-red"):o.attr("class","icon icon-dot-red")),s&&s.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#FF7E98",fillOpacity:.8,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},repeat:"50px",offset:"0"}]}),e)continue;a&&a.setAttribute("stroke","#FF7E98"),r&&r.setIcon(l.dotRed)}else{if(o.length&&(o.hasClass("icon-arrow-grey")||o.hasClass("icon-arrow-red")?o.attr("class","icon icon-arrow-grey"):o.attr("class","icon icon-dot-grey")),s&&s.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#b2b2b2",fillOpacity:.8,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},repeat:"50px",offset:"0"}]}),e)continue;a&&a.setAttribute("stroke","#b2b2b2"),r&&r.setIcon(l.dotGrey)}},f.toLatLng=function(t,e){return new google.maps.LatLng(1*t,1*e)},f.drawIdentityPaths=function(t){var e,n,i,r,s,o,a,u=this.breadcrumbs,c=this.destinationPlace;for(e in t){for(i=t[e],n=u[e],s=i.slice(0),o=[];r=s.shift();)o.push(this.toLatLng(r.latitude,r.longitude));n||(n=u[e]=this.addBreadcrumbs()),n.setPath(o),a=this.drawGeoMarker(e,i[0],o[0]),this.distanceMatrix(e,a,c)}},f.drawGeoMarker=function(t,e,n){var i;return this.updated[t]=e,this.myuid===t?this.geoLocation:(i=this.geoMarkers[t],i||(i=this.geoMarkers[t]=this.addGeoMarker()),i.setPosition(n),this.updateTipline(t,n),i)},f.addGeoMarker=function(){var t=new google.maps.Marker({map:this.map,animation:3,zIndex:h-2,icon:this.icons.dotGrey});return t},f.distanceMatrix=function(t,e,n,i){i=i||0,console.log(t,"destination",n,e);var s=$('#identities-overlay .identity[data-uid="'+t+'"]'),o=s.find(".detial"),c=o.find(".icon"),l=o.find(".distance");if(e&&n){var h=e.getPosition(),p=n.getPosition(),f=h.lat(),d=h.lng(),m=p.lat(),g=p.lng(),v=r(m,g,f,d),y=a(m,g,f,d),b=u(v);console.log(v,y,f,d,m,g),b.rotate=y,l.html(b.text),c.css("-webkit-transform","rotate("+y+"deg)"),c.attr("class","icon icon-arrow-"+(1>=i?"red":"grey")),o.css("visibility","visible")}else e?(c.hasClass("icon-dot-red")||c.hasClass("icon-dot-red")||c.attr("class","icon icon-dot"+(1>=i?"red":"grey")),l.html((i>=9?"9+":i)+'<span class="unit">分钟前</span>'),o.css("visibility","visible")):o.css("visibility","hidden")},f.fitBoundsWithDestination=function(t){console.log("fit bounds with destination");var e=this.destinationPlace,n=this.myuid===t,i=n?this.geoLocation:this.geoMarkers[t];if(i){var r=i.getPosition(),s=this.map;if(e){var o,a=e.getPosition(),u=this.fromLatLngToContainerPixel(a);n?o=this.calculateBoundsByCenter(r,[a]):(o=new google.maps.LatLngBounds,50>u.x&&(u=this.fromContainerPixelToLatLng(new google.maps.Point(u.x-50,u.y)),o.extend(u)),o.extend(r),o.extend(a)),s.fitBounds(o)}else s.getBounds().contains(r)||(7>s.getZoom()&&s.setZoom(15),s.panTo(r))}},f.panToDestination=function(t){var e=this.map;7>e.getZoom()&&e.setZoom(15),e.panTo(t||this.destinationPlace.getPosition())},f.calculateBoundsByCenter=function(t,e){for(var n,i,r,s=new google.maps.LatLngBounds,o=[];i=e.shift();)n=this.fromLatLngToContainerPixel(i),o.push(n);for(var a,u,r=this.fromLatLngToContainerPixel(t),c=0;u=o.shift();)a=Math.sqrt(Math.pow(u.x-r.x,2)+Math.pow(u.y-r.y,2)),a>c&&(c=a);var l=this.fromContainerPixelToLatLng(new google.maps.Point(r.x-c-50,r.y-c-50)),h=this.fromContainerPixelToLatLng(new google.maps.Point(r.x+c+50,r.y+c+50));return s.extend(l),s.extend(t),s.extend(h),s},f.addBreadcrumbs=function(){var t="#b2b2b2",e=.8,n=new google.maps.Polyline({map:this.map,visible:!1,index:h-3,strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:t,fillOpacity:e,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},fixedRotation:!0,repeat:"50px",offset:"0"}]});return n},f.showTextLabels=function(){},f.showBreadcrumbs=function(t){var e,n=this.breadcrumbs,i=this.uid,r=n[t];t!==i?(e=n[i],e&&e.setVisible(!1),r&&r.setVisible(!0)):r&&r.setVisible(!r.getVisible()),this.uid=t,console.log("showBreadcrumbs",i,t)},f.addPoint=function(t){var e=this,n=google.maps,i=this.map,r=new n.Marker({map:i,animation:2,zIndex:h-4,icon:new n.MarkerImage(t.icon,new n.Size(48,68),new n.Point(0,0),new n.Point(12,34),new n.Size(24,34))}),s=n.event;return s.addListener(r,"mousedown",function(r){if(r&&r.stop(),e.removeInfobox(this))return!1;var o=e.infobox=new n.InfoBox({content:e.infoWindowTemplate.replace("{{title}}",t.title).replace("{{description}}",t.description),maxWidth:200,pixelOffset:new n.Size(-80,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1,leftBoundary:60,zIndex:610});o._marker=this,o.open(i,this),s.addListenerOnce(this,"mouseout",function(){o.close(),delete o._marker,o=e.infobox=null})}),r},f.removeInfobox=function(t){var e,n=this.infobox;return n&&(e=n._marker,n.close(),delete n._marker,n=this.infobox=null,e===t)?!0:void 0},f.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',f.getPointsBounds=function(){var t,e=this.locations,n=new google.maps.LatLngBounds;for(t in e)n.union(e[t]._bounds);return n},f.contains=function(){var t,e,n,i=this.map.getBounds(),r=google.maps,s=i.getSouthWest(),o=i.getNorthEast(),a=new r.LatLngBounds,u=this.geoMarkers,c=document.getElementById("identities")._ids||{};s=this.fromLatLngToContainerPixel(s),s=this.fromContainerPixelToLatLng(new r.Point(s.x+50,s.y)),a.extend(s),a.extend(o);for(t in u)e=u[t],n=e.getPosition(),this.containsOne(t,n,a,c);console.log("map zoom",this.map.getZoom())},f.containsOne=function(t,e,n,i,r){n||(n=this.map.getBounds()),i||(i=document.getElementById("identities")._ids||{}),n.contains(e)&&(r=i[t])?this.showTipline(t,r):this.hideTipline(t)},f.hideTiplines=function(){var t,e=this.tiplines;for(t in e)this.hideTipline(t)},f.updateTipline=function(t,e){var n=this.tiplines[t];n||(n=this.tiplines[t]=this.addTipline(t)),e&&this.containsOne(t,n._lastlatlng=e)},f.addTipline=function(t){var e=(this.breadcrumbs[t],document.createElementNS("http://www.w3.org/2000/svg","polyline"));return e.setAttribute("fill","none"),e.setAttribute("stroke","#b2b2b2"),e.setAttribute("stroke-width",1),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),e.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(e),e},f.showTipline=function(t,e){var n,i=this.tiplines[t];if(i){var r=[e[1],e[2]],s=[r[0]+13,r[1]],o=[r.join(","),s.join(",")].join(" "),n=this.fromLatLngToContainerPixel(i._lastlatlng);i.setAttribute("points",o+" "+n.x+","+n.y),i.setAttributeNS(null,"display","block")}},f.hideTipline=function(t){var e=this.tiplines[t];e&&e.setAttributeNS(null,"display","none")},f.updateGeoLocation=function(t,e){var n,i=this.geoLocation;if(!i){i=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:h-1,visible:!0,animation:2,icon:this.icons.arrowGrey}),i._status=0;var r=JSON.parse(window.localStorage.getItem("last-latlng"));r&&(i._status=1,n=this.toLatLng(1*r.lat+this.latOffset,1*r.lng+this.lngOffset),i.setPosition(n),this.map.setZoom(15),this.map.panTo(n),console.log("init position",r))}e&&(n=this.toLatLng(1*e.latitude+this.latOffset,1*e.longitude+this.lngOffset),i.setIcon(this.icons.arrowBlue),i.setPosition(n),2!==i._status&&(this.map.setZoom(15),this.map.panTo(n)),i._status=2),t&&(this.updated[t]=e||r),i._uid=t},f.switchGEOStyle=function(t){var e=this.geoLocation;e&&e.setIcon(this.icons["arrow"+(t?"Blue":"Grey")])},e});