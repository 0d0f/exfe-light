define("routexmaps",function(t){"use strict";function e(e){e=this.options=e||{},this.svgLayer=this.options.svg,this.options.svg=null,this.routes={},this.locations={},this.tiplines={},window._loadmaps_=function(e,n,i){return function r(){function o(t,e){this.map_=e,this.svg_=t,this.div_=null,this.setMap(e)}google.maps.InfoBox=t("infobox"),o.prototype=new google.maps.OverlayView,o.prototype.onAdd=function(){this.div_=this.svg_,this.div_.style.zIndex=144;var t=this.getPanes();t.overlayLayer.appendChild(this.div_)},o.prototype.draw=function(){},google.maps.visualRefresh=!0,i.center=new google.maps.LatLng(35.86166,104.195397),i.mapTypeId=google.maps.MapTypeId.ROADMAP,i.disableDefaultUI=!0;var s=e.map=new google.maps.Map(n,i),a=google.maps.event,u=a.addListener(s,"tilesloaded",function(){a.addListener(s,"bounds_changed",function(){console.log("bounds_end",e.uid),a.trigger(s,"zoom_changed")}),a.addListener(s,"zoom_changed",function(){console.log("zoom_end"),e.showTipline(e.uid),e.showPolyline(e.uid)}),a.addDomListener(n,"touchstart",function(){console.log("touchstart",e.uid),a.clearListeners(n,"touchmove"),a.addDomListenerOnce(n,"touchmove",function(){console.log("touchmove"),e.hideTipline(e.uid),e.hidePolyline(e.uid)})}),a.removeListener(u)}),c=e.overlay=new google.maps.OverlayView;c.onAdd=function(){this.div_=self.svgLayer},c.draw=function(){},c.setMap(s),r=null}}(this,e.mapDiv,e.mapOptions,e.callback)}var n=e.prototype;return n.load=function(t){var e=document.createElement("script");e.type="text/javascript",e.onload=e.onerror=e.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(e.readyState)&&(e=e.onload=e.onerror=e.onreadystatechange=null,t&&t())},e.async=1,e.src=this.options.url,document.body.appendChild(e)},n.draw=function(t,e,n){"geomarks"===t&&(n=e.type,"route"===n?this.updatePolyline(e):"location"===n&&this.updatePoint(e))},n.fitBounds=function(t){var e,n,i=this.routes[this.uid],r=new google.maps.LatLngBounds,t=t&&t.slice(0),o=0;if(t)for(;e=t.shift();)r.extend(n=new google.maps.LatLng(e.latitude,e.longitude)),o++;i&&(r.union(i._bounds),r.union(this.getPointsBounds()),o=2),o>1?(this.map.panToBounds(r),this.map.fitBounds(r)):(n||(n=this.map.getCenter()),this.map.panTo(n))},n.fitCenter=function(t){var e,n,i,r=this.locations,o=new google.maps.LatLngBounds,s=0,a=[];for(n in r)e=r[n],"destination"===e._type&&(a.push(e.getPosition()),s++);t?(i=new google.maps.LatLng(t.latitude,t.longitude),s++):i=this.map.getCenter();var u=this.overlay;if(s>1){for(var c,l,h=[];l=a.shift();)c=u.getProjection().fromLatLngToContainerPixel(l),h.push(c);for(var p,f,d=u.getProjection().fromLatLngToContainerPixel(i),g=0;f=h.shift();)p=Math.sqrt(Math.pow(f.x-d.x,2)+Math.pow(f.y-d.y,2)),console.log(p,f.x,d.x,f.y,d.y),p>g&&(g=p);var m=u.getProjection().fromContainerPixelToLatLng(new google.maps.Point(d.x-g,d.y-g)),v=u.getProjection().fromContainerPixelToLatLng(new google.maps.Point(d.x+g,d.y+g));o.extend(m),o.extend(i),o.extend(v),this.map.fitBounds(o)}else this.map.setZoom(18),this.map.panTo(i)},n.updatePolyline=function(t){var e,n,i,r,o=this.routes,s=[],a=t.created_by,u=t.positions.slice(0);for(n=o[a],n||(n=o[a]=this.addPolyline(t)),i=new google.maps.LatLngBounds;e=u.shift();)r=new google.maps.LatLng(e.latitude,e.longitude),i.extend(r),s.push(r);n._data=t,n._bounds=i,n.setPath(s),this.updateTipline(a,r)},n.addPolyline=function(t){var e=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeColor:t.color,strokeOpacity:0,icons:[{icon:{path:"M 0,-1 0,1",fillOpacity:1,strokeOpacity:1,strokeWeight:2,scale:1},repeat:"20px",offset:"0"}]});return e},n.hidePolyline=function(t){var e=this.routes[t];e&&e.setVisible(!1)},n.showPolyline=function(t){var e=this.routes[t];e&&e.setVisible(!0),this.uid=t},n.updatePoint=function(t){var e,n,i,r,o,s=this.locations,a=t.id;for(n=s[a],n||(n=s[a]=this.addPoint(t)),e=new google.maps.LatLngBounds,i=new google.maps.LatLng(t.latitude,t.longitude),e.extend(i),r=t.tags.slice(0);o=r.shift();)if("destination"===o){n._type="destination";break}n._data=t,n._bounds=e,n.setPosition(i),n.setVisible(!0)},n.addPoint=function(t){var e=this,n=new google.maps.Marker({map:this.map,animation:google.maps.Animation.DROP,icon:new google.maps.MarkerImage(t.icon,new google.maps.Size(48,68),new google.maps.Point(0,0),new google.maps.Point(12,17),new google.maps.Size(24,34)),visible:!1,zIndex:233}),i=google.maps.event;return i.addListener(n,"mousedown",function(n){if(console.log("marker mousedown",n),n&&n.stop(),e.removeInfobox(this))return!1;var r=e.infobox=new google.maps.InfoBox({content:e.infoWindowTemplate.replace("{{title}}",t.title).replace("{{description}}",t.description),pixelOffset:new google.maps.Size(-80,-20),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1});r.open(e.map,this),r._marker=this,i.addListenerOnce(this,"mouseout",function(){r.close(),r=e.infobox=null})}),n},n.removeInfobox=function(t){var e,n=this.infobox;return n&&(e=n._marker,n.close(),n=this.infobox=null,e===t)?!0:void 0},n.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',n.getPointsBounds=function(){var t,e=this.locations,n=new google.maps.LatLngBounds;for(t in e)n.union(e[t]._bounds);return n},n.updateTipline=function(t,e){var n=this.tiplines[t];n||(n=this.tiplines[t]=this.addTipline(t)),n._lastlatlng=e},n.addTipline=function(t){var e=this.routes[t],n=e._data.color,i=$('#identities > .identity[data-uid="'+t+'"]')[0].getBoundingClientRect(),r=document.createElementNS("http://www.w3.org/2000/svg","polyline"),o=[50,i.top+i.height/2],s=[o[0]+13,o[1]],a=[o.join(","),s.join(",")];return r.setAttribute("fill","none"),r.setAttribute("stroke",n),r.setAttribute("stroke-width",1),r.setAttribute("start-points",a.join(" ")),r.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(r),r},n.showTipline=function(t){var e,n,i=this.tiplines[t];i&&(e=this.overlay.getProjection().fromLatLngToContainerPixel(i._lastlatlng),n=i.getAttribute("start-points"),i.setAttribute("points",n+" "+e.x+","+(e.y-3)),i.setAttributeNS(null,"display","block"))},n.hideTipline=function(t){var e=this.tiplines[t];e&&e.setAttributeNS(null,"display","none")},n.showGeoLocation=function(t){var e=this.geoLocation;e||(e=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:377,visible:!1,animation:google.maps.Animation.DROP,icon:new google.maps.MarkerImage("/static/img/map_arrow_blue@2x.png",new google.maps.Size(40,40),new google.maps.Point(0,0),new google.maps.Point(10,10),new google.maps.Size(20,20))})),e.setPosition(new google.maps.LatLng(t.latitude,t.longitude)),e.setVisible(!0)},n.hideGeoLocation=function(){var t=this.geoLocation;t&&t.setVisible(!1)},e});