define("routexmaps",function(e){"use strict";function t(t){t=this.options=t||{},this.svgLayer=this.options.svg,delete this.options.svg,this.latOffset=0,this.lngOffset=0,this.routes={},this.places={},this.locations={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.updated={},this.boundsOffset={left:50,top:0},window._loadmaps_=function(t,n,r,a){return function s(){var o=google.maps,l=o.event;o.InfoBox=e("infobox"),o.TextLabel=e("maplabel");var c=t.icons;c.dotGrey=new o.MarkerImage(i+"/static/img/map_dot_grey@2x.png",new o.Size(36,36),new o.Point(0,0),new o.Point(9,9),new o.Size(18,18)),c.dotRed=new o.MarkerImage(i+"/static/img/map_dot_red@2x.png",new o.Size(36,36),new o.Point(0,0),new o.Point(9,9),new o.Size(18,18)),c.arrowBlue=new o.MarkerImage(i+"/static/img/map_arrow_blue@2x.png",new o.Size(40,40),new o.Point(0,0),new o.Point(10,10),new o.Size(20,20)),c.arrowGrey=new o.MarkerImage(i+"/static/img/map_arrow_g5@2x.png",new o.Size(40,40),new o.Point(0,0),new o.Point(10,10),new o.Size(20,20)),o.visualRefresh=!0,r.center=t.toLatLng(35.86166,104.195397),r.mapTypeId=o.MapTypeId.ROADMAP,r.disableDefaultUI=!0,r.minZoom=1;var u=t.map=new o.Map(n,r),d=t.overlay=new o.OverlayView;d.draw=function(){},d.setMap(u);var h=l.addListener(u,"tilesloaded",function(){l.addListener(u,"bounds_changed",function(){l.trigger(u,"zoom_changed")}),l.addListener(u,"zoom_changed",function(){t.contains()}),l.addDomListener(n,"touchstart",function(){l.clearListeners(n,"touchmove"),l.addDomListenerOnce(n,"touchmove",function(){t.hideTiplines()})}),l.removeListener(h)});a(u),s=null}}(this,t.mapDiv,t.mapOptions,t.callback)}var i=window._ENV_.site_url,n=6378137,r=function(e,t,i,r){var a=n,s=(i-e)*Math.PI/180,o=(r-t)*Math.PI/180,l=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2),c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),u=a*c;return u},a=function(e){return e*Math.PI/180},s=function(e){return 180*e/Math.PI},o=function(e,t,i,n){e=a(e),t=a(t),i=a(i),n=a(n);var r=n-t,o=Math.sin(r)*Math.cos(i),l=Math.cos(e)*Math.sin(i)-Math.sin(e)*Math.cos(i)*Math.cos(r),c=Math.atan2(o,l);return 0>c&&(c+=2*Math.PI),s(c)},l=function(e,t,i,n){return i='<span class="unit">{{u}}</span>',e=Math.floor(e),n={text:"",status:0,distance:e},30>e?(n.status=4,n.text="抵达"):n.text=1e3>e?e+i.replace("{{u}}","米"):9e3>e?(e/1e3+"").slice(0,3)+i.replace("{{u}}","公里"):"9+"+i.replace("{{u}}","公里"),n},c=function(e){return(1*e).toString(16)},u=function(e){return e+="",e+(e.length>1?"":"0")},d=610,h="destination",p=t.prototype;return p.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.onload=t.onerror=t.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(t.readyState)&&(t=t.onload=t.onerror=t.onreadystatechange=null,e&&e())},t.src=this.options.url,document.body.appendChild(t)},p.fromContainerPixelToLatLng=function(e){return this.overlay.getProjection().fromContainerPixelToLatLng(e)},p.fromLatLngToContainerPixel=function(e){return this.overlay.getProjection().fromLatLngToContainerPixel(e)},p.draw=function(e,t){if(console.log(e,t),"geomarks"===e){var i,n,r=[],a=[];for(t=t.slice(0);i=t.shift();)n=i.type,"route"===n?r.push(i):"location"===n&&a.push(i);this.drawRoutes(r),this.drawPlaces(a)}else"breadcrumbs"===e&&this.drawIdentityPaths(t)},p.drawRoutes=function(e){var t,i,n,r=this.routes;for(i in r)t=r[i],t.setMap(null),t=null,delete r[i];if(e.length)for(;n=e.shift();)this.addRoute(n)},p.addRoute=function(e){var t,i,n=[],r=e.created_by,a=e.positions.slice(0);for(i=this.routes[r]=this.addPolyline(e);t=a.shift();)n.push(this.toLatLng(t.latitude,t.longitude));i.setPath(n)},p.addPolyline=function(e){var t=e.color&&e.color.split(",")||[],i="#"+(t.length?u(c(t[0]))+u(c(t[1]))+u(c(t[2])):"007BFF"),n=t[3]||1,r=new google.maps.Polyline({map:this.map,index:d-4,geodesic:!0,strokeColor:i,strokeWeight:4,strokeOpacity:n});return r},p.drawPlaces=function(e){var t,i,n,r=this.places;this.destinationPlace=null;for(i in r)t=r[i],t.setMap(null),t=null,delete r[i];if(e.length)for(;n=e.shift();)this.addPlace(n)},p.addPlace=function(e){var t,i,n,r=e.id,a=this.toLatLng(e.latitude,e.longitude);if(t=this.places[r]=this.addPoint(e),t.setPosition(a),!this.destinationPlace)for(i=e.tags.slice(0);n=i.shift();)if(h===n){var s=this.geoLocation;return(!s||s&&0==s._status)&&this.panToDestination(a),t.setZIndex(d),this.destinationPlace=t,void 0}},p.monit=function(){var e,t,i,n,r,a,s,o,l=this.updated,c=this.breadcrumbs,u=this.icons,d=this.geoMarkers,h=this.tiplines,p=this.destinationPlace,f=this.geoLocation,m=this.myuid,g=Math.round((new Date).getTime()/1e3);for(e in l)if(l.hasOwnProperty(e))if(i=l[e],t=m===e,n=Math.floor((g-i.timestamp)/60),r=t?f:d[e],this.distanceMatrix(e,r,p,n),a=c[e],o=h[e],s=$('#identities-overlay .identity[data-uid="'+e+'"]').find(".icon"),console.log(n),1>=n){if(s.length&&(s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-red"):s.attr("class","icon icon-dot-red")),a&&a.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#FF7E98",fillOpacity:.8,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},repeat:"50px",offset:"0"}]}),t)continue;o&&o.setAttribute("stroke","#FF7E98"),r&&r.setIcon(u.dotRed)}else{if(s.length&&(s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-grey"):s.attr("class","icon icon-dot-grey")),a&&a.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#b2b2b2",fillOpacity:.8,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},repeat:"50px",offset:"0"}]}),t)continue;o&&o.setAttribute("stroke","#b2b2b2"),r&&r.setIcon(u.dotGrey)}},p.toLatLng=function(e,t){return new google.maps.LatLng(1*e,1*t)},p.drawIdentityPaths=function(e){var t,i,n,r,a,s,o,l=this.breadcrumbs,c=this.destinationPlace;for(t in e){for(n=e[t],i=l[t],a=n.slice(0),s=[];r=a.shift();)s.push(this.toLatLng(r.latitude,r.longitude));i||(i=l[t]=this.addBreadcrumbs()),i.setPath(s),o=this.drawGeoMarker(t,n[0],s[0]),this.distanceMatrix(t,o,c)}},p.drawGeoMarker=function(e,t,i){var n;return this.updated[e]=t,this.myuid===e?this.geoLocation:(n=this.geoMarkers[e],n||(n=this.geoMarkers[e]=this.addGeoMarker()),n.setPosition(i),this.updateTipline(e,i),n)},p.addGeoMarker=function(){var e=new google.maps.Marker({map:this.map,animation:3,zIndex:d-2,icon:this.icons.dotGrey});return e},p.distanceMatrix=function(e,t,i,n){n=n||0,console.log(e,"destination",i,t);var a=$('#identities-overlay .identity[data-uid="'+e+'"]'),s=a.find(".detial"),c=s.find(".icon"),u=s.find(".distance");if(t&&i){var d=t.getPosition(),h=i.getPosition(),p=d.lat(),f=d.lng(),m=h.lat(),g=h.lng(),v=r(m,g,p,f),y=o(m,g,p,f),_=l(v);console.log(v,y,p,f,m,g),_.rotate=y,u.html(_.text),c.css("-webkit-transform","rotate("+y+"deg)"),c.attr("class","icon icon-arrow-"+(1>=n?"red":"grey")),s.css("visibility","visible")}else t?(c.hasClass("icon-dot-red")||c.hasClass("icon-dot-red")||c.attr("class","icon icon-dot"+(1>=n?"red":"grey")),u.html((n>=9?"9+":n)+'<span class="unit">分钟前</span>'),s.css("visibility","visible")):s.css("visibility","hidden")},p.fitBoundsWithDestination=function(e){console.log("fit bounds with destination");var t=this.destinationPlace,i=this.myuid===e,n=i?this.geoLocation:this.geoMarkers[e];if(n){var r=n.getPosition(),a=this.map;if(t){var s,o=t.getPosition(),l=this.fromLatLngToContainerPixel(o);i?s=this.calculateBoundsByCenter(r,[o]):(s=new google.maps.LatLngBounds,50>l.x&&(l=this.fromContainerPixelToLatLng(new google.maps.Point(l.x-50,l.y)),s.extend(l)),s.extend(r),s.extend(o)),a.fitBounds(s)}else a.getBounds().contains(r)||(7>a.getZoom()&&a.setZoom(15),a.panTo(r))}},p.panToDestination=function(e){var t=this.map;7>t.getZoom()&&t.setZoom(15),t.panTo(e||this.destinationPlace.getPosition())},p.calculateBoundsByCenter=function(e,t){for(var i,n,r,a=new google.maps.LatLngBounds,s=[];n=t.shift();)i=this.fromLatLngToContainerPixel(n),s.push(i);for(var o,l,r=this.fromLatLngToContainerPixel(e),c=0;l=s.shift();)o=Math.sqrt(Math.pow(l.x-r.x,2)+Math.pow(l.y-r.y,2)),o>c&&(c=o);var u=this.fromContainerPixelToLatLng(new google.maps.Point(r.x-c-50,r.y-c-50)),d=this.fromContainerPixelToLatLng(new google.maps.Point(r.x+c+50,r.y+c+50));return a.extend(u),a.extend(e),a.extend(d),a},p.addBreadcrumbs=function(){var e="#b2b2b2",t=.8,i=new google.maps.Polyline({map:this.map,visible:!1,index:d-3,strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:e,fillOpacity:t,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},fixedRotation:!0,repeat:"50px",offset:"0"}]});return i},p.showTextLabels=function(){},p.showBreadcrumbs=function(e){var t,i=this.breadcrumbs,n=this.uid,r=i[e];e!==n?(t=i[n],t&&t.setVisible(!1),r&&r.setVisible(!0)):r&&r.setVisible(!r.getVisible()),this.uid=e,console.log("showBreadcrumbs",n,e)},p.addPoint=function(e){var t=this,i=google.maps,n=this.map,r=new i.Marker({map:n,animation:2,zIndex:d-4,icon:new i.MarkerImage(e.icon,new i.Size(48,68),new i.Point(0,0),new i.Point(12,34),new i.Size(24,34))}),a=i.event;return a.addListener(r,"mousedown",function(r){if(r&&r.stop(),t.removeInfobox(this))return!1;var s=t.infobox=new i.InfoBox({content:t.infoWindowTemplate.replace("{{title}}",e.title).replace("{{description}}",e.description),maxWidth:200,pixelOffset:new i.Size(-80,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1,leftBoundary:60,zIndex:610});s._marker=this,s.open(n,this),a.addListenerOnce(this,"mouseout",function(){s.close(),delete s._marker,s=t.infobox=null})}),r},p.removeInfobox=function(e){var t,i=this.infobox;return i&&(t=i._marker,i.close(),delete i._marker,i=this.infobox=null,t===e)?!0:void 0},p.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',p.getPointsBounds=function(){var e,t=this.locations,i=new google.maps.LatLngBounds;for(e in t)i.union(t[e]._bounds);return i},p.contains=function(){var e,t,i,n=this.map.getBounds(),r=google.maps,a=n.getSouthWest(),s=n.getNorthEast(),o=new r.LatLngBounds,l=this.geoMarkers,c=document.getElementById("identities")._ids||{};a=this.fromLatLngToContainerPixel(a),a=this.fromContainerPixelToLatLng(new r.Point(a.x+50,a.y)),o.extend(a),o.extend(s);for(e in l)t=l[e],i=t.getPosition(),this.containsOne(e,i,o,c);console.log("map zoom",this.map.getZoom())},p.containsOne=function(e,t,i,n,r){i||(i=this.map.getBounds()),n||(n=document.getElementById("identities")._ids||{}),i.contains(t)&&(r=n[e])?this.showTipline(e,r):this.hideTipline(e)},p.hideTiplines=function(){var e,t=this.tiplines;for(e in t)this.hideTipline(e)},p.updateTipline=function(e,t){var i=this.tiplines[e];i||(i=this.tiplines[e]=this.addTipline(e)),t&&this.containsOne(e,i._lastlatlng=t)},p.addTipline=function(e){var t=(this.breadcrumbs[e],document.createElementNS("http://www.w3.org/2000/svg","polyline"));return t.setAttribute("fill","none"),t.setAttribute("stroke","#b2b2b2"),t.setAttribute("stroke-width",1),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),t.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(t),t},p.showTipline=function(e,t){var i,n=this.tiplines[e];if(n){var r=[t[1],t[2]],a=[r[0]+13,r[1]],s=[r.join(","),a.join(",")].join(" "),i=this.fromLatLngToContainerPixel(n._lastlatlng);n.setAttribute("points",s+" "+i.x+","+i.y),n.setAttributeNS(null,"display","block")}},p.hideTipline=function(e){var t=this.tiplines[e];t&&t.setAttributeNS(null,"display","none")},p.updateGeoLocation=function(e,t){var i,n=this.geoLocation;if(!n){n=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:d-1,visible:!0,animation:2,icon:this.icons.arrowGrey}),n._status=0;var r=JSON.parse(window.localStorage.getItem("last-latlng"));r&&(n._status=1,i=this.toLatLng(1*r.lat+this.latOffset,1*r.lng+this.lngOffset),n.setPosition(i),this.map.setZoom(15),this.map.panTo(i),console.log("init position",r))}t&&(i=this.toLatLng(1*t.latitude+this.latOffset,1*t.longitude+this.lngOffset),n.setIcon(this.icons.arrowBlue),n.setPosition(i),2!==n._status&&(this.map.setZoom(15),this.map.panTo(i)),n._status=2),e&&(this.updated[e]=t||r),n._uid=e},p.switchGEOStyle=function(e){var t=this.geoLocation;t&&t.setIcon(this.icons["arrow"+(e?"Blue":"Grey")])},t});