<<<<<<< HEAD
define("routexmaps",function(t){"use strict";function e(e){e=this.options=e||{},this.svgLayer=this.options.svg,this.options.svg=null,this.routes={},this.places={},this.locations={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.boundsOffset={left:50,top:0},window._loadmaps_=function(e,n,i,r){return function s(){var o=google.maps,a=o.event;o.InfoBox=t("infobox");var u=e.icons;u.dotGrey=new o.MarkerImage("/static/img/map_dot_grey@2x.png",new o.Size(36,36),new o.Point(0,0),new o.Point(9,9),new o.Size(18,18)),u.dotRed=new o.MarkerImage("/static/img/map_dot_red@2x.png",new o.Size(36,36),new o.Point(0,0),new o.Point(9,9),new o.Size(18,18)),u.arrowBlue=new o.MarkerImage("/static/img/map_arrow_blue@2x.png",new o.Size(40,40),new o.Point(0,0),new o.Point(10,10),new o.Size(20,20)),u.arrowGrey=new o.MarkerImage("/static/img/map_arrow_g5@2x.png",new o.Size(40,40),new o.Point(0,0),new o.Point(10,10),new o.Size(20,20)),o.visualRefresh=!0,i.center=new o.LatLng(35.86166,104.195397),i.mapTypeId=o.MapTypeId.ROADMAP,i.disableDefaultUI=!0;var c=e.map=new o.Map(n,i),l=a.addListener(c,"tilesloaded",function(){a.addListener(c,"bounds_changed",function(){a.trigger(c,"zoom_changed")}),a.addListener(c,"zoom_changed",function(){e.contains()}),a.addListener(c,"drag",function(){}),a.addDomListener(n,"touchstart",function(){a.clearListeners(n,"touchmove"),a.addDomListenerOnce(n,"touchmove",function(){e.hideTiplines()})}),a.removeListener(l)}),h=e.overlay=new o.OverlayView;h.draw=function(){},h.setMap(c),r(c),s=null}}(this,e.mapDiv,e.mapOptions,e.callback)}var n=function(t,e,n,i){var r=6371,s=(n-t)*Math.PI/180,o=(i-e)*Math.PI/180,a=Math.sin(s/2)*Math.sin(s/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2),u=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),c=r*u;return c},i=function(t,e,n,i){var r=i-e,s=Math.sin(r)*Math.cos(n),o=Math.cos(t)*Math.sin(n)-Math.sin(t)*Math.cos(n)*Math.cos(r);return Math.atan2(s,o)},r=function(t,e,n,i){return n='<span class="unit">{{u}}</span>',t=Math.floor(t),i={text:"",status:0,distance:t},30>t?(i.status=4,i.text="抵达"):i.text=1e3>t?t+n.replace("{{u}}","米"):9e3>t?(t/1e3+"").slice(0,3)+n.replace("{{u}}","公里"):"9+"+n.replace("{{u}}","公里"),i},s=e.prototype;return s.load=function(t){var e=document.createElement("script");e.type="text/javascript",e.onload=e.onerror=e.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(e.readyState)&&(e=e.onload=e.onerror=e.onreadystatechange=null,t&&t())},e.async=!0,e.src=this.options.url,document.body.appendChild(e)},s.draw=function(t,e){if("geomarks"===t){var n,i,r=[],s=[];for(e=e.slice(0);n=e.shift();)i=n.type,"route"===i?r.push(n):"location"===i&&s.push(n);this.drawRoutes(r),this.drawPlaces(s)}else"breadcrumbs"===t&&this.drawIdentityPaths(e)},s.drawRoutes=function(t){var e,n,i,r=this.routes;for(n in r)e=r[n],e.setMap(null),e=null,delete r[n];for(;i=t.shift(););},s.drawPlaces=function(t){this.destinationPlace=null;var e,n,i,r=this.places;for(n in r)e=r[n],e.setMap(null),e=null,delete r[n];for(;i=t.shift();)this.addPlace(i)},s.addPlace=function(t){var e,n,i,r=t.id,s=this.toLatLng(t.latitude,t.longitude);if(e=this.places[r]=this.addPoint(t),e._data=t,e.setPosition(s),e.setVisible(!0),!this.destinationPlace)for(n=t.tags.slice(0);i=n.shift();)if("destination"===i){var o=this.geoLocation;(!o||o&&0==o._status)&&this.panToDestination(s),e.setZIndex(378),this.destinationPlace=e;break}},s.toLatLng=function(t,e){return new google.maps.LatLng(t,e)},s.drawIdentityPaths=function(t){var e,n,i,r,s,o,a,u,c=this.breadcrumbs,l=this.toLatLng,h=this.destinationPlace;for(e in t){for(i=t[e],n=c[e],s=i.slice(0),o=[],n||(n=c[e]=this.addBreadcrumbs());r=s.shift();)o.push(l(r.latitude,r.longitude));a=o[0],n.setPath(o),n._uid=e,n._data=i,u=this.drawGeoMarker(e,s[0],a),this.distanceMatrix(e,u,h)}},s.drawGeoMarker=function(t,e,n){if(this.myuid===t)return this.geoLocation;var i=this.geoMarkers,r=i[t];return r||(r=i[t]=this.addGeoMarker()),r.setPosition(n),r._data=e,r},s.addGeoMarker=function(){var t=new google.maps.Marker({map:this.map,animation:3,zIndex:333,icon:this.icons.dotGrey});return t},s.distanceMatrix=function(t,e,s){var o=$('#identities-overlay .identity[data-uid="'+t+'"]'),a=o.find(".detial"),u=a.find(".icon"),c=a.find(".distance");if(e&&s){var l=e.getPosition(),h=s.getPosition(),p=l.lat(),f=l.lng(),d=h.lat(),m=h.lng(),g=n(d,m,p,f),v=Math.round(180*i(d,m,p,f)/Math.PI),y=r(g);y.rotate=v,c.html(y.text),u.hasClass("icon-arrow-red")||u.hasClass("icon-arrow-grey")||u.attr("class","icon icon-arrow-grey"),u.css("-webkit-transform","rotate("+v+"deg)"),a.css("visibility","visible")}else e?a.css("visibility","visible"):a.css("visibility","hidden")},s.fitBoundsWithDestination=function(t){var e=this.destinationPlace,n=this.myuid===t,i=n?this.geoLocation:this.geoMarkers[t];if(i){var r=i.getPosition(),s=this.overlay.getProjection(),o=this.map;if(e){var a,u=e.getPosition(),c=s.fromLatLngToContainerPixel(u);n?a=this.calculateBoundsByCenter(r,[u]):(a=new google.maps.LatLngBounds,50>c.x&&(c=s.fromContainerPixelToLatLng(new google.maps.Point(c.x-50,c.y)),a.extend(c)),a.extend(r),a.extend(u)),o.fitBounds(a)}else o.getBounds().contains(r)||(7>o.getZoom()&&o.setZoom(15),o.panTo(r))}},s.panToDestination=function(t){var e=this.map;7>e.getZoom()&&e.setZoom(15),e.panTo(t||this.destinationPlace.getPosition())},s.calculateBoundsByCenter=function(t,e){for(var n,i,r,s=new google.maps.LatLngBounds,o=this.overlay.getProjection(),a=[];i=e.shift();)n=o.fromLatLngToContainerPixel(i),a.push(n);for(var u,c,r=o.fromLatLngToContainerPixel(t),l=0;c=a.shift();)u=Math.sqrt(Math.pow(c.x-r.x,2)+Math.pow(c.y-r.y,2)),u>l&&(l=u);var h=o.fromContainerPixelToLatLng(new google.maps.Point(r.x-l-50,r.y-l-50)),p=o.fromContainerPixelToLatLng(new google.maps.Point(r.x+l+50,r.y+l+50));return s.extend(h),s.extend(t),s.extend(p),s},s.addBreadcrumbs=function(){var t="#FF325B",e=.5,n=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:t,fillOpacity:e,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return n},s.distancematrix=function(t,e){var i=e?this.geoLocation:this.geoMarkers[t],s=this.destinationPlace,o=$('#identities-overlay .identity[data-uid="'+t+'"]'),a=o.find(".detial"),u=(a.find(".icon"),a.find(".distance"));if(i&&s){a.css("visibility","visible");var c=i.getPosition(),l=s.getPosition(),h=r(n(c,l));4===h.status?u.text(h.text):u.html(h.text)}else i?a.css("visibility","visible"):a.css("visibility","hidden")},s.hideBreadcrumbs=function(t){var e=this.breadcrumbs[t];e&&e.setVisible(!1)},s.showBreadcrumbs=function(t){var e,n=this.breadcrumbs,i=this.uid,r=n[t];t!==i?(e=n[i],e&&e.setVisible(!1),r&&r.setVisible(!0)):r&&r.setVisible(!r.getVisible()),this.uid=t},s.showGeoMarker=function(){},s.updatePolyline=function(t){var e,n,i,r,s=this.routes,o=[],a=t.created_by,u=t.positions.slice(0);for(n=s[a],n||(n=s[a]=this.addPolyline(t)),i=new google.maps.LatLngBounds;e=u.shift();)r=new google.maps.LatLng(e.latitude,e.longitude),i.extend(r),o.push(r);n._data=t,n._bounds=i,n.setPath(o),this.updateTipline(a,r)},s.addPolyline=function(t){var e=t.color.split(","),n="#"+(+e[0]).toString(16)+(+e[1]).toString(16)+(+e[2]).toString(16),i=e[3],r=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:n,fillOpacity:i,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return r},s.updatePoint=function(t){var e,n,i,r,s=this.locations,o=t.id;for(e=s[o],e||(e=s[o]=this.addPoint(t)),e.setPosition(n),e.setVisible(!0),i=t.tags.slice(0);r=i.shift();)if("destination"===r){e._type="destination",this.destinationLocation=e;break}e._data=t},s.addLastPoint=function(){var t=new google.maps.Marker({map:this.map,animation:3,zIndex:366,icon:this.icons.dotGrey});return t},s.addPoint=function(t){var e=this,n=google.maps,i=new n.Marker({map:this.map,animation:2,visible:!1,zIndex:233,icon:new google.maps.MarkerImage(t.icon,new google.maps.Size(48,68),new google.maps.Point(0,0),new google.maps.Point(12,34),new google.maps.Size(24,34))}),r=n.event;return r.addListener(i,"mousedown",function(i){if(i&&i.stop(),e.removeInfobox(this))return!1;var s=e.infobox=new n.InfoBox({content:e.infoWindowTemplate.replace("{{title}}",t.title).replace("{{description}}",t.description),maxWidth:200,pixelOffset:new google.maps.Size(-80,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1,leftBoundary:60,zIndex:610});s.open(e.map,this),s._marker=this,r.addListenerOnce(this,"mouseout",function(){s.close(),s=e.infobox=null})}),i},s.removeInfobox=function(t){var e,n=this.infobox;return n&&(e=n._marker,n.close(),n=this.infobox=null,e===t)?!0:void 0},s.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',s.getPointsBounds=function(){var t,e=this.locations,n=new google.maps.LatLngBounds;for(t in e)n.union(e[t]._bounds);return n},s.contains=function(){var t,e,n,i=this.map.getBounds(),r=this.overlay.getProjection(),s=i.getSouthWest(),o=i.getNorthEast(),a=new google.maps.LatLngBounds,u=this.geoMarkers,c=document.getElementById("identities")._ids||{};s=r.fromLatLngToContainerPixel(s),s=r.fromContainerPixelToLatLng(new google.maps.Point(s.x+50,s.y)),a.extend(s),a.extend(o);for(t in u)e=u[t],n=e.getPosition(),this.containsOne(t,n,a,c)},s.containsOne=function(t,e,n,i,r){n||(n=this.map.getBounds()),i||(i=document.getElementById("identities")._ids||{}),n.contains(e)&&(r=i[t])?this.showTipline(t,r):this.hideTipline(t)},s.hideTiplines=function(){var t,e=this.tiplines;for(t in e)this.hideTipline(t)},s.updateTipline=function(t,e){var n=this.tiplines[t];n||(n=this.tiplines[t]=this.addTipline(t)),e&&(n._lastlatlng=e,this.containsOne(t,e))},s.addTipline=function(t){var e=(this.breadcrumbs[t],document.createElementNS("http://www.w3.org/2000/svg","polyline"));return e.setAttribute("fill","none"),e.setAttribute("stroke","#FF7E98"),e.setAttribute("stroke-width",1),e.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),e.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(e),e},s.showTipline=function(t,e){var n,i=this.tiplines[t];if(i){var r=[e[1],e[2]],s=[r[0]+13,r[1]],o=[r.join(","),s.join(",")].join(" ");n=this.overlay.getProjection().fromLatLngToContainerPixel(i._lastlatlng),i.setAttribute("points",o+" "+n.x+","+n.y),i.setAttributeNS(null,"display","block")}},s.hideTipline=function(t){var e=this.tiplines[t];e&&e.setAttributeNS(null,"display","none")},s.updateGeoLocation=function(t,e){var n,i=this.geoLocation;if(!i){i=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:377,visible:!0,animation:2,icon:this.icons.arrowGrey}),i._status=0;var r=JSON.parse(window.localStorage.getItem("last-latlng"));r&&(i._status=1,n=new google.maps.LatLng(r.lat,r.lng),i.setPosition(n),this.map.setZoom(15),this.map.panTo(n))}e&&(i.setIcon(this.icons.arrowBlue),i.setPosition(new google.maps.LatLng(e.latitude,e.longitude)),i._status=2),i._uid=t},s.switchGEOStyle=function(t){var e=this.geoLocation;e&&e.setIcon(this.icons["arrow"+(t?"Blue":"Grey")])},e});
=======
define("routexmaps",function(e){"use strict";function t(t){t=this.options=t||{},this.svgLayer=this.options.svg,this.options.svg=null,this.routes={},this.places={},this.locations={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.boundsOffset={left:50,top:0},window._loadmaps_=function(t,i,n,r){return function a(){var s=google.maps,o=s.event;s.InfoBox=e("infobox");var l=t.icons;l.dotGrey=new s.MarkerImage("/static/img/map_dot_grey@2x.png",new s.Size(36,36),new s.Point(0,0),new s.Point(9,9),new s.Size(18,18)),l.dotRed=new s.MarkerImage("/static/img/map_dot_red@2x.png",new s.Size(36,36),new s.Point(0,0),new s.Point(9,9),new s.Size(18,18)),l.arrowBlue=new s.MarkerImage("/static/img/map_arrow_blue@2x.png",new s.Size(40,40),new s.Point(0,0),new s.Point(10,10),new s.Size(20,20)),l.arrowGrey=new s.MarkerImage("/static/img/map_arrow_g5@2x.png",new s.Size(40,40),new s.Point(0,0),new s.Point(10,10),new s.Size(20,20)),s.visualRefresh=!0,n.center=new s.LatLng(35.86166,104.195397),n.mapTypeId=s.MapTypeId.ROADMAP,n.disableDefaultUI=!0;var c=t.map=new s.Map(i,n),u=o.addListener(c,"tilesloaded",function(){o.addListener(c,"bounds_changed",function(){console.log("bounds_end",t.uid),o.trigger(c,"zoom_changed")}),o.addListener(c,"zoom_changed",function(){console.log("zoom_end"),t.contains()}),o.addListener(c,"drag",function(){console.log("drag")}),o.addDomListener(i,"touchstart",function(){console.log("touchstart",t.uid),o.clearListeners(i,"touchmove"),o.addDomListenerOnce(i,"touchmove",function(){console.log("touchmove"),t.hideTiplines()})}),o.removeListener(u)}),d=t.overlay=new s.OverlayView;d.draw=function(){},d.setMap(c),r(c),a=null}}(this,t.mapDiv,t.mapOptions,t.callback)}var i=function(e,t,i,n){var r=6371,a=(i-e)*Math.PI/180,s=(n-t)*Math.PI/180,o=Math.sin(a/2)*Math.sin(a/2)+Math.cos(e*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2),l=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),c=r*l;return c},n=function(e,t,i,n){var r=n-t,a=Math.sin(r)*Math.cos(i),s=Math.cos(e)*Math.sin(i)-Math.sin(e)*Math.cos(i)*Math.cos(r);return Math.atan2(a,s)},r=function(e,t,i,n){return i='<span class="unit">{{u}}</span>',e=Math.floor(e),n={text:"",status:0,distance:e},30>e?(n.status=4,n.text="抵达"):n.text=1e3>e?e+i.replace("{{u}}","米"):9e3>e?(e/1e3+"").slice(0,3)+i.replace("{{u}}","公里"):"9+"+i.replace("{{u}}","公里"),n},a=t.prototype;a.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.onload=t.onerror=t.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(t.readyState)&&(t=t.onload=t.onerror=t.onreadystatechange=null,e&&e())},t.async=!0,t.src=this.options.url,document.body.appendChild(t)},a.draw=function(e,t){if(console.log("type",e,t),"geomarks"===e){var i,n,r=[],a=[];for(t=t.slice(0);i=t.shift();)n=i.type,"route"===n?r.push(i):"location"===n&&a.push(i);this.drawRoutes(r),this.drawPlaces(a)}else"breadcrumbs"===e&&this.drawIdentityPaths(t)},a.drawRoutes=function(e){var t,i,n,r=this.routes;for(i in r)t=r[i],t.setMap(null),t=null,delete r[i];for(;n=e.shift(););},a.drawPlaces=function(e){console.log("draw places",e.length,e),this.destinationPlace=null;var t,i,n,r=this.places;for(i in r)t=r[i],t.setMap(null),t=null,delete r[i];for(;n=e.shift();)this.addPlace(n)},a.addPlace=function(e){console.log("add a place",e);var t,i,n,r=e.id,a=this.toLatLng(e.latitude,e.longitude);if(t=this.places[r]=this.addPoint(e),t._data=e,t.setPosition(a),t.setVisible(!0),!this.destinationPlace)for(i=e.tags.slice(0);n=i.shift();)if("destination"===n){var s=this.geoLocation;(!s||s&&0==s._status)&&this.panToDestination(a),t.setZIndex(378),this.destinationPlace=t;break}},a.toLatLng=function(e,t){return new google.maps.LatLng(e,t)},a.drawIdentityPaths=function(e){var t,i,n,r,a,s,o,l,c=this.breadcrumbs,u=this.toLatLng,d=this.destinationPlace;for(t in e){for(n=e[t],i=c[t],a=n.slice(0),s=[],i||(i=c[t]=this.addBreadcrumbs());r=a.shift();)s.push(u(r.latitude,r.longitude));o=s[0],i.setPath(s),i._uid=t,i._data=n,l=this.drawGeoMarker(t,a[0],o),this.distanceMatrix(t,l,d)}},a.drawGeoMarker=function(e,t,i){if(this.myuid===e)return this.geoLocation;var n=this.geoMarkers,r=n[e];return r||(r=n[e]=this.addGeoMarker()),r.setPosition(i),r._data=t,r},a.addGeoMarker=function(){var e=new google.maps.Marker({map:this.map,animation:3,zIndex:333,icon:this.icons.dotGrey});return e},a.distanceMatrix=function(e,t,a){console.log(e,"destination",a,t);var s=$('#identities-overlay .identity[data-uid="'+e+'"]'),o=s.find(".detial"),l=o.find(".icon"),c=o.find(".distance");if(t&&a){var u=t.getPosition(),d=a.getPosition(),h=u.lat(),p=u.lng(),f=d.lat(),m=d.lng(),g=i(f,m,h,p),v=Math.round(180*n(f,m,h,p)/Math.PI),y=r(g);y.rotate=v,console.dir(y),c.html(y.text),l.hasClass("icon-arrow-red")||l.hasClass("icon-arrow-grey")||l.attr("class","icon icon-arrow-grey"),l.css("-webkit-transform","rotate("+v+"deg)"),o.css("visibility","visible")}else t?o.css("visibility","visible"):o.css("visibility","hidden")},a.fitBoundsWithDestination=function(e){console.log("fit bounds with destination");var t=this.destinationPlace,i=this.myuid===e,n=i?this.geoLocation:this.geoMarkers[e];if(n){var r=n.getPosition(),a=this.overlay.getProjection(),s=this.map;if(t){var o,l=t.getPosition(),c=a.fromLatLngToContainerPixel(l);i?o=this.calculateBoundsByCenter(r,[l]):(o=new google.maps.LatLngBounds,50>c.x&&(c=a.fromContainerPixelToLatLng(new google.maps.Point(c.x-50,c.y)),o.extend(c)),o.extend(r),o.extend(l)),s.fitBounds(o)}else s.getBounds().contains(r)||(7>s.getZoom()&&s.setZoom(15),s.panTo(r))}},a.panToDestination=function(e){var t=this.map;7>t.getZoom()&&t.setZoom(15),t.panTo(e||this.destinationPlace.getPosition())},a.calculateBoundsByCenter=function(e,t){for(var i,n,r,a=new google.maps.LatLngBounds,s=this.overlay.getProjection(),o=[];n=t.shift();)i=s.fromLatLngToContainerPixel(n),o.push(i);for(var l,c,r=s.fromLatLngToContainerPixel(e),u=0;c=o.shift();)l=Math.sqrt(Math.pow(c.x-r.x,2)+Math.pow(c.y-r.y,2)),l>u&&(u=l);var d=s.fromContainerPixelToLatLng(new google.maps.Point(r.x-u-50,r.y-u-50)),h=s.fromContainerPixelToLatLng(new google.maps.Point(r.x+u+50,r.y+u+50));return a.extend(d),a.extend(e),a.extend(h),a},a.addBreadcrumbs=function(){var e="#FF325B",t=.5,i=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:e,fillOpacity:t,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return i};var s=function(e,t){var i=e.lat(),n=e.lng(),r=t.lat(),a=t.lng(),s=a-n,o=Math.sin(s)*Math.cos(r),l=Math.cos(i)*Math.sin(r)-Math.sin(i)*Math.cos(r)*Math.cos(s);return Math.atan2(o,l)};return a.distancematrix=function(e,t){var n=t?this.geoLocation:this.geoMarkers[e],a=this.destinationPlace,o=$('#identities-overlay .identity[data-uid="'+e+'"]'),l=o.find(".detial"),c=(l.find(".icon"),l.find(".distance"));if(n&&a){l.css("visibility","visible");var u=n.getPosition(),d=a.getPosition(),h=r(i(u,d));console.log("DistanceMatrixService",h.text,h.status,!!n,!!a,s(u,d)),4===h.status?c.text(h.text):c.html(h.text)}else n?l.css("visibility","visible"):l.css("visibility","hidden")},a.hideBreadcrumbs=function(e){var t=this.breadcrumbs[e];t&&t.setVisible(!1)},a.showBreadcrumbs=function(e){var t,i=this.breadcrumbs,n=this.uid,r=i[e];e!==n?(t=i[n],t&&t.setVisible(!1),r&&r.setVisible(!0)):r&&r.setVisible(!r.getVisible()),this.uid=e,console.log("showBreadcrumbs",n,e)},a.showGeoMarker=function(){},a.updatePolyline=function(e){var t,i,n,r,a=this.routes,s=[],o=e.created_by,l=e.positions.slice(0);for(i=a[o],i||(i=a[o]=this.addPolyline(e)),n=new google.maps.LatLngBounds;t=l.shift();)r=new google.maps.LatLng(t.latitude,t.longitude),n.extend(r),s.push(r);i._data=e,i._bounds=n,i.setPath(s),this.updateTipline(o,r)},a.addPolyline=function(e){var t=e.color.split(","),i="#"+(+t[0]).toString(16)+(+t[1]).toString(16)+(+t[2]).toString(16),n=t[3],r=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:i,fillOpacity:n,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return r},a.updatePoint=function(e){var t,i,n,r,a=this.locations,s=e.id;for(t=a[s],t||(t=a[s]=this.addPoint(e)),t.setPosition(i),t.setVisible(!0),n=e.tags.slice(0);r=n.shift();)if("destination"===r){t._type="destination",this.destinationLocation=t;break}console.log(s,i.lat(),i.lng(),t),t._data=e},a.addLastPoint=function(){var e=new google.maps.Marker({map:this.map,animation:3,zIndex:366,icon:this.icons.dotGrey});return e},a.addPoint=function(e){var t=this,i=google.maps,n=new i.Marker({map:this.map,animation:2,visible:!1,zIndex:233,icon:new google.maps.MarkerImage(e.icon,new google.maps.Size(48,68),new google.maps.Point(0,0),new google.maps.Point(12,34),new google.maps.Size(24,34))}),r=i.event;return r.addListener(n,"mousedown",function(n){if(console.log("marker mousedown",n),n&&n.stop(),t.removeInfobox(this))return!1;var a=t.infobox=new i.InfoBox({content:t.infoWindowTemplate.replace("{{title}}",e.title).replace("{{description}}",e.description),maxWidth:200,pixelOffset:new google.maps.Size(-80,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1,leftBoundary:60,zIndex:610});a.open(t.map,this),a._marker=this,r.addListenerOnce(this,"mouseout",function(e){console.log("mouseout",e),a.close(),a=t.infobox=null})}),n},a.removeInfobox=function(e){var t,i=this.infobox;return i&&(t=i._marker,i.close(),i=this.infobox=null,t===e)?!0:void 0},a.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',a.getPointsBounds=function(){var e,t=this.locations,i=new google.maps.LatLngBounds;for(e in t)i.union(t[e]._bounds);return i},a.contains=function(){var e,t,i,n=this.map.getBounds(),r=this.overlay.getProjection(),a=n.getSouthWest(),s=n.getNorthEast(),o=new google.maps.LatLngBounds,l=this.geoMarkers,c=document.getElementById("identities")._ids||{};console.log("contains",c),a=r.fromLatLngToContainerPixel(a),a=r.fromContainerPixelToLatLng(new google.maps.Point(a.x+50,a.y)),o.extend(a),o.extend(s);for(e in l)t=l[e],i=t.getPosition(),this.containsOne(e,i,o,c)},a.containsOne=function(e,t,i,n,r){i||(i=this.map.getBounds()),n||(n=document.getElementById("identities")._ids||{}),i.contains(t)&&(r=n[e])?this.showTipline(e,r):this.hideTipline(e)},a.hideTiplines=function(){var e,t=this.tiplines;for(e in t)this.hideTipline(e)},a.updateTipline=function(e,t){var i=this.tiplines[e];i||(i=this.tiplines[e]=this.addTipline(e)),t&&(i._lastlatlng=t,this.containsOne(e,t))},a.addTipline=function(e){console.log("tipline",e);var t=(this.breadcrumbs[e],document.createElementNS("http://www.w3.org/2000/svg","polyline"));return t.setAttribute("fill","none"),t.setAttribute("stroke","#FF7E98"),t.setAttribute("stroke-width",1),t.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),t.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(t),t},a.showTipline=function(e,t){var i,n=this.tiplines[e];if(n){var r=[t[1],t[2]],a=[r[0]+13,r[1]],s=[r.join(","),a.join(",")].join(" ");i=this.overlay.getProjection().fromLatLngToContainerPixel(n._lastlatlng),console.log("tipline",e),n.setAttribute("points",s+" "+i.x+","+i.y),n.setAttributeNS(null,"display","block")}},a.hideTipline=function(e){var t=this.tiplines[e];t&&t.setAttributeNS(null,"display","none")},a.updateGeoLocation=function(e,t){var i,n=this.geoLocation;if(!n){n=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:377,visible:!0,animation:2,icon:this.icons.arrowGrey}),n._status=0;var r=JSON.parse(window.localStorage.getItem("last-latlng"));r&&(n._status=1,i=new google.maps.LatLng(r.lat,r.lng),n.setPosition(i),this.map.setZoom(15),this.map.panTo(i),console.log("init position",r))}t&&(n.setIcon(this.icons.arrowBlue),n.setPosition(new google.maps.LatLng(t.latitude,t.longitude)),n._status=2),n._uid=e},a.switchGEOStyle=function(e){var t=this.geoLocation;t&&t.setIcon(this.icons["arrow"+(e?"Blue":"Grey")])},t});
>>>>>>> b0044b2... tweaks routex
