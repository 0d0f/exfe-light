define("routexmaps",function(e){"use strict";function t(t){t=this.options=t||{},this.canvas=this.options.canvas;var r=$(window).width(),a=$(window).height();this.canvas.width=2*r,this.canvas.height=2*a,this.canvas.style.width=r+"px",this.canvas.style.height=a+"px",this.ctx=this.canvas.getContext("2d"),this.DRAW_STATUS=!0,delete this.options.cavnas,this.latOffset=0,this.lngOffset=0,this.routes={},this.places={},this.tiplines={},this.lines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.updated={},this._breadcrumbs={},this.boundsOffset={left:50,top:0},this.labels=[],window._loadmaps_=function(t,r,a,s){return function o(){var l=google.maps,c=l.event;l.InfoBox=e("infobox"),l.TextLabel=e("maplabel");var u=t.icons;u.dotGrey=new l.MarkerImage(i+"/static/img/map_dot_grey@2x.png",new l.Size(36,36),new l.Point(0,0),new l.Point(9,9),new l.Size(18,18)),u.dotRed=new l.MarkerImage(i+"/static/img/map_dot_red@2x.png",new l.Size(36,36),new l.Point(0,0),new l.Point(9,9),new l.Size(18,18)),u.arrowBlue=new l.MarkerImage(i+"/static/img/map_arrow_22blue@2x.png",new l.Size(44,44),new l.Point(0,0),new l.Point(11,11),new l.Size(22,22)),u.arrowGrey=new l.MarkerImage(i+"/static/img/map_arrow_22g5@2x.png",new l.Size(44,44),new l.Point(0,0),new l.Point(11,11),new l.Size(22,22)),u.placeMarker=new l.MarkerImage(n+"/icons/mapmark",new l.Size(48,68),new l.Point(0,0),new l.Point(12,34),new l.Size(24,34)),u.xplaceMarker=new l.MarkerImage(i+"/static/img/map_mark_diamond_blue@2x.png",new l.Size(48,68),new l.Point(0,0),new l.Point(12,34),new l.Size(24,34)),u.destinationMarker=new l.MarkerImage(i+"/static/img/map_mark_ring_blue@2x.png",new l.Size(48,68),new l.Point(0,0),new l.Point(12,34),new l.Size(24,34)),l.visualRefresh=!0,a.center=t.toLatLng(35.86166,104.195397),a.mapTypeId=l.MapTypeId.ROADMAP,a.disableDefaultUI=!0,a.minZoom=1;var d=t.map=new l.Map(r,a),h=t.overlay=new l.OverlayView;h.draw=function(){},h.setMap(d);var p=c.addListener(d,"tilesloaded",function(){c.addListener(d,"bounds_changed",function(){c.trigger(d,"zoom_changed")}),c.addListener(d,"zoom_changed",function(){t.contains(),t.DRAW_STATUS=!0}),c.addListener(d,"mousedown",function(e){e.stop(),t.hideMyPanel(),t.editPlace()});var e,i;$(r).on("touchstart.maps",function(n){t.hideIdentityPanel();var r=n.touches[0];e=r.pageX,i=r.pageY}).on("tap.maps",function(n){t.infobox||(n.stopPropagation(),t.showNearBy({x:e,y:i}))}),c.addDomListener(r,"touchstart",function(){t.DRAW_STATUS=!1,c.clearListeners(r,"touchmove"),c.clearListeners(r,"touchend"),c.addDomListenerOnce(r,"touchmove",function(){t.clearLines()}),c.addDomListenerOnce(r,"touchend",function(){t.DRAW_STATUS=!0})}),c.removeListener(p)});s(d),o=null}}(this,t.mapDiv,t.mapOptions,t.callback)}var i=window._ENV_.site_url,n=window._ENV_.apiv3_url,r=6378137,a=function(e,t,i,n){var a=r,s=(i-e)*Math.PI/180,o=(n-t)*Math.PI/180,l=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2),c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),u=a*c;return u},s=function(e){return e*Math.PI/180},o=function(e){return 180*e/Math.PI},l=function(e,t,i,n){e=s(e),t=s(t),i=s(i),n=s(n);var r=n-t,a=Math.sin(r)*Math.cos(i),l=Math.cos(e)*Math.sin(i)-Math.sin(e)*Math.cos(i)*Math.cos(r),c=Math.atan2(a,l);return 0>c&&(c+=2*Math.PI),o(c)},c=function(e,t,i,n,r){return n='<span class="unit">{{u}}</span>',e=Math.floor(e),r={text:"",status:0,distance:e},30>e&&!t?(r.status=4,r.text="抵达"):r.text=1e3>e?e+n.replace("{{u}}","米"):9e3>e?(e/1e3+"").slice(0,3)+n.replace("{{u}}","公里"):"9+"+n.replace("{{u}}","公里"),r},u=function(e){return(1*e).toString(16)},d=function(e){return e+="",e+(e.length>1?"":"0")},h=610,p="route",f="location",m="xplace",g="destination",v="breadcrumbs",y=[0,1,3,5,10,15],_=t.prototype;_.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.onload=t.onerror=t.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(t.readyState)&&(t=t.onload=t.onerror=t.onreadystatechange=null,e&&e())},t.src=this.options.url,document.body.appendChild(t)},_.fromContainerPixelToLatLng=function(e){return this.overlay.getProjection().fromContainerPixelToLatLng(e)},_.fromLatLngToContainerPixel=function(e){return this.overlay.getProjection().fromLatLngToContainerPixel(e)},_.showPlacePanel=function(e){var t=this.places[e];t&&google.maps.event.trigger(t,"mousedown"),this.hideNearBy()},_.showIdentityPanel=function(e){this.hideNearBy();var t,i,n=this.geoMarkers[e],r=this.geoLocation,s=this.destinationPlace,o=$('#identities-overlay .identity[data-uid="'+e+'"]').data("identity"),u=$("#other-info"),d=Math.round(Date.now()/1e3);if(n){if(t=n.getPosition(),i=Math.floor((d-n.data.positions[0].t)/60),u.find(".name").text(o.name),i>1?(u.find(".update").removeClass("hide").find(".time").html(60>i?i+"分钟":Math.floor(i/60)+"小时"),u.find(".please-update").attr("data-external-username",o.external_username).attr("data-provider",o.provider).removeClass("hide")):(u.find(".update").addClass("hide"),u.find(".please-update").addClass("hide")),s){var h=s.getPosition(),p=a(t.lat(),t.lng(),h.lat(),h.lng()),f=l(t.lat(),t.lng(),h.lat(),h.lng()),m=c(p,!0);u.find(".dest").removeClass("hide").find(".m").html(m.text+'<i class="icon icon-arrow-'+(i>1?"grey":"red")+'" style="-webkit-transform: rotate('+f+'deg)"></i>')}else u.find(".dest").addClass("hide");if(r){var h=r.getPosition(),p=a(t.lat(),t.lng(),h.lat(),h.lng()),f=l(t.lat(),t.lng(),h.lat(),h.lng()),m=c(p,!0);u.find(".dest-me").removeClass("hide").find(".m").html(m.text+'<i class="icon icon-arrow-'+(i>1?"grey":"red")+'" style="-webkit-transform: rotate('+f+'deg)"></i>')}else u.find(".dest-me").removeClass("hide");u.removeClass("hide");var g=$(window).width(),v=$(window).height(),y=u.height(),_=u.width(),b=this.fromLatLngToContainerPixel(t),x=b.x-_/2,w=b.y-y/2;0>x&&(x=50),x+_>g&&(x=g-_),0>w&&(w=20),w+y>v&&(w=v-y),u.css({left:x,top:w})}},_.setOffset=function(e){this.latOffset=1*e.earth_to_mars_latitude,this.lngOffset=1*e.earth_to_mars_longitude},_.hideMyPanel=function(){$("#my-info").addClass("hide")},_.hideIdentityPanel=function(){$("#other-info").addClass("hide")};var b='<div id="nearby" class="info-windown"></div>',x='<div class="place-marker"><h4 class="title"></h4><div class="description"></div></div>',w='<div class="geo-marker clearfix"><img width="30" height="30" src="" alt="" /><div class="detial"><div class="name"></div><div class="status"></div></div></div>';return _.hideNearBy=function(){$("#nearby").remove()},_.distance48px=function(e,t){var i=this.fromLatLngToContainerPixel(e),n=Math.sqrt(Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2));return 48>=n},_.showNearBy=function(e){if($("#nearby").length)return this.hideNearBy(),void 0;if(e){var t,i,n,r,s=e,o=!1,l=(this.myUserId,this.places),u=this.geoMarkers,d=this.geoLocation,h=d&&d.getPosition(),p=this.destinationPlace,f=p&&p.getPosition(),m=Date.now()/1e3,g=0,v=0;console.log("-----------------------",h,f);var y=$(b);for(var _ in l)if(r=l[_],t=r.getPosition(),this.distance48px(t,s)){o||(o=!0),g++,i=_;var k=$(x);k.attr("data-id",r.data.id),k.find(".title").text(r.data.title),k.find(".description").text(r.data.description),y.append($("<div></div>").append(k))}for(var _ in u)if(r=u[_],t=r.getPosition(),this.distance48px(t,s)){o||(o=!0),v++,n=_,r.data.id.split(".")[1];var C=$('#identities-overlay .identity[data-uid="'+_+'"]').data("identity"),k=$(w);k.find("img").attr("src",C.avatar_filename),k.find(".name").text(C.name),k.attr("data-uid",_);var E=r.data.positions[0],T=Math.floor((m-E.t)/60),S="",M="",A="";if(h){var P=c(a(t.lat(),t.lng(),h.lat(),h.lng()),!0);S=P.text}if(f){var P=c(a(t.lat(),t.lng(),f.lat(),f.lng()),!0);M=P.text}1>=T?(M&&(A+="<span>距离目的地"+M+"</span>"),S&&(A+="<span>与您相距"+S+"</span>")):(A+=60>T?"<span>"+T+"分钟前所处位置</span>":"<span>"+Math.floor(T/60)+"小时前所处位置</span>",M&&(A+="<span>距离目的地"+M+"</span>")),A&&k.find(".status").html(A),y.append($("<div></div>").append(k))}if(o)if(0===g&&1===v)this.showIdentityPanel(n);else{var I=$(window).width(),N=$(window).height();y.css({left:(I-200+50)/2,top:(N-132)/2}),$("#routex").append(y)}}},_.draw=function(e){var t,i,n=e.type,r=e.action,a=r&&"delete"===r,s=e.tags,o=s&&e.tags.slice(0);switch(console.log(n,r,a,o,e),n){case f:var l=0;if(s)for(;t=o.shift();)t===m?l^=1:t===g&&(l^=2,i=t);a?this.removePlace(e,i===g):this.drawPlace(e,l);break;case p:var c;if(s)for(;t=o.shift();)if(t===v){c=!0;break}c?this.drawGeoMarker(e):a?this.removeRoute(e):this.drawRoute(e)}},_.clearup=function(){var e,t=this.places;for(e in t)t[e].setMap(null),t[e]=null,delete t[e];var i=this.breadcrumbs;for(e in i)i[e].setMap(null),i[e]=null,delete i[e];var n=this.geoMarkers;for(e in n)n[e].setMap(null),n[e]=null,delete n[e];var r=this.routes;for(e in r)r[e].setMap(null),r[e]=null,delete r[e];this.destinationPlace=null,this.removeTextLabels();var a=this.lines;for(e in a)delete a[e];this.clearLines(),this.uid=null},_.removePlace=function(e,t){var i=this.places,n=e.id,r=i[n];r&&(r.setMap(null),r=null,delete i[n],t&&(this.destinationPlace=null))},_.drawRoute=function(e){var t,i,n,r,a=this.routes,s=e.id,o=e.positions.slice(0),l=[];if(!a.hasOwnProperty(s)||(t=a[s],i=t.data,i.updated_at!==e.updated_at)){for(t||(t=a[s]=this.addPolyline(e));n=o.shift();)r=n.gps,l.push(this.toLatLng(r[0],r[1]));t.setPath(l),t.data=e}},_.removeRoute=function(e){var t=this.routes,i=e.id,n=t[i];n&&(n.setMap(null),n=null,delete t[i])},_.addPolyline=function(e){var t=e.color&&e.color.split(",")||[],i="#"+(t.length?d(u(t[0]))+d(u(t[1]))+d(u(t[2])):"007BFF"),n=t[3]||1,r=new google.maps.Polyline({map:this.map,index:h-5,geodesic:!0,strokeColor:i,strokeWeight:4,strokeOpacity:n});return r},_.drawPlace=function(e,t){var i,n,r=this.places,a=e.id;if(r.hasOwnProperty(a)&&(i=r[a]),i||(i=r[a]=this.addPoint(e)),n=this.toLatLng(e.lat,e.lng),i.setPosition(n),i.data=e,1===t||3===t)return i.setIcon(this.icons.xplaceMarker),i.setZIndex(h-1),void 0;if(2===t||3===t){var s=this.geoLocation,o=h,l=this.icons.destinationMarker;(!s||s&&0==s._status)&&this.panToDestination(n);var c=this.destinationPlace;if(c&&c!==i){var u=c.data;e.updated_at>u.updated_at?(e.id!=u.id&&(c.setIcon(this.icons.placeMarker),c.setZIndex(o-5)),this.destinationPlace=i):(o=h-5,l=this.icons.placeMarker)}else this.destinationPlace=i;return 3!==t&&(i.setIcon(l),i.setZIndex(o)),void 0}var d=google.maps;i.setIcon(new d.MarkerImage(e.icon,new d.Size(48,68),new d.Point(0,0),new d.Point(12,34),new d.Size(24,34)))},_.monit=function(){var e,t,i,n,r,a,s,o,l=this.updated,c=this.breadcrumbs,u=this.icons,d=this.geoMarkers,h=this.lines,p=this.destinationPlace,f=this.geoLocation,m=this.myUserId,g=this.uid,v=Math.round(Date.now()/1e3);for(e in l)if(l.hasOwnProperty(e))if(i=l[e],t=m==e,o=Math.floor((v-i.t)/60),n=t?f:d[e],n||(n=this.drawGeoMarker(this._breadcrumbs[e])),this.distanceMatrix(e,n,p,o),r=c[e],s=h[e],a=$('#identities-overlay .identity[data-uid="'+e+'"]').find(".icon"),g&&g==e&&this._breadcrumbs[e]&&this.showTextLabels(e,this._breadcrumbs[e].positions.slice(0),1>=o),1>=o){if(a.length&&(a.parent().removeClass("unknown"),a.hasClass("icon-arrow-grey")||a.hasClass("icon-arrow-red")?a.attr("class","icon icon-arrow-red"):a.attr("class","icon icon-dot-red")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#ff325b",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},repeat:"16px",offset:"0"}]}),t)continue;s&&(s[3]="#ff7e98"),n&&n.setIcon(u.dotRed)}else{if(a.length&&(a.parent().removeClass("unknown"),a.hasClass("icon-arrow-grey")||a.hasClass("icon-arrow-red")?a.attr("class","icon icon-arrow-grey"):a.attr("class","icon icon-dot-grey")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#7f7f7f",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},repeat:"16px",offset:"0"}]}),t)continue;s&&(s[3]="#b2b2b2"),n&&n.setIcon(u.dotGrey)}this.updateLines()},_.toLatLng=function(e,t){return new google.maps.LatLng(1*e,1*t)},_.freshExfee=function(){this.controller&&this.controller.getExfee()},_.drawGeoMarker=function(e){var t,i,n,r,a=this.geoMarkers,s=e.id.split(".")[1],o=e.action;if("save_to_history"===o&&this.updatePositions(e),this.updated[s]=e.positions[0],s!=this.myUserId){if(a.hasOwnProperty(s)){if(t=a[s],i=t.data,i.positions[0].gps.join(",")===e.positions[0].gps.join(","))return t.data=e,void 0}else $('#identities .identity[data-uid="'+s+'"]').length||this.freshExfee();t||(t=a[s]=this.addGeoMarker()),r=e.positions[0].gps,n=this.toLatLng(r[0],r[1]),t.setPosition(n),t.uid=s,t.data=e,this.containsOne(s,n)}},_.updatePositions=function(e){var t=e.id.split(".")[1];this._breadcrumbs[t]?this._breadcrumbs[t].positions.unshift(e.positions[0]):this._breadcrumbs[t]=e,this._breadcrumbs[t].length>100&&this._breadcrumbs[t].splice(100,this._breadcrumbs[t].length-100)},_.addGeoMarker=function(){var e=this,t=new google.maps.Marker({map:this.map,zIndex:h-2,icon:this.icons.dotGrey,shape:{type:"circle",circle:[9,9,9]},optimized:!1});return google.maps.event.addListener(t,"mousedown",function(t){t&&t.stop(),e.showIdentityPanel(this.uid)}),t},_.distanceMatrix=function(e,t,i,n){n=n||0;var r=$('#identities-overlay .identity[data-uid="'+e+'"]'),s=r.find(".detial"),o=s.find(".icon"),u=s.find(".distance");if(t&&i){var d=t.getPosition(),h=i.getPosition(),p=d.lat(),f=d.lng(),m=h.lat(),g=h.lng(),v=a(m,g,p,f),y=l(p,f,m,g),_=c(v);_.rotate=y,u.html(_.text),o.css("-webkit-transform","rotate("+y+"deg)"),o.attr("class","icon icon-arrow-"+(1>=n?"red":"grey")),s.css("visibility","visible")}else t?(o.hasClass("icon-dot-red")||o.hasClass("icon-dot-red")||o.attr("class","icon icon-dot"+(1>=n?"red":"grey")),u.html(1>=n?"在线":60>n?n+'<span class="unit">分钟前</span>':Math.floor(n/60)+'<span class="unit">小时前</span>'),s.css("visibility","visible")):this.updated[e]?(n=Math.floor((Date.now()/1e3-this.updated[e].t)/60),u.html(1>=n?"在线":60>n?n+'<span class="unit">分钟前</span>':Math.floor(n/60)+'<span class="unit">小时前</span>'),s.css("visibility","visible")):s.css("visibility","hidden")},_.fitBoundsWithDestination=function(e){var t=this.destinationPlace,i=this.myUserId==e,n=i?this.geoLocation:this.geoMarkers[e];if(n){var r=n.getPosition(),a=this.map;if(t){var s,o=t.getPosition(),l=this.fromLatLngToContainerPixel(o);i?s=this.calculateBoundsByCenter(r,[o]):(s=new google.maps.LatLngBounds,50>l.x&&(l=this.fromContainerPixelToLatLng(new google.maps.Point(l.x-50,l.y)),s.extend(l)),s.extend(r),s.extend(o)),a.fitBounds(s)}else(i||!a.getBounds().contains(r))&&(7>a.getZoom()&&a.setZoom(15),a.panTo(r))}},_.panToDestination=function(e){var t=this.map;7>t.getZoom()&&t.setZoom(15),t.panTo(e||this.destinationPlace.getPosition())},_.calculateBoundsByCenter=function(e,t){for(var i,n,r,a=new google.maps.LatLngBounds,s=[];n=t.shift();)i=this.fromLatLngToContainerPixel(n),s.push(i);for(var o,l,r=this.fromLatLngToContainerPixel(e),c=0;l=s.shift();)o=Math.sqrt(Math.pow(l.x-r.x,2)+Math.pow(l.y-r.y,2)),o>c&&(c=o);var u=this.fromContainerPixelToLatLng(new google.maps.Point(r.x-c-50,r.y-c-50)),d=this.fromContainerPixelToLatLng(new google.maps.Point(r.x+c+50,r.y+c+50));return a.extend(u),a.extend(e),a.extend(d),a},_.addBreadcrumbs=function(){var e="#7f7f7f",t=.5,i=new google.maps.Polyline({map:this.map,visible:!1,index:h-5,strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:e,fillOpacity:t,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},fixedRotation:!0,repeat:"16px",offset:"0"}]});return i},_.MIN_PIXL=50,_.distanceMatrixPixl=function(e,t,i){i=i||50;var n=this.fromLatLngToContainerPixel(new google.maps.LatLng(e[0],e[1])),r=this.fromLatLngToContainerPixel(new google.maps.LatLng(t[0],t[1])),a=Math.sqrt(Math.pow(n.x-r.x,2)+Math.pow(n.y-r.y,2));return a>=i},_.showTextLabels=function(e,t,i){if(e){for(var n,r,a,s,o,l=Math.round(Date.now()/1e3),c=this.labels,u=this.map,d=t.slice(0),p=!0,f=0,m=0,g=0,v=0;a=d.shift();)if(s=10*Math.floor((l-a.t)/600),g!==s&&(g=s,o&&(p=this.distanceMatrixPixl(a.gps,o.gps)),s>f&&p&&(-1!=y.indexOf(s)||s>15))){if(0===v&&i){v=1;continue}f=s,n=c[m],n?r=n.marker:(r=new google.maps.Marker({map:u,zIndex:h-4,optimized:!1}),n=c[m]=new google.maps.TextLabel({map:u,zIndex:h-3}),n.marker=r),r&&(r.setPosition(this.toLatLng(a.gps[0],a.gps[1])),r.setIcon({path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:i?"#ff325b":"#7f7f7f",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5})),60>s?n.set("text",s+"分钟前"):n.set("text",Math.floor(s/60)+"小时前"),o=a,m++}for(var _=c.length-1;_>m;_--)n=c[_],n&&(n.marker.setMap(null),n.setMap(null)),c.splice(_,1)}},_.removeTextLabels=function(){for(var e,t=this.labels;e=t.shift();)e.marker.setMap(null),e.setMap(null);t.length=0},_.updateBreadcrumbs=function(e){var t,i,n,r,a=[];if(t=this._breadcrumbs[e]){var s=t.positions.slice(0),o=s.slice(0);if(i=this.breadcrumbs[e]){for(;n=o.pop();)r=n.gps,a.push(this.toLatLng(r[0],r[1]));i.setPath(a)}}},_.showBreadcrumbs=function(e){if(this.hideMyPanel(),this.hideNearBy(),this.hideIdentityPanel(),this.removeTextLabels(),this._breadcrumbs[e]){var t,i=this.breadcrumbs,n=this.uid,r=i[e];if(delete this.uid,r||(r=i[e]=this.addBreadcrumbs()),r&&this.updateBreadcrumbs(e),e!==n)t=i[n],t&&(t.setMap(null),delete i[n],t=null),r&&(r.setVisible(!0),this.uid=e);else if(r){var a=!r.getVisible();r.setVisible(a),a?this.uid=e:(r.setMap(null),delete i[e],r=null)}console.log("current breadcrumbs",e)}},_.addPoint=function(e){var t=this,i=google.maps,r=this.map,a=(this.myIdentity,new i.Marker({map:r,zIndex:h-5,icon:new i.MarkerImage(e.icon||n+"/icons/mapmark",new i.Size(48,68),new i.Point(0,0),new i.Point(12,34),new i.Size(24,34))})),s=i.event;return s.addListener(a,"mousedown",function(e){return e&&e.stop(),t.removeInfobox(this)?!1:(t.infobox=new i.InfoBox({content:t.infoWindowTemplate.replace("{{title}}",this.data.title).replace("{{description}}",this.data.description),maxWidth:200,pixelOffset:new i.Size(-100,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1,leftBoundary:60,zIndex:610,boxId:"place-editor",events:function(){t.infobox.editing=!1,s.addDomListener(this.div_,"touchstart",function(){if(!t.infobox.editing){var e=this.querySelector(".info-windown"),i=this.querySelector(".title").innerHTML,n=this.querySelector(".description").innerHTML,r=document.createElement("input");r.type="text",r.value=i;var a=document.createElement("textarea");a.value=n,e.appendChild(r),e.appendChild(a),this.querySelector(".title").className="title hide",this.querySelector(".description").className="description hide",t.infobox.editing=!0}})}}),t.infobox.marker=this,t.infobox.open(r,this),void 0)}),a},_.editPlace=function(){if(this.infobox){var e=this.infobox.marker.data,t=this.myIdentity;if(this.infobox.editing){var i=$("#place-editor input").val().trim(),n=$("#place-editor textarea").val().trim();(i!==e.title||n!==e.description)&&(e.title=i,e.description=n,e.updated_at=Math.round(Date.now()/1e3),e.updated_by=t.external_username+"@"+t.provider,this.controller.editPlace(e)),$("#place-editor input, #place-editor textarea").remove(),$("#place-editor .title").text(i).removeClass("hide"),$("#place-editor .description").text(n).removeClass("hide")}this.removeInfobox()}},_.removeInfobox=function(e){var t,i=this.infobox;return i&&(t=i.marker,i.close(),delete i.marker,i=this.infobox=null,t===e)?!0:void 0},_.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',_.contains=function(){var e,t,i,n=this.map.getBounds(),r=google.maps,a=n.getSouthWest(),s=n.getNorthEast(),o=new r.LatLngBounds,l=this.geoMarkers,c=document.getElementById("identities")._ids||{};a=this.fromLatLngToContainerPixel(a),a=this.fromContainerPixelToLatLng(new r.Point(a.x+50,a.y)),o.extend(a),o.extend(s);for(e in l)t=l[e],i=t.getPosition(),this.containsOne(e,i,o,c);console.log("map zoom",this.map.getZoom())},_.containsOne=function(e,t,i,n,r){if(i||(i=this.map.getBounds()),n||(n=document.getElementById("identities")._ids||{}),i.contains(t)&&(r=n[e])){var a=this.fromLatLngToContainerPixel(t),s=this.lines[e];s||(s=[]),s[0]=[r[1],r[2]],s[1]=[r[1]+13,r[2]],s[2]=[a.x,a.y],this.updateLine(e,s)}else this.removeLine(e)},_.clearLines=function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},_.removeLine=function(e){delete this.lines[e],this.updateLines()},_.updateLines=function(){if(this.DRAW_STATUS){this.clearLines();var e=this.lines;for(var t in e)this.addLine(t,e[t])}},_.updateLine=function(e,t){console.dir("update line",t),this.lines[e]=t,this.updateLines()},_.addLine=function(e,t){var i=this.ctx;i.beginPath(),i.lineWidth=2,i.lineJoin=i.lineCap="round",i.moveTo(2*t[0][0],2*t[0][1]),i.lineTo(2*t[1][0],2*t[1][1]),i.lineTo(2*t[2][0],2*t[2][1]),i.strokeStyle=t[3]||"#b2b2b2",i.stroke()},_.updateGeoLocation=function(e,t){var i,n,r=this.geoLocation;if(!r){r=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:h-1,visible:!0,icon:this.icons.arrowGrey,shape:{type:"rect",rect:[0,0,1,1]},optimized:!1}),r._status=0;var a=JSON.parse(window.localStorage.getItem("position"));a&&(a=this.toMars(a,!0),n=a.gps,r._status=1,i=this.toLatLng(n[0],n[1]),r.setPosition(i),this.map.setZoom(15),this.map.panTo(i))}t&&(t=this.toMars(t,!0),n=t.gps,i=this.toLatLng(n[0],n[1]),r.setIcon(this.icons.arrowBlue),r.setPosition(i),2!==r._status&&(this.map.setZoom(15),this.map.panTo(i)),r._status=2),e&&(this.updated[e]=t||a),r._uid=e},_.toMars=function(e,t){var i=e.gps,n={t:t?Math.floor(Date.now()/1e3):e.t,gps:[1*i[0]+this.latOffset,1*i[1]+this.lngOffset,i[2]]};return n},_.switchGEOStyle=function(e){var t=this.geoLocation;t&&t.setIcon(this.icons["arrow"+(e?"Blue":"Grey")])},t});