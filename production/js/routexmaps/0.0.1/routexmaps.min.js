<<<<<<< HEAD
define("routexmaps",function(t){"use strict";function e(e){e=this.options=e||{},this.svgLayer=this.options.svg,delete this.options.svg,this.latOffset=0,this.lngOffset=0,this.routes={},this.places={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.updated={},this._breadcrumbs={},this.boundsOffset={left:50,top:0},this.labels=[],window._loadmaps_=function(e,r,s,o){return function a(){var u=google.maps,c=u.event;u.InfoBox=t("infobox"),u.TextLabel=t("maplabel");var l=e.icons;l.dotGrey=new u.MarkerImage(n+"/static/img/map_dot_grey@2x.png",new u.Size(36,36),new u.Point(0,0),new u.Point(9,9),new u.Size(18,18)),l.dotRed=new u.MarkerImage(n+"/static/img/map_dot_red@2x.png",new u.Size(36,36),new u.Point(0,0),new u.Point(9,9),new u.Size(18,18)),l.arrowBlue=new u.MarkerImage(n+"/static/img/map_arrow_22blue@2x.png",new u.Size(44,44),new u.Point(0,0),new u.Point(11,11),new u.Size(22,22)),l.arrowGrey=new u.MarkerImage(n+"/static/img/map_arrow_22g5@2x.png",new u.Size(44,44),new u.Point(0,0),new u.Point(11,11),new u.Size(22,22)),l.placeMarker=new u.MarkerImage(i+"/icons/mapmark",new u.Size(48,68),new u.Point(0,0),new u.Point(12,34),new u.Size(24,34)),l.xplaceMarker=new u.MarkerImage(n+"/static/img/map_pin_blue@2x",new u.Size(48,68),new u.Point(0,0),new u.Point(12,34),new u.Size(24,34)),l.destinationMarker=new u.MarkerImage(n+"/static/img/map_mark_diamond_blue@2x.png",new u.Size(48,68),new u.Point(0,0),new u.Point(12,34),new u.Size(24,34)),u.visualRefresh=!0,s.center=e.toLatLng(35.86166,104.195397),s.mapTypeId=u.MapTypeId.ROADMAP,s.disableDefaultUI=!0,s.minZoom=1;var h=e.map=new u.Map(r,s),p=e.overlay=new u.OverlayView;p.draw=function(){},p.setMap(h);var f=c.addListener(h,"tilesloaded",function(){function t(t){clearTimeout(t),t=null}c.addListener(h,"bounds_changed",function(){c.trigger(h,"zoom_changed")}),c.addListener(h,"zoom_changed",function(){e.contains()}),c.addListener(h,"mousedown",function(t){t.stop(),e.hideIdentityPanel()});var n,i,s=377;c.addDomListener(r,"touchstart",function(o){console.dir(o),e.hideMyPanel(),e.hideNearBy(),i=Date.now(),t(n),n=setTimeout(function(){o.preventDefault();var t=o.touches[0],n={x:t.pageX,y:t.pageY};e.showNearBy(n)},s),c.clearListeners(r,"touchmove"),c.addDomListenerOnce(r,"touchmove",function(){t(n),e.hideTiplines()})}),c.addDomListener(r,"touchend",function(){377>Date.now()-i&&t(n)}),c.removeListener(f)});o(h),a=null}}(this,e.mapDiv,e.mapOptions,e.callback)}var n=window._ENV_.site_url,i=window._ENV_.apiv3_url,r=6378137,s=function(t,e,n,i){var s=r,o=(n-t)*Math.PI/180,a=(i-e)*Math.PI/180,u=Math.sin(o/2)*Math.sin(o/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(a/2)*Math.sin(a/2),c=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),l=s*c;return l},o=function(t){return t*Math.PI/180},a=function(t){return 180*t/Math.PI},u=function(t,e,n,i){t=o(t),e=o(e),n=o(n),i=o(i);var r=i-e,s=Math.sin(r)*Math.cos(n),u=Math.cos(t)*Math.sin(n)-Math.sin(t)*Math.cos(n)*Math.cos(r),c=Math.atan2(s,u);return 0>c&&(c+=2*Math.PI),a(c)},c=function(t,e,n,i,r){return i='<span class="unit">{{u}}</span>',t=Math.floor(t),r={text:"",status:0,distance:t},30>t&&!e?(r.status=4,r.text="抵达"):r.text=1e3>t?t+i.replace("{{u}}","米"):9e3>t?(t/1e3+"").slice(0,3)+i.replace("{{u}}","公里"):"9+"+i.replace("{{u}}","公里"),r},l=function(t){return(1*t).toString(16)},h=function(t){return t+="",t+(t.length>1?"":"0")},p=610,f="route",d="location",m="destination",g="breadcrumbs",v=[0,1,3,5,10,15],y=e.prototype;y.load=function(t){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.onload=e.onerror=e.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(e.readyState)&&(e=e.onload=e.onerror=e.onreadystatechange=null,t&&t())},e.src=this.options.url,document.body.appendChild(e)},y.fromContainerPixelToLatLng=function(t){return this.overlay.getProjection().fromContainerPixelToLatLng(t)},y.fromLatLngToContainerPixel=function(t){return this.overlay.getProjection().fromLatLngToContainerPixel(t)},y.showIdentityPanel=function(t){this.hideNearBy();var e,n,i=this.geoMarkers[t],r=this.geoLocation,o=this.destinationPlace,a=$('#identities-overlay .identity[data-uid="'+t+'"]').data("identity"),u=$("#other-info"),l=Math.round(Date.now()/1e3);if(i){if(e=i.getPosition(),n=Math.floor((l-i.data.positions[0].t)/60),u.find(".name").text(a.name),n>1?(u.find(".update").removeClass("hide").find(".time").text(n),u.find(".please-update").attr("data-external-username",a.external_username).attr("data-provider",a.provider).removeClass("hide")):(u.find(".update").addClass("hide"),u.find(".please-update").addClass("hide")),o){var h=o.getPosition(),p=s(h.lat(),h.lng(),e.lat(),e.lng()),f=c(p,!0);u.find(".dest").removeClass("hide").find(".m").html(f.text)}else u.find(".dest").addClass("hide");if(r){var h=r.getPosition(),p=s(h.lat(),h.lng(),e.lat(),e.lng()),f=c(p,!0);u.find(".dest-me").removeClass("hide").find(".m").html(f.text)}else u.find(".dest-me").removeClass("hide");u.removeClass("hide");var d=$(window).width(),m=$(window).height(),g=u.height(),v=u.width(),y=this.fromLatLngToContainerPixel(e),b=y.x-v/2,w=y.y-g/2;0>b&&(b=50),b+v>d&&(b=d-v),0>w&&(w=20),w+g>m&&(w=m-g),u.css({left:b,top:w})}},y.setOffset=function(t){this.latOffset=1*t.earth_to_mars_latitude,this.lngOffset=1*t.earth_to_mars_longitude},y.hideMyPanel=function(){$("#my-info").addClass("hide")},y.hideIdentityPanel=function(){$("#other-info").addClass("hide")};var b='<div id="nearby" class="info-windown"></div>',w='<div class="place-marker"><h4 class="title"></h4><div class="description"></div></div>',x='<div class="geo-marker clearfix"><img width="30" height="30" src="" alt="" /><div class="detial"><div class="name"></div><div class="status"></div></div></div>';return y.hideNearBy=function(){$("#nearby").remove()},y.distance100px=function(t,e){var n=this.fromLatLngToContainerPixel(t),i=Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));return 100>=i},y.showNearBy=function(t){if(t){var e,n,i=t,r=!1,o=(this.myUserId,this.places),a=this.geoMarkers,u=this.geoLocation,l=u&&u.getPosition(),h=this.destinationPlace,p=h&&h.getPosition(),f=Date.now()/1e3;console.log("-----------------------",l,p);var d=$(b);for(var m in o)if(n=o[m],e=n.getPosition(),this.distance100px(e,i)){r||(r=!0);var g=$(w);g.find(".title").text(n.data.title),g.find(".description").text(n.data.description),d.append($("<div></div>").append(g))}for(var m in a)if(n=a[m],e=n.getPosition(),this.distance100px(e,i)){r||(r=!0),n.data.id.split("@")[0];var v=$('#identities-overlay .identity[data-uid="'+m+'"]').data("identity"),g=$(x);g.find("img").attr("src",v.avatar_filename),g.find(".name").text(v.name),g.attr("data-uid",m);var y=n.data.positions[0],k=Math.floor((f-y.t)/60),S="",_="",E="";if(l){var T=c(s(e.lat(),e.lng(),l.lat(),l.lng()),!0);S=T.text}if(p){var T=c(s(e.lat(),e.lng(),p.lat(),p.lng()),!0);_=T.text}1>=k?(_&&(E+="<span>距离目的地"+_+"</span>"),S&&(E+="<span>与您相距"+S+"</span>")):(E+="<span>"+k+"分钟前所处位置</span>",_&&(E+="<span>距离目的地"+_+"</span>")),E&&g.find(".status").html(E),d.append($("<div></div>").append(g))}if(r){var P=$(window).width(),M=$(window).height();d.css({left:(P-200+50)/2,top:(M-132)/2}),$("#routex").append(d)}}},y.draw=function(t){var e,n=t.type,i=t.action,r=i&&"delete"===i,s=t.tags,o=s&&t.tags.slice(0);switch(console.log(n,i,r,o,t),n){case d:var a;if(s)for(;e=o.shift();)if(e===m){a=!0;break}r?this.removePlace(t,a):this.drawPlace(t,a);break;case f:var u;if(s)for(;e=o.shift();)if(e===g){u=!0;break}u?this.drawGeoMarker(t):r?this.removeRoute(t):this.drawRoute(t)}},y.removePlace=function(t,e){var n=this.places,i=t.id,r=n[i];r&&(r.setMap(null),r=null,delete n[i],e&&(this.destinationPlace=null))},y.drawRoute=function(t){var e,n,i,r,s=this.routes,o=t.id,a=t.positions.slice(0),u=[];if(!s.hasOwnProperty(o)||(e=s[o],n=e.data,n.updated_at!==t.updated_at)){for(e||(e=s[o]=this.addPolyline(t));i=a.shift();)r=i.gps,u.push(this.toLatLng(r[0],r[1]));e.setPath(u),e.data=t}},y.removeRoute=function(t){var e=this.routes,n=t.id,i=e[n];i&&(i.setMap(null),i=null,delete e[n])},y.addPolyline=function(t){var e=t.color&&t.color.split(",")||[],n="#"+(e.length?h(l(e[0]))+h(l(e[1]))+h(l(e[2])):"007BFF"),i=e[3]||1,r=new google.maps.Polyline({map:this.map,index:p-5,geodesic:!0,strokeColor:n,strokeWeight:4,strokeOpacity:i});return r},y.drawPlace=function(t,e){var n,i,r=this.places,s=t.id;if(r.hasOwnProperty(s)&&(n=r[s]),n||(n=r[s]=this.addPoint(t)),i=this.toLatLng(t.lat,t.lng),n.setPosition(i),n.data=t,e){var o=this.geoLocation,a=p,u=this.icons.destinationMarker;(!o||o&&0==o._status)&&this.panToDestination(i);var c=this.destinationPlace;if(c&&c!==n){var l=c.data;t.updated_at>l.updated_at?(t.id!=l.id&&(c.setIcon(this.icons.placeMarker),c.setZIndex(a-5)),this.destinationPlace=n):(a-=5,u=this.icons.placeMarker)}else this.destinationPlace=n;n.setIcon(u),n.setZIndex(a)}},y.monit=function(){var t,e,n,i,r,s,o,a,u=this.updated,c=this.breadcrumbs,l=this.icons,h=this.geoMarkers,p=this.tiplines,f=this.destinationPlace,d=this.geoLocation,m=this.myUserId,g=this.uid,v=Math.round(Date.now()/1e3);for(t in u)if(u.hasOwnProperty(t))if(n=u[t],e=m==t,a=Math.floor((v-n.t)/60),i=e?d:h[t],this.distanceMatrix(t,i,f,a),r=c[t],o=p[t],s=$('#identities-overlay .identity[data-uid="'+t+'"]').find(".icon"),g&&g==t&&this._breadcrumbs[g]&&this.showTextLabels(g,this._breadcrumbs[g].positions.slice(0),1>=a),1>=a){if(s.length&&(s.parent().removeClass("unknown"),s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-red"):s.attr("class","icon icon-dot-red")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#FF7E98",fillOpacity:.8,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},repeat:"25px",offset:"0"}]}),e)continue;o&&o.setAttribute("stroke","#FF7E98"),i&&i.setIcon(l.dotRed)}else{if(s.length&&(s.parent().removeClass("unknown"),s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-grey"):s.attr("class","icon icon-dot-grey")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#b2b2b2",fillOpacity:.8,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},repeat:"25px",offset:"0"}]}),e)continue;o&&o.setAttribute("stroke","#b2b2b2"),i&&i.setIcon(l.dotGrey)}},y.toLatLng=function(t,e){return new google.maps.LatLng(1*t,1*e)},y.drawGeoMarker=function(t){var e,n,i,r,s=this.geoMarkers,o=t.id.split("@")[0];if(this.updatePositions(t),o!=this.myUserId){if(s.hasOwnProperty(o)&&(e=s[o],n=e.data,n.updated_at===t.updated_at))return;e||(e=s[o]=this.addGeoMarker()),r=t.positions[0].gps,i=this.toLatLng(r[0],r[1]),e.setPosition(i),e.uid=o,e.data=t,this.updateTipline(o,i)}},y.updatePositions=function(t){var e=t.id.split("@")[0];this._breadcrumbs[e]?this._breadcrumbs[e].positions.unshift(t.positions[0]):this._breadcrumbs[e]=t,this.updated[e]=this._breadcrumbs[e].positions[0]},y.addGeoMarker=function(){var t=this,e=new google.maps.Marker({map:this.map,animation:2,zIndex:p-2,icon:this.icons.dotGrey,shape:{type:"circle",circle:[9,9,9]},optimized:!1});return google.maps.event.addListener(e,"mousedown",function(){t.showIdentityPanel(this.uid)}),e},y.distanceMatrix=function(t,e,n,i){i=i||0;var r=$('#identities-overlay .identity[data-uid="'+t+'"]'),o=r.find(".detial"),a=o.find(".icon"),l=o.find(".distance");if(e&&n){var h=e.getPosition(),p=n.getPosition(),f=h.lat(),d=h.lng(),m=p.lat(),g=p.lng(),v=s(m,g,f,d),y=u(m,g,f,d),b=c(v);b.rotate=y,l.html(b.text),a.css("-webkit-transform","rotate("+y+"deg)"),a.attr("class","icon icon-arrow-"+(1>=i?"red":"grey")),o.css("visibility","visible")}else e?(a.hasClass("icon-dot-red")||a.hasClass("icon-dot-red")||a.attr("class","icon icon-dot"+(1>=i?"red":"grey")),l.html(1>=i?"在线":(i>=9?"9+":i)+'<span class="unit">分钟前</span>'),o.css("visibility","visible")):o.css("visibility","hidden")},y.fitBoundsWithDestination=function(t){var e=this.destinationPlace,n=this.myUserId==t,i=n?this.geoLocation:this.geoMarkers[t];if(i){var r=i.getPosition(),s=this.map;if(e){var o,a=e.getPosition(),u=this.fromLatLngToContainerPixel(a);n?o=this.calculateBoundsByCenter(r,[a]):(o=new google.maps.LatLngBounds,50>u.x&&(u=this.fromContainerPixelToLatLng(new google.maps.Point(u.x-50,u.y)),o.extend(u)),o.extend(r),o.extend(a)),s.fitBounds(o)}else(n||!s.getBounds().contains(r))&&(7>s.getZoom()&&s.setZoom(15),s.panTo(r))}},y.panToDestination=function(t){var e=this.map;7>e.getZoom()&&e.setZoom(15),e.panTo(t||this.destinationPlace.getPosition())},y.calculateBoundsByCenter=function(t,e){for(var n,i,r,s=new google.maps.LatLngBounds,o=[];i=e.shift();)n=this.fromLatLngToContainerPixel(i),o.push(n);for(var a,u,r=this.fromLatLngToContainerPixel(t),c=0;u=o.shift();)a=Math.sqrt(Math.pow(u.x-r.x,2)+Math.pow(u.y-r.y,2)),a>c&&(c=a);var l=this.fromContainerPixelToLatLng(new google.maps.Point(r.x-c-50,r.y-c-50)),h=this.fromContainerPixelToLatLng(new google.maps.Point(r.x+c+50,r.y+c+50));return s.extend(l),s.extend(t),s.extend(h),s},y.addBreadcrumbs=function(){var t="#b2b2b2",e=.8,n=new google.maps.Polyline({map:this.map,visible:!1,index:p-5,strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:t,fillOpacity:e,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5},fixedRotation:!0,repeat:"25px",offset:"0"}]});return n},y.MIN_PIXL=50,y.distanceMatrixPixl=function(t,e,n){n=n||50;var i=this.fromLatLngToContainerPixel(new google.maps.LatLng(t[0],t[1])),r=this.fromLatLngToContainerPixel(new google.maps.LatLng(e[0],e[1])),s=Math.sqrt(Math.pow(i.x-r.x,2)+Math.pow(i.y-r.y,2));return s>=n},y.showTextLabels=function(t,e,n){if(t){for(var i,r,s,o,a,u=Math.round(Date.now()/1e3),c=this.labels,l=this.map,h=e.slice(0),f=!0,d=0,m=120,g=0,y=0;s=h.shift();)if(o=10*Math.floor((u-s.t)/600),y!==o){if(y=o,o>m)break;a&&(f=this.distanceMatrixPixl(s.gps,a.gps)),o>d&&f&&(-1!=v.indexOf(o)||o>15)&&(d=o,i=c[g],i?r=i.marker:(r=new google.maps.Marker({map:l,zIndex:p-4,optimized:!1}),i=c[g]=new google.maps.TextLabel({map:l,zIndex:p-3}),i.marker=r),r&&(r.setPosition(this.toLatLng(s.gps[0],s.gps[1])),r.setIcon({path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:n?"#FF7E98":"#b2b2b2",fillOpacity:.8,strokeColor:"#fff",strokeOpacity:.8,strokeWeight:1,scale:.5})),i.set("text",o+"分钟前"),a=s,g++)}for(var b=c.length-1;b>g;b--)i=c[b],i&&i.setMap(null),c.splice(b,1)}},y.removeTextLabels=function(){for(var t,e=this.labels;t=e.shift();)t.setMap(null);e.length=0},y.updateBreadcrumbs=function(t){var e,n,i,r,s=[];if(e=this._breadcrumbs[t]){var o=e.positions.slice(0),a=o.slice(0);if(this.showTextLabels(t,o),n=this.breadcrumbs[t]){for(;i=a.pop();)r=i.gps,s.push(this.toLatLng(r[0],r[1]));n.setPath(s)}}},y.showBreadcrumbs=function(t){if(this._breadcrumbs[t]){var e,n=this.breadcrumbs,i=this.uid,r=n[t];if(delete this.uid,r||(r=n[t]=this.addBreadcrumbs()),r&&this.updateBreadcrumbs(t),t!==i)e=n[i],e&&(e.setMap(null),delete n[i],e=null,this.removeTextLabels()),r&&(r.setVisible(!0),this.uid=t);else if(r){var s=!r.getVisible();r.setVisible(s),s?this.uid=t:(r.setMap(null),delete n[t],r=null,this.removeTextLabels())}console.log("current breadcrumbs",t)}},y.addPoint=function(t){var e=this,n=google.maps,r=this.map,s=this.myIdentity,o=new n.Marker({map:r,animation:2,zIndex:p-5,icon:new n.MarkerImage(t.icon||i+"/icons/mapmark",new n.Size(48,68),new n.Point(0,0),new n.Point(12,34),new n.Size(24,34))}),a=n.event;return a.addListener(o,"mousedown",function(t){if(t&&t.stop(),e.removeInfobox(this))return!1;var i=e.infobox=new n.InfoBox({content:e.infoWindowTemplate.replace("{{title}}",this.data.title).replace("{{description}}",this.data.description),maxWidth:200,pixelOffset:new n.Size(-100,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1,leftBoundary:60,zIndex:610,boxId:"place-editor",events:function(){var t=this;t.editing=!1,a.addDomListener(this.div_,"touchstart",function(){if(!t.editing){var e=this.querySelector(".info-windown"),n=this.querySelector(".title").innerHTML,i=this.querySelector(".description").innerHTML,r=document.createElement("input");r.type="text",r.value=n;var s=document.createElement("textarea");s.value=i,e.appendChild(r),e.appendChild(s),this.querySelector(".title").className="title hide",this.querySelector(".description").className="description hide",t.editing=!0}})}});i._marker=this,i.open(r,this),a.addListenerOnce(this,"mouseout",function(){if(i.editing){var t=i._marker.data,n=$("#place-editor input").val().trim(),r=$("#place-editor textarea").val().trim();if(n!==t.title||r!==t.description){t.title=n,t.description=r,t.updated_at=Math.round(Date.now()/1e3),t.updated_by=s.external_username+"@"+s.provider;for(var o=0,a=t.tags,u=a.length;u>o;++o)if("xplace"===a[o]){a.splice(o,1),this.setIcon(e.icons.placeMarker);break}e.controller.editPlace(t)}$("#place-editor input, #place-editor textarea").remove(),$("#place-editor .title").text(n).removeClass("hide"),$("#place-editor .description").text(r).removeClass("hide")}i.close(),delete i._marker,i=e.infobox=null})}),o},y.removeInfobox=function(t){var e,n=this.infobox;return n&&(e=n._marker,n.close(),delete n._marker,n=this.infobox=null,e===t)?!0:void 0},y.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',y.contains=function(){var t,e,n,i=this.map.getBounds(),r=google.maps,s=i.getSouthWest(),o=i.getNorthEast(),a=new r.LatLngBounds,u=this.geoMarkers,c=document.getElementById("identities")._ids||{};s=this.fromLatLngToContainerPixel(s),s=this.fromContainerPixelToLatLng(new r.Point(s.x+50,s.y)),a.extend(s),a.extend(o);for(t in u)e=u[t],n=e.getPosition(),this.containsOne(t,n,a,c);console.log("map zoom",this.map.getZoom())},y.containsOne=function(t,e,n,i,r){n||(n=this.map.getBounds()),i||(i=document.getElementById("identities")._ids||{}),n.contains(e)&&(r=i[t])?this.showTipline(t,r):this.hideTipline(t)},y.hideTiplines=function(){var t,e=this.tiplines;for(t in e)this.hideTipline(t)},y.updateTipline=function(t,e){var n=this.tiplines[t];n||(n=this.tiplines[t]=this.addTipline(t)),e&&this.containsOne(t,n._lastlatlng=e)},y.addTipline=function(){var t=document.createElementNS("http://www.w3.org/2000/svg","polyline");return t.setAttribute("fill","none"),t.setAttribute("stroke","#b2b2b2"),t.setAttribute("stroke-width",1),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),t.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(t),t},y.showTipline=function(t,e){var n,i=this.tiplines[t];if(i){var r=[e[1],e[2]],s=[r[0]+13,r[1]],o=[r.join(","),s.join(",")].join(" "),n=this.fromLatLngToContainerPixel(i._lastlatlng);i.setAttribute("points",o+" "+n.x+","+n.y),i.setAttributeNS(null,"display","block")}},y.hideTipline=function(t){var e=this.tiplines[t];e&&e.setAttributeNS(null,"display","none")},y.updateGeoLocation=function(t,e){var n,i,r=this.geoLocation;if(!r){r=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:p-1,visible:!0,animation:2,icon:this.icons.arrowGrey,shape:{type:"rect",rect:[0,0,22,22]},optimized:!1}),r._status=0;var s=JSON.parse(window.localStorage.getItem("position"));s&&(i=s.gps,r._status=1,n=this.toLatLng(1*i[0]+this.latOffset,1*i[1]+this.lngOffset),r.setPosition(n),this.map.setZoom(15),this.map.panTo(n))}e&&(i=e.gps,n=this.toLatLng(1*i[0]+this.latOffset,1*i[1]+this.lngOffset),r.setIcon(this.icons.arrowBlue),r.setPosition(n),2!==r._status&&(this.map.setZoom(15),this.map.panTo(n)),r._status=2),t&&(this.updated[t]=e||s),r._uid=t},y.switchGEOStyle=function(t){var e=this.geoLocation;e&&e.setIcon(this.icons["arrow"+(t?"Blue":"Grey")])},e});
=======
define("routexmaps",function(t){"use strict";function e(e){e=this.options=e||{},this.svgLayer=this.options.svg,delete this.options.svg,this.latOffset=0,this.lngOffset=0,this.routes={},this.places={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.updated={},this._breadcrumbs={},this.boundsOffset={left:50,top:0},this.labels=[],window._loadmaps_=function(e,r,s,o){return function a(){var u=google.maps,c=u.event;u.InfoBox=t("infobox"),u.TextLabel=t("maplabel");var l=e.icons;l.dotGrey=new u.MarkerImage(n+"/static/img/map_dot_grey@2x.png",new u.Size(36,36),new u.Point(0,0),new u.Point(9,9),new u.Size(18,18)),l.dotRed=new u.MarkerImage(n+"/static/img/map_dot_red@2x.png",new u.Size(36,36),new u.Point(0,0),new u.Point(9,9),new u.Size(18,18)),l.arrowBlue=new u.MarkerImage(n+"/static/img/map_arrow_22blue@2x.png",new u.Size(44,44),new u.Point(0,0),new u.Point(11,11),new u.Size(22,22)),l.arrowGrey=new u.MarkerImage(n+"/static/img/map_arrow_22g5@2x.png",new u.Size(44,44),new u.Point(0,0),new u.Point(11,11),new u.Size(22,22)),l.placeMarker=new u.MarkerImage(i+"/icons/mapmark",new u.Size(48,68),new u.Point(0,0),new u.Point(12,34),new u.Size(24,34)),l.xplaceMarker=new u.MarkerImage(n+"/static/img/map_pin_blue@2x",new u.Size(48,68),new u.Point(0,0),new u.Point(12,34),new u.Size(24,34)),l.destinationMarker=new u.MarkerImage(n+"/static/img/map_mark_diamond_blue@2x.png",new u.Size(48,68),new u.Point(0,0),new u.Point(12,34),new u.Size(24,34)),u.visualRefresh=!0,s.center=e.toLatLng(35.86166,104.195397),s.mapTypeId=u.MapTypeId.ROADMAP,s.disableDefaultUI=!0,s.minZoom=1;var h=e.map=new u.Map(r,s),p=e.overlay=new u.OverlayView;p.draw=function(){},p.setMap(h);var f=c.addListener(h,"tilesloaded",function(){function t(t){clearTimeout(t),t=null}c.addListener(h,"bounds_changed",function(){c.trigger(h,"zoom_changed")}),c.addListener(h,"zoom_changed",function(){e.contains()}),c.addListener(h,"mousedown",function(t){t.stop(),e.hideIdentityPanel()});var n,i,s=377;c.addDomListener(r,"touchstart",function(o){console.dir(o),e.hideMyPanel(),e.hideNearBy(),i=Date.now(),t(n),n=setTimeout(function(){o.preventDefault();var t=o.touches[0],n={x:t.pageX,y:t.pageY};e.showNearBy(n)},s),c.clearListeners(r,"touchmove"),c.addDomListenerOnce(r,"touchmove",function(){t(n),e.hideTiplines()})}),c.addDomListener(r,"touchend",function(){377>Date.now()-i&&t(n)}),c.removeListener(f)});o(h),a=null}}(this,e.mapDiv,e.mapOptions,e.callback)}var n=window._ENV_.site_url,i=window._ENV_.apiv3_url,r=6378137,s=function(t,e,n,i){var s=r,o=(n-t)*Math.PI/180,a=(i-e)*Math.PI/180,u=Math.sin(o/2)*Math.sin(o/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(a/2)*Math.sin(a/2),c=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),l=s*c;return l},o=function(t){return t*Math.PI/180},a=function(t){return 180*t/Math.PI},u=function(t,e,n,i){t=o(t),e=o(e),n=o(n),i=o(i);var r=i-e,s=Math.sin(r)*Math.cos(n),u=Math.cos(t)*Math.sin(n)-Math.sin(t)*Math.cos(n)*Math.cos(r),c=Math.atan2(s,u);return 0>c&&(c+=2*Math.PI),a(c)},c=function(t,e,n,i,r){return i='<span class="unit">{{u}}</span>',t=Math.floor(t),r={text:"",status:0,distance:t},30>t&&!e?(r.status=4,r.text="抵达"):r.text=1e3>t?t+i.replace("{{u}}","米"):9e3>t?(t/1e3+"").slice(0,3)+i.replace("{{u}}","公里"):"9+"+i.replace("{{u}}","公里"),r},l=function(t){return(1*t).toString(16)},h=function(t){return t+="",t+(t.length>1?"":"0")},p=610,f="route",d="location",m="destination",g="breadcrumbs",v=[0,1,3,5,10,15],y=e.prototype;y.load=function(t){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.onload=e.onerror=e.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(e.readyState)&&(e=e.onload=e.onerror=e.onreadystatechange=null,t&&t())},e.src=this.options.url,document.body.appendChild(e)},y.fromContainerPixelToLatLng=function(t){return this.overlay.getProjection().fromContainerPixelToLatLng(t)},y.fromLatLngToContainerPixel=function(t){return this.overlay.getProjection().fromLatLngToContainerPixel(t)},y.showIdentityPanel=function(t){this.hideNearBy();var e,n,i=this.geoMarkers[t],r=this.geoLocation,o=this.destinationPlace,a=$('#identities-overlay .identity[data-uid="'+t+'"]').data("identity"),u=$("#other-info"),l=Math.round(Date.now()/1e3);if(i){if(e=i.getPosition(),n=Math.floor((l-i.data.positions[0].t)/60),u.find(".name").text(a.name),n>1?(u.find(".update").removeClass("hide").find(".time").text(n),u.find(".please-update").attr("data-external-username",a.external_username).attr("data-provider",a.provider).removeClass("hide")):(u.find(".update").addClass("hide"),u.find(".please-update").addClass("hide")),o){var h=o.getPosition(),p=s(h.lat(),h.lng(),e.lat(),e.lng()),f=c(p,!0);u.find(".dest").removeClass("hide").find(".m").html(f.text)}else u.find(".dest").addClass("hide");if(r){var h=r.getPosition(),p=s(h.lat(),h.lng(),e.lat(),e.lng()),f=c(p,!0);u.find(".dest-me").removeClass("hide").find(".m").html(f.text)}else u.find(".dest-me").removeClass("hide");u.removeClass("hide");var d=$(window).width(),m=$(window).height(),g=u.height(),v=u.width(),y=this.fromLatLngToContainerPixel(e),w=y.x-v/2,b=y.y-g/2;0>w&&(w=50),w+v>d&&(w=d-v),0>b&&(b=20),b+g>m&&(b=m-g),u.css({left:w,top:b})}},y.setOffset=function(t){this.latOffset=1*t.earth_to_mars_latitude,this.lngOffset=1*t.earth_to_mars_longitude},y.hideMyPanel=function(){$("#my-info").addClass("hide")},y.hideIdentityPanel=function(){$("#other-info").addClass("hide")};var w='<div id="nearby" class="info-windown"></div>',b='<div class="place-marker"><h4 class="title"></h4><div class="description"></div></div>',x='<div class="geo-marker clearfix"><img width="30" height="30" src="" alt="" /><div class="detial"><div class="name"></div><div class="status"></div></div></div>';return y.hideNearBy=function(){$("#nearby").remove()},y.distance100px=function(t,e){var n=this.fromLatLngToContainerPixel(t),i=Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));return 100>=i},y.showNearBy=function(t){if(t){var e,n,i=t,r=!1,o=(this.myUserId,this.places),a=this.geoMarkers,u=this.geoLocation,l=u&&u.getPosition(),h=this.destinationPlace,p=h&&h.getPosition(),f=Date.now()/1e3;console.log("-----------------------",l,p);var d=$(w);for(var m in o)if(n=o[m],e=n.getPosition(),this.distance100px(e,i)){r||(r=!0);var g=$(b);g.find(".title").text(n.data.title),g.find(".description").text(n.data.description),d.append($("<div></div>").append(g))}for(var m in a)if(n=a[m],e=n.getPosition(),this.distance100px(e,i)){r||(r=!0),n.data.id.split("@")[0];var v=$('#identities-overlay .identity[data-uid="'+m+'"]').data("identity"),g=$(x);g.find("img").attr("src",v.avatar_filename),g.find(".name").text(v.name),g.attr("data-uid",m);var y=n.data.positions[0],k=Math.floor((f-y.t)/60),S="",_="",E="";if(l){var T=c(s(e.lat(),e.lng(),l.lat(),l.lng()),!0);S=T.text}if(p){var T=c(s(e.lat(),e.lng(),p.lat(),p.lng()),!0);_=T.text}1>=k?(_&&(E+="<span>距离目的地"+_+"</span>"),S&&(E+="<span>与您相距"+S+"</span>")):(E+="<span>"+k+"分钟前所处位置</span>",_&&(E+="<span>距离目的地"+_+"</span>")),E&&g.find(".status").html(E),d.append($("<div></div>").append(g))}if(r){var P=$(window).width(),M=$(window).height();d.css({left:(P-200+50)/2,top:(M-132)/2}),$("#routex").append(d)}}},y.draw=function(t){var e,n=t.type,i=t.action,r=i&&"delete"===i,s=t.tags,o=s&&t.tags.slice(0);switch(console.log(n,i,r,o,t),n){case d:var a;if(s)for(;e=o.shift();)if(e===m){a=!0;break}r?this.removePlace(t,a):this.drawPlace(t,a);break;case f:var u;if(s)for(;e=o.shift();)if(e===g){u=!0;break}u?this.drawGeoMarker(t):r?this.removeRoute(t):this.drawRoute(t)}},y.removePlace=function(t,e){var n=this.places,i=t.id,r=n[i];r&&(r.setMap(null),r=null,delete n[i],e&&(this.destinationPlace=null))},y.drawRoute=function(t){var e,n,i,r,s=this.routes,o=t.id,a=t.positions.slice(0),u=[];if(!s.hasOwnProperty(o)||(e=s[o],n=e.data,n.updated_at!==t.updated_at)){for(e||(e=s[o]=this.addPolyline(t));i=a.shift();)r=i.gps,u.push(this.toLatLng(r[0],r[1]));e.setPath(u),e.data=t}},y.removeRoute=function(t){var e=this.routes,n=t.id,i=e[n];i&&(i.setMap(null),i=null,delete e[n])},y.addPolyline=function(t){var e=t.color&&t.color.split(",")||[],n="#"+(e.length?h(l(e[0]))+h(l(e[1]))+h(l(e[2])):"007BFF"),i=e[3]||1,r=new google.maps.Polyline({map:this.map,index:p-5,geodesic:!0,strokeColor:n,strokeWeight:4,strokeOpacity:i});return r},y.drawPlace=function(t,e){var n,i,r=this.places,s=t.id;if(r.hasOwnProperty(s)&&(n=r[s]),n||(n=r[s]=this.addPoint(t)),i=this.toLatLng(t.lat,t.lng),n.setPosition(i),n.data=t,e){var o=this.geoLocation,a=p,u=this.icons.destinationMarker;(!o||o&&0==o._status)&&this.panToDestination(i);var c=this.destinationPlace;if(c&&c!==n){var l=c.data;t.updated_at>l.updated_at?(t.id!=l.id&&(c.setIcon(this.icons.placeMarker),c.setZIndex(a-5)),this.destinationPlace=n):(a-=5,u=this.icons.placeMarker)}else this.destinationPlace=n;n.setIcon(u),n.setZIndex(a)}},y.monit=function(){var t,e,n,i,r,s,o,a,u=this.updated,c=this.breadcrumbs,l=this.icons,h=this.geoMarkers,p=this.tiplines,f=this.destinationPlace,d=this.geoLocation,m=this.myUserId,g=this.uid,v=Math.round(Date.now()/1e3);for(t in u)if(u.hasOwnProperty(t))if(n=u[t],e=m==t,a=Math.floor((v-n.t)/60),i=e?d:h[t],this.distanceMatrix(t,i,f,a),r=c[t],o=p[t],s=$('#identities-overlay .identity[data-uid="'+t+'"]').find(".icon"),g&&g==t&&this._breadcrumbs[g]&&this.showTextLabels(g,this._breadcrumbs[g].positions.slice(0),1>=a),1>=a){if(s.length&&(s.parent().removeClass("unknown"),s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-red"):s.attr("class","icon icon-dot-red")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#ff325b",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},repeat:"16px",offset:"0"}]}),e)continue;o&&o.setAttribute("stroke","#FF7E98"),i&&i.setIcon(l.dotRed)}else{if(s.length&&(s.parent().removeClass("unknown"),s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-grey"):s.attr("class","icon icon-dot-grey")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#7f7f7f",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},repeat:"16px",offset:"0"}]}),e)continue;o&&o.setAttribute("stroke","#b2b2b2"),i&&i.setIcon(l.dotGrey)}},y.toLatLng=function(t,e){return new google.maps.LatLng(1*t,1*e)},y.freshExfee=function(){this.controller&&this.controller.getExfee()},y.drawGeoMarker=function(t){var e,n,i,r,s=this.geoMarkers,o=t.id.split("@")[0];if(this.updatePositions(t),o!=this.myUserId){if(s.hasOwnProperty(o)){if(e=s[o],n=e.data,n.updated_at===t.updated_at)return}else this.freshExfee();e||(e=s[o]=this.addGeoMarker()),r=t.positions[0].gps,i=this.toLatLng(r[0],r[1]),e.setPosition(i),e.uid=o,e.data=t,this.updateTipline(o,i)}},y.updatePositions=function(t){var e=t.id.split("@")[0];this._breadcrumbs[e]?this._breadcrumbs[e].positions.unshift(t.positions[0]):this._breadcrumbs[e]=t,this.updated[e]=this._breadcrumbs[e].positions[0]},y.addGeoMarker=function(){var t=this,e=new google.maps.Marker({map:this.map,animation:2,zIndex:p-2,icon:this.icons.dotGrey,shape:{type:"circle",circle:[9,9,9]},optimized:!1});return google.maps.event.addListener(e,"mousedown",function(){t.showIdentityPanel(this.uid)}),e},y.distanceMatrix=function(t,e,n,i){i=i||0;var r=$('#identities-overlay .identity[data-uid="'+t+'"]'),o=r.find(".detial"),a=o.find(".icon"),l=o.find(".distance");if(e&&n){var h=e.getPosition(),p=n.getPosition(),f=h.lat(),d=h.lng(),m=p.lat(),g=p.lng(),v=s(m,g,f,d),y=u(m,g,f,d),w=c(v);w.rotate=y,l.html(w.text),a.css("-webkit-transform","rotate("+y+"deg)"),a.attr("class","icon icon-arrow-"+(1>=i?"red":"grey")),o.css("visibility","visible")}else e?(a.hasClass("icon-dot-red")||a.hasClass("icon-dot-red")||a.attr("class","icon icon-dot"+(1>=i?"red":"grey")),l.html(1>=i?"在线":(i>=9?"9+":i)+'<span class="unit">分钟前</span>'),o.css("visibility","visible")):o.css("visibility","hidden")},y.fitBoundsWithDestination=function(t){var e=this.destinationPlace,n=this.myUserId==t,i=n?this.geoLocation:this.geoMarkers[t];if(i){var r=i.getPosition(),s=this.map;if(e){var o,a=e.getPosition(),u=this.fromLatLngToContainerPixel(a);n?o=this.calculateBoundsByCenter(r,[a]):(o=new google.maps.LatLngBounds,50>u.x&&(u=this.fromContainerPixelToLatLng(new google.maps.Point(u.x-50,u.y)),o.extend(u)),o.extend(r),o.extend(a)),s.fitBounds(o)}else(n||!s.getBounds().contains(r))&&(7>s.getZoom()&&s.setZoom(15),s.panTo(r))}},y.panToDestination=function(t){var e=this.map;7>e.getZoom()&&e.setZoom(15),e.panTo(t||this.destinationPlace.getPosition())},y.calculateBoundsByCenter=function(t,e){for(var n,i,r,s=new google.maps.LatLngBounds,o=[];i=e.shift();)n=this.fromLatLngToContainerPixel(i),o.push(n);for(var a,u,r=this.fromLatLngToContainerPixel(t),c=0;u=o.shift();)a=Math.sqrt(Math.pow(u.x-r.x,2)+Math.pow(u.y-r.y,2)),a>c&&(c=a);var l=this.fromContainerPixelToLatLng(new google.maps.Point(r.x-c-50,r.y-c-50)),h=this.fromContainerPixelToLatLng(new google.maps.Point(r.x+c+50,r.y+c+50));return s.extend(l),s.extend(t),s.extend(h),s},y.addBreadcrumbs=function(){var t="#7f7f7f",e=.5,n=new google.maps.Polyline({map:this.map,visible:!1,index:p-5,strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:t,fillOpacity:e,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},fixedRotation:!0,repeat:"16px",offset:"0"}]});return n},y.MIN_PIXL=50,y.distanceMatrixPixl=function(t,e,n){n=n||50;var i=this.fromLatLngToContainerPixel(new google.maps.LatLng(t[0],t[1])),r=this.fromLatLngToContainerPixel(new google.maps.LatLng(e[0],e[1])),s=Math.sqrt(Math.pow(i.x-r.x,2)+Math.pow(i.y-r.y,2));return s>=n},y.showTextLabels=function(t,e,n){if(t){for(var i,r,s,o,a,u=Math.round(Date.now()/1e3),c=this.labels,l=this.map,h=e.slice(0),f=!0,d=0,m=120,g=0,y=0;s=h.shift();)if(o=10*Math.floor((u-s.t)/600),y!==o){if(y=o,o>m)break;a&&(f=this.distanceMatrixPixl(s.gps,a.gps)),o>d&&f&&(-1!=v.indexOf(o)||o>15)&&(d=o,i=c[g],i?r=i.marker:(r=new google.maps.Marker({map:l,zIndex:p-4,optimized:!1}),i=c[g]=new google.maps.TextLabel({map:l,zIndex:p-3}),i.marker=r),r&&(r.setPosition(this.toLatLng(s.gps[0],s.gps[1])),r.setIcon({path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:n?"#ff325b":"#7f7f7f",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5})),i.set("text",o+"分钟前"),a=s,g++)}for(var w=c.length-1;w>g;w--)i=c[w],i&&i.setMap(null),c.splice(w,1)}},y.removeTextLabels=function(){for(var t,e=this.labels;t=e.shift();)t.setMap(null);e.length=0},y.updateBreadcrumbs=function(t){var e,n,i,r,s=[];if(e=this._breadcrumbs[t]){var o=e.positions.slice(0),a=o.slice(0);if(this.showTextLabels(t,o),n=this.breadcrumbs[t]){for(;i=a.pop();)r=i.gps,s.push(this.toLatLng(r[0],r[1]));n.setPath(s)}}},y.showBreadcrumbs=function(t){if(this._breadcrumbs[t]){var e,n=this.breadcrumbs,i=this.uid,r=n[t];if(delete this.uid,r||(r=n[t]=this.addBreadcrumbs()),r&&this.updateBreadcrumbs(t),t!==i)e=n[i],e&&(e.setMap(null),delete n[i],e=null,this.removeTextLabels()),r&&(r.setVisible(!0),this.uid=t);else if(r){var s=!r.getVisible();r.setVisible(s),s?this.uid=t:(r.setMap(null),delete n[t],r=null,this.removeTextLabels())}console.log("current breadcrumbs",t)}},y.addPoint=function(t){var e=this,n=google.maps,r=this.map,s=this.myIdentity,o=new n.Marker({map:r,animation:2,zIndex:p-5,icon:new n.MarkerImage(t.icon||i+"/icons/mapmark",new n.Size(48,68),new n.Point(0,0),new n.Point(12,34),new n.Size(24,34))}),a=n.event;return a.addListener(o,"mousedown",function(t){if(t&&t.stop(),e.removeInfobox(this))return!1;var i=e.infobox=new n.InfoBox({content:e.infoWindowTemplate.replace("{{title}}",this.data.title).replace("{{description}}",this.data.description),maxWidth:200,pixelOffset:new n.Size(-100,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1,leftBoundary:60,zIndex:610,boxId:"place-editor",events:function(){var t=this;t.editing=!1,a.addDomListener(this.div_,"touchstart",function(){if(!t.editing){var e=this.querySelector(".info-windown"),n=this.querySelector(".title").innerHTML,i=this.querySelector(".description").innerHTML,r=document.createElement("input");r.type="text",r.value=n;var s=document.createElement("textarea");s.value=i,e.appendChild(r),e.appendChild(s),this.querySelector(".title").className="title hide",this.querySelector(".description").className="description hide",t.editing=!0}})}});i._marker=this,i.open(r,this),a.addListenerOnce(this,"mouseout",function(){if(i.editing){var t=i._marker.data,n=$("#place-editor input").val().trim(),r=$("#place-editor textarea").val().trim();if(n!==t.title||r!==t.description){t.title=n,t.description=r,t.updated_at=Math.round(Date.now()/1e3),t.updated_by=s.external_username+"@"+s.provider;for(var o=0,a=t.tags,u=a.length;u>o;++o)if("xplace"===a[o]){a.splice(o,1),this.setIcon(e.icons.placeMarker);break}e.controller.editPlace(t)}$("#place-editor input, #place-editor textarea").remove(),$("#place-editor .title").text(n).removeClass("hide"),$("#place-editor .description").text(r).removeClass("hide")}i.close(),delete i._marker,i=e.infobox=null})}),o},y.removeInfobox=function(t){var e,n=this.infobox;return n&&(e=n._marker,n.close(),delete n._marker,n=this.infobox=null,e===t)?!0:void 0},y.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',y.contains=function(){var t,e,n,i=this.map.getBounds(),r=google.maps,s=i.getSouthWest(),o=i.getNorthEast(),a=new r.LatLngBounds,u=this.geoMarkers,c=document.getElementById("identities")._ids||{};s=this.fromLatLngToContainerPixel(s),s=this.fromContainerPixelToLatLng(new r.Point(s.x+50,s.y)),a.extend(s),a.extend(o);for(t in u)e=u[t],n=e.getPosition(),this.containsOne(t,n,a,c);console.log("map zoom",this.map.getZoom())},y.containsOne=function(t,e,n,i,r){n||(n=this.map.getBounds()),i||(i=document.getElementById("identities")._ids||{}),n.contains(e)&&(r=i[t])?this.showTipline(t,r):this.hideTipline(t)},y.hideTiplines=function(){var t,e=this.tiplines;for(t in e)this.hideTipline(t)},y.updateTipline=function(t,e){var n=this.tiplines[t];n||(n=this.tiplines[t]=this.addTipline(t)),e&&this.containsOne(t,n._lastlatlng=e)},y.addTipline=function(){var t=document.createElementNS("http://www.w3.org/2000/svg","polyline");return t.setAttribute("fill","none"),t.setAttribute("stroke","#b2b2b2"),t.setAttribute("stroke-width",1),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),t.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(t),t},y.showTipline=function(t,e){var n,i=this.tiplines[t];if(i){var r=[e[1],e[2]],s=[r[0]+13,r[1]],o=[r.join(","),s.join(",")].join(" "),n=this.fromLatLngToContainerPixel(i._lastlatlng);i.setAttribute("points",o+" "+n.x+","+n.y),i.setAttributeNS(null,"display","block")}},y.hideTipline=function(t){var e=this.tiplines[t];e&&e.setAttributeNS(null,"display","none")},y.updateGeoLocation=function(t,e){var n,i,r=this.geoLocation;if(!r){r=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:p-1,visible:!0,animation:2,icon:this.icons.arrowGrey,shape:{type:"rect",rect:[0,0,22,22]},optimized:!1}),r._status=0;var s=JSON.parse(window.localStorage.getItem("position"));s&&(i=s.gps,r._status=1,n=this.toLatLng(1*i[0]+this.latOffset,1*i[1]+this.lngOffset),r.setPosition(n),this.map.setZoom(15),this.map.panTo(n))}e&&(i=e.gps,n=this.toLatLng(1*i[0]+this.latOffset,1*i[1]+this.lngOffset),r.setIcon(this.icons.arrowBlue),r.setPosition(n),2!==r._status&&(this.map.setZoom(15),this.map.panTo(n)),r._status=2),t&&(this.updated[t]=e||s),r._uid=t},y.switchGEOStyle=function(t){var e=this.geoLocation;e&&e.setIcon(this.icons["arrow"+(t?"Blue":"Grey")])},e});
>>>>>>> e73faff... fresh exfee
