define("routexmaps",function(t){"use strict";function e(e){e=this.options=e||{},this.svgLayer=this.options.svg,this.options.svg=null,this.routes={},this.locations={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},window._loadmaps_=function(e,n,i,r){return function o(){var s=google.maps,a=s.event;s.InfoBox=t("infobox");var u=e.icons;u.dotGrey=new s.MarkerImage("/static/img/map_dot_grey@2x.png",new s.Size(36,36),new s.Point(0,0),new s.Point(9,9),new s.Size(18,18)),u.dotRed=new s.MarkerImage("/static/img/map_dot_red@2x.png",new s.Size(36,36),new s.Point(0,0),new s.Point(9,9),new s.Size(18,18)),u.arrowBlue=new s.MarkerImage("/static/img/map_arrow_blue@2x.png",new s.Size(40,40),new s.Point(0,0),new s.Point(10,10),new s.Size(20,20)),u.arrowGrey=new s.MarkerImage("/static/img/map_arrow_g5@2x.png",new s.Size(40,40),new s.Point(0,0),new s.Point(10,10),new s.Size(20,20)),s.visualRefresh=!0,i.center=new s.LatLng(35.86166,104.195397),i.mapTypeId=s.MapTypeId.ROADMAP,i.disableDefaultUI=!0;var c=e.map=new s.Map(n,i),l=a.addListener(c,"tilesloaded",function(){a.addListener(c,"bounds_changed",function(){console.log("bounds_end",e.uid),a.trigger(c,"zoom_changed")}),a.addListener(c,"zoom_changed",function(){console.log("zoom_end"),e.contains()}),a.addListener(c,"drag",function(){console.log("drag")}),a.addDomListener(n,"touchstart",function(){console.log("touchstart",e.uid),a.clearListeners(n,"touchmove"),a.addDomListenerOnce(n,"touchmove",function(){console.log("touchmove"),e.hideTiplines()})}),a.removeListener(l)}),h=e.overlay=new s.OverlayView;h.draw=function(){},h.setMap(c),r(c),o=null}}(this,e.mapDiv,e.mapOptions,e.callback)}function n(t,e){var n=6371,i=(t.lat()-e.lat())*Math.PI/180,r=(t.lng()-e.lng())*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.lat()*Math.PI/180)*Math.cos(t.lat()*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2),s=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),a=n*s;return a}var i=t("store"),r=e.prototype;r.load=function(t){var e=document.createElement("script");e.type="text/javascript",e.onload=e.onerror=e.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(e.readyState)&&(e=e.onload=e.onerror=e.onreadystatechange=null,t&&t())},e.async=1,e.src=this.options.url,document.body.appendChild(e)},r.draw=function(t,e){if(console.log("type",t,e),"geomarks"===t){var n,i;for(e=e.slice(0);n=e.shift();)i=n.type,"route"===i||"location"===i&&this.updatePoint(n)}else if("breadcrumbs"===t)for(var r in e)this.updateBreadcrumbs(r,e[r])},r.fitBounds=function(t){if(console.log("fit bounds",t),t&&t.length){for(var e,n,i=this.geoMarkers,r=[];n=t.shift();)(e=i[n])&&r.push(e.getPosition());this.calBounds(r,this.geoLocation.getPosition())}},r.calBounds=function(t,e){var i,r,o,s,a=this.overlay.getProjection(),u=a.fromLatLngToContainerPixel(e),c=this.destinationLatlng,l=new google.maps.LatLngBounds,h=0;for(c&&t.push(c);i=t.shift();)r=n(i,e),console.log(r),r>h&&(h=r),l.extend(i);o=a.fromContainerPixelToLatLng(new google.maps.Point(u.x-h,u.y-h)),s=a.fromContainerPixelToLatLng(new google.maps.Point(u.x+h,u.y+h)),l.extend(o),l.extend(e),l.extend(s),this.map.fitBounds(l)},r.fitCenter=function(t){var e,n=(this.locations,new google.maps.LatLngBounds),i=0,r=[];t?(e=new google.maps.LatLng(t.latitude,t.longitude),i++):e=this.map.getCenter();var o=this.overlay;if(i>1){for(var s,a,u=[];a=r.shift();)s=o.getProjection().fromLatLngToContainerPixel(a),u.push(s);for(var c,l,h=o.getProjection().fromLatLngToContainerPixel(e),p=0;l=u.shift();)c=Math.sqrt(Math.pow(l.x-h.x,2)+Math.pow(l.y-h.y,2)),console.log(c,l.x,h.x,l.y,h.y),c>p&&(p=c);var f=o.getProjection().fromContainerPixelToLatLng(new google.maps.Point(h.x-p,h.y-p)),d=o.getProjection().fromContainerPixelToLatLng(new google.maps.Point(h.x+p,h.y+p));n.extend(f),n.extend(e),n.extend(d),this.map.fitBounds(n)}else this.map.panTo(e)},r.updateBreadcrumbs=function(t,e){if(console.log("update breadcrumbs",t),this.myuid===t)return!this.geoLocation&&this.updateGeoLocation(t,r),void 0;var n,i,r,o,s=this.breadcrumbs,a=[];for(e=e.slice(0),o=e[0];n=e.shift();)r=new google.maps.LatLng(n.latitude,n.longitude),a.push(r);i=s[t],i||(i=s[t]=this.addBreadcrumbs(t,e)),r=a[0],i.setPath(a),i._uid=t,i._position=e,this.updateIdentityGeoLocation(t,o,r),this.updateTipline(t,r)},r.updateIdentityGeoLocation=function(t,e,n){var i=this.geoMarkers,r=i[t];n||(n=new google.maps.LatLng(e.latitude,e.longitude)),r||(r=i[t]=this.addLastPoint()),r._location=e,r.setPosition(n),console.log(t,n.lat(),n.lng(),this.geoLocation),this.distancematrix(t)},r.addBreadcrumbs=function(){var t="#FF325B",e=.5,n=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:t,fillOpacity:e,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return n};var o=function(t,e,n,i){return n='<span class="unit">{{u}}</span>',t=Math.floor(t),i={text:"",status:0},30>t?(i.status=4,i.text="抵达"):i.text=1e3>t?t+n.replace("{{u}}","米"):9e3>t?(t/1e3+"").slice(0,3)+n.replace("{{u}}","公里"):"9+"+n.replace("{{u}}","公里"),i};return r.distancematrix=function(t){var e=this.geoMarkers[t],i=this.geoLocation;if(e&&i){var r=e.getPosition(),s=i.getPosition(),u=o(n(r,s));console.log("DistanceMatrixService",u,!!e,!!a),4===u.status?$('#identities-overlay .identity[data-uid="'+t+'"]').find(".distance").text(u.text):$('#identities-overlay .identity[data-uid="'+t+'"]').find(".distance").html(u.text)}},r.hideBreadcrumbs=function(t){var e=this.breadcrumbs[t];e&&e.setVisible(!1)},r.showBreadcrumbs=function(t){var e,n=this.breadcrumbs,i=this.uid,r=n[t];t!==i?(e=n[i],e&&e.setVisible(!1),r&&r.setVisible(!0)):r&&r.setVisible(!r.getVisible()),this.uid=t,console.log("showBreadcrumbs",i,t)},r.showGeoMarker=function(){},r.updatePolyline=function(t){var e,n,i,r,o=this.routes,s=[],a=t.created_by,u=t.positions.slice(0);for(n=o[a],n||(n=o[a]=this.addPolyline(t)),i=new google.maps.LatLngBounds;e=u.shift();)r=new google.maps.LatLng(e.latitude,e.longitude),i.extend(r),s.push(r);n._data=t,n._bounds=i,n.setPath(s),this.updateTipline(a,r)},r.addPolyline=function(t){var e=t.color.split(","),n="#"+(+e[0]).toString(16)+(+e[1]).toString(16)+(+e[2]).toString(16),i=e[3],r=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:n,fillOpacity:i,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return r},r.hasDestination=!1,r.updatePoint=function(t){var e,n,i,r,o,s=this.locations,a=t.id;if(n=s[a],n||(n=s[a]=this.addPoint(t)),e=new google.maps.LatLngBounds,i=new google.maps.LatLng(t.latitude,t.longitude),e.extend(i),n.setPosition(i),n.setVisible(!0),!this.hasDestination)for(r=t.tags.slice(0);o=r.shift();)if("destination"===o){n._type="destination",this.destinationLatlng=i,this.hasDestination=!0;break}console.log(a,i.lat(),i.lng(),n),n._data=t,n._bounds=e},r.addLastPoint=function(){var t=new google.maps.Marker({map:this.map,animation:3,zIndex:366,icon:this.icons.dotGrey});return t},r.addPoint=function(t){var e=this,n=google.maps,i=new n.Marker({map:this.map,animation:2,visible:!1,zIndex:233,icon:new google.maps.MarkerImage(t.icon,new google.maps.Size(48,68),new google.maps.Point(0,0),new google.maps.Point(12,34),new google.maps.Size(24,34))}),r=n.event;return r.addListener(i,"mousedown",function(i){if(console.log("marker mousedown",i),i&&i.stop(),e.removeInfobox(this))return!1;var o=e.infobox=new n.InfoBox({content:e.infoWindowTemplate.replace("{{title}}",t.title).replace("{{description}}",t.description),maxWidth:200,pixelOffset:new google.maps.Size(-80,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1});o.open(e.map,this),o._marker=this,r.addListenerOnce(this,"mouseout",function(t){console.log("mouseout",t),o.close(),o=e.infobox=null})}),i},r.removeInfobox=function(t){var e,n=this.infobox;return n&&(e=n._marker,n.close(),n=this.infobox=null,e===t)?!0:void 0},r.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',r.getPointsBounds=function(){var t,e=this.locations,n=new google.maps.LatLngBounds;for(t in e)n.union(e[t]._bounds);return n},r.contains=function(){var t,e,n,i=this.map.getBounds(),r=document.getElementById("identities")._ids||[],o=this.geoMarkers;console.log("contains",r);for(t in o)e=o[t],n=e.getPosition(),this.containsOne(t,n,i,r)},r.containsOne=function(t,e,n,i,r){n||(n=this.map.getBounds()),i||(i=document.getElementById("identities")._ids||[]),n.contains(e)&&(r=i[t])?this.showTipline(t,r):this.hideTipline(t)},r.hideTiplines=function(){var t,e=this.tiplines;for(t in e)this.hideTipline(t)},r.updateTipline=function(t,e){var n=this.tiplines[t];n||(n=this.tiplines[t]=this.addTipline(t)),e&&(n._lastlatlng=e,this.containsOne(t,e))},r.addTipline=function(t){console.log("tipline",t);var e=(this.breadcrumbs[t],document.createElementNS("http://www.w3.org/2000/svg","polyline"));return e.setAttribute("fill","none"),e.setAttribute("stroke","#FF7E98"),e.setAttribute("stroke-width",1),e.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),e.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(e),e},r.showTipline=function(t,e){var n,i=this.tiplines[t];if(i){var r=[e[1],e[2]],o=[r[0]+13,r[1]],s=[r.join(","),o.join(",")].join(" ");n=this.overlay.getProjection().fromLatLngToContainerPixel(i._lastlatlng),i.setAttribute("points",s+" "+n.x+","+n.y),i.setAttributeNS(null,"display","block")}},r.hideTipline=function(t){var e=this.tiplines[t];e&&e.setAttributeNS(null,"display","none")},r.updateGeoLocation=function(t,e){var n=this.geoLocation;if(!n){n=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:377,visible:!0,animation:2,icon:this.icons.arrowGrey}),n._uid=t;var r=i.get("last-latlng");r&&n.setPosition(new google.maps.LatLng(r.lat,r.lng))}e&&(n.setIcon(this.icons.arrowBlue),n.setPosition(new google.maps.LatLng(e.latitude,e.longitude)))},e});