define("routexmaps",function(t){"use strict";function e(t,e){this.div=t,this.status=!e}function n(e){e=this.options=e||{},this.mapDiv=this.options.mapDiv,this.canvas=this.options.canvas;var n=$(window).width(),s=$(window).height();this.canvas.width=2*n,this.canvas.height=2*s,this.canvas.style.width=n+"px",this.canvas.style.height=s+"px",this.ctx=this.canvas.getContext("2d"),this.DRAW_STATUS=!0,delete this.options.mapDiv,delete this.options.cavnas,this.latOffset=0,this.lngOffset=0,this.routes={},this.places={},this.tiplines={},this.lines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},this.updated={},this._breadcrumbs={},this.boundsOffset={left:50,top:0},this.labels=[],this.currPanel=null,window._loadmaps_=function(e,n,s,a){return function o(){var c=google.maps,u=c.event;c.TextLabel=t("maplabel"),c.GeoMarker=t("geomarker");var h=e.icons;h.dotGrey=new c.MarkerImage(i+"/static/img/map_dot_grey@2x.png",new c.Size(36,36),new c.Point(0,0),new c.Point(9,9),new c.Size(18,18)),h.dotRed=new c.MarkerImage(i+"/static/img/map_dot_red@2x.png",new c.Size(36,36),new c.Point(0,0),new c.Point(9,9),new c.Size(18,18)),h.placeMarker=new c.MarkerImage(r+"/icons/mapmark",new c.Size(48,68),new c.Point(0,0),new c.Point(12,34),new c.Size(24,34)),h.xplaceMarker=new c.MarkerImage(i+"/static/img/map_mark_diamond_blue@2x.png",new c.Size(48,68),new c.Point(0,0),new c.Point(12,34),new c.Size(24,34)),h.destinationMarker=new c.MarkerImage(i+"/static/img/map_mark_ring_blue@2x.png",new c.Size(48,68),new c.Point(0,0),new c.Point(12,34),new c.Size(24,34)),c.visualRefresh=!0,s.center=e.toLatLng(35.86166,104.195397),s.mapTypeId=c.MapTypeId.ROADMAP,s.disableDefaultUI=!0,s.minZoom=1;var l=e.map=new c.Map(n,s),p=e.overlay=new c.OverlayView;p.draw=function(){},p.setMap(l);var d=u.addListener(l,"idle",function(){u.addListener(l,"bounds_changed",function(){u.trigger(l,"zoom_changed")}),u.addListener(l,"zoom_changed",function(){e.contains(),e.DRAW_STATUS=!0}),u.addListener(l,"mousedown",function(t){t.stop(),e.hideMyPanel(),e.hideMapPanel()});var t,i;$(n).on("touchstart.maps",function(n){e.hideMyPanel(),e.hideMapPanel();var r=n.touches[0];t=r.pageX,i=r.pageY}).on("tap.maps",function(n){n.stopPropagation(),e.showNearBy({x:t,y:i})}),u.addDomListener(n,"touchstart",function(){e.DRAW_STATUS=!1,u.clearListeners(n,"touchmove"),u.clearListeners(n,"touchend"),u.addDomListenerOnce(n,"touchmove",function(){e.clearLines()}),u.addDomListenerOnce(n,"touchend",function(){e.DRAW_STATUS=!0})}),u.removeListener(d),a(l)});o=null}}(this,this.mapDiv,e.mapOptions,e.callback)}var i=window._ENV_.site_url,r=window._ENV_.apiv3_url,s=6378137,a=function(t,e,n,i){var r=s,a=(n-t)*Math.PI/180,o=(i-e)*Math.PI/180,c=Math.sin(a/2)*Math.sin(a/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2),u=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)),h=r*u;return h},o=function(t){return t*Math.PI/180},c=function(t){return 180*t/Math.PI},u=function(t,e,n,i){t=o(t),e=o(e),n=o(n),i=o(i);var r=i-e,s=Math.sin(r)*Math.cos(n),a=Math.cos(t)*Math.sin(n)-Math.sin(t)*Math.cos(n)*Math.cos(r),u=Math.atan2(s,a);return 0>u&&(u+=2*Math.PI),c(u)},h=function(t,e,n,i,r){return i='<span class="unit">{{u}}</span>',t=Math.floor(t),r={text:"",status:0,distance:t},30>t&&!e?(r.status=4,r.text="抵达"):r.text=1e3>t?t+i.replace("{{u}}","米"):99e3>t?Math.floor(t/1e3)+i.replace("{{u}}","公里"):"99+"+i.replace("{{u}}","公里"),r},l=function(t){return(1*t).toString(16)},p=function(t){return t+="",t+(t.length>1?"":"0")},d=610,f="route",g="location",m="xplace",v="destination",y="breadcrumbs",w=[0,1,3,5,10,15];e.prototype={hide:function(){var t=this.div;this.hideBefore&&this.hideBefore(),t.off(),this.status?t.remove():t.addClass("hide"),this.hideAfter&&this.hideAfter()}};var b=n.prototype;b.load=function(t){for(var e,n=document.getElementsByTagName("head")[0],i=["ditu.google.cn","maps.gstatic.com","mts0.google.com","mts1.google.com","maps.googleapis.com","mts0.googleapis.com","mts1.googleapis.com"],r=this.options.protocol;e=i.shift();){var s=document.createElement("link");s.rel="dns-prefetch",s.href=r+e,n.appendChild(s)}var a=document.createElement("script");"onload"in a?(a.onload=function(){a=a.onload=a.onerror=a.onreadystatechange=null,t&&t()},a.onerror=function(){a=a.onload=a.onerror=a.onreadystatechange=null}):a.onreadystatechange=function(){a=a.onload=a.onerror=a.onreadystatechange=null,/loaded|complete/.test(a.readyState)&&t&&t()},a.async=!0,a.src=this.options.url,document.body.appendChild(a)},b.show=function(){this.mapDiv.className="",this.canvas.className=""},b.fromContainerPixelToLatLng=function(t){return this.overlay.getProjection().fromContainerPixelToLatLng(t)},b.fromLatLngToContainerPixel=function(t){return this.overlay.getProjection().fromLatLngToContainerPixel(t)},b.infoWindowTemplate='<div id="place-editor" class="info-windown park"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',b.showPlacePanel=function(t){this.hideMapPanel();var n=this,i=this.places[t];if(i){var r=i.getPosition(),s=this.fromLatLngToContainerPixel(r),a=i.data,o=$(n.infoWindowTemplate.replace("{{title}}",a.title).replace("{{description}}",a.description||""));o.editing=!1,o.on("touchstart",".title, .description",function(){o.editing=!0;var t=o.find(".title"),e=o.find(".description"),n=t.text(),i=e.text(),r=document.createElement("input");r.type="text",r.value=n;var a=document.createElement("div");a.className="splitline",a.appendChild(r);var c=document.createElement("textarea");c.value=i;var u=document.createElement("div");u.className="splitline",u.appendChild(c),o.prepend(u),o.prepend(a),t.addClass("hide"),e.addClass("hide");var h=0,l=0,p=$(window).width(),d=$(window).height(),f=200,g=o.height();h=s.x-f/2,l=s.y-64-g/2,10>h&&(h=10),h+f>p-10&&(h=p-f-10),10>l&&(l=10),l+g>d-10&&(l=d-g-10),o.css({left:h,top:l,width:200})}),$("#routex").append(o);var c=0,u=0,h=$(window).width(),l=$(window).height(),p=o.width(),d=o.height();c=s.x-p/2,u=s.y-64-d/2,10>c&&(c=10),c+p>h-10&&(c=h-p-10),10>u&&(u=10),u+d>l-10&&(u=l-d-10),o.css({left:c,top:u,visibility:"visible"}),this.currPanel=new e(o),this.currPanel.hideBefore=function(){var t=n.myIdentity,e=this.div;if(e.editing){var i=e.find("input").val().trim(),r=e.find("textarea").val().trim();(i!==a.title||r!==a.description)&&(a.title=i,a.description=r,a.updated_at=Math.round(Date.now()/1e3),a.updated_by=t.external_username+"@"+t.provider,n.controller.editPlace(a)),e.find("input, .splitline").remove(),e.find(".title").text(i).removeClass("hide"),e.find(".description").text(r).removeClass("hide")}}}},b.showIdentityPanel=function(t,n){this.hideMapPanel();var i,r,s=this.geoMarkers[t],o=this.geoLocation,c=this.destinationPlace,l=$('#identities-overlay .identity[data-uid="'+t+'"]').data("identity"),p=$("#other-info"),d=Math.round(Date.now()/1e3);if(p.find(".name").text(l.name),s?(i=s.getPosition(),r=Math.floor((d-s.data.positions[0].t)/60)):r=2,r>1?(s?p.find(".update").removeClass("hide").find(".time").html(60>r?r+"分钟":Math.floor(r/60)+"小时"):p.find(".update").addClass("hide"),p.find(".please-update").attr("data-enu",l.external_username+"@"+l.provider).attr("data-name",l.name).attr("data-notification-identities",l.notification_identities.join(" ")).removeClass("hide")):(p.find(".update").addClass("hide"),p.find(".please-update").addClass("hide")),s&&c){var f=c.getPosition(),g=a(i.lat(),i.lng(),f.lat(),f.lng()),m=u(i.lat(),i.lng(),f.lat(),f.lng()),v=h(g,!0);p.find(".dest").removeClass("hide").find(".m").html(v.text+'<i class="icon icon-arrow-'+(r>1?"grey":"red")+'" style="-webkit-transform: rotate('+m+'deg)"></i>')}else p.find(".dest").addClass("hide");if(s&&o){var f=o.getPosition(),g=a(i.lat(),i.lng(),f.lat(),f.lng()),m=u(i.lat(),i.lng(),f.lat(),f.lng()),v=h(g,!0);p.find(".dest-me").removeClass("hide").find(".m").html(v.text+'<i class="icon icon-arrow-'+(r>1?"grey":"red")+'" style="-webkit-transform: rotate('+m+'deg)"></i>')}else p.find(".dest-me").addClass("hide");p.removeClass("hide");var y,w,b=$(window).width(),x=$(window).height(),k=p.height(),_=p.width();if(s){var S=this.fromLatLngToContainerPixel(i);y=S.x-_/2,w=S.y-k/2}else y=(b-_)/2,w=(x-k)/2;n?(y=50,w=n.top):(0>y&&(y=10),y+_>b&&(y=b-_-10),0>w&&(w=10),w+k>x&&(w=x-k-10)),p.css({left:y,top:w,visibility:"visible"}),this.currPanel=new e(p,!0),this.currPanel.hideAfter=function(){this.div.css({visibility:"hidden"})}},b.setOffset=function(t){this.latOffset=1*t.earth_to_mars_latitude,this.lngOffset=1*t.earth_to_mars_longitude},b.hideMyPanel=function(){$("#my-info").addClass("hide")},b.hideIdentityPanel=function(){$("#other-info").addClass("hide")};var x='<div id="nearby" class="info-windown"></div>',k='<div class="place-marker"><h4 class="title"></h4><div class="description"></div></div>',_='<div class="geo-marker clearfix"><img width="30" height="30" src="" alt="" /><div class="detial"><div class="name"></div><div class="status"></div></div></div>';return b.hideNearBy=function(){$("#nearby").remove()},b.distance48px=function(t,e){var n=this.fromLatLngToContainerPixel(t),i=Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));return 48>=i},b.showNearBy=function(t){if(this.currPanel)return this.currPanel.hide(),this.currPanel=null,void 0;if(t){var n,i,r,s,o=t,c=!1,u=(this.myUserId,this.places),l=this.geoMarkers,p=this.geoLocation,d=p&&p.getPosition(),f=this.destinationPlace,g=f&&f.getPosition(),m=Date.now()/1e3,v=0,y=0;Debugger.log("-----------------------",d,g);var w=$(x);for(var b in u)if(s=u[b],n=s.getPosition(),this.distance48px(n,o)){c||(c=!0),v++,i=b;var S=$(k);S.attr("data-id",s.data.id),S.find(".title").text(s.data.title),S.find(".description").text(s.data.description||""),w.append($('<div class="splitline"></div>').append(S))}for(var b in l)if(s=l[b],n=s.getPosition(),this.distance48px(n,o)){var M=$('#identities-overlay .identity[data-uid="'+b+'"]').data("identity");if(!M)continue;c||(c=!0),y++,r=b,s.data.id.split(".")[1];var S=$(_);S.find("img").attr("src",M.avatar_filename),S.find(".name").text(M.name),S.attr("data-uid",b);var E=s.data.positions[0],P=Math.floor((m-E.t)/60),T="",L="",O="";if(d){var I=h(a(n.lat(),n.lng(),d.lat(),d.lng()),!0);T=I.text}if(g){var I=h(a(n.lat(),n.lng(),g.lat(),g.lng()),!0);L=I.text}1>=P?(L&&(O+="<span>至目的地"+L+"</span>"),T&&(O+="<span>与您相距"+T+"</span>")):(O+=60>P?"<span>"+P+"分钟前</span>":"<span>"+Math.floor(P/60)+"小时前</span>",L&&(O+="<span>至目的地"+L+"</span>")),O&&S.find(".status").html(O),w.append($('<div class="splitline"></div>').append(S))}if(c)if(1===v&&0===y)this.showPlacePanel(i);else if(0===v&&1===y)this.showIdentityPanel(r);else{var N=$(window).width(),C=$(window).height();w.css({transform:"translate3d("+(N-200+50)/2+"px,"+(C-132)/2+"px, 0)","-webkit-transform":"translate3d("+(N-200+50)/2+"px,"+(C-132)/2+"px, 0)"}),$("#routex").append(w),this.currPanel=new e(w)}}},b.draw=function(t){var e,n,i=t.type,r=t.action,s=r&&"delete"===r,a=t.tags,o=a&&t.tags.slice(0);switch(Debugger.log(i,r,s,o,t),i){case g:var c=0;if(a)for(;e=o.shift();)e===m?c^=1:e===v&&(c^=2,n=e);s?this.removePlace(t,n===v):this.drawPlace(t,c);break;case f:var u;if(a)for(;e=o.shift();)if(e===y){u=!0;break}u?this.drawGeoMarker(t):s?this.removeRoute(t):this.drawRoute(t);break;case"command":}},b.drawBatch=function(t,e){if(this._init_draw=!!t.length,this._init_draw){for(var n=t.slice(0);e=t.shift();)this.draw(e);for(var i,r,s=new google.maps.LatLngBounds,a=[];e=n.shift();)if(i=e.type,r=null,i===g?r=[e.lat,e.lng]:i===f&&e.positions&&(r=e.positions[0].gps.slice(0,2)),r){var o=new google.maps.LatLng(r[0],r[1]);s.extend(o),a.push(o)}a.length&&(s=this.calculateBoundsByCenter(s.getCenter(),a),this.map.fitBounds(s))}},b.clearup=function(){var t,e=this.places;for(t in e)e[t].setMap(null),e[t]=null,delete e[t];var n=this.breadcrumbs;for(t in n)n[t].setMap(null),n[t]=null,delete n[t];var i=this.geoMarkers;for(t in i)i[t].setMap(null),i[t]=null,delete i[t];var r=this.routes;for(t in r)r[t].setMap(null),r[t]=null,delete r[t];this.destinationPlace=null,this.removeTextLabels();var s=this.lines;for(t in s)delete s[t];this.clearLines(),this.uid=null},b.removePlace=function(t,e){var n=this.places,i=t.id,r=n[i];if(r&&(r.setMap(null),r=null,delete n[i],e)){this.destinationPlace=null;var s=this.geoLocation;s&&s.toggleDsntCircle(!1)}},b.drawRoute=function(t){var e,n,i,r,s=this.routes,a=t.id,o=t.positions.slice(0),c=[];if(!s.hasOwnProperty(a)||(e=s[a],n=e.data,n.updated_at!==t.updated_at)){for(e||(e=s[a]=this.addPolyline(t));i=o.shift();)r=i.gps,c.push(this.toLatLng(r[0],r[1]));e.setPath(c),e.data=t}},b.removeRoute=function(t){var e=this.routes,n=t.id,i=e[n];i&&(i.setMap(null),i=null,delete e[n])},b.addPolyline=function(t){var e=t.color&&t.color.split(",")||[],n="#"+(e.length?p(l(e[0]))+p(l(e[1]))+p(l(e[2])):"007BFF"),i=e[3]||1,r=new google.maps.Polyline({map:this.map,index:d-5,geodesic:!0,strokeColor:n,strokeWeight:4,strokeOpacity:i});return r},b.drawPlace=function(t,e){var n,i,r=this.places,s=t.id;if(r.hasOwnProperty(s)&&(n=r[s]),n||(n=r[s]=this.addPoint(t)),i=this.toLatLng(t.lat,t.lng),n.setPosition(i),n.data=t,(1===e||3===e)&&(n.setIcon(this.icons.xplaceMarker),n.setZIndex(d-1)),2===e||3===e){var a=this.geoLocation,o=d,c=this.icons.destinationMarker;(!a||a&&0==a._status)&&(this._init_draw||this.panToDestination(i));var u=this.destinationPlace;if(u&&u!==n){var h=u.data;t.id!=h.id?(u.setIcon(this.icons.placeMarker),u.setZIndex(o-5),this.destinationPlace=n):(o=d-5,c=this.icons.placeMarker)}else this.destinationPlace=n;3!==e&&(n.setIcon(c),n.setZIndex(o))}if(!(e>=1&&3>=e)){var l=google.maps;t.icon?n.setIcon(new l.MarkerImage(t.icon,new l.Size(48,68),new l.Point(0,0),new l.Point(12,34),new l.Size(24,34))):n.setIcon(this.icons.placeMarker)}},b.monit=function(){var t,e,n,i,r,s,a,o,c=this.updated,u=this.breadcrumbs,h=this.icons,l=this.geoMarkers,p=this.lines,f=this.destinationPlace,g=this.geoLocation,m=this.myUserId,v=this.uid,y=Math.round(Date.now()/1e3);for(t in c)if(c.hasOwnProperty(t))if(n=c[t],e=m==t,o=Math.floor((y-n.t)/60),i=e?g:l[t],i||(i=this.drawGeoMarker(this._breadcrumbs[t])),this.distanceMatrix(t,i,f,o),r=u[t],a=p[t],s=$('#identities-overlay .identity[data-uid="'+t+'"]').find(".icon"),v&&v==t&&this._breadcrumbs[t]&&(this.updateBreadcrumbs(t),this.showTextLabels(t,this._breadcrumbs[t].positions.slice(0),1>=o)),1>=o){if(s.length&&(s.parent().removeClass("unknown"),s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-red"):s.attr("class","icon icon-dot-red")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#ff325b",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},repeat:"16px",offset:"0"}]}),e)continue;if(a&&(a[3]="#ff7e98"),i){i.setIcon(h.dotRed);var w=i.label;w&&(w.setMap(null),delete w.marker,delete i.label)}}else{if(s.length&&(s.parent().removeClass("unknown"),s.hasClass("icon-arrow-grey")||s.hasClass("icon-arrow-red")?s.attr("class","icon icon-arrow-grey"):s.attr("class","icon icon-dot-grey")),r&&r.setOptions({strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:"#7f7f7f",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},repeat:"16px",offset:"0"}]}),e)continue;if(a&&(a[3]="#b2b2b2"),i){i.setIcon(h.dotGrey);var w=i.label;w||(i.label=w=new google.maps.TextLabel({map:this.map,zIndex:d-3}),w.marker=i,w.noRemoveMarker=!0),60>o?w.set("text",o+"分钟前"):w.set("text",Math.floor(o/60)+"小时前")}}this.updateLines()},b.toLatLng=function(t,e){return new google.maps.LatLng(1*t,1*e)},b.freshExfee=function(){this.controller&&this.controller.getExfee()},b.drawGeoMarker=function(t){var e,n,i,r,s=this.geoMarkers,a=t.id.split(".")[1],o=t.action;if("save_to_history"===o&&this.updatePositions(t),this.updated[a]=t.positions[0],a!=this.myUserId){if(s.hasOwnProperty(a)){if(e=s[a],n=e.data,n.positions[0].gps.join(",")===t.positions[0].gps.join(","))return e.data=t,void 0}else $('#identities .identity[data-uid="'+a+'"]').length||this.freshExfee();e||(e=s[a]=this.addGeoMarker()),r=t.positions[0].gps,i=this.toLatLng(r[0],r[1]),e.setPosition(i),e.uid=a,e.data=t,this.containsOne(a,i)}},b.updatePositions=function(t){var e=t.id.split(".")[1];this._breadcrumbs[e]?this._breadcrumbs[e].positions.unshift(t.positions[0]):this._breadcrumbs[e]=t,this._breadcrumbs[e].length>100&&this._breadcrumbs[e].splice(100,this._breadcrumbs[e].length-100)},b.addGeoMarker=function(){var t=new google.maps.Marker({map:this.map,zIndex:d-2,icon:this.icons.dotGrey,shape:{type:"circle",circle:[9,9,9]},optimized:!1});return t},b.distanceMatrix=function(t,e,n,i){i=i||0;var r=$('#identities-overlay .identity[data-uid="'+t+'"]'),s=r.find(".detial"),o=s.find(".icon"),c=s.find(".distance");if(e&&n){var l=e.getPosition(),p=n.getPosition(),d=l.lat(),f=l.lng(),g=p.lat(),m=p.lng(),v=a(g,m,d,f),y=u(d,f,g,m),w=h(v);w.rotate=y,c.html(w.text),o.css("-webkit-transform","rotate("+y+"deg)"),o.attr("class","icon icon-arrow-"+(1>=i?"red":"grey")),s.css("visibility","visible")}else e?(o.hasClass("icon-dot-red")||o.hasClass("icon-dot-red")||o.attr("class","icon icon-dot"+(1>=i?"red":"grey")),c.html(1>=i?"在线":60>i?i+'<span class="unit">分钟</span>':Math.floor(i/60)+'<span class="unit">小时</span>'),s.css("visibility","visible")):this.updated[t]?(i=Math.floor((Date.now()/1e3-this.updated[t].t)/60),c.html(1>=i?"在线":60>i?i+'<span class="unit">分钟</span>':Math.floor(i/60)+'<span class="unit">小时</span>'),s.css("visibility","visible")):s.css("visibility","hidden")},b.fitBoundsWithDestination=function(t){this._init_draw=!1;var e=this.destinationPlace,n=this.myUserId==t,i=n?this.geoLocation:this.geoMarkers[t];if(i){var r=i.getPosition(),s=this.map;if(e){var a,o=e.getPosition(),c=this.fromLatLngToContainerPixel(o);n?a=this.calculateBoundsByCenter(r,[o]):(a=new google.maps.LatLngBounds,50>c.x&&(c=this.fromContainerPixelToLatLng(new google.maps.Point(c.x-50,c.y)),a.extend(c)),a.extend(r),a.extend(o)),s.fitBounds(a)}else(n||!s.getBounds().contains(r))&&(7>s.getZoom()&&s.setZoom(15),s.panTo(r))}},b.panToDestination=function(t){var e=this.map;7>e.getZoom()&&e.setZoom(15),e.panTo(t||this.destinationPlace.getPosition())},b.calculateBoundsByCenter=function(t,e){for(var n,i,r,s=new google.maps.LatLngBounds,a=[];i=e.shift();)n=this.fromLatLngToContainerPixel(i),a.push(n);for(var o,c,r=this.fromLatLngToContainerPixel(t),u=0;c=a.shift();)o=Math.sqrt(Math.pow(c.x-r.x,2)+Math.pow(c.y-r.y,2)),o>u&&(u=o);var h=this.fromContainerPixelToLatLng(new google.maps.Point(r.x-u-50,r.y-u-50)),l=this.fromContainerPixelToLatLng(new google.maps.Point(r.x+u+50,r.y+u+50));return s.extend(h),s.extend(t),s.extend(l),s},b.addBreadcrumbs=function(){var t="#7f7f7f",e=.5,n=new google.maps.Polyline({map:this.map,visible:!1,index:d-5,strokeOpacity:0,icons:[{icon:{path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:t,fillOpacity:e,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5},fixedRotation:!0,repeat:"16px",offset:"0"}]});return n},b.MIN_PIXL=50,b.distanceMatrixPixl=function(t,e,n){n=n||50;var i=this.fromLatLngToContainerPixel(new google.maps.LatLng(t[0],t[1])),r=this.fromLatLngToContainerPixel(new google.maps.LatLng(e[0],e[1])),s=Math.sqrt(Math.pow(i.x-r.x,2)+Math.pow(i.y-r.y,2));return s>=n},b.showTextLabels=function(t,e,n){if(t){for(var i,r,s,a,o,c=Math.round(Date.now()/1e3),u=this.labels,h=this.map,l=e.slice(0),p=!0,f=0,g=0,m=0,v=0;s=l.shift();)if(a=10*Math.floor((c-s.t)/600),m!==a&&(m=a,o&&(p=this.distanceMatrixPixl(s.gps,o.gps)),a>f&&p&&(-1!=w.indexOf(a)||a>15))){if(0===v){v=1;continue}f=a,i=u[g],i?r=i.marker:(r=new google.maps.Marker({map:h,zIndex:d-4,optimized:!1}),i=u[g]=new google.maps.TextLabel({map:h,zIndex:d-3}),i.marker=r),r&&(r.setPosition(this.toLatLng(s.gps[0],s.gps[1])),r.setIcon({path:"M0,0 a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 z",fillColor:n?"#ff325b":"#7f7f7f",fillOpacity:.5,strokeColor:"#fff",strokeOpacity:.66,strokeWeight:1,scale:.5})),60>a?i.set("text",a+"分钟前"):i.set("text",Math.floor(a/60)+"小时前"),o=s,g++}for(var y=u.length-1;y>g;y--)i=u[y],i&&(i.marker.setMap(null),i.setMap(null)),u.splice(y,1)}},b.removeTextLabels=function(){for(var t,e=this.labels;t=e.shift();)t.marker.setMap(null),t.setMap(null);e.length=0},b.updateBreadcrumbs=function(t){var e,n,i,r,s=[];if(e=this._breadcrumbs[t]){var a=e.positions.slice(0),o=a.slice(0);if(n=this.breadcrumbs[t]){for(;i=o.pop();)r=i.gps,s.push(this.toLatLng(r[0],r[1]));n.setPath(s)}}},b.hideMapPanel=function(){this.currPanel&&(this.currPanel.hide(),this.currPanel=null)},b.showBreadcrumbs=function(t){if(this.hideMyPanel(),this.hideMapPanel(),this.removeTextLabels(),this._breadcrumbs[t]){var e,n=this.breadcrumbs,i=this.uid,r=n[t];if(delete this.uid,r||(r=n[t]=this.addBreadcrumbs()),r&&this.updateBreadcrumbs(t),t!==i)e=n[i],e&&(e.setMap(null),delete n[i],e=null),r&&(r.setVisible(!0),this.uid=t);else if(r){var s=!r.getVisible();r.setVisible(s),s?this.uid=t:(r.setMap(null),delete n[t],r=null)}Debugger.log("current breadcrumbs",t)}},b.addPoint=function(t){var e=google.maps,n=this.map,i=(this.myIdentity,new e.Marker({map:n,zIndex:d-5,icon:new e.MarkerImage(t.icon||r+"/icons/mapmark",new e.Size(48,68),new e.Point(0,0),new e.Point(12,34),new e.Size(24,34))}));return i},b.contains=function(){var t,e,n,i=this.map.getBounds(),r=google.maps,s=i.getSouthWest(),a=i.getNorthEast(),o=new r.LatLngBounds,c=this.geoMarkers,u=document.getElementById("identities")._ids||{};s=this.fromLatLngToContainerPixel(s),s=this.fromContainerPixelToLatLng(new r.Point(s.x+50,s.y)),o.extend(s),o.extend(a);for(t in c)e=c[t],n=e.getPosition(),this.containsOne(t,n,o,u);Debugger.log("map zoom",this.map.getZoom())},b.containsOne=function(t,e,n,i,r){if(n||(n=this.map.getBounds()),i||(i=document.getElementById("identities")._ids||{}),n&&n.contains(e)&&(r=i[t])){var s=this.fromLatLngToContainerPixel(e),a=this.lines[t];a||(a=[]),a[0]=[r[1],r[2]],a[1]=[r[1]+13,r[2]],a[2]=[s.x,s.y],this.updateLine(t,a)}else this.removeLine(t)},b.clearLines=function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},b.removeLine=function(t){delete this.lines[t],this.updateLines()},b.updateLines=function(){if(this.DRAW_STATUS){this.clearLines();var t=this.lines;for(var e in t)this.addLine(e,t[e])}},b.updateLine=function(t,e){Debugger.dir("update line",e),this.lines[t]=e,this.updateLines()},b.addLine=function(t,e){var n=this.ctx;n.beginPath(),n.lineWidth=2,n.lineJoin=n.lineCap="round",n.moveTo(2*e[0][0],2*e[0][1]),n.lineTo(2*e[1][0],2*e[1][1]),n.lineTo(2*e[2][0],2*e[2][1]),n.strokeStyle=e[3]||"#b2b2b2",n.stroke()},b.updateGeoLocation=function(t,e){var n,i,r=this.geoLocation;if(!r){r=this.geoLocation=new google.maps.GeoMarker({id:"gp-smarker",width:22,height:22,map:this.map}),r._status=0;var s=JSON.parse(window.localStorage.getItem("position"));s&&(s=this.toMars(s,!0),i=s.gps,r._status=1,n=this.toLatLng(i[0],i[1]),r.setPosition(n),this._init_draw||(this.map.setZoom(15),this.map.panTo(n)))}e&&(e=this.toMars(e,!0),i=e.gps,n=this.toLatLng(i[0],i[1]),r.setStatus(!0),r.setPosition(n),2!==r._status&&(this._init_draw||(this.map.setZoom(15),this.map.panTo(n))),r._status=2),t&&(this.updated[t]=e||s);var a=this.destinationPlace;if(r.toggleDsntCircle(!!a),a){var o=a.getPosition(),c=u(n.lat(),n.lng(),o.lat(),o.lng());r.setDsntRotate(c)}r._uid=t},b.toMars=function(t,e){var n=t.gps,i={t:e?Math.floor(Date.now()/1e3):t.t,gps:[1*n[0]+this.latOffset,1*n[1]+this.lngOffset,n[2]]};return i},b.switchGEOStyle=function(t){var e=this.geoLocation;e&&e.setStatus(t)},n});