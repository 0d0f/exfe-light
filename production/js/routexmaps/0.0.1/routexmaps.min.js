define("routexmaps",function(e){"use strict";function t(t){t=this.options=t||{},this.svgLayer=this.options.svg,this.options.svg=null,this.routes={},this.locations={},this.tiplines={},this.breadcrumbs={},this.geoMarkers={},this.icons={},window._loadmaps_=function(t,i,n,r){return function a(){var s=google.maps,o=s.event;s.InfoBox=e("infobox");var l=t.icons;l.dotGrey=new s.MarkerImage("/static/img/map_dot_grey@2x.png",new s.Size(36,36),new s.Point(0,0),new s.Point(9,9),new s.Size(18,18)),l.dotRed=new s.MarkerImage("/static/img/map_dot_red@2x.png",new s.Size(36,36),new s.Point(0,0),new s.Point(9,9),new s.Size(18,18)),l.arrowBlue=new s.MarkerImage("/static/img/map_arrow_blue@2x.png",new s.Size(40,40),new s.Point(0,0),new s.Point(10,10),new s.Size(20,20)),l.arrowGrey=new s.MarkerImage("/static/img/map_arrow_g5@2x.png",new s.Size(40,40),new s.Point(0,0),new s.Point(10,10),new s.Size(20,20)),s.visualRefresh=!0,n.center=new s.LatLng(35.86166,104.195397),n.mapTypeId=s.MapTypeId.ROADMAP,n.disableDefaultUI=!0;var c=t.map=new s.Map(i,n),u=o.addListener(c,"tilesloaded",function(){o.addListener(c,"bounds_changed",function(){console.log("bounds_end",t.uid),o.trigger(c,"zoom_changed")}),o.addListener(c,"zoom_changed",function(){console.log("zoom_end"),t.contains()}),o.addListener(c,"drag",function(){console.log("drag")}),o.addDomListener(i,"touchstart",function(){console.log("touchstart",t.uid),o.clearListeners(i,"touchmove"),o.addDomListenerOnce(i,"touchmove",function(){console.log("touchmove"),t.hideTiplines()})}),o.removeListener(u)}),d=t.overlay=new s.OverlayView;d.draw=function(){},d.setMap(c),r(c),a=null}}(this,t.mapDiv,t.mapOptions,t.callback)}function i(e,t){var i=6371,n=(e.lat()-t.lat())*Math.PI/180,r=(e.lng()-t.lng())*Math.PI/180,a=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t.lat()*Math.PI/180)*Math.cos(e.lat()*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2),s=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),o=i*s;return o}var n=e("store"),r=t.prototype;r.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.onload=t.onerror=t.onreadystatechange=function(){/^(?:loaded|complete|undefined)$/.test(t.readyState)&&(t=t.onload=t.onerror=t.onreadystatechange=null,e&&e())},t.async=1,t.src=this.options.url,document.body.appendChild(t)},r.draw=function(e,t){if(console.log("type",e,t),"geomarks"===e){var i,n;for(t=t.slice(0);i=t.shift();)n=i.type,"route"===n||"location"===n&&this.updatePoint(i)}else if("breadcrumbs"===e)for(var r in t)this.updateBreadcrumbs(r,t[r])},r.fitBounds=function(e){if(console.log("fit bounds",e),e&&e.length){for(var t,i,n=this.geoMarkers,r=[];i=e.shift();)(t=n[i])&&r.push(t.getPosition());this.calBounds(r,this.geoLocation.getPosition())}},r.calBounds=function(e,t){var n,r,a,s,o=this.overlay.getProjection(),l=o.fromLatLngToContainerPixel(t),c=this.destinationLatlng,u=new google.maps.LatLngBounds,d=0;for(c&&e.push(c);n=e.shift();)r=i(n,t),console.log(r),r>d&&(d=r),u.extend(n);a=o.fromContainerPixelToLatLng(new google.maps.Point(l.x-d,l.y-d)),s=o.fromContainerPixelToLatLng(new google.maps.Point(l.x+d,l.y+d)),u.extend(a),u.extend(t),u.extend(s),this.map.fitBounds(u)},r.fitCenter=function(e){var t,i=(this.locations,new google.maps.LatLngBounds),n=0,r=[];e?(t=new google.maps.LatLng(e.latitude,e.longitude),n++):t=this.map.getCenter();var a=this.overlay;if(n>1){for(var s,o,l=[];o=r.shift();)s=a.getProjection().fromLatLngToContainerPixel(o),l.push(s);for(var c,u,d=a.getProjection().fromLatLngToContainerPixel(t),h=0;u=l.shift();)c=Math.sqrt(Math.pow(u.x-d.x,2)+Math.pow(u.y-d.y,2)),console.log(c,u.x,d.x,u.y,d.y),c>h&&(h=c);var p=a.getProjection().fromContainerPixelToLatLng(new google.maps.Point(d.x-h,d.y-h)),f=a.getProjection().fromContainerPixelToLatLng(new google.maps.Point(d.x+h,d.y+h));i.extend(p),i.extend(t),i.extend(f),this.map.fitBounds(i)}else this.map.panTo(t)},r.updateBreadcrumbs=function(e,t){if(console.log("update breadcrumbs",e),this.myuid===e)return!this.geoLocation&&this.updateGeoLocation(e,r),void 0;var i,n,r,a,s=this.breadcrumbs,o=[];for(t=t.slice(0),a=t[0];i=t.shift();)r=new google.maps.LatLng(i.latitude,i.longitude),o.push(r);n=s[e],n||(n=s[e]=this.addBreadcrumbs(e,t)),r=o[0],n.setPath(o),n._uid=e,n._position=t,this.updateIdentityGeoLocation(e,a,r),this.updateTipline(e,r)},r.updateIdentityGeoLocation=function(e,t,i){var n=this.geoMarkers,r=n[e];i||(i=new google.maps.LatLng(t.latitude,t.longitude)),r||(r=n[e]=this.addLastPoint()),r._location=t,r.setPosition(i),console.log(e,i.lat(),i.lng(),this.geoLocation),this.distancematrix(e)},r.addBreadcrumbs=function(){var e="#FF325B",t=.5,i=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:e,fillOpacity:t,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return i};var s=function(e,t,i,n){return i='<span class="unit">{{u}}</span>',e=Math.floor(e),n={text:"",status:0},30>e?(n.status=4,n.text="抵达"):n.text=1e3>e?e+i.replace("{{u}}","米"):9e3>e?(e/1e3+"").slice(0,3)+i.replace("{{u}}","公里"):"9+"+i.replace("{{u}}","公里"),n};return r.distancematrix=function(e){var t=this.geoMarkers[e],n=this.geoLocation;if(t&&n){var r=t.getPosition(),o=n.getPosition(),l=s(i(r,o));console.log("DistanceMatrixService",l,!!t,!!a),4===l.status?$('#identities-overlay .identity[data-uid="'+e+'"]').find(".distance").text(l.text):$('#identities-overlay .identity[data-uid="'+e+'"]').find(".distance").html(l.text)}},r.hideBreadcrumbs=function(e){var t=this.breadcrumbs[e];t&&t.setVisible(!1)},r.showBreadcrumbs=function(e){var t,i=this.breadcrumbs,n=this.uid,r=i[e];e!==n?(t=i[n],t&&t.setVisible(!1),r&&r.setVisible(!0)):r&&r.setVisible(!r.getVisible()),this.uid=e,console.log("showBreadcrumbs",n,e)},r.showGeoMarker=function(){},r.updatePolyline=function(e){var t,i,n,r,a=this.routes,s=[],o=e.created_by,l=e.positions.slice(0);for(i=a[o],i||(i=a[o]=this.addPolyline(e)),n=new google.maps.LatLngBounds;t=l.shift();)r=new google.maps.LatLng(t.latitude,t.longitude),n.extend(r),s.push(r);i._data=e,i._bounds=n,i.setPath(s),this.updateTipline(o,r)},r.addPolyline=function(e){var t=e.color.split(","),i="#"+(+t[0]).toString(16)+(+t[1]).toString(16)+(+t[2]).toString(16),n=t[3],r=new google.maps.Polyline({map:this.map,visible:!1,geodesic:!0,strokeOpacity:0,icons:[{icon:{path:"M0,0 a10,10 0 1,0 20,0 a10,10 0 1,0 -20,0 z",fillColor:i,fillOpacity:n,strokeColor:"#fff",strokeOpacity:.5,strokeWeight:1,scale:.5},repeat:"30px",offset:"0"}]});return r},r.hasDestination=!1,r.updatePoint=function(e){var t,i,n,r,a,s=this.locations,o=e.id;if(i=s[o],i||(i=s[o]=this.addPoint(e)),t=new google.maps.LatLngBounds,n=new google.maps.LatLng(e.latitude,e.longitude),t.extend(n),i.setPosition(n),i.setVisible(!0),!this.hasDestination)for(r=e.tags.slice(0);a=r.shift();)if("destination"===a){i._type="destination",this.destinationLatlng=n,this.hasDestination=!0;break}console.log(o,n.lat(),n.lng(),i),i._data=e,i._bounds=t},r.addLastPoint=function(){var e=new google.maps.Marker({map:this.map,animation:3,zIndex:366,icon:this.icons.dotGrey});return e},r.addPoint=function(e){var t=this,i=google.maps,n=new i.Marker({map:this.map,animation:2,visible:!1,zIndex:233,icon:new google.maps.MarkerImage(e.icon,new google.maps.Size(48,68),new google.maps.Point(0,0),new google.maps.Point(12,34),new google.maps.Size(24,34))}),r=i.event;return r.addListener(n,"mousedown",function(n){if(console.log("marker mousedown",n),n&&n.stop(),t.removeInfobox(this))return!1;var a=t.infobox=new i.InfoBox({content:t.infoWindowTemplate.replace("{{title}}",e.title).replace("{{description}}",e.description),maxWidth:200,pixelOffset:new google.maps.Size(-80,-38),boxClass:"park",closeBoxMargin:"",closeBoxURL:"",alignBottom:!0,enableEventPropagation:!1});a.open(t.map,this),a._marker=this,r.addListenerOnce(this,"mouseout",function(e){console.log("mouseout",e),a.close(),a=t.infobox=null})}),n},r.removeInfobox=function(e){var t,i=this.infobox;return i&&(t=i._marker,i.close(),i=this.infobox=null,t===e)?!0:void 0},r.infoWindowTemplate='<div class="info-windown"><h2 class="title">{{title}}</h2><div class="description">{{description}}</div></div>',r.getPointsBounds=function(){var e,t=this.locations,i=new google.maps.LatLngBounds;for(e in t)i.union(t[e]._bounds);return i},r.contains=function(){var e,t,i,n=this.map.getBounds(),r=document.getElementById("identities")._ids||[],a=this.geoMarkers;console.log("contains",r);for(e in a)t=a[e],i=t.getPosition(),this.containsOne(e,i,n,r)},r.containsOne=function(e,t,i,n,r){i||(i=this.map.getBounds()),n||(n=document.getElementById("identities")._ids||[]),i.contains(t)&&(r=n[e])?this.showTipline(e,r):this.hideTipline(e)},r.hideTiplines=function(){var e,t=this.tiplines;for(e in t)this.hideTipline(e)},r.updateTipline=function(e,t){var i=this.tiplines[e];i||(i=this.tiplines[e]=this.addTipline(e)),t&&(i._lastlatlng=t,this.containsOne(e,t))},r.addTipline=function(e){console.log("tipline",e);var t=(this.breadcrumbs[e],document.createElementNS("http://www.w3.org/2000/svg","polyline"));return t.setAttribute("fill","none"),t.setAttribute("stroke","#FF7E98"),t.setAttribute("stroke-width",1),t.setAttribute("style","-webkit-filter: drop-shadow(12px 12px 7px rgba(0,0,0,0.5));"),t.setAttributeNS(null,"display","none"),this.svgLayer.appendChild(t),t},r.showTipline=function(e,t){var i,n=this.tiplines[e];if(n){var r=[t[1],t[2]],a=[r[0]+13,r[1]],s=[r.join(","),a.join(",")].join(" ");i=this.overlay.getProjection().fromLatLngToContainerPixel(n._lastlatlng),n.setAttribute("points",s+" "+i.x+","+i.y),n.setAttributeNS(null,"display","block")}},r.hideTipline=function(e){var t=this.tiplines[e];t&&t.setAttributeNS(null,"display","none")},r.updateGeoLocation=function(e,t){var i=this.geoLocation;if(!i){i=this.geoLocation=new google.maps.Marker({map:this.map,zIndex:377,visible:!0,animation:2,icon:this.icons.arrowGrey}),i._uid=e;var r=n.get("last-latlng");r&&i.setPosition(new google.maps.LatLng(r.lat,r.lng))}t&&(i.setIcon(this.icons.arrowBlue),i.setPosition(new google.maps.LatLng(t.latitude,t.longitude)))},t});