define("photox",function(e){"use strict";var t,i=e("jquery"),n=e("rex"),a=e("bus"),s=e("api").request,r=e("dialog"),o=e("store"),l=e("xdialog").dialogs,c=e("handlebars");c.registerHelper("px_imported",function(e){return e>0?e:'<i class="ix-selected"></i>'});var d={getPhotoX:function(e,t){return s("photox_getPhotoX",{resources:{photox_id:e}},t)},browseSource:function(e,t,i,n,a,r){var o={},l={};return e&&(l.photox_id=e),t&&(l.identity_id=t),i&&(l.album_id=i),n&&(o.beforeSend=n),o.data=l,s("photox_borwseSource",o,a,r)},getPhoto:function(e,t){return s("photox_getPhoto",{data:{photo_id:e}},t)},add:function(e,t,i,n){var a={type:"POST",resources:{photox_id:e},data:t};return i&&(a.beforeSend=i),s("photox_add",a,n)},addAlbum:function(e,t,i,n,a){return d.add(e,{identity_id:t,album_id:i},n,a)},addStream:function(e,t,i,n,a){return d.add(e,{identity_id:t,ids:i},n,a)},addFeed:function(e,t,i){return d.add(e,{stream_id:t},i)},getLikes:function(e,t){return s("photox_getLikes",{resources:{photox_id:e}},t)},like:function(e,t){return s("photox_like",{type:"POST",data:{id:e}},t)},delAlbum:function(e,t,i,n,a){return s("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,album_id:i},beforeSend:n},a)},delPhotos:function(e,t,i,n,a){return s("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,photo_ids:i},beforeSend:n},a)}},u=function(){};t=u.prototype,t.has=function(){return!!this.uid&&!!this.gid},t.find=function(e){return n.indexOf(this.paths,e)},t.setUid=function(e){return this.uid=e,this},t.setGid=function(e){return this.gid=e,this},t.cd=function(e,t,i){this.paths||(this.paths=[]),t=t||1,this.paths=this.paths.slice(0,t);var n=this.find(e);return-1===n?this.paths.push(e):this.paths=this.paths.slice(0,n+1),i&&i(e,this),this},t.clear=function(e){return this.paths&&(this.paths.length=0),e&&e(),this},t.prev=function(e){var t=this.paths;t.pop(),e&&e(t[t.length-1],t)};var h=function(e,t,i){this.composition=e,this.selector=t,this.$element=e.$(t),this.providers=i,this.append(i)};t=h.prototype,t.liTmp='<li{{class}} data-provider="{{provider}}" data-iid="{{iid}}"><a href="#" class="hide-text""><i class="ix-provider ix-{{provider}}"></i></a></li>',t.badgeTmmp='<div class="badge badgex"></div>',t.generate=function(e){var t,i=this.liTmp,n="";for(e=e.split(" ");t=e.shift();)t=t.split(":"),n+=i.replace("{{class}}",+t[1]?"":' class="no-oauth"').replace(/\{\{provider\}\}/g,t[0]).replace("{{iid}}",t[1]);return n},t.append=function(e){this.$element.append(this.generate(e))},t.switch=function(e,t){var i=this.$element,n=i.find('[data-provider="'+e+'"]'),a=!0;return n.hasClass("active")?t||n.removeClass("active"):(i.find(".active").removeClass("active"),n.addClass("active"),a=!1),a},t.updateBadge=function(e,t){var n,a=this.$element.find('> [data-provider="'+e+'"]'),s=a.find(".badge");s.length?n=+s.text():(s=i(this.badgeTmmp),a.append(s),n=0),s.text(n+t)};var p=function(e,t){this.composition=e,this.selector=t,this.$element=e.$(t),this.initstatus=1};t=p.prototype,t.liTmp='<li data-iid="{{iid}}" data-eaid="{{aid}}"><a href="#">{{dir}}</a><span class="divider hidden"></span></li>',t.displayHome=function(e){var t=o.get("user").identities,i=n.find(t,function(t){return t.id===e?!0:void 0});this.$element.append(this.generate(e,"",i.name+"'s Dropbox")),this.initstatus=0},t.generate=function(e,t,i){return this.liTmp.replace("{{iid}}",e).replace("{{eaid}}",t).replace("{{dir}}",i)},t.show=function(e){var t=this.$element;this.initstatus&&this.displayHome(e),this.del(1),t.hasClass("hide")&&t.removeClass("hide")},t.del=function(e){var t=this.$element.find("li").slice(e-1);t.nextAll().remove(),t.find(".divider").addClass("hidden")},t.add=function(e,t){var n=i(this.generate(e,t,t));this.$element.append(n),n.prev().find(".divider").removeClass("hidden")},t.hide=function(){this.$element.addClass("hide")},t.toggle=function(e,t){e?this.show(t):this.hide()};var f=function(e,t){this.composition=e,this.selector=t,this.$albums=e.$(t),this.$parent=this.$albums.parent()};t=f.prototype,t.liAlbumTmp='{{#each albums}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-eaid="{{external_id}}" data-imported="{{imported}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">{{{px_imported imported}}}</div><div class="photo"><div class="album-figure"></div>{{#if artwork}}<figure><img alt="" src="{{artwork}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',t.liPhotoTmp='{{#each photos}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-imported="{{imported}}" data-epid="{{external_id}}" data-pid="{{id}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}"><i class="ix-selected"></i></div><div class="photo"><div class="photo-figure"></div>{{#if images.preview.url}}<figure><img alt="" src="{{images.preview.url}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',t.showAlbums=function(){var e=this.$albums,t=this.liAlbumTmp,i=this.composition,n=this,a=i.q;a.push(d.browseSource(i.cid,null,null,function(){i.emit("toggle-loading",!0)},function(a){i.emit("toggle-loading",!1);var s=a.albums.length,r=a.photos.length;if(s+r){var o=c.compile(t),l=o(a),d=n.genPhotosHTML(a);e.html(l+d)}else i.emit("toggle-error",!1,"albums")},function(e,t){i.emit("toggle-loading",!1),400===t?i.emit("toggle-error",!1,"albums"):i.emit("toggle-error",!1,"ajax")}))},t.genPhotosHTML=function(e){var t=c.compile(this.liPhotoTmp),i=t(e);return i},t.hideAlbums=function(){this.$albums.addClass("hide")},t.switchByProvider=function(e,t){this.$albums.removeClass("hide").children().each(function(){var e=i(this),n=e.attr("data-provider");e.toggleClass("hide",n!==t)})},t.showAllAlbums=function(){this.$albums.removeClass("hide").find(" > .hide").removeClass("hide")},t.startUL='<ul class="thumbnails photos hide">',t.endUL="</ul>",t.generate=function(e){var t=c.compile(this.liAlbumTmp),i=c.compile(this.liPhotoTmp),n=t(e),a=i(e);return this.startUL+n+a+this.endUL},t.showPhotos=function(e){var t;t=i(this.generate(e)),this.$albums.append(t),t.removeClass("hide"),this.$parent.append(t)},t.toggleBadge=function(e,t){var i=e.find(".badge");i.toggleClass("hide",t),i.hasClass("hide")?e.attr("data-imported","0"):(e.attr("data-imported","-2"),i.html('<i class="ix-selected"></i>'))},t.updateBadge=function(e,t,i){var n=this.$albums.find('[data-provider="'+e+'"]'),a=~~n.attr("data-imported");i?a=t:-1!==a&&(a+=t),n.attr("data-imported",a),n.find(".badge").text(a).toggleClass("hide",!a)};var m=e("panel"),g=m.extend({options:{template:'<div class="panel photox-panel" id="photox-panel"><div class="clearfix panel-header"><h3 class="pull-left title panel-title"><i class="ix-wall ix-wall-blue"></i>&nbsp;PhotoX</h3><ul class="pull-right nav nav-tabs"></ul></div><div class="panel-body"><ul class="breadcrumb hide"></ul><div class="errors hide"><div class="albums-error hide"><p class="title">Oops, no photo to share.</p><p>Import photos from your account above.</p><br /><p>Collects photos from a variety of your web accounts.</p><p>and share with everyone’s all together in the ·X·.</p></div><div class="photos-error hide"><p class="title">Album empty.</p></div><div class="ajax-error hide"><p class="title">Network error. Please try to reload.</p></div></div><div class="loading hide"><img alt="" width="32" height="32" src="/static/img/loading.gif" /></div><ul class="thumbnails albums"></ul></div><div class="panel-footer"><div class="detail"><span class="selected-nums">0</span> pics selected</div><div class="icon-resize"></div><button class="xbtn-import">Import</button></div></div>',parentNode:null,srcNode:null},init:function(){var e=this.options;this.cid=e.crossId,this.providers=e.providers,delete e.providers,this.navTabs=new h(this,".panel-header .nav-tabs",this.providers),this.breadcrumb=new p(this,".panel-body .breadcrumb"),this.thumbnails=new f(this,".panel-body .albums"),this.fs=new u,this.q=[],this.render(),this.listen()},listen:function(){var e=this,t=e.fs,s=e.cid,o=e.element,c=e.navTabs,u=e.thumbnails,h=e.breadcrumb,p=e.q,f=e.element.find(".loading");o.on("click.photox",".nav-tabs > li",function(t){t.preventDefault(),t.stopPropagation(),e.killAjaxs(),e.emit("toggle-loading",!1),e.emit("toggle-error",!0);var n=i(this),a=~~n.data("iid"),s=n.data("provider");if(a)c.switch(s)?(e.emit("show-albums"),h.toggle(!1)):e.emit("switch-provider",a,s),u.$albums.nextAll(".photos").remove();else{var o=new r(l.addidentity);o.render(),o.element.find(".oauth-"+s).trigger("click")}}),o.on("click.photox",".breadcrumb a",function(e){e.preventDefault()}),o.on("mousedown.photox",".thumbnails > li[data-eaid]",function(r){r.preventDefault();var o=i(this),l=o.data(),f=l.iid,m=l.provider,g=l.eaid,v=~~o.attr("data-imported"),y=0,b=setTimeout(function(){if(y=1,u.toggleBadge(o),-2!==v){if(0!==v&&-2!==v)return d.delAlbum(s,m,g,null,function(){o.attr("data-imported","0"),a.emit("update-photoxwidget")}),void 0;var e=function(){o.attr("data-imported","-1"),a.emit("update-photoxwidget")};"instagram"===m?i.when(d.browseSource(s,f,g)).then(function(t){var i=t.photos,a=n.map(i,function(e){return e.external_id});d.addStream(s,f,JSON.stringify(a),null,e)}):d.addAlbum(s,f,g,null,e)}},987);o.on("mouseup.photox",function(){if(clearTimeout(b),o.off("mouseup.photox"),!y){if(c.switch(m,!0),"dropbox"===m){h.toggle("dropbox"===m,f);var i=decodeURIComponent(g).split("/"),n=i.length;g=i[n-1],t.has()||t.setUid(f).setGid(m).cd("/"),t.cd(g,n,function(e){h.del(n),h.add(f,e)})}u.hideAlbums(),p.push(d.browseSource(s,f,g,function(){e.emit("toggle-loading",!0)},function(t){e.emit("toggle-loading",!1);var i=t.albums.length,n=t.photos.length,a=i+n;a?u.showPhotos(t,v):e.emit("toggle-error",!1,"photos")},function(t,i,n){i||"timeout"!==n||(e.emit("toggle-loading",!1),e.emit("toggle-error",!1,"ajax"))}))}})}),o.on("click.photox",".thumbnails > li[data-epid]",function(t){t.preventDefault(),t.stopPropagation();var r=i(this),o=r.data(),l=o.iid,c=o.provider,h=o.epid,p=r.attr("data-pid"),f='["'+p+'"]',m='["'+h+'"]',g=~~r.attr("data-imported");return-2!==g?(u.toggleBadge(r),0!==g&&-2!==g?(d.delPhotos(s,c,f,null,function(t){var i=r.parent(),s=i.children(),o=0,l=[];r.attr("data-pid",0),r.attr("data-imported",0),n.each(t.photox.photos,function(e){c===e.provider&&(o++,r=s.filter('[data-epid="'+e.external_id+'"]'),r.size()||l.push(e),r.attr("data-imported",1),r.attr("data-pid",e.id),r.find(".badge").removeClass("hide"))}),o&&i.append(u.genPhotosHTML({photos:l})),e.emit("update-albums-badge",c,o,!0),a.emit("update-photoxwidget")}),void 0):("instagram"===c&&d.addStream(s,l,m,null,function(t){var i=t.photox.photos,s=r.parent(),l=s.children(),d=0,h=[];n.each(i,function(e){c===e.provider&&(d++,r=l.filter('[data-epid="'+e.external_id+'"]'),r.size()||o.photos.push(e),r.attr("data-imported",1),r.attr("data-pid",e.id),r.find(".badge").removeClass("hide"))}),d&&(s.append(u.genPhotosHTML({photos:h})),e.emit("update-albums-badge",c,d,!0)),a.emit("update-photoxwidget")}),void 0)):void 0}),e.on("show-albums",function(){u.showAllAlbums()}),e.on("toggle-loading",function(e){f[(e?"remove":"add")+"Class"]("hide")}),e.on("toggle-error",function(e,t){var i=o.find(".errors").toggleClass("hide",e);t&&(i.children().addClass("hide"),"albums"===t?i.find(".albums-error").removeClass("hide"):"photos"===t?i.find(".photos-error").removeClass("hide"):i.find(".ajax-error").removeClass("hide"))}),e.on("update-albums-badge",function(e,t,i){u.updateBadge(e,t,i)}),e.on("switch-provider",function(e,i){"dropbox"===i&&t.clear().setUid(e).setGid(i).cd("/"),h.toggle("dropbox"===i,e),u.switchByProvider(e,i)})},showAfter:function(){var e=this.srcNode.offset();this.element.css({top:e.top,left:e.left-20}),this.thumbnails.showAlbums()},killAjaxs:function(e){for(;e=this.q.shift();)e.abort()},destory:function(){this.killAjaxs(),this.element.off(),this.element.remove(),this._destory()}});return g});