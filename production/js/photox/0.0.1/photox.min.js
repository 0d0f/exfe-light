define("photox",function(e){"use strict";var t=e("jquery"),n=e("rex"),r=e("api").request,i=e("config"),s=i.photo_providers,o=e("dialog"),u=e("store"),a=e("xdialog").dialogs,f=e("handlebars"),l;f.registerHelper("px_imported",function(e){return e>0?e:"√"});var c=function(e){if(e&&e.meta)switch(e.meta){case 400:return;case 401:return;case 403:return;case 404:return}},h={getPhotoX:function(e,t){return r("photox_getPhotoX",{resources:{photox_id:e}},t)},browseSource:function(e,t,n,i,s,o){var u={},a={};return e&&(a.photox_id=e),t&&(a.identity_id=t),n&&(a.album_id=n),i&&(u.beforeSend=i),u.data=a,r("photox_borwseSource",u,s,o)},getPhoto:function(e,t){return r("photox_getPhoto",{data:{photo_id:e}},t)},add:function(e,t,n,i){var s={type:"POST",resources:{photox_id:e},data:t};return n&&(s.beforeSend=n),r("photox_add",s,i)},addAlbum:function(e,t,n,r,i){return h.add(e,{identity_id:t,album_id:n},r,i)},addStream:function(e,t,n,r,i){return h.add(e,{identity_id:t,ids:n},r,i)},addFeed:function(e,t,n){return h.add(e,{stream_id:t},n)},getLikes:function(e,t){return r("photox_getLikes",{resources:{photox_id:e}},t)},like:function(e,t){return r("photox_like",{type:"POST",data:{id:e}},t)},delAlbum:function(e,t,n,i,s){return r("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,album_id:n}},i,s)},delPhotos:function(e,t,n,i,s){return r("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,photo_ids:n},beforeSend:i},s)}},p={_:{}};p.init=function(e){var t=this._,n;while(n=e.shift())t[n]=[]},p.add=function(e,t){var n=this._[e]},p.del=function(e,t){};var d=function(){};l=d.prototype,l.has=function(){return!!this.uid&&!!this.gid},l.find=function(e){return n.indexOf(this.paths,e)},l.setUid=function(e){return this.uid=e,this},l.setGid=function(e){return this.gid=e,this},l.cd=function(e,t,n){this.paths||(this.paths=[]),t=t||1,this.paths=this.paths.slice(0,t);var r=this.find(e);return-1===r?this.paths.push(e):this.paths=this.paths.slice(0,r+1),n&&n(e,this),this},l.clear=function(e){return this.paths&&(this.paths.length=0),e&&e(),this},l.prev=function(e){var t=this.paths;t.pop(),e&&e(t[t.length-1],t)};var v=function(e,t,n){this.composition=e,this.selector=t,this.$element=e.$(t),this.providers=n,this.append(n)};l=v.prototype,l.liTmp='<li{{class}} data-provider="{{provider}}" data-iid="{{iid}}"><a href="#" class="hide-text""><i class="ix-provider ix-{{provider}}"></i></a></li>',l.badgeTmmp='<div class="badge badgex"></div>',l.generate=function(e){var t=this.liTmp,n="",r;e=e.split(" ");while(r=e.shift())r=r.split(":"),n+=t.replace("{{class}}",+r[1]?"":' class="no-oauth"').replace(/\{\{provider\}\}/g,r[0]).replace("{{iid}}",r[1]);return n},l.append=function(e){this.$element.append(this.generate(e))},l.switch=function(e,t){var n=this.$element,r=n.find('[data-provider="'+e+'"]'),i=!0;return r.hasClass("active")?t||r.removeClass("active"):(n.find(".active").removeClass("active"),r.addClass("active"),i=!1),i},l.updateBadge=function(e,n){var r=this.$element.find('> [data-provider="'+e+'"]'),i=r.find(".badge"),s;i.length?s=+i.text():(i=t(this.badgeTmmp),r.append(i),s=0),i.text(s+n)};var m=function(e,t){this.composition=e,this.selector=t,this.$element=e.$(t),this.initstatus=1};l=m.prototype,l.liTmp='<li data-iid="{{iid}}" data-eaid="{{aid}}"><a href="#">{{dir}}</a><span class="divider hidden"></span></li>',l.displayHome=function(e){var t=u.get("user").identities,r=n.find(t,function(t){if(t.id===e)return!0});this.$element.append(this.generate(e,"",r.name+"'s Dropbox Photos")),this.initstatus=0},l.generate=function(e,t,n){return this.liTmp.replace("{{iid}}",e).replace("{{eaid}}",t).replace("{{dir}}",n)},l.show=function(e){var t=this.$element;this.initstatus&&this.displayHome(e),this.del(1),t.hasClass("hide")&&t.removeClass("hide")},l.del=function(e){var t=this.$element.find("li").slice(e-1);t.nextAll().remove(),t.find(".divider").addClass("hidden")},l.add=function(e,n){var r=t(this.generate(e,n,n));this.$element.append(r),r.prev().find(".divider").removeClass("hidden")},l.hide=function(){this.$element.addClass("hide")},l.toggle=function(e,t){e?this.show(t):this.hide()};var g=function(e,t){this.composition=e,this.selector=t,this.$albums=e.$(t),this.$parent=this.$albums.parent()};l=g.prototype,l.liAlbumTmp='{{#each albums}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-eaid="{{external_id}}" data-imported="{{imported}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">{{{px_imported imported}}}</div><div class="photo"><div class="album-figure"></div>{{#if artwork}}<figure><img alt="" src="{{artwork}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',l.liPhotoTmp='{{#each photos}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-imported="{{imported}}" data-epid="{{external_id}}" data-pid="{{id}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">√</div><div class="photo"><div class="photo-figure"></div>{{#if images.preview.url}}<figure><img alt="" src="{{images.preview.url}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',l.showAlbums=function(){var e=this.$albums,t=this.liAlbumTmp,n=this.liPhotoTmp,r=this.composition,i=this,s=r.q;s.push(h.getPhotoX(r.cid,function(e){})),s.push(h.browseSource(r.cid,null,null,function(){r.emit("toggle-loading",!0)},function(n){r.emit("toggle-loading",!1);var s=n.albums.length,o=n.photos.length;if(s+o){var u=f.compile(t),a=u(n),l=i.genPhotosHTML(n);e.html(a+l)}else r.emit("toggle-error",!1,"albums")},function(e,t){r.emit("toggle-loading",!1),t===400?r.emit("toggle-error",!1,"albums"):r.emit("toggle-error",!1,"ajax")}))},l.genPhotosHTML=function(e){var t=f.compile(this.liPhotoTmp),n=t(e);return n},l.hideAlbums=function(){this.$albums.addClass("hide")},l.switchByProvider=function(e,n){this.$albums.removeClass("hide").children().each(function(){var e=t(this),r=e.attr("data-provider");e.toggleClass("hide",r!==n)})},l.showAllAlbums=function(){this.$albums.removeClass("hide").find(" > .hide").removeClass("hide")},l.startUL='<ul class="thumbnails photos hide">',l.endUL="</ul>",l.generate=function(e){var t=f.compile(this.liAlbumTmp),n=f.compile(this.liPhotoTmp),r=t(e),i=n(e);return this.startUL+r+i+this.endUL},l.showPhotos=function(e,n){var r=e.albums.length|e.photos.length,i;i=t(this.generate(e)),this.$albums.append(i),i.removeClass("hide"),this.$parent.append(i)},l.toggleBadge=function(e,t){var n=e.find(".badge");n.toggleClass("hide",t),n.hasClass("hide")?e.attr("data-imported","0"):(e.attr("data-imported","-2"),n.text("√"))},l.updateBadge=function(e,t,n){var r=this.$albums.find('[data-provider="'+e+'"]'),i=~~r.attr("data-imported");n?i=t:i!==-1&&(i+=t),r.attr("data-imported",i),r.find(".badge").text(i).toggleClass("hide",!i)};var y=e("panel"),b=y.extend({options:{template:'<div class="panel photox-panel" id="photox-panel"><div class="clearfix panel-header"><h3 class="pull-left title panel-title">PhotoX</h3><ul class="pull-right nav nav-tabs"></ul></div><div class="panel-body"><ul class="breadcrumb hide"></ul><div class="errors hide"><div class="albums-error hide">Oops, no photo to share.<br />Link your accounts here to import. ↗</div><div class="photos-error hide">No photo found here.</div><div class="ajax-error hide">Network error. Please try to reload.</div></div><div class="loading hide"><img alt="" width="32" height="32" src="/static/img/loading.gif" /></div><ul class="thumbnails albums"></ul></div><div class="panel-footer"><div class="detail"><span class="selected-nums">0</span> pics selected</div><div class="icon-resize"></div><button class="xbtn-upload">Import</button></div></div>',parentNode:null,srcNode:null},init:function(){var e=this.options;this.cid=e.crossId,this.providers=e.providers,delete e.providers,this.navTabs=new v(this,".panel-header .nav-tabs",this.providers),this.breadcrumb=new m(this,".panel-body .breadcrumb"),this.thumbnails=new g(this,".panel-body .albums"),this.fs=new d,this.q=[],this.render(),this.listen()},listen:function(){var e=this,r=e.fs,i=e.cid,s=e.element,u=e.navTabs,f=e.thumbnails,l=e.breadcrumb,c=e.q,p=e.element.find(".loading");s.on("click.photox",".nav-tabs > li",function(n){n.preventDefault(),n.stopPropagation(),e.killAjaxs(),e.emit("toggle-loading",!1),e.emit("toggle-error",!0);var r=t(this),i=~~r.data("iid"),s=r.data("provider");if(i)u.switch(s)?(e.emit("show-albums"),l.toggle(!1)):e.emit("switch-provider",i,s),f.$albums.nextAll(".photos").remove();else{var c=new o(a.addidentity);c.render(),c.element.find(".oauth-"+s).trigger("click")}}),s.on("click.photox",".breadcrumb a",function(e){e.preventDefault()}),s.on("mousedown.photox",".thumbnails > li[data-eaid]",function(s){s.preventDefault();var o=t(this),a=o.data(),p=a.iid,d=a.provider,v=a.eaid,m=~~o.attr("data-imported"),g=0,y=setTimeout(function(){g=1,f.toggleBadge(o);if(m===-2)return;if(m!==0&&m!==-2){h.delAlbum(i,d,v,null,function(e){o.attr("data-imported","0")});return}var e=function(e){o.attr("data-imported","-1")};d==="instagram"?(console.log(d),t.when(h.browseSource(i,p,v)).then(function(t){var r=t.photos,s=n.map(r,function(e){return e.external_id});h.addStream(i,p,JSON.stringify(s),null,e)})):h.addAlbum(i,p,v,null,e)},987);o.on("mouseup.photox",function(t){clearTimeout(y),o.off("mouseup.photox");if(g)return;u.switch(d,!0);if(d==="dropbox"){l.toggle(d==="dropbox",p);var n=decodeURIComponent(v).split("/"),s=n.length;v=aids[s-1],r.has()||r.setUid(p).setGid(d).cd("/"),r.cd(v,s,function(e){l.del(s),l.add(iGid,e)})}f.hideAlbums(),c.push(h.browseSource(i,p,v,function(){e.emit("toggle-loading",!0)},function(t){e.emit("toggle-loading",!1);var n=t.albums.length,r=t.photos.length,i=n+r;i?f.showPhotos(t,m):e.emit("toggle-error",!1,"photos")},function(t,n,r){!n&&r==="timeout"&&(e.emit("toggle-loading",!1),e.emit("toggle-error",!1,"ajax"))}))})}),s.on("click.photox",".thumbnails > li[data-epid]",function(r){r.preventDefault(),r.stopPropagation();var s=t(this),o=s.data(),u=o.iid,a=o.provider,l=o.epid,c=s.attr("data-pid"),p='["'+c+'"]',d='["'+l+'"]',v=~~s.attr("data-imported");if(v===-2)return;f.toggleBadge(s);if(v!==0&&v!==-2){h.delPhotos(i,a,p,null,function(t){var r=s.parent(),i=r.children(),o=0,u=[];s.attr("data-pid",0),s.attr("data-imported",0),n.each(t.photox.photos,function(e){a===e.provider&&(o++,s=i.filter('[data-epid="'+e.external_id+'"]'),s.size()||u.push(e),s.attr("data-imported",1),s.attr("data-pid",e.id),s.find(".badge").removeClass("hide"))}),o&&r.append(f.genPhotosHTML({photos:u})),e.emit("update-albums-badge",a,o,!0)});return}a==="instagram"&&h.addStream(i,u,d,null,function(t){var r=t.photox.photos,i=s.parent(),u=i.children(),l=0,c=[];n.each(r,function(e){a===e.provider&&(l++,s=u.filter('[data-epid="'+e.external_id+'"]'),s.size()||o.photos.push(e),s.attr("data-imported",1),s.attr("data-pid",e.id),s.find(".badge").removeClass("hide"))}),l&&(i.append(f.genPhotosHTML({photos:c})),e.emit("update-albums-badge",a,l,!0))})}),e.on("show-albums",function(){f.showAllAlbums()}),e.on("update-tabs-bage",function(e,t){tabs.updateBadge(e,t)}),e.on("toggle-loading",function(e){p[(e?"remove":"add")+"Class"]("hide")}),e.on("toggle-error",function(e,t){var n=s.find(".errors").toggleClass("hide",e);t&&(n.children().addClass("hide"),t==="albums"?n.find(".albums-error").removeClass("hide"):t==="photos"?n.find(".photos-error").removeClass("hide"):n.find(".ajax-error").removeClass("hide"))}),e.on("update-albums-badge",function(e,t,n){f.updateBadge(e,t,n)}),e.on("switch-provider",function(e,t){t==="dropbox"&&r.clear().setUid(e).setGid(t).cd("/"),l.toggle(t==="dropbox",e),f.switchByProvider(e,t)})},showAfter:function(){var e=this.srcNode.offset();this.element.css({top:e.top,left:e.left-20}),this.thumbnails.showAlbums()},killAjaxs:function(e){while(e=this.q.shift())e.abort()},destory:function(){this.killAjaxs(),this.element.off(),this.element.remove(),this._destory()}});return b});