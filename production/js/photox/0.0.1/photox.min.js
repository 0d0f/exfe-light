define("photox",function(e){"use strict";var t=e("jquery"),n=e("rex"),r=e("bus"),i=e("api").request,s=e("config"),o=s.photo_providers,u=e("dialog"),a=e("store"),f=e("xdialog").dialogs,l=e("handlebars"),c;l.registerHelper("px_imported",function(e){return e>0?e:"√"});var h=function(e){if(e&&e.meta)switch(e.meta){case 400:return;case 401:return;case 403:return;case 404:return}},p={getPhotoX:function(e,t){return i("photox_getPhotoX",{resources:{photox_id:e}},t)},browseSource:function(e,t,n,r,s,o){var u={},a={};return e&&(a.photox_id=e),t&&(a.identity_id=t),n&&(a.album_id=n),r&&(u.beforeSend=r),u.data=a,i("photox_borwseSource",u,s,o)},getPhoto:function(e,t){return i("photox_getPhoto",{data:{photo_id:e}},t)},add:function(e,t,n,r){var s={type:"POST",resources:{photox_id:e},data:t};return n&&(s.beforeSend=n),i("photox_add",s,r)},addAlbum:function(e,t,n,r,i){return p.add(e,{identity_id:t,album_id:n},r,i)},addStream:function(e,t,n,r,i){return p.add(e,{identity_id:t,ids:n},r,i)},addFeed:function(e,t,n){return p.add(e,{stream_id:t},n)},getLikes:function(e,t){return i("photox_getLikes",{resources:{photox_id:e}},t)},like:function(e,t){return i("photox_like",{type:"POST",data:{id:e}},t)},delAlbum:function(e,t,n,r,s){return i("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,album_id:n},beforeSend:r},s)},delPhotos:function(e,t,n,r,s){return i("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,photo_ids:n},beforeSend:r},s)}},d={_:{}};d.init=function(e){var t=this._,n;while(n=e.shift())t[n]=[]},d.add=function(e,t){var n=this._[e]},d.del=function(e,t){};var v=function(){};c=v.prototype,c.has=function(){return!!this.uid&&!!this.gid},c.find=function(e){return n.indexOf(this.paths,e)},c.setUid=function(e){return this.uid=e,this},c.setGid=function(e){return this.gid=e,this},c.cd=function(e,t,n){this.paths||(this.paths=[]),t=t||1,this.paths=this.paths.slice(0,t);var r=this.find(e);return-1===r?this.paths.push(e):this.paths=this.paths.slice(0,r+1),n&&n(e,this),this},c.clear=function(e){return this.paths&&(this.paths.length=0),e&&e(),this},c.prev=function(e){var t=this.paths;t.pop(),e&&e(t[t.length-1],t)};var m=function(e,t,n){this.composition=e,this.selector=t,this.$element=e.$(t),this.providers=n,this.append(n)};c=m.prototype,c.liTmp='<li{{class}} data-provider="{{provider}}" data-iid="{{iid}}"><a href="#" class="hide-text""><i class="ix-provider ix-{{provider}}"></i></a></li>',c.badgeTmmp='<div class="badge badgex"></div>',c.generate=function(e){var t=this.liTmp,n="",r;e=e.split(" ");while(r=e.shift())r=r.split(":"),n+=t.replace("{{class}}",+r[1]?"":' class="no-oauth"').replace(/\{\{provider\}\}/g,r[0]).replace("{{iid}}",r[1]);return n},c.append=function(e){this.$element.append(this.generate(e))},c.switch=function(e,t){var n=this.$element,r=n.find('[data-provider="'+e+'"]'),i=!0;return r.hasClass("active")?t||r.removeClass("active"):(n.find(".active").removeClass("active"),r.addClass("active"),i=!1),i},c.updateBadge=function(e,n){var r=this.$element.find('> [data-provider="'+e+'"]'),i=r.find(".badge"),s;i.length?s=+i.text():(i=t(this.badgeTmmp),r.append(i),s=0),i.text(s+n)};var g=function(e,t){this.composition=e,this.selector=t,this.$element=e.$(t),this.initstatus=1};c=g.prototype,c.liTmp='<li data-iid="{{iid}}" data-eaid="{{aid}}"><a href="#">{{dir}}</a><span class="divider hidden"></span></li>',c.displayHome=function(e){var t=a.get("user").identities,r=n.find(t,function(t){if(t.id===e)return!0});this.$element.append(this.generate(e,"",r.name+"'s Dropbox Photos")),this.initstatus=0},c.generate=function(e,t,n){return this.liTmp.replace("{{iid}}",e).replace("{{eaid}}",t).replace("{{dir}}",n)},c.show=function(e){var t=this.$element;this.initstatus&&this.displayHome(e),this.del(1),t.hasClass("hide")&&t.removeClass("hide")},c.del=function(e){var t=this.$element.find("li").slice(e-1);t.nextAll().remove(),t.find(".divider").addClass("hidden")},c.add=function(e,n){var r=t(this.generate(e,n,n));this.$element.append(r),r.prev().find(".divider").removeClass("hidden")},c.hide=function(){this.$element.addClass("hide")},c.toggle=function(e,t){e?this.show(t):this.hide()};var y=function(e,t){this.composition=e,this.selector=t,this.$albums=e.$(t),this.$parent=this.$albums.parent()};c=y.prototype,c.liAlbumTmp='{{#each albums}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-eaid="{{external_id}}" data-imported="{{imported}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">{{{px_imported imported}}}</div><div class="photo"><div class="album-figure"></div>{{#if artwork}}<figure><img alt="" src="{{artwork}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',c.liPhotoTmp='{{#each photos}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-imported="{{imported}}" data-epid="{{external_id}}" data-pid="{{id}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">√</div><div class="photo"><div class="photo-figure"></div>{{#if images.preview.url}}<figure><img alt="" src="{{images.preview.url}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',c.showAlbums=function(){var e=this.$albums,t=this.liAlbumTmp,n=this.liPhotoTmp,r=this.composition,i=this,s=r.q;s.push(p.browseSource(r.cid,null,null,function(){r.emit("toggle-loading",!0)},function(n){r.emit("toggle-loading",!1);var s=n.albums.length,o=n.photos.length;if(s+o){var u=l.compile(t),a=u(n),f=i.genPhotosHTML(n);e.html(a+f)}else r.emit("toggle-error",!1,"albums")},function(e,t){r.emit("toggle-loading",!1),t===400?r.emit("toggle-error",!1,"albums"):r.emit("toggle-error",!1,"ajax")}))},c.genPhotosHTML=function(e){var t=l.compile(this.liPhotoTmp),n=t(e);return n},c.hideAlbums=function(){this.$albums.addClass("hide")},c.switchByProvider=function(e,n){this.$albums.removeClass("hide").children().each(function(){var e=t(this),r=e.attr("data-provider");e.toggleClass("hide",r!==n)})},c.showAllAlbums=function(){this.$albums.removeClass("hide").find(" > .hide").removeClass("hide")},c.startUL='<ul class="thumbnails photos hide">',c.endUL="</ul>",c.generate=function(e){var t=l.compile(this.liAlbumTmp),n=l.compile(this.liPhotoTmp),r=t(e),i=n(e);return this.startUL+r+i+this.endUL},c.showPhotos=function(e,n){var r=e.albums.length|e.photos.length,i;i=t(this.generate(e)),this.$albums.append(i),i.removeClass("hide"),this.$parent.append(i)},c.toggleBadge=function(e,t){var n=e.find(".badge");n.toggleClass("hide",t),n.hasClass("hide")?e.attr("data-imported","0"):(e.attr("data-imported","-2"),n.text("√"))},c.updateBadge=function(e,t,n){var r=this.$albums.find('[data-provider="'+e+'"]'),i=~~r.attr("data-imported");n?i=t:i!==-1&&(i+=t),r.attr("data-imported",i),r.find(".badge").text(i).toggleClass("hide",!i)};var b=e("panel"),w=b.extend({options:{template:'<div class="panel photox-panel" id="photox-panel"><div class="clearfix panel-header"><h3 class="pull-left title panel-title"><i class="ix-wall ix-wall-blue"></i>&nbsp;PhotoX</h3><ul class="pull-right nav nav-tabs"></ul></div><div class="panel-body"><ul class="breadcrumb hide"></ul><div class="errors hide"><div class="albums-error hide">Oops, no photo to share.<br />Link your accounts here to import. ↗</div><div class="photos-error hide">No photo found here.</div><div class="ajax-error hide">Network error. Please try to reload.</div></div><div class="loading hide"><img alt="" width="32" height="32" src="/static/img/loading.gif" /></div><ul class="thumbnails albums"></ul></div><div class="panel-footer"><div class="detail"><span class="selected-nums">0</span> pics selected</div><div class="icon-resize"></div><button class="xbtn-upload">Import</button></div></div>',parentNode:null,srcNode:null},init:function(){var e=this.options;this.cid=e.crossId,this.providers=e.providers,delete e.providers,this.navTabs=new m(this,".panel-header .nav-tabs",this.providers),this.breadcrumb=new g(this,".panel-body .breadcrumb"),this.thumbnails=new y(this,".panel-body .albums"),this.fs=new v,this.q=[],this.render(),this.listen()},listen:function(){var e=this,i=e.fs,s=e.cid,o=e.element,a=e.navTabs,l=e.thumbnails,c=e.breadcrumb,h=e.q,d=e.element.find(".loading");o.on("click.photox",".nav-tabs > li",function(n){n.preventDefault(),n.stopPropagation(),e.killAjaxs(),e.emit("toggle-loading",!1),e.emit("toggle-error",!0);var r=t(this),i=~~r.data("iid"),s=r.data("provider");if(i)a.switch(s)?(e.emit("show-albums"),c.toggle(!1)):e.emit("switch-provider",i,s),l.$albums.nextAll(".photos").remove();else{var o=new u(f.addidentity);o.render(),o.element.find(".oauth-"+s).trigger("click")}}),o.on("click.photox",".breadcrumb a",function(e){e.preventDefault()}),o.on("mousedown.photox",".thumbnails > li[data-eaid]",function(o){o.preventDefault();var u=t(this),f=u.data(),d=f.iid,v=f.provider,m=f.eaid,g=~~u.attr("data-imported"),y=0,b=setTimeout(function(){y=1,l.toggleBadge(u);if(g===-2)return;if(g!==0&&g!==-2){p.delAlbum(s,v,m,null,function(e){u.attr("data-imported","0"),r.emit("update-photoxwidget")});return}var e=function(e){u.attr("data-imported","-1"),r.emit("update-photoxwidget")};v==="instagram"?t.when(p.browseSource(s,d,m)).then(function(t){var r=t.photos,i=n.map(r,function(e){return e.external_id});p.addStream(s,d,JSON.stringify(i),null,e)}):p.addAlbum(s,d,m,null,e)},987);u.on("mouseup.photox",function(t){clearTimeout(b),u.off("mouseup.photox");if(y)return;a.switch(v,!0);if(v==="dropbox"){c.toggle(v==="dropbox",d);var n=decodeURIComponent(m).split("/"),r=n.length;m=aids[r-1],i.has()||i.setUid(d).setGid(v).cd("/"),i.cd(m,r,function(e){c.del(r),c.add(iGid,e)})}l.hideAlbums(),h.push(p.browseSource(s,d,m,function(){e.emit("toggle-loading",!0)},function(t){e.emit("toggle-loading",!1);var n=t.albums.length,r=t.photos.length,i=n+r;i?l.showPhotos(t,g):e.emit("toggle-error",!1,"photos")},function(t,n,r){!n&&r==="timeout"&&(e.emit("toggle-loading",!1),e.emit("toggle-error",!1,"ajax"))}))})}),o.on("click.photox",".thumbnails > li[data-epid]",function(i){i.preventDefault(),i.stopPropagation();var o=t(this),u=o.data(),a=u.iid,f=u.provider,c=u.epid,h=o.attr("data-pid"),d='["'+h+'"]',v='["'+c+'"]',m=~~o.attr("data-imported");if(m===-2)return;l.toggleBadge(o);if(m!==0&&m!==-2){p.delPhotos(s,f,d,null,function(t){var i=o.parent(),s=i.children(),u=0,a=[];o.attr("data-pid",0),o.attr("data-imported",0),n.each(t.photox.photos,function(e){f===e.provider&&(u++,o=s.filter('[data-epid="'+e.external_id+'"]'),o.size()||a.push(e),o.attr("data-imported",1),o.attr("data-pid",e.id),o.find(".badge").removeClass("hide"))}),u&&i.append(l.genPhotosHTML({photos:a})),e.emit("update-albums-badge",f,u,!0),r.emit("update-photoxwidget")});return}f==="instagram"&&p.addStream(s,a,v,null,function(t){var i=t.photox.photos,s=o.parent(),a=s.children(),c=0,h=[];n.each(i,function(e){f===e.provider&&(c++,o=a.filter('[data-epid="'+e.external_id+'"]'),o.size()||u.photos.push(e),o.attr("data-imported",1),o.attr("data-pid",e.id),o.find(".badge").removeClass("hide"))}),c&&(s.append(l.genPhotosHTML({photos:h})),e.emit("update-albums-badge",f,c,!0)),r.emit("update-photoxwidget")})}),e.on("show-albums",function(){l.showAllAlbums()}),e.on("update-tabs-bage",function(e,t){tabs.updateBadge(e,t)}),e.on("toggle-loading",function(e){d[(e?"remove":"add")+"Class"]("hide")}),e.on("toggle-error",function(e,t){var n=o.find(".errors").toggleClass("hide",e);t&&(n.children().addClass("hide"),t==="albums"?n.find(".albums-error").removeClass("hide"):t==="photos"?n.find(".photos-error").removeClass("hide"):n.find(".ajax-error").removeClass("hide"))}),e.on("update-albums-badge",function(e,t,n){l.updateBadge(e,t,n)}),e.on("switch-provider",function(e,t){t==="dropbox"&&i.clear().setUid(e).setGid(t).cd("/"),c.toggle(t==="dropbox",e),l.switchByProvider(e,t)})},showAfter:function(){var e=this.srcNode.offset();this.element.css({top:e.top,left:e.left-20}),this.thumbnails.showAlbums()},killAjaxs:function(e){while(e=this.q.shift())e.abort()},destory:function(){this.killAjaxs(),this.element.off(),this.element.remove(),this._destory()}});return w});