define("photox",function(e){"use strict";var t=e("jquery"),n=e("rex"),r=e("api").request,i=e("config"),s=i.photo_providers,o=e("dialog"),u=e("store"),a=e("xdialog").dialogs,f=e("handlebars"),l;f.registerHelper("px_imported",function(e){return e>0?e:"√"});var c=function(e){if(e&&e.meta)switch(e.meta){case 400:return;case 401:return;case 403:return;case 404:return}},h={getPhotoX:function(e,t){return r("photox_getPhotoX",{resources:{photox_id:e}},t)},browseSource:function(e,t,n,i,s,o){var u={},a={};return e&&(a.photox_id=e),t&&(a.identity_id=t),n&&(a.album_id=n),i&&(u.beforeSend=i),u.data=a,r("photox_borwseSource",u,s,o)},getPhoto:function(e,t){return r("photox_getPhoto",{data:{photo_id:e}},t)},add:function(e,t,n,i){var s={type:"POST",resources:{photox_id:e},data:t};return n&&(s.beforeSend=n),r("photox_add",s,i)},addAlbum:function(e,t,n,r,i){return h.add(e,{identity_id:t,album_id:n},r,i)},addStream:function(e,t,n,r,i,s){return h.add(e,{identity_id:t,min_id:n,max_id:r},i,s)},addFeed:function(e,t,n){return h.add(e,{stream_id:t},n)},getLikes:function(e,t){return r("photox_getLikes",{resources:{photox_id:e}},t)},like:function(e,t){return r("photox_like",{type:"POST",data:{id:e}},t)},delAlbum:function(e,t,n,i,s){return r("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,album_id:n}},i,s)}},p={_:{}};p.init=function(e){var t=this._,n;while(n=e.shift())t[n]=[]},p.add=function(e,t){var n=this._[e]},p.del=function(e,t){};var d=function(){};l=d.prototype,l.has=function(){return!!this.uid&&!!this.gid},l.find=function(e){return n.indexOf(this.paths,e)},l.setUid=function(e){return this.uid=e,this},l.setGid=function(e){return this.gid=e,this},l.cd=function(e,t,n){this.paths||(this.paths=[]),t=t||1,this.paths=this.paths.slice(0,t);var r=this.find(e);return-1===r?this.paths.push(e):this.paths=this.paths.slice(0,r+1),n&&n(e,this),this},l.clear=function(e){return this.paths&&(this.paths.length=0),e&&e(),this},l.prev=function(e){var t=this.paths;t.pop(),e&&e(t[t.length-1],t)};var v=function(e,t,n){this.composition=e,this.selector=t,this.$element=e.$(t),this.providers=n,this.append(n)};l=v.prototype,l.liTmp='<li{{class}} data-provider="{{provider}}" data-iid="{{iid}}"><a href="#" class="hide-text""><i class="ix-provider ix-{{provider}}"></i></a></li>',l.badgeTmmp='<div class="badge badgex"></div>',l.generate=function(e){var t=this.liTmp,n="",r;e=e.split(" ");while(r=e.shift())r=r.split(":"),n+=t.replace("{{class}}",+r[1]?"":' class="no-oauth"').replace(/\{\{provider\}\}/g,r[0]).replace("{{iid}}",r[1]);return n},l.append=function(e){this.$element.append(this.generate(e))},l.switch=function(e,t){var n=this.$element,r=n.find('[data-provider="'+e+'"]'),i=!0;return r.hasClass("active")?t||r.removeClass("active"):(n.find(".active").removeClass("active"),r.addClass("active"),i=!1),i},l.updateBadge=function(e,n){var r=this.$element.find('> [data-provider="'+e+'"]'),i=r.find(".badge"),s;i.length?s=+i.text():(i=t(this.badgeTmmp),r.append(i),s=0),i.text(s+n)};var m=function(e,t){this.composition=e,this.selector=t,this.$element=e.$(t),this.initstatus=1};l=m.prototype,l.liTmp='<li data-iid="{{iid}}" data-aid="{{aid}}"><a href="#">{{dir}}</a><span class="divider hidden"></span></li>',l.displayHome=function(e){var t=u.get("user").identities,r=n.find(t,function(t){if(t.id===e)return!0});this.$element.append(this.generate(e,"",r.name+"'s Dropbox Photos")),this.initstatus=0},l.generate=function(e,t,n){return this.liTmp.replace("{{iid}}",e).replace("{{aid}}",t).replace("{{dir}}",n)},l.show=function(e){var t=this.$element;this.initstatus&&this.displayHome(e),this.del(1),t.hasClass("hide")&&t.removeClass("hide")},l.del=function(e){var t=this.$element.find("li").slice(e-1);t.nextAll().remove(),t.find(".divider").addClass("hidden")},l.add=function(e,n){var r=t(this.generate(e,n,n));this.$element.append(r),r.prev().find(".divider").removeClass("hidden")},l.hide=function(){this.$element.addClass("hide")},l.toggle=function(e,t){e?this.show(t):this.hide()};var g=function(e,t){this.composition=e,this.selector=t,this.$albums=e.$(t),this.$parent=this.$albums.parent()};l=g.prototype,l.liAlbumTmp='{{#each albums}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-aid="{{external_id}}" data-imported="{{imported}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">{{{px_imported imported}}}</div><div class="photo"><div class="album-figure"></div>{{#if artwork}}<figure><img alt="" src="{{artwork}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',l.liPhotoTmp='{{#each photos}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-imported="{{imported}}" data-pid="{{external_id}}"><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">√</div><div class="photo"><div class="photo-figure"></div>{{#if images.preview.url}}<figure><img alt="" src="{{images.preview.url}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',l.showAlbums=function(){var e=this.$albums,t=this.liAlbumTmp,n=this.liPhotoTmp,r=this.composition,i=r.q;i.push(h.getPhotoX(r.cid,function(e){})),i.push(h.browseSource(r.cid,null,null,function(){r.emit("toggle-loading",!0)},function(i){r.emit("toggle-loading",!1);var s=i.albums.length,o=i.photos.length;if(s+o){var u=f.compile(t),a=u(i),l=f.compile(n),c=l(i);e.html(a+c)}else r.emit("toggle-error",!1,"albums")},function(){r.emit("toggle-loading",!1)}))},l.hideAlbums=function(){this.$albums.addClass("hide")},l.switchByProvider=function(e,n){this.$albums.removeClass("hide").children().each(function(){var e=t(this),r=e.attr("data-provider");e.toggleClass("hide",r!==n)})},l.showAllAlbums=function(){this.$albums.removeClass("hide").find(" > .hide").removeClass("hide")},l.startUL='<ul class="thumbnails photos hide">',l.endUL="</ul>",l.generate=function(e){var t=f.compile(this.liAlbumTmp),n=f.compile(this.liPhotoTmp),r=t(e),i=n(e);return this.startUL+r+i+this.endUL},l.showPhotos=function(e,n){var r=e.albums.length|e.photos.length,i;i=t(this.generate(e)),this.$albums.append(i),i.removeClass("hide"),this.$parent.append(i)},l.toggleBadge=function(e){var t=e.find(".badge");t.toggleClass("hide");if(t.hasClass("hide"))e.find(".ulm").remove(),e.attr("data-imported","0");else{var n="position: absolute; z-index: 300; right: 0; color: #fff; background: #444;";e.find(".thumbnail").prepend('<ul class="ulm" style="'+n+'"><li>Open</li><li class="import">Import</li></ul>'),e.attr("data-imported","-2"),t.text("√")}};var y=e("panel"),b=y.extend({options:{template:'<div class="panel photox-panel" id="photox-panel"><div class="clearfix panel-header"><h3 class="pull-left title panel-title">PhotoX</h3><ul class="pull-right nav nav-tabs"></ul></div><div class="panel-body"><ul class="breadcrumb hide"></ul><div class="errors hide"><div class="albums-error hide">Oops, no photo to share. Link your accounts here to import. ↗</div><div class="photos-error hide">No photo found here.</div></div><div class="loading hide"><img alt="" width="32" height="32" src="/static/img/loading.gif" /></div><ul class="thumbnails albums"></ul></div><div class="panel-footer"><div class="detail"><span class="selected-nums">0</span> pics selected</div><div class="icon-resize"></div><button class="xbtn-upload">Upload</button></div></div>',parentNode:null,srcNode:null},init:function(){var e=this.options;this.cid=e.crossId,this.providers=e.providers,delete e.providers,this.navTabs=new v(this,".panel-header .nav-tabs",this.providers),this.breadcrumb=new m(this,".panel-body .breadcrumb"),this.thumbnails=new g(this,".panel-body .albums"),this.fs=new d,this.render(),this.listen(),this.q=[]},listen:function(){var e=this,n=e.fs,r=e.cid,i=e.element,s=e.navTabs,u=e.thumbnails,f=e.breadcrumb,l=e.element.find(".loading"),c=0,p;i.on("click.photox",".nav-tabs > li",function(n){n.preventDefault(),n.stopPropagation(),e.emit("toggle-error",!0);var r=t(this),i=~~r.data("iid"),l=r.data("provider");if(i)s.switch(l)?(e.emit("show-albums"),f.toggle(!1)):e.emit("switch-provider",i,l),u.$albums.nextAll(".photos").remove();else{var c=new o(a.addidentity);c.render(),c.element.find(".oauth-"+l).trigger("click")}}),i.on("click.photox",".breadcrumb a",function(e){e.preventDefault()}),i.on("click.photox",".thumbnails > li[data-aid]",function(i){i.preventDefault();var o=t(this),a=o.data("iid"),l=o.data("provider"),d=o.data("aid"),v=~~o.attr("data-imported");c++;if(c===1)p=setTimeout(function(){u.toggleBadge(o),v!==0&&v!==-2&&h.delAlbum(r,l,d,function(){},function(e){o.attr("data-imported","0")}),c=0},233);else{clearTimeout(p),s.switch(l,!0);if(l==="dropbox"){f.toggle(l==="dropbox",a);var m=decodeURIComponent(d).split("/"),g=m.length;d=m[g-1],n.has()||n.setUid(a).setGid(l).cd("/"),n.cd(d,g,function(e){f.del(g),f.add(iGid,e)})}u.hideAlbums(),h.browseSource(r,a,d,function(){e.emit("toggle-loading",!0)},function(t){e.emit("toggle-loading",!1);var n=t.albums.length,r=t.photos.length,i=n+r;i?u.showPhotos(t,v):e.emit("toggle-error",!1,"photos")}),c=0}}),i.on("click.photox",".ulm li.import",function(e){var n=t(this),i=n.parents(".thumbnail").parent("li"),s=i.data("iid"),o=i.data("provider"),u=i.data("aid");e.preventDefault(),e.stopPropagation(),o==="instagram"?t.when(h.browseSource(r,s,u)).then(function(e){var t=e.photos,o=t[0],u=t[t.length-1];h.addStream(r,s,u.external_id,o.external_id,null,function(e){n.parent().remove(),i.attr("data-imported","-1")})}):h.addAlbum(r,s,u,null,function(e){n.parent().remove(),i.attr("data-imported","-1")})}),i.on("click.photox",".thumbnails > li[data-pid]",function(e){}),e.on("show-albums",function(){u.showAllAlbums()}),e.on("update-tabs-bage",function(e,t){tabs.updateBadge(e,t)}),e.on("toggle-loading",function(e){l[(e?"remove":"add")+"Class"]("hide")}),e.on("toggle-error",function(e,t){var n=i.find(".errors").toggleClass("hide",e);t&&(n.children().addClass("hide"),t==="albums"?n.find(".albums-error").removeClass("hide"):n.find(".photos-error").removeClass("hide"))}),e.on("switch-provider",function(e,t){t==="dropbox"&&n.clear().setUid(e).setGid(t).cd("/"),f.toggle(t==="dropbox",e),u.switchByProvider(e,t)})},showAfter:function(){var e=this.srcNode.offset();this.element.css({top:e.top,left:e.left-20}),this.thumbnails.showAlbums()},destory:function(){var e;while(e=this.q.shift())e.abort();this.element.off(),this.element.remove(),this._destory()}});return b});