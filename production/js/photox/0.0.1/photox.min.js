define("photox",function(e){"use strict";var t=e("api"),n=e("jquery"),r=e("rex"),i=t.request,s=e("config"),o=s.photo_providers,u=e("dialog"),a=e("store"),f=e("xdialog").dialogs,l=e("handlebars"),c,h=function(e){if(e&&e.meta)switch(e.meta){case 400:return;case 401:return;case 403:return;case 404:return}},p={getPhotoX:function(e,t){return i("photox_getPhotoX",{resources:{photox_id:e}},t)},browseSource:function(e,t,n,r,s){var o={},u={};return e&&(u.identity_id=e),t&&(u.album_id=t),n&&(o.beforeSend=n),o.data=u,i("photox_borwseSource",o,r,s)},getPhoto:function(e,t){return i("photox_getPhoto",{data:{photo_id:e}},t)},add:function(e,t,n,r){var s={type:"POST",resources:{photox_id:e},data:t};return n&&(s.beforeSend=n),i("photox_add",s,r)},addAlbum:function(e,t,n,r,i){return p.add(e,{identity_id:t,album_id:n},r,i)},addStream:function(e,t,n,r,i,s){return p.add(e,{identity_id:t,min_id:n,max_id:r},i,s)},addFeed:function(e,t,n){return p.add(e,{stream_id:t},n)},getLikes:function(e,t){return i("photox_getLikes",{resources:{photox_id:e}},t)},like:function(e,t){return i("photox_like",{type:"POST",data:{id:e}},t)},delAlbum:function(e,t,n,r,s){return i("photox_del",{type:"POST",resources:{photox_id:e},data:{provider:t,album_id:n}},r,s)}},d={_:{}};d.init=function(e){var t=this._,n;while(n=e.shift())t[n]=[]},d.add=function(e,t){var n=this._[e]},d.del=function(e,t){};var v=function(){};c=v.prototype,c.has=function(){return!!this.uid&&!!this.gid},c.find=function(e){return r.indexOf(this.paths,e)},c.setUid=function(e){return this.uid=e,this},c.setGid=function(e){return this.gid=e,this},c.cd=function(e,t,n){this.paths||(this.paths=[]),t=t||1,this.paths=this.paths.slice(0,t);var r=this.find(e);return-1===r?this.paths.push(e):this.paths=this.paths.slice(0,r+1),n&&n(e,this),this},c.clear=function(e){return this.paths&&(this.paths.length=0),e&&e(),this},c.prev=function(e){var t=this.paths;t.pop(),e&&e(t[t.length-1],t)};var m=function(e,t,n){this.composition=e,this.selector=t,this.$element=e.$(t),this.providers=n,this.append(n)};c=m.prototype,c.liTmp='<li data-provider="{{provider}}" data-iid="{{iid}}"><a href="#" class="hide-text""><i class="ix-provider ix-{{provider}}"></i></a></li>',c.badgeTmmp='<div class="badge badgex"></div>',c.generate=function(e){var t=this.liTmp,n="",r;e=e.split(" ");while(r=e.shift())r=r.split(":"),n+=t.replace(/\{\{provider\}\}/g,r[0]).replace(/\{\{iid\}\}/,r[1]);return n},c.append=function(e){this.$element.append(this.generate(e))},c.switch=function(e,t){var n=this.$element,r=n.find('[data-provider="'+e+'"]'),i=!0;return r.hasClass("active")?t||r.removeClass("active"):(n.find(".active").removeClass("active"),r.addClass("active"),i=!1),i},c.updateBadge=function(e,t){var r=this.$element.find('> [data-provider="'+e+'"]'),i=r.find(".badge"),s;i.length?s=+i.text():(i=n(this.badgeTmmp),r.append(i),s=0),i.text(s+t)};var g=function(e,t){this.composition=e,this.selector=t,this.$element=e.$(t),this.initstatus=1};c=g.prototype,c.liTmp='<li data-iid="{{iid}}" data-aid="{{aid}}"><a href="#">{{dir}}</a><span class="divider hidden"></span></li>',c.displayHome=function(e){var t=a.get("user").identities,n=r.find(t,function(t){if(t.id===e)return!0});this.$element.append(this.generate(e,"",n.name+"'s Dropbox Photos")),this.initstatus=0},c.generate=function(e,t,n){return this.liTmp.replace("{{iid}}",e).replace("{{aid}}",t).replace("{{dir}}",n)},c.show=function(e){var t=this.$element;this.initstatus&&this.displayHome(e),this.del(1),t.hasClass("hide")&&t.removeClass("hide")},c.del=function(e){var t=this.$element.find("li").slice(e-1);t.nextAll().remove(),t.find(".divider").addClass("hidden")},c.add=function(e,t){var r=n(this.generate(e,t,t));this.$element.append(r),r.prev().find(".divider").removeClass("hidden")},c.hide=function(){this.$element.addClass("hide")},c.toggle=function(e,t){e?this.show(t):this.hide()};var y=function(e,t){this.composition=e,this.selector=t,this.$albums=e.$(t),this.$parent=this.$albums.parent()};c=y.prototype,c.liAlbumTmp='{{#each albums}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-aid="{{external_id}}" {{#if imported}}data-status="added"{{/if}}><div class="thumbnail"><div class="badge album-badge badgex {{#unless imported}}hide{{/unless}}">√</div><div class="photo"><div class="album-figure"></div>{{#if artwork}}<figure><img alt="" src="{{artwork}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',c.liPhotoTmp='{{#each photos}}<li data-provider="{{provider}}" data-iid="{{by_identity.id}}" data-pid="{{external_id}}"><div class="thumbnail"><div class="badge album-badge badgex hide">√</div><div class="photo"><div class="photo-figure"></div>{{#if images.preview.url}}<figure><img alt="" src="{{images.preview.url}}" width="70" height="70" />{{else}}<figure class="placeholder ix-placehoder">{{/if}}</figure></div><h4 class="name">{{caption}}</h4></div></li>{{/each}}',c.showAlbums=function(){var e=this.$albums,t=this.liAlbumTmp,n=this.liPhotoTmp,r=this.composition;p.getPhotoX(r.cid,function(e){}),p.browseSource(null,null,function(){r.emit("toggle-loading",!0)},function(i){r.emit("toggle-loading",!1);var s=l.compile(t),o=s(i),u=l.compile(n),a=u(i);e.html(o+a)},function(){r.emit("toggle-loading",!1)})},c.hideAlbums=function(){this.$albums.addClass("hide")},c.switchByProvider=function(e,t){this.$albums.removeClass("hide").children().each(function(){var e=n(this),r=e.attr("data-provider");e.toggleClass("hide",r!==t)})},c.showAllAlbums=function(){this.$albums.removeClass("hide").find(" > .hide").removeClass("hide")},c.startUL='<ul class="thumbnails photos hide">',c.endUL="</ul>",c.generate=function(e){var t=l.compile(this.liAlbumTmp),n=l.compile(this.liPhotoTmp),r=t(e),i=n(e);return this.startUL+r+i+this.endUL},c.showPhotos=function(e,t){var r=e.albums.length|e.photos.length,i;i=n(this.generate(e)),this.$albums.append(i),i.removeClass("hide"),this.$parent.append(i),t&&i.find(".badge").removeClass("hide")},c.toggleBadge=function(e){var t=e.find(".badge");t.toggleClass("hide");if(t.hasClass("hide"))e.find(".ulm").remove(),e.removeAttr("data-status");else{var n="position: absolute; z-index: 300; right: 0; color: #fff; background: #444;";e.find(".thumbnail").prepend('<ul class="ulm" style="'+n+'"><li>Open</li><li class="import">Import</li></ul>'),e.attr("data-status","selected")}};var b=e("panel"),w=b.extend({options:{template:'<div class="panel photox-panel"><div class="clearfix panel-header"><h3 class="pull-left title panel-title">PhotoX</h3><ul class="pull-right nav nav-tabs"></ul></div><div class="panel-body"><ul class="breadcrumb hide"></ul><div class="loading hide"><img alt="" width="32" height="32" src="/static/img/loading.gif" /></div><ul class="thumbnails albums"></ul></div><div class="panel-footer"><div class="detail"><span class="selected-nums">0</span> pics selected</div><div class="icon-resize"></div><button class="xbtn-upload">Upload</button></div></div>',parentNode:null,srcNode:null},init:function(){var e=this.options;this.cid=e.crossId,this.providers=e.providers,delete e.providers,this.navTabs=new m(this,".panel-header .nav-tabs",this.providers),this.breadcrumb=new g(this,".panel-body .breadcrumb"),this.thumbnails=new y(this,".panel-body .albums"),this.fs=new v,this.render(),this.listen()},listen:function(){var e=this,t=e.fs,r=e.cid,i=e.element,s=e.navTabs,o=e.thumbnails,a=e.breadcrumb,l=e.element.find(".loading"),c=0,h;i.on("click.photox",".nav-tabs > li",function(t){t.preventDefault(),t.stopPropagation();var r=n(this),i=~~r.data("iid"),l=r.data("provider");if(i)s.switch(l)?(e.emit("show-albums"),a.toggle(!1)):e.emit("switch-provider",i,l),o.$albums.nextAll(".photos").remove();else{var c=new u(f.addidentity);c.render(),c.element.find(".oauth-"+l).trigger("click")}}),i.on("click.photox",".breadcrumb a",function(e){e.preventDefault()}),i.on("click.photox",".thumbnails > li[data-aid]",function(i){i.preventDefault();var u=n(this),f=u.data("iid"),l=u.data("provider"),d=u.data("aid"),v=u.attr("data-status");c++;if(c===1)h=setTimeout(function(){o.toggleBadge(u),v==="added"&&p.delAlbum(r,l,d,function(){},function(e){u.removeAttr("data-status")}),c=0},233);else{clearTimeout(h),s.switch(l,!0);if(l==="dropbox"){a.toggle(l==="dropbox",f);var m=decodeURIComponent(d).split("/"),g=m.length;d=m[g-1],t.has()||t.setUid(f).setGid(l).cd("/"),t.cd(d,g,function(e){a.del(g),a.add(f,e)})}o.hideAlbums(),p.browseSource(f,d,function(){e.emit("toggle-loading",!0)},function(t){e.emit("toggle-loading",!1),o.showPhotos(t,v)}),c=0}}),i.on("click.photox",".ulm li.import",function(e){var t=n(this),i=t.parents(".thumbnail").parent("li"),s=i.data("iid"),o=i.data("provider"),u=i.data("aid");e.preventDefault(),e.stopPropagation(),o==="instagram"?n.when(p.browseSource(s,u)).then(function(e){var n=e.photos,o=n[0],u=n[n.length-1];p.addStream(r,s,u,o,null,function(e){t.parent().remove(),i.attr("data-status","added")})}):p.addAlbum(r,s,u,null,function(e){t.parent().remove(),i.attr("data-status","added")})}),i.on("click.photox",".thumbnails > li[data-pid]",function(e){}),e.on("show-albums",function(){o.showAllAlbums()}),e.on("update-tabs-bage",function(e,t){tabs.updateBadge(e,t)}),e.on("toggle-loading",function(e){l[(e?"remove":"add")+"Class"]("hide")}),e.on("switch-provider",function(e,n){n==="dropbox"&&t.clear().setUid(e).setGid(n).cd("/"),a.toggle(n==="dropbox",e),o.switchByProvider(e,n)})},showAfter:function(){var e=this.srcNode.parent().offset();this.element.css({top:e.top+50,left:e.left-20}),this.thumbnails.showAlbums()},destory:function(){this.element.off(),this.element.remove(),this._destory()}});return w});