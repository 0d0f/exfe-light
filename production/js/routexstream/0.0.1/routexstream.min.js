define("routexstream",function(){"use strict";var t=window._ENV_,e=t.streaming_api_url,n=(t.api_url,navigator.geolocation),i=0,r="",s=10,o=s,a=null,u=null,c=!!0,l={timestamp:0,latitude:"",longitude:"",accuracy:""},h="",p="",e=e,f=null,d=null,m=null,g=null,v=function(){return o=0,r?(y("Breathe with token: "+r),f&&f.abort(),f=$.ajax({type:"post",url:e+"/v3/crosses/"+i+"/routex/breadcrumbs?token="+r,data:JSON.stringify(l),success:function(t){console.dir(t)},error:function(t){var e=t.status;e&&e>=400&&499>=e?(y("Unauthorized."),u&&(r="",w.kill(),u())):(o=s-5,y("Network error"))}}),void 0):(y("No token!"),void 0)},y=function(t,e){if(c){var n=Object.prototype.toString.call(t),i=""+new Date;"[object String]"!==n&&"[object Number]"!==n&&(t=JSON.stringify(t)),console.log(i.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+t),e&&console.table&&console.table(e)}},b=function(){if(window.DeviceMotionEvent===void 0)return null;var t=50,e=0,n=0,i=0,r=0,s=0,o=0;window.addEventListener("devicemotion",function(t){e=t.accelerationIncludingGravity.x,n=t.accelerationIncludingGravity.y,i=t.accelerationIncludingGravity.z},!1),setInterval(function(){var a=Math.abs(e-r+n-s+i-o);a>t&&(d&&d(),m&&setTimeout(m,1e3)),r=e,s=n,o=i},100)},w={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(t,e,n){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=e,this.dead=n;var i=this.http=new XMLHttpRequest;i.open("post",t),i.onreadystatechange=this.listen,i.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){var t=w.http;if(!(4!==t.readyState&&3!==t.readyState||3===t.readyState&&200!==t.status||null===t.responseText)){for(4===t.readyState&&200!==t.status&&w.kill();w.prvLen!==t.responseText.length&&(4!==t.readyState||w.prvLen!==t.responseText.length);){w.prvLen=t.responseText.length;var e=t.responseText.substring(w.nxtIdx),n=e.split("\n");w.nxtIdx+=e.lastIndexOf("\n")+1,"\n"===e[e.length-1]&&n[n.length]||n.pop(),w.pop&&w.pop(n)}4===t.readyState&&w.prvLen===t.responseText.length&&w.kill()}},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},x=function(){y("Streaming is dead")},k=function(){S(l)&&++o>=s&&v(),!w.live&&r&&(w.init(e+"/v3/crosses/"+i+"/routex?_method=WATCH&token="+r,O,x),y("Streaming with token: "+r))},S=function(t){return t.timestamp&&t.latitude&&t.longitude&&t.accuracy},E=function(){N.stopWatch(g)},_=function(t,e){N.get(function(e){l.timestamp=e.timestamp,l.latitude=e.latitude+"",l.longitude=e.longitude+"",l.accuracy=e.accuracy+"",t&&t(e),y("Location update: time = "+l.timestamp+", "+"lat  = "+l.latitude+", "+"lng  = "+l.longitude+", "+"acu  = "+l.accuracy)},function(t){e&&e(t)})},T=function(t,e){g=N.watch(function(e){l.timestamp=e.timestamp,l.latitude=e.latitude+"",l.longitude=e.longitude+"",l.accuracy=e.accuracy+"",t&&t(e),y("Location update: time = "+l.timestamp+", "+"lat  = "+l.latitude+", "+"lng  = "+l.longitude+", "+"acu  = "+l.accuracy)},function(t){e&&e(t)})},N={options:{enableHighAccuracy:!0,maximumAge:0,timeout:29999.999999},freshness_threshold:4999.999999,accuracy_threshold:500,_success:function(t){var e=this.freshness_threshold,n=this.accuracy_threshold,i=(new Date).getTime();return function r(s){var o=s.coords,a=o,u=(new Date).getTime();u-i>e&&(i=u+e,a.status="success",a.timestamp=Math.round(s.timestamp/1e3),a.accuracy=parseInt(o.accuracy||n),t&&t(a),r=null)}},_error:function(t){return function e(n){var i={status:"fail",code:n.code,message:n.message};t&&t(i),e=null}},get:function(t,e,i){i=i||this.options,n.getCurrentPosition(this._success(t),this._error(e),i)},watch:function(t,e){return n.watchPosition(this._success(t),this._error(e),this.options)},stopWatch:function(t){t&&n.clearWatch(t)}},O=function(t){if(t&&t.length){var e=JSON.parse(t[t.length-1]);if(e&&e.type&&e.data){var n=e.type.replace(/^.*\/([^\/]*)$/,"$1"),i=e.data;switch(n){case"breadcrumbs":var r=JSON.stringify(i);y("Streaming pops: "+r,i),a&&h!==r&&(y("Callback"),a(n,i),h=r);break;case"geomarks":var s=JSON.stringify(i);y("Streaming pops: "+s,i),a&&p!==s&&(y("Callback"),a(n,i),p=s)}}}},P={init:function(t,e,n,c){return t?e?n?c?(i=t,y("Set cross_id: "+t),r=e,y("Set token: "+e),a=n,y("Set callback function"),u=c,y("Set unauthorized callback function"),o=s,void 0):(y("Error unauthorized callback!"),void 0):(y("Error callback!"),void 0):(y("Error token!"),void 0):(y("Error cross id!"),void 0)},shake:function(t,e){d=t,m=e},getGeo:_,startGeo:T,stopGeo:E,geoService:N};return setInterval(k,1e3),b(d,m),window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),P});