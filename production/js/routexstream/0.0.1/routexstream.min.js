define("routexstream",function(){"use strict";var e=window._ENV_,t=e.streaming_api_url,i=(e.api_url,navigator.geolocation),n=0,r="",a=10,s=a,o=null,l=null,c=!!0,u={timestamp:0,latitude:"",longitude:"",accuracy:""},d="",h="",t=t,p=null,f=null,m=null,g=null,v=function(){return s=0,r?(y("Breathe with token: "+r),p&&p.abort(),p=$.ajax({type:"post",url:t+"/v3/crosses/"+n+"/routex/breadcrumbs?token="+r,data:JSON.stringify(u),success:function(e){console.dir(e)},error:function(e){var t=e.status;t&&t>=400&&499>=t?(y("Unauthorized."),l&&(r="",b.kill(),l())):(s=a-5,y("Network error"))}}),void 0):(y("No token!"),void 0)},y=function(e,t){if(c){var i=Object.prototype.toString.call(e),n=""+new Date;"[object String]"!==i&&"[object Number]"!==i&&(e=JSON.stringify(e)),console.log(n.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+e),t&&console.table&&console.table(t)}},_=function(){if(window.DeviceMotionEvent===void 0)return null;var e=50,t=0,i=0,n=0,r=0,a=0,s=0;window.addEventListener("devicemotion",function(e){t=e.accelerationIncludingGravity.x,i=e.accelerationIncludingGravity.y,n=e.accelerationIncludingGravity.z},!1),setInterval(function(){var o=Math.abs(t-r+i-a+n-s);o>e&&(f&&f(),m&&setTimeout(m,1e3)),r=t,a=i,s=n},100)},b={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(e,t,i){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=t,this.dead=i;var n=this.http=new XMLHttpRequest;n.open("post",e),n.onreadystatechange=this.listen,n.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){var e=b.http;if(!(4!==e.readyState&&3!==e.readyState||3===e.readyState&&200!==e.status||null===e.responseText)){for(4===e.readyState&&200!==e.status&&b.kill();b.prvLen!==e.responseText.length&&(4!==e.readyState||b.prvLen!==e.responseText.length);){b.prvLen=e.responseText.length;var t=e.responseText.substring(b.nxtIdx),i=t.split("\n");b.nxtIdx+=t.lastIndexOf("\n")+1,"\n"===t[t.length-1]&&i[i.length]||i.pop(),b.pop&&b.pop(i)}4===e.readyState&&b.prvLen===e.responseText.length&&b.kill()}},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},x=function(){y("Streaming is dead")},w=function(){k(u)&&++s>=a&&v(),!b.live&&r&&(b.init(t+"/v3/crosses/"+n+"/routex?_method=WATCH&token="+r,M,x),y("Streaming with token: "+r))},k=function(e){return e.timestamp&&e.latitude&&e.longitude&&e.accuracy},C=function(){S.stopWatch(g)},E=function(e,t){S.get(function(t){u.timestamp=t.timestamp,u.latitude=t.latitude+"",u.longitude=t.longitude+"",u.accuracy=t.accuracy+"",e&&e(t),y("Location update: time = "+u.timestamp+", "+"lat  = "+u.latitude+", "+"lng  = "+u.longitude+", "+"acu  = "+u.accuracy)},function(e){t&&t(e)})},T=function(e,t){g=S.watch(function(t){u.timestamp=t.timestamp,u.latitude=t.latitude+"",u.longitude=t.longitude+"",u.accuracy=t.accuracy+"",e&&e(t),y("Location update: time = "+u.timestamp+", "+"lat  = "+u.latitude+", "+"lng  = "+u.longitude+", "+"acu  = "+u.accuracy)},function(e){t&&t(e)})},S={options:{enableHighAccuracy:!0,maximumAge:0,timeout:29999.999999},freshness_threshold:4999.999999,accuracy_threshold:500,_success:function(e){var t=this.freshness_threshold,i=this.accuracy_threshold,n=(new Date).getTime();return function r(a){var s=a.coords,o=s,l=(new Date).getTime();l-n>t&&(n=l+t,o.status="success",o.timestamp=Math.round(a.timestamp/1e3),o.accuracy=parseInt(s.accuracy||i),e&&e(o),r=null)}},_error:function(e){return function t(i){var n={status:"fail",code:i.code,message:i.message};e&&e(n),t=null}},get:function(e,t,n){n=n||this.options,i.getCurrentPosition(this._success(e),this._error(t),n)},watch:function(e,t){return i.watchPosition(this._success(e),this._error(t),this.options)},stopWatch:function(e){e&&i.clearWatch(e)}},M=function(e){if(e&&e.length){var t=JSON.parse(e[e.length-1]);if(t&&t.type&&t.data){var i=t.type.replace(/^.*\/([^\/]*)$/,"$1"),n=t.data;switch(i){case"breadcrumbs":var r=JSON.stringify(n);y("Streaming pops: "+r,n),o&&d!==r&&(y("Callback"),o(i,n),d=r);break;case"geomarks":var a=JSON.stringify(n);y("Streaming pops: "+a,n),o&&h!==a&&(y("Callback"),o(i,n),h=a)}}}},A={init:function(e,t,i,c){return e?t?i?c?(n=e,y("Set cross_id: "+e),r=t,y("Set token: "+t),o=i,y("Set callback function"),l=c,y("Set unauthorized callback function"),s=a,void 0):(y("Error unauthorized callback!"),void 0):(y("Error callback!"),void 0):(y("Error token!"),void 0):(y("Error cross id!"),void 0)},shake:function(e,t){f=e,m=t},getGeo:E,startGeo:T,stopGeo:C,geoService:S};return setInterval(w,1e3),_(f,m),window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),A});