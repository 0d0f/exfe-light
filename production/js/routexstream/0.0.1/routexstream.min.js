define("routexstream",function(){"use strict";var t,e,n,i=window._ENV_,r=i.apiv3_url,s=0,o="",a=10,u=a,c=null,l=null,h=!!0,p={t:0,gps:[0,0,0]},f=null,d=null,m=null,g=null,v=null,y=null,b=function(){return u=0,o?(w("Breathe with token: "+o),f&&f.abort(),p.t=Math.round(Date.now()/1e3),f=$.ajax({type:"POST",url:r+"/routex/breadcrumbs?coordinate=earth&token="+o,data:JSON.stringify([p]),success:function(t){t&&(localStorage.setItem("offset-latlng",JSON.stringify(t)),v&&v(t))},error:function(t){var e=t.status;e&&e>=400&&499>=e?(w("Unauthorized."),l&&(k.kill(),l())):(u=a-5,w("Network error"))}}),void 0):(w("No token!"),void 0)},w=function(t,e){if(h){var n=Object.prototype.toString.call(t),i=""+new Date;"[object String]"!==n&&"[object Number]"!==n&&(t=JSON.stringify(t)),Debugger.log(i.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+t),e&&Debugger.table&&Debugger.table(e)}},x=function(){if(window.DeviceMotionEvent===void 0)return null;var t=50,e=0,n=0,i=0,r=0,s=0,o=0;window.addEventListener("devicemotion",function(t){e=t.accelerationIncludingGravity.x,n=t.accelerationIncludingGravity.y,i=t.accelerationIncludingGravity.z},!1),setInterval(function(){var a=Math.abs(e-r+n-s+i-o);a>t&&(d&&d(),m&&setTimeout(m,1e3)),r=e,s=n,o=i},100)},k={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(e,i,r){y(),Debugger.log(e),this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=i,this.dead=r;var s=this.http=new XMLHttpRequest;s.open("post",e),s.onreadystatechange=this.listen,s.onerror=this.onError,t=Date.now(),n=!1,s.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){n||(e=Date.now(),n=!0,Debugger.alert("Streaming 开始有会包 "+(e-t)+"ms"));var i=k.http;if(!(4!==i.readyState&&3!==i.readyState||3===i.readyState&&200!==i.status||null===i.responseText)){for(4===i.readyState&&200!==i.status&&k.kill();k.prvLen!==i.responseText.length&&(4!==i.readyState||k.prvLen!==i.responseText.length);){k.prvLen=i.responseText.length;var r=i.responseText.substring(k.nxtIdx),s=r.split("\n");if(k.nxtIdx+=r.lastIndexOf("\n")+1,"\n"===r[r.length-1]&&s[s.length]||s.pop(),k.pop&&s&&s.length)for(var o;(o=s.shift())&&o.length;)k.pop(o)}4===i.readyState&&k.prvLen===i.responseText.length&&k.kill()}},onError:function(){k.live=!1},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},S=function(){w("Streaming is dead")},E=function(){_(p)&&++u>=a&&b(),!k.live&&o&&(k.init(r+"/routex/crosses/"+s+"?_method=WATCH&coordinate=mars&token="+o+"&force_window_open",A,S),w("Streaming with token: "+o))},_=function(t){return t&&t.t&&t.gps&&t.gps[0]&&t.gps[1]&&t.gps[2]},T=function(){P.stopWatch(g)},N=function(t,e){P.get(function(e){p.t=e.timestamp,p.gps[0]=e.latitude,p.gps[1]=e.longitude,p.gps[2]=e.accuracy,t&&t(e),w("Location update: time = "+p.t+", "+"lat  = "+p.gps[0]+", "+"lng  = "+p.gps[1]+", "+"acu  = "+p.gps[2])},function(t){e&&e(t)})},O=function(t,e){g=P.watch(function(e){p.t=e.timestamp,p.gps[0]=e.latitude,p.gps[1]=e.longitude,p.gps[2]=e.accuracy,t&&t(e),w("Location update: time = "+p.t+", "+"lat  = "+p.gps[0]+", "+"lng  = "+p.gps[1]+", "+"acu  = "+p.gps[2])},function(t){e&&e(t)})},P={options:{enableHighAccuracy:!0,maximumAge:0,timeout:29999.999999},cachedOptions:{enableHighAccuracy:!1,maximumAge:72e5,timeout:5e3},STATUS:0,freshness_threshold:4999.999999,accuracy_threshold:500,_success:function(t){var e=this,n=this.freshness_threshold,i=this.accuracy_threshold,r=Date.now();return function s(o){var a=o.coords,u=a,c=Date.now(),l=!1;0===e.STATUS&&(l=!0),c-r>n&&(l=!0),l&&(r=c+n,u.status="success",u.timestamp=Math.round(o.timestamp/1e3),u.accuracy=parseInt(a.accuracy||i),t&&t(u),0===e.STATUS&&(e.STATUS=1),s=null)}},_error:function(t){return function e(n){var i={status:"fail",code:n.code,message:n.message};t&&t(i),e=null}},get:function(t,e,n){n=n||this.options,navigator.geolocation.getCurrentPosition(this._success(t),this._error(e),n)},watch:function(t,e){return navigator.geolocation.watchPosition(this._success(t),this._error(e),this.STATUS?this.options:this.cachedOptions)},stopWatch:function(t){t&&navigator.geolocation.clearWatch(t)}},A=function(n){var i=JSON.parse(n);i&&i.type&&(w("Streaming pops: "+i.type),"command"===i.type&&"init_end"===i.action&&Debugger.alert("Streaming 收到 init_end "+(Date.now()-t)+"ms","开始有会包到 init_end "+(Date.now()-e)+"ms"),c(i))},M={init:function(t,e,n,i,r,h){return t?e?n?i?(s=t,w("Set cross_id: "+t),o=e,w("Set token: "+e),c=n,w("Set callback function"),l=i,w("Set unauthorized callback function"),u=a,v=r,y=h,void 0):(w("Error unauthorized callback!"),void 0):(w("Error callback!"),void 0):(w("Error token!"),void 0):(w("Error cross id!"),void 0)},shake:function(t,e){d=t,m=e},stop:function(){k.kill()},getGeo:N,startGeo:O,stopGeo:T,geoService:P};return setInterval(E,1e3),x(d,m),window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),M});