define("routexstream",function(){"use strict";var t=window._ENV_,e=t.apiv3_url,n=navigator.geolocation,i=0,r="",s=10,o=s,a=null,u=null,c=!!0,l={timestamp:0,latitude:"",longitude:"",accuracy:""},h=null,p=null,f=null,d=null,m=function(){return o=0,r?(g("Breathe with token: "+r),h&&h.abort(),h=$.ajax({type:"POST",url:e+"/crosses/"+i+"/routex/breadcrumbs?token="+r,data:JSON.stringify(l),dataType:"json",success:function(t){t&&localStorage.setItem("offset-latlng",JSON.stringify(t))},error:function(t){var e=t.status;e&&e>=400&&499>=e?(g("Unauthorized."),u&&(y.kill(),u())):(o=s-5,g("Network error"))}}),void 0):(g("No token!"),void 0)},g=function(t,e){if(c){var n=Object.prototype.toString.call(t),i=""+new Date;"[object String]"!==n&&"[object Number]"!==n&&(t=JSON.stringify(t)),console.log(i.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+t),e&&console.table&&console.table(e)}},v=function(){if(window.DeviceMotionEvent===void 0)return null;var t=50,e=0,n=0,i=0,r=0,s=0,o=0;window.addEventListener("devicemotion",function(t){e=t.accelerationIncludingGravity.x,n=t.accelerationIncludingGravity.y,i=t.accelerationIncludingGravity.z},!1),setInterval(function(){var a=Math.abs(e-r+n-s+i-o);a>t&&(p&&p(),f&&setTimeout(f,1e3)),r=e,s=n,o=i},100)},y={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(t,e,n){console.log(t),this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=e,this.dead=n;var i=this.http=new XMLHttpRequest;i.open("post",t),i.onreadystatechange=this.listen,i.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){var t=y.http;if(!(4!==t.readyState&&3!==t.readyState||3===t.readyState&&200!==t.status||null===t.responseText)){for(4===t.readyState&&200!==t.status&&y.kill();y.prvLen!==t.responseText.length&&(4!==t.readyState||y.prvLen!==t.responseText.length);){y.prvLen=t.responseText.length;var e=t.responseText.substring(y.nxtIdx),n=e.split("\n");if(y.nxtIdx+=e.lastIndexOf("\n")+1,"\n"===e[e.length-1]&&n[n.length]||n.pop(),y.pop&&n&&n.length)for(var i;(i=n.shift())&&i.length;)y.pop(i)}4===t.readyState&&y.prvLen===t.responseText.length&&y.kill()}},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},b=function(){g("Streaming is dead")},w=function(){x(l)&&++o>=s&&m(),!y.live&&r&&(y.init(e+"/routex/crosses/"+i+"?_method=WATCH&coordinate=mars&token="+r,T,b),g("Streaming with token: "+r))},x=function(t){return t.timestamp&&t.latitude&&t.longitude&&t.accuracy},k=function(){_.stopWatch(d)},S=function(t,e){_.get(function(e){l.timestamp=e.timestamp,l.latitude=e.latitude+"",l.longitude=e.longitude+"",l.accuracy=e.accuracy+"",t&&t(e),g("Location update: time = "+l.timestamp+", "+"lat  = "+l.latitude+", "+"lng  = "+l.longitude+", "+"acu  = "+l.accuracy)},function(t){e&&e(t)})},E=function(t,e){d=_.watch(function(e){l.timestamp=e.timestamp,l.latitude=e.latitude+"",l.longitude=e.longitude+"",l.accuracy=e.accuracy+"",t&&t(e),g("Location update: time = "+l.timestamp+", "+"lat  = "+l.latitude+", "+"lng  = "+l.longitude+", "+"acu  = "+l.accuracy)},function(t){e&&e(t)})},_={options:{enableHighAccuracy:!0,maximumAge:0,timeout:29999.999999},cachedOptions:{enableHighAccuracy:!1,maximumAge:3e3,timeout:5e3},STATUS:0,freshness_threshold:4999.999999,accuracy_threshold:500,_success:function(t){var e=this.freshness_threshold,n=this.accuracy_threshold,i=(new Date).getTime();return function r(s){var o=s.coords,a=o,u=(new Date).getTime();u-i>e&&(i=u+e,a.status="success",a.timestamp=Math.round(s.timestamp/1e3),a.accuracy=parseInt(o.accuracy||n),t&&t(a),r=null)}},_error:function(t){return function e(n){var i={status:"fail",code:n.code,message:n.message};t&&t(i),e=null}},get:function(t,e,i){i=i||this.options,n.getCurrentPosition(this._success(t),this._error(e),i)},watch:function(t,e){return n.watchPosition(this._success(t),this._error(e),this.STATUS?this.options:this.cachedOptions)},stopWatch:function(t){t&&n.clearWatch(t)}},T=function(t){var e=JSON.parse(t);e&&e.type&&(g("Streaming pops: "+e.type),a(e))},N={init:function(t,e,n,c){return t?e?n?c?(i=t,g("Set cross_id: "+t),r=e,g("Set token: "+e),a=n,g("Set callback function"),u=c,g("Set unauthorized callback function"),o=s,void 0):(g("Error unauthorized callback!"),void 0):(g("Error callback!"),void 0):(g("Error token!"),void 0):(g("Error cross id!"),void 0)},shake:function(t,e){p=t,f=e},getGeo:S,startGeo:E,stopGeo:k,geoService:_};return setInterval(w,1e3),v(p,f),window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),N});