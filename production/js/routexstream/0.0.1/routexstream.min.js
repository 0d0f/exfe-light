define("routexstream",function(){"use strict";var t=window._ENV_,e=t.streaming_api_url,n=(t.api_url,navigator.geolocation),i=0,r="",s=10,o=s,a=null,u=null,c=!0,l={timestamp:0,latitude:"",longitude:"",accuracy:""},h="",p="",e=e,f=null,d=null,m=null,g=null,v=function(){return o=0,r?(y("Breathe with token: "+r),f&&f.abort(),f=$.ajax({type:"post",url:e+"/v3/crosses/"+i+"/routex/breadcrumbs?token="+r,data:JSON.stringify(l),success:function(){},error:function(t){var e=t.status;e&&e>=400&&499>=e?(y("Unauthorized."),u&&(r="",w.kill(),u())):(o=s-5,y("Network error"))}}),!w.live&&r&&(w.init(e+"/v3/crosses/"+i+"/routex?_method=WATCH&token="+r,A,x),y("Streaming with token: "+r)),void 0):(y("No token!"),void 0)},y=function(t,e){if(c){var n=Object.prototype.toString.call(t),i=""+new Date;"[object String]"!==n&&"[object Number]"!==n&&(t=JSON.stringify(t)),console.log(i.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+t),e&&console.table&&console.table(e)}},b=function(){if(window.DeviceMotionEvent===void 0)return null;var t=50,e=0,n=0,i=0,r=0,s=0,o=0;window.addEventListener("devicemotion",function(t){e=t.accelerationIncludingGravity.x,n=t.accelerationIncludingGravity.y,i=t.accelerationIncludingGravity.z},!1),setInterval(function(){var a=Math.abs(e-r+n-s+i-o);a>t&&(d&&d(),m&&setTimeout(m,1e3)),r=e,s=n,o=i},100)},w={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(t,e,n){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=e,this.dead=n;var i=this.http=new XMLHttpRequest;i.open("post",t,!0),i.onreadystatechange=this.listen,i.send(),this.timer=setInterval(this.listen,1e3),console.log(t)},listen:function(){var t=w.http;if(!(4!==t.readyState&&3!==t.readyState||3===t.readyState&&200!==t.status||null===t.responseText)){for(4===t.readyState&&200!==t.status&&w.kill();w.prvLen!==t.responseText.length&&(4!==t.readyState||w.prvLen!==t.responseText.length);){w.prvLen=t.responseText.length;var e=t.responseText.substring(w.nxtIdx),n=e.split("\n");w.nxtIdx+=e.lastIndexOf("\n")+1,"\n"===e[e.length-1]&&n[n.length]||n.pop(),w.pop&&w.pop(n)}4===t.readyState&&w.prvLen===t.responseText.length&&w.kill()}},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},x=function(){y("Streaming is dead")},k=function(){S(l)&&++o>=s&&v()},S=function(t){return t.timestamp&&t.latitude&&t.longitude&&t.accuracy},E=function(){T.stopWatch(g)},_=function(t){g=T.watch(function(e){l.timestamp=e.timestamp,l.latitude=e.latitude+"",l.longitude=e.longitude+"",l.accuracy=e.accuracy+"",t&&t(e),y("Location update: time = "+l.timestamp+", "+"lat  = "+l.latitude+", "+"lng  = "+l.longitude+", "+"acu  = "+l.accuracy)})},T={options:{enableHighAccuracy:!0,maximumAge:0,timeout:3e3},freshness_threshold:233,accuracy_threshold:500,_success:function(t){var e=this.freshness_threshold,n=this.accuracy_threshold;return function(i){var r=i.coords,s=r,o=(new Date).getTime(),a=i.timestamp;o-a>e&&(s.status="success",s.timestamp=Math.round(a/1e3),s.accuracy=parseInt(r.accuracy||n),t&&t(s))}},_error:function(t){return function(e){var n={status:"fail",code:e.code,message:e.message};t&&t(n)}},get:function(t,e,i){i=i||this.options,n.getCurrentPosition(this._success(t),this._error(e),i)},watch:function(t,e){return n.watchPosition(this._success(t),this._error(e),this.options)},stopWatch:function(t){n.clearWatch(t)}},N={id:0,created_by:"cfd@exfe.com@email",type:"route",color:"#ff0000",positions:[{latitude:31.21734480179986,longitude:121.5864718},{latitude:31.21319463357469,longitude:121.5972739},{latitude:31.268121713163797,longitude:121.5976561},{latitude:31.247065104540905,longitude:121.5970507},{latitude:31.206737991954668,longitude:121.5462089},{latitude:31.248654045999515,longitude:121.5291807},{latitude:31.25565585251572,longitude:121.5656451},{latitude:31.268261173480656,longitude:121.5331074},{latitude:31.2327964098393,longitude:121.5508703},{latitude:31.250543878922706,longitude:121.6255542}]},O={id:1,created_by:"0day.zh@gmail.com@email",type:"route",color:"#0000ff",positions:[{latitude:31.234197033286563,longitude:121.5449758},{latitude:31.255222305861768,longitude:121.6002405},{latitude:31.19713847061759,longitude:121.5849201},{latitude:31.248763796544168,longitude:121.6172143},{latitude:31.199140422578434,longitude:121.5295201},{latitude:31.23870660743816,longitude:121.5498787},{latitude:31.228642727640924,longitude:121.5294021},{latitude:31.23028873356199,longitude:121.5390788},{latitude:31.274770147210454,longitude:121.6137738},{latitude:31.180405477757102,longitude:121.6165173}]},M={id:"0",type:"location",created_at:0,created_by:"",updated_at:0,updated_by:"uid",tags:["destination","park"],icon:"http://api.panda.0d0f.com/v3/icons/mapmark",title:"2013 西藏单车旅游",description:"求带、求包养、求……",latitude:"31.180405477757102",longitude:"121.6165173"},P={id:"1",type:"location",created_at:0,created_by:"",updated_at:0,updated_by:"uid",tags:["park","destination"],icon:"http://api.panda.0d0f.com/v3/icons/mapmark",title:"2013 台湾自由行",description:"台北、高雄、新竹……",latitude:31.250543878922706,longitude:121.6255542},A=function(t){if(t&&t.length){var e=JSON.parse(t[t.length-1]);if(e&&e.type&&e.data){var n=e.type.replace(/^.*\/([^\/]*)$/,"$1"),i=e.data;switch(n="geomarks",i=[N,O,M,P][Math.floor(4*Math.random())],n){case"breadcrumbs":var r=JSON.stringify(i);y("Streaming pops: "+r,i),a&&h!==r&&(y("Callback"),a(n,i),h=r);break;case"geomarks":var s=JSON.stringify(i);y("Streaming pops: "+s,i),a&&p!==s&&(y("Callback"),a(n,i),p=s)}}}},H={init:function(t,e,n,c){return t?e?n?c?(i=t,y("Set cross_id: "+t),r=e,y("Set token: "+e),a=n,y("Set callback function"),u=c,y("Set unauthorized callback function"),o=s,void 0):(y("Error unauthorized callback!"),void 0):(y("Error callback!"),void 0):(y("Error token!"),void 0):(y("Error cross id!"),void 0)},shake:function(t,e){d=t,m=e},startGeo:_,stopGeo:E,geoService:T};return setInterval(k,1e3),b(d,m),window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),H});