define(function(e){"use strict";var t=e("jquery"),n=e("store"),i=window._ENV_,r=(e("dialog"),e("xdialog").dialogs,e("handlebars")),a=e("humantime"),s=e("rex"),o=e("util"),l=e("bus"),c=e("api");r.registerHelper("each",function(e,t){var n,i,r=t.fn,a=t.inverse,s="";if(e&&e.length)for(n=0,i=e.length;i>n;++n)e[n].__index__=n,s+=r(e[n]);else s=a(this);return s}),r.registerHelper("ifFalse",function(e,t){return r.helpers["if"].call(this,!e,t)}),r.registerHelper("avatarFilename",function(e){return e}),r.registerHelper("printName",function(e,t){return e||(e=t.match(/([^@]+)@[^@]+/)[1]),e}),r.registerHelper("printTime",function(e){var t=a.printEFTime(e);return t.content||"Sometime"}),r.registerHelper("printTime2",function(e){var t=a.printEFTime(e);return t.content||"To be decided"}),r.registerHelper("printPlace",function(e){return e||"To be decided"}),r.registerHelper("printTime3",function(e){var t=e.begin_at;if(!t.date)return t.date_word||"";var n=a.printEFTime(e);return n.content||"Sometime"}),r.registerHelper("printTime4",function(e){e=r.helpers.crossItem.call(this,e);var t=a.printEFTime(e);return t.content||"Sometime"}),r.registerHelper("rsvpAction",function(e,t){var n={ACCEPTED:"Accepted",INTERESTED:"Interested",DECLINED:"Unavailable",NORESPONSE:"Pending"},i=s.filter(e,function(e){return e.identity.id===t?!0:void 0})[0],r="";if(i&&i in n&&"INTERESTED"!==i.rsvp_status){var r='<div><i class="';r+="icon-rsvp-"+i.rsvp_status.toLowerCase()+'"></i> ',r+=n[i.rsvp_status]+": "+i.identity.name+"</div>"}var a=s.map(e,function(e){return e.by_identity.id===t&&e.identity.id!==t?e.identity.name:void 0}).filter(function(e){return e?!0:void 0}).join(", ");return r+='<div><i class="icon-invite"></i> ',r+="Invited: "+a,r+="</div>",a?r:""}),r.registerHelper("ifPlace",function(e){var t=r.helpers.crossItem.call(this,"place");return r.helpers["if"].call(this,t.length,e)}),r.registerHelper("makeDefault",function(e,t,n){var i=!e&&"CONNECTED"===t;return r.helpers["if"].call(this,i,n)}),r.registerHelper("ifRevoked",function(e,t){return r.helpers["if"].call(this,"REVOKED"===e,t)}),r.registerHelper("ifVerifying",function(e,t,n){var i=!r.helpers.isOAuthIdentity.call(this,e,n)&&"VERIFYING"===t;return r.helpers["if"].call(this,i,n)}),r.registerHelper("atName",function(e){return o.printExtUserName(e,!0)}),r.registerHelper("editable",function(e,t,n){var i=!r.helpers.isOAuthIdentity.call(this,e,n)&&"CONNECTED"===t;return r.helpers["if"].call(this,i,n)});var d=function(e){t(".user-xstats .attended").html(e.cross_quantity);var i=t("#jst-user-avatar"),a=r.compile(i.html()),s=a({avatar_filename:e.avatar_filename});t(".user-avatar").append(s),t("#profile .user-name").find("h3").html(e.name||e.nickname),t("#profile .user-bio").text(e.bio||""),t("#profile .user-name").find(".changepassword").attr("data-dialog-type",e.password?"changepassword":"setpassword").find("span").text(e.password?"Change Password...":"Set Password..."),r.registerPartial("jst-identity-item",t("#jst-identity-item").html());var o=t("#jst-identity-list"),a=r.compile(o.html()),l=e.identities;l[0].__default__=!0;var s=a({identities:l});t(".identity-list").append(s);var d;if(d=t("#app-main").data("event")){var u=d.action;if("add_identity"===u){var h=d.data,p=function(e,i,a){var s=n.get("authorization"),o=s.token;c.request("addIdentity",{type:"POST",params:{token:o},data:{external_username:e,provider:i}},function(e){var i=e.identity,s=n.get("user"),o=s.identities;o.push(i),n.set("user",s);var l=r.compile(t("#jst-identity-item").html()),c=l(e.identity);t(".identity-list").append(c),a&&a.destory()},function(n){var r=n&&n.meta;if(r&&401===r.code&&"authenticate_timeout"===r.errorType){a&&a.destory();var s=t('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');t("#app-tmp").append(s);var o=t.Event("click.dialog.data-api");o._data={callback:function(){p(e,i)}},s.trigger(o)}})};p(h.identity.external_username,h.identity.provider),t("#app-main").removeData("event")}}},u=function(e){if(e){var n=e.user_id,i=e.token;return c.request("crosslist",{params:{token:i},resources:{user_id:n}},function(e){+new Date;var n=t("#jst-crosses-container");r.registerHelper("confirmed_nums",function(e){var t=0,n=s.filter(e,function(e){return"ACCEPTED"===e.rsvp_status?(t+=e.mates,!0):void 0}).length||0;return n+t}),r.registerHelper("total",function(e){var t=0;return s.filter(e,function(e){return"ACCEPTED"===e.rsvp_status?(t+=e.mates,!0):void 0}),e.length+t}),r.registerHelper("confirmed_identities",function(e){var t=s(e).filter(function(e){return"ACCEPTED"===e.rsvp_status?!0:void 0});return s(t.slice(0,7)).map(function(e){return e.identity.name}).join(", ")}),r.registerPartial("jst-cross-box",t("#jst-cross-box").html());var i=r.compile(n.html()),a="",o="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",l={};s.map(e.crosses,function(e){l[e.sort]||(l[e.sort]={crosses:[]}),l[e.sort].crosses.push(e)}),l.upcoming||(l.upcoming={}),l.upcoming.crosses||(l.upcoming.crosses=[]),l.upcoming.crosses.reverse();var c=e.more.join(" "),d=/<|>/;s.map(o.split(" "),function(e){e=e.split(d);var t=l[e[0]];t&&(t.cate=e[0],t.cate_date=e[1],t.hasMore=c.search(e[0])>-1,a+=i(t))}),t("#profile .crosses").append(a)})}},h=function(e){if(e){var n=e.user_id,i=e.token,a=new Date;a=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate();var o=c.request("crosses",{params:{token:i},resources:{user_id:n}},function(e){new Date;var i=e.crosses,a=[],o={};if(s.each(i,function(e,t){e.exfee&&e.exfee.invitations&&e.exfee.invitations.length&&s.each(e.exfee.invitations,function(e,i){o[e.id]=[t,i],n===e.identity.connected_user_id&&"NORESPONSE"===e.rsvp_status&&(e.__crossIndex=t,e.__identityIndex=i,a.push(e))})}),r.registerHelper("crossItem",function(e){return"place"===e?i[this.__crossIndex][e].title:"invitationid"===e?i[this.__crossIndex].exfee.invitations[this.__identityIndex].id:"exfeeid"===e?i[this.__crossIndex].exfee.id:"identityid"===e?i[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.id:"name"===e?i[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.name:i[this.__crossIndex][e]}),r.registerHelper("conversation_nums",function(){return this.__conversation_nums}),a.length){var l=t("#jst-invitations"),c=r.compile(l.html()),d=c({crosses:a});t("#profile .gr-b .invitations").removeClass("hide").append(d)}});return o.done(f)}},p=function(e){if(e){var n=e.user_id,i=e.token,a=new Date,o=0;return a.setDate(a.getDate()-3),o=+a,a=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate(),c.request("crosses",{resources:{user_id:n},params:{updated_at:a,token:i}},function(e){var n,i=e.crosses;if(0===i.length)return t(".siderbar.updates").addClass("no-updates"),void 0;if(n=s.filter(i,function(e){var t=e.updated,n=!1;if(t){var i,r,a;for(i in t)"background"!==i&&(r=t[i],a=+new Date(r.updated_at.replace(/\-/g,"/")),a>o?n|=!0:(n|=!1,t[i]=!1))}return n?!0:void 0}),0===n.length)return t(".siderbar.updates").addClass("no-updates"),void 0;var a=t("#jst-updates").html(),l=r.compile(a),c=l({updates:n});t(".siderbar.updates .cross-tip").before(c)})}},f=function(e){if(e&&(e=n.get("authorization"))){var r=e.user_id,a=+t(".user-xstats > .attended").text(),s=n.get("newbie_guide:"+r);if(!s&&3>=a&&!t("#app-browsing-identity").length&&!t(".newbie").length){var o=document.createElement("script"),l=t("script#js-newbieguide");o.id="js-newbieguide",o.type="text/javascript",o.async=!0,o.src="/static/js/newbieguide/0.0.4/newbieguide.min.js?t="+i.timestamp,t(o).attr("data-exists",l.attr("data-exists")),l.remove();var c=document.body;c.appendChild(o)}}},m=function(){var e=n.get("iosapp_dismiss");e||t(".ios-app").removeClass("hide")};l.on("app:profile:show",function(e){e.done([u,h,p,m])}),l.on("app:profile:identities",function(e){d(e)}),l.on("app:addidentity",function(e){var n=t("#jst-identity-list"),i=r.compile(n.html()),a=i({identities:[e.identity]});t(".identity-list").append(a)});var g=t(document.body);g.on("dblclick.profile",".user-name h3",function(){var e=t.trim(t(this).html()),n=t('<input type="text" value="'+e+'" class="pull-left" />');n.data("oldValue",e),t(this).after(n).hide(),n.focusend(),t(".xbtn-changepassword").addClass("hide")}),g.on("focusout.profile keydown.profile",".user-name input",function(e){var i=e.type,r=e.keyCode;if("focusout"===i||9===r||!e.shiftKey&&13===r){var a=t.trim(t(this).val()),s=t(this).data("oldValue");if(t(this).hide().prev().html(a||s).show(),t(this).remove(),!t(".settings-panel").data("hoverout")&&t(".xbtn-changepassword").removeClass("hide"),!a||a===s)return;var o=n.get("authorization"),d=o.token;c.request("updateUser",{type:"POST",params:{token:d},data:{name:a}},function(e){n.set("user",e.user),l.emit("app:page:changeusername",a)})}}),g.on("dblclick.profile",".identity-list li .identity > span.identityname em",function(){var e=t(this),n=e.parents("li"),i=n.data("provider"),r=(n.data("status"),n.data("editable"));if(-1!=="twitter facebook google flickr instagram dropbox".indexOf(i))n.find(".isOAuth").removeClass("hide");else if(r){var a=t.trim(e.text()),s=t('<input type="text" value="'+a+'" class="username-input" />');s.data("oldValue",a),e.after(s).hide(),s.focusend()}}),g.on("focusout.profile keydown.profile",".identity-list .username-input",function(e){var i=e.type,r=e.keyCode;if("focusout"===i||9===r||!e.shiftKey&&13===r){var a=t.trim(t(this).val()),s=t(this).data("oldValue"),o=t(this).parents("li").data("identity-id");if(t(this).hide().prev().text(a||s).show(),t(this).remove(),!a||a===s)return;var l=n.get("authorization"),d=l.token;c.request("updateIdentity",{params:{token:d},resources:{identity_id:o},type:"POST",data:{name:a}},function(e){for(var t=n.get("user"),i=0,r=t.identities.length;r>i;++i)if(t.identities[i].id===e.identity_id){t.identities[i]=identity;break}n.set("user",t)})}}),g.on("click.profile",".xbtn-accept, .xbtn-ignore",function(e){e.preventDefault(),e.stopPropagation();var i=t(this),r=i.data("action"),a=i.parent(),s=a.data("id"),o=(a.data("invitationid"),t('.gr-a [data-id="'+s+'"]')),l=a.data("exfeeid"),d=a.data("identity-id"),u=a.data("name"),h=n.get("authorization"),p=h.token;c.request("rsvp",{params:{token:p},resources:{exfee_id:l},type:"POST",data:{rsvp:'[{"identity_id":'+d+', "rsvp_status": "'+r+'", "by_identity_id": '+d+"}]",by_identity_id:d}},function(){if("ACCEPTED"===r){var e=o.find(">div :first-child"),t=+e.text();e.text(t+1);var n=o.find(">div :last-child"),i=n.text();n.text(i+(i?", ":"")+u)}var s;a.parent().prev().length||a.parent().next().length||(s=a.parents(".invitations")),a.parent().remove(),s&&s.remove()})}),g.on("click.profile","#profile div.cross-type",function(e){e.preventDefault(),t(this).next().toggleClass("hide").next().toggleClass("hide"),t(this).find("span.arrow").toggleClass("lt rb")}),g.on("hover.profile",".changepassword",function(e){var n=e.type;t(this).data("hoverout","mouseleave"===n),"mouseenter"===n?t(this).addClass("xbtn-changepassword"):t(this).removeClass("xbtn-changepassword")}),g.on("click.profile",".more > a",function(e){e.preventDefault();var i=t(this),a=i.parent(),o=a.data("cate"),l=n.get("authorization"),d=l.token,u=l.user_id,h=a.prev().find(" .cross-box").length,p=o;c.request("crosslist",{params:{token:d},resources:{user_id:u},data:{more_category:p,more_position:h}},function(e){if(e.crosses.length){var t="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",n=r.compile(t);a.prev().append(n(e));var l=s.filter(e.more,function(e){return e===o?!0:void 0});l.length||i.remove()}})}),g.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(e){e.preventDefault(),n.set("iosapp_dismiss",!0),g.off("click.profile.iosapp"),t(this).parent().fadeOut()});var v,y=null,_=null,b=null;g.on("click.data-link",".user-avatar .avatar, .identity-list > li > .avatar",function(){var n=t(this),i=n.find("img");if(!n.parent().data("editable"))return!1;var r=n.parent().data("identity-id"),a={};r&&(a.identity_id=r),a["80_80"]=i[0].src,a["80_80"]=decodeURIComponent(a["80_80"]),a["80_80"].match(/\/80_80_/)||(a["80_80"]=""),a.original=a["80_80"].replace(/80_80_/,"original_"),y||(y=e("uploader").Uploader,v=t.extend(!0,{},e("uploader").uploadSettings,{options:{onHideBefore:function(){b=null,_=null}}})),_&&(_.hide(),_=null),_=new y(v).render(),_.show(a)}),g.dndsortable({delay:300,wrap:!0,list:".identity-list",items:" > li",sort:function(e,i){var r=t(e),a=t(i),s=a.parent(),o=r.index(),l=a.index(),d=s.data("draggable");if(d){o>l?a.before(r):a.after(r);var u=n.get("authorization"),h=[];s.find("> li").each(function(e,n){h.push(t(n).data("identity-id"))}),c.request("sortIdentities",{type:"POST",resources:{user_id:u.user_id},params:{token:u.token},data:{identity_order:"["+(""+h)+"]"}},function(){var e=n.get("user"),t=e.identities,i=t.splice(o,1)[0];t.splice(l,0,i),n.set("user",e),s.data("draggable",!0)}),s.data("draggable",!1)}},setData:function(e){return t(e).data("identity-id")},start:function(){var e=t(".settings-panel .identity-list"),n=e.find("> li"),i=!!e.data("draggable");return i?1===n.size()?!1:(t(this).addClass("dragme"),t(".xbtn-addidentity").addClass("hide"),t(".identities-trash").removeClass("hide over"),void 0):!1},end:function(){t(this).removeClass("dragme"),t(".xbtn-addidentity").removeClass("hide"),t(".identities-trash").addClass("hide over")}}),g.on("dragenter.profile",".trash-overlay",function(){return t(this).parent().addClass("over"),t(".icon24-trash").addClass("icon24-trash-red"),!1}),g.on("dragover.profile",".trash-overlay",function(e){return e.stopPropagation(),e.preventDefault(),!1}),g.on("dragleave.profile",".trash-overlay",function(){return t(this).parent().removeClass("over"),t(".icon24-trash").removeClass("icon24-trash-red"),!1}),g.data("trash-overlay-deletable",!0),g.on("drop.profile",".trash-overlay",function(e){function i(e){var r=n.get("authorization"),a=r.token,o=c.request("deleteIdentity",{type:"POST",params:{token:a},data:{identity_id:e}},function(){var i=n.get("user"),r=i.identities;s.some(r,function(t,n){return t.id===e?(r.splice(n,1),!0):void 0}),n.set("user",i),t('.identity-list > li[data-identity-id="'+e+'"]').remove()},function(n){var r=n&&n.meta;if(r&&401===r.code&&"authenticate_timeout"===r.errorType){var a=t('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');t("#app-tmp").append(a);var s=t.Event("click.dialog.data-api");s._data={callback:function(){i(e)}},a.trigger(s)}});o.always(function(){g.data("trash-overlay-deletable",!0)})}var r=g.data("trash-overlay-deletable");if(r){g.data("trash-overlay-deletable",!1),e.stopPropagation(),e.preventDefault();var a=e.originalEvent.dataTransfer,o=+a.getData("text/plain");return t(this).parent().removeClass("over"),t(".icon24-trash").removeClass("icon24-trash-red"),i(o),!1}})});