define(function(e){"use strict";var t=e("jquery"),n=e("store"),i=window._ENV_,a=e("handlebars"),r=e("humantime"),s=e("rex"),o=e("util"),l=e("bus"),c=e("api");a.registerHelper("each",function(e,t){var n,i,a=t.fn,r=t.inverse,s="";if(e&&e.length)for(n=0,i=e.length;i>n;++n)e[n].__index__=n,s+=a(e[n]);else s=r(this);return s}),a.registerHelper("ifFalse",function(e,t){return a.helpers["if"].call(this,!e,t)}),a.registerHelper("avatarFilename",function(e){return e}),a.registerHelper("printName",function(e,t){return e||(e=t.match(/([^@]+)@[^@]+/)[1]),e}),a.registerHelper("printTime",function(e){var t=r.printEFTime(e);return t.content||"Sometime"}),a.registerHelper("printTime2",function(e){var t=r.printEFTime(e);return t.content||"To be decided"}),a.registerHelper("printPlace",function(e){return e||"To be decided"}),a.registerHelper("printTime3",function(e){var t=e.begin_at;if(!t.date)return t.date_word||"";var n=r.printEFTime(e);return n.content||"Sometime"}),a.registerHelper("printTime4",function(e){e=a.helpers.crossItem.call(this,e);var t=r.printEFTime(e);return t.content||"Sometime"}),a.registerHelper("rsvpAction",function(e,t){var n={ACCEPTED:"Accepted",INTERESTED:"Interested",DECLINED:"Unavailable",NORESPONSE:"Pending"},i=s.filter(e,function(e){return e.identity.id===t?!0:void 0})[0],a="";i&&i in n&&"INTERESTED"!==i.rsvp_status&&(a+='<div><i class="',a+="icon-rsvp-"+i.rsvp_status.toLowerCase()+'"></i> ',a+=n[i.rsvp_status]+": "+i.identity.name+"</div>");var r=s.map(e,function(e){return e.by_identity.id===t&&e.identity.id!==t?e.identity.name:void 0}).filter(function(e){return e?!0:void 0}).join(", ");return a+='<div><i class="icon-invite"></i> ',a+="Invited: "+r,a+="</div>",r?a:""}),a.registerHelper("ifPlace",function(e){var t=a.helpers.crossItem.call(this,"place");return a.helpers["if"].call(this,t.length,e)}),a.registerHelper("makeDefault",function(e,t,n){var i=!e&&"CONNECTED"===t;return a.helpers["if"].call(this,i,n)}),a.registerHelper("ifRevoked",function(e,t){return a.helpers["if"].call(this,"REVOKED"===e,t)}),a.registerHelper("ifVerifying",function(e,t,n){var i=!a.helpers.isOAuthIdentity.call(this,e,n)&&"VERIFYING"===t;return a.helpers["if"].call(this,i,n)}),a.registerHelper("atName",function(e){return o.printExtUserName(e,!0)}),a.registerHelper("editable",function(e,t,n){var i=!a.helpers.isOAuthIdentity.call(this,e,n)&&"CONNECTED"===t;return a.helpers["if"].call(this,i,n)}),a.registerHelper("confirmed_identities",function(e){var t=s(e).filter(function(e){return"ACCEPTED"===e.rsvp_status?!0:void 0});return s(t.slice(0,7)).map(function(e){return e.identity.name}).join(", ")});var u=function(e){t(".user-xstats .attended").html(e.cross_quantity);var i=t("#jst-user-avatar"),r=a.compile(i.html()),o=r({avatar_filename:e.avatar_filename});t(".user-avatar").append(o),t("#profile .user-name").find("h3").html(e.name||e.nickname),t("#profile .user-bio").text(e.bio||""),t("#profile .user-name").find(".changepassword").attr("data-dialog-type",e.password?"changepassword":"setpassword").find("span").text(e.password?"Change Password...":"Set Password..."),a.registerPartial("jst-identity-item",t("#jst-identity-item").html());var l=e.devices;l=s.filter(l,function(e){return"iOS"===e.os_name&&"CONNECTED"===e.status?e:void 0}),0===l.length&&t(".exfe-app").removeClass("hide");var u=t("#jst-identity-list");r=a.compile(u.html());var d=e.identities;d[0].__default__=!0,o=r({identities:d}),t(".identity-list").append(o);var h;if(h=t("#app-main").data("event")){var p=h.action;if("add_identity"===p){var f=h.data,m=function(e,i,s){var l=n.get("authorization"),u=l.token;c.request("addIdentity",{type:"POST",params:{token:u},data:{external_username:e,provider:i}},function(e){var i=e.identity,l=n.get("user"),c=l.identities;c.push(i),n.set("user",l),r=a.compile(t("#jst-identity-item").html()),o=r(e.identity),t(".identity-list").append(o),s&&s.destory()},function(n){var a=n&&n.meta;if(a&&401===a.code&&"authenticate_timeout"===a.errorType){s&&s.destory();var r=t('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');t("#app-tmp").append(r);var o=t.Event("click.dialog.data-api");o._data={callback:function(){m(e,i)}},r.trigger(o)}})};m(f.identity.external_username,f.identity.provider),t("#app-main").removeData("event")}}},d=function(e){if(e){var n=e.user_id,i=e.token;return c.request("crosslist",{params:{token:i},resources:{user_id:n}},function(e){var n=t("#jst-crosses-container");a.registerPartial("jst-cross-box",t("#jst-cross-box").html());var i=a.compile(n.html()),r="",o="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",l={};s.map(e.crosses,function(e){l[e.sort]||(l[e.sort]={crosses:[]}),l[e.sort].crosses.push(e)}),l.upcoming||(l.upcoming={}),l.upcoming.crosses||(l.upcoming.crosses=[]),l.upcoming.crosses.reverse();var c=e.more.join(" "),u=/<|>/;s.map(o.split(" "),function(e){e=e.split(u);var t=l[e[0]];t&&(t.cate=e[0],t.cate_date=e[1],t.hasMore=c.search(e[0])>-1,r+=i(t))}),t("#profile .crosses").append(r)})}},h=function(e){if(e){var n=e.user_id,i=e.token,r=new Date;r=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate();var o=c.request("crosses",{params:{token:i},resources:{user_id:n}},function(e){var i=e.crosses,r=[],o={};if(s.each(i,function(e,t){e.exfee&&e.exfee.invitations&&e.exfee.invitations.length&&s.each(e.exfee.invitations,function(e,i){o[e.id]=[t,i],n===e.identity.connected_user_id&&"NORESPONSE"===e.rsvp_status&&(e.__crossIndex=t,e.__identityIndex=i,r.push(e))})}),a.registerHelper("crossItem",function(e){return"place"===e?i[this.__crossIndex][e].title:"invitationid"===e?i[this.__crossIndex].exfee.invitations[this.__identityIndex].id:"exfeeid"===e?i[this.__crossIndex].exfee.id:"identityid"===e?i[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.id:"name"===e?i[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.name:i[this.__crossIndex][e]}),a.registerHelper("conversation_nums",function(){return this.__conversation_nums}),r.length){var l=t("#jst-invitations"),c=a.compile(l.html()),u=c({crosses:r});t("#profile .gr-b .invitations").removeClass("hide").append(u)}});return o.done(f)}},p=function(e){if(e){var n=e.user_id,i=e.token,r=new Date,o=0;return r.setDate(r.getDate()-3),o=+r,r=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate(),c.request("crosses",{resources:{user_id:n},params:{updated_at:r,token:i}},function(e){var n,i=e.crosses;if(0===i.length)return t(".siderbar.updates").addClass("no-updates"),void 0;if(n=s.filter(i,function(e){var t=e.updated,n=!1;if(t){var i,a,r;for(i in t)"background"!==i&&(a=t[i],r=+new Date(a.updated_at.replace(/\-/g,"/")),r>o?n|=!0:(n|=!1,t[i]=!1))}return n?!0:void 0}),0===n.length)return t(".siderbar.updates").addClass("no-updates"),void 0;var r=t("#jst-updates").html(),l=a.compile(r),c=l({updates:n});t(".siderbar.updates .cross-tip").before(c)})}},f=function(e){e=n.get("authorization");var a=e.user_id,r=~~t(".user-xstats > .attended").text(),s=n.get("newbie_guide:"+a);if(3>=r&&!s&&0===t("#js-newbieguide").length){var o=document.createElement("script");o.id="js-newbieguide",o.type="text/javascript",o.async=!0,o.src="/static/js/newbieguide/0.0.5/newbieguide.min.js?t="+i.timestamp,document.getElementById("app-tmp").appendChild(o)}},m=function(){var e=n.get("iosapp_dismiss");e||t(".ios-app").removeClass("hide")};l.on("app:profile:show",function(e){e.done([d,h,p,m])}),l.on("app:profile:identities",function(e){u(e)}),l.on("app:addidentity",function(e){var n=t("#jst-identity-list"),i=a.compile(n.html()),r=i({identities:[e.identity]});t(".identity-list").append(r)});var g=t(document.body);g.on("dblclick.profile",".user-name h3",function(){var e=t.trim(t(this).html()),n=t('<input type="text" value="'+e+'" class="pull-left" />');n.data("oldValue",e),t(this).after(n).hide(),n.focusend(),t(".xbtn-changepassword").addClass("hide")}),g.on("focusout.profile keydown.profile",".user-name input",function(e){var i=e.type,a=e.keyCode;if("focusout"===i||9===a||!e.shiftKey&&13===a){var r=t.trim(t(this).val()),s=t(this).data("oldValue");if(t(this).hide().prev().html(r||s).show(),t(this).remove(),!t(".settings-panel").data("hoverout")&&t(".xbtn-changepassword").removeClass("hide"),!r||r===s)return;var o=n.get("authorization"),u=o.token;c.request("updateUser",{type:"POST",params:{token:u},data:{name:r}},function(e){n.set("user",e.user),l.emit("app:page:changeusername",r)})}}),g.on("dblclick.profile",".identity-list li .identity > span.identityname em",function(){var e=t(this),n=e.parents("li"),i=n.data("provider"),a=n.data("editable");if(-1!=="twitter facebook google flickr instagram dropbox".indexOf(i))n.find(".isOAuth").removeClass("hide");else if(a){var r=t.trim(e.text()),s=t('<input type="text" value="'+r+'" class="username-input" />');s.data("oldValue",r),e.after(s).hide(),s.focusend()}}),g.on("focusout.profile keydown.profile",".identity-list .username-input",function(e){var i=e.type,a=e.keyCode;if("focusout"===i||9===a||!e.shiftKey&&13===a){var r=t.trim(t(this).val()),s=t(this).data("oldValue"),o=t(this).parents("li").data("identity-id");if(t(this).hide().prev().text(r||s).show(),t(this).remove(),!r||r===s)return;var l=n.get("authorization"),u=l.token;c.request("updateIdentity",{params:{token:u},resources:{identity_id:o},type:"POST",data:{name:r}},function(e){for(var t=e.identity,i=t.id,a=n.get("user"),r=a.identities,s=0,o=r.length;o>s;++s)if(r[s].id===i){r[s]=t;break}n.set("user",a)})}}),g.on("click.profile",".xbtn-accept, .xbtn-ignore",function(e){e.preventDefault(),e.stopPropagation();var i=t(this),a=i.data("action"),r=i.parent(),s=r.data("id"),o=t('.gr-a [data-id="'+s+'"]'),l=r.data("exfeeid"),u=r.data("identity-id"),d=r.data("name"),h=n.get("authorization"),p=h.token;c.request("rsvp",{params:{token:p},resources:{exfee_id:l},type:"POST",data:{rsvp:'[{"identity_id":'+u+', "rsvp_status": "'+a+'", "by_identity_id": '+u+"}]",by_identity_id:u}},function(){if("ACCEPTED"===a){var e=o.find(">div :first-child"),t=+e.text();e.text(t+1);var n=o.find(">div :last-child"),i=n.text();n.text(i+(i?", ":"")+d)}var s;r.parent().prev().length||r.parent().next().length||(s=r.parents(".invitations")),r.parent().remove(),s&&s.remove()})}),g.on("click.profile","#profile div.cross-type",function(e){e.preventDefault(),t(this).next().toggleClass("hide").next().toggleClass("hide"),t(this).find("span.arrow").toggleClass("lt rb")}),g.on("hover.profile",".changepassword",function(e){var n=e.type;t(this).data("hoverout","mouseleave"===n),"mouseenter"===n?t(this).addClass("xbtn-changepassword"):t(this).removeClass("xbtn-changepassword")}),g.on("click.profile",".more > a",function(e){e.preventDefault();var i=t(this),r=i.parent(),o=r.data("cate"),l=n.get("authorization"),u=l.token,d=l.user_id,h=r.prev().find(" .cross-box").length,p=o;c.request("crosslist",{params:{token:u},resources:{user_id:d},data:{more_category:p,more_position:h}},function(e){if(e.crosses.length){var t="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",n=a.compile(t);r.prev().append(n(e));var l=s.filter(e.more,function(e){return e===o?!0:void 0});l.length||i.remove()}})}),g.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(e){e.preventDefault(),n.set("iosapp_dismiss",!0),g.off("click.profile.iosapp"),t(this).parent().fadeOut()});var v,y=null,_=null,b=null;g.on("click.data-link",".user-avatar .avatar, .identity-list > li > .avatar",function(){var n=t(this),i=n.find("img");if(!n.parent().data("editable"))return!1;var a=n.parent().data("identity-id"),r={};a&&(r.identity_id=a),r["80_80"]=i[0].src,r["80_80"]=decodeURIComponent(r["80_80"]),r["80_80"].match(/\/80_80_/)||(r["80_80"]=""),r.original=r["80_80"].replace(/80_80_/,"original_"),y||(y=e("uploader").Uploader,v=t.extend(!0,{},e("uploader").uploadSettings,{options:{onHideBefore:function(){b=_=void 0}}})),_&&(_.hide(),_=null),_=new y(v).render(),_.show(r)}),g.dndsortable({delay:300,wrap:!0,list:".identity-list",items:" > li",sort:function(e,i){var a=t(e),r=t(i),s=r.parent(),o=a.index(),l=r.index(),u=s.data("draggable");if(u){o>l?r.before(a):r.after(a);var d=n.get("authorization"),h=[];s.find("> li").each(function(e,n){h.push(t(n).data("identity-id"))}),c.request("sortIdentities",{type:"POST",resources:{user_id:d.user_id},params:{token:d.token},data:{identity_order:"["+(""+h)+"]"}},function(){var e=n.get("user"),t=e.identities,i=t.splice(o,1)[0];t.splice(l,0,i),n.set("user",e),s.data("draggable",!0)}),s.data("draggable",!1)}},setData:function(e){return t(e).data("identity-id")},start:function(){var e=t(".settings-panel .identity-list"),n=e.find("> li"),i=!!e.data("draggable");return i?1===n.size()?!1:(t(this).addClass("dragme"),t(".xbtn-addidentity").addClass("hide"),t(".identities-trash").removeClass("hide over"),void 0):!1},end:function(){t(this).removeClass("dragme"),t(".xbtn-addidentity").removeClass("hide"),t(".identities-trash").addClass("hide over")}}),g.on("dragenter.profile",".trash-overlay",function(){return t(this).parent().addClass("over"),t(".icon24-trash").addClass("icon24-trash-red"),!1}),g.on("dragover.profile",".trash-overlay",function(e){return e.stopPropagation(),e.preventDefault(),!1}),g.on("dragleave.profile",".trash-overlay",function(){return t(this).parent().removeClass("over"),t(".icon24-trash").removeClass("icon24-trash-red"),!1}),g.data("trash-overlay-deletable",!0),g.on("drop.profile",".trash-overlay",function(e){function i(e){var a=n.get("authorization"),r=a.token,o=c.request("deleteIdentity",{type:"POST",params:{token:r},data:{identity_id:e}},function(){var i=n.get("user"),a=i.identities;s.some(a,function(t,n){return t.id===e?(a.splice(n,1),!0):void 0}),n.set("user",i),t('.identity-list > li[data-identity-id="'+e+'"]').remove()},function(n){var a=n&&n.meta;if(a&&401===a.code&&"authenticate_timeout"===a.errorType){var r=t('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');t("#app-tmp").append(r);var s=t.Event("click.dialog.data-api");s._data={callback:function(){i(e)}},r.trigger(s)}});o.always(function(){g.data("trash-overlay-deletable",!0)})}var a=g.data("trash-overlay-deletable");if(a){g.data("trash-overlay-deletable",!1),e.stopPropagation(),e.preventDefault();var r=e.originalEvent.dataTransfer,o=+r.getData("text/plain");return t(this).parent().removeClass("over"),t(".icon24-trash").removeClass("icon24-trash-red"),i(o),!1}})});