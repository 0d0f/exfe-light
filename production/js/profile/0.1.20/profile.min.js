define(function(e){"use strict";var t=e("jquery"),i=e("store"),r=window._ENV_,a=e("handlebars"),n=e("humantime"),s=e("rex"),o=e("util"),d=e("bus"),l=e("api");a.registerHelper("each",function(e,t){var i,r,a=t.fn,n=t.inverse,s="";if(e&&e.length)for(i=0,r=e.length;r>i;++i)e[i].__index__=i,s+=a(e[i]);else s=n(this);return s}),a.registerHelper("ifFalse",function(e,t){return a.helpers["if"].call(this,!e,t)}),a.registerHelper("avatarFilename",function(e){return e}),a.registerHelper("printName",function(e,t){return e||(e=t.match(/([^@]+)@[^@]+/)[1]),e}),a.registerHelper("printTime",function(e){var t=n.printEFTime(e);return t.content||"Sometime"}),a.registerHelper("printTime2",function(e){var t=n.printEFTime(e);return t.content||"To be decided"}),a.registerHelper("printPlace",function(e){return e||"To be decided"}),a.registerHelper("printTime3",function(e){var t=e.begin_at;if(!t.date)return t.date_word||"";var i=n.printEFTime(e);return i.content||"Sometime"}),a.registerHelper("printTime4",function(e){e=a.helpers.crossItem.call(this,e);var t=n.printEFTime(e);return t.content||"Sometime"}),a.registerHelper("rsvpAction",function(e,t){var i={ACCEPTED:"Accepted",INTERESTED:"Interested",DECLINED:"Unavailable",NORESPONSE:"Pending"},r=s.filter(e,function(e){return e.identity.id===t?!0:void 0})[0],a="";r&&r in i&&"INTERESTED"!==r.rsvp_status&&(a+='<div><i class="',a+="icon-rsvp-"+r.rsvp_status.toLowerCase()+'"></i> ',a+=i[r.rsvp_status]+": "+r.identity.name+"</div>");var n=s.map(e,function(e){return e.by_identity.id===t&&e.identity.id!==t?e.identity.name:void 0}).filter(function(e){return e?!0:void 0}).join(", ");return a+='<div><i class="icon-invite"></i> ',a+="Invited: "+n,a+="</div>",n?a:""}),a.registerHelper("ifPlace",function(e){var t=a.helpers.crossItem.call(this,"place");return a.helpers["if"].call(this,t.length,e)}),a.registerHelper("makeDefault",function(e,t,i){var r=!e&&"CONNECTED"===t;return a.helpers["if"].call(this,r,i)}),a.registerHelper("ifRevoked",function(e,t){return a.helpers["if"].call(this,"REVOKED"===e,t)}),a.registerHelper("ifVerifying",function(e,t,i){var r=!a.helpers.isOAuthIdentity.call(this,e,i)&&"VERIFYING"===t;return a.helpers["if"].call(this,r,i)}),a.registerHelper("atName",function(e){return o.printExtUserName(e,!0)}),a.registerHelper("editable",function(e,t,i){var r=!a.helpers.isOAuthIdentity.call(this,e,i)&&"CONNECTED"===t;return a.helpers["if"].call(this,r,i)}),a.registerHelper("confirmed_identities",function(e){var t=s(e).filter(function(e){return"ACCEPTED"===e.rsvp_status?!0:void 0});return s(t.slice(0,7)).map(function(e){return e.identity.name}).join(", ")});var u=function(e){t(".user-xstats .attended").html(e.cross_quantity);var r=t("#jst-user-avatar"),n=a.compile(r.html()),o=n({avatar_filename:e.avatar_filename});t(".user-avatar").append(o),t("#profile .user-name").find("h3").html(e.name||e.nickname),t("#profile .user-bio").text(e.bio||""),t("#profile .user-name").find(".changepassword").attr("data-dialog-type",e.password?"changepassword":"setpassword").find("span").text(e.password?"Change Password...":"Set Password..."),a.registerPartial("jst-identity-item",t("#jst-identity-item").html());var d=e.devices;d=s.filter(d,function(e){return"iOS"===e.os_name&&"CONNECTED"===e.status?e:void 0}),0===d.length&&t(".exfe-app").removeClass("hide");var u=t("#jst-identity-list");n=a.compile(u.html());var p=e.identities;p[0].__default__=!0,o=n({identities:p}),t(".identity-list").append(o);var c;if(c=t("#app-main").data("event")){var f=c.action;if("add_identity"===f){var v=c.data,h=function(e,r,s){var d=i.get("authorization"),u=d.token;l.request("addIdentity",{type:"POST",params:{token:u},data:{external_username:e,provider:r}},function(e){var r=e.identity,d=i.get("user"),l=d.identities;l.push(r),i.set("user",d),n=a.compile(t("#jst-identity-item").html()),o=n(e.identity),t(".identity-list").append(o),s&&s.destory()},function(i){var a=i&&i.meta;if(a&&401===a.code&&"authenticate_timeout"===a.errorType){s&&s.destory();var n=t('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');t("#app-tmp").append(n);var o=t.Event("click.dialog.data-api");o._data={callback:function(){h(e,r)}},n.trigger(o)}})};h(v.identity.external_username,v.identity.provider),t("#app-main").removeData("event")}}},p=function(e){if(e){var i=e.user_id,r=e.token;return l.request("crosslist",{params:{token:r},resources:{user_id:i}},function(e){var i=t("#jst-crosses-container");a.registerPartial("jst-cross-box",t("#jst-cross-box").html());var r=a.compile(i.html()),n="",o="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",d={};s.map(e.crosses,function(e){d[e.sort]||(d[e.sort]={crosses:[]}),d[e.sort].crosses.push(e)}),d.upcoming||(d.upcoming={}),d.upcoming.crosses||(d.upcoming.crosses=[]),d.upcoming.crosses.reverse();var l=e.more.join(" "),u=/<|>/;s.map(o.split(" "),function(e){e=e.split(u);var t=d[e[0]];t&&(t.cate=e[0],t.cate_date=e[1],t.hasMore=l.search(e[0])>-1,n+=r(t))}),t("#profile .crosses").append(n)})}},c=function(e){if(e){var i=e.user_id,r=e.token,n=new Date;n=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate();var o=l.request("crosses",{params:{token:r},resources:{user_id:i}},function(e){var r=e.crosses,n=[],o={};if(s.each(r,function(e,t){e.exfee&&e.exfee.invitations&&e.exfee.invitations.length&&s.each(e.exfee.invitations,function(e,r){o[e.id]=[t,r],i===e.identity.connected_user_id&&"NORESPONSE"===e.rsvp_status&&(e.__crossIndex=t,e.__identityIndex=r,n.push(e))})}),a.registerHelper("crossItem",function(e){return"place"===e?r[this.__crossIndex][e].title:"invitationid"===e?r[this.__crossIndex].exfee.invitations[this.__identityIndex].id:"exfeeid"===e?r[this.__crossIndex].exfee.id:"identityid"===e?r[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.id:"name"===e?r[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.name:r[this.__crossIndex][e]}),a.registerHelper("conversation_nums",function(){return this.__conversation_nums}),n.length){var d=t("#jst-invitations"),l=a.compile(d.html()),u=l({crosses:n});t("#profile .gr-b .invitations").removeClass("hide").append(u)}});return o.done(v)}},f=function(e){if(e){var i=e.user_id,r=e.token,n=new Date,o=0;return n.setDate(n.getDate()-3),o=+n,n=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate(),l.request("crosses",{resources:{user_id:i},params:{updated_at:n,token:r}},function(e){var i,r=e.crosses;if(0===r.length)return t(".siderbar.updates").addClass("no-updates"),void 0;if(i=s.filter(r,function(e){var t=e.updated,i=!1;if(t){var r,a,n;for(r in t)"background"!==r&&(a=t[r],n=+new Date(a.updated_at.replace(/\-/g,"/")),n>o?i|=!0:(i|=!1,t[r]=!1))}return i?!0:void 0}),0===i.length)return t(".siderbar.updates").addClass("no-updates"),void 0;var n=t("#jst-updates").html(),d=a.compile(n),l=d({updates:i});t(".siderbar.updates .cross-tip").before(l)})}},v=function(e){e=i.get("authorization");var a=e.user_id,n=~~t(".user-xstats > .attended").text(),s=i.get("newbie_guide:"+a);if(3>=n&&!s&&0===t("#js-newbieguide").length){var o=document.createElement("script");o.id="js-newbieguide",o.type="text/javascript",o.async=!0,o.src="/static/js/newbieguide/0.0.5/newbieguide.min.js?t="+r.timestamp,document.getElementById("app-tmp").appendChild(o)}},h=function(){var e=i.get("iosapp_dismiss");e||t(".ios-app").removeClass("hide")};d.on("app:profile:show",function(e){e.done([p,c,f,h])}),d.on("app:profile:identities",function(e){u(e)}),d.on("app:addidentity",function(e){var i=t("#jst-identity-list"),r=a.compile(i.html()),n=r({identities:[e.identity]});t(".identity-list").append(n)});var m=t(document.body);m.on("dblclick.profile",".user-name h3",function(){var e=t.trim(t(this).html()),i=t('<input type="text" value="'+e+'" class="pull-left" />');i.data("oldValue",e),t(this).after(i).hide(),i.focusend(),t(".xbtn-changepassword").addClass("hide")}),m.on("focusout.profile keydown.profile",".user-name input",function(e){var r=e.type,a=e.keyCode;if("focusout"===r||9===a||!e.shiftKey&&13===a){var n=t.trim(t(this).val()),s=t(this).data("oldValue");if(t(this).hide().prev().html(n||s).show(),t(this).remove(),!t(".settings-panel").data("hoverout")&&t(".xbtn-changepassword").removeClass("hide"),!n||n===s)return;var o=i.get("authorization"),u=o.token;l.request("updateUser",{type:"POST",params:{token:u},data:{name:n}},function(e){i.set("user",e.user),d.emit("app:page:changeusername",n)})}}),m.on("dblclick.profile",".identity-list li .identity > span.identityname em",function(){var e=t(this),i=e.parents("li"),r=i.data("provider"),a=i.data("editable");if(-1!=="twitter facebook google flickr instagram dropbox".indexOf(r))i.find(".isOAuth").removeClass("hide");else if(a){var n=t.trim(e.text()),s=t('<input type="text" value="'+n+'" class="username-input" />');s.data("oldValue",n),e.after(s).hide(),s.focusend()}}),m.on("focusout.profile keydown.profile",".identity-list .username-input",function(e){var r=e.type,a=e.keyCode;if("focusout"===r||9===a||!e.shiftKey&&13===a){var n=t.trim(t(this).val()),s=t(this).data("oldValue"),o=t(this).parents("li").data("identity-id");if(t(this).hide().prev().text(n||s).show(),t(this).remove(),!n||n===s)return;var d=i.get("authorization"),u=d.token;l.request("updateIdentity",{params:{token:u},resources:{identity_id:o},type:"POST",data:{name:n}},function(e){for(var t=e.identity,r=t.id,a=i.get("user"),n=a.identities,s=0,o=n.length;o>s;++s)if(n[s].id===r){n[s]=t;break}i.set("user",a)})}}),m.on("click.profile",".xbtn-accept, .xbtn-ignore",function(e){e.preventDefault(),e.stopPropagation();var r=t(this),a=r.data("action"),n=r.parent(),s=n.data("id"),o=t('.gr-a [data-id="'+s+'"]'),d=n.data("exfeeid"),u=n.data("identity-id"),p=n.data("name"),c=i.get("authorization"),f=c.token;l.request("rsvp",{params:{token:f},resources:{exfee_id:d},type:"POST",data:{rsvp:'[{"identity_id":'+u+', "rsvp_status": "'+a+'", "by_identity_id": '+u+"}]",by_identity_id:u}},function(){if("ACCEPTED"===a){var e=o.find(">div :first-child"),t=+e.text();e.text(t+1);var i=o.find(">div :last-child"),r=i.text();i.text(r+(r?", ":"")+p)}var s;n.parent().prev().length||n.parent().next().length||(s=n.parents(".invitations")),n.parent().remove(),s&&s.remove()})}),m.on("click.profile","#profile div.cross-type",function(e){e.preventDefault(),t(this).next().toggleClass("hide").next().toggleClass("hide"),t(this).find("span.arrow").toggleClass("lt rb")}),m.on("hover.profile",".changepassword",function(e){var i=e.type;t(this).data("hoverout","mouseleave"===i),"mouseenter"===i?t(this).addClass("xbtn-changepassword"):t(this).removeClass("xbtn-changepassword")}),m.on("click.profile",".more > a",function(e){e.preventDefault();var r=t(this),n=r.parent(),o=n.data("cate"),d=i.get("authorization"),u=d.token,p=d.user_id,c=n.prev().find(" .cross-box").length,f=o;l.request("crosslist",{params:{token:u},resources:{user_id:p},data:{more_category:f,more_position:c}},function(e){if(e.crosses.length){var t="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",i=a.compile(t);n.prev().append(i(e));var d=s.filter(e.more,function(e){return e===o?!0:void 0});d.length||r.remove()}})}),m.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(e){e.preventDefault(),i.set("iosapp_dismiss",!0),m.off("click.profile.iosapp"),t(this).parent().fadeOut()});var g,y=null,_=null,x=null;m.on("click.data-link",".user-avatar .avatar, .identity-list > li > .avatar",function(){var i=t(this),r=i.find("img");if(!i.parent().data("editable"))return!1;var a=i.parent().data("identity-id"),n={};a&&(n.identity_id=a),n["80_80"]=r[0].src,n["80_80"]=decodeURIComponent(n["80_80"]),n["80_80"].match(/\/80_80_/)||(n["80_80"]=""),n.original=n["80_80"].replace(/80_80_/,"original_"),y||(y=e("uploader").Uploader,g=t.extend(!0,{},e("uploader").uploadSettings,{options:{onHideBefore:function(){x=_=void 0}}})),_&&(_.hide(),_=null),_=new y(g).render(),_.show(n)}),m.dndsortable({delay:300,wrap:!0,list:".identity-list",items:" > li",sort:function(e,r){var a=t(e),n=t(r),s=n.parent(),o=a.index(),d=n.index(),u=s.data("draggable");if(u){o>d?n.before(a):n.after(a);var p=i.get("authorization"),c=[];s.find("> li").each(function(e,i){c.push(t(i).data("identity-id"))}),l.request("sortIdentities",{type:"POST",resources:{user_id:p.user_id},params:{token:p.token},data:{identity_order:"["+(""+c)+"]"}},function(){var e=i.get("user"),t=e.identities,r=t.splice(o,1)[0];t.splice(d,0,r),i.set("user",e),s.data("draggable",!0)}),s.data("draggable",!1)}},setData:function(e){return t(e).data("identity-id")},start:function(){var e=t(".settings-panel .identity-list"),i=e.find("> li"),r=!!e.data("draggable");return r?1===i.size()?!1:(t(this).addClass("dragme"),t(".xbtn-addidentity").addClass("hide"),t(".identities-trash").removeClass("hide over"),void 0):!1},end:function(){t(this).removeClass("dragme"),t(".xbtn-addidentity").removeClass("hide"),t(".identities-trash").addClass("hide over")}}),m.on("dragenter.profile",".trash-overlay",function(){return t(this).parent().addClass("over"),t(".icon24-trash").addClass("icon24-trash-red"),!1}),m.on("dragover.profile",".trash-overlay",function(e){return e.stopPropagation(),e.preventDefault(),!1}),m.on("dragleave.profile",".trash-overlay",function(){return t(this).parent().removeClass("over"),t(".icon24-trash").removeClass("icon24-trash-red"),!1}),m.data("trash-overlay-deletable",!0),m.on("drop.profile",".trash-overlay",function(e){function r(e){var a=i.get("authorization"),n=a.token,o=l.request("deleteIdentity",{type:"POST",params:{token:n},data:{identity_id:e}},function(){var r=i.get("user"),a=r.identities;s.some(a,function(t,i){return t.id===e?(a.splice(i,1),!0):void 0}),i.set("user",r),t('.identity-list > li[data-identity-id="'+e+'"]').remove()},function(i){var a=i&&i.meta;if(a&&401===a.code&&"authenticate_timeout"===a.errorType){var n=t('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');t("#app-tmp").append(n);var s=t.Event("click.dialog.data-api");s._data={callback:function(){r(e)}},n.trigger(s)}});o.always(function(){m.data("trash-overlay-deletable",!0)})}var a=m.data("trash-overlay-deletable");if(a){m.data("trash-overlay-deletable",!1),e.stopPropagation(),e.preventDefault();var n=e.originalEvent.dataTransfer,o=+n.getData("text/plain");return t(this).parent().removeClass("over"),t(".icon24-trash").removeClass("icon24-trash-red"),r(o),!1}})});