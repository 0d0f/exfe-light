define("mobilecontroller",function(e,t,n){"use strict";var r=e("base"),i=e("store"),s=e("tween"),o=e("config"),u=e("handlebars"),a=e("util"),f=a.trim,l=a.parseId,c=navigator.userAgent.match(/iPad/),h=e("live"),p=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},d=Date.now||function(){return(new Date).getTime()},v=function(){window.location="itms://itunes.apple.com/us/app/exfe/id514026604"},m=function(e){App.set("tryRedirectAt",d()),window.location="exfe://crosses/"+(e||"")},g="webkitTransform"in document.body.style,y=function(e,t){var n=t.length===6?"":"3d";e.style[g?"webkitTransform":"transform"]="matrix"+n+"("+t.join(",")+")"},b=function(){var e=i.get("livecard");if(!e){var t={id:"",name:"",avatar:"",bio:"",identities:[]};e={card:t,latitude:"",longitude:"",accuracy:"",traits:[]};var n=i.get("user");n&&(t.name=n.name,t.avatar=n.avatar_filename,t.bio=n.bio,t.identities=n.identities),i.set("livecard",e)}return e.card.id="",e},w=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],E=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],S=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],x=0,T=function(){return"Controller-"+x++};t=n.exports={};var N=r.extend({initialize:function(e){this.cid=T(),this.initOptions(e),this.parseElement(),this.init(),N.caches[this.cid]=this},parseElement:function(){var e=this.element,t=this.options.template;e?this.element=e instanceof $?e:$(e):t&&(this.element=$(t));if(!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(e){this.setOptions(e);for(var t in e)t!=="options"&&(this[t]=e[t])},init:function(){},destory:function(){this.element.off(),this._destory()},_destory:function(){delete N.caches[this.cid],N.superclass.destory.call(this)},$:function(e){return this.element.find(e)}});N.caches=[],t.FooterController=N.extend({countDown:5,element:$("#app-footer"),init:function(){this.listen()},enableTimer:!0,listen:function(){var e=this,t=e.element;t.on("click.footer",".redirecting, .web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(){v()}).on("keydown.footer","#email",function(t){if(t.keyCode===13){var n=e.$("#email").val();e.addNotificationIdentity(n)}}).on("click.footer",".subscribe .btn_mail",function(){var t=f(e.$("#email").val());e.addNotificationIdentity(t)}),this.on("show",function(e,t,n,r){var i=e.height-96-(t?60:0);this.element.removeClass("hide"),this.element.css({position:"relative",top:i+"px"}),this.enableTimer&&this.emit("start-redirect"),c&&this.$(".web-version").removeClass("hide"),this.$(".error-info").toggleClass("hide",!r)}),this.on("show-from-cross",function(e,t,n){this.element.css({position:"relative",top:0}),this.emit("stop-redirect"),this.element.addClass("ft-bg"),this.cross={exfee_id:e,token:t},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),t&&this.$(".subscribe").removeClass("hide"),this.element.removeClass("hide"),$("#app-footer").addClass("ft-bg"),n&&this.enableTimer?this.emit("start-redirect",n):(this.$(".get-button").removeClass("hide"),$(".redirect").addClass("hide"))}),this.on("show-from-set-password",function(){var e=App.screen.height-96;this.element.removeClass("hide"),this.element.css({position:"absolute",top:e+"px"}),c&&this.$(".web-version").removeClass("hide"),this.emit("stop-redirect"),this.emit("start-redirect")}),this.on("start-redirect",function(t){var n=$(".redirecting").removeClass("hide"),r=n.find(".sec"),i=e.countDown,s;r.text(s=i),this.App.set("redirectTimer",setInterval(function(){s-=1,s>=1?r.text(s):(n.addClass("hide"),clearInterval(App.set("redirectTimer")),m(t))},1e3))}),this.on("stop-redirect",function(){this.enableTimer=!1,this.$(".get-button").removeClass("hide"),$(".redirecting").addClass("hide"),this.App.set("redirectTimer",clearInterval(this.App.set("redirectTimer")))})},addNotificationIdentity:function(e,t,n){t=this.cross.exfee_id,n=this.cross.token;var r=l(e);if(r&&r.provider!=="email"){$("#email.email").attr("placeholder","Bad email Address.");return}$.ajax({type:"POST",url:o.api_url+"/Exfee/"+t+"/AddNotificationIdentity"+"?token="+n,data:{provider:r.provider,external_username:r.external_username},success:function(e){e&&e.meta&&e.meta.code===200&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}})}}),t.VerifyController=N.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-verify").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.resolveToken;this.on("show",function(n,r){var i=function(){n.error=!0,r.redirect("/")};this.element.removeClass("hide"),$.ajax({type:"POST",url:o.api_url+"/Users/"+t.user_id+"?token="+t.token,data:{token:t.token},success:function(n){if(n&&n.meta&&n.meta.code===200){var r=n.response.user,s=r.identities;for(var o=0,u=s.length;o<u;++o){var a=s[o];if(a.id===t.identity_id){e.showIdentity(a),App.controllers.footer.emit("start-redirect","?user_id="+r.user_id+"&token="+t.token);return}}}i()},error:function(){i()}})})},showIdentity:function(e){var t=this.$(".identity");t.find(".name").text(e.name),t.find(".avatar").attr("src",e.avatar_filename),t.find(".provider").attr("src","/static/img/identity_"+e.provider+"_18_grey@2x.png"),t.next().removClass("hide")}}),t.SetPasswordController=N.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-setpassword").length||this.element.appendTo($("#app-body"))},submitPassword:function(){var e=this,t=this.token,n=this.$(".set-button button"),r=this.$(".error-info"),i=this.$("#name"),s=this.$("#password"),u=f(i.val()),a=s.val();u&&a.length>=4?(n.addClass("disabled").prop("disabled",!0),$.ajax({type:"POST",url:o.api_url+"/Users/ResetPassword",data:{token:t,name:u,password:a},success:function(t){var o=t.meta;o&&o.code===200?(i.blur(),s.blur(),e.$(".done-info").removeClass("hide"),r.html("").addClass("hide"),n.parent().addClass("hide"),App.controllers.footer.emit("show-from-set-password")):n.removeClass("disabled").prop("disabled",!0),n.removeClass("disabled").prop("disabled",!0)},error:function(){r.html("Failed to set password. Please try later.").removeClass("hide"),n.removeClass("disabled").prop("disabled",!1)}})):r.html("Password must be longer than four!").removeClass("hide")},listen:function(){var e=this,t=this.element,n=this.resolveToken,r,i;t.on("touchstart.setpassword",".pass",function(){i&&(clearTimeout(i),i=void 0),r=d();var e=$(this).prev();e.prop("type","password")}).on("touchend.setpassword",".pass",function(e){if(d()-r>300){var t=$(this).prev();t.prop("type","text"),i=setTimeout(function(){t.prop("type","password")},500)}return e.preventDefault(),e.stopPropagation(),!1}).on("keydown.setpassword","#password",function(t){t.keyCode===13?e.submitPassword():e.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){e.submitPassword()}),this.on("show",function(e,r){var i=function(){e.error=!0,r.redirect("/")};t.removeClass("hide"),$("#app-body").css("height","100%"),App.controllers.footer.emit("reset-position"),$.ajax({type:"POST",url:o.api_url+"/Users/"+n.user_id+"?token="+n.token,data:{token:n.token},success:function(e){var t=e.response.user;if(e&&e.meta&&e.meta.code===200){$(".identity .avatar").attr("src",t.avatar_filename),$(".identity .name").val(t.name);return}i()},error:function(){i()}})})}}),t.HomeController=N.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-home").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element;t.on("touchstart.home","#home-card",function(){clearInterval(App.set("tryTimer")),App.set("tryTimer",void 0),e.stopAnimate(),e.emit("goto-live")}),this.on("goto-live",function(){App.controllers.footer.emit("stop-redirect"),App.request.switchPageCallback=function(){t.addClass("hide")},App.response.redirect("/#live")}),this.on("show",function(e,n){var r=e.height;this.$(".logo-box .inner").css("top",(r-300)/2+"px"),t.removeClass("hide"),S[13]=(r-64)/2,this.setHomeCard(S),n=!!n&&n.code===404;var i=this.$(".title");i.find(".normal").toggleClass("hide",n),i.find(".invalid").toggleClass("hide",!n),this.startAnimate()})},setHomeCard:function(e){var t=b(),n=t.card,r=n.name,i=n.avatar,s=this.$("#home-card");y(s[0],e),n&&(r||i)?(i||(i=r?o.api_url+"/avatar/default?name="+r:"/static/img/portrait_default.png"),i="url("+i+")"):i="",s.find(".avatar").css("background-image",i)},aopts:{o:1},createAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),n=document.getElementById("home-card"),r=function(){t.style.opacity=e.o,n.style.opacity=1-e.o};this._a=(new s.Tween(e)).delay(1377).to({o:0},1377).easing(s.Easing.Cubic.InOut).onUpdate(r),this._b=(new s.Tween(e)).delay(1377).to({o:1},1377).easing(s.Easing.Cubic.InOut).onUpdate(r)},startAnimate:function(){!this._a&&!this._b&&this.createAnimate(),this._a.chain(this._b),this._b.chain(this._a),this._a.start()},stopAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),n=document.getElementById("home-card");this._a.chain(),this._b.chain(),this._b.stop(),this._a.stop(),e.o=t.style.opacity=1,n.style.opacity=0}}),t.CrossController=N.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-cross").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element,n=this.token,r=this.cross,i=e.$(".rsvp_toolbar");t.on("touchstart.cross",".portrait.me",function(){i.toggleClass("rsvp_toolbar_off",!i.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(){var t=prompt("Change my display name:");t?$.ajax({type:"POST",url:o.api_url+"/Identities/"+r.identity.id+"/Update"+"?token="+n,data:{name:t},success:function(t){t&&t.meta&&t.meta.code===200&&e.$(".name_me").html(p(t.response.identity.name))},error:function(){alert("Failed, please retry later.")}}):alert("Display name cannot be empty.")}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var t=$(this).hasClass("accepted")?"ACCEPTED":"DECLINED";e.rsvp(t)}).on("touchstart.cross",".inf_area .description",function(){var e=$(this),t=e.hasClass("clickable");if(t){var n=e.hasClass("limit");e.toggleClass("limit",!n),e.find(".xbtn-more .rb").toggleClass("hidden",n),e.find(".xbtn-more .lt").toggleClass("hidden",!n)}}),this.on("show",function(){t.removeClass("hide");var e=this.$(".inf_area .description");e.height()>130&&(e.addClass("limit clickable"),e.find(".xbtn-more").removeClass("hide"),e.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(e){var t=this.cross.identity.id,n=this.exfee_id,r=this.token,i=[{rsvp_status:e,identity_id:t,by_identity_id:t}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var s=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(e){case"ACCEPTED":s.addClass("accepted");break;case"DECLINED":s.addClass("declined");break;default:s.addClass("pending")}$.ajax({type:"post",url:o.api_url+"/Exfee/"+n+"/Rsvp?token="+r,data:{rsvp:JSON.stringify(i)},success:function(){},error:function(){alert("RSVP failed!")}})}}),t.LiveController=N.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-live").length?this.element=$("#app-live"):this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element,n,r;t.on("touchstart.live","#card-name",function(e){e.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus()}).on("touchend.live",".live-form",function(e){e.stopPropagation(),$(e.target).hasClass("live-form")&&(t.find(".input-item").blur(),App.response.redirect("/"))}).on("keydown.live","#card-name",function(t){var n=t.keyCode,r=f(this.value);r&&n===13&&e.addEmailOrPhone(this,r)}).on("blur.live","#card-name",function(){var t=f(this.value);t?e.addEmailOrPhone(this,t):e.setCardName(this)}).on("keydown.live blur.live","#add-identity",function(t){var n=t.keyCode,r=f(this.value);if(r&&n===13||t.type==="blur")e.addEmailOrPhone(this,r,!0),this.value=""}).on("keydown.live blur.live","#facebook-identity",function(t){var n=t.keyCode,r=f(this.value);if(r&&n===13||t.type==="blur")r+="@facebook",e.addFacebook(this,r)&&$("#add-identity-facebook").addClass("hide"),this.value=""}).on("touchstart.live",".list .input-item",function(){$(this).next().removeClass("hidden")}).on("blur.live",".list .input-item",function(){$(this).next().addClass("hidden"),e.updateIdentityLi(this)}).on("touchstart.live",".list .delete",function(){var t=$(this).prev()[0],n=f(t.value),r=t.getAttribute("data-provider"),i=r==="facebook",s;i&&(n+="@facebook"),s=l(n),$(this).parent().remove(),s&&s.provider&&e.removeIdentity(s),i&&e.emit("show-add-facebook")}).on("touchstart.live",".btn-start",function(){var t=$(".list .input-item");t.each(function(){e.updateIdentityLi(this)});var n=document.getElementById("card-name");n.blur();var r=f(n.value);r?e.liveCard.card.name=r:e.setCardName(n),setTimeout(function(){e.inspectFields()&&(e.emit("post-card"),e.emit("live-gather"))},23)}).on("hold:live",".live-gather .card .avatar",function(){var e=this,t=e.parentNode,n=$(t).data("card"),r=t.style.transform||t.style.webkitTransform,i=r.match(/([\-\d\.]+)/g).slice(1),s=document.getElementById("card-tip"),o="";if(n&&n.identities){for(var u=0,a=n.identities.length;u<a;++u){var f=n.identities[u],l=f.provider,c=f.external_username,h="";l!=="email"&&l!=="phone"&&(l=l.substr(0,1).toUpperCase()+l.substr(1),h='<span class="provider">'+l+"</span>"),o+='<li><span class="external-username'+(h?"":" normal")+'">'+c+"</span>"+h+"</li>"}s.querySelector("ul").innerHTML=o;var p=s.clientHeight,d=~~i[12]-68,v=~~i[13]-(6+p),m=93;d<0?d=10:d+200>=320&&(d=110);if(d===10||d===110)m=~~i[12]+32-7-d;i[12]=d,i[13]=v-5,i[14]=7,y(s,i),s.querySelector(".ang").style.left=m+"px",s.querySelector(".bio").innerText=n.bio,s.className="card-tip"}}).on("touchstart.live",".live-gather .card .avatar",function(e){var t=$(this),i=250,s=e.touches.length;r=d(),n&&(clearTimeout(n),n=void 0),s===1&&s>=1&&(n=setTimeout(function(){t.trigger("hold:live")},i))}).on("touchend.live",".live-gather .card .avatar",function(){n&&(clearTimeout(n),n=void 0);if(d()-r<250){var e=$(this).parent();e.hasClass("card-me")||e.toggleClass("selected")}document.getElementById("card-tip").className="card-tip hidden"}).on("touchstart.live",".back",function(){e.$(".live-gather").addClass("hide"),App.response.redirect("/")}).on("touchstart.live",".live-gather",function(e){var t=e.target,n=$(".live-title h2"),r=n[0],i=n.hasClass("clicked");i&&($(".wave").css("opacity",1),n.data("clicked",t===r||$.contains(r,t)).removeClass("clicked"),$(".live-tip").addClass("live-tip-close"))}).on("touchstart.live",".live-title h2",function(){var e=$(this),t=e.hasClass("clicked"),n=e.data("clicked");!t&&!n&&($(this).addClass("clicked"),$(".wave").css("opacity",0),$(".live-tip").removeClass("live-tip-close")),e.data("clicked",!1)}).on("touchstart.live",".btn-confirm",function(){e.postContacts()}),this.on("show-add-email",function(){this.$("#add-identity").removeClass("hide")}),this.on("show-add-facebook",function(){if(this.$('.list input[data-provider="facebook"]').length)return;this.$("#add-identity-facebook").removeClass("hide")}),this.on("show",function(e){this.screen=e,$("#app-footer").addClass("hide"),this.element.removeClass("hide");var t=e.height;S[13]=(t-64)/2,y(this.$("#icard")[0],S),this.$(".live-form, .live-gahter").css("min-height",t),this.$(".live-form").removeClass("hide"),this.$("#live-discover").css("opacity",0),this.$("#card-form").css({opacity:0,"min-height":(t-100)/t*100+"%"}),this.measurePositions(e.width,e.height-10,32,32),this.MAPS=this._MAPS.slice(0),this.$(".identities .list").empty(),this.liveCard=b(),this.updateMyCardForm(),this.startAnimate()}),this.on("post-card",function(){this.postMyCard()}),this.on("disabled-live-btn",function(e){this.$(".btn-start").toggleClass("disabled",e)}),this.on("live-gather",function(){this.$(".live-form").addClass("hide"),this.$(".live-gather").removeClass("hide"),this.$(".wave").addClass("start"),this.$(".live-gather").find(".card").remove();var e=this.liveCard.card,t=this.genCard(e,this.coords[0][0],0,0,!0,this.screen.ios).appendTo(this.$(".live-gather"));this.updateCard(t[0],e),this._others&&this.updateOthers()})},updateIdentityLi:function(e){var t=e.getAttribute("data-external-username"),n=e.getAttribute("data-provider"),r=e.getAttribute("data-name"),i="",s=f(e.value),o=!1,u=!1,a=!1,c;if(s){n==="facebook"&&(s+="@facebook"),c=l(s);if(c&&c.provider){var h=this.findIdentity(c),p=c.provider===n&&c.external_username===t;h&&!p&&(e.value=i),!h&&!p&&(a=!0,o=!0)}else u=!0,o=!0}else u=!0,o=!0;u&&(e.setAttribute("data-name",i),e.setAttribute("data-external-username",i),e.setAttribute("data-provider",i),setTimeout(function(){alert("Invalid contact.")},14)),a&&(e.setAttribute("data-name",c.name),e.setAttribute("data-external-username",c.external_username),e.setAttribute("data-provider",c.provider),e.value=c.external_username,$(e).prev().text(this.aliasProvider(c.provider)),this.updateLiveCard(c,"+")),o&&this.updateLiveCard({name:r,external_username:t,provider:n},"-",!0),(o||a)&&this.emit("post-card")},postContacts:function(){},inspectFields:function(){var e=this.liveCard.card;return e.name&&e.identities.length},updateCardName:function(e){e.name&&(this.liveCard.card.name=document.getElementById("card-name").value=e.name,i.set("livecard",this.liveCard))},updateMe:function(e){var t=document.getElementById("icard"),n=t.getAttribute("data-url"),r;n!==e.avatar&&(r=e.avatar,r||(r=e.name?o.api_url+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),n!==r&&(t.querySelector(".avatar").style.backgroundImage="url("+r+")",t.setAttribute("data-url",r)));var i=document.getElementById("card-bio");e.bio&&(i.innerText=e.bio),i.className=e.bio?"":"hide"},postMyCard:function(){i.set("livecard",this.liveCard);var e=this.liveCard.card;e.name&&e.identities.length&&h.init(e,$.proxy(this.liveCallback,this))},state:1,liveCallback:function(e){var t=this.liveCard,n=e.me;this.state===1&&n&&n.name&&n.identities.length&&(d()-n.timestamp>6e4&&this.updateCardName(n),this.updateMe(t.card=n),i.set("livecard",t)),this._others=e.others,this.updateOthers()},updateMyCardForm:function(){var e=this.liveCard,t=e.card,n=t.identities,r;if(n&&(r=n.length)){this.updateCardName(t),this.updateMe(t),this.postMyCard(),n=n.slice(0);var i,s;while(i=n.shift())s=i.provider,(s==="email"||s==="phone"||s==="facebook")&&this.addIdentity(i,!0);this.emit("show-add-email"),this.emit("show-add-facebook")}else this.emit("disabled-live-btn",!0)},resetLiveCard:function(){this.emit("disabled-live-btn",!0),i.clear("livecard"),this.liveCard=b()},findIdentity:function(e){var t=this.liveCard.card,n=t.identities,r=n.length;if(r)for(var i=0;i<r;++i){var s=n[i];if(s.provider===e.provider&&s.external_username===e.external_username)return!0}return!1},updateLiveCard:function(e,t,n){var r=this.liveCard.card,s=r.identities;if(t==="+")s.push(e);else{for(var o=0,u=s.length;o<u;++o){var a=s[o];if(a.provider===e.provider&&a.external_username===e.external_username){s.splice(o,1);break}}!n&&s.length===0&&this.resetLiveCard()}i.set("livecard",this.liveCard)},setCardName:function(e){var t=this.packedIdentities();if(t.length){var n=t[0],r="",i=n.external_username,s=n.provider;s==="phone"?r="Anonym_"+i.slice(i.length-4):r=i.split("@")[0],this.liveCard.card.name=e.value=r,e.setAttribute("placeholder","Name"),$(e).addClass("normal")}},addFacebook:function(e,t){var n=l(t),r=n.provider;return r&&r==="facebook"&&!this.existsByIdentity(n)?(this.addIdentity(n),!0):!1},addEmailOrPhone:function(e,t,n){n=!n;var r=l(t),i=r.provider;i&&(i==="email"||i==="phone")&&!this.existsByIdentity(r)&&(this.addIdentity(r),n&&this.setCardName(e)),n&&(this.emit("show-add-email"),this.emit("show-add-facebook")),this.emit("post-card")},aliasProvider:function(e){return e==="email"?e="Email":e==="phone"?e="Mobile":e==="facebook"&&(e="Facebook"),e},genIdentity:function(e){var t=u.compile($("#live-li-identity-tmpl").html()),n=e.provider;n=this.aliasProvider(n);var r=$(t({provider_alias:n,identity:e}));return r},resetCard:function(){this.state=0,this.$("#icard").removeAttr("data-url").find(".avatar").css("background",""),this.$("#card-name").attr("placeholder","Your email or mobile no.").removeClass("normal").val(""),this.$("#add-identity").addClass("hide"),this.$("#add-identity-facebook").addClass("hide")},removeIdentity:function(e){var t=this.$(".identities .list li");0===t.length?(this.resetCard(),this.emit("disabled-live-btn",!0)):e.provider==="facebook"&&this.emit("show-add-facebook"),this.updateLiveCard(e,"-"),this.emit("post-card")},addIdentity:function(e,t){t=!t,this.state=1;var n=this.$(".identities .list"),r=this.genIdentity(e);n.append(r),this.emit("disabled-live-btn",!1),t&&(this.updateLiveCard(e,"+"),this.emit("post-card"))},packedIdentities:function(){var e=this.$(".identities .list").find("input"),t=0,n=e.length,r=[],i,s,o,u,a;for(;t<n;++t){i=e.eq(t),s=i.attr("data-provider"),o=f(e.eq(t).val());if(!o)continue;s==="facebook"&&(o+="@facebook"),u=l(o),a=u.provider,a&&(a==="email"||a==="phone"||a==="facebook")&&r.push(u)}return r},existsByIdentity:function(e){var t=this.packedIdentities(),n=e.external_username,r=e.provider,i;if(0===t.length)return!1;while(i=t.shift())if(i.external_username===n&&i.provider===r)return!0;return!1},coords:"".split(),_MAPS:[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],MAPS:"".split(),measurePositions:function(e,t,n,r){var i=this.coords;i[0]=[[e*.5-n,t*.88-r]],i[1]=new Array(3),i[1][0]=[e*.25-5-n,t*.66+30-r],i[1][1]=[e*.5-n,t*.66-r],i[1][2]=[e*.75+5-n,t*.66+30-r],i[2]=new Array(4),i[2][0]=[e*.125+5-n,t*.44+40-r],i[2][1]=[e*.375-n,t*.44-r],i[2][2]=[e*.625-n,t*.44-r],i[2][3]=[e*.875-5-n,t*.44+40-r],i[3]=new Array(4),i[3][0]=[e*.125-n,t*.22+40-r],i[3][1]=[e*.375-n,t*.22-r],i[3][2]=[e*.625-n,t*.22-r],i[3][3]=[e*.875-n,t*.22+40-r]},genCard:function(e,t,n,r,i,s){var o=u.compile($("#live-card-tmpl").html()),a=w.slice(0);a[12]=t[0],a[13]=t[1];var f=$(o({g:n,i:r,matrix:a.join(","),"class":(i?"card-me":"card-other hide")+(s==="iphone4"?" card-iphone4":""),card:e}));return f.data("card",e),f},addCard:function(e){var t=this.MAPS;if(!t||t.length===0)return!1;var n=t.shift(),r=n[0],i=n[1],o=this.coords[r][i],u=this.genCard(e,o,r,i,!1,this.screen.ios),a=u[0],f=a.style,l=w.slice(0);l[0]=l[5]=0,l[12]=o[0],l[13]=o[1],u.data("card",e),this.$(".live-gather").append(u),(new s.Tween({o:0})).to({o:1},250).easing(s.Easing.Bounce.In).onStart(function(){y(a,l),u.removeClass("hide")}).onUpdate(function(){f.opacity=this.o,l[0]=l[5]=this.o,y(a,l)}).onComplete(function(){s.remove(this)}).start()},delCard:function(e){var t=this.MAPS,n=e.getAttribute("data-g"),r=e.getAttribute("data-i"),i=w.slice(0),o=this.coords[n][r],u=e.style;i[12]=o[0],i[13]=o[1],(new s.Tween({o:1})).to({o:0},250).easing(s.Easing.Bounce.Out).onUpdate(function(){u.opacity=this.o,y(e,i)}).onComplete(function(){t.unshift([n,r]),e.parentNode.removeChild(e),s.remove(this)}).start()},updateCard:function(e,t){var n=e.getAttribute("data-url"),r="";if(!n||n!==t.avatar)r=t.avatar,r||(r=t.name?o.api_url+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),n!==r&&(e.querySelector(".avatar").style.backgroundImage="url("+r+")",e.setAttribute("data-url",r));e.querySelector(".name").innerText=t.name,$(e).data("card",t)},updateOthers:function(){var e=this._others,t=document.querySelectorAll(".card-other"),n=t.length,r=0,i,s,o,u;for(;r<n;++r)i=t[r],s=i.getAttribute("id"),s in e||this.delCard(i);for(o in e)u=e[o],i=document.getElementById(u.id),i?this.updateCard(i,u):this.addCard(u)},createAnimate:function(){var e=this.$("#icard")[0],t=this.$("#card-form")[0],n=this.$("#live-discover")[0],r=S[13],i=E[13],o=S.slice(0);this.a=(new s.Tween({o:0})).to({o:1},500).easing(s.Easing.Cubic.In).onUpdate(function(){n.style.opacity=this.o,o[13]=(r-i)*(1-this.o)+i,y(e,o)}),this.b=(new s.Tween({o:0})).delay(250).to({o:1},500).onUpdate(function(){t.style.opacity=this.o})},startAnimate:function(){!this.a&&!this.b&&this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}})});