<<<<<<< HEAD
define("mobilecontroller",function(t,e,i){"use strict";var n=t("base"),s=t("store"),r=t("tween"),o=window._ENV_,a=o.api_url,l=o.app_scheme,c=l+"://crosses/",u=(o.AMAP_KEY,window.openExfe),h=t("handlebars"),d=t("util"),p=d.trim,f=d.parseId,m=navigator.userAgent.match(/iPad/),v=t("live"),g=function(t,e){return t.replace(e?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},y=Date.now||function(){return(new Date).getTime()},b="webkitTransform"in document.body.style,w=function(t,e){var i=6===e.length?"":"3d";t.style[b?"webkitTransform":"transform"]="matrix"+i+"("+e.join(",")+")"},x=function(){var t=s.get("livecard");if(!t){var e={id:"",name:"",avatar:"",bio:"",identities:[]};t={card:e,latitude:"",longitude:"",accuracy:"",traits:[]};var i=s.get("user");i&&(e.name=i.name,e.avatar=i.avatar_filename,e.bio=i.bio,e.identities=i.identities),s.set("livecard",t)}return t.card.id="",t},_=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],k=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],C=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],S=0,E=function(){return"Controller-"+S++};e=i.exports={};var P=n.extend({initialize:function(t){this.cid=E(),this.initOptions(t),this.parseElement(),this.init(),P.caches[this.cid]=this},parseElement:function(){var t=this.element,e=this.options.template;if(t?this.element=t instanceof $?t:$(t):e&&(this.element=$(e)),!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(t){this.setOptions(t);for(var e in t)"options"!==e&&(this[e]=t[e])},init:function(){},destory:function(){this.element.off(),this._destory()},_destory:function(){delete P.caches[this.cid],P.superclass.destory.call(this)},$:function(t){return this.element.find(t)}});P.caches=[],e.FooterController=P.extend({element:$("#app-footer"),init:function(){this.listen()},enableTimer:!0,listen:function(){var t=this,e=t.element;e.on("click.footer",".web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(t){return t.preventDefault(),u(),!1}).on("keydown.footer","#email",function(e){if(13===e.keyCode){var i=t.$("#email").val();t.addNotificationIdentity(i)}}).on("click.footer",".subscribe .btn_mail",function(){var e=p(t.$("#email").val());t.addNotificationIdentity(e)}),this.on("show",function(t,e,i,n){var s=t.height-96-(e?60:0);this.element.removeClass("hide"),this.element.css({position:"relative",top:s+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),m&&this.$(".web-version").removeClass("hide"),this.$(".error-info").toggleClass("hide",!n)}),this.on("reset-position",function(){var t=App.screen.height-96;this.element.removeClass("hide"),this.element.css({position:"absolute",top:t+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),m&&this.$(".web-version").removeClass("hide")}),this.on("show-from-cross",function(t,e,i){this.element.css({position:"relative",top:0}),this.element.addClass("ft-bg"),this.cross={exfee_id:t,token:e},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),i||this.$(".subscribe").removeClass("hide"),this.element.removeClass("hide"),$("#app-footer").addClass("ft-bg"),this.$(".get-button").removeClass("hide"),m&&this.$(".web-version").removeClass("hide")}),this.on("redirect",function(t,e){window.launchApp(c+t,e,500)})},addNotificationIdentity:function(t,e,i){e=this.cross.exfee_id,i=this.cross.token;var n=f(t);return n&&"email"!==n.provider?($("#email.email").attr("placeholder","Bad email Address."),void 0):($.ajax({type:"POST",url:a+"/Exfee/"+e+"/AddNotificationIdentity"+"?token="+i,data:{provider:n.provider,external_username:n.external_username},success:function(t){t&&t.meta&&200===t.meta.code&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}}),void 0)}}),e.VerifyController=P.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-verify").remove(),this.element.appendTo($("#app-body"))},listen:function(){var t=this,e=this.resolveToken;this.on("show",function(i,n){setTimeout(function(){window.scrollTo(0,0)},14);var r=function(){i.error=!0,n.redirect("/")};this.element.removeClass("hide"),$("#app-body").css("height","100%");var o=s.get("tmp-user");if(o){for(var l=o.identities,c=0,u=l.length;u>c;++c){var h=l[c];if(h.id===e.identity_id){t.showIdentity(h),t.$(".done-info").removeClass("hide");break}}return s.remove("tmp-user"),s.remove("tmp-token"),App.controllers.footer.emit("reset-position"),void 0}var d=function(t){App.controllers.footer.emit("redirect",t,function(){var t=window.location.search.substr(1);t&&(t="&"+t),window.location="/?redirect"+t+window.location.hash})},p=e.user_id,f=e.token;$.ajax({type:"POST",url:a+"/Users/"+p+"?token="+f,data:{token:f},success:function(i){var n=i.meta;if(n&&200===n.code)for(var o=i.response.user,a=o.identities,l=0,c=a.length;c>l;++l){var u=a[l];if(u.id===e.identity_id){if(t.showIdentity(u),t.$(".done-info").removeClass("hide"),s.set("tmp-user",o),App.controllers.footer.emit("reset-position"),p&&f){var h="?token="+f+"&user_id="+p+"&identity_id="+u.id;d(h)}break}}else r()},error:function(){r()}})})},showIdentity:function(t){var e=this.$(".identity");e.find(".name").text(t.name),e.find(".avatar").attr("src",t.avatar_filename)}}),e.SetPasswordController=P.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-setpassword").remove(),this.element.appendTo($("#app-body"))},submitPassword:function(){var t=this,e=this.token,i=this.$(".set-button button"),n=this.$(".error-info"),s=this.$("#name"),r=this.$("#password"),o=p(s.val()),l=r.val();l.length>=4?(i.addClass("disabled").prop("disabled",!0),$.ajax({type:"POST",url:a+"/Users/ResetPassword",data:{token:e,name:o,password:l},success:function(e){var o=e.meta;if(o&&200===o.code){s.blur(),r.blur(),t.$(".password").addClass("hide"),t.$(".done-info").removeClass("hide"),n.html("").addClass("hide"),i.parent().addClass("hide");var a=e.response.authorization;a&&App.controllers.footer.emit("redirect","?token="+a.token+"&user_id="+a.user_id,function(){var t=window.location.search.substr(1);t&&(t="&"+t),window.location="/?redirect"+t+window.location.hash})}else 401===o.code&&(n.html('<span class="t">Token expired.</span> Please request to reset password again.').removeClass("hide"),r.prop("disabled",!0),i.parent().addClass("hide"));i.prop("disabled",!0)},error:function(){n.html("Failed to set password. Please try later.").removeClass("hide"),i.prop("disabled",!1)}})):n.html("Password must be longer than four!").removeClass("hide")},listen:function(){var t,e,i=this,n=this.element,r=this.resolveToken;n.on("touchstart.setpassword",".pass",function(){e&&(clearTimeout(e),e=void 0),t=y();var i=$(this).prev();i.prop("type","password")}).on("touchend.setpassword",".pass",function(i){if(y()-t>300){var n=$(this).prev();n.prop("type","text"),e=setTimeout(function(){n.prop("type","password")},500)}return i.preventDefault(),i.stopPropagation(),!1}).on("keydown.setpassword","#password",function(t){13===t.keyCode?i.submitPassword():i.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){i.submitPassword()}),this.on("show",function(t,e){setTimeout(function(){window.scrollTo(0,0)},0);var i=function(){t.error=!0,e.redirect("/")};n.removeClass("hide"),$("#app-body").css("height","100%");var o=s.get("tmp-user");return o?($(".identity .avatar").attr("src",o.avatar_filename),$(".identity .name").html(o.name),window.noExfeApp&&($(".password").addClass("hide"),$(".set-button").addClass("hide"),$(".done-info").removeClass("hide")),App.controllers.footer.emit("reset-position"),s.remove("tmp-user"),s.remove("tmp-token"),void 0):($.ajax({type:"POST",url:a+"/Users/"+r.user_id+"?token="+r.token,data:{token:r.token},success:function(t){var e=t.response.user;return t&&t.meta&&200===t.meta.code?($(".identity .avatar").attr("src",e.avatar_filename),$(".identity .name").html(e.name),s.set("tmp-user",e),App.controllers.footer.emit("reset-position"),void 0):(i(),void 0)},error:function(){i()}}),void 0)})}}),e.HomeController=P.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-home").length||this.element.appendTo($("#app-body"))},listen:function(){var t=this,e=this.element;e.on("touchstart.home","#home-card",function(){t.stopAnimate(),t.emit("goto-live")}),this.on("goto-live",function(){App.request.switchPageCallback=function(){e.addClass("hide")},App.response.redirect("/#live")}),this.on("show",function(t,i){var n=t.height;this.$(".logo-box .inner").css("top",(n-300)/2+"px"),e.removeClass("hide"),C[13]=(n-64)/2,this.setHomeCard(C),i=!(!i||404!==i.code);var s=this.$(".title");s.find(".normal").removeClass("hide"),i&&setTimeout(function(){alert("Sorry. Your link is invalid or expired. Requested page was not found.")},14),this.$("#home-card").css("display","none")})},setHomeCard:function(t){var e=x(),i=e.card,n=i.name,s=i.avatar,r=this.$("#home-card");w(r[0],t),i&&(n||s)?(s||(s=n?a+"/avatar/default?name="+n:"/static/img/portrait_default.png"),s="url("+s+")"):s="",r.find(".avatar").css("background-image",s)},aopts:{o:1},createAnimate:function(){var t=this.aopts,e=document.getElementById("big-logo"),i=document.getElementById("home-card"),n=function(){e.style.opacity=t.o,i.style.opacity=1-t.o};this._a=new r.Tween(t).delay(1377).to({o:0},1377).easing(r.Easing.Cubic.InOut).onUpdate(n),this._b=new r.Tween(t).delay(1377).to({o:1},1377).easing(r.Easing.Cubic.InOut).onUpdate(n)},startAnimate:function(){this._a||this._b||this.createAnimate(),this._a.chain(this._b),this._b.chain(this._a),this._a.start()},stopAnimate:function(){var t=this.aopts,e=document.getElementById("big-logo"),i=document.getElementById("home-card");this._a.chain(),this._b.chain(),this._b.stop(),this._a.stop(),t.o=e.style.opacity=1,i.style.opacity=0}}),e.CrossController=P.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-cross").remove(),this.element.appendTo($("#app-body"))},listen:function(){var t=this,e=this.element,i=this.token,n=this.cross,s=t.$(".rsvp_toolbar");e.on("touchstart.cross",".portrait.me",function(){s.toggleClass("rsvp_toolbar_off",!s.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(){var e=prompt("Change my display name:");e?$.ajax({type:"POST",url:a+"/Identities/"+n.identity.id+"/Update"+"?token="+i,data:{name:e},success:function(e){e&&e.meta&&200===e.meta.code&&t.$(".name_me").html(g(e.response.identity.name))},error:function(){alert("Failed, please retry later.")}}):alert("Display name cannot be empty.")}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var e=$(this).hasClass("accepted")?"ACCEPTED":"DECLINED";t.rsvp(e)}).on("touchstart.cross",".inf_area .description",function(){var t=$(this),e=t.hasClass("clickable");if(e){var i=t.hasClass("limit");t.toggleClass("limit",!i),t.find(".xbtn-more .rb").toggleClass("hidden",i),t.find(".xbtn-more .lt").toggleClass("hidden",!i)}}),this.on("show",function(){e.removeClass("hide");var t=this.$(".inf_area .description");t.height()>130&&(t.addClass("limit clickable"),t.find(".xbtn-more").removeClass("hide"),t.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(t){var e=this.cross.identity.id,i=this.exfee_id,n=this.token,s=[{rsvp_status:t,identity_id:e,by_identity_id:e}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var r=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(t){case"ACCEPTED":r.addClass("accepted");break;case"DECLINED":r.addClass("declined");break;default:r.addClass("pending")}$.ajax({type:"post",url:a+"/Exfee/"+i+"/Rsvp?token="+n,data:{rsvp:JSON.stringify(s)},success:function(){},error:function(){alert("RSVP failed!")}})}}),e.LiveController=P.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-live").length?this.element=$("#app-live"):this.element.appendTo($("#app-body"))},listen:function(){var t,e,i=this,n=this.element;n.on("touchstart.live","#card-name",function(t){t.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus()}).on("touchend.live",".live-form",function(t){t.stopPropagation(),$(t.target).hasClass("live-form")&&(n.find(".input-item").blur(),App.response.redirect("/"))}).on("keydown.live","#card-name",function(t){var e=t.keyCode,n=p(this.value);n&&13===e&&i.addEmailOrPhone(this,n)}).on("blur.live","#card-name",function(){var t=p(this.value);t?i.addEmailOrPhone(this,t):i.setCardName(this)}).on("keydown.live blur.live","#add-identity",function(t){var e=t.keyCode,n=p(this.value);(n&&13===e||"blur"===t.type)&&(i.addEmailOrPhone(this,n,!0),this.value="")}).on("keydown.live blur.live","#facebook-identity",function(t){var e=t.keyCode,n=p(this.value);(n&&13===e||"blur"===t.type)&&(n+="@facebook",i.addFacebook(this,n)&&$("#add-identity-facebook").addClass("hide"),this.value="")}).on("touchstart.live",".list .input-item",function(){$(this).next().removeClass("hidden")}).on("blur.live",".list .input-item",function(){$(this).next().addClass("hidden"),i.updateIdentityLi(this)}).on("touchstart.live",".list .delete",function(){var t,e=$(this).prev()[0],n=p(e.value),s=e.getAttribute("data-provider"),r="facebook"===s;r&&(n+="@facebook"),t=f(n),$(this).parent().remove(),t&&t.provider&&i.removeIdentity(t),r&&i.emit("show-add-facebook")}).on("touchstart.live",".btn-start",function(){var t=$(".list .input-item");t.each(function(){i.updateIdentityLi(this)});var e=document.getElementById("card-name");e.blur();var n=p(e.value);n?i.liveCard.card.name=n:i.setCardName(e),setTimeout(function(){i.inspectFields()&&(i.emit("post-card"),i.emit("live-gather"))},23)}).on("hold:live",".live-gather .card .avatar",function(){var t=this,e=t.parentNode,i=$(e).data("card"),n=e.style.transform||e.style.webkitTransform,s=n.match(/([\-\d\.]+)/g).slice(1),r=document.getElementById("card-tip"),o="";if(i&&i.identities){for(var a=0,l=i.identities.length;l>a;++a){var c=i.identities[a],u=c.provider,h=c.external_username,d="";"email"!==u&&"phone"!==u&&(u=u.substr(0,1).toUpperCase()+u.substr(1),d='<span class="provider">'+u+"</span>"),o+='<li><span class="external-username'+(d?"":" normal")+'">'+h+"</span>"+d+"</li>"}r.querySelector("ul").innerHTML=o;var p=r.clientHeight,f=~~s[12]-68,m=~~s[13]-(6+p),v=93;0>f?f=10:f+200>=320&&(f=110),(10===f||110===f)&&(v=~~s[12]+32-7-f),s[12]=f,s[13]=m-5,s[14]=7,w(r,s),r.querySelector(".ang").style.left=v+"px",r.querySelector(".bio").innerText=i.bio,r.className="card-tip"}}).on("touchstart.live",".live-gather .card .avatar",function(i){var n=$(this),s=250,r=i.touches.length;e=y(),t&&(clearTimeout(t),t=void 0),1===r&&r>=1&&(t=setTimeout(function(){n.trigger("hold:live")},s))}).on("touchend.live",".live-gather .card .avatar",function(){if(t&&(clearTimeout(t),t=void 0),250>y()-e){var i=$(this).parent();i.hasClass("card-me")||i.toggleClass("selected")}document.getElementById("card-tip").className="card-tip hidden"}).on("touchstart.live",".back",function(){i.$(".live-gather").addClass("hide"),App.response.redirect("/")}).on("touchstart.live",".live-gather",function(t){var e=t.target,i=$(".live-title h2"),n=i[0],s=i.hasClass("clicked");s&&($(".wave").css("opacity",1),i.data("clicked",e===n||$.contains(n,e)).removeClass("clicked"),$(".live-tip").addClass("live-tip-close"))}).on("touchstart.live",".live-title h2",function(){var t=$(this),e=t.hasClass("clicked"),i=t.data("clicked");e||i||($(this).addClass("clicked"),$(".wave").css("opacity",0),$(".live-tip").removeClass("live-tip-close")),t.data("clicked",!1)}).on("touchstart.live",".btn-confirm",function(){i.postContacts()}),this.on("show-add-email",function(){this.$("#add-identity").removeClass("hide")}),this.on("show-add-facebook",function(){this.$('.list input[data-provider="facebook"]').length||this.$("#add-identity-facebook").removeClass("hide")}),this.on("show",function(t){v.startGeo(),this.screen=t,$("#app-footer").addClass("hide"),this.element.removeClass("hide");var e=t.height;C[13]=(e-64)/2,w(this.$("#icard")[0],C),this.$(".live-form, .live-gahter").css("min-height",e),this.$(".live-form").removeClass("hide"),this.$("#live-discover").css("opacity",0),this.$("#card-form").css({opacity:0,"min-height":100*((e-100)/e)+"%"}),this.measurePositions(t.width,t.height-10,32,32),this.MAPS=this._MAPS.slice(0),this.$(".identities .list").empty(),this.liveCard=x(),this.updateMyCardForm(),this.startAnimate()}),this.on("post-card",function(){this.postMyCard()}),this.on("disabled-live-btn",function(t){this.$(".btn-start").toggleClass("disabled",t)}),this.on("live-gather",function(){this.$(".live-form").addClass("hide"),this.$(".live-gather").removeClass("hide"),this.$(".wave").addClass("start"),this.$(".live-gather").find(".card").remove();var t=this.liveCard.card,e=this.genCard(t,this.coords[0][0],0,0,!0,this.screen.ios).appendTo(this.$(".live-gather"));this.updateCard(e[0],t),this._others&&this.updateOthers()})},updateIdentityLi:function(t){var e,i=t.getAttribute("data-external-username"),n=t.getAttribute("data-provider"),s=t.getAttribute("data-name"),r="",o=p(t.value),a=!1,l=!1,c=!1;if(o)if("facebook"===n&&(o+="@facebook"),e=f(o),e&&e.provider){var u=this.findIdentity(e),h=e.provider===n&&e.external_username===i;u&&!h&&(t.value=r),u||h||(c=!0,a=!0)}else l=!0,a=!0;else l=!0,a=!0;l&&(t.setAttribute("data-name",r),t.setAttribute("data-external-username",r),t.setAttribute("data-provider",r),setTimeout(function(){alert("Invalid contact.")},14)),c&&(t.setAttribute("data-name",e.name),t.setAttribute("data-external-username",e.external_username),t.setAttribute("data-provider",e.provider),t.value=e.external_username,$(t).prev().text(this.aliasProvider(e.provider)),this.updateLiveCard(e,"+")),a&&this.updateLiveCard({name:s,external_username:i,provider:n},"-",!0),(a||c)&&this.emit("post-card")},postContacts:function(){},inspectFields:function(){var t=this.liveCard.card;return t.name&&t.identities.length},updateCardName:function(t){t.name&&(this.liveCard.card.name=document.getElementById("card-name").value=t.name,s.set("livecard",this.liveCard))},updateMe:function(t){var e,i=document.getElementById("icard"),n=i.getAttribute("data-url");n!==t.avatar&&(e=t.avatar,e||(e=t.name?a+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),n!==e&&(i.querySelector(".avatar").style.backgroundImage="url("+e+")",i.setAttribute("data-url",e)));var s=document.getElementById("card-bio");t.bio&&(s.innerText=t.bio),s.className=t.bio?"":"hide"},postMyCard:function(){s.set("livecard",this.liveCard);var t=this.liveCard.card;t.name&&t.identities.length&&v.init(t,$.proxy(this.liveCallback,this))},state:1,liveCallback:function(t){var e=this.liveCard,i=t.me;1===this.state&&i&&i.name&&i.identities.length&&(y()-i.timestamp>6e4&&this.updateCardName(i),this.updateMe(e.card=i),s.set("livecard",e)),this._others=t.others,this.updateOthers()},updateMyCardForm:function(){var t,e=this.liveCard,i=e.card,n=i.identities;if(n&&(t=n.length)){this.updateCardName(i),this.updateMe(i),this.postMyCard(),n=n.slice(0);for(var s,r;s=n.shift();)r=s.provider,("email"===r||"phone"===r||"facebook"===r)&&this.addIdentity(s,!0);this.emit("show-add-email"),this.emit("show-add-facebook")}else this.emit("disabled-live-btn",!0)},resetLiveCard:function(){this.emit("disabled-live-btn",!0),s.clear("livecard"),this.liveCard=x()},findIdentity:function(t){var e=this.liveCard.card,i=e.identities,n=i.length;if(n)for(var s=0;n>s;++s){var r=i[s];if(r.provider===t.provider&&r.external_username===t.external_username)return!0}return!1},updateLiveCard:function(t,e,i){var n=this.liveCard.card,r=n.identities;if("+"===e)r.push(t);else{for(var o=0,a=r.length;a>o;++o){var l=r[o];if(l.provider===t.provider&&l.external_username===t.external_username){r.splice(o,1);break}}i||0!==r.length||this.resetLiveCard()}s.set("livecard",this.liveCard)},setCardName:function(t){var e=this.packedIdentities();if(e.length){var i=e[0],n="",s=i.external_username,r=i.provider;n="phone"===r?"Anonym_"+s.slice(s.length-4):s.split("@")[0],this.liveCard.card.name=t.value=n,t.setAttribute("placeholder","Name"),$(t).addClass("normal")}},addFacebook:function(t,e){var i=f(e),n=i.provider;return n&&"facebook"===n&&!this.existsByIdentity(i)?(this.addIdentity(i),!0):!1},addEmailOrPhone:function(t,e,i){i=!i;var n=f(e),s=n.provider;!s||"email"!==s&&"phone"!==s||this.existsByIdentity(n)||(this.addIdentity(n),i&&this.setCardName(t)),i&&(this.emit("show-add-email"),this.emit("show-add-facebook")),this.emit("post-card")},aliasProvider:function(t){return"email"===t?t="Email":"phone"===t?t="Mobile":"facebook"===t&&(t="Facebook"),t},genIdentity:function(t){var e=h.compile($("#live-li-identity-tmpl").html()),i=t.provider;i=this.aliasProvider(i);var n=$(e({provider_alias:i,identity:t}));return n},resetCard:function(){this.state=0,this.$("#icard").removeAttr("data-url").find(".avatar").css("background",""),this.$("#card-name").attr("placeholder","Your email or mobile no.").removeClass("normal").val(""),this.$("#add-identity").addClass("hide"),this.$("#add-identity-facebook").addClass("hide")},removeIdentity:function(t){var e=this.$(".identities .list li");0===e.length?(this.resetCard(),this.emit("disabled-live-btn",!0)):"facebook"===t.provider&&this.emit("show-add-facebook"),this.updateLiveCard(t,"-"),this.emit("post-card")},addIdentity:function(t,e){e=!e,this.state=1;var i=this.$(".identities .list"),n=this.genIdentity(t);i.append(n),this.emit("disabled-live-btn",!1),e&&(this.updateLiveCard(t,"+"),this.emit("post-card"))},packedIdentities:function(){for(var t,e,i,n,s,r=this.$(".identities .list").find("input"),o=0,a=r.length,l=[];a>o;++o)t=r.eq(o),e=t.attr("data-provider"),i=p(r.eq(o).val()),i&&("facebook"===e&&(i+="@facebook"),n=f(i),s=n.provider,!s||"email"!==s&&"phone"!==s&&"facebook"!==s||l.push(n));return l},existsByIdentity:function(t){var e,i=this.packedIdentities(),n=t.external_username,s=t.provider;if(0===i.length)return!1;for(;e=i.shift();)if(e.external_username===n&&e.provider===s)return!0;return!1},coords:"".split(),_MAPS:[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],MAPS:"".split(),measurePositions:function(t,e,i,n){var s=this.coords;s[0]=[[.5*t-i,.88*e-n]],s[1]=Array(3),s[1][0]=[.25*t-5-i,.66*e+30-n],s[1][1]=[.5*t-i,.66*e-n],s[1][2]=[.75*t+5-i,.66*e+30-n],s[2]=Array(4),s[2][0]=[.125*t+5-i,.44*e+40-n],s[2][1]=[.375*t-i,.44*e-n],s[2][2]=[.625*t-i,.44*e-n],s[2][3]=[.875*t-5-i,.44*e+40-n],s[3]=Array(4),s[3][0]=[.125*t-i,.22*e+40-n],s[3][1]=[.375*t-i,.22*e-n],s[3][2]=[.625*t-i,.22*e-n],s[3][3]=[.875*t-i,.22*e+40-n]},genCard:function(t,e,i,n,s,r){var o=h.compile($("#live-card-tmpl").html()),a=_.slice(0);a[12]=e[0],a[13]=e[1];var l=$(o({g:i,i:n,matrix:a.join(","),"class":(s?"card-me":"card-other hide")+("iphone4"===r?" card-iphone4":""),card:t}));return l.data("card",t),l},addCard:function(t){var e=this.MAPS;if(!e||0===e.length)return!1;var i=e.shift(),n=i[0],s=i[1],o=this.coords[n][s],a=this.genCard(t,o,n,s,!1,this.screen.ios),l=a[0],c=l.style,u=_.slice(0);u[0]=u[5]=0,u[12]=o[0],u[13]=o[1],a.data("card",t),this.$(".live-gather").append(a),new r.Tween({o:0}).to({o:1},250).easing(r.Easing.Bounce.In).onStart(function(){w(l,u),a.removeClass("hide")}).onUpdate(function(){c.opacity=this.o,u[0]=u[5]=this.o,w(l,u)}).onComplete(function(){r.remove(this)}).start()},delCard:function(t){var e=this.MAPS,i=t.getAttribute("data-g"),n=t.getAttribute("data-i"),s=_.slice(0),o=this.coords[i][n],a=t.style;s[12]=o[0],s[13]=o[1],new r.Tween({o:1}).to({o:0},250).easing(r.Easing.Bounce.Out).onUpdate(function(){a.opacity=this.o,w(t,s)}).onComplete(function(){e.unshift([i,n]),t.parentNode.removeChild(t),r.remove(this)}).start()},updateCard:function(t,e){var i=t.getAttribute("data-url"),n="";i&&i===e.avatar||(n=e.avatar,n||(n=e.name?a+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),i!==n&&(t.querySelector(".avatar").style.backgroundImage="url("+n+")",t.setAttribute("data-url",n))),t.querySelector(".name").innerText=e.name,$(t).data("card",e)},updateOthers:function(){for(var t,e,i,n,s=this._others,r=document.querySelectorAll(".card-other"),o=r.length,a=0;o>a;++a)t=r[a],e=t.getAttribute("id"),e in s||this.delCard(t);for(i in s)n=s[i],t=document.getElementById(n.id),t?this.updateCard(t,n):this.addCard(n)},createAnimate:function(){var t=this.$("#icard")[0],e=this.$("#card-form")[0],i=this.$("#live-discover")[0],n=C[13],s=k[13],o=C.slice(0);this.a=new r.Tween({o:0}).to({o:1},500).easing(r.Easing.Cubic.In).onUpdate(function(){i.style.opacity=this.o,o[13]=(n-s)*(1-this.o)+s,w(t,o)}),this.b=new r.Tween({o:0}).delay(250).to({o:1},500).onUpdate(function(){e.style.opacity=this.o})},startAnimate:function(){this.a||this.b||this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}});var T=t("routexstream");T.geoService,e.RouteXController=P.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-routex").remove(),this.element.appendTo($("#app-container")),this.loadMaps()},listen:function(){var t=this,e=t.element,i=$(window),n=t.$("#info-wins"),r=t.$("#open-exfe"),o=t.$("#locate");i.on("orientationchange",function(){i.height(),i.width(),o.css("-webkit-transform","translate3d(0, 0, 0)"),r.css("-webkit-transform","translate3d(0, 0, 0)")});var l=function(e,i){var n=t.checkGPSStyle();if(t.mapReadyStatus){var s=t.mapController.myuid;i&&t.mapController.showBreadcrumbs(s),t.mapController.fitBoundsWithDestination(s)}2===n||1===n&&t.startStream()};e.on("tap.maps",function(e){e.target===t.tapElement||$.contains(n[0],e.target)||(n.addClass("hide"),t.tapElement=null)}),e.on("tap.maps","#locate",l),e.on("tap.maps","#isme .avatar",function(e){return l(e,!0),t.tapElement===this?(n.addClass("hide"),t.tapElement=null,!1):(n.hasClass("hide")&&n.removeClass("hide"),n.find("#other-info").addClass("hide"),n.find("#my-info").removeClass("hide"),n.css("-webkit-transform","translate3d(50px, 6px, 0)"),t.tapElement=this,void 0)}),e.on("tap.maps","#identities .avatar",function(){var e=$(this),i=e.parent().parent(),s=i.data("uid");if(t.mapReadyStatus&&(t.mapController.showBreadcrumbs(s),t.mapController.fitBoundsWithDestination(s)),t.tapElement===this)return n.addClass("hide"),t.tapElement=null,!1;n.hasClass("hide")&&n.removeClass("hide"),n.find("#my-info").addClass("hide"),n.find("#other-info").removeClass("hide");var r=this.getBoundingClientRect();n.css("-webkit-transform","translate3d(50px,"+(r.top+r.height/2-62.5)+"px, 0)"),t.tapElement=this}),e.on("tap.maps","#free-identities .identities li",function(){var e=$(this),i=e.data("identity-id"),n=e.data("uid"),r=!!e.hasClass("touched");if(!r){var o=confirm("确认您的身份\n您刚拖入的头像已经被认领过， \n您确定没有拖错自己的头像？");o&&(e.addClass("touched"),$.ajax({type:"get",url:a+"/crosses/"+t.cross.id+"/freeidentities/"+i+"/itsme?token="+t.token,complete:function(){e.removeClass("touched")},success:function(e){var r=e.meta&&e.meta.code;if(200===r){console.log("success"),console.dir(e);var o=s.get("cats")||{};o[t.ctoken]=e.response.cross_access_token,t.myIdentityId=i,t.myuid=n,s.set("cats",o),t.$("#free-identities").hide().empty(),t.createIdentitiesList(),t.streaming()}},error:function(t){console.log("fail"),console.dir(t)}}))}});var c=e.find("#identities");c.on("scroll.maps",function(e){n.hasClass("hide")||n.addClass("hide");var i=$(this).find(".avatar"),s=this.getBoundingClientRect(),r=this.scrollTop,o=s.height,a=s.top,l=o+a,c=this._ids={};return i.each(function(t){var e=this.getBoundingClientRect(),i=$(this).parents(".identity").data("uid"),n=e.height/2+e.top;n>=a&&l>=n&&(c[i]=[t,46,n])}),t.mapController&&t.mapController.contains(),console.dir(c),0>=r||r+o>=this.scrollHeight?(e.stopPropagation(),e.preventDefault(),!1):void 0}),t.on("show",function(){$("html, body").css("min-height",i.height()),console.log("This is Smith-Token.",t.isSmithToken),t.isSmithToken?(e.find("#free-identities").removeClass("hide"),t.getFreeIdentities()):(t.createIdentitiesList(),t.streaming()),i.trigger("orientationchange")})},updateExfeeName:function(){this.element.find("#exfee-name").text(this.cross.exfee.name)},createFreeIdentitiesList:function(t){var e,i='<li data-identity-id="{{id}}" data-uid="{{external_username}}@{{provider}}"><img src="{{avatar_filename}}" alt="" class="avatar{{is_free}}" /><div class="name">{{external_username}}</div></li>',n=this.element.find("#free-identities .identities");for(t=t.slice(0);e=t.shift();)n.append(i.replace("{{id}}",e.id).replace("{{avatar_filename}}",e.avatar_filename).replace(/\{\{external_username\}\}/g,e.external_username).replace("{{provider}}",e.provider).replace("{{is_free}}",(e.free?" ":" no-")+"free"))},getFreeIdentities:function(){this.updateExfeeName(),this.createFreeIdentitiesList(this.freeIdentities)},loadMaps:function(){var e=this,i=t("routexmaps"),n=this.mapController=new i({url:"//ditu.google.cn/maps/api/js?sensor=true&language=zh_CN&v=3&callback=_loadmaps_",mapDiv:this.$("#map")[0],mapOptions:{zoom:5},svg:this.$("#svg")[0],callback:function(){e.mapReadyStatus=!0,e.mapController.updateGeoLocation(null)}});n.tracking=!0,n.load()},mapReadyStatus:!1,streaming:function(){this.initStream(),this.startStream(),console.log("start streaming")},initStream:function(){var t=this;T.init(t.cross.id,t.token,function(e,i){t.mapController&&t.mapController.draw(e,i)},function(t){console.log(t)})},startStream:function(){var t=this;t.switchGPSStyle(0),T.stopGeo(),T.startGeo(function(e){t.position=e,t.switchGPSStyle(2),s.set("last-latlng",{lat:e.latitude+"",lng:e.longitude+""}),t.trackGeoLocation(),console.log("GPS",e.latitude,e.longitude)},function(e){t.switchGPSStyle(1),console.log(e.status,e),T.stopGeo(),t.mapController&&t.mapController.switchGEOStyle(0)})},checkGPSStyle:function(){return~~this.$("#locate").attr("data-status")},switchGPSStyle:function(t,e){0===t?e="load":1===t?e="grey":(t=2,e="blue"),this.$("#locate").removeClass().addClass(e).attr("data-status",t)},trackGeoLocation:function(){var t=this.mapController,e=this.position,i=this.mapReadyStatus;i&&t&&(console.log("tracking"),t.myuid=this.myuid,t.updateGeoLocation(this.myuid,e))},updateMe:function(t){this.myIdentity=t;var e=this.$("#isme");e.attr("data-uid",t.external_username+"@"+t.provider),e.find("img").attr("src",t.avatar_filename)},createIdentitiesList:function(){var t,e,i=this.cross.exfee,n=this.$("#identities"),s=this.myIdentityId,r=i.invitations.slice(0);for(console.dir(i);t=r.shift();)if(e=t.identity,s!==e.id){var o=$('<div class="identity"><div class="abg"><img src="" alt="" class="avatar"></div><div class="detial"><i class="icon icon-dot-grey"></i><span class="distance">方位？</span></div></div>');o.attr("data-uid",e.external_username+"@"+e.provider),o.find("img").attr("src",e.avatar_filename),n.append(o)}else this.myuid=e.external_username+"@"+e.provider,this.updateMe(e);window.getComputedStyle(n[0]).webkitTransform,n.parent().css("-webkit-transform","translate3d(0, 0, 0)")}})});
=======
define("mobilecontroller",function(e,t,i){"use strict";var n=e("base"),r=e("store"),a=e("tween"),s=window._ENV_,o=s.api_url,l=s.app_scheme,c=l+"://crosses/",d=(s.AMAP_KEY,window.openExfe),u=e("handlebars"),h=e("util"),p=h.trim,f=h.parseId,m=navigator.userAgent.match(/iPad/),g=e("live"),v=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},y=Date.now||function(){return(new Date).getTime()},_="webkitTransform"in document.body.style,b=function(e,t){var i=6===t.length?"":"3d";e.style[_?"webkitTransform":"transform"]="matrix"+i+"("+t.join(",")+")"},x=function(){var e=r.get("livecard");if(!e){var t={id:"",name:"",avatar:"",bio:"",identities:[]};e={card:t,latitude:"",longitude:"",accuracy:"",traits:[]};var i=r.get("user");i&&(t.name=i.name,t.avatar=i.avatar_filename,t.bio=i.bio,t.identities=i.identities),r.set("livecard",e)}return e.card.id="",e},w=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],k=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],C=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],E=0,T=function(){return"Controller-"+E++};t=i.exports={};var S=n.extend({initialize:function(e){this.cid=T(),this.initOptions(e),this.parseElement(),this.init(),S.caches[this.cid]=this},parseElement:function(){var e=this.element,t=this.options.template;if(e?this.element=e instanceof $?e:$(e):t&&(this.element=$(t)),!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(e){this.setOptions(e);for(var t in e)"options"!==t&&(this[t]=e[t])},init:function(){},destory:function(){this.element.off(),this._destory()},_destory:function(){delete S.caches[this.cid],S.superclass.destory.call(this)},$:function(e){return this.element.find(e)}});S.caches=[],t.FooterController=S.extend({element:$("#app-footer"),init:function(){this.listen()},enableTimer:!0,listen:function(){var e=this,t=e.element;t.on("click.footer",".web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(e){return e.preventDefault(),d(),!1}).on("keydown.footer","#email",function(t){if(13===t.keyCode){var i=e.$("#email").val();e.addNotificationIdentity(i)}}).on("click.footer",".subscribe .btn_mail",function(){var t=p(e.$("#email").val());e.addNotificationIdentity(t)}),this.on("show",function(e,t,i,n){var r=e.height-96-(t?60:0);this.element.removeClass("hide"),this.element.css({position:"relative",top:r+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),m&&this.$(".web-version").removeClass("hide"),this.$(".error-info").toggleClass("hide",!n)}),this.on("reset-position",function(){var e=App.screen.height-96;this.element.removeClass("hide"),this.element.css({position:"absolute",top:e+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),m&&this.$(".web-version").removeClass("hide")}),this.on("show-from-cross",function(e,t,i){this.element.css({position:"relative",top:0}),this.element.addClass("ft-bg"),this.cross={exfee_id:e,token:t},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),i||this.$(".subscribe").removeClass("hide"),this.element.removeClass("hide"),$("#app-footer").addClass("ft-bg"),this.$(".get-button").removeClass("hide"),m&&this.$(".web-version").removeClass("hide")}),this.on("redirect",function(e,t){window.launchApp(c+e,t)})},addNotificationIdentity:function(e,t,i){t=this.cross.exfee_id,i=this.cross.token;var n=f(e);return n&&"email"!==n.provider?($("#email.email").attr("placeholder","Bad email Address."),void 0):($.ajax({type:"POST",url:o+"/Exfee/"+t+"/AddNotificationIdentity"+"?token="+i,data:{provider:n.provider,external_username:n.external_username},success:function(e){e&&e.meta&&200===e.meta.code&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}}),void 0)}}),t.VerifyController=S.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-verify").remove(),this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.resolveToken;this.on("show",function(i,n){setTimeout(function(){window.scrollTo(0,0)},14);var a=function(){i.error=!0,n.redirect("/")};this.element.removeClass("hide"),$("#app-body").css("height","100%");var s=r.get("tmp-user");if(s){for(var l=s.identities,c=0,d=l.length;d>c;++c){var u=l[c];if(u.id===t.identity_id){e.showIdentity(u),e.$(".done-info").removeClass("hide");break}}return r.remove("tmp-user"),r.remove("tmp-token"),App.controllers.footer.emit("reset-position"),void 0}var h=function(e){App.controllers.footer.emit("redirect",e,function(){var e=window.search.substr(1);e&&(e="&"+e),window.location="/?redirect"+e+window.location.hash})},p=t.user_id,f=t.token;$.ajax({type:"POST",url:o+"/Users/"+p+"?token="+f,data:{token:f},success:function(i){var n=i.meta;if(n&&200===n.code)for(var s=i.response.user,o=s.identities,l=0,c=o.length;c>l;++l){var d=o[l];if(d.id===t.identity_id){if(e.showIdentity(d),e.$(".done-info").removeClass("hide"),r.set("tmp-user",s),App.controllers.footer.emit("reset-position"),p&&f){var u="?token="+f+"&user_id="+p+"&identity_id="+d.id;h(u)}break}}else a()},error:function(){a()}})})},showIdentity:function(e){var t=this.$(".identity");t.find(".name").text(e.name),t.find(".avatar").attr("src",e.avatar_filename)}}),t.SetPasswordController=S.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-setpassword").remove(),this.element.appendTo($("#app-body"))},submitPassword:function(){var e=this,t=this.token,i=this.$(".set-button button"),n=this.$(".error-info"),r=this.$("#name"),a=this.$("#password"),s=p(r.val()),l=a.val();l.length>=4?(i.addClass("disabled").prop("disabled",!0),$.ajax({type:"POST",url:o+"/Users/ResetPassword",data:{token:t,name:s,password:l},success:function(t){var s=t.meta;if(s&&200===s.code){r.blur(),a.blur(),e.$(".password").addClass("hide"),e.$(".done-info").removeClass("hide"),n.html("").addClass("hide"),i.parent().addClass("hide");var o=t.response.authorization;o&&App.controllers.footer.emit("redirect","?token="+o.token+"&user_id="+o.user_id,function(){var e=window.location.search.substr(1);e&&(e="&"+e),window.location="/?redirect"+e+window.location.hash})}else 401===s.code&&(n.html('<span class="t">Token expired.</span> Please request to reset password again.').removeClass("hide"),a.prop("disabled",!0),i.parent().addClass("hide"));i.prop("disabled",!0)},error:function(){n.html("Failed to set password. Please try later.").removeClass("hide"),i.prop("disabled",!1)}})):n.html("Password must be longer than four!").removeClass("hide")},listen:function(){var e,t,i=this,n=this.element,a=this.resolveToken;n.on("touchstart.setpassword",".pass",function(){t&&(clearTimeout(t),t=void 0),e=y();var i=$(this).prev();i.prop("type","password")}).on("touchend.setpassword",".pass",function(i){if(y()-e>300){var n=$(this).prev();n.prop("type","text"),t=setTimeout(function(){n.prop("type","password")},500)}return i.preventDefault(),i.stopPropagation(),!1}).on("keydown.setpassword","#password",function(e){13===e.keyCode?i.submitPassword():i.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){i.submitPassword()}),this.on("show",function(e,t){setTimeout(function(){window.scrollTo(0,0)},0);var i=function(){e.error=!0,t.redirect("/")};n.removeClass("hide"),$("#app-body").css("height","100%");var s=r.get("tmp-user");return s?($(".identity .avatar").attr("src",s.avatar_filename),$(".identity .name").html(s.name),window.noExfeApp&&($(".password").addClass("hide"),$(".set-button").addClass("hide"),$(".done-info").removeClass("hide")),App.controllers.footer.emit("reset-position"),r.remove("tmp-user"),r.remove("tmp-token"),void 0):($.ajax({type:"POST",url:o+"/Users/"+a.user_id+"?token="+a.token,data:{token:a.token},success:function(e){var t=e.response.user;return e&&e.meta&&200===e.meta.code?($(".identity .avatar").attr("src",t.avatar_filename),$(".identity .name").html(t.name),r.set("tmp-user",t),App.controllers.footer.emit("reset-position"),void 0):(i(),void 0)},error:function(){i()}}),void 0)})}}),t.HomeController=S.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-home").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element;t.on("touchstart.home","#home-card",function(){e.stopAnimate(),e.emit("goto-live")}),this.on("goto-live",function(){App.request.switchPageCallback=function(){t.addClass("hide")},App.response.redirect("/#live")}),this.on("show",function(e,i){var n=e.height;this.$(".logo-box .inner").css("top",(n-300)/2+"px"),t.removeClass("hide"),C[13]=(n-64)/2,this.setHomeCard(C),i=!(!i||404!==i.code);var r=this.$(".title");r.find(".normal").removeClass("hide"),i&&setTimeout(function(){alert("Sorry. Your link is invalid or expired. Requested page was not found.")},14),this.$("#home-card").css("display","none")})},setHomeCard:function(e){var t=x(),i=t.card,n=i.name,r=i.avatar,a=this.$("#home-card");b(a[0],e),i&&(n||r)?(r||(r=n?o+"/avatar/default?name="+n:"/static/img/portrait_default.png"),r="url("+r+")"):r="",a.find(".avatar").css("background-image",r)},aopts:{o:1},createAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),i=document.getElementById("home-card"),n=function(){t.style.opacity=e.o,i.style.opacity=1-e.o};this._a=new a.Tween(e).delay(1377).to({o:0},1377).easing(a.Easing.Cubic.InOut).onUpdate(n),this._b=new a.Tween(e).delay(1377).to({o:1},1377).easing(a.Easing.Cubic.InOut).onUpdate(n)},startAnimate:function(){this._a||this._b||this.createAnimate(),this._a.chain(this._b),this._b.chain(this._a),this._a.start()},stopAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),i=document.getElementById("home-card");this._a.chain(),this._b.chain(),this._b.stop(),this._a.stop(),e.o=t.style.opacity=1,i.style.opacity=0}}),t.CrossController=S.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-cross").remove(),this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element,i=this.token,n=this.cross,r=e.$(".rsvp_toolbar");t.on("touchstart.cross",".portrait.me",function(){r.toggleClass("rsvp_toolbar_off",!r.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(){var t=prompt("Change my display name:");t?$.ajax({type:"POST",url:o+"/Identities/"+n.identity.id+"/Update"+"?token="+i,data:{name:t},success:function(t){t&&t.meta&&200===t.meta.code&&e.$(".name_me").html(v(t.response.identity.name))},error:function(){alert("Failed, please retry later.")}}):alert("Display name cannot be empty.")}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var t=$(this).hasClass("accepted")?"ACCEPTED":"DECLINED";e.rsvp(t)}).on("touchstart.cross",".inf_area .description",function(){var e=$(this),t=e.hasClass("clickable");if(t){var i=e.hasClass("limit");e.toggleClass("limit",!i),e.find(".xbtn-more .rb").toggleClass("hidden",i),e.find(".xbtn-more .lt").toggleClass("hidden",!i)}}),this.on("show",function(){t.removeClass("hide");var e=this.$(".inf_area .description");e.height()>130&&(e.addClass("limit clickable"),e.find(".xbtn-more").removeClass("hide"),e.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(e){var t=this.cross.identity.id,i=this.exfee_id,n=this.token,r=[{rsvp_status:e,identity_id:t,by_identity_id:t}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var a=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(e){case"ACCEPTED":a.addClass("accepted");break;case"DECLINED":a.addClass("declined");break;default:a.addClass("pending")}$.ajax({type:"post",url:o+"/Exfee/"+i+"/Rsvp?token="+n,data:{rsvp:JSON.stringify(r)},success:function(){},error:function(){alert("RSVP failed!")}})}}),t.LiveController=S.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-live").length?this.element=$("#app-live"):this.element.appendTo($("#app-body"))},listen:function(){var e,t,i=this,n=this.element;n.on("touchstart.live","#card-name",function(e){e.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus()}).on("touchend.live",".live-form",function(e){e.stopPropagation(),$(e.target).hasClass("live-form")&&(n.find(".input-item").blur(),App.response.redirect("/"))}).on("keydown.live","#card-name",function(e){var t=e.keyCode,n=p(this.value);n&&13===t&&i.addEmailOrPhone(this,n)}).on("blur.live","#card-name",function(){var e=p(this.value);e?i.addEmailOrPhone(this,e):i.setCardName(this)}).on("keydown.live blur.live","#add-identity",function(e){var t=e.keyCode,n=p(this.value);(n&&13===t||"blur"===e.type)&&(i.addEmailOrPhone(this,n,!0),this.value="")}).on("keydown.live blur.live","#facebook-identity",function(e){var t=e.keyCode,n=p(this.value);(n&&13===t||"blur"===e.type)&&(n+="@facebook",i.addFacebook(this,n)&&$("#add-identity-facebook").addClass("hide"),this.value="")}).on("touchstart.live",".list .input-item",function(){$(this).next().removeClass("hidden")}).on("blur.live",".list .input-item",function(){$(this).next().addClass("hidden"),i.updateIdentityLi(this)}).on("touchstart.live",".list .delete",function(){var e,t=$(this).prev()[0],n=p(t.value),r=t.getAttribute("data-provider"),a="facebook"===r;a&&(n+="@facebook"),e=f(n),$(this).parent().remove(),e&&e.provider&&i.removeIdentity(e),a&&i.emit("show-add-facebook")}).on("touchstart.live",".btn-start",function(){var e=$(".list .input-item");e.each(function(){i.updateIdentityLi(this)});var t=document.getElementById("card-name");t.blur();var n=p(t.value);n?i.liveCard.card.name=n:i.setCardName(t),setTimeout(function(){i.inspectFields()&&(i.emit("post-card"),i.emit("live-gather"))},23)}).on("hold:live",".live-gather .card .avatar",function(){var e=this,t=e.parentNode,i=$(t).data("card"),n=t.style.transform||t.style.webkitTransform,r=n.match(/([\-\d\.]+)/g).slice(1),a=document.getElementById("card-tip"),s="";if(i&&i.identities){for(var o=0,l=i.identities.length;l>o;++o){var c=i.identities[o],d=c.provider,u=c.external_username,h="";"email"!==d&&"phone"!==d&&(d=d.substr(0,1).toUpperCase()+d.substr(1),h='<span class="provider">'+d+"</span>"),s+='<li><span class="external-username'+(h?"":" normal")+'">'+u+"</span>"+h+"</li>"}a.querySelector("ul").innerHTML=s;var p=a.clientHeight,f=~~r[12]-68,m=~~r[13]-(6+p),g=93;0>f?f=10:f+200>=320&&(f=110),(10===f||110===f)&&(g=~~r[12]+32-7-f),r[12]=f,r[13]=m-5,r[14]=7,b(a,r),a.querySelector(".ang").style.left=g+"px",a.querySelector(".bio").innerText=i.bio,a.className="card-tip"}}).on("touchstart.live",".live-gather .card .avatar",function(i){var n=$(this),r=250,a=i.touches.length;t=y(),e&&(clearTimeout(e),e=void 0),1===a&&a>=1&&(e=setTimeout(function(){n.trigger("hold:live")},r))}).on("touchend.live",".live-gather .card .avatar",function(){if(e&&(clearTimeout(e),e=void 0),250>y()-t){var i=$(this).parent();i.hasClass("card-me")||i.toggleClass("selected")}document.getElementById("card-tip").className="card-tip hidden"}).on("touchstart.live",".back",function(){i.$(".live-gather").addClass("hide"),App.response.redirect("/")}).on("touchstart.live",".live-gather",function(e){var t=e.target,i=$(".live-title h2"),n=i[0],r=i.hasClass("clicked");r&&($(".wave").css("opacity",1),i.data("clicked",t===n||$.contains(n,t)).removeClass("clicked"),$(".live-tip").addClass("live-tip-close"))}).on("touchstart.live",".live-title h2",function(){var e=$(this),t=e.hasClass("clicked"),i=e.data("clicked");t||i||($(this).addClass("clicked"),$(".wave").css("opacity",0),$(".live-tip").removeClass("live-tip-close")),e.data("clicked",!1)}).on("touchstart.live",".btn-confirm",function(){i.postContacts()}),this.on("show-add-email",function(){this.$("#add-identity").removeClass("hide")}),this.on("show-add-facebook",function(){this.$('.list input[data-provider="facebook"]').length||this.$("#add-identity-facebook").removeClass("hide")}),this.on("show",function(e){g.startGeo(),this.screen=e,$("#app-footer").addClass("hide"),this.element.removeClass("hide");var t=e.height;C[13]=(t-64)/2,b(this.$("#icard")[0],C),this.$(".live-form, .live-gahter").css("min-height",t),this.$(".live-form").removeClass("hide"),this.$("#live-discover").css("opacity",0),this.$("#card-form").css({opacity:0,"min-height":100*((t-100)/t)+"%"}),this.measurePositions(e.width,e.height-10,32,32),this.MAPS=this._MAPS.slice(0),this.$(".identities .list").empty(),this.liveCard=x(),this.updateMyCardForm(),this.startAnimate()}),this.on("post-card",function(){this.postMyCard()}),this.on("disabled-live-btn",function(e){this.$(".btn-start").toggleClass("disabled",e)}),this.on("live-gather",function(){this.$(".live-form").addClass("hide"),this.$(".live-gather").removeClass("hide"),this.$(".wave").addClass("start"),this.$(".live-gather").find(".card").remove();var e=this.liveCard.card,t=this.genCard(e,this.coords[0][0],0,0,!0,this.screen.ios).appendTo(this.$(".live-gather"));this.updateCard(t[0],e),this._others&&this.updateOthers()})},updateIdentityLi:function(e){var t,i=e.getAttribute("data-external-username"),n=e.getAttribute("data-provider"),r=e.getAttribute("data-name"),a="",s=p(e.value),o=!1,l=!1,c=!1;if(s)if("facebook"===n&&(s+="@facebook"),t=f(s),t&&t.provider){var d=this.findIdentity(t),u=t.provider===n&&t.external_username===i;d&&!u&&(e.value=a),d||u||(c=!0,o=!0)}else l=!0,o=!0;else l=!0,o=!0;l&&(e.setAttribute("data-name",a),e.setAttribute("data-external-username",a),e.setAttribute("data-provider",a),setTimeout(function(){alert("Invalid contact.")},14)),c&&(e.setAttribute("data-name",t.name),e.setAttribute("data-external-username",t.external_username),e.setAttribute("data-provider",t.provider),e.value=t.external_username,$(e).prev().text(this.aliasProvider(t.provider)),this.updateLiveCard(t,"+")),o&&this.updateLiveCard({name:r,external_username:i,provider:n},"-",!0),(o||c)&&this.emit("post-card")},postContacts:function(){},inspectFields:function(){var e=this.liveCard.card;return e.name&&e.identities.length},updateCardName:function(e){e.name&&(this.liveCard.card.name=document.getElementById("card-name").value=e.name,r.set("livecard",this.liveCard))},updateMe:function(e){var t,i=document.getElementById("icard"),n=i.getAttribute("data-url");n!==e.avatar&&(t=e.avatar,t||(t=e.name?o+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),n!==t&&(i.querySelector(".avatar").style.backgroundImage="url("+t+")",i.setAttribute("data-url",t)));var r=document.getElementById("card-bio");e.bio&&(r.innerText=e.bio),r.className=e.bio?"":"hide"},postMyCard:function(){r.set("livecard",this.liveCard);var e=this.liveCard.card;e.name&&e.identities.length&&g.init(e,$.proxy(this.liveCallback,this))},state:1,liveCallback:function(e){var t=this.liveCard,i=e.me;1===this.state&&i&&i.name&&i.identities.length&&(y()-i.timestamp>6e4&&this.updateCardName(i),this.updateMe(t.card=i),r.set("livecard",t)),this._others=e.others,this.updateOthers()},updateMyCardForm:function(){var e,t=this.liveCard,i=t.card,n=i.identities;if(n&&(e=n.length)){this.updateCardName(i),this.updateMe(i),this.postMyCard(),n=n.slice(0);for(var r,a;r=n.shift();)a=r.provider,("email"===a||"phone"===a||"facebook"===a)&&this.addIdentity(r,!0);this.emit("show-add-email"),this.emit("show-add-facebook")}else this.emit("disabled-live-btn",!0)},resetLiveCard:function(){this.emit("disabled-live-btn",!0),r.clear("livecard"),this.liveCard=x()},findIdentity:function(e){var t=this.liveCard.card,i=t.identities,n=i.length;if(n)for(var r=0;n>r;++r){var a=i[r];if(a.provider===e.provider&&a.external_username===e.external_username)return!0}return!1},updateLiveCard:function(e,t,i){var n=this.liveCard.card,a=n.identities;if("+"===t)a.push(e);else{for(var s=0,o=a.length;o>s;++s){var l=a[s];if(l.provider===e.provider&&l.external_username===e.external_username){a.splice(s,1);break}}i||0!==a.length||this.resetLiveCard()}r.set("livecard",this.liveCard)},setCardName:function(e){var t=this.packedIdentities();if(t.length){var i=t[0],n="",r=i.external_username,a=i.provider;n="phone"===a?"Anonym_"+r.slice(r.length-4):r.split("@")[0],this.liveCard.card.name=e.value=n,e.setAttribute("placeholder","Name"),$(e).addClass("normal")}},addFacebook:function(e,t){var i=f(t),n=i.provider;return n&&"facebook"===n&&!this.existsByIdentity(i)?(this.addIdentity(i),!0):!1},addEmailOrPhone:function(e,t,i){i=!i;var n=f(t),r=n.provider;!r||"email"!==r&&"phone"!==r||this.existsByIdentity(n)||(this.addIdentity(n),i&&this.setCardName(e)),i&&(this.emit("show-add-email"),this.emit("show-add-facebook")),this.emit("post-card")},aliasProvider:function(e){return"email"===e?e="Email":"phone"===e?e="Mobile":"facebook"===e&&(e="Facebook"),e},genIdentity:function(e){var t=u.compile($("#live-li-identity-tmpl").html()),i=e.provider;i=this.aliasProvider(i);var n=$(t({provider_alias:i,identity:e}));return n},resetCard:function(){this.state=0,this.$("#icard").removeAttr("data-url").find(".avatar").css("background",""),this.$("#card-name").attr("placeholder","Your email or mobile no.").removeClass("normal").val(""),this.$("#add-identity").addClass("hide"),this.$("#add-identity-facebook").addClass("hide")},removeIdentity:function(e){var t=this.$(".identities .list li");0===t.length?(this.resetCard(),this.emit("disabled-live-btn",!0)):"facebook"===e.provider&&this.emit("show-add-facebook"),this.updateLiveCard(e,"-"),this.emit("post-card")},addIdentity:function(e,t){t=!t,this.state=1;var i=this.$(".identities .list"),n=this.genIdentity(e);i.append(n),this.emit("disabled-live-btn",!1),t&&(this.updateLiveCard(e,"+"),this.emit("post-card"))},packedIdentities:function(){for(var e,t,i,n,r,a=this.$(".identities .list").find("input"),s=0,o=a.length,l=[];o>s;++s)e=a.eq(s),t=e.attr("data-provider"),i=p(a.eq(s).val()),i&&("facebook"===t&&(i+="@facebook"),n=f(i),r=n.provider,!r||"email"!==r&&"phone"!==r&&"facebook"!==r||l.push(n));return l},existsByIdentity:function(e){var t,i=this.packedIdentities(),n=e.external_username,r=e.provider;if(0===i.length)return!1;for(;t=i.shift();)if(t.external_username===n&&t.provider===r)return!0;return!1},coords:"".split(),_MAPS:[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],MAPS:"".split(),measurePositions:function(e,t,i,n){var r=this.coords;r[0]=[[.5*e-i,.88*t-n]],r[1]=Array(3),r[1][0]=[.25*e-5-i,.66*t+30-n],r[1][1]=[.5*e-i,.66*t-n],r[1][2]=[.75*e+5-i,.66*t+30-n],r[2]=Array(4),r[2][0]=[.125*e+5-i,.44*t+40-n],r[2][1]=[.375*e-i,.44*t-n],r[2][2]=[.625*e-i,.44*t-n],r[2][3]=[.875*e-5-i,.44*t+40-n],r[3]=Array(4),r[3][0]=[.125*e-i,.22*t+40-n],r[3][1]=[.375*e-i,.22*t-n],r[3][2]=[.625*e-i,.22*t-n],r[3][3]=[.875*e-i,.22*t+40-n]},genCard:function(e,t,i,n,r,a){var s=u.compile($("#live-card-tmpl").html()),o=w.slice(0);o[12]=t[0],o[13]=t[1];var l=$(s({g:i,i:n,matrix:o.join(","),"class":(r?"card-me":"card-other hide")+("iphone4"===a?" card-iphone4":""),card:e}));return l.data("card",e),l},addCard:function(e){var t=this.MAPS;if(!t||0===t.length)return!1;var i=t.shift(),n=i[0],r=i[1],s=this.coords[n][r],o=this.genCard(e,s,n,r,!1,this.screen.ios),l=o[0],c=l.style,d=w.slice(0);d[0]=d[5]=0,d[12]=s[0],d[13]=s[1],o.data("card",e),this.$(".live-gather").append(o),new a.Tween({o:0}).to({o:1},250).easing(a.Easing.Bounce.In).onStart(function(){b(l,d),o.removeClass("hide")}).onUpdate(function(){c.opacity=this.o,d[0]=d[5]=this.o,b(l,d)}).onComplete(function(){a.remove(this)}).start()},delCard:function(e){var t=this.MAPS,i=e.getAttribute("data-g"),n=e.getAttribute("data-i"),r=w.slice(0),s=this.coords[i][n],o=e.style;r[12]=s[0],r[13]=s[1],new a.Tween({o:1}).to({o:0},250).easing(a.Easing.Bounce.Out).onUpdate(function(){o.opacity=this.o,b(e,r)}).onComplete(function(){t.unshift([i,n]),e.parentNode.removeChild(e),a.remove(this)}).start()},updateCard:function(e,t){var i=e.getAttribute("data-url"),n="";i&&i===t.avatar||(n=t.avatar,n||(n=t.name?o+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),i!==n&&(e.querySelector(".avatar").style.backgroundImage="url("+n+")",e.setAttribute("data-url",n))),e.querySelector(".name").innerText=t.name,$(e).data("card",t)},updateOthers:function(){for(var e,t,i,n,r=this._others,a=document.querySelectorAll(".card-other"),s=a.length,o=0;s>o;++o)e=a[o],t=e.getAttribute("id"),t in r||this.delCard(e);for(i in r)n=r[i],e=document.getElementById(n.id),e?this.updateCard(e,n):this.addCard(n)},createAnimate:function(){var e=this.$("#icard")[0],t=this.$("#card-form")[0],i=this.$("#live-discover")[0],n=C[13],r=k[13],s=C.slice(0);this.a=new a.Tween({o:0}).to({o:1},500).easing(a.Easing.Cubic.In).onUpdate(function(){i.style.opacity=this.o,s[13]=(n-r)*(1-this.o)+r,b(e,s)}),this.b=new a.Tween({o:0}).delay(250).to({o:1},500).onUpdate(function(){t.style.opacity=this.o})},startAnimate:function(){this.a||this.b||this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}});var M=e("routexstream");M.geoService,t.RouteXController=S.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-routex").remove(),this.element.appendTo($("#app-container")),this.loadMaps()},listen:function(){var e=this,t=e.element,i=$(window),n=e.$("#info-wins"),a=e.$("#open-exfe"),s=e.$("#locate");i.on("orientationchange",function(){i.height(),i.width(),s.css("-webkit-transform","translate3d(0, 0, 0)"),a.css("-webkit-transform","translate3d(0, 0, 0)")});var l=function(t,i){var n=e.checkGPSStyle();if(e.mapReadyStatus){var r=e.mapController.myuid;i&&e.mapController.showBreadcrumbs(r),e.mapController.fitBoundsWithDestination(r)}2===n||1===n&&e.startStream()};t.on("tap.maps",function(t){t.target===e.tapElement||$.contains(n[0],t.target)||(n.addClass("hide"),e.tapElement=null)}),t.on("tap.maps","#locate",l),t.on("tap.maps","#isme .avatar",function(t){return l(t,!0),e.tapElement===this?(n.addClass("hide"),e.tapElement=null,!1):(n.hasClass("hide")&&n.removeClass("hide"),n.find("#other-info").addClass("hide"),n.find("#my-info").removeClass("hide"),n.css("-webkit-transform","translate3d(50px, 6px, 0)"),e.tapElement=this,void 0)}),t.on("tap.maps","#identities .avatar",function(){var t=$(this),i=t.parent().parent(),r=i.data("uid");if(e.mapReadyStatus&&(e.mapController.showBreadcrumbs(r),e.mapController.fitBoundsWithDestination(r)),e.tapElement===this)return n.addClass("hide"),e.tapElement=null,!1;n.hasClass("hide")&&n.removeClass("hide"),n.find("#my-info").addClass("hide"),n.find("#other-info").removeClass("hide");var a=this.getBoundingClientRect();n.css("-webkit-transform","translate3d(50px,"+(a.top+a.height/2-62.5)+"px, 0)"),e.tapElement=this}),t.on("tap.maps","#free-identities .identities li",function(){var t=$(this),i=t.data("identity-id"),n=t.data("uid"),a=!!t.hasClass("touched");if(!a){var s=confirm("确认您的身份\n您刚拖入的头像已经被认领过， \n您确定没有拖错自己的头像？");s&&(t.addClass("touched"),$.ajax({type:"get",url:o+"/crosses/"+e.cross.id+"/freeidentities/"+i+"/itsme?token="+e.token,complete:function(){t.removeClass("touched")},success:function(t){var a=t.meta&&t.meta.code;if(200===a){console.log("success"),console.dir(t);var s=r.get("cats")||{};s[e.ctoken]=t.response.cross_access_token,e.myIdentityId=i,e.myuid=n,r.set("cats",s),e.$("#free-identities").hide().empty(),e.createIdentitiesList(),e.streaming()}},error:function(e){console.log("fail"),console.dir(e)}}))}});var c=t.find("#identities");c.on("scroll.maps",function(t){n.hasClass("hide")||n.addClass("hide");var i=$(this).find(".avatar"),r=this.getBoundingClientRect(),a=this.scrollTop,s=r.height,o=r.top,l=s+o,c=this._ids={};return i.each(function(e){var t=this.getBoundingClientRect(),i=$(this).parents(".identity").data("uid"),n=t.height/2+t.top;n>=o&&l>=n&&(c[i]=[e,46,n])}),e.mapController&&e.mapController.contains(),console.dir(c),0>=a||a+s>=this.scrollHeight?(t.stopPropagation(),t.preventDefault(),!1):void 0}),e.on("show",function(){$("html, body").css("min-height",i.height()),console.log("This is Smith-Token.",e.isSmithToken),e.isSmithToken?(t.find("#free-identities").removeClass("hide"),e.getFreeIdentities()):(e.createIdentitiesList(),e.streaming()),i.trigger("orientationchange")})},updateExfeeName:function(){this.element.find("#exfee-name").text(this.cross.exfee.name)},createFreeIdentitiesList:function(e){var t,i='<li data-identity-id="{{id}}" data-uid="{{external_username}}@{{provider}}"><img src="{{avatar_filename}}" alt="" class="avatar{{is_free}}" /><div class="name">{{external_username}}</div></li>',n=this.element.find("#free-identities .identities");for(e=e.slice(0);t=e.shift();)n.append(i.replace("{{id}}",t.id).replace("{{avatar_filename}}",t.avatar_filename).replace(/\{\{external_username\}\}/g,t.external_username).replace("{{provider}}",t.provider).replace("{{is_free}}",(t.free?" ":" no-")+"free"))},getFreeIdentities:function(){this.updateExfeeName(),this.createFreeIdentitiesList(this.freeIdentities)},loadMaps:function(){var t=this,i=e("routexmaps"),n=this.mapController=new i({url:"//ditu.google.cn/maps/api/js?sensor=true&language=zh_CN&v=3&callback=_loadmaps_",mapDiv:this.$("#map")[0],mapOptions:{zoom:5},svg:this.$("#svg")[0],callback:function(){t.mapReadyStatus=!0,t.mapController.updateGeoLocation(null)}});n.tracking=!0,n.load()},mapReadyStatus:!1,streaming:function(){this.initStream(),this.startStream(),console.log("start streaming")},initStream:function(){var e=this;M.init(e.cross.id,e.token,function(t,i){e.mapController&&e.mapController.draw(t,i)},function(e){console.log(e)})},startStream:function(){var e=this;e.switchGPSStyle(0),M.stopGeo(),M.startGeo(function(t){e.position=t,e.switchGPSStyle(2),r.set("last-latlng",{lat:t.latitude+"",lng:t.longitude+""}),e.trackGeoLocation(),console.log("GPS",t.latitude,t.longitude)},function(t){e.switchGPSStyle(1),console.log(t.status,t),M.stopGeo(),e.mapController&&e.mapController.switchGEOStyle(0)})},checkGPSStyle:function(){return~~this.$("#locate").attr("data-status")},switchGPSStyle:function(e,t){0===e?t="load":1===e?t="grey":(e=2,t="blue"),this.$("#locate").removeClass().addClass(t).attr("data-status",e)},trackGeoLocation:function(){var e=this.mapController,t=this.position,i=this.mapReadyStatus;i&&e&&(console.log("tracking"),e.myuid=this.myuid,e.updateGeoLocation(this.myuid,t))},updateMe:function(e){this.myIdentity=e;var t=this.$("#isme");t.attr("data-uid",e.external_username+"@"+e.provider),t.find("img").attr("src",e.avatar_filename)},createIdentitiesList:function(){var e,t,i=this.cross.exfee,n=this.$("#identities"),r=this.myIdentityId,a=i.invitations.slice(0);for(console.dir(i);e=a.shift();)if(t=e.identity,r!==t.id){var s=$('<div class="identity"><div class="abg"><img src="" alt="" class="avatar"></div><div class="detial"><i class="icon icon-dot-grey"></i><span class="distance">方位？</span></div></div>');s.attr("data-uid",t.external_username+"@"+t.provider),s.find("img").attr("src",t.avatar_filename),n.append(s)}else this.myuid=t.external_username+"@"+t.provider,this.updateMe(t);window.getComputedStyle(n[0]).webkitTransform,n.parent().css("-webkit-transform","translate3d(0, 0, 0)")}})});
>>>>>>> b0044b2... tweaks routex
