define("mobilecontroller",function(t,e,n){"use strict";var i=t("base"),r=t("store"),s=t("tween"),a=window._ENV_.api_url,o=t("handlebars"),c=t("util"),u=c.trim,l=c.parseId,h=navigator.userAgent.match(/iPad/),p=t("live"),d=function(t,e){return t.replace(e?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},f=Date.now||function(){return(new Date).getTime()},m=function(){window.location="https://itunes.apple.com/us/app/exfe/id514026604"},v=function(t){window.location="exfe://crosses/"+(t||"")},g="webkitTransform"in document.body.style,y=function(t,e){var n=6===e.length?"":"3d";t.style[g?"webkitTransform":"transform"]="matrix"+n+"("+e.join(",")+")"},b=function(){var t=r.get("livecard");if(!t){var e={id:"",name:"",avatar:"",bio:"",identities:[]};t={card:e,latitude:"",longitude:"",accuracy:"",traits:[]};var n=r.get("user");n&&(e.name=n.name,e.avatar=n.avatar_filename,e.bio=n.bio,e.identities=n.identities),r.set("livecard",t)}return t.card.id="",t},w=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],x=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],k=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],_=0,C=function(){return"Controller-"+_++};e=n.exports={};var E=i.extend({initialize:function(t){this.cid=C(),this.initOptions(t),this.parseElement(),this.init(),E.caches[this.cid]=this},parseElement:function(){var t=this.element,e=this.options.template;if(t?this.element=t instanceof $?t:$(t):e&&(this.element=$(e)),!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(t){this.setOptions(t);for(var e in t)"options"!==e&&(this[e]=t[e])},init:function(){},destory:function(){this.element.off(),this._destory()},_destory:function(){delete E.caches[this.cid],E.superclass.destory.call(this)},$:function(t){return this.element.find(t)}});E.caches=[],e.FooterController=E.extend({countDown:5,element:$("#app-footer"),init:function(){this.listen()},enableTimer:!0,listen:function(){var t=this,e=t.element;e.on("click.footer",".web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(){m()}).on("keydown.footer","#email",function(e){if(13===e.keyCode){var n=t.$("#email").val();t.addNotificationIdentity(n)}}).on("click.footer",".subscribe .btn_mail",function(){var e=u(t.$("#email").val());t.addNotificationIdentity(e)}),this.on("show",function(t,e,n,i){var r=t.height-96-(e?60:0);this.element.removeClass("hide"),this.element.css({position:"relative",top:r+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),h&&this.$(".web-version").removeClass("hide"),this.$(".error-info").toggleClass("hide",!i)}),this.on("reset-position",function(){var t=App.screen.height-96;this.element.removeClass("hide"),this.element.css({position:"absolute",top:t+"px"}),h&&this.$(".web-version").removeClass("hide")}),this.on("show-from-cross",function(t,e,n,i){this.element.css({position:"relative",top:0}),this.element.addClass("ft-bg"),this.cross={exfee_id:t,token:e},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),n&&!i&&this.$(".subscribe").removeClass("hide"),this.element.removeClass("hide"),$("#app-footer").addClass("ft-bg"),this.$(".get-button").removeClass("hide"),h&&this.$(".web-version").removeClass("hide")}),this.on("redirect",function(t){v(t)})},addNotificationIdentity:function(t,e,n){e=this.cross.exfee_id,n=this.cross.token;var i=l(t);return i&&"email"!==i.provider?($("#email.email").attr("placeholder","Bad email Address."),void 0):($.ajax({type:"POST",url:a+"/Exfee/"+e+"/AddNotificationIdentity"+"?token="+n,data:{provider:i.provider,external_username:i.external_username},success:function(t){t&&t.meta&&200===t.meta.code&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}}),void 0)}}),e.VerifyController=E.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-verify").remove(),this.element.appendTo($("#app-body"))},listen:function(){var t=this,e=this.resolveToken;this.on("show",function(n,i){setTimeout(function(){window.scrollTo(0,0)},14);var r=function(){n.error=!0,i.redirect("/")};this.element.removeClass("hide"),$("#app-body").css("height","100%"),App.controllers.footer.emit("reset-position"),$.ajax({type:"POST",url:a+"/Users/"+e.user_id+"?token="+e.token,data:{token:e.token},success:function(n){var i=n.meta;if(i&&200===i.code)for(var s=n.response.user,a=s.identities,o=0,c=a.length;c>o;++o){var u=a[o];if(u.id===e.identity_id){t.showIdentity(u),t.$(".done-info").removeClass("hide"),App.controllers.footer.emit("redirect");break}}else r()},error:function(){r()}})})},showIdentity:function(t){var e=this.$(".identity");e.find(".name").text(t.name),e.find(".avatar").attr("src",t.avatar_filename)}}),e.SetPasswordController=E.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-setpassword").remove(),this.element.appendTo($("#app-body"))},submitPassword:function(){var t=this,e=this.token,n=this.$(".set-button button"),i=this.$(".error-info"),r=this.$("#name"),s=this.$("#password"),o=s.val();o.length>=4?(n.addClass("disabled").prop("disabled",!0),$.ajax({type:"POST",url:a+"/Users/ResetPassword",data:{token:e,name:name,password:o},success:function(e){var a=e.meta;a&&200===a.code?(r.blur(),s.blur(),t.$(".done-info").removeClass("hide"),i.html("").addClass("hide"),n.parent().addClass("hide"),App.controllers.footer.emit("redirect")):n.removeClass("disabled").prop("disabled",!0),n.removeClass("disabled").prop("disabled",!0)},error:function(){i.html("Failed to set password. Please try later.").removeClass("hide"),n.removeClass("disabled").prop("disabled",!1)}})):i.html("Password must be longer than four!").removeClass("hide")},listen:function(){var t,e,n=this,i=this.element,r=this.resolveToken;i.on("touchstart.setpassword",".pass",function(){e&&(clearTimeout(e),e=void 0),t=f();var n=$(this).prev();n.prop("type","password")}).on("touchend.setpassword",".pass",function(n){if(f()-t>300){var i=$(this).prev();i.prop("type","text"),e=setTimeout(function(){i.prop("type","password")},500)}return n.preventDefault(),n.stopPropagation(),!1}).on("keydown.setpassword","#password",function(t){13===t.keyCode?n.submitPassword():n.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){n.submitPassword()}),this.on("show",function(t,e){setTimeout(function(){window.scrollTo(0,0)},0);var n=function(){t.error=!0,e.redirect("/")};i.removeClass("hide"),$("#app-body").css("height","100%"),$.ajax({type:"POST",url:a+"/Users/"+r.user_id+"?token="+r.token,data:{token:r.token},success:function(t){var e=t.response.user;return t&&t.meta&&200===t.meta.code?($(".identity .avatar").attr("src",e.avatar_filename),$(".identity .name").html(e.name),void 0):(n(),void 0)},error:function(){n()}}),App.controllers.footer.emit("reset-position")})}}),e.HomeController=E.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-home").length||this.element.appendTo($("#app-body"))},listen:function(){var t=this,e=this.element;e.on("touchstart.home","#home-card",function(){t.stopAnimate(),t.emit("goto-live")}),this.on("goto-live",function(){App.request.switchPageCallback=function(){e.addClass("hide")},App.response.redirect("/#live")}),this.on("show",function(t,n){var i=t.height;this.$(".logo-box .inner").css("top",(i-300)/2+"px"),e.removeClass("hide"),k[13]=(i-64)/2,this.setHomeCard(k),n=!(!n||404!==n.code);var r=this.$(".title");r.find(".normal").removeClass("hide"),n&&setTimeout(function(){alert("Sorry. Your link is invalid or expired. Requested page was not found.")},14),this.$("#home-card").css("display","none")})},setHomeCard:function(t){var e=b(),n=e.card,i=n.name,r=n.avatar,s=this.$("#home-card");y(s[0],t),n&&(i||r)?(r||(r=i?a+"/avatar/default?name="+i:"/static/img/portrait_default.png"),r="url("+r+")"):r="",s.find(".avatar").css("background-image",r)},aopts:{o:1},createAnimate:function(){var t=this.aopts,e=document.getElementById("big-logo"),n=document.getElementById("home-card"),i=function(){e.style.opacity=t.o,n.style.opacity=1-t.o};this._a=new s.Tween(t).delay(1377).to({o:0},1377).easing(s.Easing.Cubic.InOut).onUpdate(i),this._b=new s.Tween(t).delay(1377).to({o:1},1377).easing(s.Easing.Cubic.InOut).onUpdate(i)},startAnimate:function(){this._a||this._b||this.createAnimate(),this._a.chain(this._b),this._b.chain(this._a),this._a.start()},stopAnimate:function(){var t=this.aopts,e=document.getElementById("big-logo"),n=document.getElementById("home-card");this._a.chain(),this._b.chain(),this._b.stop(),this._a.stop(),t.o=e.style.opacity=1,n.style.opacity=0}}),e.CrossController=E.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-cross").remove(),this.element.appendTo($("#app-body"))},listen:function(){var t=this,e=this.element,n=this.token,i=this.cross,r=t.$(".rsvp_toolbar");e.on("touchstart.cross",".portrait.me",function(){r.toggleClass("rsvp_toolbar_off",!r.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(){var e=prompt("Change my display name:");e?$.ajax({type:"POST",url:a+"/Identities/"+i.identity.id+"/Update"+"?token="+n,data:{name:e},success:function(e){e&&e.meta&&200===e.meta.code&&t.$(".name_me").html(d(e.response.identity.name))},error:function(){alert("Failed, please retry later.")}}):alert("Display name cannot be empty.")}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var e=$(this).hasClass("accepted")?"ACCEPTED":"DECLINED";t.rsvp(e)}).on("touchstart.cross",".inf_area .description",function(){var t=$(this),e=t.hasClass("clickable");if(e){var n=t.hasClass("limit");t.toggleClass("limit",!n),t.find(".xbtn-more .rb").toggleClass("hidden",n),t.find(".xbtn-more .lt").toggleClass("hidden",!n)}}),this.on("show",function(){e.removeClass("hide");var t=this.$(".inf_area .description");t.height()>130&&(t.addClass("limit clickable"),t.find(".xbtn-more").removeClass("hide"),t.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(t){var e=this.cross.identity.id,n=this.exfee_id,i=this.token,r=[{rsvp_status:t,identity_id:e,by_identity_id:e}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var s=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(t){case"ACCEPTED":s.addClass("accepted");break;case"DECLINED":s.addClass("declined");break;default:s.addClass("pending")}$.ajax({type:"post",url:a+"/Exfee/"+n+"/Rsvp?token="+i,data:{rsvp:JSON.stringify(r)},success:function(){},error:function(){alert("RSVP failed!")}})}}),e.LiveController=E.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-live").length?this.element=$("#app-live"):this.element.appendTo($("#app-body"))},listen:function(){var t,e,n=this,i=this.element;i.on("touchstart.live","#card-name",function(t){t.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus()}).on("touchend.live",".live-form",function(t){t.stopPropagation(),$(t.target).hasClass("live-form")&&(i.find(".input-item").blur(),App.response.redirect("/"))}).on("keydown.live","#card-name",function(t){var e=t.keyCode,i=u(this.value);i&&13===e&&n.addEmailOrPhone(this,i)}).on("blur.live","#card-name",function(){var t=u(this.value);t?n.addEmailOrPhone(this,t):n.setCardName(this)}).on("keydown.live blur.live","#add-identity",function(t){var e=t.keyCode,i=u(this.value);(i&&13===e||"blur"===t.type)&&(n.addEmailOrPhone(this,i,!0),this.value="")}).on("keydown.live blur.live","#facebook-identity",function(t){var e=t.keyCode,i=u(this.value);(i&&13===e||"blur"===t.type)&&(i+="@facebook",n.addFacebook(this,i)&&$("#add-identity-facebook").addClass("hide"),this.value="")}).on("touchstart.live",".list .input-item",function(){$(this).next().removeClass("hidden")}).on("blur.live",".list .input-item",function(){$(this).next().addClass("hidden"),n.updateIdentityLi(this)}).on("touchstart.live",".list .delete",function(){var t,e=$(this).prev()[0],i=u(e.value),r=e.getAttribute("data-provider"),s="facebook"===r;s&&(i+="@facebook"),t=l(i),$(this).parent().remove(),t&&t.provider&&n.removeIdentity(t),s&&n.emit("show-add-facebook")}).on("touchstart.live",".btn-start",function(){var t=$(".list .input-item");t.each(function(){n.updateIdentityLi(this)});var e=document.getElementById("card-name");e.blur();var i=u(e.value);i?n.liveCard.card.name=i:n.setCardName(e),setTimeout(function(){n.inspectFields()&&(n.emit("post-card"),n.emit("live-gather"))},23)}).on("hold:live",".live-gather .card .avatar",function(){var t=this,e=t.parentNode,n=$(e).data("card"),i=e.style.transform||e.style.webkitTransform,r=i.match(/([\-\d\.]+)/g).slice(1),s=document.getElementById("card-tip"),a="";if(n&&n.identities){for(var o=0,c=n.identities.length;c>o;++o){var u=n.identities[o],l=u.provider,h=u.external_username,p="";"email"!==l&&"phone"!==l&&(l=l.substr(0,1).toUpperCase()+l.substr(1),p='<span class="provider">'+l+"</span>"),a+='<li><span class="external-username'+(p?"":" normal")+'">'+h+"</span>"+p+"</li>"}s.querySelector("ul").innerHTML=a;var d=s.clientHeight,f=~~r[12]-68,m=~~r[13]-(6+d),v=93;0>f?f=10:f+200>=320&&(f=110),(10===f||110===f)&&(v=~~r[12]+32-7-f),r[12]=f,r[13]=m-5,r[14]=7,y(s,r),s.querySelector(".ang").style.left=v+"px",s.querySelector(".bio").innerText=n.bio,s.className="card-tip"}}).on("touchstart.live",".live-gather .card .avatar",function(n){var i=$(this),r=250,s=n.touches.length;e=f(),t&&(clearTimeout(t),t=void 0),1===s&&s>=1&&(t=setTimeout(function(){i.trigger("hold:live")},r))}).on("touchend.live",".live-gather .card .avatar",function(){if(t&&(clearTimeout(t),t=void 0),250>f()-e){var n=$(this).parent();n.hasClass("card-me")||n.toggleClass("selected")}document.getElementById("card-tip").className="card-tip hidden"}).on("touchstart.live",".back",function(){n.$(".live-gather").addClass("hide"),App.response.redirect("/")}).on("touchstart.live",".live-gather",function(t){var e=t.target,n=$(".live-title h2"),i=n[0],r=n.hasClass("clicked");r&&($(".wave").css("opacity",1),n.data("clicked",e===i||$.contains(i,e)).removeClass("clicked"),$(".live-tip").addClass("live-tip-close"))}).on("touchstart.live",".live-title h2",function(){var t=$(this),e=t.hasClass("clicked"),n=t.data("clicked");e||n||($(this).addClass("clicked"),$(".wave").css("opacity",0),$(".live-tip").removeClass("live-tip-close")),t.data("clicked",!1)}).on("touchstart.live",".btn-confirm",function(){n.postContacts()}),this.on("show-add-email",function(){this.$("#add-identity").removeClass("hide")}),this.on("show-add-facebook",function(){this.$('.list input[data-provider="facebook"]').length||this.$("#add-identity-facebook").removeClass("hide")}),this.on("show",function(t){p.startGeo(),this.screen=t,$("#app-footer").addClass("hide"),this.element.removeClass("hide");var e=t.height;k[13]=(e-64)/2,y(this.$("#icard")[0],k),this.$(".live-form, .live-gahter").css("min-height",e),this.$(".live-form").removeClass("hide"),this.$("#live-discover").css("opacity",0),this.$("#card-form").css({opacity:0,"min-height":100*((e-100)/e)+"%"}),this.measurePositions(t.width,t.height-10,32,32),this.MAPS=this._MAPS.slice(0),this.$(".identities .list").empty(),this.liveCard=b(),this.updateMyCardForm(),this.startAnimate()}),this.on("post-card",function(){this.postMyCard()}),this.on("disabled-live-btn",function(t){this.$(".btn-start").toggleClass("disabled",t)}),this.on("live-gather",function(){this.$(".live-form").addClass("hide"),this.$(".live-gather").removeClass("hide"),this.$(".wave").addClass("start"),this.$(".live-gather").find(".card").remove();var t=this.liveCard.card,e=this.genCard(t,this.coords[0][0],0,0,!0,this.screen.ios).appendTo(this.$(".live-gather"));this.updateCard(e[0],t),this._others&&this.updateOthers()})},updateIdentityLi:function(t){var e,n=t.getAttribute("data-external-username"),i=t.getAttribute("data-provider"),r=t.getAttribute("data-name"),s="",a=u(t.value),o=!1,c=!1,h=!1;if(a)if("facebook"===i&&(a+="@facebook"),e=l(a),e&&e.provider){var p=this.findIdentity(e),d=e.provider===i&&e.external_username===n;p&&!d&&(t.value=s),p||d||(h=!0,o=!0)}else c=!0,o=!0;else c=!0,o=!0;c&&(t.setAttribute("data-name",s),t.setAttribute("data-external-username",s),t.setAttribute("data-provider",s),setTimeout(function(){alert("Invalid contact.")},14)),h&&(t.setAttribute("data-name",e.name),t.setAttribute("data-external-username",e.external_username),t.setAttribute("data-provider",e.provider),t.value=e.external_username,$(t).prev().text(this.aliasProvider(e.provider)),this.updateLiveCard(e,"+")),o&&this.updateLiveCard({name:r,external_username:n,provider:i},"-",!0),(o||h)&&this.emit("post-card")},postContacts:function(){},inspectFields:function(){var t=this.liveCard.card;return t.name&&t.identities.length},updateCardName:function(t){t.name&&(this.liveCard.card.name=document.getElementById("card-name").value=t.name,r.set("livecard",this.liveCard))},updateMe:function(t){var e,n=document.getElementById("icard"),i=n.getAttribute("data-url");i!==t.avatar&&(e=t.avatar,e||(e=t.name?a+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),i!==e&&(n.querySelector(".avatar").style.backgroundImage="url("+e+")",n.setAttribute("data-url",e)));var r=document.getElementById("card-bio");t.bio&&(r.innerText=t.bio),r.className=t.bio?"":"hide"},postMyCard:function(){r.set("livecard",this.liveCard);var t=this.liveCard.card;t.name&&t.identities.length&&p.init(t,$.proxy(this.liveCallback,this))},state:1,liveCallback:function(t){var e=this.liveCard,n=t.me;1===this.state&&n&&n.name&&n.identities.length&&(f()-n.timestamp>6e4&&this.updateCardName(n),this.updateMe(e.card=n),r.set("livecard",e)),this._others=t.others,this.updateOthers()},updateMyCardForm:function(){var t,e=this.liveCard,n=e.card,i=n.identities;if(i&&(t=i.length)){this.updateCardName(n),this.updateMe(n),this.postMyCard(),i=i.slice(0);for(var r,s;r=i.shift();)s=r.provider,("email"===s||"phone"===s||"facebook"===s)&&this.addIdentity(r,!0);this.emit("show-add-email"),this.emit("show-add-facebook")}else this.emit("disabled-live-btn",!0)},resetLiveCard:function(){this.emit("disabled-live-btn",!0),r.clear("livecard"),this.liveCard=b()},findIdentity:function(t){var e=this.liveCard.card,n=e.identities,i=n.length;if(i)for(var r=0;i>r;++r){var s=n[r];if(s.provider===t.provider&&s.external_username===t.external_username)return!0}return!1},updateLiveCard:function(t,e,n){var i=this.liveCard.card,s=i.identities;if("+"===e)s.push(t);else{for(var a=0,o=s.length;o>a;++a){var c=s[a];if(c.provider===t.provider&&c.external_username===t.external_username){s.splice(a,1);break}}n||0!==s.length||this.resetLiveCard()}r.set("livecard",this.liveCard)},setCardName:function(t){var e=this.packedIdentities();if(e.length){var n=e[0],i="",r=n.external_username,s=n.provider;i="phone"===s?"Anonym_"+r.slice(r.length-4):r.split("@")[0],this.liveCard.card.name=t.value=i,t.setAttribute("placeholder","Name"),$(t).addClass("normal")}},addFacebook:function(t,e){var n=l(e),i=n.provider;return i&&"facebook"===i&&!this.existsByIdentity(n)?(this.addIdentity(n),!0):!1},addEmailOrPhone:function(t,e,n){n=!n;var i=l(e),r=i.provider;!r||"email"!==r&&"phone"!==r||this.existsByIdentity(i)||(this.addIdentity(i),n&&this.setCardName(t)),n&&(this.emit("show-add-email"),this.emit("show-add-facebook")),this.emit("post-card")},aliasProvider:function(t){return"email"===t?t="Email":"phone"===t?t="Mobile":"facebook"===t&&(t="Facebook"),t},genIdentity:function(t){var e=o.compile($("#live-li-identity-tmpl").html()),n=t.provider;n=this.aliasProvider(n);var i=$(e({provider_alias:n,identity:t}));return i},resetCard:function(){this.state=0,this.$("#icard").removeAttr("data-url").find(".avatar").css("background",""),this.$("#card-name").attr("placeholder","Your email or mobile no.").removeClass("normal").val(""),this.$("#add-identity").addClass("hide"),this.$("#add-identity-facebook").addClass("hide")},removeIdentity:function(t){var e=this.$(".identities .list li");0===e.length?(this.resetCard(),this.emit("disabled-live-btn",!0)):"facebook"===t.provider&&this.emit("show-add-facebook"),this.updateLiveCard(t,"-"),this.emit("post-card")},addIdentity:function(t,e){e=!e,this.state=1;var n=this.$(".identities .list"),i=this.genIdentity(t);n.append(i),this.emit("disabled-live-btn",!1),e&&(this.updateLiveCard(t,"+"),this.emit("post-card"))},packedIdentities:function(){for(var t,e,n,i,r,s=this.$(".identities .list").find("input"),a=0,o=s.length,c=[];o>a;++a)t=s.eq(a),e=t.attr("data-provider"),n=u(s.eq(a).val()),n&&("facebook"===e&&(n+="@facebook"),i=l(n),r=i.provider,!r||"email"!==r&&"phone"!==r&&"facebook"!==r||c.push(i));return c},existsByIdentity:function(t){var e,n=this.packedIdentities(),i=t.external_username,r=t.provider;if(0===n.length)return!1;for(;e=n.shift();)if(e.external_username===i&&e.provider===r)return!0;return!1},coords:"".split(),_MAPS:[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],MAPS:"".split(),measurePositions:function(t,e,n,i){var r=this.coords;r[0]=[[.5*t-n,.88*e-i]],r[1]=Array(3),r[1][0]=[.25*t-5-n,.66*e+30-i],r[1][1]=[.5*t-n,.66*e-i],r[1][2]=[.75*t+5-n,.66*e+30-i],r[2]=Array(4),r[2][0]=[.125*t+5-n,.44*e+40-i],r[2][1]=[.375*t-n,.44*e-i],r[2][2]=[.625*t-n,.44*e-i],r[2][3]=[.875*t-5-n,.44*e+40-i],r[3]=Array(4),r[3][0]=[.125*t-n,.22*e+40-i],r[3][1]=[.375*t-n,.22*e-i],r[3][2]=[.625*t-n,.22*e-i],r[3][3]=[.875*t-n,.22*e+40-i]},genCard:function(t,e,n,i,r,s){var a=o.compile($("#live-card-tmpl").html()),c=w.slice(0);c[12]=e[0],c[13]=e[1];var u=$(a({g:n,i:i,matrix:c.join(","),"class":(r?"card-me":"card-other hide")+("iphone4"===s?" card-iphone4":""),card:t}));return u.data("card",t),u},addCard:function(t){var e=this.MAPS;if(!e||0===e.length)return!1;var n=e.shift(),i=n[0],r=n[1],a=this.coords[i][r],o=this.genCard(t,a,i,r,!1,this.screen.ios),c=o[0],u=c.style,l=w.slice(0);l[0]=l[5]=0,l[12]=a[0],l[13]=a[1],o.data("card",t),this.$(".live-gather").append(o),new s.Tween({o:0}).to({o:1},250).easing(s.Easing.Bounce.In).onStart(function(){y(c,l),o.removeClass("hide")}).onUpdate(function(){u.opacity=this.o,l[0]=l[5]=this.o,y(c,l)}).onComplete(function(){s.remove(this)}).start()},delCard:function(t){var e=this.MAPS,n=t.getAttribute("data-g"),i=t.getAttribute("data-i"),r=w.slice(0),a=this.coords[n][i],o=t.style;r[12]=a[0],r[13]=a[1],new s.Tween({o:1}).to({o:0},250).easing(s.Easing.Bounce.Out).onUpdate(function(){o.opacity=this.o,y(t,r)}).onComplete(function(){e.unshift([n,i]),t.parentNode.removeChild(t),s.remove(this)}).start()},updateCard:function(t,e){var n=t.getAttribute("data-url"),i="";n&&n===e.avatar||(i=e.avatar,i||(i=e.name?a+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),n!==i&&(t.querySelector(".avatar").style.backgroundImage="url("+i+")",t.setAttribute("data-url",i))),t.querySelector(".name").innerText=e.name,$(t).data("card",e)},updateOthers:function(){for(var t,e,n,i,r=this._others,s=document.querySelectorAll(".card-other"),a=s.length,o=0;a>o;++o)t=s[o],e=t.getAttribute("id"),e in r||this.delCard(t);for(n in r)i=r[n],t=document.getElementById(i.id),t?this.updateCard(t,i):this.addCard(i)},createAnimate:function(){var t=this.$("#icard")[0],e=this.$("#card-form")[0],n=this.$("#live-discover")[0],i=k[13],r=x[13],a=k.slice(0);this.a=new s.Tween({o:0}).to({o:1},500).easing(s.Easing.Cubic.In).onUpdate(function(){n.style.opacity=this.o,a[13]=(i-r)*(1-this.o)+r,y(t,a)}),this.b=new s.Tween({o:0}).delay(250).to({o:1},500).onUpdate(function(){e.style.opacity=this.o})},startAnimate:function(){this.a||this.b||this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}})});