define("mobilecontroller",function(t,e,i){"use strict";var n=t("base"),s=t("store"),a=t("tween"),r=window._ENV_,o=r.api_url,c=r.apiv3_url,l=r.app_scheme,h=window.openExfe,u=t("handlebars"),d=t("zepto"),p=!!navigator.platform.match(/(iP(hone|ad|od))/i),f=!!navigator.userAgent.match(/Android/i),m=t("util"),g=m.trim,v=m.parseId,y=navigator.userAgent.match(/iPad/),b=t("live"),w=function(t,e){return t.replace(e?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},x=Date.now||function(){return(new Date).getTime()},k="webkitTransform"in document.body.style,_=function(t,e){var i=6===e.length?"":"3d";t.style[k?"webkitTransform":"transform"]="matrix"+i+"("+e.join(",")+")"},C=function(){var t=s.get("livecard");if(!t){var e={id:"",name:"",avatar:"",bio:"",identities:[]};t={card:e,latitude:"",longitude:"",accuracy:"",traits:[]};var i=s.get("user");i&&(e.name=i.name,e.avatar=i.avatar_filename,e.bio=i.bio,e.identities=i.identities),s.set("livecard",t)}return t.card.id="",t},S=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],P=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],E=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],T=0,M=function(){return"Controller-"+T++};e=i.exports={};var I=n.extend({initialize:function(t){this.cid=M(),this.initOptions(t),this.parseElement(),this.init(),I.caches[this.cid]=this},parseElement:function(){var t=this.element,e=this.options.template;if(t?this.element=t instanceof d?t:d(t):e&&(this.element=d(e)),!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(t){this.setOptions(t);for(var e in t)"options"!==e&&(this[e]=t[e])},init:function(){},destory:function(){this.element.off(),this._destory()},_destory:function(){delete I.caches[this.cid],I.superclass.destory.call(this)},$:function(t){return this.element.find(t)}});I.caches=[],e.FooterController=I.extend({element:d("#app-footer"),init:function(){this.listen()},enableTimer:!0,listen:function(){var t=this,e=t.element;e.on("click.footer",".web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(t){return t.preventDefault(),h(),!1}).on("keydown.footer","#email",function(e){if(13===e.keyCode){var i=t.$("#email").val();t.addNotificationIdentity(i)}}).on("click.footer",".subscribe .btn_mail",function(){var e=g(t.$("#email").val());t.addNotificationIdentity(e)}),this.on("show",function(t,e,i,n){var s=t.height-96-(e?60:0);this.element.removeClass("hide"),this.element.css({position:"relative",top:s+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),y&&this.$(".web-version").removeClass("hide"),this.$(".error-info").toggleClass("hide",!n)}),this.on("reset-position",function(){var t=App.screen.height-96;this.element.removeClass("hide"),this.element.css({position:"absolute",top:t+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),y&&this.$(".web-version").removeClass("hide")}),this.on("show-from-cross",function(t,e,i){this.element.css({position:"relative",top:0}),this.element.addClass("ft-bg"),this.cross={exfee_id:t,token:e},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),i||this.$(".subscribe").removeClass("hide"),this.element.removeClass("hide"),d("#app-footer").addClass("ft-bg"),this.$(".get-button").removeClass("hide"),y&&this.$(".web-version").removeClass("hide")}),this.on("redirect",function(t,e){window.launchApp(l+t,e)})},addNotificationIdentity:function(t,e,i){e=this.cross.exfee_id,i=this.cross.token;var n=v(t);return n&&"email"!==n.provider?(d("#email.email").attr("placeholder","Bad email Address."),void 0):(d.ajax({type:"POST",url:o+"/Exfee/"+e+"/AddNotificationIdentity"+"?token="+i,data:{provider:n.provider,external_username:n.external_username},success:function(t){t&&t.meta&&200===t.meta.code&&d(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}}),void 0)}}),e.VerifyController=I.extend({init:function(){this.render(),this.listen()},render:function(){d("#app-verify").remove(),this.element.appendTo(d("#app-body"))},listen:function(){var t=this,e=this.resolveToken;this.on("show",function(i,n){setTimeout(function(){window.scrollTo(0,0)},14);var a=function(){i.error=!0,n.redirect("/")};this.element.removeClass("hide"),d("#app-body").css("height","100%");var r=s.get("tmp-user");if(r){for(var c=r.identities,l=0,h=c.length;h>l;++l){var u=c[l];if(u.id===e.identity_id){t.showIdentity(u),t.$(".done-info").removeClass("hide");break}}return s.remove("tmp-user"),s.remove("tmp-token"),App.controllers.footer.emit("reset-position"),void 0}var p=function(t){App.controllers.footer.emit("redirect",t,function(){var t=window.search.substr(1);t&&(t="&"+t),window.location="/?redirect"+t+window.location.hash})},f=e.user_id,m=e.token,g=e.name||"";d.ajax({type:"POST",url:o+"/Users/"+f+"?token="+m,data:{token:m},success:function(i){var n=i.meta;if(n&&200===n.code)for(var r=i.response.user,o=r.identities,c=0,l=o.length;l>c;++c){var h=o[c];if(h.id===e.identity_id){if(t.showIdentity(h),t.$(".done-info").removeClass("hide"),s.set("tmp-user",r),App.controllers.footer.emit("reset-position"),f&&m){var u="?token="+m+"&user_id="+f+"&username="+encodeURIComponent(g)+"&identity_id="+h.id;p(u)}break}}else a()},error:function(){a()}})})},showIdentity:function(t){var e=this.$(".identity");e.find(".name").text(t.name),e.find(".avatar").attr("src",t.avatar_filename)}}),e.SetPasswordController=I.extend({init:function(){this.render(),this.listen()},render:function(){d("#app-setpassword").remove(),this.element.appendTo(d("#app-body"))},submitPassword:function(){var t=this,e=this.token,i=this.$(".set-button button"),n=this.$(".error-info"),s=this.$(".identity .name"),a=this.$("#password"),r=g(s.text()),c=a.val();c.length>=4?(i.addClass("disabled").prop("disabled",!0),d.ajax({type:"POST",url:o+"/Users/ResetPassword",data:{token:e,name:r,password:c},success:function(e){var r=e.meta;if(r&&200===r.code){s.blur(),a.blur(),t.$(".password").addClass("hide"),t.$(".done-info").removeClass("hide"),n.html("").addClass("hide"),i.parent().addClass("hide");var o=e.response.authorization;o&&App.controllers.footer.emit("redirect","?token="+o.token+"&user_id="+o.user_id+"&username="+encodeURIComponent(o.name||""),function(){var t=window.location.search.substr(1);t&&(t="&"+t),window.location="/?redirect"+t+window.location.hash})}else 401===r.code&&(n.html('<span class="t">Token expired.</span> Please request to reset password again.').removeClass("hide"),a.prop("disabled",!0),i.parent().addClass("hide"));i.prop("disabled",!0)},error:function(){n.html("Failed to set password. Please try later.").removeClass("hide"),i.prop("disabled",!1)}})):n.html("Password must be longer than four!").removeClass("hide")},listen:function(){var t,e,i=this,n=this.element,a=this.resolveToken;n.on("touchstart.setpassword",".pass",function(){e&&(clearTimeout(e),e=void 0),t=x();var i=d(this).prev();i.prop("type","password")}).on("touchend.setpassword",".pass",function(i){if(x()-t>300){var n=d(this).prev();n.prop("type","text"),e=setTimeout(function(){n.prop("type","password")},500)}return i.preventDefault(),i.stopPropagation(),!1}).on("keydown.setpassword","#password",function(t){13===t.keyCode?i.submitPassword():i.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){i.submitPassword()}),this.on("show",function(t,e){setTimeout(function(){window.scrollTo(0,0)},0);var i=function(){t.error=!0,e.redirect("/")};n.removeClass("hide"),d("#app-body").css("height","100%");var r=s.get("tmp-user");return r?(d(".identity .avatar").attr("src",r.avatar_filename),d(".identity .name").html(r.name),window.noExfeApp&&(d(".password").addClass("hide"),d(".set-button").addClass("hide"),d(".done-info").removeClass("hide")),App.controllers.footer.emit("reset-position"),s.remove("tmp-user"),s.remove("tmp-token"),void 0):(d.ajax({type:"POST",url:o+"/Users/"+a.user_id+"?token="+a.token,data:{token:a.token},success:function(t){var e=t.response.user;return t&&t.meta&&200===t.meta.code?(d(".identity .avatar").attr("src",e.avatar_filename),d(".identity .name").html(e.name),s.set("tmp-user",e),App.controllers.footer.emit("reset-position"),void 0):(i(),void 0)},error:function(){i()}}),void 0)})}}),e.HomeController=I.extend({init:function(){this.render(),this.listen()},render:function(){d("#app-home").length||this.element.appendTo(d("#app-body"))},listen:function(){var t=this,e=this.element;e.on("touchstart.home","#home-card",function(){t.stopAnimate(),t.emit("goto-live")}),this.on("goto-live",function(){App.request.switchPageCallback=function(){e.addClass("hide")},App.response.redirect("/#live")}),this.on("show",function(t,i){var n=t.height;this.$(".logo-box .inner").css("top",(n-300)/2+"px"),e.removeClass("hide"),E[13]=(n-64)/2,this.setHomeCard(E),i=!(!i||404!==i.code);var s=this.$(".title");s.find(".normal").removeClass("hide"),i&&setTimeout(function(){alert("Sorry. Your link is invalid or expired. Requested page was not found.")},14),this.$("#home-card").css("display","none")})},setHomeCard:function(t){var e=C(),i=e.card,n=i.name,s=i.avatar,a=this.$("#home-card");_(a[0],t),i&&(n||s)?(s||(s=n?o+"/avatar/default?name="+n:"/static/img/portrait_default.png"),s="url("+s+")"):s="",a.find(".avatar").css("background-image",s)},aopts:{o:1},createAnimate:function(){var t=this.aopts,e=document.getElementById("big-logo"),i=document.getElementById("home-card"),n=function(){e.style.opacity=t.o,i.style.opacity=1-t.o};this._a=new a.Tween(t).delay(1377).to({o:0},1377).easing(a.Easing.Cubic.InOut).onUpdate(n),this._b=new a.Tween(t).delay(1377).to({o:1},1377).easing(a.Easing.Cubic.InOut).onUpdate(n)},startAnimate:function(){this._a||this._b||this.createAnimate(),this._a.chain(this._b),this._b.chain(this._a),this._a.start()},stopAnimate:function(){var t=this.aopts,e=document.getElementById("big-logo"),i=document.getElementById("home-card");this._a.chain(),this._b.chain(),this._b.stop(),this._a.stop(),t.o=e.style.opacity=1,i.style.opacity=0}}),e.CrossController=I.extend({init:function(){this.render(),this.listen()},render:function(){d("#app-cross").remove(),this.element.appendTo(d("#app-body"))},listen:function(){var t=this,e=this.element,i=this.token,n=this.cross,s=t.$(".rsvp_toolbar");e.on("touchstart.cross",".portrait.me",function(){s.toggleClass("rsvp_toolbar_off",!s.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(){var e=prompt("Change my display name:");e?d.ajax({type:"POST",url:o+"/Identities/"+n.identity.id+"/Update"+"?token="+i,data:{name:e},success:function(e){e&&e.meta&&200===e.meta.code&&t.$(".name_me").html(w(e.response.identity.name))},error:function(){alert("Failed, please retry later.")}}):alert("Display name cannot be empty.")}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var e=d(this).hasClass("accepted")?"ACCEPTED":"DECLINED";t.rsvp(e)}).on("touchstart.cross",".inf_area .description",function(){var t=d(this),e=t.hasClass("clickable");if(e){var i=t.hasClass("limit");t.toggleClass("limit",!i),t.find(".xbtn-more .rb").toggleClass("hidden",i),t.find(".xbtn-more .lt").toggleClass("hidden",!i)}}),this.on("show",function(){e.removeClass("hide");var t=this.$(".inf_area .description");t.height()>130&&(t.addClass("limit clickable"),t.find(".xbtn-more").removeClass("hide"),t.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(t){var e=this.cross.identity.id,i=this.exfee_id,n=this.token,s=[{rsvp_status:t,identity_id:e,by_identity_id:e}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var a=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(t){case"ACCEPTED":a.addClass("accepted");break;case"DECLINED":a.addClass("declined");break;default:a.addClass("pending")}d.ajax({type:"post",url:o+"/Exfee/"+i+"/Rsvp?token="+n,data:{rsvp:JSON.stringify(s)},success:function(){},error:function(){alert("RSVP failed!")}})}}),e.LiveController=I.extend({init:function(){this.render(),this.listen()},render:function(){d("#app-live").length?this.element=d("#app-live"):this.element.appendTo(d("#app-body"))},listen:function(){var t,e,i=this,n=this.element;n.on("touchstart.live","#card-name",function(t){t.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus()}).on("touchend.live",".live-form",function(t){t.stopPropagation(),d(t.target).hasClass("live-form")&&(n.find(".input-item").blur(),App.response.redirect("/"))}).on("keydown.live","#card-name",function(t){var e=t.keyCode,n=g(this.value);n&&13===e&&i.addEmailOrPhone(this,n)}).on("blur.live","#card-name",function(){var t=g(this.value);t?i.addEmailOrPhone(this,t):i.setCardName(this)}).on("keydown.live blur.live","#add-identity",function(t){var e=t.keyCode,n=g(this.value);(n&&13===e||"blur"===t.type)&&(i.addEmailOrPhone(this,n,!0),this.value="")}).on("keydown.live blur.live","#facebook-identity",function(t){var e=t.keyCode,n=g(this.value);(n&&13===e||"blur"===t.type)&&(n+="@facebook",i.addFacebook(this,n)&&d("#add-identity-facebook").addClass("hide"),this.value="")}).on("touchstart.live",".list .input-item",function(){d(this).next().removeClass("hidden")}).on("blur.live",".list .input-item",function(){d(this).next().addClass("hidden"),i.updateIdentityLi(this)}).on("touchstart.live",".list .delete",function(){var t,e=d(this).prev()[0],n=g(e.value),s=e.getAttribute("data-provider"),a="facebook"===s;a&&(n+="@facebook"),t=v(n),d(this).parent().remove(),t&&t.provider&&i.removeIdentity(t),a&&i.emit("show-add-facebook")}).on("touchstart.live",".btn-start",function(){var t=d(".list .input-item");t.each(function(){i.updateIdentityLi(this)});var e=document.getElementById("card-name");e.blur();var n=g(e.value);n?i.liveCard.card.name=n:i.setCardName(e),setTimeout(function(){i.inspectFields()&&(i.emit("post-card"),i.emit("live-gather"))},23)}).on("hold:live",".live-gather .card .avatar",function(){var t=this,e=t.parentNode,i=d(e).data("card"),n=e.style.transform||e.style.webkitTransform,s=n.match(/([\-\d\.]+)/g).slice(1),a=document.getElementById("card-tip"),r="";if(i&&i.identities){for(var o=0,c=i.identities.length;c>o;++o){var l=i.identities[o],h=l.provider,u=l.external_username,p="";"email"!==h&&"phone"!==h&&(h=h.substr(0,1).toUpperCase()+h.substr(1),p='<span class="provider">'+h+"</span>"),r+='<li><span class="external-username'+(p?"":" normal")+'">'+u+"</span>"+p+"</li>"}a.querySelector("ul").innerHTML=r;var f=a.clientHeight,m=~~s[12]-68,g=~~s[13]-(6+f),v=93;0>m?m=10:m+200>=320&&(m=110),(10===m||110===m)&&(v=~~s[12]+32-7-m),s[12]=m,s[13]=g-5,s[14]=7,_(a,s),a.querySelector(".ang").style.left=v+"px",a.querySelector(".bio").innerText=i.bio,a.className="card-tip"}}).on("touchstart.live",".live-gather .card .avatar",function(i){var n=d(this),s=250,a=i.touches.length;e=x(),t&&(clearTimeout(t),t=void 0),1===a&&a>=1&&(t=setTimeout(function(){n.trigger("hold:live")},s))}).on("touchend.live",".live-gather .card .avatar",function(){if(t&&(clearTimeout(t),t=void 0),250>x()-e){var i=d(this).parent();i.hasClass("card-me")||i.toggleClass("selected")}document.getElementById("card-tip").className="card-tip hidden"}).on("touchstart.live",".back",function(){i.$(".live-gather").addClass("hide"),App.response.redirect("/")}).on("touchstart.live",".live-gather",function(t){var e=t.target,i=d(".live-title h2"),n=i[0],s=i.hasClass("clicked");s&&(d(".wave").css("opacity",1),i.data("clicked",e===n||d.contains(n,e)).removeClass("clicked"),d(".live-tip").addClass("live-tip-close"))}).on("touchstart.live",".live-title h2",function(){var t=d(this),e=t.hasClass("clicked"),i=t.data("clicked");e||i||(d(this).addClass("clicked"),d(".wave").css("opacity",0),d(".live-tip").removeClass("live-tip-close")),t.data("clicked",!1)}).on("touchstart.live",".btn-confirm",function(){i.postContacts()}),this.on("show-add-email",function(){this.$("#add-identity").removeClass("hide")}),this.on("show-add-facebook",function(){this.$('.list input[data-provider="facebook"]').length||this.$("#add-identity-facebook").removeClass("hide")}),this.on("show",function(t){b.startGeo(),this.screen=t,d("#app-footer").addClass("hide"),this.element.removeClass("hide");var e=t.height;E[13]=(e-64)/2,_(this.$("#icard")[0],E),this.$(".live-form, .live-gahter").css("min-height",e),this.$(".live-form").removeClass("hide"),this.$("#live-discover").css("opacity",0),this.$("#card-form").css({opacity:0,"min-height":100*((e-100)/e)+"%"}),this.measurePositions(t.width,t.height-10,32,32),this.MAPS=this._MAPS.slice(0),this.$(".identities .list").empty(),this.liveCard=C(),this.updateMyCardForm(),this.startAnimate()}),this.on("post-card",function(){this.postMyCard()}),this.on("disabled-live-btn",function(t){this.$(".btn-start").toggleClass("disabled",t)}),this.on("live-gather",function(){this.$(".live-form").addClass("hide"),this.$(".live-gather").removeClass("hide"),this.$(".wave").addClass("start"),this.$(".live-gather").find(".card").remove();var t=this.liveCard.card,e=this.genCard(t,this.coords[0][0],0,0,!0,this.screen.ios).appendTo(this.$(".live-gather"));this.updateCard(e[0],t),this._others&&this.updateOthers()})},updateIdentityLi:function(t){var e,i=t.getAttribute("data-external-username"),n=t.getAttribute("data-provider"),s=t.getAttribute("data-name"),a="",r=g(t.value),o=!1,c=!1,l=!1;if(r)if("facebook"===n&&(r+="@facebook"),e=v(r),e&&e.provider){var h=this.findIdentity(e),u=e.provider===n&&e.external_username===i;h&&!u&&(t.value=a),h||u||(l=!0,o=!0)}else c=!0,o=!0;else c=!0,o=!0;c&&(t.setAttribute("data-name",a),t.setAttribute("data-external-username",a),t.setAttribute("data-provider",a),setTimeout(function(){alert("Invalid contact.")},14)),l&&(t.setAttribute("data-name",e.name),t.setAttribute("data-external-username",e.external_username),t.setAttribute("data-provider",e.provider),t.value=e.external_username,d(t).prev().text(this.aliasProvider(e.provider)),this.updateLiveCard(e,"+")),o&&this.updateLiveCard({name:s,external_username:i,provider:n},"-",!0),(o||l)&&this.emit("post-card")},postContacts:function(){},inspectFields:function(){var t=this.liveCard.card;return t.name&&t.identities.length},updateCardName:function(t){t.name&&(this.liveCard.card.name=document.getElementById("card-name").value=t.name,s.set("livecard",this.liveCard))},updateMe:function(t){var e,i=document.getElementById("icard"),n=i.getAttribute("data-url");n!==t.avatar&&(e=t.avatar,e||(e=t.name?o+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),n!==e&&(i.querySelector(".avatar").style.backgroundImage="url("+e+")",i.setAttribute("data-url",e)));var s=document.getElementById("card-bio");t.bio&&(s.innerText=t.bio),s.className=t.bio?"":"hide"},postMyCard:function(){s.set("livecard",this.liveCard);var t=this.liveCard.card;t.name&&t.identities.length&&b.init(t,d.proxy(this.liveCallback,this))},state:1,liveCallback:function(t){var e=this.liveCard,i=t.me;1===this.state&&i&&i.name&&i.identities.length&&(x()-i.timestamp>6e4&&this.updateCardName(i),this.updateMe(e.card=i),s.set("livecard",e)),this._others=t.others,this.updateOthers()},updateMyCardForm:function(){var t,e=this.liveCard,i=e.card,n=i.identities;if(n&&(t=n.length)){this.updateCardName(i),this.updateMe(i),this.postMyCard(),n=n.slice(0);for(var s,a;s=n.shift();)a=s.provider,("email"===a||"phone"===a||"facebook"===a)&&this.addIdentity(s,!0);this.emit("show-add-email"),this.emit("show-add-facebook")}else this.emit("disabled-live-btn",!0)},resetLiveCard:function(){this.emit("disabled-live-btn",!0),s.clear("livecard"),this.liveCard=C()},findIdentity:function(t){var e=this.liveCard.card,i=e.identities,n=i.length;if(n)for(var s=0;n>s;++s){var a=i[s];if(a.provider===t.provider&&a.external_username===t.external_username)return!0}return!1},updateLiveCard:function(t,e,i){var n=this.liveCard.card,a=n.identities;if("+"===e)a.push(t);else{for(var r=0,o=a.length;o>r;++r){var c=a[r];if(c.provider===t.provider&&c.external_username===t.external_username){a.splice(r,1);break}}i||0!==a.length||this.resetLiveCard()}s.set("livecard",this.liveCard)},setCardName:function(t){var e=this.packedIdentities();if(e.length){var i=e[0],n="",s=i.external_username,a=i.provider;n="phone"===a?"Anonym_"+s.slice(s.length-4):s.split("@")[0],this.liveCard.card.name=t.value=n,t.setAttribute("placeholder","Name"),d(t).addClass("normal")}},addFacebook:function(t,e){var i=v(e),n=i.provider;return n&&"facebook"===n&&!this.existsByIdentity(i)?(this.addIdentity(i),!0):!1},addEmailOrPhone:function(t,e,i){i=!i;var n=v(e),s=n.provider;!s||"email"!==s&&"phone"!==s||this.existsByIdentity(n)||(this.addIdentity(n),i&&this.setCardName(t)),i&&(this.emit("show-add-email"),this.emit("show-add-facebook")),this.emit("post-card")},aliasProvider:function(t){return"email"===t?t="Email":"phone"===t?t="Mobile":"facebook"===t&&(t="Facebook"),t},genIdentity:function(t){var e=u.compile(d("#live-li-identity-tmpl").html()),i=t.provider;i=this.aliasProvider(i);var n=d(e({provider_alias:i,identity:t}));return n},resetCard:function(){this.state=0,this.$("#icard").removeAttr("data-url").find(".avatar").css("background",""),this.$("#card-name").attr("placeholder","Your email or mobile no.").removeClass("normal").val(""),this.$("#add-identity").addClass("hide"),this.$("#add-identity-facebook").addClass("hide")},removeIdentity:function(t){var e=this.$(".identities .list li");0===e.length?(this.resetCard(),this.emit("disabled-live-btn",!0)):"facebook"===t.provider&&this.emit("show-add-facebook"),this.updateLiveCard(t,"-"),this.emit("post-card")},addIdentity:function(t,e){e=!e,this.state=1;var i=this.$(".identities .list"),n=this.genIdentity(t);i.append(n),this.emit("disabled-live-btn",!1),e&&(this.updateLiveCard(t,"+"),this.emit("post-card"))},packedIdentities:function(){for(var t,e,i,n,s,a=this.$(".identities .list").find("input"),r=0,o=a.length,c=[];o>r;++r)t=a.eq(r),e=t.attr("data-provider"),i=g(a.eq(r).val()),i&&("facebook"===e&&(i+="@facebook"),n=v(i),s=n.provider,!s||"email"!==s&&"phone"!==s&&"facebook"!==s||c.push(n));return c},existsByIdentity:function(t){var e,i=this.packedIdentities(),n=t.external_username,s=t.provider;if(0===i.length)return!1;for(;e=i.shift();)if(e.external_username===n&&e.provider===s)return!0;return!1},coords:"".split(),_MAPS:[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],MAPS:"".split(),measurePositions:function(t,e,i,n){var s=this.coords;s[0]=[[.5*t-i,.88*e-n]],s[1]=Array(3),s[1][0]=[.25*t-5-i,.66*e+30-n],s[1][1]=[.5*t-i,.66*e-n],s[1][2]=[.75*t+5-i,.66*e+30-n],s[2]=Array(4),s[2][0]=[.125*t+5-i,.44*e+40-n],s[2][1]=[.375*t-i,.44*e-n],s[2][2]=[.625*t-i,.44*e-n],s[2][3]=[.875*t-5-i,.44*e+40-n],s[3]=Array(4),s[3][0]=[.125*t-i,.22*e+40-n],s[3][1]=[.375*t-i,.22*e-n],s[3][2]=[.625*t-i,.22*e-n],s[3][3]=[.875*t-i,.22*e+40-n]},genCard:function(t,e,i,n,s,a){var r=u.compile(d("#live-card-tmpl").html()),o=S.slice(0);o[12]=e[0],o[13]=e[1];var c=d(r({g:i,i:n,matrix:o.join(","),"class":(s?"card-me":"card-other hide")+("iphone4"===a?" card-iphone4":""),card:t}));return c.data("card",t),c},addCard:function(t){var e=this.MAPS;if(!e||0===e.length)return!1;var i=e.shift(),n=i[0],s=i[1],r=this.coords[n][s],o=this.genCard(t,r,n,s,!1,this.screen.ios),c=o[0],l=c.style,h=S.slice(0);h[0]=h[5]=0,h[12]=r[0],h[13]=r[1],o.data("card",t),this.$(".live-gather").append(o),new a.Tween({o:0}).to({o:1},250).easing(a.Easing.Bounce.In).onStart(function(){_(c,h),o.removeClass("hide")}).onUpdate(function(){l.opacity=this.o,h[0]=h[5]=this.o,_(c,h)}).onComplete(function(){a.remove(this)}).start()},delCard:function(t){var e=this.MAPS,i=t.getAttribute("data-g"),n=t.getAttribute("data-i"),s=S.slice(0),r=this.coords[i][n],o=t.style;s[12]=r[0],s[13]=r[1],new a.Tween({o:1}).to({o:0},250).easing(a.Easing.Bounce.Out).onUpdate(function(){o.opacity=this.o,_(t,s)}).onComplete(function(){e.unshift([i,n]),t.parentNode.removeChild(t),a.remove(this)}).start()},updateCard:function(t,e){var i=t.getAttribute("data-url"),n="";i&&i===e.avatar||(n=e.avatar,n||(n=e.name?o+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),i!==n&&(t.querySelector(".avatar").style.backgroundImage="url("+n+")",t.setAttribute("data-url",n))),t.querySelector(".name").innerText=e.name,d(t).data("card",e)},updateOthers:function(){for(var t,e,i,n,s=this._others,a=document.querySelectorAll(".card-other"),r=a.length,o=0;r>o;++o)t=a[o],e=t.getAttribute("id"),e in s||this.delCard(t);for(i in s)n=s[i],t=document.getElementById(n.id),t?this.updateCard(t,n):this.addCard(n)},createAnimate:function(){var t=this.$("#icard")[0],e=this.$("#card-form")[0],i=this.$("#live-discover")[0],n=E[13],s=P[13],r=E.slice(0);this.a=new a.Tween({o:0}).to({o:1},500).easing(a.Easing.Cubic.In).onUpdate(function(){i.style.opacity=this.o,r[13]=(n-s)*(1-this.o)+s,_(t,r)}),this.b=new a.Tween({o:0}).delay(250).to({o:1},500).onUpdate(function(){e.style.opacity=this.o})},startAnimate:function(){this.a||this.b||this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}});var L=t("routexstream");L.geoService,e.RouteXController=I.extend({init:function(){this.render(),this.listen()},render:function(){d("#app-routex").remove(),this.element.appendTo(d("#app-container")),this.START_TIME=x(),this.getRoutexWidget(),this.loadMaps(),this.loadStaticMaps(),this.setLatLngOffset()},cancelStaticMaps:function(){this.mapReadyStatus&&(this.staticMaps.hide(),delete this.staticMaps,this.mapController.show(),d("#identities").triggerHandler("scroll"))},listen:function(){var t=this,e=t.element,i=d(window),n=t.$("#my-info"),s=t.$("#open-exfe"),a=t.$("#locate"),r=!1,o=!1;i.on("orientationchange",function(){var t=i.height();i.width(),a.css("-webkit-transform","translate3d(0, 0, 0)"),s.css("-webkit-transform","translate3d(0, 0, 0)"),d("#identities").css("max-height",60*Math.floor(t/60)-95),d("#identities").triggerHandler("scroll")}),e.on("touchstart.maps","#turn-on",function(){t.streaming(),d("#privacy-dialog").addClass("hide")});var l=function(e,i){var n=t.checkGPSStyle();if(t.mapReadyStatus){var s=t.mapController.myUserId;i&&t.mapController.showBreadcrumbs(s),t.mapController.fitBoundsWithDestination(s)}2===n||1===n&&t.startStream()};e.on("tap.maps",function(e){t.tapElement&&e.target!==t.tapElement&&!d.contains(n[0],e.target)&&(n.addClass("hide"),t.tapElement=null)}),e.on("tap.maps","#locate",l),e.on("touchstart.maps","#isme .avatar",function(e){l(e,!0),t.checkFollowing(),t.tapElement=this}),e.on("touchstart.maps","#wechat-guide",function(){d(this).addClass("ant hide"),t.checkFollowing()}),e.on("touchstart.maps","#wechat-share",function(t){var e=d(this),i=t.target;d.contains(e.find(".ibox")[0],i)||(e.find(".share-input").blur(),e.addClass("ant hide"))}),e.on("tap.maps","#nearby .place-marker",function(e){if(!o&&(e.preventDefault(),t.mapReadyStatus)){var i=d(this).data("id");t.mapController.showPlacePanel(i)}}),e.on("tap.maps","#nearby .geo-marker",function(e){if(!o&&(e.preventDefault(),t.mapReadyStatus)){var i=d(this).data("uid");t.mapController.showIdentityPanel(i)}}),e.on("touchstart.maps",".open-app",function(){t.openEXFE()}),e.on("touchstart.maps","#other-info .please-update",function(){var e=d(this),i=e.hasClass("disable");if(!i){var n,s=e.attr("data-enu"),a=e.attr("data-name"),r=(e.attr("data-notification-identities")||"").split(" "),o=e.find(".loading");e.addClass("disable"),o.css("display","block"),d.ajax({type:"POST",url:c+"/routex/notification/crosses/"+t.cross_id+"?id="+s+"&token="+t.token,success:function(){},error:function(t){var e=t.status;switch(e){case 406:for(r.unshift(s);(s=r.shift())&&!(n=/\@wechat$/.test(s)););if(n){var i=d("#wechat-share"),o=i.find(".share-input"),c=o[0],l="@"+a+" 你在哪？打开这个网页就能在“活点地图”里互相看到方位。";i.removeClass("hide"),window.getComputedStyle(i[0]).opacity,i.removeClass("ant"),c.value=l,window.setTimeout(function(){c.focus(),c.selectionStart=0,c.selectionEnd=l.length},500)}else alert("通知失败\n无法立刻通知对方更新方位。\n请尝试用其它方式联系对方。");break;case 401:case 403:}},complete:function(){e.removeClass("disable"),o.css("display","none")}})}}),e.on("touchstart.maps","#my-info .discover",function(){n.addClass("hide"),t.tapElement=null}),e.on("tap.maps","#identities .abg",function(){if(!r){var e=d(this),i=e.parent(),n=e.next(),s=i.data("uid");return n.hasClass("unknown")?(t.mapController.showIdentityPanel(s,i[0].getBoundingClientRect()),void 0):(t.mapReadyStatus&&(t.mapController.showBreadcrumbs(s),t.mapController.fitBoundsWithDestination(s)),void 0)}}),e.on("tap.maps","#open-exfe",function(){var e=new O({options:{template:d("#wechat-about-tmpl").html()},cross_id:t.cross_id,token:t.token});e.emit("show")});var h,u=0,p=0;e.on("touchstart.maps","#nearby",function(t){o=!1,u=t.originalEvent.touches[0].pageY,p=this.scrollTop}),e.on("touchend.maps","#nearby",function(){h&&clearTimeout(h),m=setTimeout(function(){o=!1},233)}),e.on("touchmove.maps","#nearby",function(t){o=!0,t.preventDefault(),this.scrollTop=u-t.originalEvent.touches[0].pageY+p});var f=e.find("#identities");f.on("scroll.maps",function(){n.hasClass("hide")||n.addClass("hide");var e=d(this).find(".avatar"),i=this.getBoundingClientRect(),s=i.height,a=(this.scrollTop,i.top),r=s+a,o=this._ids={};e.each(function(t){var e=this.getBoundingClientRect(),i=d(this).parents(".identity").data("uid"),n=e.height/2+e.top;n>=a&&r>=n&&(o[i]=[t,46,n])}),t.mapReadyStatus&&t.mapController&&t.mapController.contains(),t.staticMaps&&t.staticMaps.contains(),Debugger.log(i,o)}),e.on("touchmove.maps","#identities-overlay",function(t){t.stopPropagation(),t.preventDefault()}),e.on("touchmove",".info-windown",function(t){t.preventDefault()});var m,g=0,v=0;f.on("touchstart.maps",function(e){t.mapReadyStatus&&t.mapController.hideMapPanel(),r=!1,g=e.pageY,v=this.scrollTop}),f.on("touchend.maps",function(){m&&clearTimeout(m),m=setTimeout(function(){r=!1},233)}),f.on("touchmove.maps",function(t){r=!0,t.preventDefault(),this.scrollTop=g-t.pageY+v}),t.on("show",function(){d("html, body").css({"min-height":i.height()}),Debugger.log("This is Smith-Token.",t.isSmithToken),i.trigger("orientationchange"),t.createIdentitiesList(),t.checkRouteXStatus()})},openEXFE:function(){var t=this.cross_id;window.location.href="/toapp?authenticate"+(t?"&cross_id="+t:"")},updateExfeeName:function(){this.element.find("#exfee-name").text(this.cross.exfee.name)},createFreeIdentitiesList:function(t){var e,i='<li data-identity-id="{{id}}" data-free="{{free}}" data-uid="{{external_username}}@{{provider}}"><img src="{{avatar_filename}}" alt="" class="avatar{{is_free}}" /><div class="name">{{external_username}}</div></li>',n=this.element.find("#free-identities .identities");for(t=t.slice(0);e=t.shift();)n.append(i.replace("{{id}}",e.id).replace("{{avatar_filename}}",e.avatar_filename).replace(/\{\{external_username\}\}/g,e.external_username).replace("{{provider}}",e.provider).replace("{{is_free}}",(e.free?" ":" no-")+"free").replace("{{free}}",e.free))},loadMaps:function(){var e=p||f?"http://":"https://",i=this,n=t("routexmaps"),s=this.mapController=new n({protocol:e,url:e+"ditu.google.cn/maps/api/js?key="+window._ENV_.MAP_KEY+"&sensor=false&language=zh_CN&callback=_loadmaps_",mapDiv:document.getElementById("map"),mapOptions:{zoom:5},canvas:document.getElementById("canvas"),callback:function(){Debugger.alert("动态地图加载时间: "+(x()-i.START_TIME+"ms")),i.mapReadyStatus=!0,i.mapController.updateGeoLocation(s.myUserId,i.position),i.cancelStaticMaps(),d("#identities-overlay .identity .detial").removeClass("hide");var t,e=i.routexWidget;e&&(t=e.objects)&&i.mapController.drawBatch(t.slice(0))}});s.myUserId=this.myUserId,s.myIdentity=this.myIdentity,s.tracking=!0,s.controller=i,s.load(),this.token&&this.cross_id&&d.ajax({url:c+"/routex/breadcrumbs/crosses/"+this.cross_id+"?coordinate=mars&token="+this.token,type:"GET",dataType:"json",success:function(t){var e=t&&t.length;if(e){var i,n,a;for(a=0;e>a;++a){if(i=t[a],n=i.id.split(".")[1],s._breadcrumbs[n]){var r=[];s._breadcrumbs[n].positions=r.contact(s._breadcrumbs[n].positions,i.positions)}else s._breadcrumbs[n]=i;s.updated[n]=s._breadcrumbs[n].positions[0]
}}}})},mapReadyStatus:!1,editPlace:function(t){t&&d.ajax({type:"POST",url:c+"/routex/geomarks/crosses/"+this.cross_id+"/location/"+t.id+"?coordinate=mars&token="+this.token+"&_method=PUT",data:JSON.stringify(t),success:function(){},error:function(){}})},setLatLngOffset:function(){var t=s.get("offset-latlng");t&&(this.mapController.setOffset(t),this.staticMaps&&this.staticMaps.setOffset(t))},stopStream:function(){L.stop()},turnOnTrack:function(){if(this.cross_id&&this.token){var t={save_breadcrumbs:!0,after_in_seconds:3600};d.ajax({type:"POST",url:c+"/routex/users/crosses/"+this.cross_id+"?token="+this.token,data:JSON.stringify(t),success:function(){},error:function(){}})}},checkFollowing:function(){if(!this.checkFollowingStatus){var t=this,e="";if("wechat"===this.myIdentity.provider)e=this.myIdentity.external_username+"@wechat";else if(this.notification_identities.length)for(var i,n,s=this.notification_identities.slice(0);n=s.shift();)if(i=v(n),"wechat"===i.provider){e=i.external_username+"@wechat";break}e&&(this.checkFollowingStatus=1,d.ajax({url:o+"/identities/checkfollowing?token="+this.token+"&identity_id="+e,timeout:5e3,success:function(t){if(200===t.meta.code){var e=t.response.following,i=d("#wechat-guide");e?i.hasClass("hide")||i.addClass("ant hide"):i.hasClass("hide")&&(i.removeClass("hide"),window.getComputedStyle(i[0]).opacity,i.removeClass("ant"))}},complete:function(){t.checkFollowingStatus=0}}))}},getRoutexWidget:function(){var t,e=this.cross||window._ENV_.cross||{};if(e&&e.widget)for(var i=0,n=e.widget.length;n>i;++i){var s=e.widget[i];if("routex"===s.type){t=s;break}}return this.routexWidget=t},checkRouteXStatus:function(){var t=!0,e=this.routexWidget;(!e||e&&null===e.my_status)&&(t=confirm("开启这张活点地图\n这张“活点地图”将会展现您\n未来1小时内的方位。")),t?(this.checkFollowing(),this.streaming()):d("#privacy-dialog").removeClass("hide")},streaming:function(){var t=this;this.initStream(),this.startStream(),Debugger.log("start streaming"),Debugger.log("start monit"),this.timer=setInterval(function(){t.mapReadyStatus&&(Debugger.log(new Date),t.mapController.monit())},1e3)},loadStaticMaps:function(){var e=t("staticmaps");this.staticMaps=new e(this.$("#static-map"),this.myUserId);var i,n=this.routexWidget;n&&(i=n.objects)&&this.staticMaps.drawBatch(i.slice(0))},_cache:[],initStream:function(){var t=this,e=this._cache;L.init(t.cross.id,t.token,function(i){if(t.staticMaps&&t.staticMaps.draw(i),t.mapController&&(t.mapController.myUserId||(t.mapController.myUserId=t.myUserId),t.mapController.myIdentity||(t.mapController.myIdentity=t.myIdentity)),t.mapReadyStatus){if(e.length)for(var n;n=e.shift();)t.mapController.draw(n);t.mapController.draw(i)}else e.push(i)},function(t){Debugger.log(t)},function(){t.trackGeoLocation()},function(){})},startStream:function(){var t=this;t.switchGPSStyle(0),L.stopGeo(),L.startGeo(function(e){t.position={gps:[e.latitude+"",e.longitude+"",e.accuracy],t:e.timestamp},s.set("position",t.position),t.switchGPSStyle(2),t.trackGeoLocation()},function(e){return 1===e.code?(d("#privacy-dialog").removeClass("hide"),void 0):(t.switchGPSStyle(1),Debugger.log(e.status,e),L.stopGeo(),t.mapController&&t.mapController.switchGEOStyle(0),void 0)})},checkGPSStyle:function(){return~~this.$("#locate").attr("data-status")},switchGPSStyle:function(t,e){0===t?e="load":1===t?e="grey":(t=2,e="blue"),this.$("#locate").removeClass().addClass(e).attr("data-status",t)},trackGeoLocation:function(){var t=this.mapController,e=this.myUserId,i=this.position,n=this.mapReadyStatus,s=this.staticMaps;this.setLatLngOffset(),s&&(s.updateGeoPosition(i),s.updateGeoLocation(e,i)),n&&t&&(Debugger.log("tracking"),t.updateGeoLocation(e,i))},getExfee:function(){var t=this,e=this.cross;d.ajax({type:"GET",url:o+"/exfee/"+this.cross.exfee.id+"?token="+this.token,success:function(i){i&&i.meta&&200===i.meta.code&&(e.exfee=i.response.exfee,t.createIdentitiesList())},error:function(){}})},updateMe:function(t){this.myIdentity=t,Debugger.log("my identity",this.myIdentity);var e=this.$("#isme");e.attr("data-uid",t.connected_user_id),e.attr("data-name",t.name),e.find("img").attr("src",t.avatar_filename),e.data("identity",t)},updateNotifyProvider:function(t){if(t.length)for(var e,i;e=t.shift();)if(i=v(e),i&&("phone"===i.provider||"email"===i.provider)){d("#notify-provider").val(i.external_username);break}},createIdentitiesList:function(){var t,e,i=this.cross.exfee,n=this.$("#identities"),s=this.myUserId,a=(this.myIdentityId,this.smith_id),r=i.invitations.slice(0);for(n.empty();t=r.shift();)if(e=t.identity,e.notification_identities=t.notification_identities.slice(0),a!==e.id)if(s!==e.connected_user_id){var o=d('<div class="identity"><div class="abg"><img src="" alt="" class="avatar"/><div class="avatar-wrapper"></div></div><div class="detial unknown hide"><i class="icon icon-dot-grey"></i><span class="distance">方位未知</span></div></div>');o.attr("data-uid",e.connected_user_id),o.attr("data-name",e.name),o.find("img").attr("src",e.avatar_filename),n.append(o),o.data("identity",e)}else this.myUserId=e.connected_user_id,this.myIdentityId=e.id,this.updateMe(e),this.notification_identities=t.notification_identities.slice(0),this.updateNotifyProvider(this.notification_identities);window.getComputedStyle(n[0]).webkitTransform,n.parent().css("-webkit-transform","translate3d(0, 0, 0)"),Debugger.log("trigger handler scroll.maps"),d("#identities").triggerHandler("scroll")}});var O=e.WechatAboutRoutexController=I.extend({init:function(){this.render(),this.listen()},render:function(){d("#shuidi-dialog").remove(),this.element.appendTo(d("#app-container")),this.cross_id||this.element.addClass("nobg")},out:function(){if(!this.isOut){var t=this,e=this.element,i=e.find(".main"),n=e.find(".mw");setTimeout(function(){setTimeout(function(){t.destory(),e.remove(),t.isOut=!1},250),e.find(".sd-bg").css("background-color","rgba(0, 0, 0, 0)")},500),window.getComputedStyle(i[0]).top,i.css({"-webkit-transform":"translate(0px, "+n.scrollTop()+"px)",transform:"translate(0px, "+n.scrollTop()+"px)"})}},listen:function(){var t=this,e=this.element,i=this.cross_id;i&&(e.on("tap.maps",function(e){e.stopPropagation(),t.out(),t.isOut=!0}),e.find(".mw").on("scroll.maps",function(){0>=this.scrollTop&&(t.out(),t.isOut=!0)})),e.on("touchstart.maps",".app-btn",function(e){return e.preventDefault(),t.openEXFE(),!1}),e.on("touchstart.maps",".notify-frame .email",function(t){t.stopPropagation()}),e.on("touchstart.maps",".notify-ok",function(n){return n.stopPropagation(),t.addIdentity(e.find("#notify-provider").val()),i&&(t.destory(),e.remove()),!1}),e.on("touchstart.maps","#cleanup-cache",function(t){return t.stopPropagation(),s.clear(),window.location.href=window.location.href,!1}),t.on("show",function(){if(p&&e.find(".app").removeClass("hide"),i){var t,n=d(window).height(),s=e.find(".mw"),a=e.find(".main"),r=150;t=n-380,t>100?t=100:0>t&&(t=5),t=n-t+(5===t?0:50);var o={top:n+150,"min-height":t};a.css(o),s.css("max-height",n+150),s.prop("scrollTop",r),window.getComputedStyle(a[0]).top,e.find(".sd-bg").css("background-color","rgba(0, 0, 0, 0.85)"),setTimeout(function(){a.css({"-webkit-transform":"translate(0px, "+-t+"px)",transform:"translate(0px, "+-t+"px)"}),e.css("overflow-y","hidden")},250)}})},openEXFE:function(){var t=this.cross_id;window.location.href="/toapp?authenticate"+(t?"&cross_id="+t:"")},addIdentity:function(t,e){e=this.token;var i=v(t);return i&&"email"!==i.provider&&"phone"!==i.provider?(d("#notify-provider.email").attr("placeholder","请输入正确的手机号或电子邮件。"),void 0):(d.ajax({type:"POST",url:o+"/users/addIdentity"+"?token="+e,data:{provider:i.provider,external_username:i.external_username},success:function(){},error:function(){alert("Failed, please retry later.")}}),void 0)}})});