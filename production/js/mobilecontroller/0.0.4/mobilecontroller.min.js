define("mobilecontroller",function(e,t,i){"use strict";var a=e("base"),s=e("store"),n=e("tween"),r=window._ENV_.api_url,o=e("handlebars"),d=e("util"),l=d.trim,c=d.parseId,h=navigator.userAgent.match(/iPad/),u=e("live"),p=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},m=Date.now||function(){return(new Date).getTime()},v=function(){window.location="https://itunes.apple.com/us/app/exfe/id514026604"},f=function(e){window.location="exfe://crosses/"+(e||"")},b="webkitTransform"in document.body.style,C=function(e,t){var i=6===t.length?"":"3d";e.style[b?"webkitTransform":"transform"]="matrix"+i+"("+t.join(",")+")"},g=function(){var e=s.get("livecard");if(!e){var t={id:"",name:"",avatar:"",bio:"",identities:[]};e={card:t,latitude:"",longitude:"",accuracy:"",traits:[]};var i=s.get("user");i&&(t.name=i.name,t.avatar=i.avatar_filename,t.bio=i.bio,t.identities=i.identities),s.set("livecard",e)}return e.card.id="",e},y=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],w=[1,0,0,0,0,1,0,0,0,0,1,0,128,28,0,1],k=[1,0,0,0,0,1,0,0,0,0,1,0,128,0,0,1],_=0,x=function(){return"Controller-"+_++};t=i.exports={};var A=a.extend({initialize:function(e){this.cid=x(),this.initOptions(e),this.parseElement(),this.init(),A.caches[this.cid]=this},parseElement:function(){var e=this.element,t=this.options.template;if(e?this.element=e instanceof $?e:$(e):t&&(this.element=$(t)),!this.element)throw"element is invalid";this.element.attr("data-page-id",this.cid)},initOptions:function(e){this.setOptions(e);for(var t in e)"options"!==t&&(this[t]=e[t])},init:function(){},destory:function(){this.element.off(),this._destory()},_destory:function(){delete A.caches[this.cid],A.superclass.destory.call(this)},$:function(e){return this.element.find(e)}});A.caches=[],t.FooterController=A.extend({countDown:5,element:$("#app-footer"),init:function(){this.listen()},enableTimer:!0,listen:function(){var e=this,t=e.element;t.on("click.footer",".redirecting, .web-version",function(){window.location.href="/?ipad"+location.hash}).on("click.footer",".get-button button",function(){v()}).on("keydown.footer","#email",function(t){if(13===t.keyCode){var i=e.$("#email").val();e.addNotificationIdentity(i)}}).on("click.footer",".subscribe .btn_mail",function(){var t=l(e.$("#email").val());e.addNotificationIdentity(t)}),this.on("show",function(e,t,i,a){var s=e.height-96-(t?60:0);this.element.removeClass("hide"),this.element.css({position:"relative",top:s+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),h&&this.$(".web-version").removeClass("hide"),this.$(".error-info").toggleClass("hide",!a)}),this.on("reset-position",function(){var e=App.screen.height-96;this.element.removeClass("hide"),this.element.css({position:"absolute",top:e+"px"}),this.$(".action").addClass("hide"),this.$(".get-button").removeClass("hide"),h&&this.$(".web-version").removeClass("hide")}),this.on("show-from-cross",function(e,t,i,a){this.element.css({position:"relative",top:0}),this.emit("stop-redirect"),this.element.addClass("ft-bg"),this.cross={exfee_id:e,token:t},this.$(".actions").addClass("action-cross"),this.$(".action").addClass("hide"),i&&!a&&this.$(".subscribe").removeClass("hide"),this.element.removeClass("hide"),$("#app-footer").addClass("ft-bg"),this.$(".get-button").removeClass("hide"),h&&this.$(".web-version").removeClass("hide")}),this.on("show-from-resolve-token",function(){this.emit("stop-redirect"),1>this.countDown?($(".redirecting").removeClass("hide"),f()):this.emit("start-redirect")}),this.on("start-redirect",function(t){var i,a=$(".app-body .redirecting").removeClass("hide"),s=~~a.find(".sec")||5,n=e.countDown;s.text(i=n),this.App.set("redirectTimer",setInterval(function(){e.countDown=i-=1,i>=1?s.text(i):(a.addClass("hide"),e.emit("stop-redirect"),f(t))},1e3))}),this.on("stop-redirect",function(){this.enableTimer=!1,$(".app-body .redirecting").addClass("hide"),this.App.set("redirectTimer",clearInterval(this.App.set("redirectTimer")))})},addNotificationIdentity:function(e,t,i){t=this.cross.exfee_id,i=this.cross.token;var a=c(e);return a&&"email"!==a.provider?($("#email.email").attr("placeholder","Bad email Address."),void 0):($.ajax({type:"POST",url:r+"/Exfee/"+t+"/AddNotificationIdentity"+"?token="+i,data:{provider:a.provider,external_username:a.external_username},success:function(e){e&&e.meta&&200===e.meta.code&&$(".subscribe").hide()},error:function(){alert("Failed, please retry later.")}}),void 0)}}),t.VerifyController=A.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-verify").remove(),this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.resolveToken;this.on("show",function(i,a){setTimeout(function(){window.scrollTo(0,0)},14);var s=function(){i.error=!0,a.redirect("/")};this.element.removeClass("hide"),$("#app-body").css("height","100%"),App.controllers.footer.emit("reset-position"),$.ajax({type:"POST",url:r+"/Users/"+t.user_id+"?token="+t.token,data:{token:t.token},success:function(i){var a=i.meta;if(a&&200===a.code)for(var n=i.response.user,r=n.identities,o=0,d=r.length;d>o;++o){var l=r[o];if(l.id===t.identity_id){e.showIdentity(l),e.$(".done-info").removeClass("hide"),App.controllers.footer.emit("show-from-resolve-token");break}}else s()},error:function(){s()}})})},showIdentity:function(e){var t=this.$(".identity");t.find(".name").text(e.name),t.find(".avatar").attr("src",e.avatar_filename)}}),t.SetPasswordController=A.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-setpassword").remove(),this.element.appendTo($("#app-body"))},submitPassword:function(){var e=this,t=this.token,i=this.$(".set-button button"),a=this.$(".error-info"),s=this.$("#name"),n=this.$("#password"),o=n.val();o.length>=4?(i.addClass("disabled").prop("disabled",!0),$.ajax({type:"POST",url:r+"/Users/ResetPassword",data:{token:t,name:name,password:o},success:function(t){var r=t.meta;r&&200===r.code?(s.blur(),n.blur(),e.$(".done-info").removeClass("hide"),a.html("").addClass("hide"),i.parent().addClass("hide"),App.controllers.footer.emit("show-from-resolve-token")):i.removeClass("disabled").prop("disabled",!0),i.removeClass("disabled").prop("disabled",!0)},error:function(){a.html("Failed to set password. Please try later.").removeClass("hide"),i.removeClass("disabled").prop("disabled",!1)}})):a.html("Password must be longer than four!").removeClass("hide")},listen:function(){var e,t,i=this,a=this.element,s=this.resolveToken;a.on("touchstart.setpassword",".pass",function(){t&&(clearTimeout(t),t=void 0),e=m();var i=$(this).prev();i.prop("type","password")}).on("touchend.setpassword",".pass",function(i){if(m()-e>300){var a=$(this).prev();a.prop("type","text"),t=setTimeout(function(){a.prop("type","password")},500)}return i.preventDefault(),i.stopPropagation(),!1}).on("keydown.setpassword","#password",function(e){13===e.keyCode?i.submitPassword():i.$(".error-info").html("")}).on("touchstart.setpassword",".set-button button",function(){i.submitPassword()}),this.on("show",function(e,t){setTimeout(function(){window.scrollTo(0,0)},0);var i=function(){e.error=!0,t.redirect("/")};a.removeClass("hide"),$("#app-body").css("height","100%"),$.ajax({type:"POST",url:r+"/Users/"+s.user_id+"?token="+s.token,data:{token:s.token},success:function(e){var t=e.response.user;return e&&e.meta&&200===e.meta.code?($(".identity .avatar").attr("src",t.avatar_filename),$(".identity .name").html(t.name),void 0):(i(),void 0)},error:function(){i()}}),App.controllers.footer.emit("reset-position")})}}),t.HomeController=A.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-home").length||this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element;t.on("touchstart.home","#home-card",function(){e.stopAnimate(),e.emit("goto-live")}),this.on("goto-live",function(){App.controllers.footer.emit("stop-redirect"),App.request.switchPageCallback=function(){t.addClass("hide")},App.response.redirect("/#live")}),this.on("show",function(e,i){var a=e.height;this.$(".logo-box .inner").css("top",(a-300)/2+"px"),t.removeClass("hide"),k[13]=(a-64)/2,this.setHomeCard(k),i=!(!i||404!==i.code);var s=this.$(".title");s.find(".normal").removeClass("hide"),i&&setTimeout(function(){alert("Sorry. Your link is invalid or expired. Requested page was not found.")},14),this.$("#home-card").css("display","none")})},setHomeCard:function(e){var t=g(),i=t.card,a=i.name,s=i.avatar,n=this.$("#home-card");C(n[0],e),i&&(a||s)?(s||(s=a?r+"/avatar/default?name="+a:"/static/img/portrait_default.png"),s="url("+s+")"):s="",n.find(".avatar").css("background-image",s)},aopts:{o:1},createAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),i=document.getElementById("home-card"),a=function(){t.style.opacity=e.o,i.style.opacity=1-e.o};this._a=new n.Tween(e).delay(1377).to({o:0},1377).easing(n.Easing.Cubic.InOut).onUpdate(a),this._b=new n.Tween(e).delay(1377).to({o:1},1377).easing(n.Easing.Cubic.InOut).onUpdate(a)},startAnimate:function(){this._a||this._b||this.createAnimate(),this._a.chain(this._b),this._b.chain(this._a),this._a.start()},stopAnimate:function(){var e=this.aopts,t=document.getElementById("big-logo"),i=document.getElementById("home-card");this._a.chain(),this._b.chain(),this._b.stop(),this._a.stop(),e.o=t.style.opacity=1,i.style.opacity=0}}),t.CrossController=A.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-cross").remove(),this.element.appendTo($("#app-body"))},listen:function(){var e=this,t=this.element,i=this.token,a=this.cross,s=e.$(".rsvp_toolbar");t.on("touchstart.cross",".portrait.me",function(){s.toggleClass("rsvp_toolbar_off",!s.hasClass("rsvp_toolbar_off"))}).on("touchstart.cross",".changename",function(){var t=prompt("Change my display name:");t?$.ajax({type:"POST",url:r+"/Identities/"+a.identity.id+"/Update"+"?token="+i,data:{name:t},success:function(t){t&&t.meta&&200===t.meta.code&&e.$(".name_me").html(p(t.response.identity.name))},error:function(){alert("Failed, please retry later.")}}):alert("Display name cannot be empty.")}).on("touchstart.cross",".rsvp.accepted, .rsvp.unavailable",function(){var t=$(this).hasClass("accepted")?"ACCEPTED":"DECLINED";e.rsvp(t)}).on("touchstart.cross",".inf_area .description",function(){var e=$(this),t=e.hasClass("clickable");if(t){var i=e.hasClass("limit");e.toggleClass("limit",!i),e.find(".xbtn-more .rb").toggleClass("hidden",i),e.find(".xbtn-more .lt").toggleClass("hidden",!i)}}),this.on("show",function(){t.removeClass("hide");var e=this.$(".inf_area .description");e.height()>130&&(e.addClass("limit clickable"),e.find(".xbtn-more").removeClass("hide"),e.find(".xbtn-more .rb").removeClass("hidden"))})},rsvp:function(e){var t=this.cross.identity.id,i=this.exfee_id,a=this.token,s=[{rsvp_status:e,identity_id:t,by_identity_id:t}];this.$(".rsvp_toolbar").addClass("rsvp_toolbar_off");var n=this.$(".portrait_rsvp_me").removeClass("accepted declined pending");switch(e){case"ACCEPTED":n.addClass("accepted");break;case"DECLINED":n.addClass("declined");break;default:n.addClass("pending")}$.ajax({type:"post",url:r+"/Exfee/"+i+"/Rsvp?token="+a,data:{rsvp:JSON.stringify(s)},success:function(){},error:function(){alert("RSVP failed!")}})}}),t.LiveController=A.extend({init:function(){this.render(),this.listen()},render:function(){$("#app-live").length?this.element=$("#app-live"):this.element.appendTo($("#app-body"))},listen:function(){var e,t,i=this,a=this.element;a.on("touchstart.live","#card-name",function(e){e.stopPropagation(),setTimeout(function(){window.scrollTo(0,0)},0),this.focus()}).on("touchend.live",".live-form",function(e){e.stopPropagation(),$(e.target).hasClass("live-form")&&(a.find(".input-item").blur(),App.response.redirect("/"))}).on("keydown.live","#card-name",function(e){var t=e.keyCode,a=l(this.value);a&&13===t&&i.addEmailOrPhone(this,a)}).on("blur.live","#card-name",function(){var e=l(this.value);e?i.addEmailOrPhone(this,e):i.setCardName(this)}).on("keydown.live blur.live","#add-identity",function(e){var t=e.keyCode,a=l(this.value);(a&&13===t||"blur"===e.type)&&(i.addEmailOrPhone(this,a,!0),this.value="")}).on("keydown.live blur.live","#facebook-identity",function(e){var t=e.keyCode,a=l(this.value);(a&&13===t||"blur"===e.type)&&(a+="@facebook",i.addFacebook(this,a)&&$("#add-identity-facebook").addClass("hide"),this.value="")}).on("touchstart.live",".list .input-item",function(){$(this).next().removeClass("hidden")}).on("blur.live",".list .input-item",function(){$(this).next().addClass("hidden"),i.updateIdentityLi(this)}).on("touchstart.live",".list .delete",function(){var e,t=$(this).prev()[0],a=l(t.value),s=t.getAttribute("data-provider"),n="facebook"===s;n&&(a+="@facebook"),e=c(a),$(this).parent().remove(),e&&e.provider&&i.removeIdentity(e),n&&i.emit("show-add-facebook")}).on("touchstart.live",".btn-start",function(){var e=$(".list .input-item");e.each(function(){i.updateIdentityLi(this)});var t=document.getElementById("card-name");t.blur();var a=l(t.value);a?i.liveCard.card.name=a:i.setCardName(t),setTimeout(function(){i.inspectFields()&&(i.emit("post-card"),i.emit("live-gather"))},23)}).on("hold:live",".live-gather .card .avatar",function(){var e=this,t=e.parentNode,i=$(t).data("card"),a=t.style.transform||t.style.webkitTransform,s=a.match(/([\-\d\.]+)/g).slice(1),n=document.getElementById("card-tip"),r="";if(i&&i.identities){for(var o=0,d=i.identities.length;d>o;++o){var l=i.identities[o],c=l.provider,h=l.external_username,u="";"email"!==c&&"phone"!==c&&(c=c.substr(0,1).toUpperCase()+c.substr(1),u='<span class="provider">'+c+"</span>"),r+='<li><span class="external-username'+(u?"":" normal")+'">'+h+"</span>"+u+"</li>"}n.querySelector("ul").innerHTML=r;var p=n.clientHeight,m=~~s[12]-68,v=~~s[13]-(6+p),f=93;0>m?m=10:m+200>=320&&(m=110),(10===m||110===m)&&(f=~~s[12]+32-7-m),s[12]=m,s[13]=v-5,s[14]=7,C(n,s),n.querySelector(".ang").style.left=f+"px",n.querySelector(".bio").innerText=i.bio,n.className="card-tip"}}).on("touchstart.live",".live-gather .card .avatar",function(i){var a=$(this),s=250,n=i.touches.length;t=m(),e&&(clearTimeout(e),e=void 0),1===n&&n>=1&&(e=setTimeout(function(){a.trigger("hold:live")},s))}).on("touchend.live",".live-gather .card .avatar",function(){if(e&&(clearTimeout(e),e=void 0),250>m()-t){var i=$(this).parent();i.hasClass("card-me")||i.toggleClass("selected")}document.getElementById("card-tip").className="card-tip hidden"}).on("touchstart.live",".back",function(){i.$(".live-gather").addClass("hide"),App.response.redirect("/")}).on("touchstart.live",".live-gather",function(e){var t=e.target,i=$(".live-title h2"),a=i[0],s=i.hasClass("clicked");s&&($(".wave").css("opacity",1),i.data("clicked",t===a||$.contains(a,t)).removeClass("clicked"),$(".live-tip").addClass("live-tip-close"))}).on("touchstart.live",".live-title h2",function(){var e=$(this),t=e.hasClass("clicked"),i=e.data("clicked");t||i||($(this).addClass("clicked"),$(".wave").css("opacity",0),$(".live-tip").removeClass("live-tip-close")),e.data("clicked",!1)}).on("touchstart.live",".btn-confirm",function(){i.postContacts()}),this.on("show-add-email",function(){this.$("#add-identity").removeClass("hide")}),this.on("show-add-facebook",function(){this.$('.list input[data-provider="facebook"]').length||this.$("#add-identity-facebook").removeClass("hide")}),this.on("show",function(e){u.startGeo(),this.screen=e,$("#app-footer").addClass("hide"),this.element.removeClass("hide");var t=e.height;k[13]=(t-64)/2,C(this.$("#icard")[0],k),this.$(".live-form, .live-gahter").css("min-height",t),this.$(".live-form").removeClass("hide"),this.$("#live-discover").css("opacity",0),this.$("#card-form").css({opacity:0,"min-height":100*((t-100)/t)+"%"}),this.measurePositions(e.width,e.height-10,32,32),this.MAPS=this._MAPS.slice(0),this.$(".identities .list").empty(),this.liveCard=g(),this.updateMyCardForm(),this.startAnimate()}),this.on("post-card",function(){this.postMyCard()}),this.on("disabled-live-btn",function(e){this.$(".btn-start").toggleClass("disabled",e)}),this.on("live-gather",function(){this.$(".live-form").addClass("hide"),this.$(".live-gather").removeClass("hide"),this.$(".wave").addClass("start"),this.$(".live-gather").find(".card").remove();var e=this.liveCard.card,t=this.genCard(e,this.coords[0][0],0,0,!0,this.screen.ios).appendTo(this.$(".live-gather"));this.updateCard(t[0],e),this._others&&this.updateOthers()})},updateIdentityLi:function(e){var t,i=e.getAttribute("data-external-username"),a=e.getAttribute("data-provider"),s=e.getAttribute("data-name"),n="",r=l(e.value),o=!1,d=!1,h=!1;if(r)if("facebook"===a&&(r+="@facebook"),t=c(r),t&&t.provider){var u=this.findIdentity(t),p=t.provider===a&&t.external_username===i;u&&!p&&(e.value=n),u||p||(h=!0,o=!0)}else d=!0,o=!0;else d=!0,o=!0;d&&(e.setAttribute("data-name",n),e.setAttribute("data-external-username",n),e.setAttribute("data-provider",n),setTimeout(function(){alert("Invalid contact.")},14)),h&&(e.setAttribute("data-name",t.name),e.setAttribute("data-external-username",t.external_username),e.setAttribute("data-provider",t.provider),e.value=t.external_username,$(e).prev().text(this.aliasProvider(t.provider)),this.updateLiveCard(t,"+")),o&&this.updateLiveCard({name:s,external_username:i,provider:a},"-",!0),(o||h)&&this.emit("post-card")},postContacts:function(){},inspectFields:function(){var e=this.liveCard.card;return e.name&&e.identities.length},updateCardName:function(e){e.name&&(this.liveCard.card.name=document.getElementById("card-name").value=e.name,s.set("livecard",this.liveCard))},updateMe:function(e){var t,i=document.getElementById("icard"),a=i.getAttribute("data-url");a!==e.avatar&&(t=e.avatar,t||(t=e.name?r+"/avatar/default?name="+e.name:"/static/img/portrait_default.png"),a!==t&&(i.querySelector(".avatar").style.backgroundImage="url("+t+")",i.setAttribute("data-url",t)));var s=document.getElementById("card-bio");e.bio&&(s.innerText=e.bio),s.className=e.bio?"":"hide"},postMyCard:function(){s.set("livecard",this.liveCard);var e=this.liveCard.card;e.name&&e.identities.length&&u.init(e,$.proxy(this.liveCallback,this))},state:1,liveCallback:function(e){var t=this.liveCard,i=e.me;1===this.state&&i&&i.name&&i.identities.length&&(m()-i.timestamp>6e4&&this.updateCardName(i),this.updateMe(t.card=i),s.set("livecard",t)),this._others=e.others,this.updateOthers()},updateMyCardForm:function(){var e,t=this.liveCard,i=t.card,a=i.identities;if(a&&(e=a.length)){this.updateCardName(i),this.updateMe(i),this.postMyCard(),a=a.slice(0);for(var s,n;s=a.shift();)n=s.provider,("email"===n||"phone"===n||"facebook"===n)&&this.addIdentity(s,!0);this.emit("show-add-email"),this.emit("show-add-facebook")}else this.emit("disabled-live-btn",!0)},resetLiveCard:function(){this.emit("disabled-live-btn",!0),s.clear("livecard"),this.liveCard=g()},findIdentity:function(e){var t=this.liveCard.card,i=t.identities,a=i.length;if(a)for(var s=0;a>s;++s){var n=i[s];if(n.provider===e.provider&&n.external_username===e.external_username)return!0}return!1},updateLiveCard:function(e,t,i){var a=this.liveCard.card,n=a.identities;if("+"===t)n.push(e);else{for(var r=0,o=n.length;o>r;++r){var d=n[r];if(d.provider===e.provider&&d.external_username===e.external_username){n.splice(r,1);break}}i||0!==n.length||this.resetLiveCard()}s.set("livecard",this.liveCard)},setCardName:function(e){var t=this.packedIdentities();if(t.length){var i=t[0],a="",s=i.external_username,n=i.provider;a="phone"===n?"Anonym_"+s.slice(s.length-4):s.split("@")[0],this.liveCard.card.name=e.value=a,e.setAttribute("placeholder","Name"),$(e).addClass("normal")}},addFacebook:function(e,t){var i=c(t),a=i.provider;return a&&"facebook"===a&&!this.existsByIdentity(i)?(this.addIdentity(i),!0):!1},addEmailOrPhone:function(e,t,i){i=!i;var a=c(t),s=a.provider;!s||"email"!==s&&"phone"!==s||this.existsByIdentity(a)||(this.addIdentity(a),i&&this.setCardName(e)),i&&(this.emit("show-add-email"),this.emit("show-add-facebook")),this.emit("post-card")},aliasProvider:function(e){return"email"===e?e="Email":"phone"===e?e="Mobile":"facebook"===e&&(e="Facebook"),e},genIdentity:function(e){var t=o.compile($("#live-li-identity-tmpl").html()),i=e.provider;i=this.aliasProvider(i);var a=$(t({provider_alias:i,identity:e}));return a},resetCard:function(){this.state=0,this.$("#icard").removeAttr("data-url").find(".avatar").css("background",""),this.$("#card-name").attr("placeholder","Your email or mobile no.").removeClass("normal").val(""),this.$("#add-identity").addClass("hide"),this.$("#add-identity-facebook").addClass("hide")},removeIdentity:function(e){var t=this.$(".identities .list li");0===t.length?(this.resetCard(),this.emit("disabled-live-btn",!0)):"facebook"===e.provider&&this.emit("show-add-facebook"),this.updateLiveCard(e,"-"),this.emit("post-card")},addIdentity:function(e,t){t=!t,this.state=1;var i=this.$(".identities .list"),a=this.genIdentity(e);i.append(a),this.emit("disabled-live-btn",!1),t&&(this.updateLiveCard(e,"+"),this.emit("post-card"))},packedIdentities:function(){for(var e,t,i,a,s,n=this.$(".identities .list").find("input"),r=0,o=n.length,d=[];o>r;++r)e=n.eq(r),t=e.attr("data-provider"),i=l(n.eq(r).val()),i&&("facebook"===t&&(i+="@facebook"),a=c(i),s=a.provider,!s||"email"!==s&&"phone"!==s&&"facebook"!==s||d.push(a));return d},existsByIdentity:function(e){var t,i=this.packedIdentities(),a=e.external_username,s=e.provider;if(0===i.length)return!1;for(;t=i.shift();)if(t.external_username===a&&t.provider===s)return!0;return!1},coords:"".split(),_MAPS:[[1,0],[1,1],[1,2],[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]],MAPS:"".split(),measurePositions:function(e,t,i,a){var s=this.coords;s[0]=[[.5*e-i,.88*t-a]],s[1]=Array(3),s[1][0]=[.25*e-5-i,.66*t+30-a],s[1][1]=[.5*e-i,.66*t-a],s[1][2]=[.75*e+5-i,.66*t+30-a],s[2]=Array(4),s[2][0]=[.125*e+5-i,.44*t+40-a],s[2][1]=[.375*e-i,.44*t-a],s[2][2]=[.625*e-i,.44*t-a],s[2][3]=[.875*e-5-i,.44*t+40-a],s[3]=Array(4),s[3][0]=[.125*e-i,.22*t+40-a],s[3][1]=[.375*e-i,.22*t-a],s[3][2]=[.625*e-i,.22*t-a],s[3][3]=[.875*e-i,.22*t+40-a]},genCard:function(e,t,i,a,s,n){var r=o.compile($("#live-card-tmpl").html()),d=y.slice(0);d[12]=t[0],d[13]=t[1];var l=$(r({g:i,i:a,matrix:d.join(","),"class":(s?"card-me":"card-other hide")+("iphone4"===n?" card-iphone4":""),card:e}));return l.data("card",e),l},addCard:function(e){var t=this.MAPS;if(!t||0===t.length)return!1;var i=t.shift(),a=i[0],s=i[1],r=this.coords[a][s],o=this.genCard(e,r,a,s,!1,this.screen.ios),d=o[0],l=d.style,c=y.slice(0);c[0]=c[5]=0,c[12]=r[0],c[13]=r[1],o.data("card",e),this.$(".live-gather").append(o),new n.Tween({o:0}).to({o:1},250).easing(n.Easing.Bounce.In).onStart(function(){C(d,c),o.removeClass("hide")}).onUpdate(function(){l.opacity=this.o,c[0]=c[5]=this.o,C(d,c)}).onComplete(function(){n.remove(this)}).start()},delCard:function(e){var t=this.MAPS,i=e.getAttribute("data-g"),a=e.getAttribute("data-i"),s=y.slice(0),r=this.coords[i][a],o=e.style;s[12]=r[0],s[13]=r[1],new n.Tween({o:1}).to({o:0},250).easing(n.Easing.Bounce.Out).onUpdate(function(){o.opacity=this.o,C(e,s)}).onComplete(function(){t.unshift([i,a]),e.parentNode.removeChild(e),n.remove(this)}).start()},updateCard:function(e,t){var i=e.getAttribute("data-url"),a="";i&&i===t.avatar||(a=t.avatar,a||(a=t.name?r+"/avatar/default?name="+t.name:"/static/img/portrait_default.png"),i!==a&&(e.querySelector(".avatar").style.backgroundImage="url("+a+")",e.setAttribute("data-url",a))),e.querySelector(".name").innerText=t.name,$(e).data("card",t)},updateOthers:function(){for(var e,t,i,a,s=this._others,n=document.querySelectorAll(".card-other"),r=n.length,o=0;r>o;++o)e=n[o],t=e.getAttribute("id"),t in s||this.delCard(e);for(i in s)a=s[i],e=document.getElementById(a.id),e?this.updateCard(e,a):this.addCard(a)},createAnimate:function(){var e=this.$("#icard")[0],t=this.$("#card-form")[0],i=this.$("#live-discover")[0],a=k[13],s=w[13],r=k.slice(0);this.a=new n.Tween({o:0}).to({o:1},500).easing(n.Easing.Cubic.In).onUpdate(function(){i.style.opacity=this.o,r[13]=(a-s)*(1-this.o)+s,C(e,r)}),this.b=new n.Tween({o:0}).delay(250).to({o:1},500).onUpdate(function(){t.style.opacity=this.o})},startAnimate:function(){this.a||this.b||this.createAnimate(),this.a.start(),this.b.start()},stopAnimate:function(){this.a.stop(),this.b.stop()}})});