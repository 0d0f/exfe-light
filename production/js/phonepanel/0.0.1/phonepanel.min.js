define("phonepanel",function(e){"use strict";var t=e("jquery"),n=t.proxy,r=t.extend,i=e("config"),s=e("api"),o=/[\r\n]+/g,u="\r",a=t(window),f=t.browser.msie,l="",c=0,h={country_code:"",phone_number:""},p="",d="",v=e("countrycodes"),m=e("panel"),g=function(e,n){typeof v[e]!="undefined"&&(c=e,n||t("#phone-panel .countrycode").val("+"+v[c].country_code),t(".tips-area .ta-countrycode").html(v[c].short_name),y(),b())},y=function(){v[c].format_long&&v[c].format_reg&&v[c].format_str&&l.length===v[c].format_long?t("#phone-panel .phonenumber").val(l.replace(v[c].format_reg,v[c].format_str)):t("#phone-panel .phonenumber").val(l)},b=function(){E(),t("#phone-panel .countrycode").val()&&t("#phone-panel .name").val()&&l?t("#phone-panel .add").prop("disabled",!1):t("#phone-panel .add").prop("disabled",!0)},w=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},E=function(){var e="+"+v[c].country_code+l;e!==p&&(s.request("getIdentity",{type:"POST",data:{identities:JSON.stringify([{provider:"phone",external_username:e}])}},function(e){e&&e.identities&&e.identities.length&&e.identities[0].connected_user_id>0?(d=e.identities[0].avatar_filename,t("#phone-panel .identity-avatar").attr("src",d).show(),t("#phone-panel .identity-name").html(w(e.identities[0].name)).show(),t("#phone-panel .name").val(e.identities[0].name).hide(),t("#phone-panel .add").toggleClass("match",!0)):(d="",t("#phone-panel .identity-avatar").hide(),t("#phone-panel .identity-name").hide(),t("#phone-panel .name").val("").show(),t("#phone-panel .add").toggleClass("match",!1))}),p=e)},S=m.extend({options:{template:'<div class="panel phone-panel" tabindex="-1" data-widget="panel" id="phone-panel"><div class="panel-body"><div class="main-info">Please complete contact info:</div><div class="clearfix input-area"><input class="countrycode" tabindex="4" type="text" /><input class="phonenumber" tabindex="5" type="text" /></div><div class="tips-area"><div class="ta-countrycode"></div><div class="ta-phonenumber">Area code and local number</div></div><ol class="clearfix complete-list"></ol><div class="name-area"><input class="name" type="text" tabindex="2" placeholder="Enter contact name" /><img class="identity-avatar"/><div class="identity-name"></div><button class="xbtn-blue add" tabindex="3" disabled="disabled">Add</button></div></div></div>',parentNode:null,srcNode:null},init:function(){var e=this,n=this.options,r;this.render(),r=this.element;for(var i=0;i<v.length;i++)v[i].regular=new RegExp(v[i].regular),v[i].format_reg=v[i].format_reg?new RegExp(v[i].format_reg):"",v[i].short_name==="US"&&(c=i);this.listen(),t(document.body).on("click.phonepanel",function(n){var r=t("#phone-panel");if(r.length&&r[0]!==n.target&&!t.contains(r[0],n.target)){e.hide(),t(document.body).off("click.phonepanel");return}})},listen:function(){var e=this,n=this.element;n.on("keyup.phonepanel",".countrycode",function(e){var r=function(e){return'<li country-code="'+e+'">'+'<div class="li-countrycode">+'+v[e].country_code+"</div>"+'<div class="li-countryname">'+v[e].country_name+"</div>"+'<div class="li-tips">'+v[e].support.join(" and ")+" supported</div>"+"</li>"};switch(e.keyCode){case 38:case 40:return;case 13:var i=t(".complete-list li.selected"),s=~~i.attr("country-code");typeof v[s]&&(g(s),n.find(".tips-area").show(),n.find(".complete-list").slideUp());return}var o="",u=-1,a=t(this).val().toLowerCase();if(a)if(/^\+[0-9]*/.test(a))for(var f=0;f<v.length;f++)"+"+v[f].country_code===a?(o=r(f)+o,u=f):("+"+v[f].search_index).indexOf(a)!==-1&&(o+=r(f),u=u===-1?f:u);else for(f=0;f<v.length;f++)v[f].country_code===a?(o=r(f)+o,u=f):v[f].search_index.indexOf(a)!==-1&&(o+=r(f),u=u===-1?f:u);n.find(".complete-list").html(o),o?(n.find(".tips-area").hide(),n.find(".complete-list").slideDown(),n.find(".complete-list li").eq(0).toggleClass("selected",!0),g(u,!0)):(n.find(".tips-area").show(),n.find(".complete-list").slideUp())}),n.on("keydown.phonepanel",".countrycode",function(e){if(!n.find(".complete-list").html())return;var t=n.find(".complete-list li.selected"),r=n.find(".complete-list"),i=~~t.index(),s=44,o=s*3,u=n.find(".complete-list li").length-1,a=r.scrollTop();switch(e.keyCode){case 38:event.preventDefault(),--i<0&&(i=u);break;case 40:event.preventDefault(),++i>u&&(i=0)}t.toggleClass("selected",!1),n.find(".complete-list li").eq(i).toggleClass("selected",!0);var f=i*s,l=f-a;l<0?r.scrollTop(f):l+s>o&&r.scrollTop(f+s-o+1)}),n.on("blur.phonepanel",".countrycode",function(e){g(c)}),n.on("focus.phonepanel",".countrycode",function(e){t(this).css("z-index","1"),n.find(".phonenumber").css("z-index","0")}),n.on("focus.phonepanel",".phonenumber",function(e){n.find(".phonenumber").val(l),n.find(".complete-list").html(""),n.find(".tips-area").show(),n.find(".complete-list").slideUp(),t(this).prop("tabindex","1"),t(this).css("z-index","1"),n.find(".countrycode").css("z-index","0")}),n.on("blur.phonepanel",".phonenumber",function(e){var r=n.find(".phonenumber").val().replace(/\-|\(|\)|\ /g,"");/^[0-9]*$/.test(r)?l=r:l="",y(),b(),t(this).prop("tabindex","5")}),n.on("mouseover.phonepanel",".complete-list li",function(e){t(this).siblings().filter(".selected").toggleClass("selected",!1),t(this).toggleClass("selected",!0)}),n.on("click.phonepanel",".complete-list li",function(e){var r=t(this),i=~~r.attr("country-code");typeof v[i]&&(g(i),n.find(".tips-area").show(),n.find(".complete-list").slideUp())}),n.on("keyup.phonepanel",".name",function(e){n.find(".complete-list").html(""),n.find(".tips-area").show(),n.find(".complete-list").slideUp()}),n.on("keyup.phonepanel",".name",function(r){if(t(this).val()&&r.keyCode===13){var i="+"+v[c].country_code+l,s=n.find(".name").val();e.add({provider:"phone",external_id:i,external_username:i,name:s,avatar_filename:d?d:ExfeeWidget.api_url+"/avatar/default?name="+s}),e.hide()}b()}),n.on("click.phonepanel",".add",function(t){var r="+"+v[c].country_code+l,i=n.find(".name").val();e.add({provider:"phone",external_id:r,external_username:r,name:i,avatar_filename:d?d:ExfeeWidget.api_url+"/avatar/default?name="+i}),e.hide()})},save:function(){this.$(".place-submit").trigger("click.mappanel")},showAfter:function(){var e=this,n=e.srcNode;if(n){var r=n.offset(),i=e.element,s=i.outerWidth(),o=n.outerHeight();i.css({left:this.oleft=r.left,top:this.otop=r.top+o}),t("#phone-panel .identity-avatar").hide(),t("#phone-panel .identity-name").hide(),l=n.val().replace(/\-|\(|\)|\ /g,"");var u=c;if(/^\+.*$/.test(l))for(var a=0;a<v.length;a++)if(v[a].regular.test(l)){l=l.replace(v[a].regular,""),u=a;break}g(u),i.find(".name").focus()}},destory:function(){this.element.off(),this.element.remove(),this._destory()}});return S});