define("phonepanel",function(e){"use strict";var t=e("jquery"),n=t.proxy,r=t.extend,i=e("config"),s=/[\r\n]+/g,o="\r",u=t(window),a=t.browser.msie,f="",l=0,c={country_code:"",phone_number:""},h=e("countrycodes"),p=e("panel"),d=function(e,n){typeof h[e]!="undefined"&&(l=e,n||t("#phone-panel .countrycode").val("+"+h[l].country_code),t(".tips-area .ta-countrycode").html(h[l].short_name),v(),m())},v=function(){h[l].format_long&&h[l].format_reg&&h[l].format_str&&f.length===h[l].format_long?t("#phone-panel .phonenumber").val(f.replace(h[l].format_reg,h[l].format_str)):t("#phone-panel .phonenumber").val(f)},m=function(){t("#phone-panel .countrycode").val()&&t("#phone-panel .name").val()&&f?t("#phone-panel .add").prop("disabled",!1):t("#phone-panel .add").prop("disabled",!0)},g=p.extend({options:{template:'<div class="panel phone-panel" tabindex="-1" data-widget="panel" id="phone-panel"><div class="panel-body"><div class="main-info">Please complete contact info:</div><div class="input-area"><input class="countrycode" type="text" /><input class="phonenumber" type="text" /></div><div class="tips-area"><div class="ta-countrycode"></div><div class="ta-phonenumber">Area code and local number</div></div><ol class="complete-list"></ol><div class="name-area"><input class="name" type="text" placeholder="Enter contact name" /><button class="xbtn-blue add" disabled="disabled">Add</button></div></div></div>',parentNode:null,srcNode:null},init:function(){var e=this.options,t;this.render(),t=this.element;for(var n=0;n<h.length;n++)h[n].regular=new RegExp(h[n].regular),h[n].format_reg=h[n].format_reg?new RegExp(h[n].format_reg):"",h[n].short_name==="US"&&(l=n);this.listen()},listen:function(){var e=this,n=this.element;n.on("keyup.phonepanel",".countrycode",function(e){var r=function(e){return'<li country-code="'+e+'">'+'<div class="li-countrycode">+'+h[e].country_code+"</div>"+'<div class="li-countryname">'+h[e].country_name+"</div>"+'<div class="li-tips">'+h[e].support.join(" and ")+" supported</div>"+"</li>"};switch(e.keyCode){case 38:case 40:return;case 13:var i=t(".complete-list li.selected"),s=~~i.attr("country-code");typeof h[s]&&(d(s),n.find(".tips-area").show(),n.find(".complete-list").slideUp());return}var o="",u=-1,a=t(this).val().toLowerCase();if(a)if(/^\+[0-9]*/.test(a))for(var f=0;f<h.length;f++)"+"+h[f].country_code===a?(o=r(f)+o,u=f):("+"+h[f].search_index).indexOf(a)!==-1&&(o+=r(f),u=u===-1?f:u);else for(f=0;f<h.length;f++)h[f].country_code===a?(o=r(f)+o,u=f):h[f].search_index.indexOf(a)!==-1&&(o+=r(f),u=u===-1?f:u);n.find(".complete-list").html(o),o?(n.find(".tips-area").hide(),n.find(".complete-list").slideDown(),n.find(".complete-list li").eq(0).toggleClass("selected",!0),d(u,!0)):(n.find(".tips-area").show(),n.find(".complete-list").slideUp())}),n.on("keydown.phonepanel",".countrycode",function(e){if(!n.find(".complete-list").html())return;var t=n.find(".complete-list li.selected"),r=n.find(".complete-list"),i=~~t.index(),s=44,o=s*3,u=n.find(".complete-list li").length-1,a=r.scrollTop();switch(e.keyCode){case 38:event.preventDefault(),--i<0&&(i=u);break;case 40:event.preventDefault(),++i>u&&(i=0)}t.toggleClass("selected",!1),n.find(".complete-list li").eq(i).toggleClass("selected",!0);var f=i*s,l=f-a;l<0?r.scrollTop(f):l+s>o&&r.scrollTop(f+s-o+1)}),n.on("blur.phonepanel",".countrycode",function(e){d(l)}),n.on("focus.phonepanel",".phonenumber",function(e){n.find(".phonenumber").val(f),n.find(".complete-list").html(""),n.find(".tips-area").show(),n.find(".complete-list").slideUp()}),n.on("blur.phonepanel",".phonenumber",function(e){var t=n.find(".phonenumber").val().replace(/\-|\(|\)|\ /g,"");/^[0-9]*$/.test(t)?f=t:f="",v(),m()}),n.on("mouseover.phonepanel",".complete-list li",function(e){t(this).siblings().filter(".selected").toggleClass("selected",!1),t(this).toggleClass("selected",!0)}),n.on("click.phonepanel",".complete-list li",function(e){var r=t(this),i=~~r.attr("country-code");typeof h[i]&&(d(i),n.find(".tips-area").show(),n.find(".complete-list").slideUp())}),n.on("keyup.phonepanel",".name",function(e){n.find(".complete-list").html(""),n.find(".tips-area").show(),n.find(".complete-list").slideUp()}),n.on("keyup.phonepanel",".name",function(r){if(t(this).val()&&r.keyCode===13){var i="+"+h[l].country_code+f,s=n.find(".name").val();e.add({provider:"phone",external_id:i,external_username:i,name:s,avatar_filename:ExfeeWidget.api_url+"/avatar/default?name="+s}),e.hide()}m()}),n.on("click.phonepanel",".add",function(t){var r="+"+h[l].country_code+f,i=n.find(".name").val();e.add({provider:"phone",external_id:r,external_username:r,name:i,avatar_filename:ExfeeWidget.api_url+"/avatar/default?name="+i}),e.hide()})},save:function(){this.$(".place-submit").trigger("click.mappanel")},showAfter:function(){var e=this,t=e.srcNode;if(t){var n=t.offset(),r=e.element,i=r.outerWidth(),s=t.outerHeight();r.css({left:this.oleft=n.left,top:this.otop=n.top+s}),f=t.val().replace(/\-|\(|\)|\ /g,"");var o=l;if(/^\+.*$/.test(f))for(var u=0;u<h.length;u++)if(h[u].regular.test(f)){f=f.replace(h[u].regular,""),o=u;break}d(o),r.find(".name").focus()}},destory:function(){this.element.off(),this.element.remove(),this._destory()}});return g});