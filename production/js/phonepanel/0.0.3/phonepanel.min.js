define("phonepanel",function(e){"use strict";var t=e("jquery"),i=e("api"),s="",n=0,o="",a="",r=e("countrycodes"),d=e("panel"),l=function(e,i){r[e]!==void 0&&(n=e,i||t("#phone-panel .countrycode").val("+"+r[n].country_code),t(".tips-area .ta-countrycode").html(r[n].short_name),c(),p())},c=function(){r[n].format_long&&r[n].format_reg&&r[n].format_str&&s.length===r[n].format_long?t("#phone-panel .phonenumber").val(s.replace(r[n].format_reg,r[n].format_str)):t("#phone-panel .phonenumber").val(s)},p=function(){u(),t("#phone-panel .countrycode").val()&&t("#phone-panel .name").val()&&s?t("#phone-panel .add").prop("disabled",!1):t("#phone-panel .add").prop("disabled",!0)},f=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},u=function(){var e="+"+r[n].country_code+s;e!==o&&(i.request("getIdentity",{type:"POST",data:{identities:JSON.stringify([{provider:"phone",external_username:e}])}},function(e){e&&e.identities&&e.identities.length&&e.identities[0].connected_user_id>0?(a=e.identities[0].avatar_filename,t("#phone-panel .identity-avatar").attr("src",a).show(),t("#phone-panel .identity-name").html(f(e.identities[0].name)).show(),t("#phone-panel .name").val(e.identities[0].name).hide(),t("#phone-panel .add").toggleClass("match",!0)):(a="",t("#phone-panel .identity-avatar").hide(),t("#phone-panel .identity-name").hide(),t("#phone-panel .name").val("").show(),t("#phone-panel .add").toggleClass("match",!1))}),o=e)},h=d.extend({options:{template:'<div class="panel phone-panel" tabindex="-1" data-widget="panel" id="phone-panel"><div class="panel-body"><div class="main-info">Please complete contact info:</div><div class="clearfix input-area"><input class="countrycode" tabindex="4" type="text" /><input class="phonenumber" tabindex="5" type="text" /></div><div class="tips-area"><div class="ta-countrycode"></div><div class="ta-phonenumber">Area code and local number</div></div><ol class="clearfix complete-list"></ol><div class="name-area"><input class="name" type="text" tabindex="2" placeholder="Enter contact name" /><img class="identity-avatar"/><div class="identity-name"></div><button class="xbtn-blue add" tabindex="3" disabled="disabled">Add</button></div></div></div>',parentNode:null,srcNode:null},init:function(){var e,i=this;this.render(),e=this.element;for(var s=0;r.length>s;s++)r[s].regular=RegExp(r[s].regular),r[s].format_reg=r[s].format_reg?RegExp(r[s].format_reg):"","US"===r[s].short_name&&(n=s);this.listen(),t(document.body).on("click.phonepanel",function(e){var s=t("#phone-panel");return s.length&&s[0]!==e.target&&!t.contains(s[0],e.target)?(t(document.body).off("click.phonepanel"),i.hide(),void 0):void 0})},listen:function(){var e=this,i=this.element;i.on("keyup.phonepanel",".countrycode",function(e){var s=function(e){return'<li country-code="'+e+'">'+'<div class="li-countrycode">+'+r[e].country_code+"</div>"+'<div class="li-countryname">'+r[e].country_name+"</div>"+'<div class="li-tips">'+r[e].support.join(" and ")+" supported</div>"+"</li>"};switch(e.keyCode){case 38:case 40:return;case 13:var n=t(".complete-list li.selected"),o=~~n.attr("country-code");return l(o),i.find(".tips-area").show(),i.find(".complete-list").slideUp(),void 0}var a="",d=-1,c=t(this).val().toLowerCase();if(c)if(/^\+[0-9]*/.test(c))for(var p=0;r.length>p;p++)"+"+r[p].country_code===c?(a=s(p)+a,d=p):-1!==("+"+r[p].search_index).indexOf(c)&&(a+=s(p),d=-1===d?p:d);else for(p=0;r.length>p;p++)r[p].country_code===c?(a=s(p)+a,d=p):-1!==r[p].search_index.indexOf(c)&&(a+=s(p),d=-1===d?p:d);i.find(".complete-list").html(a),a?(i.find(".tips-area").hide(),i.find(".complete-list").slideDown(),i.find(".complete-list li").eq(0).toggleClass("selected",!0),l(d,!0)):(i.find(".tips-area").show(),i.find(".complete-list").slideUp())}),i.on("keydown.phonepanel",".countrycode",function(e){if(i.find(".complete-list").html()){var t=i.find(".complete-list li.selected"),s=i.find(".complete-list"),n=~~t.index(),o=44,a=3*o,r=i.find(".complete-list li").length-1,d=s.scrollTop();switch(e.keyCode){case 38:event.preventDefault(),0>--n&&(n=r);break;case 40:event.preventDefault(),++n>r&&(n=0)}t.toggleClass("selected",!1),i.find(".complete-list li").eq(n).toggleClass("selected",!0);var l=n*o,c=l-d;0>c?s.scrollTop(l):c+o>a&&s.scrollTop(l+o-a+1)}}),i.on("blur.phonepanel",".countrycode",function(){l(n)}),i.on("focus.phonepanel",".countrycode",function(){t(this).css("z-index","1"),i.find(".phonenumber").css("z-index","0")}),i.on("focus.phonepanel",".phonenumber",function(){i.find(".phonenumber").val(s),i.find(".complete-list").html(""),i.find(".tips-area").show(),i.find(".complete-list").slideUp(),t(this).prop("tabindex","1"),t(this).css("z-index","1"),i.find(".countrycode").css("z-index","0")}),i.on("blur.phonepanel",".phonenumber",function(){var e=i.find(".phonenumber").val().replace(/\-|\(|\)|\ /g,"");s=/^[0-9]*$/.test(e)?e:"",c(),p(),t(this).prop("tabindex","5")}),i.on("mouseover.phonepanel",".complete-list li",function(){t(this).siblings().filter(".selected").toggleClass("selected",!1),t(this).toggleClass("selected",!0)}),i.on("click.phonepanel",".complete-list li",function(){var e=t(this),s=~~e.attr("country-code");l(s),i.find(".tips-area").show(),i.find(".complete-list").slideUp()}),i.on("keyup.phonepanel",".name",function(){i.find(".complete-list").html(""),i.find(".tips-area").show(),i.find(".complete-list").slideUp()}),i.on("keyup.phonepanel",".name",function(o){if(t(this).val()&&13===o.keyCode){var d="+"+r[n].country_code+s,l=i.find(".name").val();e.add({provider:"phone",external_id:d,external_username:d,name:l,avatar_filename:a?a:ExfeeWidget.api_url+"/avatar/default?name="+l}),e.hide()}p()}),i.on("click.phonepanel",".add",function(){var t="+"+r[n].country_code+s,o=i.find(".name").val();e.add({provider:"phone",external_id:t,external_username:t,name:o,avatar_filename:a?a:ExfeeWidget.api_url+"/avatar/default?name="+o}),e.hide()})},save:function(){this.$(".place-submit").trigger("click.mappanel")},showAfter:function(){var e=this,i=e.srcNode;if(i){var o=i.offset(),a=e.element,d=i.outerHeight();a.css({left:this.oleft=o.left,top:this.otop=o.top+d}),t("#phone-panel .identity-avatar").hide(),t("#phone-panel .identity-name").hide(),s=i.val().replace(/\-|\(|\)|\ /g,"");var c=n;if(/^\+.*$/.test(s))for(var p=0;r.length>p;p++)if(r[p].regular.test(s)){s=s.replace(r[p].regular,""),c=p;break}l(c),a.find(".name").focus()}},destory:function(){this.element.off(),this.element.remove(),this._destory()}});return h});