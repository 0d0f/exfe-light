define("phonepanel",function(e){"use strict";var t=e("jquery"),n=e("api"),r="",a=0,i="",s="",o=e("countrycodes"),l=e("panel"),c=function(e,n){o[e]!==void 0&&(a=e,n||t("#phone-panel .countrycode").val("+"+o[a].country_code),t(".tips-area .ta-countrycode").html(o[a].short_name),u(),d())},u=function(){o[a].format_long&&o[a].format_reg&&o[a].format_str&&r.length===o[a].format_long?t("#phone-panel .phonenumber").val(r.replace(o[a].format_reg,o[a].format_str)):t("#phone-panel .phonenumber").val(r)},d=function(){p(),t("#phone-panel .countrycode").val()&&t("#phone-panel .name").val()&&r?t("#phone-panel .add").prop("disabled",!1):t("#phone-panel .add").prop("disabled",!0)},h=function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},p=function(){var e="+"+o[a].country_code+r;e!==i&&(n.request("getIdentity",{type:"POST",data:{identities:JSON.stringify([{provider:"phone",external_username:e}])}},function(e){e&&e.identities&&e.identities.length&&e.identities[0].connected_user_id>0?(s=e.identities[0].avatar_filename,t("#phone-panel .identity-avatar").attr("src",s).show(),t("#phone-panel .identity-name").html(h(e.identities[0].name)).show(),t("#phone-panel .name").val(e.identities[0].name).hide(),t("#phone-panel .add").prop("disabled",!1)):(s="",t("#phone-panel .identity-avatar").hide(),t("#phone-panel .identity-name").hide(),t("#phone-panel .name").val("").show(),t("#phone-panel .add").prop("disabled",!0))}),i=e)},f=l.extend({options:{template:'<div class="panel phone-panel" tabindex="-1" data-widget="panel" id="phone-panel"><div class="panel-body"><div class="main-info">Please complete contact info:</div><div class="clearfix input-area"><input class="countrycode" tabindex="4" type="text" /><input class="phonenumber" tabindex="5" type="text" /></div><div class="tips-area"><div class="ta-countrycode"></div><div class="ta-phonenumber">Area code and local number</div></div><ol class="clearfix complete-list"></ol><div class="name-area"><input class="name" type="text" tabindex="2" placeholder="Enter contact name" /><img class="identity-avatar"/><div class="identity-name"></div><button class="xbtn-blue add" tabindex="3" disabled="disabled">Add</button></div></div></div>',parentNode:null,srcNode:null},init:function(){var e,n=this;this.render(),e=this.element;for(var r=0;o.length>r;r++)o[r].regular=RegExp(o[r].regular),o[r].format_reg=o[r].format_reg?RegExp(o[r].format_reg):"","US"===o[r].short_name&&(a=r);this.listen(),t(document.body).on("click.phonepanel",function(e){var r=t("#phone-panel");return r.length&&r[0]!==e.target&&!t.contains(r[0],e.target)?(t(document.body).off("click.phonepanel"),n.hide(),void 0):void 0})},listen:function(){var e=this,n=this.element;n.on("keyup.phonepanel",".countrycode",function(e){var r=function(e){return'<li country-code="'+e+'">'+'<div class="li-countrycode">+'+o[e].country_code+"</div>"+'<div class="li-countryname">'+o[e].country_name+"</div>"+'<div class="li-tips">'+o[e].support.join(" and ")+" supported</div>"+"</li>"};switch(e.keyCode){case 38:case 40:return;case 13:var a=t(".complete-list li.selected"),i=~~a.attr("country-code");return c(i),n.find(".tips-area").show(),n.find(".complete-list").slideUp(),void 0}var s="",l=-1,u=t(this).val().toLowerCase();if(u)if(/^\+[0-9]*/.test(u))for(var d=0;o.length>d;d++)"+"+o[d].country_code===u?(s=r(d)+s,l=d):-1!==("+"+o[d].search_index).indexOf(u)&&(s+=r(d),l=-1===l?d:l);else for(d=0;o.length>d;d++)o[d].country_code===u?(s=r(d)+s,l=d):-1!==o[d].search_index.indexOf(u)&&(s+=r(d),l=-1===l?d:l);n.find(".complete-list").html(s),s?(n.find(".tips-area").hide(),n.find(".complete-list").slideDown(),n.find(".complete-list li").eq(0).toggleClass("selected",!0),c(l,!0)):(n.find(".tips-area").show(),n.find(".complete-list").slideUp())}),n.on("keydown.phonepanel",".countrycode",function(e){if(n.find(".complete-list").html()){var t=n.find(".complete-list li.selected"),r=n.find(".complete-list"),a=~~t.index(),i=44,s=3*i,o=n.find(".complete-list li").length-1,l=r.scrollTop();switch(e.keyCode){case 38:event.preventDefault(),0>--a&&(a=o);break;case 40:event.preventDefault(),++a>o&&(a=0)}t.toggleClass("selected",!1),n.find(".complete-list li").eq(a).toggleClass("selected",!0);var c=a*i,u=c-l;0>u?r.scrollTop(c):u+i>s&&r.scrollTop(c+i-s+1)}}),n.on("blur.phonepanel",".countrycode",function(){c(a)}),n.on("focus.phonepanel",".countrycode",function(){t(this).css("z-index","1"),n.find(".phonenumber").css("z-index","0")}),n.on("focus.phonepanel",".phonenumber",function(){n.find(".phonenumber").val(r),n.find(".complete-list").html(""),n.find(".tips-area").show(),n.find(".complete-list").slideUp(),t(this).prop("tabindex","1"),t(this).css("z-index","1"),n.find(".countrycode").css("z-index","0")}),n.on("blur.phonepanel",".phonenumber",function(){var e=n.find(".phonenumber").val().replace(/\-|\(|\)|\ /g,"");r=/^[0-9]*$/.test(e)?e:"",u(),d(),t(this).prop("tabindex","5")}),n.on("mouseover.phonepanel",".complete-list li",function(){t(this).siblings().filter(".selected").toggleClass("selected",!1),t(this).toggleClass("selected",!0)}),n.on("click.phonepanel",".complete-list li",function(){var e=t(this),r=~~e.attr("country-code");c(r),n.find(".tips-area").show(),n.find(".complete-list").slideUp()}),n.on("keyup.phonepanel",".name",function(){n.find(".complete-list").html(""),n.find(".tips-area").show(),n.find(".complete-list").slideUp()}),n.on("keydown.phonepanel",".name",function(i){if(t(this).val()&&13===i.keyCode){var l="+"+o[a].country_code+r,c=n.find(".name").val();e.add({provider:"phone",external_id:l,external_username:l,name:c,avatar_filename:s?s:ExfeeWidget.api_url+"/avatar/default?name="+c}),e.hide()}d()}),n.on("click.phonepanel",".add",function(){var t="+"+o[a].country_code+r,i=n.find(".name").val();e.add({provider:"phone",external_id:t,external_username:t,name:i,avatar_filename:s?s:ExfeeWidget.api_url+"/avatar/default?name="+i}),e.hide()})},save:function(){this.$(".place-submit").trigger("click.mappanel")},showAfter:function(){var e=this,n=e.srcNode;if(i="",n){var s=n.offset(),l=e.element,u=n.outerHeight();l.css({left:this.oleft=s.left,top:this.otop=s.top+u}),t("#phone-panel .identity-avatar").hide(),t("#phone-panel .identity-name").hide(),r=n.val().replace(/\-|\(|\)|\ /g,"");var d=a;if(/^\+.*$/.test(r))for(var h=0;o.length>h;h++)if(o[h].regular.test(r)){r=r.replace(o[h].regular,""),d=h;break}c(d),l.find(".name").focus()}},destory:function(){this.element.off(),this.element.remove(),this._destory()}});return f});