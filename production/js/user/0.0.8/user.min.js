define("user",function(e){"use strict";function l(e,i,s,o){r.request("crosslist",{params:{token:e},resources:{user_id:i}},s||function(e){var r=e.crosses,s=r.length;if(0===s)return;var o=5,a;n.map(r,function(e){if(e.exfee&&e.exfee.invitations&&e.exfee.invitations.length){var t=n.filter(e.exfee.invitations,function(e){if("ACCEPTED"===e.rsvp_status&&i===e.identity.connected_user_id)return!0});t.length&&(!a&&(a=[]),a.push(e))}});if(!a)return;a=a.slice(0,o);if(0===a.length)return;var f=+(new Date),l=f+2592e5,c=f+108e5,h=f+864e5;a=n.filter(a,function(e){var t=e.time.begin_at,n=(new Date(t.date.replace(/\-/g,"/")+" "+t.time)).getTime();if(f<=n&&n<=l)return!0});if(0===a.length)return;a.reverse(),u.registerHelper("upcoming",function(){var e="<li>",t=this.time.begin_at,n=(new Date(t.date.replace(/\-/g,"/")+" "+t.time)).getTime();return f<=n&&n<c?e='<li class="tag"><i class="icon10-now"></i>':c<=n&&n<h&&(e='<li class="tag"><i class="icon10-24hr"></i>'),e+='<a data-link data-id="'+this.id+'" href="/#!'+this.id+'">'+u.Utils.escapeExpression(this.title)+"</a></li>",new u.SafeString(e)});var p='<div>Upcoming:</div><ul class="unstyled crosses">{{#each this}}{{upcoming}}{{/each}}</ul>',d=u.compile(p)(a);t("#app-user-menu .user-panel .body").append(d)},o||function(){})}function h(e){var n=t("#app-user-menu"),r=t("#app-user-name"),i=r.find("span"),o=n.find(".dropdown-wrapper"),a=o.find(".user-panel"),f,l="/#"+s.printExtUserName(e.identities[0]);t("#app-browsing-identity").remove(),r.attr("href",l),i.text(e.name||e.nickname).removeClass("browsing-identity"),f=u.compile(c.normal),a.size()&&a.remove(),e.profileLink=l,e.verifying=1===e.identities.length&&"VERIFYING"===e.identities[0].status,o.append(f(e)),delete e.profileLink,delete e.verifying}function p(e){var n=t("#app-user-menu"),r=t("#app-user-name"),i=r.find("span"),s=n.find(".dropdown-wrapper"),o=s.find(".user-panel"),a=e.browsing,f;e.browsing.isBrowsing=!0,t("#app-browsing-identity").remove(),t("#app-tmp").append(t('<div id="app-browsing-identity">').data("settings",e).attr("data-widget","dialog").attr("data-dialog-type","browsing_identity").attr("data-token-type",e.tokenType).attr("data-token",e.originToken).attr("data-page",e.page).attr("data-action",e.action).attr("data-read-only",e.readOnly)),r.attr("href",location.href),i.html("Browsing as: <em>"+(a.name||a.nickname)+"</em>").addClass("browsing-identity"),f=u.compile(c.browsing_identity),o.size()&&o.remove(),s.append(f(e)),t("#app-user-menu").find(".set-up").data("source",{browsing_user:a,identity:a.identities[0],originToken:e.originToken,tokenType:e.tokenType,user_name:e.user_name,forward:e.forward,page:e.page})}function d(e,n){e=!!e;var r=t(document.body),i=t("#app-menubar"),s=t("#app-main");n||s.empty(),r.toggleClass("hbg",e),i.toggleClass("hide",e)}function v(e){e=!!e;var n=t("#app-user-menu"),r=t("#app-signin");n.toggleClass("hide",!e),r.toggleClass("hide",e)}function m(e){var t=o.get("identities")||[],r=t.slice(0);0===e.length?t=e:n.each(e,function(e){var i=n.find(r,function(t){if(t.id===e.id)return!0});i||t.push(e)}),o.set("identities",t)}var t=e("jquery"),n=e("rex"),r=e("api"),i=e("bus"),s=e("util"),o=e("store"),u=e("handlebars"),a=function(e,r,u,a){f(e,r,function(f){var l=o.get("last_external_username"),c,h=f.user;l&&(c=n.find(h.identities,function(e){var t=s.printExtUserName(e);if(l===t)return!0})),c||(c=h.identities[0],o.set("last_external_username",s.printExtUserName(c))),o.set("authorization",{token:e,user_id:r}),o.set("user",h),o.set("lastIdentity",c),m(h.identities),a=!t(".modal-su").size();if(a){var p=t("#forbidden"),d=t("#invite");if(p.size()||d.size()){window.location.reload();return}var v=t("#app-browsing-identity");if(v.size()&&v.attr("data-page")==="profile"){v.remove(),window.location.href="/";return}var g=decodeURIComponent(window.location.hash);if(u||(""===g||/^#?(invalid)?/.test(g))&&!/^#gather/.test(g)&&!/^#!/.test(g)){setTimeout(function(){window.location.hash=s.printExtUserName(h.identities[0])},44.5);return}}i.emit("app:page:usermenu",!0),i.emit("app:usermenu:updatenormal",h),i.emit("app:usermenu:crosslist",e,r),i.emit("app:user:signin:after",h)})};i.on("app:user:signin",a);var f=function(e,t,n,i){r.request("getUser",{params:{token:e},resources:{user_id:t}},n||function(){},i||function(){})};i.on("app:api:getuser",f),i.on("app:usermenu:updatenormal",h),i.on("app:usermenu:updatebrowsing",p);var c={normal:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="{{profileLink}}" data-link><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="{{profileLink}}" data-link><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x">路X路</em> attended</span></a></div></div><div class="body">{{#unless password}}<div class="merge set-up" data-widget="dialog" data-dialog-type="setpassword"><a href="#">Set Up</a> your <span class="x-sign">EXFE</span> password</div>{{/unless}}{{#if verifying}}<div class="merge verify" data-dialog-type="verification_{{identities.[0].provider}}" data-widget="dialog" data-identity-id="{{identities.[0].id}}"><strong>Verify</strong> your identity</div>{{/if}}<div class="list"></div></div><div class="footer"><a href="/#gather" class="xbtn xbtn-gather" id="js-gatherax" data-link>Gather a <span class="x">路X路</span></a><div class="spliterline"></div><div class="actions"><a href="#" class="pull-right" id="app-signout">Sign out</a></div></div></div>',browsing_identity:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body">{{#with browsing}}<div>You are browsing this page as {{capitalize identities.[0].provider}} identity:</div><div class="identity"><span class="pull-right avatar alt40"><img src="{{identities.[0].avatar_filename}}" width="20" height="20" alt="" /></span><i class="icon16-identity-{{identities.[0].provider}}"></i><span class="oblique">{{identities.[0].external_username}}</span></div>{{#if ../setup}}<div class="merge set-up" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_{{identities.[0].provider}}"><a href="#">Set Up</a> new <span class="x-sign">EXFE</span> account with the browsing identity.</div>{{/if}}{{/with}}{{#unless setup}}<div class="orspliter hide">or</div><div class="merge" data-user-action="signin" data-source="{{browsing.identities.[0].external_username}}" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00"><a href="#">Sign In</a> with browsing identity<br />{{#if normal}}(sign out from current account){{/if}}</div>{{/unless}}</div><div class="footer"></div></div>'};u.registerHelper("ifConnected",function(e,t){return u.helpers["if"].call(this,"CONNECTED"===e,t)}),i.on("app:page:home",d),i.on("app:page:usermenu",v),i.on("app:page:changeusername",function(e){t("#app-user-name").find("span").text(e)})});