define("user",function(e){"use strict";function t(e){var t,i=s("#app-user-menu"),n=s("#app-user-name"),r=n.find("span"),a=i.find(".dropdown-wrapper"),o=a.find(".user-panel"),l="/#"+d.printExtUserName(e.identities[0]);s("#app-browsing-identity").remove(),n.attr("href",l),r.text(e.name||e.nickname).removeClass("browsing-identity"),t=h.compile(m.normal),o.length&&o.remove(),e.profileLink=l,e.verifying=1===e.identities.length&&"VERIFYING"===e.identities[0].status,a.append(t(e)),delete e.profileLink,delete e.verifying}function i(e){var t,i=s("#app-user-menu"),n=s("#app-user-name"),r=n.find("span"),a=i.find(".dropdown-wrapper"),o=a.find(".user-panel"),l=e.browsing;e.browsing.isBrowsing=!0,s("#app-browsing-identity").remove(),s("#app-tmp").append(s('<div id="app-browsing-identity">').data("settings",e).attr("data-widget","dialog").attr("data-dialog-type","browsing_identity").attr("data-token-type",e.tokenType).attr("data-token",e.originToken).attr("data-page",e.page).attr("data-action",e.action).attr("data-read-only",e.readOnly)),n.attr("href",location.href),r.html("Browsing as: <em>"+(l.name||l.nickname)+"</em>").addClass("browsing-identity"),t=h.compile(m.browsing_identity),o.length&&o.remove(),a.append(t(e)),s("#app-user-menu").find(".set-up").data("source",{browsing_user:l,identity:l.identities[0],originToken:e.originToken,tokenType:e.tokenType,user_name:e.user_name,forward:e.forward,page:e.page})}function n(e,t){e=!!e;var i=s(document.body),n=s("#app-menubar"),r=s("#app-main");t||r.empty(),i.toggleClass("hbg",e),n.toggleClass("hide",e)}function r(e){e=!!e;var t=s("#app-user-menu"),i=s("#app-signin");t.toggleClass("hide",!e),i.toggleClass("hide",e)}function a(e){var t=u.get("identities")||[],i=t.slice(0);0===e.length?t=e:o.each(e,function(e,n){var r=o.find(i,function(i){return i.external_username===e.external_username?(t[n]=i,!0):void 0});r||t.push(e)}),u.set("identities",t)}var s=e("jquery"),o=e("rex"),l=e("api"),c=e("bus"),d=e("util"),u=e("store"),h=e("handlebars"),p=function(e,t,i,n){f(e,t,function(r){var l,h=u.get("last_external_username"),p=r.user;if(h&&(l=o.find(p.identities,function(e){var t=d.printExtUserName(e);return h===t?!0:void 0})),l||(l=p.identities[0],u.set("last_external_username",d.printExtUserName(l))),u.set("authorization",{token:e,user_id:t}),u.set("user",p),u.set("lastIdentity",l),a(p.identities),n=!s(".modal-su").size()){var f=s("#forbidden"),m=s("#invite");if(f.size()||m.size())return window.location.reload(),void 0;var g=s("#app-browsing-identity");if(g.size()&&"profile"===g.attr("data-page"))return g.remove(),window.location.href="/",void 0;var v=decodeURIComponent(window.location.hash);if(i||(""===v||/^#?(invalid)?/.test(v))&&!/^#gather/.test(v)&&!/^#!/.test(v))return setTimeout(function(){window.location.hash=d.printExtUserName(p.identities[0])},44.5),void 0}c.emit("app:page:usermenu",!0),c.emit("app:usermenu:updatenormal",p),c.emit("app:usermenu:crosslist",e,t),c.emit("app:user:signin:after",p)})};c.on("app:user:signin",p);var f=function(e,t,i,n){l.request("getUser",{params:{token:e},resources:{user_id:t}},i||function(){},n||function(){})};c.on("app:api:getuser",f),c.on("app:usermenu:updatenormal",t),c.on("app:usermenu:updatebrowsing",i);var m={normal:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="{{profileLink}}" data-link><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="{{profileLink}}" data-link><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x">路X路</em> attended</span></a></div></div><div class="body">{{#unless password}}<div class="merge set-up" data-widget="dialog" data-dialog-type="setpassword"><a href="#">Set Up</a> your <span class="x-sign">EXFE</span> password</div>{{/unless}}{{#if verifying}}<div class="merge verify" data-dialog-type="verification_{{identities.[0].provider}}" data-widget="dialog" data-identity-id="{{identities.[0].id}}"><strong>Verify</strong> your identity</div>{{/if}}<div class="list"></div></div><div class="footer"><a href="/#gather" class="xbtn xbtn-gather" id="js-gatherax" data-link>Gather a <span class="x">路X路</span></a><div class="spliterline"></div><div class="actions"><a href="#" class="pull-right" id="app-signout">Sign out</a></div></div></div>',browsing_identity:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body">{{#with browsing}}<div>You are browsing this page as {{capitalize identities.[0].provider}} identity:</div><div class="identity"><span class="pull-right avatar alt40"><img src="{{identities.[0].avatar_filename}}" width="20" height="20" alt="" /></span><i class="icon16-identity-{{identities.[0].provider}}"></i><span class="oblique">{{identities.[0].external_username}}</span></div>{{#if ../setup}}<div class="merge set-up" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_{{identities.[0].provider}}"><a href="#">Set Up</a> new <span class="x-sign">EXFE</span> account with the browsing identity.</div>{{/if}}{{/with}}{{#unless setup}}<div class="orspliter hide">or</div><div class="merge" data-user-action="signin" data-source="{{browsing.identities.[0].external_username}}" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00"><a href="#">Sign In</a> with browsing identity<br />{{#if normal}}(sign out from current account){{/if}}</div>{{/unless}}</div><div class="footer"></div></div>'};h.registerHelper("ifConnected",function(e,t){return h.helpers["if"].call(this,"CONNECTED"===e,t)}),c.on("app:page:home",n),c.on("app:page:usermenu",r),c.on("app:page:changeusername",function(e){s("#app-user-name").find("span").text(e)})});