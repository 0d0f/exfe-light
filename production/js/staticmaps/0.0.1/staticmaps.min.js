define("staticmaps",function(){"use strict";function t(){}function e(e,n){this.map=e,this.myUserId=n,this.width=$(window).width(),this.height=$(window).height(),this.bounds=new t,this._cache=[],this.latOffset=0,this.lngOffset=0,this.lines={},this.canvas=$("#static-map-canvas"),this.canvas.width=2*this.width,this.canvas.height=2*this.height,this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.ctx=this.canvas.getContext("2d")}var n;return n=t.prototype,n.extend=function(t){this._southWest||this._northEast?(this._southWest[0]=Math.min(t[0],this._southWest[0]),this._southWest[1]=Math.min(t[1],this._southWest[1]),this._northEast[0]=Math.max(t[0],this._northEast[0]),this._northEast[1]=Math.max(t[1],this._northEast[1])):(this._southWest=t.slice(0),this._northEast=t.slice(0)),this.minLat=Math.min(t[0],this._southWest[0]),this.minLng=Math.min(t[1],this._southWest[1]),this.maxLat=Math.max(t[0],this._northEast[0]),this.maxLng=Math.max(t[1],this._northEast[1])},n.getCenter=function(){return[(this._southWest[0]+this._northEast[0])/2,(this._southWest[1]+this._northEast[1])/2]},n.getNorthEast=function(){return this._northEast},n.getSouthWest=function(){return this._southWest},n.getNorthWest=function(){return[this._northEast[0],this._southWest[1]]},n.getSouthEast=function(){return[this._southWest[0],this._northEast[1]]},n.contains=function(t){var e=this._southWest,n=this._northEast,i=t,r=t;return i[0]>=e[0]&&r[0]<=n[1]&&i[1]>=e[1]&&r[1]<=n[0]},n=e.prototype,n.initEnd=!1,n.setOffset=function(t){this.latOffset=1*t.earth_to_mars_latitude,this.lngOffset=1*t.earth_to_mars_longitude},n.load=function(){this.zoom=this.getBoundsZoomLevel()-1,this.center=this.bounds.getCenter();var t=this,e=this.center,n="zoom="+this.zoom,i=document.createElement("img"),r="size="+this.width+"x"+this.height,s="center="+e[0]+","+e[1],o="http://ditu.google.com/maps/api/staticmap?key="+window._ENV_.MAP_KEY+"&language=zh_CN&sensor=false&format=jpg&"+r+"&"+s+"&"+n;i.src=o,i.width=this.width,i.height=this.height,i.onload=i.onerror=function(){Debugger.alert("loaded"),t.update()},this.map.append(i),this.map.removeClass()},n.hide=function(){this.map.addClass("hide")},n.update=function(){for(var t,e,n=this._cache,i=0,r=n.length;r>i;++i)t=n[i],e=t.type,"route"===e?this.addDot(t):"location"===e&&this.addPlace(t)},n.addDot=function(t){var e="grey",n=t.id.split(".")[1],i=t.positions[0];60>Math.floor(Date.now()/1e3-i.t)&&(e="red");var r=document.createElement("div");r.className="dot "+e+"-dot";var s=i.gps.slice(0,2),o=this.latlngToLayerPoint(s);r.style.left=o[0]-9+"px",r.style.top=o[1]-9+"px",r.setAttribute("data-uid",n),r.setAttribute("data-lat",s[0]),r.setAttribute("data-lng",s[1]),this.map.append(r)},n.addPlace=function(t){var e,n,i=t.id.split(".")[1],r=t.tags;if(i!==this.myUserId){for(;e=r.shift();)"xplace"===e?n="x-place":"destination"===e&&(n="d-place");var s=document.createElement("div"),o=[t.lat,t.lng],a=this.latlngToLayerPoint(o);n?s.className="place "+n:s.style.backgroundImage="url("+(t.icon||"/static/img/map_mark_diamond_blue@2x.png")+")",s.style.left=a[0]-12+"px",s.style.top=a[1]-34+"px",this.map.append(s)}},n.contains=function(){var t=this.bounds,e=this.map.$(".dot"),n=document.getElementById("identities")._ids||{};e.each(function(){var e=$(this),i=e.attr("data-uid"),r=1*e.attr("data-lat"),s=1*e.attr("data-lng");this.containsOne(i,[r,s],t,n)})},n.containsOne=function(t,e,n,i,r){if(n||(n=this.bounds),i||(i=document.getElementById("identities")._ids||{}),n.contains(e)&&(r=i[t])){var s=this.latlngToLayerPoint(e),o=this.lines[t];o||(o=[]),o[0]=[r[1],r[2]],o[1]=[r[1]+13,r[2]],o[2]=[s[0],s[1]],this.updateLine(t,o)}else this.removeLine(t)},n.clearLines=function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},n.removeLine=function(t){delete this.lines[t],this.updateLines()},n.updateLines=function(){this.clearLines();var t=this.lines;for(var e in t)this.addLine(e,t[e])},n.updateLine=function(t,e){this.lines[t]=e,this.updateLines()},n.addLine=function(t,e){var n=this.ctx;n.beginPath(),n.lineWidth=2,n.lineJoin=n.lineCap="round",n.moveTo(2*e[0][0],2*e[0][1]),n.lineTo(2*e[1][0],2*e[1][1]),n.lineTo(2*e[2][0],2*e[2][1]),n.strokeStyle=e[3]||"#b2b2b2",n.stroke()},n.draw=function(t){var e=t.type,n=t.action;this.initEnd||("command"===e&&"init_end"===n?(this.initEnd=!0,this.setBounds(),this.load()):("route"===e||"location"===e)&&this._cache.push(t))},n.setBounds=function(){for(var t,e,n=this.bounds,i=this._cache,r=0,s=i.length;s>r;++r)t=i[r],e=null,"route"===t.type?e=t.positions[0].gps.slice(0,2):"location"===t.type&&(e=[t.lat,t.lng]),e&&n.extend(e)},n.getBoundsZoomLevel=function(){function t(t){var e=Math.sin(t*Math.PI/180),n=Math.log((1+e)/(1-e))/2;return Math.max(Math.min(n,Math.PI),-Math.PI)/2}function e(t,e,n){return Math.floor(Math.log(t/e/n)/Math.LN2)}var n={height:256,width:256},i=21,r=this.bounds.getNorthEast(),s=this.bounds.getSouthWest(),o=(t(r[0])-t(s[0]))/Math.PI,a=r[1]-s[1],u=(0>a?a+360:a)/360,c=e(this.height,n.height,o),h=e(this.width,n.width,u);return Math.min(c,h,i)},n.project=function(t){var e=Math.PI/180,n=85.0511287798,i=Math.max(Math.min(n,t[0]),-n),r=t[1]*e,s=i*e;return s=Math.log(Math.tan(Math.PI/4+s/2)),[r,s]},n.scale=function(t){return 256*Math.pow(2,t)},n.latLngToPoint=function(t,e){var n=this.project(t),i=this.scale(e);return this.transform(n,i)},n.leftTopPoint=function(t){var e=this.latLngToPoint(t,this.zoom);return e[0]-=this.width/2,e[1]-=this.height/2,e},n.latlngToLayerPoint=function(t){var e=this.latLngToPoint(t,this.zoom),n=this.leftTopPoint(this.bounds.getCenter());return e[0]-=n[0],e[1]-=n[1],e},n.pointToLatLng=function(){},n._a=.5/Math.PI,n._b=.5,n._c=-.5/Math.PI,n._d=.5,n.transform=function(t,e){return e=e||1,t[0]=e*(this._a*t[0]+this._b),t[1]=e*(this._c*t[1]+this._d),t},n.updateGeoLocation=function(t,e){this.myUserId=t;var n=this.map.find("#gps-marker");0===n.length&&(n=$('<div id="gps-marker"><div id="gps-circle" style="display:none;"></div><div id="gps-dsnt" style="display:none;"></div><div id="gps-arrow"></div></div>'),this.map.append(n)),e=this.toMars(e);var i=this.latlngToLayerPoint(e.gps.slice(0,2));n.css({left:i[0]-11,top:i[1]-11});var r=60>Math.floor(Date.now()/1e3-e.t);n.find("#gps-arrow").attr("class",r?"online":"")},n.toMars=function(t,e){var n=t.gps,i={t:e?Math.floor(Date.now()/1e3):t.t,gps:[1*n[0]+this.latOffset,1*n[1]+this.lngOffset,n[2]]};return i},e});