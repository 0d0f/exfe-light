define("staticmaps",function(){"use strict";function t(){}function e(e,n,i){this.map=e,this.myUserId=n,this.MODE=i||"free",this.bounds=new t,this.width=$(window).width(),this.height=$(window).height(),this._cache=[],this.latOffset=0,this.lngOffset=0,this.topOffset=0,this.leftOffset=0,this.lines={},this.canvas=document.getElementById("static-map-canvas"),this.canvas.width=2*this.width,this.canvas.height=2*this.height,this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.ctx=this.canvas.getContext("2d"),this.readyStatus=!1,this.setImg()}var n,i=window._ENV_.apiv3_url,r=i+"/icons/mapmark";return n=t.prototype,n.extend=function(t){this._southWest||this._northEast?(this._southWest[0]=Math.min(t[0],this._southWest[0]),this._southWest[1]=Math.min(t[1],this._southWest[1]),this._northEast[0]=Math.max(t[0],this._northEast[0]),this._northEast[1]=Math.max(t[1],this._northEast[1])):(this._southWest=t.slice(0),this._northEast=t.slice(0)),this.minLat=Math.min(t[0],this._southWest[0]),this.minLng=Math.min(t[1],this._southWest[1]),this.maxLat=Math.max(t[0],this._northEast[0]),this.maxLng=Math.max(t[1],this._northEast[1])},n.getCenter=function(){return[(this._southWest[0]+this._northEast[0])/2,(this._southWest[1]+this._northEast[1])/2]},n.getNorthEast=function(){return this._northEast},n.getSouthWest=function(){return this._southWest},n.getNorthWest=function(){return[this._northEast[0],this._southWest[1]]},n.getSouthEast=function(){return[this._southWest[0],this._northEast[1]]},n.contains=function(t){var e=this._southWest,n=this._northEast,i=t,r=t;return i[0]>=e[0]&&r[0]<=n[0]&&i[1]>=e[1]&&r[1]<=n[1]},n=e.prototype,n.initEnd=!1,n.setImg=function(){if(this.imgWidth=this.width,this.imgHeight=this.height,"free"===this.MODE){var t=this.width/640,e=this.height/640;t>1&&t>e?(this.imgWidth=640,this.imgHeight=this.height):t>1&&e>t?this.imgWidth=this.imgHeight=640:e>1&&e>t&&(this.imgHeight=640,this.imgWidth=this.width),this.leftOffset=(this.width-this.imgWidth)/2,this.topOffset=(this.height-this.imgHeight)/2}},n.setOffset=function(t){this.latOffset=1*t.earth_to_mars_latitude,this.lngOffset=1*t.earth_to_mars_longitude},n.load=function(){var t=this,e=this.center,n="zoom="+this.zoom,i=document.createElement("img"),r="size="+this.imgWidth+"x"+this.imgHeight,s="center="+e[0]+","+e[1],a="http://ditu.google.com/maps/api/staticmap?key="+window._ENV_.MAP_KEY+"&language=zh_CN&sensor=false&format=jpg&"+r+"&"+s+"&"+n;i.className="static-map-img",i.src=a,i.width=this.imgWidth,i.height=this.imgHeight,i.style.top=this.topOffset+"px",i.style.left=this.leftOffset+"px",this.img=i,i.onload=function(){t.map.append(i),t.abortImage()},i.onerror=function(){t.map.find("#failed").removeClass("hide"),t.canvas.className="hide",t.abortImage()}},n.abortImage=function(){var t=this.img;t&&(t.onload=t.onerror=t=this.img=null)},n.hide=function(){this.map.remove(),$(this.canvas).remove(),delete this.map,delete this.canvas},n.show=function(){this.map.removeClass("hide"),this.canvas.className=""},n.update=function(){for(var t,e,n=this._cache,i=0,r=n.length;r>i;++i)t=n[i],e=t.type,"route"===e?this.addDot(t):"location"===e&&this.addPlace(t)},n.addDot=function(t){var e=t.id.split(".")[1];if(e!=this.myUserId){var n="grey",i=t.positions[0];60>Math.floor(Date.now()/1e3-i.t)&&(n="red");var r=document.createElement("div");r.className="dot "+n+"-dot";var s=i.gps.slice(0,2),a=this.getOffsetPoint(s);r.style.left=a[0]-9+"px",r.style.top=a[1]-9+"px",r.setAttribute("data-uid",e),r.setAttribute("data-lat",s[0]),r.setAttribute("data-lng",s[1]),r.setAttribute("data-color","grey"===n?"#b2b2b2":"#ff7e98"),this.map.append(r)}},n.addPlace=function(t){var e,n,i=t.id.split(".")[1],s=t.tags;if(i!==this.myUserId){var a=0,o=0;if(s)for(;e=s.shift();)"xplace"===e?a^=1:"destination"===e&&(a^=2);var u=document.createElement("div"),c=[t.lat,t.lng],h=this.getOffsetPoint(c);if(u.style.left=h[0]-12+"px",u.style.top=h[1]-34+"px",this.map.append(u),(1===a||3===a)&&(n="x-place",o=1),2===a||3===a){n="d-place",o=2;var l=this.destPlace;l&&(l.style.backgroundImage="url("+r+")",l.style.zIndex=0,this.destPlace=u),3!==a&&(u.style.zIndex=2)}n?u.className="place "+n:(u.className="place",u.style.backgroundImage="url("+(t.icon||r)+")")}},n.contains=function(){var t=this,e=this.bounds,n=this.map.find(".dot"),i=document.getElementById("identities")._ids||{};n.each(function(){var n=$(this),r=n.attr("data-uid"),s=1*n.attr("data-lat"),a=1*n.attr("data-lng"),o=n.attr("data-color");t.containsOne(r,[s,a],e,i,o)})},n.containsOne=function(t,e,n,i,r,s){if(n||(n=this.bounds),i||(i=document.getElementById("identities")._ids||{}),n.contains(e)&&(s=i[t])){var a=this.getOffsetPoint(e),o=this.lines[t];o||(o=[]),o[0]=[s[1],s[2]],o[1]=[s[1]+13,s[2]],o[2]=[a[0],a[1]],o[3]=r,this.updateLine(t,o)}else this.removeLine(t)},n.clearLines=function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},n.removeLine=function(t){delete this.lines[t],this.updateLines()},n.updateLines=function(){this.clearLines();var t=this.lines;for(var e in t)this.addLine(e,t[e])},n.updateLine=function(t,e){this.lines[t]=e,this.updateLines()},n.addLine=function(t,e){var n=this.ctx;n.beginPath(),n.lineWidth=2,n.lineJoin=n.lineCap="round",n.moveTo(2*e[0][0],2*e[0][1]),n.lineTo(2*e[1][0],2*e[1][1]),n.lineTo(2*e[2][0],2*e[2][1]),n.strokeStyle=e[3]||"#b2b2b2",n.stroke()},n.draw=function(t){if(!this.initEnd){var e=t.type,n=t.action;"command"===e&&"init_end"===n?(this.initEnd=!0,this.setBounds(),this.update(),this.updateGeoLocation(this.myUserId,this.position),this.canvas.className="",this.contains(),this.load()):("route"===e||"location"===e)&&this._cache.push(t)}},n.drawBatch=function(t){this._cache=t,this.draw({type:"command",action:"init_end"})},n.setBounds=function(){for(var t,e,n=this.bounds,i=this._cache,r=0,s=i.length;s>r;++r)t=i[r],e=null,"route"===t.type?e=t.positions[0].gps.slice(0,2):"location"===t.type&&(e=[t.lat,t.lng]),e&&n.extend(e);this.zoom=this.getBoundsZoomLevel()-1,this.center=this.bounds.getCenter()},n.getBoundsZoomLevel=function(){function t(t){var e=Math.sin(t*Math.PI/180),n=Math.log((1+e)/(1-e))/2;return Math.max(Math.min(n,Math.PI),-Math.PI)/2}function e(t,e,n){return Math.floor(Math.log(t/e/n)/Math.LN2)}var n={height:256,width:256},i=21,r=this.bounds.getNorthEast(),s=this.bounds.getSouthWest(),a=(t(r[0])-t(s[0]))/Math.PI,o=r[1]-s[1],u=(0>o?o+360:o)/360,c=e(this.imgHeight,n.height,a),h=e(this.imgWidth,n.width,u);return Math.min(c,h,i)},n.project=function(t){var e=Math.PI/180,n=85.0511287798,i=Math.max(Math.min(n,t[0]),-n),r=t[1]*e,s=i*e;return s=Math.log(Math.tan(Math.PI/4+s/2)),[r,s]},n.scale=function(t){return 256*Math.pow(2,t)},n.latLngToPoint=function(t,e){var n=this.project(t),i=this.scale(e);return this.transform(n,i)},n.leftTopPoint=function(t){var e=this.latLngToPoint(t,this.zoom);return e[0]-=this.imgWidth/2,e[1]-=this.imgHeight/2,e},n.latlngToLayerPoint=function(t){var e=this.latLngToPoint(t,this.zoom),n=this.leftTopPoint(this.center);return e[0]-=n[0],e[1]-=n[1],e},n.pointToLatLng=function(){},n._a=.5/Math.PI,n._b=.5,n._c=-.5/Math.PI,n._d=.5,n.transform=function(t,e){return e=e||1,t[0]=e*(this._a*t[0]+this._b),t[1]=e*(this._c*t[1]+this._d),t},n.getOffsetPoint=function(t){var e=this.latlngToLayerPoint(t);return e[0]+=this.leftOffset,e[1]+=this.topOffset,e},n.updateGeoPosition=function(t){this.position=t,this.bounds.extend(t.gps.slice(0,2))},n.updateGeoLocation=function(t,e){if(this.center&&e){this.myUserId=t;var n=this.map.find(".gps-marker");0===n.length&&(n=$('<div class="gps-marker"><div class="gps-circle" style="display:none;"></div><div class="gps-dsnt" style="display:none;"></div><div class="gps-arrow"></div></div>'),this.map.append(n)),e=this.toMars(e,!0);var i=this.getOffsetPoint(e.gps.slice(0,2));n.css({left:i[0]-11,top:i[1]-11});var r=60>Math.floor(Date.now()/1e3-e.t);n.find(".gps-arrow").attr("class",r?"gps-arrow online":"gps-arrow")}},n.toMars=function(t,e){var n=t.gps,i={t:e?Math.floor(Date.now()/1e3):t.t,gps:[1*n[0]+this.latOffset,1*n[1]+this.lngOffset,n[2]]};return i},e});