define(function(e){"use strict";function t(e){return e.stopPropagation(),e.preventDefault(),!1}function i(){a(p).removeClass("open")}function n(e){var t=a(this),i=t.data("timer"),n=t.data("clicked"),r=t.find("div.user-panel").addClass("show"),s=-r.outerHeight();return e.preventDefault(),"mouseleave"!==e.type||n?n?(t.data("clicked",!1),void 0):i?(clearTimeout(i),t.data("timer",i=null),!1):(f||(r.css("top",s),t.find(".user-panel").addClass("show"),f=!0),t.prev().removeClass("hide"),t.parent().addClass("user"),r.stop().animate({top:56},100),void 0):(i=setTimeout(function(){f=!1,r.stop().animate({top:s},200,function(){t.prev().addClass("hide"),t.parent().removeClass("user")}),clearTimeout(i),t.data("timer",i=null)},500),t.data("timer",i),!1)}var a=e("jquery"),r=e("bus"),s=e("api"),o=e("store"),l=e("dialog"),c=e("xdialog").dialogs,d=e("xdialog").Identification,u=e("xidentity"),h=a(document.body);h.on("drop",t).on("dragover",t);var p='[data-toggle="dropdown"]';h.on("click.dropdown.data-api",i);var f=!1;h.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",n),h.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(){var e=a("#app-user-menu .dropdown-wrapper"),t=e.find("div.user-panel").addClass("show"),i=-t.outerHeight();t.css("top",i),e.prev().addClass("hide").end().parent().removeClass("user"),e.data("clicked",!0)}),h.on("click.usermenu","#app-signout",function(){r.emit("xapp:cross:end"),a(".navbar .dropdown-wrapper").find(".user-panel").remove(),a("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),o.remove("cats"),o.remove("user"),o.remove("authorization"),window.location.href="/"});var m=function(e,t,i){s.request("checkinvitationtoken",{type:"POST",params:{token:e},data:{invitation_token:t}},function(e){e.valid&&i()})},g=function(e){var t=a(this),i=o.get("authorization"),n=i&&i.user_id,r=i&&i.token,s=o.get("user"),l=t.data("link"),c=(t.data("event-ignore"),a("#app-browsing-identity")),d=c.length;if(d){var u=c.data(),h=u.settings,p=h.action,f=h.code,g=h.invitation_token,v=h.tokenType,y=h.readOnly,b=h.browsing;if(1===f){if(l){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();var w=a('<div id="read-only-browsing" data-destory="true" data-widget="dialog" data-dialog-type="read_only"></div>');return w.data("settings",b),a("#app-tmp").append(w),w.trigger("click"),!1}}else if(2===f){var x=b.user_id;if("SIGNIN"===p&&n&&n!==x){if(!l&&"cross"!==v)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),m(r,g,function(){var e=a('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');e.data("settings",{browsing:b,user:s,token:r,action:p,invitation_token:g}),a("#app-tmp").append(e),e.trigger("click")}),!1}else if("SETUP"===p&&!y&&!l)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),n&&n!==x?m(r,g,function(){var e=a('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');e.data("settings",{browsing:b,user:s,token:r,action:p,invitation_token:g}),a("#app-tmp").append(e),e.trigger("click")}):a('[data-user-action="SETUP"]').trigger("click"),!1}}};h.on("click.data-link","a[data-link], div[data-link], span[data-link]",g),h.on("mousedown.data-link","button[data-link], input[data-link], textarea[data-link]",g),r.on("app:cross:edited",function(e){var t=a("#app-browsing-identity"),i=t.data("settings"),n=a("#app-read-only");e&&"no_permission"===e.error&&(n.size()||a("#app-main").append(n=a('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",i&&i.browsing||o.get("user"))),n.trigger("click"))}),h.on("click.dialog.data-api",'[data-widget="dialog"]',function(e){var t,i=a(this),n=i.data("dialog"),r=i.data("dialog-type"),s=i.data("dialog-tab"),o=i.data("dialog-from"),u=i.data("dialog-settings");e.preventDefault(),n||r&&(t=c[r],u&&(t=a.extend(!0,{},t,u)),n=new("identification"===r?d:l)(t),n.options.srcNode=i,o&&(n.dialog_from=o),n.render(),i.data("dialog",n),h.find('[data-dialog-type="'+r+'"]').not(i).data("dialog",n)),s&&n.switchTab(s),n.show(e)});var v=o.get("identities");v||(v=[]),h.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(e){var t=a(this);t.data("typeahead")||(e.preventDefault(),t.data("typeahead",new u({options:{source:v,useCache:!0,target:t,onNothing:function(){this.target.parent().removeClass("identity-avatar"),r.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(e){var t;e&&(t=e.identity)?this.target.prev().attr("src",t.avatar_filename).parent().addClass("identity-avatar"):this.target.parent().removeClass("identity-avatar"),r.emit("widget-dialog-identification-auto",e)}}})))})});