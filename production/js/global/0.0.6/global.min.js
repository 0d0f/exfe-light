define(function(e){"use strict";function t(e){return e.stopPropagation(),e.preventDefault(),!1}function i(){r(p).removeClass("open")}function n(e){var t=r(this),i=t.data("timer"),n=t.data("clicked"),s=t.find("div.user-panel").addClass("show"),a=-s.outerHeight();return e.preventDefault(),"mouseleave"!==e.type||n?n?(t.data("clicked",!1),void 0):i?(clearTimeout(i),t.data("timer",i=null),!1):(f||(s.css("top",a),t.find(".user-panel").addClass("show"),f=!0),t.prev().removeClass("hide"),t.parent().addClass("user"),s.stop().animate({top:56},100),void 0):(i=setTimeout(function(){f=!1,s.stop().animate({top:a},200,function(){t.prev().addClass("hide"),t.parent().removeClass("user")}),clearTimeout(i),t.data("timer",i=null)},500),t.data("timer",i),!1)}var r=e("jquery"),s=e("bus"),a=e("api"),o=e("store"),l=e("dialog"),c=e("xdialog").dialogs,d=e("xdialog").Identification,u=e("xidentity"),h=r(document.body);h.on("drop",t).on("dragover",t);var p='[data-toggle="dropdown"]';h.on("click.dropdown.data-api",i);var f=!1;h.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",n),h.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(){var e=r("#app-user-menu .dropdown-wrapper"),t=e.find("div.user-panel").addClass("show"),i=-t.outerHeight();t.css("top",i),e.prev().addClass("hide").end().parent().removeClass("user"),e.data("clicked",!0)}),h.on("click.usermenu","#app-signout",function(){s.emit("xapp:cross:end"),r(".navbar .dropdown-wrapper").find(".user-panel").remove(),r("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),o.remove("cats"),o.remove("user"),o.remove("authorization"),window.location.href="/"});var m=function(e,t,i){a.request("checkinvitationtoken",{type:"POST",params:{token:e},data:{invitation_token:t}},function(e){e.valid&&i()})},g=function(e){var t=r(this),i=o.get("authorization"),n=i&&i.user_id,s=i&&i.token,a=o.get("user"),l=t.data("link"),c=(t.data("event-ignore"),r("#app-browsing-identity")),d=c.length;if(d){var u=c.data(),h=u.settings,p=h.action,f=h.code,g=h.invitation_token,v=h.readOnly,y=h.browsing;if(1===f){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();var b=r('<div id="read-only-browsing" data-destory="true" data-widget="dialog" data-dialog-type="read_only">></div>');return b.data("settings",y),r("#app-tmp").append(b),b.trigger("click"),!1}if(2===f){var x=y.user_id;if("SIGNIN"===p&&n&&n!==x){if(!l)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),m(s,g,function(){var e=r('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');e.data("settings",{browsing:y,user:a,token:s,action:p,invitation_token:g}),r("#app-tmp").append(e),e.trigger("click")}),!1}else if("SETUP"===p&&!v&&!l)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),n&&n!==x?m(s,g,function(){var e=r('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');e.data("settings",{browsing:y,user:a,token:s,action:p,invitation_token:g}),r("#app-tmp").append(e),e.trigger("click")}):r('[data-user-action="SETUP"]').trigger("click"),!1}}};h.on("click.data-link","a[data-link], div[data-link], span[data-link]",g),h.on("mousedown.data-link","button[data-link], input[data-link], textarea[data-link]",g),s.on("app:cross:edited",function(e){var t=r("#app-browsing-identity"),i=t.data("settings"),n=r("#app-read-only");e&&"no_permission"===e.error&&(n.size()||r("#app-main").append(n=r('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",i&&i.browsing||o.get("user"))),n.trigger("click"))}),h.on("click.dialog.data-api",'[data-widget="dialog"]',function(e){var t,i=r(this),n=i.data("dialog"),s=i.data("dialog-type"),a=i.data("dialog-tab"),o=i.data("dialog-from"),u=i.data("dialog-settings");e.preventDefault(),n||s&&(t=c[s],u&&(t=r.extend(!0,{},t,u)),n=new("identification"===s?d:l)(t),n.options.srcNode=i,o&&(n.dialog_from=o),n.render(),i.data("dialog",n),h.find('[data-dialog-type="'+s+'"]').not(i).data("dialog",n)),a&&n.switchTab(a),n.show(e)});var v=o.get("identities");v||(v=[]),h.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(e){var t=r(this);t.data("typeahead")||(e.preventDefault(),t.data("typeahead",new u({options:{source:v,useCache:!0,target:t,onNothing:function(){this.target.parent().removeClass("identity-avatar"),s.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(e){var t;e&&(t=e.identity)?this.target.prev().attr("src",t.avatar_filename).parent().addClass("identity-avatar"):this.target.parent().removeClass("identity-avatar"),s.emit("widget-dialog-identification-auto",e)}}})))})});