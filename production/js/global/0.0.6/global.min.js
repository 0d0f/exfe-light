define(function(a){"use strict";function e(a){return a.stopPropagation(),a.preventDefault(),!1}function t(){n(g).removeClass("open")}function i(a){var e=n(this),t=e.data("timer"),i=e.data("clicked"),d=e.find("div.user-panel").addClass("show"),o=-d.outerHeight();return a.preventDefault(),"mouseleave"!==a.type||i?i?(e.data("clicked",!1),void 0):t?(clearTimeout(t),e.data("timer",t=null),!1):(c||(d.css("top",o),e.find(".user-panel").addClass("show"),c=!0),e.prev().removeClass("hide"),e.parent().addClass("user"),d.stop().animate({top:56},100),void 0):(t=setTimeout(function(){c=!1,d.stop().animate({top:o},200,function(){e.prev().addClass("hide"),e.parent().removeClass("user")}),clearTimeout(t),e.data("timer",t=null)},500),e.data("timer",t),!1)}var n=a("jquery"),d=a("bus"),o=a("store"),r=a("dialog"),s=a("xdialog").dialogs,p=a("xdialog").Identification,l=a("xidentity"),u=n(document.body);u.on("drop",e).on("dragover",e);var g='[data-toggle="dropdown"]';u.on("click.dropdown.data-api",t);var c=!1;u.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",i),u.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(){var a=n("#app-user-menu .dropdown-wrapper"),e=a.find("div.user-panel").addClass("show"),t=-e.outerHeight();e.css("top",t),a.prev().addClass("hide").end().parent().removeClass("user"),a.data("clicked",!0)}),u.on("click.usermenu","#app-signout",function(){d.emit("xapp:cross:end"),n(".navbar .dropdown-wrapper").find(".user-panel").remove(),n("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),o.remove("cats"),o.remove("user"),o.remove("authorization"),window.location.href="/"}),u.on("click.data-link dblclick.data-link","[data-link]",function(a){var e=n(this).data("link"),t=n(this).data("event-ignore");if(a.type!==t){var i=n("#app-browsing-identity"),d=i.data("readOnly"),o=i.data("settings"),r=n("#app-read-only"),s=i.data("token-type");if(i.size()&&d&&"nota"===e)return a.stopImmediatePropagation(),a.stopPropagation(),a.preventDefault(),r.size()||n("#app-main").append(r=n('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",o.browsing)),r.trigger("click"),!1;if(i.size()&&(""===e||"nota"===e&&"user"===s))return a.stopImmediatePropagation(),a.stopPropagation(),a.preventDefault(),i.trigger("click"),!1}});var v=2;d.on("app:cross:edited",function(a){if(0!==v){v--;var e=n("#app-browsing-identity"),t=e.data("settings"),i=n("#app-read-only"),d=e.data("action");a?a&&"no_permission"===a.error&&(i.size()||n("#app-main").append(i=n('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",t&&t.browsing||o.get("user"))),i.trigger("click")):"setup"===d&&n('[data-user-action="'+d+'"]').trigger("click")}}),u.on("click.dialog.data-api",'[data-widget="dialog"]',function(a){var e,t=n(this),i=t.data("dialog"),d=t.data("dialog-type"),o=t.data("dialog-tab"),l=t.data("dialog-from"),g=t.data("dialog-settings");a.preventDefault(),i||d&&(e=s[d],g&&(e=n.extend(!0,{},e,g)),i=new("identification"===d?p:r)(e),i.options.srcNode=t,l&&(i.dialog_from=l),i.render(),t.data("dialog",i),u.find('[data-dialog-type="'+d+'"]').not(t).data("dialog",i)),o&&i.switchTab(o),i.show(a)});var f=o.get("identities");f||(f=[]),u.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(a){var e=n(this);e.data("typeahead")||(a.preventDefault(),e.data("typeahead",new l({options:{source:f,useCache:!0,target:e,onNothing:function(){this.target.parent().removeClass("identity-avatar"),d.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(a){var e;a&&(e=a.identity)?this.target.prev().attr("src",e.avatar_filename).parent().addClass("identity-avatar"):this.target.parent().removeClass("identity-avatar"),d.emit("widget-dialog-identification-auto",a)}}})))})});