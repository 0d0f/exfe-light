define(function(e){"use strict";function t(e){return e.stopPropagation(),e.preventDefault(),!1}function i(){o(h).removeClass("open")}function a(e){var t=o(this),i=t.data("timer"),a=t.data("clicked"),s=t.find("div.user-panel").addClass("show"),n=-s.outerHeight();return e.preventDefault(),"mouseleave"!==e.type||a?a?(t.data("clicked",!1),void 0):i?(clearTimeout(i),t.data("timer",i=null),!1):(v||(s.css("top",n),t.find(".user-panel").addClass("show"),v=!0),t.prev().removeClass("hide"),t.parent().addClass("user"),s.stop().animate({top:56},100),void 0):(i=setTimeout(function(){v=!1,s.stop().animate({top:n},200,function(){t.prev().addClass("hide"),t.parent().removeClass("user")}),clearTimeout(i),t.data("timer",i=null)},500),t.data("timer",i),!1)}var o=e("jquery"),s=e("bus"),n=e("api"),d=e("store"),r=e("dialog"),p=e("xdialog").dialogs,l=e("xdialog").Identification,c=e("xidentity"),u=o(document.body);u.on("drop",t).on("dragover",t);var h='[data-toggle="dropdown"]';u.on("click.dropdown.data-api",i);var v=!1;u.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",a),u.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(){var e=o("#app-user-menu .dropdown-wrapper"),t=e.find("div.user-panel").addClass("show"),i=-t.outerHeight();t.css("top",i),e.prev().addClass("hide").end().parent().removeClass("user"),e.data("clicked",!0)}),u.on("click.usermenu","#app-signout",function(){s.emit("xapp:cross:end"),o(".navbar .dropdown-wrapper").find(".user-panel").remove(),o("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),d.remove("cats"),d.remove("user"),d.remove("authorization"),window.location.href="/"});var g=function(e,t,i){n.request("checkinvitationtoken",{type:"POST",params:{token:e},data:{invitation_token:t}},function(e){e.valid&&i()})},f=function(e){var t=o(this),i=d.get("authorization"),a=i&&i.user_id,s=i&&i.token,n=d.get("user"),r=t.data("link"),p=(t.data("event-ignore"),o("#app-browsing-identity")),l=p.length;if(l){var c=p.data(),u=c.settings,h=u.action,v=u.code,f=u.invitation_token,m=u.tokenType,y=u.readOnly,k=u.browsing;if(1===v){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();var w=o('<div id="read-only-browsing" data-destory="true" data-widget="dialog" data-dialog-type="read_only"></div>');return w.data("settings",k),o("#app-tmp").append(w),w.trigger("click"),!1}if(2===v){var _=k.user_id;if("SIGNIN"===h&&a&&a!==_){if(!r&&"cross"!==m)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),g(s,f,function(){var e=o('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');e.data("settings",{browsing:k,user:n,token:s,action:h,invitation_token:f}),o("#app-tmp").append(e),e.trigger("click")}),!1}else if("SETUP"===h&&!y&&!r)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),a&&a!==_?g(s,f,function(){var e=o('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');e.data("settings",{browsing:k,user:n,token:s,action:h,invitation_token:f}),o("#app-tmp").append(e),e.trigger("click")}):o('[data-user-action="SETUP"]').trigger("click"),!1}}};u.on("click.data-link","a[data-link], div[data-link], span[data-link]",f),u.on("mousedown.data-link","button[data-link], input[data-link], textarea[data-link]",f),s.on("app:cross:edited",function(e){var t=o("#app-browsing-identity"),i=t.data("settings"),a=o("#app-read-only");e&&"no_permission"===e.error&&(a.size()||o("#app-main").append(a=o('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",i&&i.browsing||d.get("user"))),a.trigger("click"))}),u.on("click.dialog.data-api",'[data-widget="dialog"]',function(e){var t,i=o(this),a=i.data("dialog"),s=i.data("dialog-type"),n=i.data("dialog-tab"),d=i.data("dialog-from"),c=i.data("dialog-settings");e.preventDefault(),a||s&&(t=p[s],c&&(t=o.extend(!0,{},t,c)),a=new("identification"===s?l:r)(t),a.options.srcNode=i,d&&(a.dialog_from=d),a.render(),i.data("dialog",a),u.find('[data-dialog-type="'+s+'"]').not(i).data("dialog",a)),n&&a.switchTab(n),a.show(e)});var m=d.get("identities");m||(m=[]),u.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(e){var t=o(this);t.data("typeahead")||(e.preventDefault(),t.data("typeahead",new c({options:{source:m,useCache:!0,target:t,onNothing:function(){this.target.parent().removeClass("identity-avatar"),s.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(e){var t;e&&(t=e.identity)?this.target.prev().attr("src",t.avatar_filename).parent().addClass("identity-avatar"):this.target.parent().removeClass("identity-avatar"),s.emit("widget-dialog-identification-auto",e)}}})))})});