define(function(a){"use strict";function t(a){return a.stopPropagation(),a.preventDefault(),!1}function e(){n(c).removeClass("open")}function i(a){var t=n(this),e=t.data("timer"),i=t.data("clicked"),o=t.find("div.user-panel").addClass("show"),d=-o.outerHeight();return a.preventDefault(),"mouseleave"!==a.type||i?i?(t.data("clicked",!1),void 0):e?(clearTimeout(e),t.data("timer",e=null),!1):(v||(o.css("top",d),t.find(".user-panel").addClass("show"),v=!0),t.prev().removeClass("hide"),t.parent().addClass("user"),o.stop().animate({top:56},100),void 0):(e=setTimeout(function(){v=!1,o.stop().animate({top:d},200,function(){t.prev().addClass("hide"),t.parent().removeClass("user")}),clearTimeout(e),t.data("timer",e=null)},500),t.data("timer",e),!1)}var n=a("jquery"),o=a("bus"),d=a("api"),r=a("store"),s=a("dialog"),p=a("xdialog").dialogs,l=a("xdialog").Identification,g=a("xidentity"),u=n(document.body);u.on("drop",t).on("dragover",t);var c='[data-toggle="dropdown"]';u.on("click.dropdown.data-api",e);var v=!1;u.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",i),u.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(){var a=n("#app-user-menu .dropdown-wrapper"),t=a.find("div.user-panel").addClass("show"),e=-t.outerHeight();t.css("top",e),a.prev().addClass("hide").end().parent().removeClass("user"),a.data("clicked",!0)}),u.on("click.usermenu","#app-signout",function(){o.emit("xapp:cross:end"),n(".navbar .dropdown-wrapper").find(".user-panel").remove(),n("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),r.remove("cats"),r.remove("user"),r.remove("authorization"),window.location.href="/"});var f=function(a,t,e){d.request("checkinvitationtoken",{type:"POST",params:{token:a},data:{invitation_token:t}},function(a){a.valid&&e()})},m=function(a){var t=n(this),e=r.get("authorization"),i=e&&e.user_id,o=e&&e.token,d=r.get("user"),s=t.data("link"),p=(t.data("event-ignore"),n("#app-browsing-identity")),l=p.length;if(l){var g=p.data(),u=g.settings,c=u.action,v=u.code,m=u.invitation_token,w=u.tokenType,y=u.readOnly,h=u.browsing;if(1===v){if(s){a.stopImmediatePropagation(),a.stopPropagation(),a.preventDefault();var k=n('<div id="read-only-browsing" data-destory="true" data-widget="dialog" data-dialog-type="read_only"></div>');return k.data("settings",h),n("#app-tmp").append(k),k.trigger("click"),!1}}else if(2===v){var C=h.user_id;if("SIGNIN"===c&&i&&i!==C){if(!s&&"cross"!==w)return a.stopImmediatePropagation(),a.stopPropagation(),a.preventDefault(),f(o,m,function(){var a=n('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');a.data("settings",{browsing:h,user:d,token:o,action:c,invitation_token:m}),n("#app-tmp").append(a),a.trigger("click")}),!1}else if("SETUP"===c&&!y&&!s)return a.stopImmediatePropagation(),a.stopPropagation(),a.preventDefault(),i&&i!==C?f(o,m,function(){var a=n('<div id="merge-identity" data-destory="true" data-widget="dialog" data-dialog-type="browsing_identity"></div>');a.data("settings",{browsing:h,user:d,token:o,action:c,invitation_token:m}),n("#app-tmp").append(a),a.trigger("click")}):n('[data-user-action="SETUP"]').trigger("click"),!1}}};u.on("click.data-link","a[data-link], div[data-link], span[data-link]",m),u.on("mousedown.data-link","button[data-link], input[data-link], textarea[data-link]",m),o.on("app:cross:edited",function(a){var t=n("#app-browsing-identity"),e=t.data("settings"),i=n("#app-read-only");a&&"no_permission"===a.error&&(i.size()||n("#app-main").append(i=n('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",e&&e.browsing||r.get("user"))),i.trigger("click"))}),u.on("click.dialog.data-api",'[data-widget="dialog"]',function(a){var t,e=n(this),i=e.data("dialog"),o=e.data("dialog-type"),d=e.data("dialog-tab"),r=e.data("dialog-from"),g=e.data("dialog-settings");a.preventDefault(),i||o&&(t=p[o],g&&(t=n.extend(!0,{},t,g)),i=new("identification"===o?l:s)(t),i.options.srcNode=e,r&&(i.dialog_from=r),i.render(),e.data("dialog",i),u.find('[data-dialog-type="'+o+'"]').not(e).data("dialog",i)),d&&i.switchTab(d),i.show(a)});var w=r.get("identities");w||(w=[]),u.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(a){var t=n(this);t.data("typeahead")||(a.preventDefault(),t.data("typeahead",new g({options:{source:w,useCache:!0,target:t,onNothing:function(){this.target.parent().removeClass("identity-avatar"),o.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(a){var t;a&&(t=a.identity)?this.target.prev().attr("src",t.avatar_filename).parent().addClass("identity-avatar"):this.target.parent().removeClass("identity-avatar"),o.emit("widget-dialog-identification-auto",a)}}})))})});