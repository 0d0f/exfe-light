define(function(e){"use strict";function t(e){return e.stopPropagation(),e.preventDefault(),!1}function i(){r(h).removeClass("open")}function n(e){var t=r(this),i=t.data("timer"),n=t.data("clicked"),s=t.find("div.user-panel").addClass("show"),a=-s.outerHeight();return e.preventDefault(),"mouseleave"!==e.type||n?n?(t.data("clicked",!1),void 0):i?(clearTimeout(i),t.data("timer",i=null),!1):(p||(s.css("top",a),t.find(".user-panel").addClass("show"),p=!0),t.prev().removeClass("hide"),t.parent().addClass("user"),s.stop().animate({top:56},100),void 0):(i=setTimeout(function(){p=!1,s.stop().animate({top:a},200,function(){t.prev().addClass("hide"),t.parent().removeClass("user")}),clearTimeout(i),t.data("timer",i=null)},500),t.data("timer",i),!1)}var r=e("jquery"),s=e("bus"),a=e("store"),o=e("dialog"),l=e("xdialog").dialogs,c=e("xdialog").Identification,d=e("xidentity"),u=r(document.body);u.on("drop",t).on("dragover",t);var h='[data-toggle="dropdown"]';u.on("click.dropdown.data-api",i);var p=!1;u.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",n),u.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(){var e=r("#app-user-menu .dropdown-wrapper"),t=e.find("div.user-panel").addClass("show"),i=-t.outerHeight();t.css("top",i),e.prev().addClass("hide").end().parent().removeClass("user"),e.data("clicked",!0)}),u.on("click.usermenu","#app-signout",function(){s.emit("xapp:cross:end"),r(".navbar .dropdown-wrapper").find(".user-panel").remove(),r("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),a.remove("cats"),a.remove("user"),a.remove("authorization"),window.location.href="/"}),u.on("click.data-link dblclick.data-link","[data-link]",function(e){var t=r(this).data("link"),i=r(this).data("event-ignore");if(e.type!==i){var n=r("#app-browsing-identity"),s=n.data("readOnly"),a=n.data("settings"),o=r("#app-read-only"),l=n.data("token-type");if(n.size()&&s&&"nota"===t)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),o.size()||r("#app-main").append(o=r('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",a.browsing)),o.trigger("click"),!1;if(n.size()&&(""===t||"nota"===t&&"user"===l))return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),n.trigger("click"),!1}});var f=2;s.on("app:cross:edited",function(e){if(0!==f){f--;var t=r("#app-browsing-identity"),i=t.data("settings"),n=r("#app-read-only"),s=t.data("action");e?e&&"no_permission"===e.error&&(n.size()||r("#app-main").append(n=r('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",i&&i.browsing||a.get("user"))),n.trigger("click")):"setup"===s&&r('[data-user-action="'+s+'"]').trigger("click")}}),u.on("click.dialog.data-api",'[data-widget="dialog"]',function(e){var t,i=r(this),n=i.data("dialog"),s=i.data("dialog-type"),a=i.data("dialog-tab"),d=i.data("dialog-from"),h=i.data("dialog-settings");e.preventDefault(),n||s&&(t=l[s],h&&(t=r.extend(!0,{},t,h)),n=new("identification"===s?c:o)(t),n.options.srcNode=i,d&&(n.dialog_from=d),n.render(),i.data("dialog",n),u.find('[data-dialog-type="'+s+'"]').not(i).data("dialog",n)),a&&n.switchTab(a),n.show(e)});var m=a.get("identities");m||(m=[]),u.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(e){var t=r(this);t.data("typeahead")||(e.preventDefault(),t.data("typeahead",new d({options:{source:m,useCache:!0,target:t,onNothing:function(){this.target.parent().removeClass("identity-avatar"),s.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(e){var t;e&&(t=e.identity)?this.target.prev().attr("src",t.avatar_filename).parent().addClass("identity-avatar"):this.target.parent().removeClass("identity-avatar"),s.emit("widget-dialog-identification-auto",e)}}})))})});