define("mobileroutes",function(t,e,n){"use strict";var i=t("store"),r=t("handlebars"),s=t("humantime"),a=window._ENV_,o=function(t){var e=s.printEFTime(t,"X");return e},c=t("mobilecontroller"),u=c.HomeController,l=c.SetPasswordController,h=c.VerifyController,p=c.CrossController,d=c.LiveController,f=function(t,e,n,s,c,u){s||(s={}),$.ajax({type:"POST",url:a.api_url+"/Crosses/GetCrossByInvitationToken",data:n,success:function(n){var a=n.meta,l=a&&a.code;if(l&&200===l){var h=n.response,d=h.cross,f={id:d.id,title:d.title,description:d.description.replace(/\r\n|\r|\n/g,"<br />"),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!h.read_only},m=d.time;m&&m.begin_at&&m.begin_at.origin&&m.begin_at.timezone?f.time=o(m):f.time.tobe="tobe";var v=d.place;v&&v.title&&(f.place={title:v.title,description:v.description.replace(/\r\n|\r|\n/g,"<br />")});var g=v.lat,y=v.lng;if(g&&y){var b=window.devicePixelRatio>=2?2:1;f.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+g+","+y+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+g+","+y+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+b,f.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(f.place.title)+"@"+g+","+y}else f.place.tobe="tobe";var w,k=d.widget;if(k&&(w=k.length))for(var x=0;w>x;++x)if("Background"===k[x].type){f.background=k[x].image;break}var _=0,E=0,C=h.authorization;C?(_=C.user_id,h.browsing_identity&&(E=h.browsing_identity.id)):h.browsing_identity&&h.browsing_identity.connected_user_id&&(_=h.browsing_identity.connected_user_id,E=h.browsing_identity.id),h.cross_access_token&&(u=s[c]=h.cross_access_token,i.set("cats",s));for(var S=d.exfee.invitations,T=[],N={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]},A=0,P=S.length;P>A;++A){var I=S[A],O="pending",M=I.rsvp_status;"ACCEPTED"===M?O="accepted":"DECLINED"===M&&(O="declined"),I.rsvp_style=O,_&&_===I.identity.connected_user_id||E===I.identity.id?(I.is_me=!0,E=I.identity.id,E!==I.invited_by.id&&(f.inviter=I.invited_by),I.identity.isphone="phone"===I.identity.provider,f.identity=I.identity,N.ACCEPTED.unshift(I)):I.rsvp_status in N&&N[I.rsvp_status].push(I)}T=[].concat(N.ACCEPTED,N.INTERESTED,N.NORESPONSE,N.IGNORED,N.DECLINED),f.invitations=[],P=T.length;for(var H=0;P>H;)f.invitations.push(T.splice(0,5)),H+=5;P=f.invitations.length;var D=f.invitations[P-1],j=D.length;if(j&&5>j)for(;5-j++;)D.push(void 0);var L="";_&&(C?(L=f.id+"?user_id="+_+"&token="+C.token+"&identity_id="+E,u=C.token,i.set("authorization",C)):(C=i.get("authorization"),C&&C.user_id===_&&(L=f.id+"?user_id="+_+"&token="+C.token+"&identity_id="+E,u=C.token)));var R=t.app,F=R.controllers,z=F.cross;z&&z.destory();var B=r.compile($("#cross-tmpl").html());z=R.controllers.cross=new p({options:{template:B(f)},cross:f,exfee_id:d.exfee.id,token:u}),z.emit("show"),R.controllers.footer.emit("show-from-cross",d.exfee.id,u,f.identity.isphone,L)}else t.error={code:404},e.redirect("/")},error:function(){t.error={code:404},e.redirect("/")}})};n.exports={index:function(t){var e=t.error,n=t.app,i=n.controllers,r=i.home,s=i.footer,a=n.screen;r||(r=n.controllers.home=new u({options:{template:$("#home-tmpl").html()}})),document.title="EXFE - A utility for gathering with friends.",r.emit("show",a,e),s.emit("show",a,!1,!1,e===!0),delete t.error,n.currPageName="HOME"},verify:function(t,e){var n=t.session,i=n.resolveToken,r=t.app;if(i){$("#app-header").removeClass("hide");var s=new h({options:{template:$("#verify-tmpl").html()},resolveToken:i});s.emit("show",t,e)}else t.error=!0,e.redirect("/");r.currPageName="VERIFY"},setPassword:function(t,e){var n=t.session,i=n.resolveToken,r=t.app;if(i){$("#app-header").removeClass("hide");var s=new l({options:{template:$("#setpassword-tmpl").html()},resolveToken:i,token:i.origin_token});s.emit("show",t,e)}else t.error=!0,e.redirect("/");r.currPageName="SET_PASSWORD"},resolveToken:function(t,e){var n=t.app,i=t.params[0],r=function(t,e){t.error={code:404},e.redirect("/")};i?$.ajax({type:"POST",url:a.api_url+"/Users/ResolveToken",data:{token:i},success:function(n){if(n&&n.meta&&200===n.meta.code){var s=t.session;s.resolveToken=n.response;var a=s.resolveToken.action;"VERIFIED"===a?e.redirect("/#verify"):"INPUT_NEW_PASSWORD"===a&&(s.resolveToken.origin_token=i,e.redirect("/#set_password"))}else r(t,e)},error:function(){r(t,e)}}):r(t,e),n.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(t,e){var n,r,s=t.app,a=t.params,o=a[0],c=a[1],u=i.get("cats");n={invitation_token:c,cross_id:o},u&&(r=u[c])&&(n.cross_access_token=r),f(t,e,n,u,c,r),s.currPageName="CROSS"},crossToken:function(t,e){var n,r=t.app,s=t.params[0],a=i.get("cats"),o={invitation_token:s};a&&(n=a[s])&&(o.cross_access_token=n),f(t,e,o,a,s,n),r.currPageName="CROSS"},live:function(t){var e=t.app,n=e.controllers,i=n.live;i&&i.destory(),i=e.controllers.live=new d({options:{template:$("#live-tmpl").html()}}),i.emit("show",e.screen,e.ios),e.currPageName="LIVE"}}});