define("mobileroutes",function(t,e,n){"use strict";var i=window._ENV_,r=t("store"),a=t("handlebars"),s=t("humantime"),o=function(t){var e=s.printEFTime(t,"X");return e},l=t("mobilecontroller"),c=l.HomeController,u=l.SetPasswordController,h=l.VerifyController,d=l.CrossController,p=l.LiveController,f=l.RouteXController,m=l.WechatAboutRoutexController,v=function(t,e,n,i,s,l){i||(i={});var c=n.response,u=c.cross,h={id:u.id,title:u.title,description:u.description.replace(/\r\n|\r|\n/g,"<br />"),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!c.read_only,change_name:!1},p=u.time;p&&p.begin_at&&p.begin_at.timezone?h.time=o(p):h.time.tobe="tobe";var f=u.place;f&&f.title&&(h.place={title:f.title,description:f.description.replace(/\r\n|\r|\n/g,"<br />")});var m=f.lat,v=f.lng;if(m&&v){var g=window.devicePixelRatio>=2?2:1;h.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+m+","+v+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_mark_diamond_blue@2x.png")+"%7C"+m+","+v+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+g,h.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(h.place.title)+"@"+m+","+v}else h.place.tobe="tobe";var y,b=u.widget;if(b&&(y=b.length))for(var w=0;y>w;++w)if("Background"===b[w].type){h.background=b[w].image;break}var x=0,k=0,_=c.authorization;_?(x=_.user_id,c.browsing_identity&&(k=c.browsing_identity.id)):c.browsing_identity&&c.browsing_identity.connected_user_id&&(x=c.browsing_identity.connected_user_id,k=c.browsing_identity.id),c.cross_access_token&&(l=i[s]=c.cross_access_token,r.set("cats",i));for(var C=u.exfee.invitations,S=[],E={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]},T=!1,P=0,M=C.length;M>P;++P){var I=C[P],L=x&&x===I.identity.connected_user_id||k===I.identity.id,A=x&&x===I.identity.connected_user_id&&k===I.identity.id,N="pending",O=I.rsvp_status;(A||"NOTIFICATION"!==O)&&("ACCEPTED"===O?N="accepted":"DECLINED"===O&&(N="declined"),I.rsvp_style=N,L?(T="pending"===N,I.is_me=!0,k=I.identity.id,k!==I.invited_by.id&&(h.inviter=I.invited_by),k!==I.by_identity.id&&(T=!0),I.identity.isphone="phone"===I.identity.provider,h.identity=I.identity,E.ACCEPTED.unshift(I)):I.rsvp_status in E&&E[I.rsvp_status].push(I))}h.hide_rsvp=!T,S=[].concat(E.ACCEPTED,E.INTERESTED,E.NORESPONSE,E.IGNORED,E.DECLINED),h.invitations=[],M=S.length;for(var D=0;M>D;)h.invitations.push(S.splice(0,5)),D+=5;M=h.invitations.length;var H=h.invitations[M-1],R=H.length;if(R&&5>R)for(;5-R++;)H.push(void 0);var j="";x&&(_?(j=h.id+"?user_id="+x+"&token="+_.token+"&identity_id="+k,l=_.token,r.set("authorization",_)):(_=r.get("authorization"),_&&_.user_id===x&&(j=h.id+"?user_id="+x+"&token="+_.token+"&identity_id="+k,l=_.token))),l&&h.identity.isphone&&(h.change_name=!0);var z=t.app,F=z.controllers,B=F.cross;B&&B.destory();var U=a.compile($("#cross-tmpl").html());B=z.controllers.cross=new d({options:{template:U(h)},cross:h,exfee_id:u.exfee.id,token:l}),B.emit("show"),z.controllers.footer.emit("show-from-cross",u.exfee.id,l,h.read_only,j)},g=n.exports={index:function(t){var e=t.error,n=t.app,i=n.controllers,r=i.home,a=i.footer,s=n.screen;r||(r=n.controllers.home=new c({options:{template:$("#home-tmpl").html()}})),document.title="EXFE - The group utility for gathering.",r.emit("show",s,e),a.emit("show",s,!1,!1,e===!0),delete t.error,n.currPageName="HOME"},verify:function(t,e){var n=t.session,i=n.resolveToken,r=t.app;$("#app-header").removeClass("hide");var a=new h({options:{template:$("#verify-tmpl").html()},resolveToken:i});a.emit("show",t,e),r.currPageName="VERIFY"},setPassword:function(t,e){var n=t.session,i=n.resolveToken,r=t.app;$("#app-header").removeClass("hide");var a=new u({options:{template:$("#setpassword-tmpl").html()},resolveToken:i,token:i.origin_token});a.emit("show",t,e),r.currPageName="SET_PASSWORD"},resolveToken:function(t,e){var n=t.app,r=t.params[0],a=t._data_=i._data_,s=t.session;s.resolveToken=a;var o=s.resolveToken.action;"VERIFIED"===o?g.verify(t,e):"INPUT_NEW_PASSWORD"===o&&(s.resolveToken.origin_token=r,g.setPassword(t,e)),n.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(t,e){var n=t.app,a=t.params,s=a[2],o=r.get("cats"),l=o&&o[s],c=t._data_=i._data_;v(t,e,c,o,s,l),n.currPageName="CROSS"},crossToken:function(t,e){var n=t.app,a=t.params[1],s=r.get("cats"),o=t._data_=i._data_,l=s&&s[a];v(t,e,o,s,a,l),n.currPageName="CROSS"},live:function(t){var e=t.app,n=e.controllers,i=n.live;i&&i.destory(),i=e.controllers.live=new p({options:{template:$("#live-tmpl").html()}}),i.emit("show",e.screen,e.ios),e.currPageName="LIVE"},routex:function(t){document.title="活点地图";var e=t.app,n=t.params[0],a=i._data_.response,s=i._data_.tokenInfos,o=i._data_.username||"",l=a.cross,c=(a.action,a.cross_access_token),u=a.browsing_identity,h=r.get("cats")||{},d=h&&h[n];c&&(d=h[n]=c,r.set("cats",h));var p=e.controllers.routex=new f({options:{template:$("#routex-tmpl").html()},lastGPS:r.get("position"),cross:l,cross_id:l&&l.id,ctoken:n,token:d||s[0]||n,username:o,myIdentityId:u&&u.id||s[1]||0,myUserId:u&&u.connected_user_id||0,smith_id:window._ENV_.smith_id,isSmithToken:!!window._ENV_.smith_id});p.emit("show")},wechatAboutRoutex:function(t){var e=t.app,n=window._ENV_.authorization,i=e.controllers.wechatAboutRoutex=new m({options:{template:$("#wechat-about-tmpl").html()},token:n.token});i.emit("show")}}});