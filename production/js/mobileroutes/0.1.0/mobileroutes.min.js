define("mobileroutes",function(t,e,i){"use strict";var n=window._ENV_,s=t("store"),r=t("handlebars"),a=t("humantime"),o=function(t){var e=a.printEFTime(t,"X");return e},c=t("mobilecontroller"),l=c.HomeController,h=c.SetPasswordController,u=c.VerifyController,d=c.CrossController,p=c.LiveController,f=c.RouteXController,m=c.WechatAboutRoutexController,g=function(t,e,i,n,a,c){n||(n={});var l=i.response,h=l.cross,u={id:h.id,title:h.title,description:h.description.replace(/\r\n|\r|\n/g,"<br />"),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!l.read_only,change_name:!1},p=h.time;p&&p.begin_at&&p.begin_at.timezone?u.time=o(p):u.time.tobe="tobe";var f=h.place;f&&f.title&&(u.place={title:f.title,description:f.description.replace(/\r\n|\r|\n/g,"<br />")});var m=f.lat,g=f.lng;if(m&&g){var v=window.devicePixelRatio>=2?2:1;u.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+m+","+g+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_mark_diamond_blue@2x.png")+"%7C"+m+","+g+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+v,u.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(u.place.title)+"@"+m+","+g}else u.place.tobe="tobe";var y,b=h.widget;if(b&&(y=b.length))for(var w=0;y>w;++w)if("Background"===b[w].type){u.background=b[w].image;break}var x=0,_=0,k=l.authorization;k?(x=k.user_id,l.browsing_identity&&(_=l.browsing_identity.id)):l.browsing_identity&&l.browsing_identity.connected_user_id&&(x=l.browsing_identity.connected_user_id,_=l.browsing_identity.id),l.cross_access_token&&(c=n[a]=l.cross_access_token,s.set("cats",n));for(var C=h.exfee.invitations,E=[],S={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]},P=!1,T=0,M=C.length;M>T;++T){var I=C[T],L=x&&x===I.identity.connected_user_id||_===I.identity.id,N=x&&x===I.identity.connected_user_id&&_===I.identity.id,A="pending",O=I.rsvp_status;(N||"NOTIFICATION"!==O)&&("ACCEPTED"===O?A="accepted":"DECLINED"===O&&(A="declined"),I.rsvp_style=A,L?(P="pending"===A,I.is_me=!0,_=I.identity.id,_!==I.invited_by.id&&(u.inviter=I.invited_by),_!==I.by_identity.id&&(P=!0),I.identity.isphone="phone"===I.identity.provider,u.identity=I.identity,S.ACCEPTED.unshift(I)):I.rsvp_status in S&&S[I.rsvp_status].push(I))}u.hide_rsvp=!P,E=[].concat(S.ACCEPTED,S.INTERESTED,S.NORESPONSE,S.IGNORED,S.DECLINED),u.invitations=[],M=E.length;for(var D=0;M>D;)u.invitations.push(E.splice(0,5)),D+=5;M=u.invitations.length;var H=u.invitations[M-1],R=H.length;if(R&&5>R)for(;5-R++;)H.push(void 0);var j="";x&&(k?(j=u.id+"?user_id="+x+"&token="+k.token+"&identity_id="+_,c=k.token,s.set("authorization",k)):(k=s.get("authorization"),k&&k.user_id===x&&(j=u.id+"?user_id="+x+"&token="+k.token+"&identity_id="+_,c=k.token))),c&&u.identity.isphone&&(u.change_name=!0);var z=t.app,B=z.controllers,F=B.cross;F&&F.destory();var U=r.compile($("#cross-tmpl").html());F=z.controllers.cross=new d({options:{template:U(u)},cross:u,exfee_id:h.exfee.id,token:c}),F.emit("show"),z.controllers.footer.emit("show-from-cross",h.exfee.id,c,u.read_only,j)},v=i.exports={index:function(t){var e=t.error,i=t.app,n=i.controllers,s=n.home,r=n.footer,a=i.screen;s||(s=i.controllers.home=new l({options:{template:$("#home-tmpl").html()}})),document.title="EXFE - The group utility for gathering.",s.emit("show",a,e),r.emit("show",a,!1,!1,e===!0),delete t.error,i.currPageName="HOME"},verify:function(t,e){var i=t.session,n=i.resolveToken,s=t.app;$("#app-header").removeClass("hide");var r=new u({options:{template:$("#verify-tmpl").html()},resolveToken:n});r.emit("show",t,e),s.currPageName="VERIFY"},setPassword:function(t,e){var i=t.session,n=i.resolveToken,s=t.app;$("#app-header").removeClass("hide");var r=new h({options:{template:$("#setpassword-tmpl").html()},resolveToken:n,token:n.origin_token});r.emit("show",t,e),s.currPageName="SET_PASSWORD"},resolveToken:function(t,e){var i=t.app,s=t.params[0],r=t._data_=n._data_,a=t.session;a.resolveToken=r;var o=a.resolveToken.action;"VERIFIED"===o?v.verify(t,e):"INPUT_NEW_PASSWORD"===o&&(a.resolveToken.origin_token=s,v.setPassword(t,e)),i.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(t,e){var i=t.app,r=t.params,a=r[2],o=s.get("cats"),c=o&&o[a],l=t._data_=n._data_;g(t,e,l,o,a,c),i.currPageName="CROSS"},crossToken:function(t,e){var i=t.app,r=t.params[1],a=s.get("cats"),o=t._data_=n._data_,c=a&&a[r];g(t,e,o,a,r,c),i.currPageName="CROSS"},live:function(t){var e=t.app,i=e.controllers,n=i.live;n&&n.destory(),n=e.controllers.live=new p({options:{template:$("#live-tmpl").html()}}),n.emit("show",e.screen,e.ios),e.currPageName="LIVE"},routex:function(t){document.title="活点地图";var e=t.app,i=t.params[0],r=n._data_.response,a=n._data_.tokenInfos,o=n._data_.username||"",c=r.cross,l=(r.action,r.cross_access_token),h=r.browsing_identity,u=s.get("cats")||{},d=u&&u[i];l&&(d=u[i]=l,s.set("cats",u));var p=e.controllers.routex=new f({options:{template:$("#routex-tmpl").html()},lastGPS:s.get("position"),cross:c,cross_id:c&&c.id,ctoken:i,token:d||a[0]||i,username:o,myIdentityId:h&&h.id||a[1]||0,myUserId:h&&h.connected_user_id||0,smith_id:window._ENV_.smith_id,isSmithToken:!!window._ENV_.smith_id});p.emit("show")},wechatAboutRoutex:function(t){var e=t.app,i=window._ENV_.authorization,n=e.controllers.wechatAboutRoutex=new m({options:{template:$("#wechat-about-tmpl").html()},token:i.token});n.emit("show")}}});