define("mobileroutes",function(t,e,i){"use strict";var n=window._ENV_,s=t("store"),r=t("handlebars"),o=t("humantime"),a=function(t){var e=o.printEFTime(t,"X");return e},l=t("mobilecontroller"),c=l.HomeController,u=l.SetPasswordController,h=l.VerifyController,d=l.CrossController,p=l.LiveController,f=l.RouteXController,m=function(t,e,i,n,o,l){n||(n={});var c=i.response,u=c.cross,h={id:u.id,title:u.title,description:u.description.replace(/\r\n|\r|\n/g,"<br />"),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!c.read_only,change_name:!1},p=u.time;p&&p.begin_at&&p.begin_at.timezone?h.time=a(p):h.time.tobe="tobe";var f=u.place;f&&f.title&&(h.place={title:f.title,description:f.description.replace(/\r\n|\r|\n/g,"<br />")});var m=f.lat,v=f.lng;if(m&&v){var g=window.devicePixelRatio>=2?2:1;h.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+m+","+v+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_mark_diamond_blue@2x.png")+"%7C"+m+","+v+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+g,h.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(h.place.title)+"@"+m+","+v}else h.place.tobe="tobe";var y,b=u.widget;if(b&&(y=b.length))for(var w=0;y>w;++w)if("Background"===b[w].type){h.background=b[w].image;break}var x=0,_=0,k=c.authorization;k?(x=k.user_id,c.browsing_identity&&(_=c.browsing_identity.id)):c.browsing_identity&&c.browsing_identity.connected_user_id&&(x=c.browsing_identity.connected_user_id,_=c.browsing_identity.id),c.cross_access_token&&(l=n[o]=c.cross_access_token,s.set("cats",n));for(var C=u.exfee.invitations,S=[],E={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]},P=!1,T=0,I=C.length;I>T;++T){var L=C[T],M=x&&x===L.identity.connected_user_id||_===L.identity.id,O=x&&x===L.identity.connected_user_id&&_===L.identity.id,N="pending",A=L.rsvp_status;(O||"NOTIFICATION"!==A)&&("ACCEPTED"===A?N="accepted":"DECLINED"===A&&(N="declined"),L.rsvp_style=N,M?(P="pending"===N,L.is_me=!0,_=L.identity.id,_!==L.invited_by.id&&(h.inviter=L.invited_by),_!==L.by_identity.id&&(P=!0),L.identity.isphone="phone"===L.identity.provider,h.identity=L.identity,E.ACCEPTED.unshift(L)):L.rsvp_status in E&&E[L.rsvp_status].push(L))}h.hide_rsvp=!P,S=[].concat(E.ACCEPTED,E.INTERESTED,E.NORESPONSE,E.IGNORED,E.DECLINED),h.invitations=[],I=S.length;for(var D=0;I>D;)h.invitations.push(S.splice(0,5)),D+=5;I=h.invitations.length;var H=h.invitations[I-1],B=H.length;if(B&&5>B)for(;5-B++;)H.push(void 0);var R="";x&&(k?(R=h.id+"?user_id="+x+"&token="+k.token+"&identity_id="+_,l=k.token,s.set("authorization",k)):(k=s.get("authorization"),k&&k.user_id===x&&(R=h.id+"?user_id="+x+"&token="+k.token+"&identity_id="+_,l=k.token))),l&&h.identity.isphone&&(h.change_name=!0);var z=t.app,j=z.controllers,F=j.cross;F&&F.destory();var U=r.compile($("#cross-tmpl").html());F=z.controllers.cross=new d({options:{template:U(h)},cross:h,exfee_id:u.exfee.id,token:l}),F.emit("show"),z.controllers.footer.emit("show-from-cross",u.exfee.id,l,h.read_only,R)},v=i.exports={index:function(t){var e=t.error,i=t.app,n=i.controllers,s=n.home,r=n.footer,o=i.screen;s||(s=i.controllers.home=new c({options:{template:$("#home-tmpl").html()}})),document.title="EXFE - The group utility for gathering.",s.emit("show",o,e),r.emit("show",o,!1,!1,e===!0),delete t.error,i.currPageName="HOME"},verify:function(t,e){var i=t.session,n=i.resolveToken,s=t.app;$("#app-header").removeClass("hide");var r=new h({options:{template:$("#verify-tmpl").html()},resolveToken:n});r.emit("show",t,e),s.currPageName="VERIFY"},setPassword:function(t,e){var i=t.session,n=i.resolveToken,s=t.app;$("#app-header").removeClass("hide");var r=new u({options:{template:$("#setpassword-tmpl").html()},resolveToken:n,token:n.origin_token});r.emit("show",t,e),s.currPageName="SET_PASSWORD"},resolveToken:function(t,e){var i=t.app,s=t.params[0],r=t._data_=n._data_,o=t.session;o.resolveToken=r;var a=o.resolveToken.action;"VERIFIED"===a?v.verify(t,e):"INPUT_NEW_PASSWORD"===a&&(o.resolveToken.origin_token=s,v.setPassword(t,e)),i.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(t,e){var i=t.app,r=t.params,o=r[2],a=s.get("cats"),l=a&&a[o],c=t._data_=n._data_;m(t,e,c,a,o,l),i.currPageName="CROSS"},crossToken:function(t,e){var i=t.app,r=t.params[1],o=s.get("cats"),a=t._data_=n._data_,l=o&&o[r];m(t,e,a,o,r,l),i.currPageName="CROSS"},live:function(t){var e=t.app,i=e.controllers,n=i.live;n&&n.destory(),n=e.controllers.live=new p({options:{template:$("#live-tmpl").html()}}),n.emit("show",e.screen,e.ios),e.currPageName="LIVE"},routex:function(t){document.title="活点地图";var e=t.app,i=t.params[0],r=n._data_.response,o=n._data_.tokenInfos,a=r.cross,l=(r.action,r.cross_access_token),c=r.browsing_identity,u=s.get("cats")||{},h=u&&u[i];l&&(h=u[i]=l,s.set("cats",u));var d=e.controllers.routex=new f({options:{template:$("#routex-tmpl").html()},lastGPS:s.get("position"),cross:a,cross_id:a&&a.id,ctoken:i,token:h||o[0]||i,myIdentityId:c&&c.id||o[1]||0,myUserId:c&&c.connected_user_id||0,smith_id:window._ENV_.smith_id,isSmithToken:!!window._ENV_.smith_id});d.emit("show")}}});