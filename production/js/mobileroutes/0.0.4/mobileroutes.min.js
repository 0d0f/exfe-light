define("mobileroutes",function(e,t,o){"use strict";var r=e("store"),i=e("handlebars"),n=e("humantime"),s=window._ENV_,a=function(e){var t=n.printEFTime(e,"X");return t},c=e("mobilecontroller"),l=c.HomeController,d=c.SetPasswordController,p=c.VerifyController,m=c.CrossController,v=c.LiveController,u=function(e,t,o,n,c,l){n||(n={}),$.ajax({type:"POST",url:s.api_url+"/Crosses/GetCrossByInvitationToken",data:o,success:function(o){var s=o.meta,d=s&&s.code;if(d&&200===d){var p=o.response,v=p.cross,u={id:v.id,title:v.title,description:v.description.replace(/\r\n|\r|\n/g,"<br />"),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!p.read_only},_=v.time;_&&_.begin_at&&_.begin_at.timezone?u.time=a(_):u.time.tobe="tobe";var f=v.place;f&&f.title&&(u.place={title:f.title,description:f.description.replace(/\r\n|\r|\n/g,"<br />")});var g=f.lat,h=f.lng;if(g&&h){var E=window.devicePixelRatio>=2?2:1;u.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+g+","+h+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+g+","+h+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+E,u.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(u.place.title)+"@"+g+","+h}else u.place.tobe="tobe";var k,y=v.widget;if(y&&(k=y.length))for(var w=0;k>w;++w)if("Background"===y[w].type){u.background=y[w].image;break}var T=0,b=0,C=p.authorization;C?(T=C.user_id,p.browsing_identity&&(b=p.browsing_identity.id)):p.browsing_identity&&p.browsing_identity.connected_user_id&&(T=p.browsing_identity.connected_user_id,b=p.browsing_identity.id),p.cross_access_token&&(l=n[c]=p.cross_access_token,r.set("cats",n));for(var N=v.exfee.invitations,P=[],S={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]},D=0,R=N.length;R>D;++D){var I=N[D],O="pending",x=I.rsvp_status;"ACCEPTED"===x?O="accepted":"DECLINED"===x&&(O="declined"),I.rsvp_style=O,T&&T===I.identity.connected_user_id||b===I.identity.id?(I.is_me=!0,b=I.identity.id,b!==I.invited_by.id&&(u.inviter=I.invited_by),I.identity.isphone="phone"===I.identity.provider,u.identity=I.identity,S.ACCEPTED.unshift(I)):I.rsvp_status in S&&S[I.rsvp_status].push(I)}P=[].concat(S.ACCEPTED,S.INTERESTED,S.NORESPONSE,S.IGNORED,S.DECLINED),u.invitations=[],R=P.length;for(var z=0;R>z;)u.invitations.push(P.splice(0,5)),z+=5;R=u.invitations.length;var A=u.invitations[R-1],L=A.length;if(L&&5>L)for(;5-L++;)A.push(void 0);var V="";T&&(C?(V=u.id+"?user_id="+T+"&token="+C.token+"&identity_id="+b,l=C.token,r.set("authorization",C)):(C=r.get("authorization"),C&&C.user_id===T&&(V=u.id+"?user_id="+T+"&token="+C.token+"&identity_id="+b,l=C.token)));var F=e.app,U=F.controllers,j=U.cross;j&&j.destory();var G=i.compile($("#cross-tmpl").html());j=F.controllers.cross=new m({options:{template:G(u)},cross:u,exfee_id:v.exfee.id,token:l}),j.emit("show"),F.controllers.footer.emit("show-from-cross",v.exfee.id,l,u.identity.isphone,V)}else e.error={code:404},t.redirect("/")},error:function(){e.error={code:404},t.redirect("/")}})};o.exports={index:function(e){var t=e.error,o=e.app,r=o.controllers,i=r.home,n=r.footer,s=o.screen;i||(i=o.controllers.home=new l({options:{template:$("#home-tmpl").html()}})),document.title="EXFE - The group utility for gathering.",i.emit("show",s,t),n.emit("show",s,!1,!1,t===!0),delete e.error,o.currPageName="HOME"},verify:function(e,t){var o=e.session,r=o.resolveToken,i=e.app;if(r){$("#app-header").removeClass("hide");var n=new p({options:{template:$("#verify-tmpl").html()},resolveToken:r});n.emit("show",e,t)}else e.error=!0,t.redirect("/");i.currPageName="VERIFY"},setPassword:function(e,t){var o=e.session,r=o.resolveToken,i=e.app;if(r){$("#app-header").removeClass("hide");var n=new d({options:{template:$("#setpassword-tmpl").html()},resolveToken:r,token:r.origin_token});n.emit("show",e,t)}else e.error=!0,t.redirect("/");i.currPageName="SET_PASSWORD"},resolveToken:function(e,t){var o=e.app,r=e.params[0],i=function(e,t){e.error={code:404},t.redirect("/")};r?$.ajax({type:"POST",url:s.api_url+"/Users/ResolveToken",data:{token:r},success:function(o){if(o&&o.meta&&200===o.meta.code){var n=e.session;n.resolveToken=o.response;var s=n.resolveToken.action;"VERIFIED"===s?t.redirect("/#verify"):"INPUT_NEW_PASSWORD"===s&&(n.resolveToken.origin_token=r,t.redirect("/#set_password"))}else i(e,t)},error:function(){i(e,t)}}):i(e,t),o.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(e,t){var o,i,n=e.app,s=e.params,a=s[0],c=s[1],l=r.get("cats");o={invitation_token:c,cross_id:a},l&&(i=l[c])&&(o.cross_access_token=i),u(e,t,o,l,c,i),n.currPageName="CROSS"},crossToken:function(e,t){var o,i=e.app,n=e.params[0],s=r.get("cats"),a={invitation_token:n};s&&(o=s[n])&&(a.cross_access_token=o),u(e,t,a,s,n,o),i.currPageName="CROSS"},live:function(e){var t=e.app,o=t.controllers,r=o.live;r&&r.destory(),r=t.controllers.live=new v({options:{template:$("#live-tmpl").html()}}),r.emit("show",t.screen,t.ios),t.currPageName="LIVE"}}});