define("mobileroutes",function(e,t,i){"use strict";var n=e("store"),r=e("handlebars"),a=e("humantime"),s=window._ENV_,o=function(e){var t=a.printEFTime(e,"X");return t},l=e("mobilecontroller"),c=l.HomeController,u=l.SetPasswordController,d=l.VerifyController,h=l.CrossController,p=l.LiveController,f=function(e,t,i,a,l,c){a||(a={}),$.ajax({type:"POST",url:s.api_url+"/Crosses/GetCrossByInvitationToken",data:i,success:function(i){var s=i.meta,u=s&&s.code;if(u&&200===u){var d=i.response,p=d.cross,f={id:p.id,title:p.title,description:p.description.replace(/\r\n|\r|\n/g,"<br />"),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!d.read_only},m=p.time;m&&m.begin_at&&m.begin_at.timezone?f.time=o(m):f.time.tobe="tobe";var g=p.place;g&&g.title&&(f.place={title:g.title,description:g.description.replace(/\r\n|\r|\n/g,"<br />")});var v=g.lat,y=g.lng;if(v&&y){var _=window.devicePixelRatio>=2?2:1;f.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+v+","+y+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+v+","+y+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+_,f.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(f.place.title)+"@"+v+","+y}else f.place.tobe="tobe";var b,x=p.widget;if(x&&(b=x.length))for(var w=0;b>w;++w)if("Background"===x[w].type){f.background=x[w].image;break}var k=0,C=0,E=d.authorization;E?(k=E.user_id,d.browsing_identity&&(C=d.browsing_identity.id)):d.browsing_identity&&d.browsing_identity.connected_user_id&&(k=d.browsing_identity.connected_user_id,C=d.browsing_identity.id),d.cross_access_token&&(c=a[l]=d.cross_access_token,n.set("cats",a));for(var T=p.exfee.invitations,S=[],M={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]},N=0,I=T.length;I>N;++N){var A=T[N],P="pending",D=A.rsvp_status;"ACCEPTED"===D?P="accepted":"DECLINED"===D&&(P="declined"),A.rsvp_style=P,k&&k===A.identity.connected_user_id||C===A.identity.id?(A.is_me=!0,C=A.identity.id,C!==A.invited_by.id&&(f.inviter=A.invited_by),A.identity.isphone="phone"===A.identity.provider,f.identity=A.identity,M.ACCEPTED.unshift(A)):A.rsvp_status in M&&M[A.rsvp_status].push(A)}S=[].concat(M.ACCEPTED,M.INTERESTED,M.NORESPONSE,M.IGNORED,M.DECLINED),f.invitations=[],I=S.length;for(var O=0;I>O;)f.invitations.push(S.splice(0,5)),O+=5;I=f.invitations.length;var H=f.invitations[I-1],L=H.length;if(L&&5>L)for(;5-L++;)H.push(void 0);var z="";k&&(E?(z=f.id+"?user_id="+k+"&token="+E.token+"&identity_id="+C,c=E.token,n.set("authorization",E)):(E=n.get("authorization"),E&&E.user_id===k&&(z=f.id+"?user_id="+k+"&token="+E.token+"&identity_id="+C,c=E.token)));var R=e.app,j=R.controllers,F=j.cross;F&&F.destory();var q=r.compile($("#cross-tmpl").html());F=R.controllers.cross=new h({options:{template:q(f)},cross:f,exfee_id:p.exfee.id,token:c}),F.emit("show"),R.controllers.footer.emit("show-from-cross",p.exfee.id,c,f.identity.isphone,z)}else e.error={code:404},t.redirect("/")},error:function(){e.error={code:404},t.redirect("/")}})};i.exports={index:function(e){var t=e.error,i=e.app,n=i.controllers,r=n.home,a=n.footer,s=i.screen;r||(r=i.controllers.home=new c({options:{template:$("#home-tmpl").html()}})),document.title="EXFE - The group utility for gathering.",r.emit("show",s,t),a.emit("show",s,!1,!1,t===!0),delete e.error,i.currPageName="HOME"},verify:function(e,t){var i=e.session,n=i.resolveToken,r=e.app;if(n){$("#app-header").removeClass("hide");var a=new d({options:{template:$("#verify-tmpl").html()},resolveToken:n});a.emit("show",e,t)}else e.error=!0,t.redirect("/");r.currPageName="VERIFY"},setPassword:function(e,t){var i=e.session,n=i.resolveToken,r=e.app;if(n){$("#app-header").removeClass("hide");var a=new u({options:{template:$("#setpassword-tmpl").html()},resolveToken:n,token:n.origin_token});a.emit("show",e,t)}else e.error=!0,t.redirect("/");r.currPageName="SET_PASSWORD"},resolveToken:function(e,t){var i=e.app,n=e.params[0],r=function(e,t){e.error={code:404},t.redirect("/")};n?$.ajax({type:"POST",url:s.api_url+"/Users/ResolveToken",data:{token:n},success:function(i){if(i&&i.meta&&200===i.meta.code){var a=e.session;a.resolveToken=i.response;var s=a.resolveToken.action;"VERIFIED"===s?t.redirect("/#verify"):"INPUT_NEW_PASSWORD"===s&&(a.resolveToken.origin_token=n,t.redirect("/#set_password"))}else r(e,t)},error:function(){r(e,t)}}):r(e,t),i.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(e,t){var i,r,a=e.app,s=e.params,o=s[0],l=s[1],c=n.get("cats");i={invitation_token:l,cross_id:o},c&&(r=c[l])&&(i.cross_access_token=r),f(e,t,i,c,l,r),a.currPageName="CROSS"},crossToken:function(e,t){var i,r=e.app,a=e.params[0],s=n.get("cats"),o={invitation_token:a};s&&(i=s[a])&&(o.cross_access_token=i),f(e,t,o,s,a,i),r.currPageName="CROSS"},live:function(e){var t=e.app,i=t.controllers,n=i.live;n&&n.destory(),n=t.controllers.live=new p({options:{template:$("#live-tmpl").html()}}),n.emit("show",t.screen,t.ios),t.currPageName="LIVE"}}});