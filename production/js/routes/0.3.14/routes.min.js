define("routes",function(e,i,t){"use strict";function a(e,i){function t(e,i){var t=o.printExtUserName(e.identities[0]);i.redirect("/#"+t.replace(/ /g,""))}var a=e.session,n=d.get("user");if(n)return t(n,i),void 0;var r=a.authorization;s.emit("app:user:signin",r.token,r.user_id,!0)}var n=e("rex"),r=e("api"),s=e("bus"),o=e("util"),d=e("store");e("user");var p=t.exports={};p.index=function(e,i){return e.session.authorization?(a(e,i),void 0):(s.emit("app:page:home",!0),i.render("home.html",function(i){$("#app-main").append(i),$.ajax({dataType:"script",cache:!0,url:"/static/js/newhome/0.0.1/newhome.min.js?t="+e.app.set("timestamp")})}),void 0)},p.gather=function(e,i){var t=e.session;if(s.emit("app:page:home",!1),!t.initMenuBar){var a=t.authorization,n=t.user;s.emit("app:page:usermenu",!!a),a&&(t.initMenuBar=!0,s.emit("app:usermenu:updatenormal",n),s.emit("app:usermenu:crosslist",a.token,a.user_id))}i.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},p.resolveToken=function(e,i,t){e.origin="resolveToken";var a=e.params[0];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),a?t():i.redirect("/#invalid/token="+a)},p.inspectResolveToken=function(e,i,t,a,n){var r=e.session,p=r.user,u=r.authorization;r.originToken=n,r.resolveData=a;var l,m=a.token,c=a.user_id,g=a.user_name,v=null,f=a.token_type,h=a.action;!v&&(u&&u.user_id===c||!u&&"VERIFY"===f&&"VERIFIED"===h)?(u={token:m,user_id:c},d.set("authorization",r.authorization=u),r.auto_sign="INPUT_NEW_PASSWORD"!==h):r.browsing_authorization=l=a,s.emit("app:api:getuser",m,c,function(e){var i=e.user;if(r.resolveData.setup="INPUT_NEW_PASSWORD"===h&&"VERIFY"===f&&i.password===!1,l){r.browsing_user=i;var a,c=o.printExtUserName(i.identities[0]);a=u?"/#"+c+"/token="+n:"/#"+c,s.emit("app:usermenu:updatebrowsing",{normal:p,browsing:i,action:h,setup:"INPUT_NEW_PASSWORD"===h&&"VERIFY"===f&&i.password===!1,originToken:n,tokenType:"user",user_token:m,page:"resolve",readOnly:!0,user_name:g||i.name,mergeable_user:v,forward:a},"browsing_identity")}else d.set("user",p=r.user=e.user),s.emit("app:usermenu:updatenormal",p),s.emit("app:usermenu:crosslist",u.token,u.user_id);t()})},p.resolveRequest=function(e,i,t){var a=e.session,n=e.params[0];a.originToken=n,r.request("resolveToken",{type:"POST",data:{token:n}},function(a){p.inspectResolveToken(e,i,t,a,n)},function(){i.redirect("/#invalid/token="+n)})},p.resolveShow=function(e,i){var t=e.session,a=t.auto_sign,r=t.originToken,o=t.user,d=t.authorization,p=t.browsing_authorization,u=t.browsing_user,l=t.resolveData,m=l.identity_id,c=l.token_type,g=null,v=l.action,f="identity_verified.html";if(g)return i.render(f,function(e){var i=$("#app-main");i.append(e);var t=$('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">');t.data("source",{merged_identity:n.find(u.identities,function(e){return e.id===m?!0:void 0}),browsing_token:r,mergeable_user:g}),t.appendTo($("#app-tmp")),t.trigger("click.dialog.data-api"),$(".modal-mi").css("top",230)}),void 0;if(a&&d&&!p)return delete t.auto_sign,i.render(f,function(e){var t=$("#app-main");t.append(e),t.find(".tab01").removeClass("hide"),t.find(".tab01 > p").animate({opacity:0},2333,function(){i.redirect("/")})}),void 0;if(!a&&"VERIFY"===c&&"VERIFIED"===v)return i.render(f,function(e){var i=$("#app-main");i.append(e),$("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)}),void 0;if("INPUT_NEW_PASSWORD"===v){var h;"SET_PASSWORD"===c&&(f="forgot_password.html"),i.render(f,function(e){$("#app-main").append(e),d&&!p?(n.find(o.identities,function(e){return e.id===m?!0:void 0}),"VERIFY"===c?(h=$('<div class="merge setup" data-destory="true" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_email" data-redirect="true">'),h.data("source",{browsing_user:o,originToken:r,user_name:l.user_name,tokenType:"user"})):"SET_PASSWORD"===c&&(h=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword" data-redirect="true">'),h.data("source",{user:o,token:l.setup?d.token:r,setup:l.setup})),h.appendTo($("#app-tmp")),h.trigger("click.dialog.data-api")):"VERIFY"===c?(s.once("app:user:signin:after",function(){var e=$('<div class="addidentity" data-destory="true" data-widget="dialog" data-dialog-type="addIdentityAfterSignIn">');e.data("source",{identity:u.identities[0]}),e.appendTo($("#app-tmp")),e.trigger("click.dialog.data-api")}),$("#app-user-menu").find(".setup").trigger("click.dialog.data-api")):(h=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword" data-redirect="true">'),h.data("source",{user:u,token:l.setup?p.token:r,setup:l.setup}),h.appendTo($("#app-tmp")),h.trigger("click.dialog.data-api")),$(".modal-su, .modal-sp, .modal-bi").css("top",250)})}delete t.browsing_authorization,delete t.resolveData,delete t.originToken},p.cross=function(e,i){var t=e.session,a=t.authorization,n=t.user;if(!a)return s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0],null),void 0;s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),t.initMenuBar||(s.emit("app:usermenu:updatenormal",n),s.emit("app:usermenu:crosslist",a.token,a.user_id));var r=e.params[0];i.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",r)})},s.on("app:cross:forbidden",function(e,i){$("#app-main").load("/static/views/forbidden.html",function(){var e=d.get("authorization"),t={options:{keyboard:!1,backdrop:!1,viewData:{cls:"modal-id"}}};if(i&&$(".sign-in").data("source",i.external_username),e){var a=d.get("user");$(".details").removeClass("hide"),$(".details .avatar img").attr("src",a.avatar_filename),$(".details .identity-name").text(a.name),$(".please-access").removeClass("hide"),$(".modal-id").css({top:380})}else $(".sign-in").data("dialog-settings",t),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide"),$(".please-signin").removeClass("hide"),$(".modal-id").css("top",260)})}),p.crossInvitation=function(e,i){var t=e.session,a=t.authorization,d=t.user,p=d&&d.id,u=e.params[0],l=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!!a),a&&(s.emit("app:usermenu:updatenormal",d),s.emit("app:usermenu:crosslist",a.token,a.user_id)),r.request("getInvitationByToken",{type:"POST",resources:{cross_id:u},data:{token:l}},function(e){var t,r=e.invitation,l=r.identity,m=r.by_identity;return p&&(t=n.find(d.identities,function(e){return e.connected_user_id===l.connected_user_id&&e.id===l.id?!0:void 0}))?(i.redirect("/#!"+u),void 0):"email"===l.provider?(s.emit("app:cross:forbidden",u,l),void 0):(i.render("invite.html",function(e){$("#app-main").append(e),a?($(".please-access").removeClass("hide"),$(".form-horizontal").addClass("fh-left"),$(".details").removeClass("hide"),$(".details .avatar img").attr("src",d.avatar_filename),$(".details .identity-name").text(d.name)):$(".please-signin").removeClass("hide"),$(".invite-to").find("img").attr("src",l.avatar_filename).parent().next().text(o.printExtUserName(l)),$(".invite-from").find("img").attr("src",m.avatar_filename).parent().next().text(o.printExtUserName(m));var i=$(".x-invite").find(".redirecting"),t=i.next(),n=!1;$(".xbtn-authenticate").on("click",function(e){if(e.stopPropagation(),e.preventDefault(),!n){var a=$(this).data("oauth");$.ajax({url:"/OAuth/Authenticate?provider="+a,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){n=!0,t.addClass("hide"),i.removeClass("hide")},success:function(e){n=!1;var a=e.meta.code;200===a?window.location.href=e.response.redirect:(i.addClass("hide"),t.removeClass("hide"))}})}})}),void 0)},function(e){404===e.meta.code&&i.location("/404")})};var u=function(e,i,t,a,n,o,p,u,l){var m=i.session,c=m.authorization,g=m.user,v=c&&c.user_id||0;r.request("getCrossByInvitationToken",{type:"POST",params:a,data:n},function(i){var t=i.authorization,a=i.browsing_identity,n=a&&a.connected_user_id,r=i.cross_access_token,g=i.read_only,f=i.action,h=i.cross;s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),!1===g&&r&&(o||(o={}),p=o[u]=r,d.set("cats",o));var w=function(){e.render("x.html",function(e){if($("#app-main").empty().append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,a,h,g,p||u,l),"mute"===l){var i=$('<div id="js-dialog-unsubscribe" data-destory="true" data-widget="dialog" data-dialog-type="unsubscribe">');i.data("source",h),i.appendTo($("#app-tmp")),i.trigger("click.dialog.data-api")}})};if(!t&&g)s.emit("app:usermenu:updatebrowsing",{browsing:{identities:[a],name:a.name},action:f,readOnly:g,page:"cross",code:1});else{if((c&&v===n||!c&&(c=t))&&n>0)return d.set("authorization",m.authorization=c),s.once("app:user:signin:after",function(){e.redirect("/#!"+h.id)}),s.emit("app:user:signin",c.token,c.user_id),void 0;if(!g&&(p||t)){var _={browsing:{user_id:a.connected_user_id,identities:[a],name:a.name},invitation_token:u,action:f,readOnly:g,tokenType:"invitation",setup:"SETUP"===f,page:"cross",code:2};p&&(_.tokenType="cross",_.cross_access_token=p),s.emit("app:usermenu:updatebrowsing",_)}}w()},function(i){var t=i&&i.meta&&i.meta.code,a=!!c;403===t?(s.emit("app:page:home",!1),s.emit("app:page:usermenu",a),a&&(s.emit("app:usermenu:updatenormal",g),s.emit("app:usermenu:crosslist",c.token,c.user_id)),s.emit("app:cross:forbidden",null,null)):404===t&&e.location("/404")})};p.crossToken=function(e,i,t){var a,n,r=e.session,s=r.authorization,o=s&&s.token,p=e.params[0],l=e.params[1],m=d.get("cats"),c={};o&&(c.token=o),m&&(a=m[p]),n={invitation_token:p},a&&(n.cross_access_token=a),u(i,e,t,c,n,m,a,p,l)},p.crossPhoneToken=function(e,i,t){var a,n,r=e.session,s=r.authorization,o=s&&s.token,p=e.params[0],l=e.params[1],m=e.params[2]||"",c=d.get("cats"),g={};o&&(g.token=o),c&&(a=c[l]),n={invitation_token:l,cross_id:p},a&&(n.cross_access_token=a),u(i,e,t,g,n,c,a,l,m)},p.profile=function(e,i){var t=e.session,a=t.authorization,n=t.user,r=t.browsing_authorization,p=t.browsing_user,u=t.action,l=t.oauth;s.emit("app:page:home",!1);var m=e.params[2],c=m&&m.match(o.tokenRegExp),g=c&&c[1];return g&&!r?(i.redirect("/#token="+g),void 0):(a||r?(document.title="EXFE - Profile",s.emit("app:page:usermenu",!0),a&&!r?(s.emit("app:usermenu:updatenormal",n),s.emit("app:usermenu:crosslist",a.token,a.user_id),i.render("profile.html",function(e){$("#app-main").data("event",t.event),delete t.event,$("#app-main").append(e),s.emit("app:profile:identities",n);var i=$.Deferred(),r=$.Event("click.dialog.data-api");i.resolve(a),s.emit("app:profile:show",i),l?("connected"!==l.identity_status&&(r.following=l.following,r.identity=l.identity,r.token=a.token,$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-destory="true"></div>').appendTo($("#app-tmp")).trigger(r)),d.remove("oauth"),delete t.oauth):t.verification_token&&($('<div id="app-oauth-resetpassword" class="hide" data-widget="dialog" data-dialog-type="setpassword" data-destory="true" data-redirect="false"></div>').data("token",t.verification_token).appendTo($("#app-tmp")).trigger(r),delete t.verification_token)})):r?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:n,browsing:p,action:u,setup:"INPUT_NEW_PASSWORD"===u,originToken:t.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete t.originToken,i.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",p);var i=$.Deferred();i.resolve(r),s.emit("app:profile:show",i)})):i.redirect("/")):i.redirect("/"),void 0)},p.invalid=function(e,i){var t=e.session,a=t.authorization,n=t.user;document.title="EXFE - Invalid Link",s.emit("app:page:home",!1),a?(s.emit("app:page:usermenu",!0),s.emit("app:usermenu:updatenormal",n),s.emit("app:usermenu:crosslist",a.token,a.user_id)):s.emit("app:page:usermenu",!1),i.render("invalid.html",function(e){$("#app-main").append(e)})},p.signout=function(){d.remove("cats"),d.remove("user"),d.remove("authorization"),window.location.href="/"},p.refreshAuthUser=function(e,i,t){var a=e.session,n=a.authorization;return n?(s.emit("app:api:getuser",n.token,n.user_id,function(e){var i=e.user;return d.set("user",a.user=i),0===i.identities.length?(p.signout(),void 0):(t(),void 0)},function(e){var i=e&&e.meta&&e.meta.code;401===i&&(d.remove("user"),d.remove("authorization"),delete a.user,delete a.authorization),t()}),void 0):(t(),void 0)}});