<<<<<<< HEAD
define("routes",function(e,t,i){"use strict";function n(e,t){function i(e,t){var i=o.printExtUserName(e.identities[0]);t.redirect("/#"+i.replace(/ /g,""))}var n=e.session,a=l.get("user");if(a)return i(a,t),void 0;var r=n.authorization;s.emit("app:user:signin",r.token,r.user_id,!0)}var a=e("rex"),r=e("api"),s=e("bus"),o=e("util"),l=e("store");e("user");var c=i.exports={};c.index=function(e,t){return e.session.authorization?(n(e,t),void 0):(s.emit("app:page:home",!0),t.render("home.html",function(t){$("#app-main").append(t),$.ajax({dataType:"script",cache:!0,url:"/static/js/newhome/0.0.1/newhome.min.js?t="+e.app.set("timestamp")})}),void 0)},c.gather=function(e,t){var i=e.session;if(s.emit("app:page:home",!1),!i.initMenuBar){var n=i.authorization,a=i.user;s.emit("app:page:usermenu",!!n),n&&(i.initMenuBar=!0,s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id))}t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},c.resolveToken=function(e,t,i){e.origin="resolveToken";var n=e.params[0];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),n?i():t.redirect("/#invalid/token="+n)},c.inspectResolveToken=function(e,t,i,n,a){var r=e.session,c=r.user,d=r.authorization;r.resolveData=n;var u,h=n.token,p=n.user_id,f=n.user_name,m=null,g=n.token_type,v=n.action;!m&&(d&&d.user_id===p||!d&&"VERIFY"===g&&"VERIFIED"===v)?(d={token:h,user_id:p},l.set("authorization",r.authorization=d),r.auto_sign="INPUT_NEW_PASSWORD"!==v):r.browsing_authorization=u=n,s.emit("app:api:getuser",h,p,function(e){var t=e.user;if(r.resolveData.setup="INPUT_NEW_PASSWORD"===v&&"VERIFY"===g&&t.password===!1,u){r.browsing_user=t;var n,h=o.printExtUserName(t.identities[0]);n=d?"/#"+h+"/token="+a:"/#"+h,s.emit("app:usermenu:updatebrowsing",{normal:c,browsing:t,action:v,setup:"INPUT_NEW_PASSWORD"===v&&"VERIFY"===g&&t.password===!1,originToken:a,tokenType:"user",page:"resolve",readOnly:!0,user_name:f||t.name,mergeable_user:m,forward:n},"browsing_identity")}else l.set("user",c=r.user=e.user),s.emit("app:usermenu:updatenormal",c),s.emit("app:usermenu:crosslist",d.token,d.user_id);i()})},c.resolveRequest=function(e,t,i){var n=e.session,a=e.params[0];n.originToken=a,r.request("resolveToken",{type:"POST",data:{token:a}},function(n){c.inspectResolveToken(e,t,i,n,a)},function(){t.redirect("/#invalid/token="+a)})},c.resolveShow=function(e,t){var i=e.session,n=i.auto_sign,r=i.originToken,o=i.user,l=i.authorization,c=i.browsing_authorization,d=i.browsing_user,u=i.resolveData,h=u.identity_id,p=u.token_type,f=null,m=u.action,g="identity_verified.html";if(f)return t.render(g,function(e){var t=$("#app-main");t.append(e);var i=$('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">');i.data("source",{merged_identity:a.find(d.identities,function(e){return e.id===h?!0:void 0}),browsing_token:r,mergeable_user:f}),i.appendTo($("#app-tmp")),i.trigger("click.dialog.data-api"),$(".modal-mi").css("top",230)}),void 0;if(n&&l&&!c)return delete i.auto_sign,t.render(g,function(e){var i=$("#app-main");i.append(e),i.find(".tab01").removeClass("hide"),i.find(".tab01 > p").animate({opacity:0},2333,function(){t.redirect("/")})}),void 0;if(!n&&"VERIFY"===p&&"VERIFIED"===m)return t.render(g,function(e){var t=$("#app-main");t.append(e),$("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)}),void 0;if("INPUT_NEW_PASSWORD"===m){var v;g="forgot_password.html",t.render(g,function(e){if($("#app-main").append(e),l&&!c){var t=a.find(o.identities,function(e){return e.id===h?!0:void 0});"VERIFY"===p?(v=$('<div class="merge set-up" data-destory="true" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_email">'),v.data("source",{browsing_user:o,identity:t,originToken:r,user_name:u.user_name,tokenType:"user"})):"SET_PASSWORD"===p&&(v=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),v.data("source",{user:o,token:u.setup?l.token:r,setup:u.setup})),v.appendTo($("#app-tmp")),v.trigger("click.dialog.data-api")}else"VERIFY"===p?(s.once("app:user:signin:after",function(){var e=$('<div class="addidentity" data-destory="true" data-widget="dialog" data-dialog-type="addIdentityAfterSignIn">');e.data("source",{identity:d.identities[0]}),e.appendTo($("#app-tmp")),e.trigger("click.dialog.data-api")}),$("#app-user-menu").find(".set-up").trigger("click.dialog.data-api")):(v=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),v.data("source",{user:d,token:u.setup?c.token:r,setup:u.setup}),v.appendTo($("#app-tmp")),v.trigger("click.dialog.data-api"));$(".modal-su, .modal-sp, .modal-bi").css("top",230)})}delete i.browsing_authorization,delete i.resolveData,delete i.originToken},c.cross=function(e,t){var i=e.session,n=i.authorization,a=i.user;if(!n)return s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0],null),void 0;s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),i.initMenuBar||(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id));var r=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",r)})},s.on("app:cross:forbidden",function(e,t){$("#app-main").load("/static/views/forbidden.html",function(){var e=l.get("authorization"),i={options:{keyboard:!1,backdrop:!1,viewData:{cls:"modal-id"}}};if(t&&$(".sign-in").data("source",t.external_username),e){var n=l.get("user");$(".details").removeClass("hide"),$(".details .avatar img").attr("src",n.avatar_filename),$(".details .identity-name").text(n.name),$(".please-access").removeClass("hide"),$(".modal-id").css({top:380})}else $(".sign-in").data("dialog-settings",i),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide"),$(".please-signin").removeClass("hide"),$(".modal-id").css("top",260)})}),c.crossInvitation=function(e,t){var i=e.session,n=i.authorization,l=i.user,c=l&&l.id,d=e.params[0],u=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!!n),n&&(s.emit("app:usermenu:updatenormal",l),s.emit("app:usermenu:crosslist",n.token,n.user_id)),r.request("getInvitationByToken",{type:"POST",resources:{cross_id:d},data:{token:u}},function(e){var i,r=e.invitation,u=r.identity,h=r.by_identity;return c&&(i=a.find(l.identities,function(e){return e.connected_user_id===u.connected_user_id&&e.id===u.id?!0:void 0}))?(t.redirect("/#!"+d),void 0):"email"===u.provider?(s.emit("app:cross:forbidden",d,u),void 0):(t.render("invite.html",function(e){$("#app-main").append(e),n?($(".please-access").removeClass("hide"),$(".form-horizontal").addClass("fh-left"),$(".details").removeClass("hide"),$(".details .avatar img").attr("src",l.avatar_filename),$(".details .identity-name").text(l.name)):$(".please-signin").removeClass("hide"),$(".invite-to").find("img").attr("src",u.avatar_filename).parent().next().text(o.printExtUserName(u)),$(".invite-from").find("img").attr("src",h.avatar_filename).parent().next().text(o.printExtUserName(h));var t=$(".x-invite").find(".redirecting"),i=t.next(),a=!1;$(".xbtn-authenticate").on("click",function(e){if(e.stopPropagation(),e.preventDefault(),!a){var n=$(this).data("oauth");$.ajax({url:"/OAuth/Authenticate?provider="+n,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){a=!0,i.addClass("hide"),t.removeClass("hide")},success:function(e){a=!1;var n=e.meta.code;200===n?window.location.href=e.response.redirect:(t.addClass("hide"),i.removeClass("hide"))}})}})}),void 0)},function(e){404===e.meta.code&&t.location("/404")})};var d=function(e,t,i,n,a,o,c,d,u){var h=t.session,p=h.authorization,f=h.user;r.request("getCrossByInvitationToken",{type:"POST",params:n,data:a},function(t){function i(){e.render("x.html",function(e){if($("#app-main").empty().append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,a,p,g,c||d,u),"mute"===u){var t=$('<div id="js-dialog-unsubscribe" data-destory="true" data-widget="dialog" data-dialog-type="unsubscribe">');t.data("source",p),t.appendTo($("#app-tmp")),t.trigger("click.dialog.data-api")}})}var n=t.authorization,a=t.browsing_identity,r=t.action,p=t.cross,m=t.cross_access_token,g=t.read_only;if(!1===g&&m&&(o||(o={}),o[d]=m,l.set("cats",o)),s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),n||!a){if(!h.initMenuBar){if(n)return s.once("app:user:signin:after",function(){e.redirect("/#!"+p.id)}),s.emit("app:user:signin",n.token,n.user_id),void 0;e.redirect("/#!"+p.id)}}else a&&s.emit("app:usermenu:updatebrowsing",{normal:f,browsing:{identities:[a],name:a.name},action:r,setup:"setup"===r,originToken:d,tokenType:"cross",page:"cross",readOnly:g},"browsing_identity");i()},function(t){var i=t&&t.meta&&t.meta.code,n=!!p;403===i?(s.emit("app:page:home",!1),s.emit("app:page:usermenu",n),n&&(s.emit("app:usermenu:updatenormal",f),s.emit("app:usermenu:crosslist",p.token,p.user_id)),s.emit("app:cross:forbidden",null,null)):404===i&&e.location("/404")})};c.crossToken=function(e,t,i){var n,a,r=e.session,s=r.authorization,o=s&&s.token,c=e.params[0],u=e.params[1],h=l.get("cats"),p={};o&&(p.token=o),h&&(n=h[c]),a={invitation_token:c},n&&(a.cross_access_token=n),d(t,e,i,p,a,h,n,c,u)},c.crossPhoneToken=function(e,t,i){var n,a,r=e.session,s=r.authorization,o=s&&s.token,c=e.params[0],u=e.params[1],h=e.params[2]||"",p=l.get("cats"),f={};o&&(f.token=o),p&&(n=p[u]),a={invitation_token:u,cross_id:c},n&&(a.cross_access_token=n),d(t,e,i,f,a,p,n,u,h)},c.profile=function(e,t){var i=e.session,n=i.authorization,a=i.user,r=i.browsing_authorization,c=i.browsing_user,d=i.action,u=i.oauth;s.emit("app:page:home",!1);var h=e.params[2],p=h&&h.match(o.tokenRegExp),f=p&&p[1];return f&&!r?(t.redirect("/#token="+f),void 0):(n||r?(document.title="EXFE - Profile",s.emit("app:page:usermenu",!0),n&&!r?(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id),t.render("profile.html",function(e){$("#app-main").data("event",i.event),delete i.event,$("#app-main").append(e),s.emit("app:profile:identities",a);var t=$.Deferred(),r=$.Event("click.dialog.data-api");t.resolve(n),s.emit("app:profile:show",t),u?("connected"!==u.identity_status&&(r.following=u.following,r.identity=u.identity,r.token=n.token,$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-destory="true"></div>').appendTo($("#app-tmp")).trigger(r)),l.remove("oauth"),delete i.oauth):i.verification_token&&($('<div id="app-oauth-resetpassword" class="hide" data-widget="dialog" data-dialog-type="setpassword" data-destory="true"></div>').data("token",i.verification_token).appendTo($("#app-tmp")).trigger(r),delete i.verification_token)})):r?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:c,action:d,setup:"INPUT_NEW_PASSWORD"===d,originToken:i.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete i.originToken,t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",c);var t=$.Deferred();t.resolve(r),s.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/"),void 0)},c.invalid=function(e,t){var i=e.session,n=i.authorization,a=i.user;document.title="EXFE - Invalid Link",s.emit("app:page:home",!1),n?(s.emit("app:page:usermenu",!0),s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id)):s.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},c.signout=function(){l.remove("cats"),l.remove("user"),l.remove("authorization"),window.location.href="/"},c.refreshAuthUser=function(e,t,i){var n=e.session,a=n.authorization;return a?(s.emit("app:api:getuser",a.token,a.user_id,function(e){var t=e.user;return l.set("user",n.user=t),0===t.identities.length?(c.signout(),void 0):(i(),void 0)},function(e){var t=e&&e.meta&&e.meta.code;401===t&&(l.remove("user"),l.remove("authorization"),delete n.user,delete n.authorization),i()}),void 0):(i(),void 0)}});
=======
define("routes",function(e,t,i){"use strict";function n(e,t){function i(e,t){var i=o.printExtUserName(e.identities[0]);t.redirect("/#"+i.replace(/ /g,""))}var n=e.session,a=l.get("user");if(a)return i(a,t),void 0;var r=n.authorization;s.emit("app:user:signin",r.token,r.user_id,!0)}var a=e("rex"),r=e("api"),s=e("bus"),o=e("util"),l=e("store");e("user");var d=i.exports={};d.index=function(e,t){return e.session.authorization?(n(e,t),void 0):(s.emit("app:page:home",!0),t.render("home.html",function(t){$("#app-main").append(t),$.ajax({dataType:"script",cache:!0,url:"/static/js/newhome/0.0.1/newhome.min.js?t="+e.app.set("timestamp")})}),void 0)},d.gather=function(e,t){var i=e.session;if(s.emit("app:page:home",!1),!i.initMenuBar){var n=i.authorization,a=i.user;s.emit("app:page:usermenu",!!n),n&&(i.initMenuBar=!0,s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id))}t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},d.resolveToken=function(e,t,i){e.origin="resolveToken";var n=e.params[0];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),n?i():t.redirect("/#invalid/token="+n)},d.inspectResolveToken=function(e,t,i,n,a){var r=e.session,d=r.user,c=r.authorization;r.resolveData=n;var u,h=n.token,p=n.user_id,f=n.user_name,m=null,g=n.token_type,v=n.action;!m&&(c&&c.user_id===p||!c&&"VERIFY"===g&&"VERIFIED"===v)?(c={token:h,user_id:p},l.set("authorization",r.authorization=c),r.auto_sign="INPUT_NEW_PASSWORD"!==v):r.browsing_authorization=u=n,s.emit("app:api:getuser",h,p,function(e){var t=e.user;if(r.resolveData.setup="INPUT_NEW_PASSWORD"===v&&"VERIFY"===g&&t.password===!1,u){r.browsing_user=t;var n,h=o.printExtUserName(t.identities[0]);n=c?"/#"+h+"/token="+a:"/#"+h,s.emit("app:usermenu:updatebrowsing",{normal:d,browsing:t,action:v,setup:"INPUT_NEW_PASSWORD"===v&&"VERIFY"===g&&t.password===!1,originToken:a,tokenType:"user",page:"resolve",readOnly:!0,user_name:f||t.name,mergeable_user:m,forward:n},"browsing_identity")}else l.set("user",d=r.user=e.user),s.emit("app:usermenu:updatenormal",d),s.emit("app:usermenu:crosslist",c.token,c.user_id);i()})},d.resolveRequest=function(e,t,i){var n=e.session,a=e.params[0];n.originToken=a,r.request("resolveToken",{type:"POST",data:{token:a}},function(n){d.inspectResolveToken(e,t,i,n,a)},function(){t.redirect("/#invalid/token="+a)})},d.resolveShow=function(e,t){var i=e.session,n=i.auto_sign,r=i.originToken,o=i.user,l=i.authorization,d=i.browsing_authorization,c=i.browsing_user,u=i.resolveData,h=u.identity_id,p=u.token_type,f=null,m=u.action,g="identity_verified.html";if(f)return t.render(g,function(e){var t=$("#app-main");t.append(e);var i=$('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">');i.data("source",{merged_identity:a.find(c.identities,function(e){return e.id===h?!0:void 0}),browsing_token:r,mergeable_user:f}),i.appendTo($("#app-tmp")),i.trigger("click.dialog.data-api"),$(".modal-mi").css("top",230)}),void 0;if(n&&l&&!d)return delete i.auto_sign,t.render(g,function(e){var i=$("#app-main");i.append(e),i.find(".tab01").removeClass("hide"),i.find(".tab01 > p").animate({opacity:0},2333,function(){t.redirect("/")})}),void 0;if(!n&&"VERIFY"===p&&"VERIFIED"===m)return t.render(g,function(e){var t=$("#app-main");t.append(e),$("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)}),void 0;if("INPUT_NEW_PASSWORD"===m){var v;g="forgot_password.html",t.render(g,function(e){if($("#app-main").append(e),l&&!d){var t=a.find(o.identities,function(e){return e.id===h?!0:void 0});"VERIFY"===p?(v=$('<div class="merge set-up" data-destory="true" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_email">'),v.data("source",{browsing_user:o,identity:t,originToken:r,user_name:u.user_name,tokenType:"user"})):"SET_PASSWORD"===p&&(v=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),v.data("source",{user:o,token:u.setup?l.token:r,setup:u.setup})),v.appendTo($("#app-tmp")),v.trigger("click.dialog.data-api")}else"VERIFY"===p?(s.once("app:user:signin:after",function(){var e=$('<div class="addidentity" data-destory="true" data-widget="dialog" data-dialog-type="addIdentityAfterSignIn">');e.data("source",{identity:c.identities[0]}),e.appendTo($("#app-tmp")),e.trigger("click.dialog.data-api")}),$("#app-user-menu").find(".set-up").trigger("click.dialog.data-api")):(v=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),v.data("source",{user:c,token:u.setup?d.token:r,setup:u.setup}),v.appendTo($("#app-tmp")),v.trigger("click.dialog.data-api"));$(".modal-su, .modal-sp, .modal-bi").css("top",230)})}delete i.browsing_authorization,delete i.resolveData,delete i.originToken},d.cross=function(e,t){var i=e.session,n=i.authorization,a=i.user;if(!n)return s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0],null),void 0;s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),i.initMenuBar||(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id));var r=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",r)})},s.on("app:cross:forbidden",function(e,t){$("#app-main").load("/static/views/forbidden.html",function(){var e=l.get("authorization"),i={options:{keyboard:!1,backdrop:!1,viewData:{cls:"modal-id"}}};if(t&&$(".sign-in").data("source",t.external_username),e){var n=l.get("user");$(".details").removeClass("hide"),$(".details .avatar img").attr("src",n.avatar_filename),$(".details .identity-name").text(n.name),$(".please-access").removeClass("hide"),$(".modal-id").css({top:380})}else $(".sign-in").data("dialog-settings",i),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide"),$(".please-signin").removeClass("hide"),$(".modal-id").css("top",260)})}),d.crossInvitation=function(e,t){var i=e.session,n=i.authorization,l=i.user,d=l&&l.id,c=e.params[0],u=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!!n),n&&(s.emit("app:usermenu:updatenormal",l),s.emit("app:usermenu:crosslist",n.token,n.user_id)),r.request("getInvitationByToken",{type:"POST",resources:{cross_id:c},data:{token:u}},function(e){var i,r=e.invitation,u=r.identity,h=r.by_identity;return d&&(i=a.find(l.identities,function(e){return e.connected_user_id===u.connected_user_id&&e.id===u.id?!0:void 0}))?(t.redirect("/#!"+c),void 0):"email"===u.provider?(s.emit("app:cross:forbidden",c,u),void 0):(t.render("invite.html",function(e){$("#app-main").append(e),n?($(".please-access").removeClass("hide"),$(".form-horizontal").addClass("fh-left"),$(".details").removeClass("hide"),$(".details .avatar img").attr("src",l.avatar_filename),$(".details .identity-name").text(l.name)):$(".please-signin").removeClass("hide"),$(".invite-to").find("img").attr("src",u.avatar_filename).parent().next().text(o.printExtUserName(u)),$(".invite-from").find("img").attr("src",h.avatar_filename).parent().next().text(o.printExtUserName(h));var t=$(".x-invite").find(".redirecting"),i=t.next(),a=!1;$(".xbtn-authenticate").on("click",function(e){if(e.stopPropagation(),e.preventDefault(),!a){var n=$(this).data("oauth");$.ajax({url:"/OAuth/Authenticate?provider="+n,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){a=!0,i.addClass("hide"),t.removeClass("hide")},success:function(e){a=!1;var n=e.meta.code;200===n?window.location.href=e.response.redirect:(t.addClass("hide"),i.removeClass("hide"))}})}})}),void 0)},function(e){404===e.meta.code&&t.location("/404")})};var c=function(e,t,i,n,a,o,d,c,u){var h=t.session,p=h.authorization,f=h.user;r.request("getCrossByInvitationToken",{type:"POST",params:n,data:a},function(t){function i(){e.render("x.html",function(e){if($("#app-main").empty().append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,a,p,g,d||c,u),"mute"===u){var t=$('<div id="js-dialog-unsubscribe" data-destory="true" data-widget="dialog" data-dialog-type="unsubscribe">');t.data("source",p),t.appendTo($("#app-tmp")),t.trigger("click.dialog.data-api")}})}var n=t.authorization,a=t.browsing_identity,r=t.action,p=t.cross,m=t.cross_access_token,g=t.read_only;if(!1===g&&m&&(o||(o={}),o[c]=m,l.set("cats",o)),s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),n||!a){if(!h.initMenuBar){if(n)return s.once("app:user:signin:after",function(){e.redirect("/#!"+p.id)}),s.emit("app:user:signin",n.token,n.user_id),void 0;e.redirect("/#!"+p.id)}}else a&&s.emit("app:usermenu:updatebrowsing",{normal:f,browsing:{identities:[a],name:a.name},action:r,setup:"setup"===r,originToken:c,tokenType:"cross",page:"cross",readOnly:g},"browsing_identity");i()},function(t){var i=t&&t.meta&&t.meta.code,n=!!p;403===i?(s.emit("app:page:home",!1),s.emit("app:page:usermenu",n),n&&(s.emit("app:usermenu:updatenormal",f),s.emit("app:usermenu:crosslist",p.token,p.user_id)),s.emit("app:cross:forbidden",null,null)):404===i&&e.location("/404")})};d.crossToken=function(e,t,i){var n,a,r=e.session,s=r.authorization,o=s&&s.token,d=e.params[0],u=e.params[1],h=l.get("cats"),p={};o&&(p.token=o),h&&(n=h[d]),a={invitation_token:d},n&&(a.cross_access_token=n),c(t,e,i,p,a,h,n,d,u)},d.crossPhoneToken=function(e,t,i){var n,a,r=e.session,s=r.authorization,o=s&&s.token,d=e.params[0],u=e.params[1],h=e.params[2]||"",p=l.get("cats"),f={};o&&(f.token=o),p&&(n=p[u]),a={invitation_token:u,cross_id:d},n&&(a.cross_access_token=n),c(t,e,i,f,a,p,n,u,h)},d.profile=function(e,t){var i=e.session,n=i.authorization,a=i.user,r=i.browsing_authorization,d=i.browsing_user,c=i.action,u=i.oauth;s.emit("app:page:home",!1);var h=e.params[2],p=h&&h.match(o.tokenRegExp),f=p&&p[1];return f&&!r?(t.redirect("/#token="+f),void 0):(n||r?(document.title="EXFE - Profile",s.emit("app:page:usermenu",!0),n&&!r?(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id),t.render("profile.html",function(e){$("#app-main").data("event",i.event),delete i.event,$("#app-main").append(e),s.emit("app:profile:identities",a);var t=$.Deferred(),r=$.Event("click.dialog.data-api");t.resolve(n),s.emit("app:profile:show",t),u?("connected"!==u.identity_status&&(r.following=u.following,r.identity=u.identity,r.token=n.token,$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-destory="true"></div>').appendTo($("#app-tmp")).trigger(r)),l.remove("oauth"),delete i.oauth):i.verification_token&&($('<div id="app-oauth-resetpassword" class="hide" data-widget="dialog" data-dialog-type="setpassword" data-destory="true"></div>').data("token",i.verification_token).appendTo($("#app-tmp")).trigger(r),delete i.verification_token)})):r?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:d,action:c,setup:"INPUT_NEW_PASSWORD"===c,originToken:i.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete i.originToken,t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",d);var t=$.Deferred();t.resolve(r),s.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/"),void 0)},d.invalid=function(e,t){var i=e.session,n=i.authorization,a=i.user;document.title="EXFE - Invalid Link",s.emit("app:page:home",!1),n?(s.emit("app:page:usermenu",!0),s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",n.token,n.user_id)):s.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},d.signout=function(){l.remove("cats"),l.remove("user"),l.remove("authorization"),window.location.href="/"},d.refreshAuthUser=function(e,t,i){var n=e.session,a=n.authorization;return a?(s.emit("app:api:getuser",a.token,a.user_id,function(e){var t=e.user;return l.set("user",n.user=t),0===t.identities.length?(d.signout(),void 0):(i(),void 0)},function(e){var t=e&&e.meta&&e.meta.code;401===t&&(l.remove("user"),l.remove("authorization"),delete n.user,delete n.authorization),i()}),void 0):(i(),void 0)}});
>>>>>>> 6a96ad7... update files
