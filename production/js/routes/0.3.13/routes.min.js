define("routes",function(e,t,i){"use strict";function a(e,t){function i(e,t){var i=s.printExtUserName(e.identities[0]);t.redirect("/#"+i.replace(/ /g,""))}var a=e.session,n=p.get("user");if(n)return i(n,t),void 0;var r=a.authorization;o.emit("app:user:signin",r.token,r.user_id,!0)}var n=e("rex"),r=e("api"),o=e("bus"),s=e("util"),p=e("store");e("user");var d=i.exports={};d.index=function(e,t){return e.session.authorization?(a(e,t),void 0):(o.emit("app:page:home",!0),t.render("home.html",function(t){$("#app-main").append(t),$.ajax({dataType:"script",cache:!0,url:"/static/js/newhome/0.0.1/newhome.min.js?t="+e.app.set("timestamp")})}),void 0)},d.gather=function(e,t){var i=e.session;if(o.emit("app:page:home",!1),!i.initMenuBar){var a=i.authorization,n=i.user;o.emit("app:page:usermenu",!!a),a&&(i.initMenuBar=!0,o.emit("app:usermenu:updatenormal",n),o.emit("app:usermenu:crosslist",a.token,a.user_id))}t.render("x.html",function(e){$("#app-main").append(e),o.emit("xapp:cross:main"),o.emit("xapp:cross",0)})},d.resolveToken=function(e,t,i){e.origin="resolveToken";var a=e.params[0];o.emit("app:page:home",!1),o.emit("app:page:usermenu",!0),a?i():t.redirect("/#invalid/token="+a)},d.inspectResolveToken=function(e,t,i,a,n){var r=e.session,d=r.user,u=r.authorization;r.resolveData=a;var m,c=a.token,l=a.user_id,g=a.user_name,v=null,f=a.token_type,h=a.action;!v&&(u&&u.user_id===l||!u&&"VERIFY"===f&&"VERIFIED"===h)?(u={token:c,user_id:l},p.set("authorization",r.authorization=u),r.auto_sign="INPUT_NEW_PASSWORD"!==h):r.browsing_authorization=m=a,o.emit("app:api:getuser",c,l,function(e){var t=e.user;if(r.resolveData.setup="INPUT_NEW_PASSWORD"===h&&"VERIFY"===f&&t.password===!1,m){r.browsing_user=t;var a,c=s.printExtUserName(t.identities[0]);a=u?"/#"+c+"/token="+n:"/#"+c,o.emit("app:usermenu:updatebrowsing",{normal:d,browsing:t,action:h,setup:"INPUT_NEW_PASSWORD"===h&&"VERIFY"===f&&t.password===!1,originToken:n,tokenType:"user",page:"resolve",readOnly:!0,user_name:g||t.name,mergeable_user:v,forward:a},"browsing_identity")}else p.set("user",d=r.user=e.user),o.emit("app:usermenu:updatenormal",d),o.emit("app:usermenu:crosslist",u.token,u.user_id);i()})},d.resolveRequest=function(e,t,i){var a=e.session,n=e.params[0];a.originToken=n,r.request("resolveToken",{type:"POST",data:{token:n}},function(a){d.inspectResolveToken(e,t,i,a,n)},function(){t.redirect("/#invalid/token="+n)})},d.resolveShow=function(e,t){var i=e.session,a=i.auto_sign,r=i.originToken,s=i.user,p=i.authorization,d=i.browsing_authorization,u=i.browsing_user,m=i.resolveData,c=m.identity_id,l=m.token_type,g=null,v=m.action,f="identity_verified.html";if(g)return t.render(f,function(e){var t=$("#app-main");t.append(e);var i=$('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">');i.data("source",{merged_identity:n.find(u.identities,function(e){return e.id===c?!0:void 0}),browsing_token:r,mergeable_user:g}),i.appendTo($("#app-tmp")),i.trigger("click.dialog.data-api"),$(".modal-mi").css("top",230)}),void 0;if(a&&p&&!d)return delete i.auto_sign,t.render(f,function(e){var i=$("#app-main");i.append(e),i.find(".tab01").removeClass("hide"),i.find(".tab01 > p").animate({opacity:0},2333,function(){t.redirect("/")})}),void 0;if(!a&&"VERIFY"===l&&"VERIFIED"===v)return t.render(f,function(e){var t=$("#app-main");t.append(e),$("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)}),void 0;if("INPUT_NEW_PASSWORD"===v){var h;f="forgot_password.html",t.render(f,function(e){if($("#app-main").append(e),p&&!d){var t=n.find(s.identities,function(e){return e.id===c?!0:void 0});"VERIFY"===l?(h=$('<div class="merge set-up" data-destory="true" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_email">'),h.data("source",{browsing_user:s,identity:t,originToken:r,user_name:m.user_name,tokenType:"user"})):"SET_PASSWORD"===l&&(h=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),h.data("source",{user:s,token:m.setup?p.token:r,setup:m.setup})),h.appendTo($("#app-tmp")),h.trigger("click.dialog.data-api")}else"VERIFY"===l?(o.once("app:user:signin:after",function(){var e=$('<div class="addidentity" data-destory="true" data-widget="dialog" data-dialog-type="addIdentityAfterSignIn">');e.data("source",{identity:u.identities[0]}),e.appendTo($("#app-tmp")),e.trigger("click.dialog.data-api")}),$("#app-user-menu").find(".set-up").trigger("click.dialog.data-api")):(h=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),h.data("source",{user:u,token:m.setup?d.token:r,setup:m.setup}),h.appendTo($("#app-tmp")),h.trigger("click.dialog.data-api"));$(".modal-su, .modal-sp, .modal-bi").css("top",230)})}delete i.browsing_authorization,delete i.resolveData,delete i.originToken},d.cross=function(e,t){var i=e.session,a=i.authorization,n=i.user;if(!a)return o.emit("app:page:home",!1),o.emit("app:page:usermenu",!1),o.emit("app:cross:forbidden",e.params[0],null),void 0;o.emit("app:page:home",!1),o.emit("app:page:usermenu",!0),i.initMenuBar||(o.emit("app:usermenu:updatenormal",n),o.emit("app:usermenu:crosslist",a.token,a.user_id));var r=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),o.emit("xapp:cross:main"),o.emit("xapp:cross",r)})},o.on("app:cross:forbidden",function(e,t){$("#app-main").load("/static/views/forbidden.html",function(){var e=p.get("authorization"),i={options:{keyboard:!1,backdrop:!1,viewData:{cls:"modal-id"}}};if(t&&$(".sign-in").data("source",t.external_username),e){var a=p.get("user");$(".details").removeClass("hide"),$(".details .avatar img").attr("src",a.avatar_filename),$(".details .identity-name").text(a.name),$(".please-access").removeClass("hide"),$(".modal-id").css({top:380})}else $(".sign-in").data("dialog-settings",i),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide"),$(".please-signin").removeClass("hide"),$(".modal-id").css("top",260)})}),d.crossInvitation=function(e,t){var i=e.session,a=i.authorization,p=i.user,d=p&&p.id,u=e.params[0],m=e.params[1];o.emit("app:page:home",!1),o.emit("app:page:usermenu",!!a),a&&(o.emit("app:usermenu:updatenormal",p),o.emit("app:usermenu:crosslist",a.token,a.user_id)),r.request("getInvitationByToken",{type:"POST",resources:{cross_id:u},data:{token:m}},function(e){var i,r=e.invitation,m=r.identity,c=r.by_identity;return d&&(i=n.find(p.identities,function(e){return e.connected_user_id===m.connected_user_id&&e.id===m.id?!0:void 0}))?(t.redirect("/#!"+u),void 0):"email"===m.provider?(o.emit("app:cross:forbidden",u,m),void 0):(t.render("invite.html",function(e){$("#app-main").append(e),a?($(".please-access").removeClass("hide"),$(".form-horizontal").addClass("fh-left"),$(".details").removeClass("hide"),$(".details .avatar img").attr("src",p.avatar_filename),$(".details .identity-name").text(p.name)):$(".please-signin").removeClass("hide"),$(".invite-to").find("img").attr("src",m.avatar_filename).parent().next().text(s.printExtUserName(m)),$(".invite-from").find("img").attr("src",c.avatar_filename).parent().next().text(s.printExtUserName(c));var t=$(".x-invite").find(".redirecting"),i=t.next(),n=!1;$(".xbtn-authenticate").on("click",function(e){if(e.stopPropagation(),e.preventDefault(),!n){var a=$(this).data("oauth");$.ajax({url:"/OAuth/Authenticate?provider="+a,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){n=!0,i.addClass("hide"),t.removeClass("hide")},success:function(e){n=!1;var a=e.meta.code;200===a?window.location.href=e.response.redirect:(t.addClass("hide"),i.removeClass("hide"))}})}})}),void 0)},function(e){404===e.meta.code&&t.location("/404")})};var u=function(e,t,i,a,n,s,d,u,m){var c=t.session,l=c.authorization,g=c.user;r.request("getCrossByInvitationToken",{type:"POST",params:a,data:n},function(t){function i(){e.render("x.html",function(e){if($("#app-main").empty().append(e),o.emit("xapp:cross:main"),o.emit("xapp:cross",null,n,l,f,d||u,m),"mute"===m){var t=$('<div id="js-dialog-unsubscribe" data-destory="true" data-widget="dialog" data-dialog-type="unsubscribe">');t.data("source",l),t.appendTo($("#app-tmp")),t.trigger("click.dialog.data-api")}})}var a=t.authorization,n=t.browsing_identity,r=t.action,l=t.cross,v=t.cross_access_token,f=t.read_only;if(!1===f&&v&&(s||(s={}),s[u]=v,p.set("cats",s)),o.emit("app:page:home",!1),o.emit("app:page:usermenu",!0),a||!n){if(!c.initMenuBar){if(a)return o.once("app:user:signin:after",function(){e.redirect("/#!"+l.id)}),o.emit("app:user:signin",a.token,a.user_id),void 0;e.redirect("/#!"+l.id)}}else n&&o.emit("app:usermenu:updatebrowsing",{normal:g,browsing:{identities:[n],name:n.name},action:r,setup:"setup"===r,originToken:u,tokenType:"cross",page:"cross",readOnly:f},"browsing_identity");i()},function(t){var i=t&&t.meta&&t.meta.code,a=!!l;403===i?(o.emit("app:page:home",!1),o.emit("app:page:usermenu",a),a&&(o.emit("app:usermenu:updatenormal",g),o.emit("app:usermenu:crosslist",l.token,l.user_id)),o.emit("app:cross:forbidden",null,null)):404===i&&e.location("/404")})};d.crossToken=function(e,t,i){var a,n,r=e.session,o=r.authorization,s=o&&o.token,d=e.params[0],m=e.params[1],c=p.get("cats"),l={};s&&(l.token=s),c&&(a=c[d]),n={invitation_token:d},a&&(n.cross_access_token=a),u(t,e,i,l,n,c,a,d,m)},d.crossPhoneToken=function(e,t,i){var a,n,r=e.session,o=r.authorization,s=o&&o.token,d=e.params[0],m=e.params[1],c=e.params[2]||"",l=p.get("cats"),g={};s&&(g.token=s),l&&(a=l[m]),n={invitation_token:m,cross_id:d},a&&(n.cross_access_token=a),u(t,e,i,g,n,l,a,m,c)},d.profile=function(e,t){var i=e.session,a=i.authorization,n=i.user,r=i.browsing_authorization,d=i.browsing_user,u=i.action,m=i.oauth;o.emit("app:page:home",!1);var c=e.params[2],l=c&&c.match(s.tokenRegExp),g=l&&l[1];return g&&!r?(t.redirect("/#token="+g),void 0):(a||r?(document.title="EXFE - Profile",o.emit("app:page:usermenu",!0),a&&!r?(o.emit("app:usermenu:updatenormal",n),o.emit("app:usermenu:crosslist",a.token,a.user_id),t.render("profile.html",function(e){$("#app-main").data("event",i.event),delete i.event,$("#app-main").append(e),o.emit("app:profile:identities",n);var t=$.Deferred(),r=$.Event("click.dialog.data-api");t.resolve(a),o.emit("app:profile:show",t),m?("connected"!==m.identity_status&&(r.following=m.following,r.identity=m.identity,r.token=a.token,$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-destory="true"></div>').appendTo($("#app-tmp")).trigger(r)),p.remove("oauth"),delete i.oauth):i.verification_token&&($('<div id="app-oauth-resetpassword" class="hide" data-widget="dialog" data-dialog-type="setpassword" data-destory="true"></div>').data("token",i.verification_token).appendTo($("#app-tmp")).trigger(r),delete i.verification_token)})):r?($(document.body).attr("data-browsing"),o.emit("app:usermenu:updatebrowsing",{normal:n,browsing:d,action:u,setup:"INPUT_NEW_PASSWORD"===u,originToken:i.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete i.originToken,t.render("profile.html",function(e){$("#app-main").append(e),o.emit("app:profile:identities",d);var t=$.Deferred();t.resolve(r),o.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/"),void 0)},d.invalid=function(e,t){var i=e.session,a=i.authorization,n=i.user;document.title="EXFE - Invalid Link",o.emit("app:page:home",!1),a?(o.emit("app:page:usermenu",!0),o.emit("app:usermenu:updatenormal",n),o.emit("app:usermenu:crosslist",a.token,a.user_id)):o.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},d.signout=function(){p.remove("cats"),p.remove("user"),p.remove("authorization"),window.location.href="/"},d.refreshAuthUser=function(e,t,i){var a=e.session,n=a.authorization;return n?(o.emit("app:api:getuser",n.token,n.user_id,function(e){var t=e.user;return p.set("user",a.user=t),0===t.identities.length?(d.signout(),void 0):(i(),void 0)},function(e){var t=e&&e.meta&&e.meta.code;401===t&&(p.remove("user"),p.remove("authorization"),delete a.user,delete a.authorization),i()}),void 0):(i(),void 0)}});