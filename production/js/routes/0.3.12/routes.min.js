define("routes",function(e,t,n){"use strict";function l(e,t){function i(e,t){var n=o.printExtUserName(e.identities[0]);t.redirect("/#"+n.replace(/ /g,""))}var n=e.session,r=u.get("user");if(r){i(r,t);return}var a=n.authorization;s.emit("app:user:signin",a.token,a.user_id,!0)}var r=e("rex"),i=e("api"),s=e("bus"),o=e("util"),u=e("store");e("user");var a=n.exports={};a.index=function(e,t){if(e.session.authorization){l(e,t);return}s.emit("app:page:home",!0),t.render("index.html",function(t){var n=$("#app-main");n.append(t);var r=n.find("div.page-main"),i=$('<img class="exfe-toy" id="js-exfe-toy" src="/static/img/exfe.png" alt="" />');r.append(i),i.load(function(){$.ajax({dataType:"script",cache:!0,url:"/static/js/home/0.0.3/home.js?t="+e.app.set("timestamp")})})})},a.gather=function(e,t){var n=e.session;s.emit("app:page:home",!1);if(!n.initMenuBar){var r=n.authorization,i=n.user;s.emit("app:page:usermenu",!!r),r&&(n.initMenuBar=!0,s.emit("app:usermenu:updatenormal",i),s.emit("app:usermenu:crosslist",r.token,r.user_id))}t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},a.resolveToken=function(e,t,n){e.origin="resolveToken";var r=e.params[0];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r?n():t.redirect("/#invalid/token="+r)},a.inspectResolveToken=function(e,t,n,r,i){var a=e.session,f=a.user,l=a.authorization;a.resolveData=r;var c=r.token,h=r.user_id,p=r.user_name,d=null,v=r.token_type,m=r.action,g;!d&&(l&&l.user_id===h||!l&&v==="VERIFY"&&m==="VERIFIED")?(l={token:c,user_id:h},u.set("authorization",a.authorization=l),a.auto_sign=m!=="INPUT_NEW_PASSWORD"):a.browsing_authorization=g=r,s.emit("app:api:getuser",c,h,function(t){var r=t.user;a.resolveData.setup=m==="INPUT_NEW_PASSWORD"&&v==="VERIFY"&&r.password===!1;if(g){a.browsing_user=r;var c=o.printExtUserName(r.identities[0]),h;l?h="/#"+c+"/token="+i:h="/#"+c,s.emit("app:usermenu:updatebrowsing",{normal:f,browsing:r,action:m,setup:m==="INPUT_NEW_PASSWORD"&&v==="VERIFY"&&r.password===!1,originToken:i,tokenType:"user",page:"resolve",readOnly:!0,user_name:p||r.name,mergeable_user:d,forward:h},"browsing_identity")}else u.set("user",f=a.user=t.user),s.emit("app:usermenu:updatenormal",f),s.emit("app:usermenu:crosslist",l.token,l.user_id);n()})},a.resolveRequest=function(e,t,n){var r=e.session,s=e.params[0];r.originToken=s,i.request("resolveToken",{type:"POST",data:{token:s}},function(r){a.inspectResolveToken(e,t,n,r,s)},function(){t.redirect("/#invalid/token="+s)})},a.resolveShow=function(e,t){var n=e.session,i=n.auto_sign,o=n.originToken,u=n.user,a=n.authorization,f=n.browsing_authorization,l=n.browsing_user,c=n.resolveData,h=c.identity_id,p=c.token_type,d=null,v=c.action,m="identity_verified.html";if(d){t.render(m,function(e){var t=$("#app-main");t.append(e);var n=$('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">');n.data("source",{merged_identity:r.find(l.identities,function(e){if(e.id===h)return!0}),browsing_token:o,mergeable_user:d}),n.appendTo($("#app-tmp")),n.trigger("click.dialog.data-api"),$(".modal-mi").css("top",230)});return}if(i&&a&&!f){delete n.auto_sign,t.render(m,function(e){var n=$("#app-main");n.append(e),n.find(".tab01").removeClass("hide"),n.find(".tab01 > p").animate({opacity:0},2333,function(){t.redirect("/")})});return}if(!i&&p==="VERIFY"&&v==="VERIFIED"){t.render(m,function(e){var t=$("#app-main");t.append(e),$("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)});return}if(v==="INPUT_NEW_PASSWORD"){var g;m="forgot_password.html",t.render(m,function(e){$("#app-main").append(e);if(a&&!f){var t=r.find(u.identities,function(e){if(e.id===h)return!0});p==="VERIFY"?(g=$('<div class="merge set-up" data-destory="true" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_email">'),g.data("source",{browsing_user:u,identity:t,originToken:o,user_name:c.user_name,tokenType:"user"})):p==="SET_PASSWORD"&&(g=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),g.data("source",{user:u,token:c.setup?a.token:o,setup:c.setup})),g.appendTo($("#app-tmp")),g.trigger("click.dialog.data-api")}else p==="VERIFY"?(s.once("app:user:signin:after",function(){var e=$('<div class="addidentity" data-destory="true" data-widget="dialog" data-dialog-type="addIdentityAfterSignIn">');e.data("source",{identity:l.identities[0]}),e.appendTo($("#app-tmp")),e.trigger("click.dialog.data-api")}),$("#app-user-menu").find(".set-up").trigger("click.dialog.data-api")):(g=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),g.data("source",{user:l,token:c.setup?f.token:o,setup:c.setup}),g.appendTo($("#app-tmp")),g.trigger("click.dialog.data-api"));$(".modal-su, .modal-sp, .modal-bi").css("top",230)})}delete n.browsing_authorization,delete n.resolveData,delete n.originToken},a.cross=function(e,t){var n=e.session,r=n.authorization,i=n.user;if(!r){s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0],null);return}s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),n.initMenuBar||(s.emit("app:usermenu:updatenormal",i),s.emit("app:usermenu:crosslist",r.token,r.user_id));var o=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",o)})},s.on("app:cross:forbidden",function(e,t){$("#app-main").load("/static/views/forbidden.html",function(){var e=u.get("authorization"),n={options:{keyboard:!1,backdrop:!1,viewData:{cls:"modal-id"}}};t&&$(".sign-in").data("source",t.external_username);if(!e)$(".sign-in").data("dialog-settings",n),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide"),$(".please-signin").removeClass("hide"),$(".modal-id").css("top",260);else{var r=u.get("user");$(".details").removeClass("hide"),$(".details .avatar img").attr("src",r.avatar_filename),$(".details .identity-name").text(r.name),$(".please-access").removeClass("hide"),$(".modal-id").css({top:380})}})}),a.crossInvitation=function(e,t){var n=e.session,u=n.authorization,a=n.user,f=a&&a.id,l=e.params[0],c=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!!u),u&&(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",u.token,u.user_id)),i.request("getInvitationByToken",{type:"POST",resources:{cross_id:l},data:{token:c}},function(e){var n=e.invitation,i=n.identity,c=n.by_identity,h;if(f){h=r.find(a.identities,function(e){if(e.connected_user_id===i.connected_user_id&&e.id===i.id)return!0});if(h){t.redirect("/#!"+l);return}}if(i.provider==="email"){s.emit("app:cross:forbidden",l,i);return}t.render("invite.html",function(e){$("#app-main").append(e),u?($(".please-access").removeClass("hide"),$(".form-horizontal").addClass("fh-left"),$(".details").removeClass("hide"),$(".details .avatar img").attr("src",a.avatar_filename),$(".details .identity-name").text(a.name)):$(".please-signin").removeClass("hide"),$(".invite-to").find("img").attr("src",i.avatar_filename).parent().next().text(o.printExtUserName(i)),$(".invite-from").find("img").attr("src",c.avatar_filename).parent().next().text(o.printExtUserName(c));var t=$(".x-invite").find(".redirecting"),n=t.next(),r=!1;$(".xbtn-authenticate").on("click",function(e){e.stopPropagation(),e.preventDefault();if(r)return;var i=$(this).data("oauth");$.ajax({url:"/OAuth/Authenticate?provider="+i,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(){r=!0,n.addClass("hide"),t.removeClass("hide")},success:function(e){r=!1;var i=e.meta.code;i===200?window.location.href=e.response.redirect:(t.addClass("hide"),n.removeClass("hide"))}})})})},function(e){e.meta.code===404&&t.location("/404")})};var f=function(e,t,n,r,o,a,f,l,c,h){var p=t.session,d=p.authorization,v=p.user;i.request("getCrossByInvitationToken",{type:"POST",params:r,data:o},function(t){function g(){e.render("x.html",function(e){$("#app-main").empty().append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,r,o,m,f,!!c);if(h){var t=$('<div id="js-dialog-unsubscribe" data-destory="true" data-widget="dialog" data-dialog-type="unsubscribe">');t.data("source",o),t.appendTo($("#app-tmp")),t.trigger("click.dialog.data-api")}})}var n=t.authorization,r=t.browsing_identity,i=t.action,o=t.cross,d=t.cross_access_token,m=t.read_only;!1===m&&d&&(a||(a={}),a[l]=d,u.set("cats",a)),s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0);if(n||!r){if(!p.initMenuBar){if(n){s.once("app:user:signin:after",function(){e.redirect("/#!"+o.id)}),s.emit("app:user:signin",n.token,n.user_id);return}e.redirect("/#!"+o.id)}}else r&&s.emit("app:usermenu:updatebrowsing",{normal:v,browsing:{identities:[r],name:r.name},action:i,setup:i==="setup",originToken:l,tokenType:"cross",page:"cross",readOnly:m},"browsing_identity");g()},function(t){var n=t&&t.meta&&t.meta.code,r=!!d;403===n?(s.emit("app:page:home",!1),s.emit("app:page:usermenu",r),r&&(s.emit("app:usermenu:updatenormal",v),s.emit("app:usermenu:crosslist",d.token,d.user_id)),s.emit("app:cross:forbidden",null,null)):404===n&&e.location("/404")})};a.crossToken=function(e,t,n){var r=e.session,i=r.authorization,s=i&&i.token,o=e.params[0],a=e.params[1],l=a==="accept",c=a==="mute",h=u.get("cats"),p,d={},v;s&&(d.token=s),h&&(p=h[o]),v={invitation_token:o},p&&(v.cross_access_token=p),f(t,e,n,d,v,h,p,o,l,c)},a.crossPhoneToken=function(e,t,n){var r=e.session,i=r.authorization,s=i&&i.token,o=e.params[0],a=e.params[1],l=e.params[2],c=l==="accept",h=l==="mute",p=u.get("cats"),d={},v,m;s&&(d.token=s),p&&(v=p[a]),m={invitation_token:a,cross_id:o},v&&(m.cross_access_token=v),f(t,e,n,d,m,p,v,a,c,h)},a.profile=function(e,t){var n=e.session,r=n.authorization,i=n.user,a=n.browsing_authorization,f=n.browsing_user,l=n.action,c=n.oauth;s.emit("app:page:home",!1);var h=e.params[2],p=h&&h.match(o.tokenRegExp),d=p&&p[1];if(d&&!a){t.redirect("/#token="+d);return}r||a?(document.title="EXFE - Profile",s.emit("app:page:usermenu",!0),r&&!a?(s.emit("app:usermenu:updatenormal",i),s.emit("app:usermenu:crosslist",r.token,r.user_id),t.render("profile.html",function(e){$("#app-main").data("event",n.event),delete n.event,$("#app-main").append(e),s.emit("app:profile:identities",i);var t=$.Deferred(),o=$.Event("click.dialog.data-api");t.resolve(r),s.emit("app:profile:show",t),c?(c.identity_status!=="connected"&&(o.following=c.following,o.identity=c.identity,o.token=r.token,$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-destory="true"></div>').appendTo($("#app-tmp")).trigger(o)),u.remove("oauth"),delete n.oauth):n.verification_token&&($('<div id="app-oauth-resetpassword" class="hide" data-widget="dialog" data-dialog-type="setpassword" data-destory="true"></div>').data("token",n.verification_token).appendTo($("#app-tmp")).trigger(o),delete n.verification_token)})):a?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:i,browsing:f,action:l,setup:l==="INPUT_NEW_PASSWORD",originToken:n.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete n.originToken,t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",f);var t=$.Deferred();t.resolve(a),s.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/")},a.invalid=function(e,t){var n=e.session,r=n.authorization,i=n.user;document.title="EXFE - Invalid Link",s.emit("app:page:home",!1),r?(s.emit("app:page:usermenu",!0),s.emit("app:usermenu:updatenormal",i),s.emit("app:usermenu:crosslist",r.token,r.user_id)):s.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},a.signout=function(){u.remove("cats"),u.remove("user"),u.remove("authorization"),window.location.href="/"},a.refreshAuthUser=function(e,t,n){var r=e.session,i=r.authorization;if(!i){n();return}s.emit("app:api:getuser",i.token,i.user_id,function(e){var t=e.user;u.set("user",r.user=t);if(0===t.identities.length){a.signout();return}n()},function(e){var t=e&&e.meta&&e.meta.code;401===t&&(u.remove("user"),u.remove("authorization"),delete r.user,delete r.authorization),n()})}});