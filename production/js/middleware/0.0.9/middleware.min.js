define("middleware",function(e,t,n){"use strict";function u(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n}var r=e("bus"),i=e("store"),s=e("jquery"),o=n.exports={};o.basicAuth=function(e,t,n){var r=e.session,s=i.get("authorization"),o=i.get("user"),a=u();s&&(!a||a&&!a.authorization)?(r.authorization=s,r.user=o):!s&&a&&a.authorization&&a.data&&!a.event?(i.set("oauth",r.oauth={identity:a.data.identity,following:a.data.identity.provider==="twitter"?!!a.data.twitter_following:!1,identity_status:a.data.identity_status}),delete r.user,i.remove("user"),i.set("authorization",r.authorization=a.authorization)):s&&a&&a.authorization&&a.data&&!a.event&&(s.user_id===a.authorization.user_id&&s.token!==a.authorization.token?(s.token=a.authorization.token,i.set("authorization",r.authorization=s)):s.user_id!==a.authorization.user_id&&s.token!==a.authorization.token&&a.identity&&(i.set("oauth",r.oauth={identity:a.data.identity,following:a.data.identity.provider==="twitter"?!!a.data.twitter_following:!1,identity_status:a.data.identity_status}),delete r.user,i.remove("user"),i.set("authorization",r.authorization=a.authorization))),a&&(a.event&&(r.event=JSON.parse(a.event),r.event.data=a.data),a.verification_token&&(r.verification_token=a.verification_token),a.refere&&a.refere!==window.location.protocol+"//"+window.location.hostname+"/"&&(window.location.href=a.refere||"/")),n()},o.errorHandler=function(e,t){var n=/^\/404/;if(n.exec(window.location.pathname)){r.emit("app:page:home",!1,!0);var s=i.get("authorization");r.emit("app:page:usermenu",!!s);if(s){var o=i.get("user");r.emit("app:usermenu:updatenormal",o),r.emit("app:usermenu:crosslist",s.token,s.user_id)}return}t.location("/404")},o.cleanupAppTmp=function(e,t,n){var r=s("#app-tmp"),i=r.find("[data-widget-id]");i.trigger("destory.widget"),n()},o.fixedFaceBookURL=function(e,t,n){if(window.location.hash==="#_=_"){window.location.hash="",e.updateUrl();if(s.browser.mozilla)return}n()}});