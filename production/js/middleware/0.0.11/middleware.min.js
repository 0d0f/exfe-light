define("middleware",function(t,e,i){"use strict";function a(){var t=document.getElementsByTagName("head")[0],e=document.getElementsByName("authorization")[0],i=null;return e&&(i=JSON.parse(e.content),t.removeChild(e)),i}var o=t("bus"),n=t("store"),r=t("jquery"),u=i.exports={};u.basicAuth=function(t,e,i){var o=t.session,r=n.get("authorization"),u=n.get("user"),d=a();r&&(!d||d&&!d.authorization)?(o.authorization=r,o.user=u):!r&&d&&d.authorization&&d.data&&!d.event?(n.set("oauth",o.oauth={identity:d.data.identity,following:"twitter"===d.data.identity.provider?!!d.data.twitter_following:!1,identity_status:d.data.identity_status}),delete o.user,n.remove("user"),n.set("authorization",o.authorization=d.authorization)):r&&d&&d.authorization&&d.data&&!d.event&&(r.user_id===d.authorization.user_id&&r.token!==d.authorization.token?(r.token=d.authorization.token,n.set("authorization",o.authorization=r)):r.user_id!==d.authorization.user_id&&r.token!==d.authorization.token&&d.identity&&(n.set("oauth",o.oauth={identity:d.data.identity,following:"twitter"===d.data.identity.provider?!!d.data.twitter_following:!1,identity_status:d.data.identity_status}),delete o.user,n.remove("user"),n.set("authorization",o.authorization=d.authorization))),d&&(d.event&&(o.event=JSON.parse(d.event),o.event.data=d.data),d.verification_token&&(o.verification_token=d.verification_token),d.refere&&d.refere!==window.location.protocol+"//"+window.location.hostname+"/"&&e.redirect(d.refere||"/")),i()},u.errorHandler=function(t,e){var i=/^\/404/;if(i.exec(window.location.pathname)){o.emit("app:page:home",!1,!0);var a=n.get("authorization");if(o.emit("app:page:usermenu",!!a),a){var r=n.get("user");o.emit("app:usermenu:updatenormal",r),o.emit("app:usermenu:crosslist",a.token,a.user_id)}}else e.location("/404")},u.cleanupAppTmp=function(t,e,i){var a=r("#app-tmp");a.find("[data-widget-id]").trigger("destory.widget"),a.children().off().remove(),r(".x-tmp").off().remove(),i()},u.fixedFaceBookURL=function(t,e,i){"#_=_"===window.location.hash&&(window.location.hash="",t.updateUrl(),r.browser.mozilla)||i()}});