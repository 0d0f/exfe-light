define("middleware",function(e,t,i){"use strict";function n(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],i=null;return t&&(i=JSON.parse(t.content),e.removeChild(t)),i}var a=e("bus"),r=e("store"),s=e("jquery"),o=i.exports={};o.basicAuth=function(e,t,i){var a=e.session,s=r.get("authorization"),o=r.get("user"),l=n(),c=l&&l.authorization,d=l&&l.data,u=l&&l.event;!s||l&&c?!s&&c&&d&&!u?(r.set("oauth",a.oauth={identity:d.identity,following:"twitter"===d.identity.provider?!!d.twitter_following:!1,identity_status:d.identity_status}),delete a.user,r.remove("user"),r.set("authorization",a.authorization=c)):s&&c&&d&&!u&&(s.user_id===c.user_id&&s.token!==c.token?(s.token=c.token,r.set("authorization",a.authorization=s)):s.user_id!==c.user_id&&s.token!==c.token&&d.identity&&(r.set("oauth",a.oauth={identity:d.identity,following:"twitter"===d.identity.provider?!!d.twitter_following:!1,identity_status:d.identity_status}),delete a.user,r.remove("user"),r.set("authorization",a.authorization=c))):(a.authorization=s,a.user=o),l&&(u&&(a.event=JSON.parse(u),a.event.data=d),l.verification_token&&(a.verification_token=l.verification_token),l.refere&&l.refere!==window.location.protocol+"//"+window.location.hostname+"/"&&t.redirect(l.refere||"/")),i()},o.errorHandler=function(e,t){var i=/^\/404/;if(i.exec(window.location.pathname)){a.emit("app:page:home",!1,!0);var n=r.get("authorization");if(a.emit("app:page:usermenu",!!n),n){var s=r.get("user");a.emit("app:usermenu:updatenormal",s),a.emit("app:usermenu:crosslist",n.token,n.user_id)}}else t.location("/404")},o.cleanupAppTmp=function(e,t,i){var n=s("#app-tmp");n.find("[data-widget-id]").trigger("destory.widget"),n.children().off().remove(),s(".x-tmp").off().remove(),i()},o.fixedFaceBookURL=function(e,t,i){"#_=_"===window.location.hash&&(window.location.hash="",e.updateUrl(),s.browser.mozilla)||i()}});