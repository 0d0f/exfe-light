define("middleware",function(e,t,i){"use strict";function n(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],i=null;return t&&(i=JSON.parse(t.content),e.removeChild(t)),i}var r=e("bus"),a=e("store"),s=e("jquery"),o=i.exports={};o.basicAuth=function(e,t,i){var r=e.session,s=a.get("authorization"),o=a.get("user"),l=n();s&&(!l||l&&!l.authorization)?(r.authorization=s,r.user=o):!s&&l&&l.authorization&&l.data&&!l.event?(a.set("oauth",r.oauth={identity:l.data.identity,following:"twitter"===l.data.identity.provider?!!l.data.twitter_following:!1,identity_status:l.data.identity_status}),delete r.user,a.remove("user"),a.set("authorization",r.authorization=l.authorization)):s&&l&&l.authorization&&l.data&&!l.event&&(s.user_id===l.authorization.user_id&&s.token!==l.authorization.token?(s.token=l.authorization.token,a.set("authorization",r.authorization=s)):s.user_id!==l.authorization.user_id&&s.token!==l.authorization.token&&l.identity&&(a.set("oauth",r.oauth={identity:l.data.identity,following:"twitter"===l.data.identity.provider?!!l.data.twitter_following:!1,identity_status:l.data.identity_status}),delete r.user,a.remove("user"),a.set("authorization",r.authorization=l.authorization))),l&&(l.event&&(r.event=JSON.parse(l.event),r.event.data=l.data),l.verification_token&&(r.verification_token=l.verification_token),l.refere&&l.refere!==window.location.protocol+"//"+window.location.hostname+"/"&&t.redirect(l.refere||"/")),i()},o.errorHandler=function(e,t){var i=/^\/404/;if(i.exec(window.location.pathname)){r.emit("app:page:home",!1,!0);var n=a.get("authorization");if(r.emit("app:page:usermenu",!!n),n){var s=a.get("user");r.emit("app:usermenu:updatenormal",s),r.emit("app:usermenu:crosslist",n.token,n.user_id)}}else t.location("/404")},o.cleanupAppTmp=function(e,t,i){var n=s("#app-tmp"),r=n.find("[data-widget-id]");r.trigger("destory.widget"),i()},o.fixedFaceBookURL=function(e,t,i){"#_=_"===window.location.hash&&(window.location.hash="",e.updateUrl(),s.browser.mozilla)||i()}});