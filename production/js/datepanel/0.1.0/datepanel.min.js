define("datepanel",function(e){"use strict";var t=e("rex"),n=e("jquery"),r=n.proxy,i=e("api"),s=e("eftime"),o=s.locales[s.locale],u=o.monthsShort,a=o.months,f=s.lead0,l=s.h12,c=e("panel"),h=c.extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel" editarea="date-panel"><div class="panel-body"><div class="pull-left date-container"><input type="text" name="date-string" id="date-string" autocomplete="off" /><div class="date-calendar" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="year"></div><div class="full-month"></div><div class="table-wrapper"><table class="table" id="date-table"><tbody></tbody></table></div></div></div><div class="pull-right date-timeline"> <div class="fuzzy-time">   <ul class="unstyled time-cates">     <li data-cate="all-day">All-day</li>     <li class="hide" data-time="00:01" data-cate="late-night">Late-night</li>     <li class="hide" data-time="05:00" data-cate="dawn">Dawn</li>     <li class="hide" data-time="07:00" data-cate="breakfast">Breakfast</li>     <li class="hide" data-time="08:30" data-cate="morning">Morning</li>     <li class="hide" data-time="10:00" data-cate="brunch">Brunch</li>     <li class="hide" data-time="11:30" data-cate="lunch">Lunch</li>     <li class="hide" data-time="13:00" data-cate="noon">Noon</li>     <li class="hide" data-time="14:30" data-cate="afternoon">Afternoon</li>     <li class="hide" data-time="16:00" data-cate="tea-break">Tea-break</li>     <li class="hide" data-time="17:30" data-cate="off-work">Off-work</li>     <li class="hide" data-time="19:00" data-cate="dinner">Dinner</li>     <li class="hide" data-time="20:30" data-cate="evening">Evening</li>     <li class="hide" data-time="22:00" data-cate="night">Night</li>     <li class="hide" data-time="24:00" data-cate="late-night">Late-night</li>   </ul> </div> <div class="times-wrapper">   <div class="times"></div> </div></div></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var e=this.options;this.render(),this.originEftime=e.eftime,this.eftime=Cross.time,this.dateObj=s.toDate(this.eftime),delete e.eftime,this.dateInput=new p(this,"#date-string"),this.calendarTable=new d(this,".date-calendar"),this.timeline=new v(this,".date-timeline"),this.originEftime.begin_at.timezone=this.eftime.begin_at.timezone=this.dateInput.timezone,this.listen(),this.initBuild()},initBuild:function(){var e=this.eftime,t=this.dateObj.date;this.dateInput.change(e.origin||t.text),this.calendarTable.refresh(t),this.timeline.refresh(e),this.selectDefault()},selectDefault:function(){this.originEftime.outputformat||(this.calendarTable.setCursorClass(),this.calendarTable.select(!0),this.timeline.select(this.eftime))},listen:function(){this.element.on("keydown.datepanel",r(this.keydown,this)),this.on("dateinput-tab",this.dateInputTab),this.on("calendartable-tab",this.calendarTableTab),this.on("refresh-calendar",this.refreshCalendar),this.on("save",this.save),this.on("refresh-from-dateinput",this.refreshFromDI),this.on("refresh-from-calendartable",this.refreshFromCT),this.on("refresh-from-timeline",this.refreshFromTL),this.on("change",this.change)},refreshFromDI:function(e){n.extend(!0,this.eftime,e),this.dateObj=s.toDate(e),this.calendarTable.refresh(this.dateObj.date),this.timeline.refresh(e)},refreshFromCT:function(e){var t=this.eftime,n=this.dateObj.date,r="",i=e.split("-");n.setFullYear(i[0]),n.setMonth(i[1]-1),n.setDate(i[2]),r=n.getUTCFullYear()+"-"+(n.getUTCMonth()+1)+"-"+n.getUTCDate(),t.begin_at.date=r;if(t.outputformat)t.outputformat=0,t.origin=e;else{var s="";t.begin_at.time?s=f(n.getHours())+":"+f(n.getMinutes()):(s=t.begin_at.time_word,t.begin_at.date=e),s?s=e+" "+s:s=e,t.origin=s}this.dateInput.change(t.origin)},refreshFromTL:function(e,t){var n=this.eftime,r=this.dateObj.date,i="";n.begin_at.time="";if(e){var s=e.split(":");r.setHours(s[0]||0),r.setMinutes(s[1]||0),r.setSeconds(s[2]||0),n.begin_at.time=r.getUTCHours()+":"+r.getMinutes()+":"+r.getSeconds()}n.begin_at.time_word=t,i=e||t,n.outputformat?(n.outputformat=0,n.origin=i):(n.begin_at.date&&(i=m(r)+" "+i),n.origin=i),this.dateInput.change(n.origin)},keydown:function(e){var t=this,n=e.altKey,r=e.ctrlKey,i=e.shiftKey,s=e.metaKey,o=e.keyCode;27===o?(t.revert(),t.emit("save")):13===o&&!(n|i)&(r|s)&&t.emit&&t.emit("save")},save:function(){n("body").trigger("click")},revert:function(){n.extend(!0,this.eftime,this.originEftime)},refreshCalendar:function(e){n.extend(!0,this.eftime,e),this.date=s.toDate(e),this.calendarTable.refresh(this.date),this.timeline.refresh(this.eftime)},dateInputTab:function(){var e=this.calendarTable;setTimeout(function(){e.$element.focus()},0)},calendarTableTab:function(){var e=this.dateInput,t=this.calendarTable;setTimeout(function(){e.$element.focus()},0)},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),n=this.element.outerWidth();this.element.css({left:t.left-n-15,top:t.top})}this.dateInput.$element.focusend(),this.calendarTable.scrollTop(132),this.timeline.select(this.eftime)},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),p=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.befer=null,this.timezone=y(),this.listen()};p.prototype={change:function(e){this.$element.val(e)},listen:function(){var e=this.$container,t=this.selector;e.on("keypress.datepanel",t,n.proxy(this.keypress,this)).on("keyup.datepanel",t,n.proxy(this.keyup,this)).on("keydown.datepanel",t,n.proxy(this.keydown,this))},keyup:function(e){switch(e.keyCode){case 9:case 13:case 16:case 17:case 18:case 27:case 38:case 40:break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this.component,n=e.keyCode;switch(n){case 9:e.preventDefault(),t.emit("dateinput-tab");break;case 13:e.preventDefault(),t.emit("save")}},keypress:function(e){if(this.suppressKeyPressRepeat)return!1;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~t.indexOf([9,13],e.keyCode),this.keyHandler(e)},lookup:function(e){var t=this,r=t.component,o=n.trim(t.$element.val());t.befer&&t.befer.abort();if(""===o){var u=s.create();r.emit("refresh-from-dateinput",u);return}t.befer=i.request("recognize",{type:"POST",data:{time_string:o,timezone:t.timezone}},function(e){r.emit("refresh-from-dateinput",e.cross_time)})}};var d=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.today=new Date,this.todayString=m(this.today),this.coords=[0,0],this.vpRows=3,this.vpHeight=44,this.len=0,this.$cursor=null,this.divTemp='<div class="tw"><span class="m hide">{{m}}</span><span class="d">{{d}}</span></div>',this.$tableWrapper=this.$element.find(".table-wrapper"),this.$table=this.$tableWrapper.find("table"),this.$tbody=this.$table.find("tbody"),this.$trs=null,this.$year=this.$element.find(".year"),this.$fullMonth=this.$element.find(".full-month"),this.listen()};d.prototype={initCalendar:function(e){var t=this.vpRows,n=e.getFullYear(),r=e.getMonth(),i=this.vpHeight,s=e.getDay(),e=new Date(n,r,e.getDate()-s-21);this.startDate=m(e),this.nextPend(e),this.nextPend(e),this.nextPend(e),this.endDate=m(e),this.coords=[s,t],this.$trs=this.$tbody.find("tr"),this.scrollTop(i*t),this.updateYearMonth(n,a[r])},refresh:function(e){this.len=0,this.$tbody.empty(),this.$str=this.$select=this.$cursor=null,this.initCalendar(e)},getSelectedDate:function(){return this.selectedDate||this.todayString},setCursorClass:function(){this.$cursor=this.$trs.eq(this.coords[1]).find("td").eq(this.coords[0]).addClass("hover")},removeCursorClass:function(){this.$cursor&&this.$cursor.removeClass("hover")},scrollTop:function(e){this.$tableWrapper.scrollTop(e)},listen:function(){var e=this.$container,t=this.selector,n=this.$tableWrapper;e.on("blur.datepanel",t,r(this.blur,this)).on("keypress.datepanel",t,r(this.keypress,this)).on("keyup.datepanel",t,r(this.keyup,this)).on("keydown.datepanel",t,r(this.keydown,this)).on("focus.datepanel",t,r(this.focus,this)).on("mouseenter.datepanel",t+" td",r(this.tdMouseenter,this)).on("click.datepanel",t+" td",r(this.tdClick,this)),n.on("scroll.datepanel",r(this.scroll,this))},scroll:function(e){e.stopPropagation(),e.preventDefault();var t=this.$tableWrapper,n=t.scrollTop();if(n===0)this.pageUp(this.coords),t.scrollTop(132),this.$year.addClass("hide"),this.$fullMonth.addClass("hide");else if(n===277)this.pageDown(this.coords),this.$year.addClass("hide"),this.$fullMonth.addClass("hide");else if(this.$cursor){var r=g(this.$cursor.data("date"));this.updateYearMonth(r.getFullYear(),a[r.getMonth()])}},updateYearMonth:function(e,t){this.$year.removeClass("hide").html(e),this.$fullMonth.removeClass("hide").html(t)},tdClick:function(e){e.preventDefault(),this.moveSpacing()},tdMouseenter:function(e){e.preventDefault(),this.removeCursorClass();var t=n(e.currentTarget),r=t.parent();this.coords[0]=t.index(),this.coords[1]=r.index(),this.setCursorClass()},blur:function(e){this.removeCursorClass()},focus:function(e){this.setCursorClass()},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keyup:function(e){e.stopPropagation(),e.preventDefault()},keydown:function(e){this.suppressKeyPressRepeat=!!~t.indexOf([9,13,32,33,34,35,36,37,38,39,40],e.keyCode),this.keyHandler(e)},keyHandler:function(e){var t=this,n=this.component,r=this.coords,i=e.keyCode;switch(i){case 9:e.preventDefault(),n.emit("calendartable-tab");break;case 37:e.preventDefault(),t.moveWrapper(r,"moveLeft");break;case 38:e.preventDefault(),t.moveWrapper(r,"moveTop");break;case 39:e.preventDefault(),t.moveWrapper(r,"moveRight");break;case 40:e.preventDefault(),t.moveWrapper(r,"moveDown");break;case 33:e.preventDefault(),t.moveWrapper(r,"pageUp");break;case 34:e.preventDefault(),t.moveWrapper(r,"pageDown");break;case 13:e.preventDefault();break;case 32:e.preventDefault(),t.moveSpacing();break;case 35:case 36:}},moveSpacing:function(){this.selectedDate&&this.$trs.find('td[data-date="'+this.selectedDate+'"]').removeClass("selected"),this.select()},select:function(e){var t=this.selectedDate=this.$cursor.data("date");this.$cursor.addClass("selected"),e||this.component.emit("refresh-from-calendartable",t)},generateHTML:function(e){var t=this.vpRows,n=this.todayString,r=this.selectedDate,i=this.divTemp,s=0,o="";this.len+=t;for(;s<t;++s){var a=0,f="<tr>",l="",c,h,p,d;for(;a<7;++a){d="",c=m(e),h=c===n,p=c===r,h&&(d+="today"),p&&(d+=(d.length?" ":"")+"selected"),l+='<td data-date="'+c+'"'+(d?' class="'+d+'"':"")+">";var v=i,g=e.getDate();l+=v.replace("{{m}}",u[e.getMonth()]).replace("{{d}}",h?"Today":g),l+="</td>",e.setDate(g+1)}f+=l+"</tr>",o+=f}return o},prevPend:function(e){this.$tbody.prepend(this.generateHTML(e))},nextPend:function(e){this.$tbody.append(this.generateHTML(e))},delFirst:function(){var e=this.$trs.first();this.startDate=e.find("td").data("date"),this.$trs.eq(0).remove(),this.$trs.eq(1).remove(),this.$trs.eq(2).remove(),this.len-=3},delLast:function(){var e=this.$trs.eq(this.len-3);this.endDate=e.find("td").data("date"),this.$trs.eq(this.len-1).remove(),this.$trs.eq(this.len-2).remove(),e.remove(),this.len-=3},moveWrapper:function(e,t){this.removeCursorClass(),this[t](e),this.setCursorClass()},moveLeft:function(e){0===e[0]--&&(e[0]=6,this.moveTop(e))},moveTop:function(e){if(0===e[1]--){this.delLast();var t=g(this.startDate,-21);this.startDate=m(t),this.prevPend(t),this.$trs=this.$tbody.find("tr"),e[1]=2,this.$tableWrapper.scrollTop(this.vpHeight*e[1])}var n=this.$tableWrapper.scrollTop();e[1]*this.vpHeight<n&&this.$tableWrapper.scrollTop(n-=this.vpHeight)},moveRight:function(e){6===e[0]++&&(e[0]=0,this.moveDown(e))},moveDown:function(e){if(this.len===++e[1]){this.delFirst();var t=g(this.endDate,0);this.nextPend(t),this.endDate=m(t),this.$trs=this.$tbody.find("tr"),e[1]=this.len-2,this.$tableWrapper.scrollTop(this.vpHeight*5)}var n=this.$tableWrapper.scrollTop();e[1]*this.vpHeight>n+this.vpHeight*(this.vpRows-1)&&this.$tableWrapper.scrollTop(n+=this.vpHeight)},pageUp:function(e){if(e[1]<=this.vpRows){this.delLast();var t=g(this.startDate,-21);this.startDate=m(t),this.prevPend(t),this.$trs=this.$tbody.find("tr"),e[1]+=this.vpRows}else{var n=this.$tableWrapper.scrollTop();this.$tableWrapper.scrollTop(n-=this.vpHeight*this.vpRows)}e[1]-=this.vpRows},pageDown:function(e){if(e[1]>=this.len-this.vpRows){this.delFirst();var t=g(this.endDate,0);this.nextPend(t),this.endDate=m(t),this.$trs=this.$tbody.find("tr"),e[1]-=this.vpRows,this.$tableWrapper.scrollTop(this.vpHeight*3)}e[1]+=this.vpRows;var n=this.$tableWrapper.scrollTop();this.$tableWrapper.scrollTop(n+=this.vpHeight*this.vpRows)}};var v=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.divTmp='<div class="time-item{{class}}" data-time="{{dt}}"><time>{{t}}</time></div>',this.$fuzzyTime=this.$element.find(".fuzzy-time"),this.$timesWrapper=this.$element.find(".times-wrapper"),this.$timesContainer=this.$timesWrapper.find(".times"),this.isMouseEnter=!1,this.mX=0,this.mY=0,this.n=0,this._b=7,this._e=7,this._l=9,this.generateHTML(),this.selectedTime="";var r=this.times=[];this.$times=this.$element.find("ul.time-cates [data-time]").each(function(e,t){r.push(n(t).data("time"))}),this.len=this.$times.length,this.listen()};v.prototype={refresh:function(e){this.removeSelected(),this.select(e)},select:function(e){if(e&&0===e.outputformat)if(e.begin_at.time){var t=s.toDate(e).date,n=Math.round(t.getMinutes()/15)*15;t.setMinutes(n),this.selectedTime=f(t.getHours())+":"+f(t.getMinutes()),this.$selected=this.$timesWrapper.find('[data-time="'+this.selectedTime+'"]').addClass("selected"),this.$selected.size()||(this.$selected=this.createTimeItem(t.getHours(),t.getMinutes(),(t.getHours()+Math.round(t.getMinutes()/60))*5*12/3," selected")),this.scrollTop(this.$selected.position().top)}else this.scrollTop(180);else this.scrollTop(180)},getSelectedTime:function(){return this.selectedTime},getRealHeight:function(){this.realHeight=this.$timesWrapper.prop("scrollHeight")},scrollTop:function(e){this.$timesWrapper.scrollTop(e)},listen:function(){var e=this.$container,t=this.selector;e.on("click.datepanel",t+" .time-cates li[data-cate]",r(this.cateClick,this)).on("mouseleave.datepanel",t,r(this._mouseleave,this)).on("mouseenter.datepanel, mousemove.datepanel",t+" .times-wrapper",r(this._mousemove,this)).on("click.datepanel",t+" .times-wrapper",r(this._click,this)),this.$timesWrapper.on("scroll.datepanel",r(this._scrollTop,this))},_click:function(e){e.stopPropagation(),e.preventDefault(),this.$selected&&this.$selected.removeClass("selected"),this.$selected=this.$item.addClass("selected"),this.component.emit("refresh-from-timeline",this.selectedTime=this.$item.data("time"),"")},_scrollTop:function(e){e.pageX=this.pX||0,e.pageY=this.pY||0,this._mousemove(e)},_mouseleave:function(e){e&&(e.stopPropagation(),e.preventDefault());var t=this.$item;t&&t.size()&&(t.removeClass("time-hover"),!t.hasClass("time-label")&&!t.hasClass("selected")&&t.remove()),this.$fuzzyTime.addClass("hide"),delete this.$item},_mousemove:function(e){e.stopPropagation(),e.preventDefault(),this.realHeight||(this.getRealHeight(),this.offset=this.$timesWrapper.offset(),this._h=Math.floor((this.realHeight-this._b-this._e)/(this._l-1)/12),this._a=Math.round(15/this._h));var t=this.$timesWrapper.scrollTop();this.pX=e.pageX,this.pY=e.pageY,this.mX=this.pX-this.offset.left,this.mY=this.pY-this.offset.top+t-7,this.mY<0?this.mY=0:this.mY>(this._l-1)*this._h*12&&(this.mY=(this._l-1)*this._h*12),this.genHoverItem(),this.$fuzzyTime.removeClass("hide"),this.showFuzzyTime(e)},cateClick:function(e){var t=n(e.currentTarget);this.removeSelected(),this.component.emit("refresh-from-timeline","",t.text())},createTimeItem:function(e,t,r,i,s){var o=this.divTmp,u=f(e)+":"+f(t),e=e===24?0:e,a=n(o.replace("{{class}}",i).replace("{{dt}}",u).replace("{{t}}",(s?e===12?e:e%12:e+":"+f(t))+" "+(e<12?"AM":"PM"))).css("top",r);return this.$timesContainer.append(a),a},genHoverItem:function(){var e=this.$timesWrapper.find(".times"),t=Math.round(this.mY/this._h)*this._h,n=t*this._a,r=Math.floor(n/60).toFixed(0),i=n%60,s=f(r)+":"+f(i),o;this._dh=r,this._dm=i,this._mouseleave(),(o=e.find('[data-time="'+s+'"]')).size()?this.$item=o.addClass("time-hover"):this.$item=this.createTimeItem(r,i,t," time-hover")},showFuzzyTime:function(e){var n=0,r=this.$timesWrapper,i=this.times,s,o=new Date(2012,12,21,this._dh,this._dm),u;t.find(i,function(e,t){s=e.split(":"),u=new Date(2012,12,21,s[0],s[1]);if(o<u)return n=t,!0}),n||(n=1),+this._dh===24&&(n=14),n-=1,this.$times.addClass("hide").eq(n).removeClass("hide"),+this._dh>=5&&this._dh<22&&(this.$times.eq(n-1).removeClass("hide"),this.$times.eq(n+1).removeClass("hide"));var a=e.pageY-r.offset().top-7,f=this.$times.not(".hide").length;this.$fuzzyTime.css("top",a-(f+1)/2*18+"px")},itemClick:function(e){this.$selected&&this.$selected.removeClass("selected");var t=n(e.currentTarget),r=t.data("time");this.$selected=t.addClass("selected"),this.component.emit("refresh-from-timeline",this.selectedTime=r,"")},removeSelected:function(){this.$selected&&(this.$selected.removeClass("selected"),this.$selected=null,this.selectedTime="")},generateHTML:function(){var e=this.divTmp,t="",n=0,r=this._l,i=180,s=new Date(2012,12,21,21,0),o=0,u=0;for(;n<r;++n)s.setMinutes(s.getMinutes()+i),o=s.getHours(),u=s.getMinutes(),t=e,n===8&&(o=24),this.createTimeItem(o,u,60*n," time-label",!0)}};var m=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},g=function(e,t){return t||(t=0),e=e.split("-"),new Date(e[0],+e[1]-1,+e[2]+t)},y=function(){var e=(new Date).toString(),t=e.replace(/^.*([\+\-]\d\d):?(\d\d).*$/,"$1:$2"),n=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return n=n==="UTC"||n==="GMT"?"":n,t+(n?" "+n:"")};return h});