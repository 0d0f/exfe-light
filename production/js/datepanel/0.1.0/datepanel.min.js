define("datepanel",function(e){"use strict";var t=e("jquery"),n=t.browser.msie,r=e("eftime"),i=r.locales[r.locale],s=i.monthsShort,o=i.monthsShort,u=r.create,a=r.toDate,f=r.lead0,l=e("util"),c=l.trim,h=e("api"),p=e("rex"),d=e("panel").extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel" editarea="date-panel"><div class="panel-body"><div class="pull-left date-container"><input type="text" name="date-string" id="date-string" autocomplete="off" /><div class="date-calendar" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="year"></div><div class="full-month"></div><div class="table-wrapper"><table class="table" id="date-table"><tbody></tbody></table></div></div></div><div class="pull-right date-timeline"> <div class="fuzzy-time hide">   <ul class="unstyled time-cates">     <li data-cate="all-day">All-day</li>     <li class="hide" data-time="00:01" data-cate="late-night">Late-night</li>     <li class="hide" data-time="05:00" data-cate="dawn">Dawn</li>     <li class="hide" data-time="07:00" data-cate="breakfast">Breakfast</li>     <li class="hide" data-time="08:30" data-cate="morning">Morning</li>     <li class="hide" data-time="10:00" data-cate="brunch">Brunch</li>     <li class="hide" data-time="11:30" data-cate="lunch">Lunch</li>     <li class="hide" data-time="13:00" data-cate="noon">Noon</li>     <li class="hide" data-time="14:30" data-cate="afternoon">Afternoon</li>     <li class="hide" data-time="16:00" data-cate="tea-break">Tea-break</li>     <li class="hide" data-time="17:30" data-cate="off-work">Off-work</li>     <li class="hide" data-time="19:00" data-cate="dinner">Dinner</li>     <li class="hide" data-time="20:30" data-cate="evening">Evening</li>     <li class="hide" data-time="22:00" data-cate="night">Night</li>     <li class="hide" data-time="24:00" data-cate="late-night">Late-night</li>   </ul> </div> <div class="times-wrapper">   <div class="times"></div> </div></div></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var e=this.options;this.render(),this.originEftime=e.eftime,this.eftime=Cross.time,this.dateObj=a(this.eftime),delete e.eftime,this.timezone=E(),this.dateInput=new v(this,"#date-string"),this.calendarTable=new m(this,".date-calendar"),this.timeline=new g(this,".date-timeline"),this.listen()},initComponents:function(){var e=this.eftime,t=this.dateObj.date;this.calendarTable.refresh(t),0===this.originEftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select()),this.timeline.refresh(this.eftime),this.dateInput.change(e.origin||t.text),this.dateInput.$element.focusend()},listen:function(){this.element.on("keydown.datepanel",y(this.keydown,this)),this.on("save",this.save),this.on("tmt-ct",this.tmtCT),this.on("tmt-di",this.tmtDI),this.on("rf-di",this.rfDI),this.on("rf-tl",this.rfTL),this.on("rf-ct",this.rfCT)},save:function(){t("body").trigger("click")},revert:function(){t.extend(!0,this.eftime,this.originEftime)},tmtCT:function(){var e=this.calendarTable.$element;setTimeout(function(){e.focus()},0)},tmtDI:function(){var e=this.dateInput.$element;setTimeout(function(){e.focus()},0)},rfDI:function(e){t.extend(!0,this.eftime,e),this.dateObj=a(e),this.calendarTable.refresh(this.dateObj.date),0===this.eftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select(!0)),this.timeline.select(e)},rfTL:function(e,t){var n=this.eftime,r=this.dateObj.date,i="",s;n.begin_at.time="",e&&(s=e.split(":"),r.setHours(s[0]||0),r.setMinutes(s[1]||0),r.setSeconds(s[2]||0),n.begin_at.time=r.getUTCHours()+":"+r.getMinutes()+":"+r.getSeconds()),n.begin_at.time_word=t,i=e||t,n.outputformat?(n.outputformat=0,n.origin=i):(n.begin_at.date&&(i=b(r)+" "+i),n.origin=i),this.dateInput.change(n.origin)},rfCT:function(e){var t=this.eftime,n=this.dateObj.date,r="",i=e.split("-");n.setFullYear(i[0]),n.setMonth(i[1]-1),n.setDate(i[2]),r=n.getUTCFullYear()+"-"+(n.getUTCMonth()+1)+"-"+n.getUTCDate(),t.begin_at.date=r;if(t.outputformat)t.outputformat=0,t.origin=e;else{var s="";t.begin_at.time?s=f(n.getHours())+":"+f(n.getMinutes()):(s=t.begin_at.time_word,t.begin_at.date=e),s?s=e+" "+s:s=e,t.origin=s}this.dateInput.change(t.origin)},keydown:function(e){var t=this,n=e.altKey,r=e.ctrlKey,i=e.shiftKey,s=e.metaKey,o=e.keyCode;27===o?(t.revert(),t.emit("save")):13===o&&!(n|i)&(r|s)&&t.emit&&t.emit("save")},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),n=this.element,r=n.outerWidth();n.css({left:t.left-r-15,top:t.top})}this.initComponents()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),v=function(e,t){this.component=e,this.$container=e.element,this.tz=e.timezone,this.selector=t,this.$element=e.$(t),this.listen()};v.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("keydown.datepanel",t,y(this.keydown,this)).on("keypress.datepanel",t,y(this.keypress,this)).on("keyup.datepanel",t,y(this.keyup,this))},keyHandler:function(e){var t=this.component,n=e.keyCode;switch(n){case 9:e.preventDefault(),t.emit("tmt-ct");break;case 13:e.preventDefault(),t.emit("save");break;case 40:var r=this.$element.val(),i=r.length,s=this.$element[0],o=S(s);i===o&&(e.preventDefault(),t.emit("tmt-ct"))}},keydown:function(e){this.suppressKeyPressRepeat=!!~p.indexOf([9,13,40],e.keyCode),this.keyHandler(e)},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keyup:function(e){e.stopPropagation(),e.preventDefault();switch(e.keyCode){case 9:case 13:case 16:case 17:case 18:case 27:case 37:case 38:case 39:case 40:break;default:this.lookup()}},lookup:function(){var e=this,t=e.component,n=c(e.$element.val());e.befer&&(e.befer.abort(),delete e.befer);if(""===n){t.emit("rf-di",u());return}e.befer=h.request("recognize",{type:"POST",data:{time_string:n,timezone:e.tz}},function(e){t.emit("rf-di",e.cross_time)})},change:function(e){this.$element.val(e)}};var m=function(e,t){this.component=e,this.$container=e.element,this.selector=t,this.$element=e.$(t),this.today=new Date,this.todayString=b(this.today),this.cx=0,this.cy=0,this.vpr=3,this.vph=44,this.len=0,this.divTmp='<div class="tw"><span class="m hide">{{m}}</span><span class="d">{{d}}</span></div>',this.$y=this.$element.find(".year"),this.$m=this.$element.find(".full-month"),this.$tw=this.$element.find(".table-wrapper"),this.$tb=this.$tw.find("tbody"),this.inited=!0,this.enable=!1,this.listen()};m.prototype={init:function(e){var t=this.vpr,n=this.vph,r=e.getFullYear(),i=e.getMonth(),s=e.getDate(),o=e.getDay();e=new Date(r,i,s-o-21),this.startDate=b(e),this.genNext(e),this.genNext(e),this.genNext(e),this.endDate=b(e),this.cx=o,this.cy=t,this.scrollTop(t*n),this.$trs=this.$tb.find("tr"),this.inited&&(this.st=this.$tw.prop("scrollHeight")-this.$tw.outerHeight(),this.inited=!1)},refresh:function(e){this.$trs=this.$cursor=null,this.selectedDate="",this.len=0,this.$tb.empty(),this.init(e)},getSelectedDate:function(){return this.selectedDate||this.todayString},listen:function(){var e=this.$container,t=this.selector;e.on("blur.datepanel",t,y(this.blur,this)).on("focus.datepanel",t,y(this.focus,this)).on("keydown.datepanel",t,y(this.keydown,this)).on("keypress.datepanel",t,y(this.keypress,this)).on("keyup.datepanel",t,y(this.keyup,this)).on("click.datepanel",t+" td",y(this.clickDate,this)).on("mouseenter.datepanel",t+" td",y(this.mouseenterDate,this)),this.$tw.on("scroll.datepanel",y(this.scroll,this))},scroll:function(e){this.enable&&!0,e.stopPropagation(),e.preventDefault();var t=this.$tw,n=t.scrollTop(),r=!1,i=this.$y,s=this.$m;if(0===n||this.st===n)this.enable=!0,this[0===n?"mpageUp":"mpageDown"](),this.$tw.scrollTop(this.vph*this.vpr),r=!0;this.updateYearMonth(),i.toggleClass("hide",r),s.toggleClass("hide",r)},updateYearMonth:function(){if(this.$cursor){var e=w(this.$cursor.data("date"));this.$y.text(e.getFullYear()),this.$m.text(s[e.getMonth()])}},delCursorStyle:function(){this.$cursor&&this.$cursor.removeClass("hover")},addCursorStyle:function(){this.$cursor=this.$trs.eq(this.cy).find("td").eq(this.cx).addClass("hover")},blur:function(){this.delCursorStyle()},focus:function(){this.addCursorStyle()},scrollTop:function(e){this.$tw.scrollTop(e)},keyHandler:function(e){var t=this,n=this.component,r=e.keyCode;switch(r){case 9:e.preventDefault(),n.emit("tmt-di");break;case 37:e.preventDefault(),t.move("left");break;case 38:e.preventDefault(),t.move("top");break;case 39:e.preventDefault(),t.move("right");break;case 40:e.preventDefault(),t.move("down");break;case 33:e.preventDefault(),t.move("pageUp");break;case 34:e.preventDefault(),t.move("pageDown");break;case 13:e.preventDefault();break;case 32:e.preventDefault(),t.spacing();break;case 35:case 36:}},keydown:function(e){this.suppressKeyPressRepeat=!!~p.indexOf([9,13,32,33,34,35,36,37,38,39,40],e.keyCode),this.keyHandler(e)},keypress:function(e){if(this.suppressKeyPressRepeat)return!1;this.keyHandler(e)},keyup:function(e){e.stopPropagation(),e.preventDefault()},clickDate:function(e){e.preventDefault(),this.spacing()},spacing:function(){this.selectedDate&&this.$tb.find('td[data-date="'+this.selectedDate+'"]').removeClass("selected"),this.select()},select:function(e){var t=this.selectedDate=this.$cursor.data("date");this.$cursor.addClass("selected"),this.updateYearMonth(),e||this.component.emit("rf-ct",t)},mouseenterDate:function(e){e.preventDefault(),this.delCursorStyle();var n=t(e.currentTarget),r=n.parent();this.cx=n.index(),this.cy=r.index(),this.addCursorStyle()},move:function(e){this.enable=!0,this.delCursorStyle(),this["m"+e](),this.addCursorStyle(),this.enable=!1},mleft:function(){0===this.cx--&&(this.cx=6,this.mtop())},mtop:function(){if(0===this.cy--){this.delTail3();var e=w(this.startDate,-21);this.startDate=b(e),this.genPrev(e),this.$trs=this.$tb.find("tr"),this.cy=2,this.$tw.scrollTop(this.vph*this.cy)}var t=this.$tw.scrollTop();t=Math.round(t/this.vph)*this.vph,this.cy*this.vph<t&&this.$tw.scrollTop(t-=this.vph)},mright:function(){6===this.cx++&&(this.cx=0,this.mdown())},mdown:function(){if(this.len===++this.cy){this.delHead3();var e=w(this.endDate,0);this.genNext(e),this.endDate=b(e),this.$trs=this.$tb.find("tr"),this.cy=7,this.$tw.scrollTop(this.vph*5)}var t=this.$tw.scrollTop();t=Math.round(t/this.vph)*this.vph,this.cy*this.vph>t+this.vph*(this.vpr-1)&&this.$tw.scrollTop(t+=this.vph)},mpageUp:function(){this.delTail3();var e=w(this.startDate,-21);this.startDate=b(e),this.genPrev(e),this.$trs=this.$tb.find("tr")},mpageDown:function(){this.delHead3();var e=w(this.endDate,0);this.genNext(e),this.$trs=this.$tb.find("tr"),this.endDate=b(e)},generateHTML:function(e){var t=this.vpr,n=this.todayString,r=this.selectedDate,i=this.divTmp,s="",u=0,a;this.len+=t;for(;u<t;++u){var f=0,l="<tr>",c="",h,p,d,v;for(;f<7;++f)v="",h=b(e),p=h===n,d=h===r,p&&(v="today"),d&&(v+=(v.length?" ":"")+"selected"),c+='<td data-date="'+h+'"'+(v.length?' class="'+v+'"':"")+">",a=e.getDate(),c+=i.replace("{{m}}",o[e.getMonth()]).replace("{{d}}",p?"Today":a),c+="</td>",e.setDate(a+1);l+=c+"</tr>",s+=l}return s},genPrev:function(e){this.$tb.prepend(this.generateHTML(e))},genNext:function(e){this.$tb.append(this.generateHTML(e))},delHead3:function(){this.startDate=this.$trs.eq(0).find("td").eq(0).data("date"),this.$trs.eq(0).remove(),this.$trs.eq(1).remove(),this.$trs.eq(2).remove(),this.len-=3},delTail3:function(){this.endDate=this.$trs.eq(this.len-3).find("td").eq(0).data("date"),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove()}};var g=function(e,n){this.component=e,this.$container=e.element,this.selector=n,this.$element=e.$(n),this.divTmp='<div class="time-item{{class}}" data-time="{{dt}}"><time>{{t}}</time></div>',this.$tw=this.$element.find(".times-wrapper"),this.$tc=this.$element.find(".times"),this.$ft=this.$element.find(".fuzzy-time"),this.$ts=this.$ft.find(".time-cates > li[data-time]"),this.ts=p.map(this.$ts,function(e){return t(e).data("time")}),this.x=0,this.y=0,this.px=0,this.py=0,this.l=9,this.hh=7,this.th=7,this.dh=0,this.dm=0,this.status=!1,this.isHide=!0,this.listen()};g.prototype={select:function(e){this.enable=!0,this.removeSelected();if(e&&0===e.outputformat&&e.begin_at.time){var t=a(e).date,n=t.getHours(),r=t.getMinutes(),i=Math.round(n/15)*15,s;t.setMinutes(i),this.selectedTime=f(n)+":"+f(r),this.$selected=this.$tc.find('[data-time="'+this.selectedTime+'"]').eq(0),0===this.$selected.length&&(this.$selected=this.createNormalItem(n,r,(n+i/60)*this.h*4)),this.$selected.removeClass("time-hover"),this.$selected.addClass("selected"),s=parseInt(this.$selected.css("top"),10),this.$tw.scrollTop(Math.max(0,s-this.vph/2))}else this.$tw.scrollTop(180);this.enable=!1},refresh:function(e){this.generateHTML(),this.rh=this.$tw.prop("scrollHeight"),this.h=Math.floor((this.rh-this.hh-this.th)/(this.l-1)/12),this.a=Math.round(15/this.h);var t=this.$tw.offset();this.ox=t.left,this.oy=t.top,this.st=this.$tw.scrollTop(),this.vph=this.$tw.innerHeight(),this.select(e)},listen:function(){var e=this.$container,t=this.selector;e.on("mouseleave.datepanel",t,y(this.mouseleave,this)).on("mouseenter.datepanel",t+" .times-wrapper",y(this.meTW,this)).on("mousemove.datepanel",t+" .times-wrapper",y(this.mousemove,this)).on("mouseleave.datepanel",t+" .times-wrapper",y(this.mlTW,this)).on("click.datepanel",t+" .times-wrapper",y(this.clickTW,this)).on("click.datepanel",t+" .time-cates li[data-cate]",y(this.clickCT,this)),this.$tw.on("scroll.datepanel",y(this.scrollTop,this))},scrollTop:function(e){this.isHide&&(this.$cursor.removeClass("hide"),this.isHide=!1);if(this.enable)return;e.pageX=this.px,e.pageY=this.py,this.st=this.$tw.scrollTop(),this.mousemove(e)},removeSelected:function(){this.$selected&&(this.selectedTime="",this.$selected.removeClass("selected"),delete this.$selected)},mouseleave:function(e){e.stopPropagation(),e.preventDefault(),this.$ft.addClass("hide")},mousemove:function(e){e.stopPropagation(),e.preventDefault();var t=this.y;this.px=e.pageX,this.py=e.pageY,this.x=this.px-this.ox,this.y=this.py-this.oy+this.st-this.hh,this.y=Math.max(0,Math.min(this.y,(this.l-1)*this.h*3*4));if(t===this.y)return;this.hoverItem(),this.showFuzzyTime(e.pageY)},clickCT:function(e){e.preventDefault(),this.removeSelected(),this.component.emit("rf-tl","",t(e.currentTarget).text())},showFuzzyTime:function(e){var t=0,n=this.ts,r,i=new Date(2012,12,21,this.dh,this.dm),s,o,u;p.find(n,function(e,n){r=e.split(":"),s=new Date(2012,12,21,r[0],r[1]);if(i<s)return t=n,!0}),0===t&&(t=1),24===this.dh&&(t=14),--t,this.$ts.not(".hide").addClass("hide"),this.$ts.eq(t).removeClass("hide"),5<=this.dh&&this.dh<22&&(this.$ts.eq(t-1).removeClass("hide"),this.$ts.eq(t+1).removeClass("hide")),o=e-this.oy-this.th,u=this.$ts.not(".hide").length,this.$ft.stop(!0,!0).animate({top:o-(u+1)/2*18},233)},meTW:function(){this.$cursor.removeClass("hide"),this.$ft.removeClass("hide")},mlTW:function(e){var t=this.$cursor;e&&e.preventDefault(),!t.hasClass("time-label")&&!t.hasClass("selected")&&t.addClass("hide")},clickTW:function(e){e.stopPropagation(),e.preventDefault();var t=this.$cursor,n=t.attr("data-time"),r=n.split(":"),i=0===+r[0]%3&&0===+r[1],s=this.$selected;t.addClass("hide");if(s){s.removeClass("selected");if(n===s.attr("date-time"))return;s.hasClass("time-label")||(s.remove(),delete this.$selected)}i?this.$selected=this.$tc.find('[data-time="'+n+'"]').eq(0):(this.$selected=t.clone().removeClass("hide time-hover"),t.before(this.$selected)),this.$selected.addClass("selected"),this.component.emit("rf-tl",this.selectedTime=this.$selected.data("time"),"")},hoverItem:function(){var e=Math.round(this.y/this.h)*this.h,t=e*this.a,n=+Math.floor(t/60).toFixed(0),r=t%60,i=f(n)+":"+f(r);this.dh=n,this.dm=r,this.$cursor.css("top",e).attr("data-time",i).find("time").text((12===n?n:n%12)+":"+f(r)+" "+(n<12?"A":"P")+"M")},createNormalItem:function(e,n,r){var i=t(this.divTmp.replace("{{class}}"," time-hover").replace("{{dt}}",f(e)+":"+f(n)).replace("{{t}}",e+":"+f(n)+" "+(e<12?"A":"P")+"M"));return i.css("top",r),this.$tc.append(i),i},createLabelItem:function(e,n,r){var i=t(this.divTmp.replace("{{class}}"," time-label").replace("{{dt}}",f(e)+":"+f(n)).replace("{{t}}",(12===e?e:e%12)+" "+(e<12?"A":"P")+"M"));return i.css("top",r),this.$tc.append(i),i},generateHTML:function(){var e=this.l,t=0,n=180,r=new Date(2012,12,21,21,0),i=0,s=0;for(;t<e;++t)r.setMinutes(r.getMinutes()+n),i=r.getHours(),s=r.getMinutes(),8===t&&(i=24),this.createLabelItem(i,s,60*t);this.$cursor=this.createNormalItem(0,0,0).addClass("hide")}};var y=function(e,t){if(!e)return;return function(r){return e.call(t,r)}},b=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},w=function(e,t){return t||(t=0),e=e.split("-"),new Date(e[0],+e[1]-1,+e[2]+t)},E=function(){var e=(new Date).toString(),t=e.replace(/^(?:[\w\W]+([\+\-]\d\d):?(\d\d)[\w\W]+)$/,"$1:$2"),n=e.replace(/^(?:[\w\W]+\(([a-z]+)\)[\w\W]*)$/i,"$1");if(n==="UTC"||n==="GMT")n="";return t+(n?" "+n:"")},S=function(e){return n?x(e):e.selectionEnd},x=function(e){var t=document.selection.createRange(),n=e.createTextRange(),r=n.duplicate();return n.moveToBookmark(t.getBookmark()),r.setEndPoint("EndToStart",n),r.text.length+t.text.length};return d});