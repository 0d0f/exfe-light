define("datepanel",function(e,t,n){var r=e("rex"),i=e("jquery"),s=i.proxy,o=i.browser.mozilla,u=i.browser.webkit,a=e("eftime"),f=a.locales[a.locale],l=f.monthsShort,c=f.months,h=a.lead0,p=a.h12,d=e("panel"),v=d.extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel" editarea="date-panel"><div class="panel-body"><div class="pull-left date-container"><input type="text" name="date-string" id="date-string" autocomplete="off" /><div class="date-calendar" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="year"></div><div class="full-month"></div><div class="table-wrapper"><table class="table" id="date-table"><tbody></tbody></table></div></div></div><div class="pull-right date-timeline"> <div class="fuzzy-time hide">   <ul class="unstyled time-cates">     <li data-cate="all-day">All-day</li>     <li class="hide" data-time="00:01" data-cate="late-night">Late-night</li>     <li class="hide" data-time="05:00" data-cate="dawn">Dawn</li>     <li class="hide" data-time="07:00" data-cate="breakfast">Breakfast</li>     <li class="hide" data-time="08:30" data-cate="morning">Morning</li>     <li class="hide" data-time="10:00" data-cate="brunch">Brunch</li>     <li class="hide" data-time="11:30" data-cate="lunch">Lunch</li>     <li class="hide" data-time="13:00" data-cate="noon">Noon</li>     <li class="hide" data-time="14:30" data-cate="afternoon">Afternoon</li>     <li class="hide" data-time="16:00" data-cate="tea-break">Tea-break</li>     <li class="hide" data-time="17:30" data-cate="off-work">Off-work</li>     <li class="hide" data-time="19:00" data-cate="dinner">Dinner</li>     <li class="hide" data-time="20:30" data-cate="evening">Evening</li>     <li class="hide" data-time="22:00" data-cate="night">Night</li>     <li class="hide" data-time="24:00" data-cate="late-night">Late-night</li>   </ul> </div> <div class="times-wrapper">   <div class="times"></div> </div></div></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var e=this.options;this.render(),this.originEftime=e.eftime,this.eftime=Cross.time,this.date=a.toDate(this.eftime),delete e.eftime,this.dateInput=new m(this,"#date-string",this.date),this.calendarTable=new g(this,".date-calendar",this.date),this.timeline=new y(this,".date-timeline"),this.listen(),this.emit("change",{date:this.eftime.origin||this.date.text},!0)},listen:function(){this.element.on("keydown.datepanel",s(this.keydown,this)),this.on("dateinput-tab",this.dateInputTab),this.on("calendartable-tab",this.calendarTableTab),this.on("change",this.change),this.on("refresh-calendar",this.refreshCalendar),this.on("save",this.save)},keydown:function(e){var t=this;27===e.keyCode?(t.revert(),t.emit("save")):e.ctrlKey&&13===e.keyCode&&t.emit&&t.emit("save")},save:function(){i.extend(!0,this.originEftime,this.eftime),i("body").trigger("click")},revert:function(){i.extend(!0,this.eftime,this.originEftime)},refreshCalendar:function(e){i.extend(!0,this.eftime,e),this.date=a.toDate(e),this.calendarTable.refresh(this.date)},change:function(e,t){e.date||(e.date=this.calendarTable.getSelectedDate()),e.time||(e.time=this.timeline.getSelectedTime());var n=e.date,r=a.parseISO8601(n),s=e.time.split(":");n=i.trim(n+" "+e.time),t||(r.setHours(s[0]||0),r.setMinutes(s[1]||0),r.setSeconds(s[2]||0),e.date=r.getUTCFullYear()+"-"+(r.getUTCMonth()+1)+"-"+r.getUTCDate(),e.time=r.getUTCHours()+":"+r.getUTCMinutes()+":"+r.getUTCSeconds(),e.timezone=S(),i.extend(!0,this.eftime,{begin_at:e,origin:n,outputformat:0})),this.dateInput.change(n)},dateInputTab:function(){var e=this.dateInput,t=this.calendarTable;setTimeout(function(){t.$element.focus()},0)},calendarTableTab:function(){var e=this.dateInput,t=this.calendarTable;setTimeout(function(){e.$element.focus()},0)},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),n=this.element.outerWidth();this.element.css({left:t.left-n-15,top:t.top})}this.dateInput.$element.focusend(),this.calendarTable.scrollTop(132)},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),m=function(e,t,n){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.date=n,this.befer=null,this.timezone=S(),this.listen()};m.prototype={change:function(e){this.input(e)},input:function(e){this.$element.val(e)},listen:function(){var e=this.$container,t=this.selector;e.on("blur.datepanel",t,i.proxy(this.blur,this)).on("keypress.datepanel",t,i.proxy(this.keypress,this)).on("keyup.datepanel",t,i.proxy(this.keyup,this)).on("keydown.datepanel",t,i.proxy(this.keydown,this)).on("focus.datepanel",t,i.proxy(this.focus,this))},blur:function(e){},focus:function(e){},keyup:function(e){switch(e.keyCode){case 9:case 13:case 16:case 17:case 18:case 27:case 38:case 40:break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this,n=this.component,r=e.keyCode;switch(r){case 9:e.preventDefault(),n.emit("dateinput-tab");break;case 13:e.preventDefault(),n.emit("save")}},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~r.indexOf([9,13],e.keyCode),this.keyHandler(e)},lookup:function(e){var t=this,n=t.component,r=i.trim(t.$element.val());t.befer&&t.befer.abort();if(""===r){var s=a.create();n.emit("refresh-calendar",s);return}t.befer=Api.request("recognize",{type:"POST",data:{time_string:r,timezone:t.timezone}},function(e){n.emit("refresh-calendar",e.cross_time)})}};var g=function(e,t,n){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.date=n,this.today=new Date,this.todayString=w(this.today),this.coords=[0,0],this.vpRows=3,this.vpHeight=44,this.len=0,this.$cursor=null,this.divTemp='<div class="tw"><span class="m hide">{{m}}</span><span class="d">{{d}}</span></div>',this.$tableWrapper=this.$element.find(".table-wrapper"),this.$table=this.$tableWrapper.find("table"),this.$tbody=this.$table.find("tbody"),this.$trs=null,this.$year=this.$element.find(".year"),this.$fullMonth=this.$element.find(".full-month"),this.initCalendar(),this.listen()};g.prototype={initCalendar:function(){var e=this.date.day,t=this,n=e.getFullYear(),r=e.getMonth(),i=e.getDate(),s=e.getDay(),o=new Date(n,r,i-s-21);this.startDate=w(o),this.nextPend(o),this.nextPend(o),this.nextPend(o),this.endDate=w(o),this.coords=[s,3],this.$trs=this.$tbody.find("tr"),this.$tableWrapper.scrollTop(0)},refresh:function(e){this.$tbody.empty(),this.$trs=null,this.$select=null,this.$cursor=null,this.date=e,this.len=0,this.initCalendar()},getSelectedDate:function(){return this.selectedDate||this.todayString},setCursorClass:function(){this.$cursor=this.$trs.eq(this.coords[1]).find("td").eq(this.coords[0]).addClass("hover")},removeCursorClass:function(){this.$cursor&&this.$cursor.removeClass("hover")},scrollTop:function(e){this.$tableWrapper.scrollTop(e)},listen:function(){var e=this.$container,t=this.selector,n=this.$tableWrapper;e.on("blur.datepanel",t,s(this.blur,this)).on("keypress.datepanel",t,s(this.keypress,this)).on("keyup.datepanel",t,s(this.keyup,this)).on("keydown.datepanel",t,s(this.keydown,this)).on("focus.datepanel",t,s(this.focus,this)).on("mouseenter.datepanel",t+" td",s(this.tdMouseenter,this)).on("click.datepanel",t+" td",s(this.tdClick,this)),n.on("scroll.datepanel",s(this.scroll,this))},scroll:function(e){e.stopPropagation(),e.preventDefault();var t=this.$tableWrapper,n=t.scrollTop();if(n==0)this.pageUp(this.coords),t.scrollTop(132),this.$year.addClass("hide"),this.$fullMonth.addClass("hide");else if(n==277)this.pageDown(this.coords),this.$year.addClass("hide"),this.$fullMonth.addClass("hide");else if(this.$cursor){var r=E(this.$cursor.data("date"));this.$year.removeClass("hide").html(r.getFullYear()),this.$fullMonth.removeClass("hide").html(c[r.getMonth()])}},tdClick:function(e){e.preventDefault(),this.moveSpacing()},tdMouseenter:function(e){e.preventDefault(),this.removeCursorClass();var t=i(e.currentTarget),n=t.parent();this.coords[0]=t.index(),this.coords[1]=n.index(),this.setCursorClass()},blur:function(e){this.removeCursorClass()},focus:function(e){this.setCursorClass()},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keyup:function(e){e.stopPropagation(),e.preventDefault()},keydown:function(e){this.suppressKeyPressRepeat=!!~r.indexOf([9,13,32,33,34,35,36,37,38,39,40],e.keyCode),this.keyHandler(e)},keyHandler:function(e){var t=this,n=this.component,r=this.coords,i=e.keyCode;switch(i){case 9:e.preventDefault(),n.emit("calendartable-tab");break;case 37:e.preventDefault(),t.moveWrapper(r,"moveLeft");break;case 38:e.preventDefault(),t.moveWrapper(r,"moveTop");break;case 39:e.preventDefault(),t.moveWrapper(r,"moveRight");break;case 40:e.preventDefault(),t.moveWrapper(r,"moveDown");break;case 33:e.preventDefault(),t.moveWrapper(r,"pageUp");break;case 34:e.preventDefault(),t.moveWrapper(r,"pageDown");break;case 13:e.preventDefault();break;case 32:e.preventDefault(),t.moveSpacing();break;case 35:case 36:}},moveSpacing:function(){this.selectedDate&&this.$trs.find('td[data-date="'+this.selectedDate+'"]').removeClass("selected"),this.select()},select:function(){this.selectedDate=this.$cursor.data("date"),this.$cursor.addClass("selected"),this.component.emit("change",{date:this.selectedDate})},generateHTML:function(e){var t=this.vpRows,n=this.todayString,r=this.selectedDate,i=this.divTemp,s=0,o="";this.len+=t;for(;s<t;++s){var u=0,a="<tr>",f="",c,h,p,d;for(;u<7;++u){d="",c=w(e),h=c===n,p=c===r,h&&(d+="today"),p&&(d+=(d.length?" ":"")+"selected"),f+='<td data-date="'+c+'"'+(d?' class="'+d+'"':"")+">";var v=i,m=e.getDate();f+=v.replace("{{m}}",l[e.getMonth()]).replace("{{d}}",h?"Today":m),f+="</td>",e.setDate(m+1)}a+=f+"</tr>",o+=a}return o},prevPend:function(e){this.$tbody.prepend(this.generateHTML(e))},nextPend:function(e){this.$tbody.append(this.generateHTML(e))},delFirst:function(){var e=this.$trs.first();this.startDate=e.find("td").data("date"),this.$trs.eq(0).remove(),this.$trs.eq(1).remove(),this.$trs.eq(2).remove(),this.len-=3},delLast:function(){var e=this.$trs.eq(this.len-3);this.endDate=e.find("td").data("date"),this.$trs.eq(this.len-1).remove(),this.$trs.eq(this.len-2).remove(),e.remove(),this.len-=3},moveWrapper:function(e,t){this.removeCursorClass(),this[t](e),this.setCursorClass()},moveLeft:function(e){0===e[0]--&&(e[0]=6,this.moveTop(e))},moveTop:function(e){if(0===e[1]--){this.delLast();var t=E(this.startDate,-21);this.startDate=w(t),this.prevPend(t),this.$trs=this.$tbody.find("tr"),e[1]=2,this.$tableWrapper.scrollTop(this.vpHeight*e[1])}var n=this.$tableWrapper.scrollTop();e[1]*this.vpHeight<n&&this.$tableWrapper.scrollTop(n-=this.vpHeight)},moveRight:function(e){6===e[0]++&&(e[0]=0,this.moveDown(e))},moveDown:function(e){if(this.len===++e[1]){this.delFirst();var t=E(this.endDate,0);this.nextPend(t),this.endDate=w(t),this.$trs=this.$tbody.find("tr"),e[1]=this.len-2,this.$tableWrapper.scrollTop(this.vpHeight*5)}var n=this.$tableWrapper.scrollTop();e[1]*this.vpHeight>n+this.vpHeight*(this.vpRows-1)&&this.$tableWrapper.scrollTop(n+=this.vpHeight)},pageUp:function(e){if(e[1]<=this.vpRows){this.delLast();var t=E(this.startDate,-21);this.startDate=w(t),this.prevPend(t),this.$trs=this.$tbody.find("tr"),e[1]+=this.vpRows}else{var n=this.$tableWrapper.scrollTop();this.$tableWrapper.scrollTop(n-=this.vpHeight*this.vpRows)}e[1]-=this.vpRows},pageDown:function(e){if(e[1]>=this.len-this.vpRows){this.delFirst();var t=E(this.endDate,0);this.nextPend(t),this.endDate=w(t),this.$trs=this.$tbody.find("tr"),e[1]-=this.vpRows,this.$tableWrapper.scrollTop(this.vpHeight*3)}e[1]+=this.vpRows;var n=this.$tableWrapper.scrollTop();this.$tableWrapper.scrollTop(n+=this.vpHeight*this.vpRows)}};var y=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.divTmp='<div class="time-item{{class}}" data-time="{{dt}}"><time>{{t}}</time></div>',this.$fuzzyTime=this.$element.find(".fuzzy-time"),this.$timesWrapper=this.$element.find(".times-wrapper"),this.generateHTML();var n=this.times=[];this.$times=this.$element.find("ul.time-cates [data-time]").each(function(e,t){n.push(i(t).data("time"))}),this.len=this.$times.length,this.listen()};y.prototype={getSelectedTime:function(){return this.selectedTime||""},listen:function(){var e=this.$container,t=this.selector;e.on("hover.datepanel",t,i.proxy(this.hover,this)).on("hover.datepanel",t+" .time-item",i.proxy(this.itemHover,this)).on("click.datepanel",t+" .time-item",i.proxy(this.itemClick,this))},hover:function(e){var t=e.type,n="mouseleave"===t;this.$fuzzyTime.toggleClass("hide",n)},itemHover:function(e){e.preventDefault();var t=i(e.currentTarget),n=this.$timesWrapper,s=e.type,o=this.times,u=t.data("time"),a="mouseenter"===s,f=0;if(a){var l=u.split(":"),c=new Date(1970,0,1,l[0],l[1]),h,p,d=r.find(o,function(e,t){p=e.split(":"),h=new Date(1970,0,1,p[0],p[1]);if(c<h)return f=t,!0});f||(f=1),l[0]===24&&(f=14),f-=1,this.$times.addClass("hide").eq(f).removeClass("hide"),+l[0]>=5&&+l[0]<22&&(this.$times.eq(f-1).removeClass("hide"),this.$times.eq(f+1).removeClass("hide"));var v=e.pageY-this.$timesWrapper.offset().top-5,m=this.$times.not(".hide").length;this.$fuzzyTime.css("top",v-(m+1)/2*18+"px")}},itemClick:function(e){this.$select&&this.$select.removeClass("selected");var t=i(e.currentTarget),n=t.data("time");this.$select=t.addClass("selected"),this.component.emit("change",{time:this.selectedTime=n})},generateHTML:function(){var e=97,t=0,n="",r="",i=0,s=0,o=!1,u=new Date(1970,0,1,23,45);for(;t<e;++t)u.setMinutes(u.getMinutes()+15),i=u.getHours(),s=u.getMinutes(),o=0===t%12,t===96&&(i=24),r=this.divTmp,n+=r.replace("{{class}}",o?" time-label":"").replace("{{dt}}",h(i)+":"+h(s)).replace("{{t}}",(o?i===0?"0":p(i):(i===0?"0":p(i))+":"+h(s))+" "+(i<12?"AM":"PM"));this.$element.find(".times").html(n)}};var b=function(e){},w=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},E=function(e,t){return t||(t=0),e=e.split("-"),new Date(e[0],+e[1]-1,+e[2]+t)},S=function(){var e=(new Date).toString(),t=e.replace(/^.*([\+\-]\d\d):?(\d\d).*$/,"$1:$2"),n=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return n=n==="UTC"||n==="GMT"?"":n,t+(n?" "+n:"")};return v});