define("datepanel",function(e){"use strict";var t=e("jquery"),i=t.browser.msie,n=e("humantime"),r=n.locales[n.locale],s=r.months,a=r.monthsShort,o=n.createEFTime,l=n.toLocaleDate,c=n.lead0,u=e("util"),d=u.trim,h=e("api"),p=e("rex"),f=e("panel").extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel" editarea="date-panel"><div class="panel-body"><div class="pull-left date-container"><div class="date-input"><input type="text" name="date-string" id="date-string" autocomplete="off" /><i class="pointer icon-enter-blue place-submit"></i></div><div class="date-calendar" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="year"></div><div class="full-month"></div><div class="table-wrapper"><table class="table" id="date-table"><tbody></tbody></table></div></div></div><div class="pull-right date-timeline hide"> <div class="fuzzy-time hide">   <ul class="unstyled time-cates">     <li data-cate="all-day">All-day</li>     <li class="hide" data-time="00:01" data-cate="late-night">Late-night</li>     <li class="hide" data-time="05:00" data-cate="dawn">Dawn</li>     <li class="hide" data-time="07:00" data-cate="breakfast">Breakfast</li>     <li class="hide" data-time="08:30" data-cate="morning">Morning</li>     <li class="hide" data-time="10:00" data-cate="brunch">Brunch</li>     <li class="hide" data-time="11:30" data-cate="lunch">Lunch</li>     <li class="hide" data-time="13:00" data-cate="noon">Noon</li>     <li class="hide" data-time="14:30" data-cate="afternoon">Afternoon</li>     <li class="hide" data-time="16:00" data-cate="tea-break">Tea-break</li>     <li class="hide" data-time="17:30" data-cate="off-work">Off-work</li>     <li class="hide" data-time="19:00" data-cate="dinner">Dinner</li>     <li class="hide" data-time="20:30" data-cate="evening">Evening</li>     <li class="hide" data-time="22:00" data-cate="night">Night</li>     <li class="hide" data-time="24:00" data-cate="late-night">Late-night</li>   </ul> </div> <div class="times-wrapper">   <div class="times"></div> </div></div></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var e=this.options;this.render(),this.originEftime=e.eftime,this.eftime=Cross.time,this.dateObj=l(this.eftime),delete e.eftime,this.timezone=w(),this.dateInput=new m(this,"#date-string"),this.calendarTable=new g(this,".date-calendar"),this.timeline=new v(this,".date-timeline"),this.listen()},initComponents:function(){var e=this.eftime,t=this.dateObj.date;this.calendarTable.refresh(t),0===this.originEftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select()),this.timeline.refresh(this.eftime),this.timeline.select(this.eftime),this.dateInput.change(e.origin||t.text),this.dateInput.$element.focusend(),this.eftime.begin_at.time&&this.showTL()},listen:function(){this.element.on("click.datepanel",".place-submit",y(this.submitSave,this)),this.element.on("keydown.datepanel",y(this.keydown,this)),this.on("save",this.save),this.on("tmt-ct",this.tmtCT),this.on("tmt-di",this.tmtDI),this.on("rf-di",this.rfDI),this.on("rf-tl",this.rfTL),this.on("rf-ct",this.rfCT),this.on("show-tl",this.showTL)},submitSave:function(){this.save()},save:function(e){e&&(this.eftime.origin=e),t("body").trigger("click")},revert:function(){t.extend(!0,this.eftime,this.originEftime)},tmtCT:function(){var e=this.calendarTable.$element;setTimeout(function(){e.focus()},0)},tmtDI:function(){var e=this.dateInput.$element;setTimeout(function(){e.focus()},0)},rfDI:function(e){t.extend(!0,this.eftime,e),this.dateObj=l(e),this.calendarTable.refresh(this.dateObj.date),0===this.eftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select(!0)),this.timeline.select(e)},rfTL:function(e,t){var i,n=this.eftime,r=this.dateObj.date,s="";n.begin_at.time="",e&&(i=e.split(":"),r.setHours(i[0]||0),r.setMinutes(i[1]||0),r.setSeconds(i[2]||0),n.begin_at.time=c(r.getUTCHours())+":"+c(r.getMinutes())+":"+c(r.getSeconds())),n.begin_at.time_word=t,s=e||t,n.outputformat?(n.outputformat=0,n.origin=s):(n.begin_at.date&&(s=b(r)+" "+s),n.origin=s),this.dateInput.change(n.origin)},rfCT:function(e){var t=this.eftime,i=this.dateObj.date,n="",r=e.split("-");if(i.setFullYear(r[0]),i.setMonth(r[1]-1),i.setDate(r[2]),n=i.getUTCFullYear()+"-"+c(i.getUTCMonth()+1)+"-"+c(i.getUTCDate()),t.begin_at.date=n,t.outputformat)t.outputformat=0,t.origin=e;else{var s="";t.begin_at.time?s=c(i.getHours())+":"+c(i.getMinutes()):(s=t.begin_at.time_word,t.begin_at.date=e),s=s?e+" "+s:e,t.origin=s}this.dateInput.change(t.origin)},showTL:function(){this.timeline.show(this.eftime)},keydown:function(e){var t=this,i=e.altKey,n=e.ctrlKey,r=e.shiftKey,s=e.metaKey,a=e.keyCode;27===a?(t.revert(),t.emit("save")):13===a&&!(i|r)&(n|s)&&t.emit&&t.emit("save")},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),i=this.element,n=i.outerWidth(),r=e.outerHeight();i.css({left:t.left-n+175-15,top:t.top+r+7})}this.initComponents()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),m=function(e,t){this.component=e,this.$container=e.element,this.tz=e.timezone,this.selector=t,this.$element=e.$(t),this.listen()};m.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("keydown.datepanel",t,y(this.keydown,this)).on("keypress.datepanel",t,y(this.keypress,this)).on("keyup.datepanel",t,y(this.keyup,this))},keyHandler:function(e){var t=this.component,i=e.keyCode;switch(i){case 9:e.preventDefault(),t.emit("tmt-ct");break;case 13:e.preventDefault(),t.emit("save",d(this.$element.val()));break;case 40:var n=this.$element.val(),r=n.length,s=this.$element[0],a=k(s);r===a&&(e.preventDefault(),t.emit("tmt-ct"))}},keydown:function(e){this.suppressKeyPressRepeat=!!~p.indexOf([9,13,40],e.keyCode),this.keyHandler(e)},keypress:function(e){this.suppressKeyPressRepeat||this.keyHandler(e)},keyup:function(e){switch(e.stopPropagation(),e.preventDefault(),e.keyCode){case 9:case 13:case 16:case 17:case 18:case 27:case 37:case 38:case 39:case 40:break;default:this.lookup()}},lookup:function(){var e=this,t=e.component,i=d(e.$element.val());return e.befer&&(e.befer.abort(),e.befer=void 0),""===i?(t.emit("rf-di",o()),void 0):(e.befer=h.request("recognize",{type:"POST",data:{time_string:i,timezone:e.tz}},function(e){t&&t.emit("rf-di",e.cross_time)}),void 0)},change:function(e){this.$element.val(e)}};var g=function(e,t){this.component=e,this.$container=e.element,this.selector=t,this.$element=e.$(t),this.today=new Date,this.todayString=b(this.today),this.cx=0,this.cy=0,this.vpr=3,this.vph=44,this.len=0,this.divTmp='<div class="tw"><span class="m hide">{{m}}</span><span class="d">{{d}}</span></div>',this.$y=this.$element.find(".year"),this.$m=this.$element.find(".full-month"),this.$tw=this.$element.find(".table-wrapper"),this.$tb=this.$tw.find("tbody"),this.inited=!0,this.enable=!1,this.listen()};g.prototype={init:function(e){var t=this.vpr,i=this.vph,n=e.getFullYear(),r=e.getMonth(),s=e.getDate(),a=e.getDay();e=new Date(n,r,s-a-21),this.startDate=b(e),this.genNext(e),this.genNext(e),this.genNext(e),this.endDate=b(e),this.cx=a,this.cy=t,this.scrollTop(t*i),this.$trs=this.$tb.find("tr"),this.inited&&(this.st=this.$tw.prop("scrollHeight")-this.$tw.outerHeight(),this.inited=!1)},refresh:function(e){this.$trs=this.$cursor=null,this.len=0,this.$tb.empty(),this.init(e)},getSelectedDate:function(){return this.selectedDate||this.todayString},listen:function(){var e=this.$container,t=this.selector;e.on("blur.datepanel",t,y(this.blur,this)).on("focus.datepanel",t,y(this.focus,this)).on("keydown.datepanel",t,y(this.keydown,this)).on("keypress.datepanel",t,y(this.keypress,this)).on("keyup.datepanel",t,y(this.keyup,this)).on("click.datepanel",t+" td",y(this.clickDate,this)).on("mouseenter.datepanel",t+" td",y(this.mouseenterDate,this)),this.$tw.on("scroll.datepanel",y(this.scroll,this))},scroll:function(e){this.enable,e.stopPropagation(),e.preventDefault();var t=this.$tw,i=t.scrollTop(),n=!1,r=this.$y,s=this.$m;(0===i||this.st===i)&&(this.enable=!0,this[0===i?"mpageUp":"mpageDown"](),this.$tw.scrollTop(this.vph*this.vpr),n=!0),this.updateYearMonth(),r.toggleClass("hide",n),s.toggleClass("hide",n)},updateYearMonth:function(){if(this.$cursor){var e=x(this.$cursor.data("date"));this.$y.text(e.getFullYear()),this.$m.text(s[e.getMonth()])}},delCursorStyle:function(){this.$cursor&&this.$cursor.removeClass("hover")},addCursorStyle:function(){this.$cursor=this.$trs.eq(this.cy).find("td").eq(this.cx).addClass("hover")},blur:function(){this.delCursorStyle()},focus:function(){this.addCursorStyle()},scrollTop:function(e){this.$tw.scrollTop(e)},keyHandler:function(e){var t=this,i=this.component,n=e.keyCode;switch(n){case 9:e.preventDefault(),i.emit("tmt-di");break;case 37:e.preventDefault(),t.move("left");break;case 38:e.preventDefault(),t.move("top");break;case 39:e.preventDefault(),t.move("right");break;case 40:e.preventDefault(),t.move("down");break;case 33:e.preventDefault(),t.move("pageUp");break;case 34:e.preventDefault(),t.move("pageDown");break;case 13:e.preventDefault();break;case 32:e.preventDefault(),t.spacing();break;case 68:e.preventDefault(),t.refresh(x(t.getSelectedDate()));break;case 84:e.preventDefault(),t.refresh(t.today);break;case 35:case 36:}},keydown:function(e){this.suppressKeyPressRepeat=!!~p.indexOf([9,13,32,33,34,35,36,37,38,39,40,68,84],e.keyCode),this.keyHandler(e)},keypress:function(e){return this.suppressKeyPressRepeat?!1:(this.keyHandler(e),void 0)},keyup:function(e){e.stopPropagation(),e.preventDefault()},clickDate:function(e){e.preventDefault(),this.spacing(),this.component.emit("show-tl")},spacing:function(){this.selectedDate&&this.$tb.find('td[data-date="'+this.selectedDate+'"]').removeClass("selected"),this.select()},select:function(e){this.selectedDate&&this.$trs.find("td.selected").removeClass("selected");var t=this.selectedDate=this.$cursor.data("date");this.$cursor.addClass("selected"),this.updateYearMonth(),e||this.component.emit("rf-ct",t)},mouseenterDate:function(e){e.preventDefault(),this.delCursorStyle();var i=t(e.currentTarget),n=i.parent();this.cx=i.index(),this.cy=n.index(),this.addCursorStyle()},move:function(e){this.enable=!0,this.delCursorStyle(),this["m"+e](),this.addCursorStyle(),this.enable=!1},mleft:function(){0===this.cx--&&(this.cx=6,this.mtop())},mtop:function(){if(0===this.cy--){this.delTail3();var e=x(this.startDate,-21);this.startDate=b(e),this.genPrev(e),this.$trs=this.$tb.find("tr"),this.cy=2,this.$tw.scrollTop(this.vph*this.cy)}var t=this.$tw.scrollTop();t=Math.round(t/this.vph)*this.vph,t>this.cy*this.vph&&this.$tw.scrollTop(t-=this.vph)},mright:function(){6===this.cx++&&(this.cx=0,this.mdown())},mdown:function(){if(this.len===++this.cy){this.delHead3();var e=x(this.endDate,0);this.genNext(e),this.endDate=b(e),this.$trs=this.$tb.find("tr"),this.cy=7,this.$tw.scrollTop(5*this.vph)}var t=this.$tw.scrollTop();t=Math.round(t/this.vph)*this.vph,this.cy*this.vph>t+this.vph*(this.vpr-1)&&this.$tw.scrollTop(t+=this.vph)},mpageUp:function(){this.delTail3();var e=x(this.startDate,-21);this.startDate=b(e),this.genPrev(e),this.$trs=this.$tb.find("tr")},mpageDown:function(){this.delHead3();var e=x(this.endDate,0);this.genNext(e),this.$trs=this.$tb.find("tr"),this.endDate=b(e)},generateHTML:function(e){var t,i=this.vpr,n=this.todayString,r=this.selectedDate,s=this.divTmp,o="",l=0;for(this.len+=i;i>l;++l){for(var c,u,d,h,p=0,f="<tr>",m="";7>p;++p)h="",c=b(e),u=c===n,d=c===r,u&&(h="today"),d&&(h+=(h.length?" ":"")+"selected"),m+='<td data-date="'+c+'"'+(h.length?' class="'+h+'"':"")+">",t=e.getDate(),m+=s.replace("{{m}}",a[e.getMonth()]).replace("{{d}}",u?"Today":t),m+="</td>",e.setDate(t+1);f+=m+"</tr>",o+=f}return o},genPrev:function(e){this.$tb.prepend(this.generateHTML(e))},genNext:function(e){this.$tb.append(this.generateHTML(e))},delHead3:function(){this.startDate=this.$trs.eq(0).find("td").eq(0).data("date"),this.$trs.eq(0).remove(),this.$trs.eq(1).remove(),this.$trs.eq(2).remove(),this.len-=3},delTail3:function(){this.endDate=this.$trs.eq(this.len-3).find("td").eq(0).data("date"),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove()}};var v=function(e,i){this.component=e,this.$container=e.element,this.selector=i,this.$element=e.$(i),this.divTmp='<div class="time-item{{class}}" data-time="{{dt}}"><time>{{t}}</time></div>',this.$tw=this.$element.find(".times-wrapper"),this.$tc=this.$element.find(".times"),this.$ft=this.$element.find(".fuzzy-time"),this.$ts=this.$ft.find(".time-cates > li[data-time]"),this.ts=p.map(this.$ts,function(e){return t(e).data("time")}),this.x=0,this.y=0,this.px=0,this.py=0,this.l=9,this.hh=7,this.th=7,this.dh=0,this.dm=0,this.status=!1,this.isHide=!0,this.listen()};v.prototype={show:function(e){this.$element.removeClass("hide"),this.select(e)},select:function(e){if(this.enable=!0,this.removeSelected(),e&&0===e.outputformat&&e.begin_at.time){var t,i=l(e).date,n=i.getHours(),r=i.getMinutes(),s=15*Math.round(n/15);i.setMinutes(s),this.selectedTime=c(n)+":"+c(r),this.$selected=this.$tc.find('[data-time="'+this.selectedTime+'"]').eq(0),0===this.$selected.length&&(this.$selected=this.createNormalItem(n,r,Math.floor(4*(n+r/60)*this.h))),this.$selected.removeClass("time-hover"),this.$selected.addClass("selected"),t=parseInt(this.$selected.css("top"),10),this.$tw.scrollTop(Math.max(0,t-this.vph/2))}else this.$tw.scrollTop(180);this.enable=!1},refresh:function(e){this.generateHTML();var t=this.$element.clone().attr("id","__tmp__").css({visibility:"hidden",display:"block",position:"absolute"});this.$element.parent().append(t),this.rh=t.find(".times-wrapper").prop("scrollHeight"),this.h=Math.floor((this.rh-this.hh-this.th)/(this.l-1)/12),this.a=Math.round(15/this.h);var i=t.offset();this.ox=i.left,this.oy=i.top,this.st=t.scrollTop(),this.vph=t.innerHeight(),t.remove(),this.select(e)},listen:function(){var e=this.$container,t=this.selector;e.on("mouseleave.datepanel",t,y(this.mouseleave,this)).on("mouseenter.datepanel",t+" .times-wrapper",y(this.meTW,this)).on("mousemove.datepanel",t+" .times-wrapper",y(this.mousemove,this)).on("mouseleave.datepanel",t+" .times-wrapper",y(this.mlTW,this)).on("click.datepanel",t+" .times-wrapper",y(this.clickTW,this)).on("click.datepanel",t+" .time-cates li[data-cate]",y(this.clickCT,this)),this.$tw.on("scroll.datepanel",y(this.scrollTop,this))},scrollTop:function(e){this.isHide&&(this.$cursor.removeClass("hide"),this.isHide=!1),this.enable||(e.pageX=this.px,e.pageY=this.py,this.st=this.$tw.scrollTop(),this.mousemove(e))},removeSelected:function(){this.$selected&&(this.selectedTime="",this.$selected.removeClass("selected"),delete this.$selected)},mouseleave:function(e){e.stopPropagation(),e.preventDefault(),this.$ft.addClass("hide")},mousemove:function(e){e.stopPropagation(),e.preventDefault();var t=this.y;this.px=e.pageX,this.py=e.pageY,this.x=this.px-this.ox,this.y=this.py-this.oy+this.st-this.hh,this.y=Math.max(0,Math.min(this.y,4*3*(this.l-1)*this.h)),t!==this.y&&(this.hoverItem(),this.showFuzzyTime(e.pageY))},clickCT:function(e){e.preventDefault(),this.removeSelected(),this.component.emit("rf-tl","",t(e.currentTarget).text())},showFuzzyTime:function(e){var t,i,n,r,s=0,a=this.ts,o=new Date(2012,12,21,this.dh,this.dm);p.find(a,function(e,n){return t=e.split(":"),i=new Date(2012,12,21,t[0],t[1]),i>o?(s=n,!0):void 0}),0===s&&(s=1),24===this.dh&&(s=14),--s,this.$ts.not(".hide").addClass("hide"),this.$ts.eq(s).removeClass("hide"),this.dh>=5&&22>this.dh&&(this.$ts.eq(s-1).removeClass("hide"),this.$ts.eq(s+1).removeClass("hide")),n=e-this.oy-this.th,r=this.$ts.not(".hide").length,this.$ft.stop(!0,!0).animate({top:n-18*((r+1)/2)},233)},meTW:function(){this.$cursor.removeClass("hide"),this.$ft.removeClass("hide")},mlTW:function(e){var t=this.$cursor;e&&e.preventDefault(),t.hasClass("time-label")||t.hasClass("selected")||t.addClass("hide")},clickTW:function(e){e.stopPropagation(),e.preventDefault();var t=this.$cursor,i=t.attr("data-time"),n=i.split(":"),r=0===+n[0]%3&&0===+n[1],s=this.$selected;if(t.addClass("hide"),s){if(s.removeClass("selected"),i===s.attr("date-time"))return;s.hasClass("time-label")||(s.remove(),delete this.$selected)}r?this.$selected=this.$tc.find('[data-time="'+i+'"]').eq(0):(this.$selected=t.clone().removeClass("hide time-hover"),t.before(this.$selected)),this.$selected.addClass("selected"),this.component.emit("rf-tl",this.selectedTime=this.$selected.data("time"),"")},hoverItem:function(){var e=Math.round(this.y/this.h)*this.h,t=e*this.a,i=+Math.floor(t/60).toFixed(0),n=t%60,r=c(i)+":"+c(n);this.dh=i,this.dm=n,this.$cursor.css("top",e).attr("data-time",r).find("time").text((12===i?i:i%12)+":"+c(n)+" "+(12>i?"A":"P")+"M")},createNormalItem:function(e,i,n){var r=t(this.divTmp.replace("{{class}}"," time-hover").replace("{{dt}}",c(e)+":"+c(i)).replace("{{t}}",e+":"+c(i)+" "+(12>e?"A":"P")+"M"));return r.css("top",n),this.$tc.append(r),r},createLabelItem:function(e,i,n){var r=t(this.divTmp.replace("{{class}}"," time-label").replace("{{dt}}",c(e)+":"+c(i)).replace("{{t}}",(12===e?e:e%12)+" "+(12>e?"A":"P")+"M"));return r.css("top",n),this.$tc.append(r),r},generateHTML:function(){for(var e=this.l,t=0,i=180,n=new Date(2012,12,21,21,0),r=0,s=0;e>t;++t)n.setMinutes(n.getMinutes()+i),r=n.getHours(),s=n.getMinutes(),8===t&&(r=24),this.createLabelItem(r,s,60*t);this.$cursor=this.createNormalItem(0,0,0).addClass("hide")}};var y=function(e,t){return e?function(i){return e.call(t,i)}:void 0},b=function(e){return e.getFullYear()+"-"+c(e.getMonth()+1)+"-"+c(e.getDate())},x=function(e,t){return t||(t=0),e=e.split("-"),new Date(e[0],+e[1]-1,+e[2]+t)},w=function(){var e=""+new Date,t=e.replace(/^(?:[\w\W]+([\+\-]\d\d):?(\d\d)[\w\W]+)$/,"$1:$2"),i=e.replace(/^(?:[\w\W]+\(([a-z]+)\)[\w\W]*)$/i,"$1");return("UTC"===i||"GMT"===i)&&(i=""),t+(i?" "+i:"")},k=function(e){return i?T(e):e.selectionEnd},T=function(e){var t=document.selection.createRange(),i=e.createTextRange(),n=i.duplicate();return i.moveToBookmark(t.getBookmark()),n.setEndPoint("EndToStart",i),n.text.length+t.text.length};return f});