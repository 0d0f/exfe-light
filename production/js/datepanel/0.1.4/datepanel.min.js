define("datepanel",function(t){"use strict";var e=t("jquery"),i=e.browser.msie,s=t("humantime"),a=s.locales[s.locale],n=a.months,h=a.monthsShort,r=s.createEFTime,l=s.toLocaleDate,o=s.lead0,d=t("util"),c=d.trim,m=t("api"),p=t("rex"),u=t("panel").extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel" editarea="date-panel"><div class="panel-body"><div class="pull-left date-container"><div class="date-input"><input type="text" name="date-string" id="date-string" autocomplete="off" /><i class="pointer icon-enter-blue place-submit"></i></div><div class="date-calendar" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="year"></div><div class="full-month"></div><div class="table-wrapper"><table class="table" id="date-table"><tbody></tbody></table></div></div></div><div class="pull-right date-timeline hide"> <div class="fuzzy-time hide">   <ul class="unstyled time-cates">     <li data-cate="all-day">All-day</li>     <li class="hide" data-time="00:01" data-cate="late-night">Late-night</li>     <li class="hide" data-time="05:00" data-cate="dawn">Dawn</li>     <li class="hide" data-time="07:00" data-cate="breakfast">Breakfast</li>     <li class="hide" data-time="08:30" data-cate="morning">Morning</li>     <li class="hide" data-time="10:00" data-cate="brunch">Brunch</li>     <li class="hide" data-time="11:30" data-cate="lunch">Lunch</li>     <li class="hide" data-time="13:00" data-cate="noon">Noon</li>     <li class="hide" data-time="14:30" data-cate="afternoon">Afternoon</li>     <li class="hide" data-time="16:00" data-cate="tea-break">Tea-break</li>     <li class="hide" data-time="17:30" data-cate="off-work">Off-work</li>     <li class="hide" data-time="19:00" data-cate="dinner">Dinner</li>     <li class="hide" data-time="20:30" data-cate="evening">Evening</li>     <li class="hide" data-time="22:00" data-cate="night">Night</li>     <li class="hide" data-time="24:00" data-cate="late-night">Late-night</li>   </ul> </div> <div class="times-wrapper">   <div class="times"></div> </div></div></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var t=this.options;this.render(),this.originEftime=t.eftime,this.eftime=Cross.time,this.dateObj=l(this.eftime),delete t.eftime,this.timezone=w(),this.dateInput=new f(this,"#date-string"),this.calendarTable=new v(this,".date-calendar"),this.timeline=new $(this,".date-timeline"),this.listen()},_x:0,initComponents:function(){var t=this.eftime,e=this.dateObj.date;this.calendarTable.refresh(e),0===this.originEftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select()),this.timeline.refresh(this.eftime),this.timeline.select(this.eftime),this.dateInput.change(t.origin||e.text),this.dateInput.$element.focusend(),this.eftime.begin_at.time&&(this._x=124,this.element.css("left","-="+this._x),this.showTL())},listen:function(){this.element.on("click.datepanel",".place-submit",g(this.submitSave,this)),this.element.on("keydown.datepanel",g(this.keydown,this)),this.on("save",this.save),this.on("tmt-ct",this.tmtCT),this.on("tmt-di",this.tmtDI),this.on("rf-di",this.rfDI),this.on("rf-tl",this.rfTL),this.on("rf-ct",this.rfCT),this.on("show-tl",this.showTL)},submitSave:function(){this.save()},save:function(t){t&&(this.eftime.origin=t),e("body").trigger("save-cross")},revert:function(){e.extend(!0,this.eftime,this.originEftime)},tmtCT:function(){var t=this.calendarTable.$element;setTimeout(function(){t.focus()},0)},tmtDI:function(){var t=this.dateInput.$element;setTimeout(function(){t.focus()},0)},rfDI:function(t){e.extend(!0,this.eftime,t),this.dateObj=l(t),this.calendarTable.refresh(this.dateObj.date),0===this.eftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select(!0)),this.timeline.select(t)},rfTL:function(t,e){var i,s=this.eftime,a=this.dateObj.date,n="";s.begin_at.time="",t&&(i=t.split(":"),a.setHours(i[0]||0),a.setMinutes(i[1]||0),a.setSeconds(i[2]||0),s.begin_at.time=o(a.getUTCHours())+":"+o(a.getMinutes())+":"+o(a.getSeconds())),s.begin_at.time_word=e,n=t||e,s.outputformat?(s.outputformat=0,s.origin=n):(s.begin_at.date&&(n=y(a)+" "+n),s.origin=n),this.dateInput.change(s.origin)},rfCT:function(t){var e=this.eftime,i=this.dateObj.date,s="",a=t.split("-");if(i.setFullYear(a[0]),i.setMonth(a[1]-1),i.setDate(a[2]),s=i.getUTCFullYear()+"-"+o(i.getUTCMonth()+1)+"-"+o(i.getUTCDate()),e.begin_at.date=s,e.outputformat)e.outputformat=0,e.origin=t;else{var n="";e.begin_at.time?n=o(i.getHours())+":"+o(i.getMinutes()):(n=e.begin_at.time_word,e.begin_at.date=t),n=n?t+" "+n:t,e.origin=n}this.dateInput.change(e.origin)},showTL:function(){this.timeline.show(this.eftime),this._x||(this._x=124,this.element.css({"-webkit-transform":"-webkit-translate3d(-"+this._x+"px, 0, 0)","-moz-transform":"-moz-translate3d(-"+this._x+"px, 0, 0)","-ms-transform":"-ms-translate3d(-"+this._x+"px, 0, 0)","-o-transform":"-o-translate3d(-"+this._x+"px, 0, 0)",transform:"translate3d(-"+this._x+"px, 0, 0)"}))},keydown:function(t){var e=this,i=t.altKey,s=t.ctrlKey,a=t.shiftKey,n=t.metaKey,h=t.keyCode;27===h?(e.revert(),e.emit("save")):13===h&&!(i|a)&(s|n)&&e.emit&&e.emit("save")},showAfter:function(){var t=this.srcNode;if(t){var e=t.offset(),i=this.element,s=i.outerWidth();i.css({left:e.left-s-15,top:e.top})}this.initComponents()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),f=function(t,e){this.component=t,this.$container=t.element,this.tz=t.timezone,this.selector=e,this.$element=t.$(e),this.listen()};f.prototype={listen:function(){var t=this.$container,e=this.selector;t.on("keydown.datepanel",e,g(this.keydown,this)).on("keypress.datepanel",e,g(this.keypress,this)).on("keyup.datepanel",e,g(this.keyup,this))},keyHandler:function(t){var e=this.component,i=t.keyCode;switch(i){case 9:t.preventDefault(),e.emit("tmt-ct");break;case 13:t.preventDefault(),e.emit("save",c(this.$element.val()));break;case 40:var s=this.$element.val(),a=s.length,n=this.$element[0],h=T(n);a===h&&(t.preventDefault(),e.emit("tmt-ct"))}},keydown:function(t){this.suppressKeyPressRepeat=!!~p.indexOf([9,13,40],t.keyCode),this.keyHandler(t)},keypress:function(t){this.suppressKeyPressRepeat||this.keyHandler(t)},keyup:function(t){switch(t.stopPropagation(),t.preventDefault(),t.keyCode){case 9:case 13:case 16:case 17:case 18:case 27:case 37:case 38:case 39:case 40:break;default:this.lookup()}},lookup:function(){var t=this,e=t.component,i=c(t.$element.val());return t.befer&&(t.befer.abort(),t.befer=void 0),""===i?(e.emit("rf-di",r()),void 0):(t.befer=m.request("recognize",{type:"POST",data:{time_string:i,timezone:t.tz}},function(t){e&&e.emit("rf-di",t.cross_time)}),void 0)},change:function(t){this.$element.val(t)}};var v=function(t,e){this.component=t,this.$container=t.element,this.selector=e,this.$element=t.$(e),this.today=new Date,this.todayString=y(this.today),this.cx=0,this.cy=0,this.vpr=3,this.vph=44,this.len=0,this.divTmp='<div class="tw"><span class="m hide">{{m}}</span><span class="d">{{d}}</span></div>',this.$y=this.$element.find(".year"),this.$m=this.$element.find(".full-month"),this.$tw=this.$element.find(".table-wrapper"),this.$tb=this.$tw.find("tbody"),this.inited=!0,this.enable=!1,this.listen()};v.prototype={init:function(t){var e=this.vpr,i=this.vph,s=t.getFullYear(),a=t.getMonth(),n=t.getDate(),h=t.getDay();t=new Date(s,a,n-h-21),this.startDate=y(t),this.genNext(t),this.genNext(t),this.genNext(t),this.endDate=y(t),this.cx=h,this.cy=e,this.scrollTop(e*i),this.$trs=this.$tb.find("tr"),this.inited&&(this.st=this.$tw.prop("scrollHeight")-this.$tw.outerHeight(),this.inited=!1)},refresh:function(t){this.$trs=this.$cursor=null,this.len=0,this.$tb.empty(),this.init(t)},getSelectedDate:function(){return this.selectedDate||this.todayString},listen:function(){var t=this.$container,e=this.selector;t.on("blur.datepanel",e,g(this.blur,this)).on("focus.datepanel",e,g(this.focus,this)).on("keydown.datepanel",e,g(this.keydown,this)).on("keypress.datepanel",e,g(this.keypress,this)).on("keyup.datepanel",e,g(this.keyup,this)).on("click.datepanel",e+" td",g(this.clickDate,this)).on("mouseenter.datepanel",e+" td",g(this.mouseenterDate,this)),this.$tw.on("scroll.datepanel",g(this.scroll,this))},scroll:function(t){this.enable,t.stopPropagation(),t.preventDefault();var e=this.$tw,i=e.scrollTop(),s=!1,a=this.$y,n=this.$m;(0===i||this.st===i)&&(this.enable=!0,this[0===i?"mpageUp":"mpageDown"](),this.$tw.scrollTop(this.vph*this.vpr),s=!0),this.updateYearMonth(),a.toggleClass("hide",s),n.toggleClass("hide",s)},updateYearMonth:function(){if(this.$cursor){var t=b(this.$cursor.data("date"));this.$y.text(t.getFullYear()),this.$m.text(n[t.getMonth()])}},delCursorStyle:function(){this.$cursor&&this.$cursor.removeClass("hover")},addCursorStyle:function(){this.$cursor=this.$trs.eq(this.cy).find("td").eq(this.cx).addClass("hover")},blur:function(){this.delCursorStyle()},focus:function(){this.addCursorStyle()},scrollTop:function(t){this.$tw.scrollTop(t)},keyHandler:function(t){var e=this,i=this.component,s=t.keyCode;switch(s){case 9:t.preventDefault(),i.emit("tmt-di");break;case 37:t.preventDefault(),e.move("left");break;case 38:t.preventDefault(),e.move("top");break;case 39:t.preventDefault(),e.move("right");break;case 40:t.preventDefault(),e.move("down");break;case 33:t.preventDefault(),e.move("pageUp");break;case 34:t.preventDefault(),e.move("pageDown");break;case 13:t.preventDefault();break;case 32:t.preventDefault(),e.spacing();break;case 68:t.preventDefault(),e.refresh(b(e.getSelectedDate()));break;case 84:t.preventDefault(),e.refresh(e.today);break;case 35:case 36:}},keydown:function(t){this.suppressKeyPressRepeat=!!~p.indexOf([9,13,32,33,34,35,36,37,38,39,40,68,84],t.keyCode),this.keyHandler(t)},keypress:function(t){return this.suppressKeyPressRepeat?!1:(this.keyHandler(t),void 0)},keyup:function(t){t.stopPropagation(),t.preventDefault()},clickDate:function(t){t.preventDefault(),this.spacing(),this.component.emit("show-tl")},spacing:function(){this.selectedDate&&this.$tb.find('td[data-date="'+this.selectedDate+'"]').removeClass("selected"),this.select()},select:function(t){this.selectedDate&&this.$trs.find("td.selected").removeClass("selected");var e=this.selectedDate=this.$cursor.data("date");this.$cursor.addClass("selected"),this.updateYearMonth(),t||this.component.emit("rf-ct",e)},mouseenterDate:function(t){t.preventDefault(),this.delCursorStyle();var i=e(t.currentTarget),s=i.parent();this.cx=i.index(),this.cy=s.index(),this.addCursorStyle()},move:function(t){this.enable=!0,this.delCursorStyle(),this["m"+t](),this.addCursorStyle(),this.enable=!1},mleft:function(){0===this.cx--&&(this.cx=6,this.mtop())},mtop:function(){if(0===this.cy--){this.delTail3();var t=b(this.startDate,-21);this.startDate=y(t),this.genPrev(t),this.$trs=this.$tb.find("tr"),this.cy=2,this.$tw.scrollTop(this.vph*this.cy)}var e=this.$tw.scrollTop();e=Math.round(e/this.vph)*this.vph,e>this.cy*this.vph&&this.$tw.scrollTop(e-=this.vph)},mright:function(){6===this.cx++&&(this.cx=0,this.mdown())},mdown:function(){if(this.len===++this.cy){this.delHead3();var t=b(this.endDate,0);this.genNext(t),this.endDate=y(t),this.$trs=this.$tb.find("tr"),this.cy=7,this.$tw.scrollTop(5*this.vph)}var e=this.$tw.scrollTop();e=Math.round(e/this.vph)*this.vph,this.cy*this.vph>e+this.vph*(this.vpr-1)&&this.$tw.scrollTop(e+=this.vph)},mpageUp:function(){this.delTail3();var t=b(this.startDate,-21);this.startDate=y(t),this.genPrev(t),this.$trs=this.$tb.find("tr")},mpageDown:function(){this.delHead3();var t=b(this.endDate,0);this.genNext(t),this.$trs=this.$tb.find("tr"),this.endDate=y(t)},generateHTML:function(t){var e,i=this.vpr,s=this.todayString,a=this.selectedDate,n=this.divTmp,r="",l=0;for(this.len+=i;i>l;++l){for(var o,d,c,m,p=0,u="<tr>",f="";7>p;++p)m="",o=y(t),d=o===s,c=o===a,d&&(m="today"),c&&(m+=(m.length?" ":"")+"selected"),f+='<td data-date="'+o+'"'+(m.length?' class="'+m+'"':"")+">",e=t.getDate(),f+=n.replace("{{m}}",h[t.getMonth()]).replace("{{d}}",d?"Today":e),f+="</td>",t.setDate(e+1);u+=f+"</tr>",r+=u}return r},genPrev:function(t){this.$tb.prepend(this.generateHTML(t))},genNext:function(t){this.$tb.append(this.generateHTML(t))},delHead3:function(){this.startDate=this.$trs.eq(0).find("td").eq(0).data("date"),this.$trs.eq(0).remove(),this.$trs.eq(1).remove(),this.$trs.eq(2).remove(),this.len-=3},delTail3:function(){this.endDate=this.$trs.eq(this.len-3).find("td").eq(0).data("date"),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove()}};var $=function(t,i){this.component=t,this.$container=t.element,this.selector=i,this.$element=t.$(i),this.divTmp='<div class="time-item{{class}}" data-time="{{dt}}"><time>{{t}}</time></div>',this.$tw=this.$element.find(".times-wrapper"),this.$tc=this.$element.find(".times"),this.$ft=this.$element.find(".fuzzy-time"),this.$ts=this.$ft.find(".time-cates > li[data-time]"),this.ts=p.map(this.$ts,function(t){return e(t).data("time")}),this.x=0,this.y=0,this.px=0,this.py=0,this.l=9,this.hh=7,this.th=7,this.dh=0,this.dm=0,this.status=!1,this.isHide=!0,this.listen()};$.prototype={show:function(t){this.$element.removeClass("hide"),this.select(t)},select:function(t){if(this.enable=!0,this.removeSelected(),t&&0===t.outputformat&&t.begin_at.time){var e,i=l(t).date,s=i.getHours(),a=i.getMinutes(),n=15*Math.round(s/15);i.setMinutes(n),this.selectedTime=o(s)+":"+o(a),this.$selected=this.$tc.find('[data-time="'+this.selectedTime+'"]').eq(0),0===this.$selected.length&&(this.$selected=this.createNormalItem(s,a,Math.floor(4*(s+a/60)*this.h))),this.$selected.removeClass("time-hover"),this.$selected.addClass("selected"),e=parseInt(this.$selected.css("top"),10),this.$tw.scrollTop(Math.max(0,e-this.vph/2))}else this.$tw.scrollTop(180);this.enable=!1},refresh:function(t){this.generateHTML();var e=this.$element.clone().attr("id","__tmp__").css({visibility:"hidden",display:"block",position:"absolute"});this.$element.parent().append(e),this.rh=e.find(".times-wrapper").prop("scrollHeight"),this.h=Math.floor((this.rh-this.hh-this.th)/(this.l-1)/12),this.a=Math.round(15/this.h);var i=e.offset();this.ox=i.left,this.oy=i.top,this.st=e.scrollTop(),this.vph=e.innerHeight(),e.remove(),this.select(t)},listen:function(){var t=this.$container,e=this.selector;t.on("mouseleave.datepanel",e,g(this.mouseleave,this)).on("mouseenter.datepanel",e+" .times-wrapper",g(this.meTW,this)).on("mousemove.datepanel",e+" .times-wrapper",g(this.mousemove,this)).on("mouseleave.datepanel",e+" .times-wrapper",g(this.mlTW,this)).on("click.datepanel",e+" .times-wrapper",g(this.clickTW,this)).on("click.datepanel",e+" .time-cates li[data-cate]",g(this.clickCT,this)),this.$tw.on("scroll.datepanel",g(this.scrollTop,this))},scrollTop:function(t){this.isHide&&(this.$cursor.removeClass("hide"),this.isHide=!1),this.enable||(t.pageX=this.px,t.pageY=this.py,this.st=this.$tw.scrollTop(),this.mousemove(t))},removeSelected:function(){this.$selected&&(this.selectedTime="",this.$selected.removeClass("selected"),delete this.$selected)},mouseleave:function(t){t.stopPropagation(),t.preventDefault(),this.$ft.addClass("hide")},mousemove:function(t){t.stopPropagation(),t.preventDefault();var e=this.y;this.px=t.pageX,this.py=t.pageY,this.x=this.px-this.ox,this.y=this.py-this.oy+this.st-this.hh,this.y=Math.max(0,Math.min(this.y,4*3*(this.l-1)*this.h)),e!==this.y&&(this.hoverItem(),this.showFuzzyTime(t.pageY))},clickCT:function(t){t.preventDefault(),this.removeSelected(),this.component.emit("rf-tl","",e(t.currentTarget).text())},showFuzzyTime:function(t){var e,i,s,a,n=0,h=this.ts,r=new Date(2012,12,21,this.dh,this.dm);p.find(h,function(t,s){return e=t.split(":"),i=new Date(2012,12,21,e[0],e[1]),i>r?(n=s,!0):void 0}),0===n&&(n=1),24===this.dh&&(n=14),--n,this.$ts.not(".hide").addClass("hide"),this.$ts.eq(n).removeClass("hide"),this.dh>=5&&22>this.dh&&(this.$ts.eq(n-1).removeClass("hide"),this.$ts.eq(n+1).removeClass("hide")),s=t-this.oy-this.th,a=this.$ts.not(".hide").length,this.$ft.stop(!0,!0).animate({top:s-18*((a+1)/2)},233)},meTW:function(){this.$cursor.removeClass("hide"),this.$ft.removeClass("hide")},mlTW:function(t){var e=this.$cursor;t&&t.preventDefault(),e.hasClass("time-label")||e.hasClass("selected")||e.addClass("hide")},clickTW:function(t){t.stopPropagation(),t.preventDefault();var e=this.$cursor,i=e.attr("data-time"),s=i.split(":"),a=0===+s[0]%3&&0===+s[1],n=this.$selected;if(e.addClass("hide"),n){if(n.removeClass("selected"),i===n.attr("date-time"))return;n.hasClass("time-label")||(n.remove(),delete this.$selected)}a?this.$selected=this.$tc.find('[data-time="'+i+'"]').eq(0):(this.$selected=e.clone().removeClass("hide time-hover"),e.before(this.$selected)),this.$selected.addClass("selected"),this.component.emit("rf-tl",this.selectedTime=this.$selected.data("time"),"")},hoverItem:function(){var t=Math.round(this.y/this.h)*this.h,e=t*this.a,i=+Math.floor(e/60).toFixed(0),s=e%60,a=o(i)+":"+o(s);this.dh=i,this.dm=s,this.$cursor.css("top",t).attr("data-time",a).find("time").text((12===i?i:i%12)+":"+o(s)+" "+(12>i?"A":"P")+"M")},createNormalItem:function(t,i,s){var a=e(this.divTmp.replace("{{class}}"," time-hover").replace("{{dt}}",o(t)+":"+o(i)).replace("{{t}}",t+":"+o(i)+" "+(12>t?"A":"P")+"M"));return a.css("top",s),this.$tc.append(a),a},createLabelItem:function(t,i,s){var a=e(this.divTmp.replace("{{class}}"," time-label").replace("{{dt}}",o(t)+":"+o(i)).replace("{{t}}",(12===t?t:t%12)+" "+(12>t?"A":"P")+"M"));return a.css("top",s),this.$tc.append(a),a},generateHTML:function(){for(var t=this.l,e=0,i=180,s=new Date(2012,12,21,21,0),a=0,n=0;t>e;++e)s.setMinutes(s.getMinutes()+i),a=s.getHours(),n=s.getMinutes(),8===e&&(a=24),this.createLabelItem(a,n,60*e);this.$cursor=this.createNormalItem(0,0,0).addClass("hide")}};var g=function(t,e){return t?function(i){return t.call(e,i)}:void 0},y=function(t){return t.getFullYear()+"-"+o(t.getMonth()+1)+"-"+o(t.getDate())},b=function(t,e){return e||(e=0),t=t.split("-"),new Date(t[0],+t[1]-1,+t[2]+e)},w=function(){var t=""+new Date,e=t.replace(/^(?:[\w\W]+([\+\-]\d\d):?(\d\d)[\w\W]+)$/,"$1:$2"),i=t.replace(/^(?:[\w\W]+\(([a-z]+)\)[\w\W]*)$/i,"$1");return("UTC"===i||"GMT"===i)&&(i=""),e+(i?" "+i:"")},T=function(t){return i?k(t):t.selectionEnd},k=function(t){var e=document.selection.createRange(),i=t.createTextRange(),s=i.duplicate();return i.moveToBookmark(e.getBookmark()),s.setEndPoint("EndToStart",i),s.text.length+e.text.length};return u});