define("datepanel",function(e){"use strict";var t=e("jquery"),i=t.browser.msie,s=e("humantime"),n=s.locales[s.locale],a=n.months,o=n.monthsShort,r=s.createEFTime,d=s.toLocaleDate,l=s.lead0,c=e("util"),h=c.trim,p=e("api"),f=e("rex"),u=e("panel").extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel" editarea="date-panel"><div class="panel-body"><div class="pull-left date-container"><div class="date-input"><input type="text" name="date-string" id="date-string" autocomplete="off" /><i class="pointer icon-enter-blue place-submit"></i></div><div class="date-calendar" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="year"></div><div class="full-month"></div><div class="table-wrapper"><table class="table" id="date-table"><tbody></tbody></table></div></div></div><div class="pull-right date-timeline hide"> <div class="fuzzy-time hide">   <ul class="unstyled time-cates">     <li data-cate="all-day">All-day</li>     <li class="hide" data-time="00:01" data-cate="late-night">Late-night</li>     <li class="hide" data-time="05:00" data-cate="dawn">Dawn</li>     <li class="hide" data-time="07:00" data-cate="breakfast">Breakfast</li>     <li class="hide" data-time="08:30" data-cate="morning">Morning</li>     <li class="hide" data-time="10:00" data-cate="brunch">Brunch</li>     <li class="hide" data-time="11:30" data-cate="lunch">Lunch</li>     <li class="hide" data-time="13:00" data-cate="noon">Noon</li>     <li class="hide" data-time="14:30" data-cate="afternoon">Afternoon</li>     <li class="hide" data-time="16:00" data-cate="tea-break">Tea-break</li>     <li class="hide" data-time="17:30" data-cate="off-work">Off-work</li>     <li class="hide" data-time="19:00" data-cate="dinner">Dinner</li>     <li class="hide" data-time="20:30" data-cate="evening">Evening</li>     <li class="hide" data-time="22:00" data-cate="night">Night</li>     <li class="hide" data-time="24:00" data-cate="late-night">Late-night</li>   </ul> </div> <div class="times-wrapper">   <div class="times"></div> </div></div></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var e=this.options;this.render(),this.originEftime=e.eftime,this.eftime=Cross.time,this.dateObj=d(this.eftime),delete e.eftime,this.timezone=b(),this.dateInput=new m(this,"#date-string"),this.calendarTable=new v(this,".date-calendar"),this.timeline=new g(this,".date-timeline"),this.listen()},initComponents:function(){var e=this.eftime,t=this.dateObj.date;this.calendarTable.refresh(t),0===this.originEftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select()),this.timeline.refresh(this.eftime),this.timeline.select(this.eftime),this.dateInput.change(e.origin||t.text),this.dateInput.$element.focusend(),this.eftime.begin_at.time&&this.showTL()},listen:function(){this.element.on("click.datepanel",".place-submit",x(this.submitSave,this)),this.element.on("keydown.datepanel",x(this.keydown,this)),this.on("save",this.save),this.on("tmt-ct",this.tmtCT),this.on("tmt-di",this.tmtDI),this.on("rf-di",this.rfDI),this.on("rf-tl",this.rfTL),this.on("rf-ct",this.rfCT),this.on("show-tl",this.showTL)},submitSave:function(){this.save()},save:function(e){e&&(this.eftime.origin=e),t("body").trigger("save-cross")},revert:function(){t.extend(!0,this.eftime,this.originEftime)},tmtCT:function(){var e=this.calendarTable.$element;setTimeout(function(){e.focus()},0)},tmtDI:function(){var e=this.dateInput.$element;setTimeout(function(){e.focus()},0)},rfDI:function(e){t.extend(!0,this.eftime,e),this.dateObj=d(e),this.calendarTable.refresh(this.dateObj.date),0===this.eftime.outputformat&&(this.calendarTable.addCursorStyle(),this.calendarTable.select(!0)),this.timeline.select(e)},rfTL:function(e,t){var i,s=this.eftime,n=this.dateObj.date,a="";s.begin_at.time="",e&&(i=e.split(":"),n.setHours(i[0]||0),n.setMinutes(i[1]||0),n.setSeconds(i[2]||0),s.begin_at.time=l(n.getUTCHours())+":"+l(n.getMinutes())+":"+l(n.getSeconds())),s.begin_at.time_word=t,a=e||t,s.outputformat?(s.outputformat=0,s.origin=a):(s.begin_at.date&&(a=y(n)+" "+a),s.origin=a),this.dateInput.change(s.origin)},rfCT:function(e){var t=this.eftime,i=this.dateObj.date,s="",n=e.split("-");if(i.setFullYear(n[0]),i.setMonth(n[1]-1),i.setDate(n[2]),s=i.getUTCFullYear()+"-"+l(i.getUTCMonth()+1)+"-"+l(i.getUTCDate()),t.begin_at.date=s,t.outputformat)t.outputformat=0,t.origin=e;else{var a="";t.begin_at.time?a=l(i.getHours())+":"+l(i.getMinutes()):(a=t.begin_at.time_word,t.begin_at.date=e),a=a?e+" "+a:e,t.origin=a}this.dateInput.change(t.origin)},showTL:function(){this.timeline.show(this.eftime)},keydown:function(e){var t=this,i=e.altKey,s=e.ctrlKey,n=e.shiftKey,a=e.metaKey,o=e.keyCode;27===o?(t.revert(),t.emit("save")):13===o&&!(i|n)&(s|a)&&t.emit&&t.emit("save")},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),i=this.element,s=i.outerWidth(),n=e.outerHeight();i.css({left:t.left-s+175-15,top:t.top+n+7})}this.initComponents()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),m=function(e,t){this.component=e,this.$container=e.element,this.tz=e.timezone,this.selector=t,this.$element=e.$(t),this.listen()};m.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("keydown.datepanel",t,x(this.keydown,this)).on("keypress.datepanel",t,x(this.keypress,this)).on("keyup.datepanel",t,x(this.keyup,this))},keyHandler:function(e){var t=this.component,i=e.keyCode;switch(i){case 9:e.preventDefault(),t.emit("tmt-ct");break;case 13:e.preventDefault(),t.emit("save",h(this.$element.val()));break;case 40:var s=this.$element.val(),n=s.length,a=this.$element[0],o=w(a);n===o&&(e.preventDefault(),t.emit("tmt-ct"))}},keydown:function(e){this.suppressKeyPressRepeat=!!~f.indexOf([9,13,40],e.keyCode),this.keyHandler(e)},keypress:function(e){this.suppressKeyPressRepeat||this.keyHandler(e)},keyup:function(e){switch(e.stopPropagation(),e.preventDefault(),e.keyCode){case 9:case 13:case 16:case 17:case 18:case 27:case 37:case 38:case 39:case 40:break;default:this.lookup()}},lookup:function(){var e=this,t=e.component,i=h(e.$element.val());return e.befer&&(e.befer.abort(),e.befer=void 0),""===i?(t.emit("rf-di",r()),void 0):(e.befer=p.request("recognize",{type:"POST",data:{time_string:i,timezone:e.tz}},function(e){t&&t.emit("rf-di",e.cross_time)}),void 0)},change:function(e){this.$element.val(e)}};var v=function(e,t){this.component=e,this.$container=e.element,this.selector=t,this.$element=e.$(t),this.today=new Date,this.todayString=y(this.today),this.cx=0,this.cy=0,this.vpr=3,this.vph=44,this.len=0,this.divTmp='<div class="tw"><span class="m hide">{{m}}</span><span class="d">{{d}}</span></div>',this.$y=this.$element.find(".year"),this.$m=this.$element.find(".full-month"),this.$tw=this.$element.find(".table-wrapper"),this.$tb=this.$tw.find("tbody"),this.inited=!0,this.enable=!1,this.listen()};v.prototype={init:function(e){var t=this.vpr,i=this.vph,s=e.getFullYear(),n=e.getMonth(),a=e.getDate(),o=e.getDay();e=new Date(s,n,a-o-21),this.startDate=y(e),this.genNext(e),this.genNext(e),this.genNext(e),this.endDate=y(e),this.cx=o,this.cy=t,this.scrollTop(t*i),this.$trs=this.$tb.find("tr"),this.inited&&(this.st=this.$tw.prop("scrollHeight")-this.$tw.outerHeight(),this.inited=!1)},refresh:function(e){this.$trs=this.$cursor=null,this.len=0,this.$tb.empty(),this.init(e)},getSelectedDate:function(){return this.selectedDate||this.todayString},listen:function(){var e=this.$container,t=this.selector;e.on("blur.datepanel",t,x(this.blur,this)).on("focus.datepanel",t,x(this.focus,this)).on("keydown.datepanel",t,x(this.keydown,this)).on("keypress.datepanel",t,x(this.keypress,this)).on("keyup.datepanel",t,x(this.keyup,this)).on("click.datepanel",t+" td",x(this.clickDate,this)).on("mouseenter.datepanel",t+" td",x(this.mouseenterDate,this)),this.$tw.on("scroll.datepanel",x(this.scroll,this))},scroll:function(e){this.enable,e.stopPropagation(),e.preventDefault();var t=this.$tw,i=t.scrollTop(),s=!1,n=this.$y,a=this.$m;(0===i||this.st===i)&&(this.enable=!0,this[0===i?"mpageUp":"mpageDown"](),this.$tw.scrollTop(this.vph*this.vpr),s=!0),this.updateYearMonth(),n.toggleClass("hide",s),a.toggleClass("hide",s)},updateYearMonth:function(){if(this.$cursor){var e=_(this.$cursor.data("date"));this.$y.text(e.getFullYear()),this.$m.text(a[e.getMonth()])}},delCursorStyle:function(){this.$cursor&&this.$cursor.removeClass("hover")},addCursorStyle:function(){this.$cursor=this.$trs.eq(this.cy).find("td").eq(this.cx).addClass("hover")},blur:function(){this.delCursorStyle()},focus:function(){this.addCursorStyle()},scrollTop:function(e){this.$tw.scrollTop(e)},keyHandler:function(e){var t=this,i=this.component,s=e.keyCode;switch(s){case 9:e.preventDefault(),i.emit("tmt-di");break;case 37:e.preventDefault(),t.move("left");break;case 38:e.preventDefault(),t.move("top");break;case 39:e.preventDefault(),t.move("right");break;case 40:e.preventDefault(),t.move("down");break;case 33:e.preventDefault(),t.move("pageUp");break;case 34:e.preventDefault(),t.move("pageDown");break;case 13:e.preventDefault();break;case 32:e.preventDefault(),t.spacing();break;case 68:e.preventDefault(),t.refresh(_(t.getSelectedDate()));break;case 84:e.preventDefault(),t.refresh(t.today);break;case 35:case 36:}},keydown:function(e){this.suppressKeyPressRepeat=!!~f.indexOf([9,13,32,33,34,35,36,37,38,39,40,68,84],e.keyCode),this.keyHandler(e)},keypress:function(e){return this.suppressKeyPressRepeat?!1:(this.keyHandler(e),void 0)},keyup:function(e){e.stopPropagation(),e.preventDefault()},clickDate:function(e){e.preventDefault(),this.spacing(),this.component.emit("show-tl")},spacing:function(){this.selectedDate&&this.$tb.find('td[data-date="'+this.selectedDate+'"]').removeClass("selected"),this.select()},select:function(e){this.selectedDate&&this.$trs.find("td.selected").removeClass("selected");var t=this.selectedDate=this.$cursor.data("date");this.$cursor.addClass("selected"),this.updateYearMonth(),e||this.component.emit("rf-ct",t)},mouseenterDate:function(e){e.preventDefault(),this.delCursorStyle();var i=t(e.currentTarget),s=i.parent();this.cx=i.index(),this.cy=s.index(),this.addCursorStyle()},move:function(e){this.enable=!0,this.delCursorStyle(),this["m"+e](),this.addCursorStyle(),this.enable=!1},mleft:function(){0===this.cx--&&(this.cx=6,this.mtop())},mtop:function(){if(0===this.cy--){this.delTail3();var e=_(this.startDate,-21);this.startDate=y(e),this.genPrev(e),this.$trs=this.$tb.find("tr"),this.cy=2,this.$tw.scrollTop(this.vph*this.cy)}var t=this.$tw.scrollTop();t=Math.round(t/this.vph)*this.vph,t>this.cy*this.vph&&this.$tw.scrollTop(t-=this.vph)},mright:function(){6===this.cx++&&(this.cx=0,this.mdown())},mdown:function(){if(this.len===++this.cy){this.delHead3();var e=_(this.endDate,0);this.genNext(e),this.endDate=y(e),this.$trs=this.$tb.find("tr"),this.cy=7,this.$tw.scrollTop(5*this.vph)}var t=this.$tw.scrollTop();t=Math.round(t/this.vph)*this.vph,this.cy*this.vph>t+this.vph*(this.vpr-1)&&this.$tw.scrollTop(t+=this.vph)},mpageUp:function(){this.delTail3();var e=_(this.startDate,-21);this.startDate=y(e),this.genPrev(e),this.$trs=this.$tb.find("tr")},mpageDown:function(){this.delHead3();var e=_(this.endDate,0);this.genNext(e),this.$trs=this.$tb.find("tr"),this.endDate=y(e)},generateHTML:function(e){var t,i=this.vpr,s=this.todayString,n=this.selectedDate,a=this.divTmp,r="",d=0;for(this.len+=i;i>d;++d){for(var l,c,h,p,f=0,u="<tr>",m="";7>f;++f)p="",l=y(e),c=l===s,h=l===n,c&&(p="today"),h&&(p+=(p.length?" ":"")+"selected"),m+='<td data-date="'+l+'"'+(p.length?' class="'+p+'"':"")+">",t=e.getDate(),m+=a.replace("{{m}}",o[e.getMonth()]).replace("{{d}}",c?"Today":t),m+="</td>",e.setDate(t+1);u+=m+"</tr>",r+=u}return r},genPrev:function(e){this.$tb.prepend(this.generateHTML(e))},genNext:function(e){this.$tb.append(this.generateHTML(e))},delHead3:function(){this.startDate=this.$trs.eq(0).find("td").eq(0).data("date"),this.$trs.eq(0).remove(),this.$trs.eq(1).remove(),this.$trs.eq(2).remove(),this.len-=3},delTail3:function(){this.endDate=this.$trs.eq(this.len-3).find("td").eq(0).data("date"),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove(),this.$trs.eq(--this.len).remove()}};var g=function(e,i){this.component=e,this.$container=e.element,this.selector=i,this.$element=e.$(i),this.divTmp='<div class="time-item{{class}}" data-time="{{dt}}"><time>{{t}}</time></div>',this.$tw=this.$element.find(".times-wrapper"),this.$tc=this.$element.find(".times"),this.$ft=this.$element.find(".fuzzy-time"),this.$ts=this.$ft.find(".time-cates > li[data-time]"),this.ts=f.map(this.$ts,function(e){return t(e).data("time")}),this.x=0,this.y=0,this.px=0,this.py=0,this.l=9,this.hh=7,this.th=7,this.dh=0,this.dm=0,this.status=!1,this.isHide=!0,this.listen()};g.prototype={show:function(e){this.$element.removeClass("hide"),this.select(e)},select:function(e){if(this.enable=!0,this.removeSelected(),e&&0===e.outputformat&&e.begin_at.time){var t,i=d(e).date,s=i.getHours(),n=i.getMinutes(),a=15*Math.round(s/15);i.setMinutes(a),this.selectedTime=l(s)+":"+l(n),this.$selected=this.$tc.find('[data-time="'+this.selectedTime+'"]').eq(0),0===this.$selected.length&&(this.$selected=this.createNormalItem(s,n,Math.floor(4*(s+n/60)*this.h))),this.$selected.removeClass("time-hover"),this.$selected.addClass("selected"),t=parseInt(this.$selected.css("top"),10),this.$tw.scrollTop(Math.max(0,t-this.vph/2))}else this.$tw.scrollTop(180);this.enable=!1},refresh:function(e){this.generateHTML();var t=this.$element.clone().attr("id","__tmp__").css({visibility:"hidden",display:"block",position:"absolute"});this.$element.parent().append(t),this.rh=t.find(".times-wrapper").prop("scrollHeight"),this.h=Math.floor((this.rh-this.hh-this.th)/(this.l-1)/12),this.a=Math.round(15/this.h);var i=t.offset();this.ox=i.left,this.oy=i.top,this.st=t.scrollTop(),this.vph=t.innerHeight(),t.remove(),this.select(e)},listen:function(){var e=this.$container,t=this.selector;e.on("mouseleave.datepanel",t,x(this.mouseleave,this)).on("mouseenter.datepanel",t+" .times-wrapper",x(this.meTW,this)).on("mousemove.datepanel",t+" .times-wrapper",x(this.mousemove,this)).on("mouseleave.datepanel",t+" .times-wrapper",x(this.mlTW,this)).on("click.datepanel",t+" .times-wrapper",x(this.clickTW,this)).on("click.datepanel",t+" .time-cates li[data-cate]",x(this.clickCT,this)),this.$tw.on("scroll.datepanel",x(this.scrollTop,this))},scrollTop:function(e){this.isHide&&(this.$cursor.removeClass("hide"),this.isHide=!1),this.enable||(e.pageX=this.px,e.pageY=this.py,this.st=this.$tw.scrollTop(),this.mousemove(e))},removeSelected:function(){this.$selected&&(this.selectedTime="",this.$selected.removeClass("selected"),delete this.$selected)},mouseleave:function(e){e.stopPropagation(),e.preventDefault(),this.$ft.addClass("hide")},mousemove:function(e){e.stopPropagation(),e.preventDefault();var t=this.y;this.px=e.pageX,this.py=e.pageY,this.x=this.px-this.ox,this.y=this.py-this.oy+this.st-this.hh,this.y=Math.max(0,Math.min(this.y,4*3*(this.l-1)*this.h)),t!==this.y&&(this.hoverItem(),this.showFuzzyTime(e.pageY))},clickCT:function(e){e.preventDefault(),this.removeSelected(),this.component.emit("rf-tl","",t(e.currentTarget).text())},showFuzzyTime:function(e){var t,i,s,n,a=0,o=this.ts,r=new Date(2012,12,21,this.dh,this.dm);f.find(o,function(e,s){return t=e.split(":"),i=new Date(2012,12,21,t[0],t[1]),i>r?(a=s,!0):void 0}),0===a&&(a=1),24===this.dh&&(a=14),--a,this.$ts.not(".hide").addClass("hide"),this.$ts.eq(a).removeClass("hide"),this.dh>=5&&22>this.dh&&(this.$ts.eq(a-1).removeClass("hide"),this.$ts.eq(a+1).removeClass("hide")),s=e-this.oy-this.th,n=this.$ts.not(".hide").length,this.$ft.stop(!0,!0).animate({top:s-18*((n+1)/2)},233)},meTW:function(){this.$cursor.removeClass("hide"),this.$ft.removeClass("hide")},mlTW:function(e){var t=this.$cursor;e&&e.preventDefault(),t.hasClass("time-label")||t.hasClass("selected")||t.addClass("hide")},clickTW:function(e){e.stopPropagation(),e.preventDefault();var t=this.$cursor,i=t.attr("data-time"),s=i.split(":"),n=0===+s[0]%3&&0===+s[1],a=this.$selected;if(t.addClass("hide"),a){if(a.removeClass("selected"),i===a.attr("date-time"))return;a.hasClass("time-label")||(a.remove(),delete this.$selected)}n?this.$selected=this.$tc.find('[data-time="'+i+'"]').eq(0):(this.$selected=t.clone().removeClass("hide time-hover"),t.before(this.$selected)),this.$selected.addClass("selected"),this.component.emit("rf-tl",this.selectedTime=this.$selected.data("time"),"")},hoverItem:function(){var e=Math.round(this.y/this.h)*this.h,t=e*this.a,i=+Math.floor(t/60).toFixed(0),s=t%60,n=l(i)+":"+l(s);this.dh=i,this.dm=s,this.$cursor.css("top",e).attr("data-time",n).find("time").text((12===i?i:i%12)+":"+l(s)+" "+(12>i?"A":"P")+"M")},createNormalItem:function(e,i,s){var n=t(this.divTmp.replace("{{class}}"," time-hover").replace("{{dt}}",l(e)+":"+l(i)).replace("{{t}}",e+":"+l(i)+" "+(12>e?"A":"P")+"M"));return n.css("top",s),this.$tc.append(n),n},createLabelItem:function(e,i,s){var n=t(this.divTmp.replace("{{class}}"," time-label").replace("{{dt}}",l(e)+":"+l(i)).replace("{{t}}",(12===e?e:e%12)+" "+(12>e?"A":"P")+"M"));return n.css("top",s),this.$tc.append(n),n},generateHTML:function(){for(var e=this.l,t=0,i=180,s=new Date(2012,12,21,21,0),n=0,a=0;e>t;++t)s.setMinutes(s.getMinutes()+i),n=s.getHours(),a=s.getMinutes(),8===t&&(n=24),this.createLabelItem(n,a,60*t);this.$cursor=this.createNormalItem(0,0,0).addClass("hide")}};var x=function(e,t){return e?function(i){return e.call(t,i)}:void 0},y=function(e){return e.getFullYear()+"-"+l(e.getMonth()+1)+"-"+l(e.getDate())},_=function(e,t){return t||(t=0),e=e.split("-"),new Date(e[0],+e[1]-1,+e[2]+t)},b=function(){var e=""+new Date,t=e.replace(/^(?:[\w\W]+([\+\-]\d\d):?(\d\d)[\w\W]+)$/,"$1:$2"),i=e.replace(/^(?:[\w\W]+\(([a-z]+)\)[\w\W]*)$/i,"$1");return("UTC"===i||"GMT"===i)&&(i=""),t+(i?" "+i:"")},w=function(e){return i?E(e):e.selectionEnd},E=function(e){var t=document.selection.createRange(),i=e.createTextRange(),s=i.duplicate();return i.moveToBookmark(t.getBookmark()),s.setEndPoint("EndToStart",i),s.text.length+t.text.length};return u});