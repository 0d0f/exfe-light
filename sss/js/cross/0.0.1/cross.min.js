define(function(e){ExfeUtilities={trim:function(e){return e?e.replace(/^\s+|\s+$/g,""):""},escape:function(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},clone:function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var n in e)t[n]=this.clone(e[n]);break;case"[object Array]":t=[];for(n in e)t.push(this.clone(e[n]));break;default:t=e}return t},getTimezone:function(){var e=Date().toString(),t=e.replace(/^.+([+-]\d{2})(\d{2}).+$/i,"$1:$2"),n=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return n=n==="UTC"||n==="GMT"?"":n,t+(n===e?"":" "+n)},parsePlacestring:function(e){var t=e?e.split(/\r\n|\r|\n/g):[],n=[];for(var r=0;r<t.length;r++)t[r]&&n.push(t[r]);var i=n.shift();return i=i?i:"",{title:i,description:n.join("\r"),lng:"",lat:"",provider:"",external_id:"",id:Cross.place.id,type:"Place"}}},ExfeeCache={identities:[],tried_key:{},updated_identity:[],init:function(){var e=Store.get("exfee_cache_user_id"),t=Store.get("exfee_cache_identities");if(!User||!User.id||!e||User.id!==e||!t)t=[];this.identities=[];for(var n=0;n<t.length;n++)t[n].external_username&&this.identities.push(t[n])},saveCache:function(){User&&User.id&&(Store.set("exfee_cache_user_id",User.id),Store.set("exfee_cache_identities",this.identities))},search:function(e){var t=function(e,t){return t?t.toLowerCase().indexOf(e)!==-1:!1},n=function(e,n){return t(e,n.external_id)||t(e,n.external_username)||t(e,n.name)},r=[];e=e.toLowerCase();for(var i=0;i<this.identities.length;i++)n(e,this.identities[i])&&!ExfeeWidget.isMyIdentity(this.identities[i])&&ExfeeWidget.checkExistence(this.identities[i])===!1&&r.push(ExfeUtilities.clone(this.identities[i]));return r},cacheIdentities:function(e,t){e=ExfeUtilities.clone(e);for(var n=0;n<e.length;n++){for(var r=0;r<this.identities.length;r++)ExfeeWidget.compareIdentity(e[n],this.identities[r])&&this.identities.splice(r,1);t?this.identities.unshift(e[n]):this.identities.push(e[n]),this.identities.length>233&&this.identities.splice(233),this.updated_identity.push(e[n])}this.saveCache()},fetchIdentity:function(e){for(var t=0;t<this.identities.length;t++)if(ExfeeWidget.compareIdentity(e,this.identities[t]))return ExfeUtilities.clone(this.identities[t]);return null}},ExfeeWidget={dom_id:"",rsvp_status:["Pending","Accepted","Unavailable","Interested"],editable:!1,complete_timer:0,complete_key:"",complete_exfee:[],complete_request:0,selected:"",completing:!1,callback:function(){},last_inputed:{},base_info_timer:0,api_url:"",focus:{},soft_limit:12,hard_limit:50,make:function(e,t,n){return this.dom_id=e,this.editable=t,this.callback=n,$("#"+this.dom_id+" .total").css("visibility","hidden"),$("#"+this.dom_id+" .avatar .rb").hide(),$("#"+this.dom_id).bind("mouseenter mouseleave",function(t){switch(t.type){case"mouseenter":$("#"+e+" .total").css("visibility","visible"),$("#"+e+" .avatar .rb").show(),!readOnly;break;case"mouseleave":!ExfeeWidget.focus[e+"-input"]&&$("#"+e+" .exfee-input").val()===""&&($("#"+e+" .total").css("visibility","hidden"),$("#"+e+" .avatar .rb").hide(),ExfeeWidget.showLimitWarning(!1))}}),$("#"+this.dom_id+" .input-xlarge").bind("focus keydown blur",this.inputEvent),$("#"+this.dom_id+" .pointer").bind("click",function(){ExfeeWidget.checkInput($("#"+e+" .input-xlarge"),!0)}),$(document).on("mousedown","#"+this.dom_id+" .thumbnails > li.identity > .avatar",function(e){ExfeeWidget.showPanel(this.parentNode)}),this.complete_timer=setInterval("ExfeeWidget.checkInput($('#"+this.dom_id+" .input-xlarge'))",50),ExfeUtilities.clone(this)},showAll:function(e,t){var n=0,r=0,i=["ACCEPTED","INTERESTED","NORESPONSE","DECLINED","IGNORED"];$("#"+this.dom_id+" .thumbnails").html("");for(var s=0;s<i.length;s++)for(var o=0;o<Exfee.invitations.length;o++)if(Exfee.invitations[o].rsvp_status===i[s]){var u=Exfee.invitations[o].mates+1;(!e||!ExfeeWidget.isMyIdentity(Exfee.invitations[o].identity))&&this.showOne(Exfee.invitations[o],t),Exfee.invitations[o].rsvp_status==="ACCEPTED"&&(n+=u),r+=u}$("#"+this.dom_id+" .attended").html(n),$("#"+this.dom_id+" .total").html("of "+r)},showOne:function(e,t){var n={ACCEPTED:"icon14-rsvp-accepted-blue",DECLINED:"icon14-rsvp-declined",INTERESTED:"icon14-rsvp-interested",NORESPONSE:"icon14-rsvp-noresponse"};$("#"+this.dom_id+" .thumbnails").append('<li class="identity" id="'+e.identity.id+'" provider="'+e.identity.provider.toLowerCase()+'" external_id="'+e.identity.external_id.toLowerCase()+'" external_username="'+e.identity.external_username.toLowerCase()+'">'+'<span class="pointer avatar'+(t&&e.rsvp_status!=="ACCEPTED"?" unconfirmed":"")+'">'+'<img src="'+e.identity.avatar_filename+'" alt="'+e.identity.external_id+'" width="50" height="50" />'+'<i class="rt'+(e.host?" icon10-host-h":"")+'"></i>'+'<i class="icon10-plus-'+e.mates+' lt"></i>'+(this.dom_id==="cross-exfee"?'<span class="rb rb-bg'+(ExfeeWidget.focus[this.dom_id+"-input"]?"":" hide")+'">'+'<i class="'+n[e.rsvp_status]+'"></i>'+"</span>":"")+"</span>"+'<div class="identity-name">'+e.identity.name+"</div>"+"</li>")},showLimitWarning:function(e){$(".exfee-warning").toggleClass("hide",e===!1)},showTip:function(e){var t=$(e),n=t.offset(),r={},i=t.attr("id"),s=t.attr("provider"),o=t.attr("external_id"),u=t.attr("external_username");if(i=~~i)r.id=i;s&&(r.provider=s),o&&(r.external_id=o),u&&(r.external_username=u);var a=this.getInvitationByIdentity(r);ExfeePanel.showTip(a,n.left,n.top+50)},showPanel:function(e){var t=$(e),n=t.offset(),r={},i=t.attr("id"),s=t.attr("provider"),o=t.attr("external_id"),u=t.attr("external_username");if(i=~~i)r.id=i;s&&(r.provider=s),o&&(r.external_id=o),u&&(r.external_username=u);var a=this.getInvitationByIdentity(r);ExfeePanel.showPanel(a,n.left+5,n.top+5)},compareIdentity:function(e,t){if(e.id&&t.id&&e.id===t.id)return!0;if(ExfeUtilities.trim(e.provider).toLowerCase()===ExfeUtilities.trim(t.provider).toLowerCase()){if(e.external_id&&t.external_id&&ExfeUtilities.trim(e.external_id).toLowerCase()===ExfeUtilities.trim(t.external_id).toLowerCase())return!0;if(e.external_username&&t.external_username&&ExfeUtilities.trim(e.external_username).toLowerCase()===ExfeUtilities.trim(t.external_username).toLowerCase())return!0}return!1},checkExistence:function(e){for(var t=0;t<Exfee.invitations.length;t++)if(this.compareIdentity(Exfee.invitations[t].identity,e))return t;return!1},addExfee:function(e,t,n){var r=ExfeeWidget.summary().items;if(r<ExfeeWidget.hard_limit&&e){var i=this.checkExistence(e);return i===!1?(Exfee.invitations.push({identity:ExfeUtilities.clone(e),rsvp_status:n?n:"NORESPONSE",host:!!t,mates:0}),this.callback()):Exfee.invitations[i].rsvp_status==="REMOVED"&&(Exfee.invitations[i].rsvp_status="NORESPONSE",this.callback()),!0}return!1},delExfee:function(e){this.rsvpExfee(e,"REMOVED")},rsvpExfee:function(e,t){var n=this.checkExistence(e);if(n!==!1){Exfee.invitations[n].rsvp_status=t,Exfee.invitations[n].by_identity=ExfeUtilities.clone(curIdentity);var r=!1;t==="REMOVED"&&curIdentity&&ExfeeWidget.compareIdentity(Exfee.invitations[n].identity,curIdentity)&&(r=!0),this.callback(r)}},changeMates:function(e,t){var n=this.checkExistence(e);n!==!1&&(t>9&&(t=9),t<0&&(t=0),Exfee.invitations[n].mates=t,this.callback())},rsvpMe:function(e){this.rsvpExfee(curIdentity,e)},summary:function(){var e={items:0,accepted:0,total:0,accepted_invitations:[]};for(var t=0;t<Exfee.invitations.length;t++){if(Exfee.invitations[t].rsvp_status==="REMOVED"||Exfee.invitations[t].rsvp_status==="NOTIFICATION")continue;e.items++;var n=1+Exfee.invitations[t].mates;e.total+=n,Exfee.invitations[t].rsvp_status==="ACCEPTED"&&(e.accepted+=n,e.accepted_invitations.push(Exfee.invitations[t]))}return e},getUTF8Length:function(e){var t=0;if(e)for(var n=0;n<e.length;n++)charCode=e.charCodeAt(n),charCode<127?t+=1:128<=charCode&&charCode<=2047?t+=2:2048<=charCode&&charCode<=65535&&(t+=3);return t},cutLongName:function(e){e=e?e.replace(/[^0-9a-zA-Z_\u4e00-\u9fa5\ \'\.]+/g," "):"";while(this.getUTF8Length(e)>30)e=e.substring(0,e.length-1);return e},parseAttendeeInfo:function(e){e=ExfeUtilities.trim(e);var t={id:0,name:"",external_id:"",external_username:"",provider:"",type:"identity"};if(/^[^@]*<[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?>$/.test(e)){var n=e.indexOf("<"),r=e.indexOf(">");t.external_id=ExfeUtilities.trim(e.substring(++n,r)),t.external_username=t.external_id,t.name=ExfeUtilities.trim(this.cutLongName(ExfeUtilities.trim(e.substring(0,n)).replace(/^"|^'|"$|'$/g,""))),t.provider="email"}else if(/^[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&\'*+\\\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e))t.external_id=e,t.external_username=e,t.name=ExfeUtilities.trim(this.cutLongName(e.split("@")[0])),t.provider="email";else if(/^@[a-z0-9_]{1,15}$|^@[a-z0-9_]{1,15}@twitter$|^[a-z0-9_]{1,15}@twitter$/i.test(e))t.external_id="",t.external_username=e.replace(/^@|@twitter$/ig,""),t.name=t.external_username,t.provider="twitter";else{if(!/^[a-z0-9\.]{5,}@facebook$/i.test(e))return null;t.external_id="",t.external_username=e.replace(/@facebook$/ig,""),t.name=t.external_username,t.provider="facebook"}return t.avatar_filename=encodeURI(ExfeeWidget.api_url+"/avatar/default?name="+t.name),t},checkComplete:function(e,t,n){this.showCompleteItems(e,t,t?ExfeeCache.search(t):[],n),this.ajaxComplete(e,t)},displayIdentity:function(e,t){switch(e?e.provider:""){case"email":case"phone":if(/^\+1.{10}$/.test(e.external_id))return e.external_id.replace(/^(\+1)(.{3})(.{3})(.{4})$/,"$1 ($2) $3-$4");if(/^\+86.{11}$/.test(e.external_id))return e.external_id.replace(/^(\+86)(.{3})(.{4})(.{4})$/,"$1 $2 $3 $4");return e.external_id;case"twitter":return"@"+e.external_username+(t?"":"@twitter");case"facebook":return e.external_username+(t?"":"@facebook");default:return""}},displayCompletePanel:function(e,t){if(this.completing=t){var n=e.offset();$(".ids-popmenu").css({left:n.left+"px",top:n.top+e.height()+10+"px","max-height":"352px","overflow-y":"scroll"}).slideDown(50)}else $(".ids-popmenu").slideUp(50)},showCompleteItems:function(t,n,r,i){n=n.replace(/^\+/,"");var s=function(e){var t=new RegExp("("+n+")");return e?e.replace(t,'<span class="highlight">$1</span>'):""},o=$(".ids-popmenu > ol"),u="";n=n?n.toLowerCase():"",ExfeeWidget.complete_key!==n&&(ExfeeWidget.complete_exfee=[],o.html("")),ExfeeWidget.complete_key=n;for(var a=0;a<r.length;a++){var f=!1;for(var l=0;l<ExfeeWidget.complete_exfee.length;l++)if(this.compareIdentity(ExfeeWidget.complete_exfee[l],r[a])){f=!0;break}if(f)continue;var c=ExfeeWidget.complete_exfee.push(ExfeUtilities.clone(r[a]))-1,h=r[a].provider;u+="<li"+(c?"":' class="active"')+">"+'<span class="pull-left avatar">'+'<img src="'+r[a].avatar_filename+'" alt="" width="40" height="40">'+'<span class="rb"><i class="icon16-identity-'+r[a].provider+'"></i></span>'+"</span>"+'<div class="identity">'+'<div class="name">'+s(r[a].name)+"</div>"+"<div>"+'<span class="oblique external">'+s(this.displayIdentity(r[a],!0))+"</span>"+(h==="email"||h==="phone"?"":' <span class="provider">@'+h.charAt(0).toUpperCase()+h.substr(1)+"</span>")+"</div>"+"</div>"+"</li>"}o.append(u),this.displayCompletePanel(t,n&&ExfeeWidget.complete_exfee.length);var p=n.replace(/\-|\(|\)|\ /g,"");if(p&&i&&!ExfeeWidget.complete_exfee.length&&!$("#phone-panel").length&&/^\+?[0-9]{5,15}$/.test(p)){var d=e("phonepanel"),v=new d({options:{parentNode:$("#app-tmp"),srcNode:t},add:function(e){ExfeeWidget.addExfee(e),t.val("")}});v.show()}},isMyIdentity:function(e){return curIdentity&&(this.compareIdentity(e,curIdentity)||e.connected_user_id===curIdentity.connected_user_id)},getInvitationByIdentity:function(e){for(var t=0;t<Exfee.invitations.length;t++)if(this.compareIdentity(Exfee.invitations[t].identity,e))return Exfee.invitations[t];return null},getMyInvitation:function(){return curIdentity?this.getInvitationByIdentity(curIdentity):null},ajaxComplete:function(e,t){if(!User||!t||typeof ExfeeCache.tried_key[t]!="undefined")return;this.complete_request&&this.complete_request.abort(),this.complete_request=Api.request("complete",{type:"get",data:{key:t}},function(n){var r=[];for(var i=0;i<n.identities.length;i++)!ExfeeWidget.isMyIdentity(n.identities[i])&&ExfeeWidget.checkExistence(n.identities[i])===!1&&r.push(n.identities[i]),ExfeeCache.cacheIdentities(r),ExfeeCache.tried_key[t]=!0,ExfeeWidget.complete_key===t&&ExfeeWidget.showCompleteItems(e,t,r)})},ajaxIdentity:function(e){e&&e.length&&Api.request("getIdentity",{type:"POST",data:{identities:JSON.stringify(e)}},function(e){var t=[];for(var n=0;n<e.identities.length;n++){var r=ExfeeWidget.checkExistence(e.identities[n]);r!==!1&&(Exfee.invitations[r].identity=e.identities[n]),t.push(e.identities[n])}t.length&&(ExfeeCache.cacheIdentities(t),window.GatherExfeeWidget.showAll(!0),window.CrossExfeeWidget.showAll(!1,!0))})},checkInput:function(e,t){if(!e||!e.length)return;var n=e.val(),r=n.split(/,|;|\r|\n|\t/),i=[],s=[],o="",u="";if(ExfeeWidget.last_inputed[e[0].id]===n&&!t)return;ExfeeWidget.last_inputed[e[0].id]=n;for(var a=0;a<r.length;a++)if(o=ExfeUtilities.trim(r[a])){var f=ExfeeWidget.parseAttendeeInfo(o);f&&(~~a<r.length-1||t)&&this.addExfee(f)?i.push(f):(s.push(r[a]),u=r[a])}var l=s.join("; ");l!==n&&e.val(l),this.ajaxIdentity(i),ExfeeWidget.summary().items>=ExfeeWidget.hard_limit&&n?(u="",this.showLimitWarning()):this.showLimitWarning(!1);var c=!!ExfeeWidget.parseAttendeeInfo(u);e.parent().find(".pointer").toggleClass("icon16-exfee-plus-blue",c).toggleClass("icon16-exfee-plus",!c),this.checkComplete(e,u.replace(/^@/,""),t)},selectCompleteItem:function(e){var t="active";$(".ids-popmenu > ol > li").removeClass(t).eq(e).addClass(t)},useCompleteItem:function(e){var t=ExfeeCache.fetchIdentity(this.complete_exfee[e]);t?(this.complete_exfee.splice(e,1),ExfeeCache.cacheIdentities(t)):t=ExfeUtilities.clone(this.complete_exfee[e]),this.addExfee(t)},inputEvent:function(e){var t=$(e.target);switch(e.type){case"focus":ExfeeWidget.focus[e.target.id]=!0;break;case"keydown":switch(e.which){case 9:ExfeeWidget.checkInput(t,!0);break;case 13:var n=$(".ids-popmenu > ol > .active"),r=n.length?~~n.index():null;ExfeeWidget.completing&&r!==null?(ExfeeWidget.useCompleteItem(r),ExfeeWidget.displayCompletePanel(t,!1),t.val("")):ExfeeWidget.checkInput(t,!0);break;case 27:ExfeeWidget.completing&&ExfeeWidget.displayCompletePanel(t,!1);break;case 38:case 40:e.preventDefault();var i=$(".ids-popmenu"),s=352,o=50,u=i.scrollTop();if(!ExfeeWidget.completing)return;var n=i.find("ol .active"),r=~~n.index(),a=ExfeeWidget.complete_exfee.length-1;switch(e.which){case 38:--r<0&&(r=a);break;case 40:++r>a&&(r=0)}ExfeeWidget.selectCompleteItem(r);var f=r*o,l=f-u;l<0?i.scrollTop(f):l+o>s&&i.scrollTop(f+o-s+1)}break;case"blur":ExfeeWidget.focus[e.target.id]=!1,ExfeeWidget.displayCompletePanel(t,!1)}}}}),define("exfeepanel",function(e,t,n){var r=$("body");return r.bind("click",function(e){var t=e.target;while(t&&!$(t).hasClass("exfee_pop_up")&&!$(t).hasClass("exfee_pop_up_save")&&t.tagName!=="BODY")t=t.parentNode;!$(t).hasClass("exfee_pop_up")&&!$(t).hasClass("exfee_pop_up_save")&&$(".exfee_pop_up").hide().remove()}),{objBody:r,tipId:"",panelId:"",arrRsvp:{NORESPONSE:["Pending"],ACCEPTED:["Accepted"],INTERESTED:["Interested"],DECLINED:["Unavailable"],IGNORED:["Pending"]},invitation:{},editing:"",pre_delete:!1,newId:function(e){return"id_"+e.identity.id+"provider_"+e.identity.provider+"external_id_"+e.identity.external_id+"external_username_"+e.identity.external_username},showTip:function(e,t,n){var r=this.newId(e),i='<div class="tooltip tip-exfee  exfee_pop_up" style="left: '+t+"px; top: "+n+'px;">'+'<div class="tooltip-inner">'+"<h5>"+e.identity.name+"</h5>"+"<div>"+'<i class="icon16-identity-'+e.identity.provider+'"></i>'+'<span class="oblique">'+ExfeeWidget.displayIdentity(e.identity,!0)+"</span>"+"</div>"+"</div>"+"</div>";if(this.tipId!==r||!$(".tip-exfee").length)this.tipId=r,this.hideTip(),this.objBody.append(i),$(".exfeetip").show()},showPanel:function(e,t,n){var r=this.newId(e),i='<div class="exfeepanel exfee_pop_up" style="left: '+t+"px; top: "+n+'px; z-index: 10">'+'<div class="tooltip-inner">'+'<div class="avatar-name">'+'<span class="pull-left pointer avatar">'+'<img src="'+e.identity.avatar_filename+'" alt="" width="60" height="60" />'+'<i class="lt"></i>'+"</span>"+"<h4>"+e.identity.name+"</h4>"+"</div>"+'<div class="clearfix rsvp-actions">'+'<div class="pull-right invited">'+'<div class="mates-num hide"></div>'+'<div class="pull-left together-with hide">Mates&nbsp;</div>'+'<div class="pull-right mates-info">'+'<i class="mates-add icon-plus-blue"></i>'+"</div>"+'<div class="pull-left mates-edit hide">'+'<i class="pull-left mates-minus icon14-mates-minus"></i>'+'<span class="pull-left num"></span>'+'<i class="pull-left mates-add icon14-mates-add"></i>'+"</div>"+"</div>"+'<div class="rsvp-info">'+'<div class="rsvp-content">'+'<div class="attendance"></div>'+'<div class="by">by <span class="name"></span></div>'+"</div>"+'<div class="pull-right pointer underline setto">'+(readOnly?"":'<span>set to</span> <i class="icon-rsvp-declined-red"></i>')+"</div>"+"</div>"+"</div>"+'<div class="identities">'+'<ul class="identities-list">'+"<li>"+'<i class="pull-left icon16-identity-'+e.identity.provider+'"></i>'+'<span class="oblique identity">'+ExfeeWidget.displayIdentity(e.identity,!0)+"</span>"+(readOnly?"":'<div class="identity-btn delete"><i class="icon-minus-red"></i><button class="btn-leave">Leave</button></div>')+"</li>"+"</ul>"+'<div class="identity-actions">'+"<p>"+'<span class="xalert-fail">Remove yourself?</span>'+"<br />"+'<span class="xalter-info">You will <strong>NOT</strong> be able to access any information in this <span class="x">·X·</span>. Confirm leaving?</span>'+'<button class="pull-right btn-cancel">Cancel</button>'+"</p>"+"</div>"+"</div>"+'<!--i class="expand nomore"></i-->'+"</div>"+"</div>";this.invitation=ExfeUtilities.clone(e);if(this.panelId!==r||!$(".exfeepanel").length)this.panelId=r,this.editing="",this.pre_delete=!1,this.hideTip(),this.hidePanel(),this.objBody.append(i),this.bindEvents(),$(".exfeepanel").show();this.showRsvp()},hideTip:function(){$(".tip-exfee").hide().remove()},hidePanel:function(){$(".exfeepanel").hide().remove()},showRsvp:function(){var e=this.invitation.by_identity?this.invitation.by_identity:curIdentity,t="",n=$(".exfee_pop_up .rsvp-info .setto i");switch(this.invitation.rsvp_status){case"ACCEPTED":t="DECLINED",n.toggleClass("icon-rsvp-accepted-blue",!1),n.toggleClass("icon-rsvp-declined-red",!0),n.toggleClass("icon-rsvp-noresponse",!1);break;case"DECLINED":t="NORESPONSE",n.toggleClass("icon-rsvp-accepted-blue",!1),n.toggleClass("icon-rsvp-declined-red",!1),n.toggleClass("icon-rsvp-noresponse",!0);break;case"NORESPONSE":case"IGNORED":default:t="ACCEPTED",n.toggleClass("icon-rsvp-accepted-blue",!0),n.toggleClass("icon-rsvp-declined-red",!1),n.toggleClass("icon-rsvp-noresponse",!1)}$(".exfee_pop_up .rsvp-info .setto").attr("rsvp",t),$(".exfee_pop_up .rsvp-info .attendance").html(this.arrRsvp[this.invitation.rsvp_status][0]);for(var r=1;r<10;r++)$(".exfee_pop_up .avatar-name .lt").toggleClass("icon10-plus-"+r,this.invitation.mates===r);$(".exfee_pop_up .rsvp-info .by .name").html(e?e.name:""),$(".exfee_pop_up .invited .mates-num").html("+"+this.invitation.mates),$(".exfee_pop_up .mates-edit .num").html(this.invitation.mates),e&&this.invitation.identity.id!==e.id&&this.editing==="rsvp"?$(".exfee_pop_up .rsvp-info .by").show():$(".exfee_pop_up .rsvp-info .by").hide();switch(this.editing){case"rsvp":$(".exfee_pop_up .rsvp-info").show(),$(".exfee_pop_up .rsvp-info .setto").show(),$(".exfee_pop_up .invited").hide();break;case"mates":$(".exfee_pop_up .rsvp-info").hide(),$(".exfee_pop_up .invited").show(),$(".exfee_pop_up .invited .together-with").show(),this.invitation.mates?($(".exfee_pop_up .mates-edit").show(),$(".exfee_pop_up .invited .mates-info").hide()):($(".exfee_pop_up .mates-edit").hide(),$(".exfee_pop_up .invited .mates-info").show()),$(".exfee_pop_up .invited .mates-num").hide();break;default:$(".exfee_pop_up .rsvp-info").show(),$(".exfee_pop_up .rsvp-info .setto").hide(),$(".exfee_pop_up .invited").show(),$(".exfee_pop_up .mates-edit").hide(),$(".exfee_pop_up .invited .together-with").hide(),this.invitation.mates?($(".exfee_pop_up .invited .mates-num").show(),$(".exfee_pop_up .invited .mates-info").hide()):($(".exfee_pop_up .invited .mates-num").hide(),readOnly?$(".exfee_pop_up .invited .mates-info").hide():$(".exfee_pop_up .invited .mates-info").show())}this.invitation.host?($(".exfee_pop_up .identities-list .delete i").hide(),$(".exfee_pop_up .identities-list .delete button").hide(),$(".exfee_pop_up .identity-actions").hide()):this.pre_delete?($(".exfee_pop_up .identities-list .delete i").hide(),$(".exfee_pop_up .identities-list .delete button").show(),curIdentity&&this.invitation.identity.id===curIdentity.id?($(".exfee_pop_up .identity-actions").show(),$(".exfee_pop_up .identities-list .btn-leave").html("Leave")):($(".exfee_pop_up .identity-actions").hide(),$(".exfee_pop_up .identities-list .btn-leave").html("Remove"))):($(".exfee_pop_up .identities-list .delete i").show(),$(".exfee_pop_up .identities-list .delete button").hide(),$(".exfee_pop_up .identity-actions").hide())},bindEvents:function(){$(".exfee_pop_up .mates-add").bind("click",this.matesAdd),$(".exfee_pop_up .mates-minus").bind("click",this.matesMinus),$(".exfee_pop_up .rsvp-info .setto").bind("click",this.rsvp),$(".exfee_pop_up .invited").bind("hover",function(e){if(!readOnly){switch(e.type){case"mouseenter":ExfeePanel.editing="mates";break;case"mouseleave":ExfeePanel.editing=""}ExfeePanel.showRsvp()}}),$(".exfee_pop_up .rsvp-info").bind("hover",function(e){switch(e.type){case"mouseenter":ExfeePanel.editing="rsvp";break;case"mouseleave":ExfeePanel.editing=""}ExfeePanel.showRsvp()}),$(".exfee_pop_up .identities-list .delete i").bind("click",function(e){e.stopPropagation(),ExfeePanel.pre_delete=!0,ExfeePanel.showRsvp()}),$(".exfee_pop_up .identities-list .delete button").bind("click",function(e){ExfeeWidget.delExfee(ExfeePanel.invitation.identity),ExfeePanel.hidePanel()}),$(".exfee_pop_up .identity-actions .btn-cancel").bind("click",function(e){ExfeePanel.pre_delete=!1,ExfeePanel.showRsvp()}),$(".exfee_pop_up").bind("click",function(){ExfeePanel.pre_delete=!1,ExfeePanel.showRsvp()}),$(".exfee_pop_up").on("click","span.avatar > img",function(e){window.open($(this).attr("src").replace(/\/(80_80)_/,"/original_"))}).on("mouseleave",function(e){$(this).hide(144,function(){ExfeePanel.hidePanel()})})},matesAdd:function(){ExfeePanel.invitation.mates<9&&(ExfeeWidget.changeMates(ExfeePanel.invitation.identity,++ExfeePanel.invitation.mates),ExfeePanel.showRsvp())},matesMinus:function(){ExfeePanel.invitation.mates>0&&(ExfeeWidget.changeMates(ExfeePanel.invitation.identity,--ExfeePanel.invitation.mates),ExfeePanel.showRsvp())},rsvp:function(){var e=$(this).attr("rsvp");e&&(ExfeePanel.invitation.rsvp_status=e,ExfeePanel.invitation.by_identity=ExfeUtilities.clone(curIdentity),ExfeeWidget.rsvpExfee(ExfeePanel.invitation.identity,e),ExfeePanel.showRsvp())}}}),define(function(e,t,n){var r=e("jquery"),i=[],s={title:"",description:"",by_identity:{id:0},time:{begin_at:{date_word:"",date:"",time_word:"",time:"",timezone:"",id:0,type:"EFTime"},origin:"",outputformat:1,id:0,type:"CrossTime"},place:{title:"",description:"",lng:"",lat:"",provider:"",external_id:"",id:0,type:"Place"},attribute:{state:"published"},exfee_id:0,widget:[{image:"",widget_id:0,id:0,type:"Background"}],relative:{id:0,relation:""},type:"Cross"},o={id:0,type:"Exfee",invitations:[]},u=function(e){Cross.id&&(r(".cross-opts .saving").show(),Api.request("editExfee",{type:"POST",resources:{exfee_id:Exfee.id},data:{by_identity_id:curIdentity.id,exfee:JSON.stringify(Exfee)}},function(t){r(".cross-opts .saving").hide(),e?window.location.href="/":Q.emit("app:cross:edited")},function(e){r(".cross-opts .saving").hide();var t=!e.meta||e.meta.code!==401&&e.meta.code!==403?"":"no_permission";Q.emit("app:cross:edited",{error:t})}))},a=function(e){L(),u(e)},f=function(){ExfeeCache.init(),ExfeeWidget.api_url=window._ENV_.api_url,window.GatherExfeeWidget=ExfeeWidget.make("gather-exfee",!0,a),window.CrossExfeeWidget=ExfeeWidget.make("cross-exfee",!0,a)},l=function(e){if(e){var t={by_identity_id:curIdentity.id,content:e.substr(0,233),id:0,relative:[],type:"Post",via:"exfe.com"};r(".cross-opts .saving").show(),Api.request("addConversation",{resources:{exfee_id:Exfee.id},type:"POST",data:JSON.stringify(t)},function(e){O=e.post.updated_at,r(".cross-opts .saving").hide(),_(e.post),Q.emit("app:cross:edited")},function(e){r(".cross-opts .saving").hide();var t=!e.meta||e.meta.code!==401&&e.meta.code!==403?"":"no_permission";Q.emit("app:cross:edited",{error:t})})}},c=function(){r("#cross-form-discard").bind("click",function(){window.location="/"}),r("#cross-form-gather").bind("click",function(){r("body").trigger("click");if(curIdentity)r(this).hasClass("disabled")||(r(this).prop("disabled",!0).toggleClass("disabled",!0),W());else{var e=r.trim(r("#gather-title").val());0===e.length?(r(".choose-identity .placeholder").addClass("text-error"),r(".add-identity").addClass("hide"),r(".please-identity").removeClass("hide")):r(".choose-identity .placeholder").trigger("click")}}),r(".cross-conversation .comment-form .pointer").bind("click",function(){var e=r(".cross-conversation .comment-form textarea");l(e.val()),e.val("")}),r(".cross-conversation .comment-form textarea").bind("keydown",function(e){switch(e.which){case 13:var t=r(this);e.shiftKey||(e.preventDefault(),l(t.val()),t.val(""))}})},h=function(){var e=r("#gather-title");e.bind("focus keydown keyup blur",function(t){b(e.val(),"gather")})},p=function(t){if(!r(".cross-container").length||readOnly)return;var n=Editing,i=t?t.target:null,s={title:[function(){r(".cross-title").removeAttr("editable"),r(".cross-title .show").show(),b(r(".cross-title .edit").val(),"cross"),r(".cross-title .edit").hide(),$()},function(){r(".cross-title").attr("editable",!0),r(".cross-title .show").hide(),r(".cross-title .edit").show().focus()}],description:[function(){r(".cross-description-outer").removeAttr("editable"),r(".cross-description .show").show(),r(".cross-description .edit").hide(),w(r(".cross-description .edit").val()),$()},function(){r(".cross-description-outer").attr("editable",!0),r(".cross-description .show").hide(),r(".cross-description .xbtn-more").hide(),r(".cross-description .edit").show().focus()}],time:[function(){var e=r("#date-panel");if(e.size()){var t=e.data("widget-id"),i=App.widgetCaches[t],s=r.trim(r("#date-string").data("date"));(n==="date-panel"||n==="time")&&$(),i&&i.hide()}r(".cross-date").removeAttr("editable")},function(){var t=r("#date-panel");if(t.size())return;var n=e("datepanel"),i=new n({options:{parentNode:r("#app-tmp"),srcNode:r(".cross-date"),eftime:Cross.time}});i.show(),r(".cross-date").attr("editable",!0)}],place:[function(){r(".cross-place").removeAttr("editable");var e=r("#map-panel");if(e.size()){var t=e.data("widget-id"),i=App.widgetCaches[t];if(n==="map-panel"||n==="place")Cross.place=i.place,$();i&&i.hide()}},function(){var t=r("#map-panel");if(t.size())return;var n=e("mappanel"),i=new n({options:{parentNode:r("#app-tmp"),srcNode:r(".cross-place"),place:Cross.place},update:function(e){k(e),H(e)}});i.show(),r(".cross-place").attr("editable",!0)}],rsvp:[function(){P()},function(){P(!0)}],background:[function(){},function(){t&&t.type==="dblclick"&&(n||!Cross.id)&&g(t?t.shiftKey:!1)}],exfee:[function(){r("#cross-exfee .exfee-input").val()||(r("#cross-exfee .total").css("visibility","hidden"),r("#cross-exfee .thumbnails .avatar .rb").hide()),r("#gather-exfee .exfee-input").val()||r("#gather-exfee .thumbnails .avatar .rb").hide(),ExfeeWidget.showLimitWarning(!1)},function(){}]};if(t){var o=r(i).attr("editarea");switch(o){case"rsvp":case"exfee":Editing=o}if(t.type==="click"&&(Editing||!Cross.id)||t.type==="dblclick"){Editing=o;while(i&&!Editing&&i.tagName!=="BODY")i=i.parentNode,Editing=r(i).attr("editarea")}else Editing=""}if(Editing==="background")s.background[1](),Editing=n;else{if(Editing==="map-panel")return;if(Editing==="date-panel")return;for(var u in s)s[u][~~(u===Editing)]()}},d=function(){r("body").on("click",p),r("body").on("dblclick.data-link","[editarea]",p),r(".cross-title .edit").bind("focus keydown keyup blur",function(e){if(e.type==="keydown")switch(e.which){case 13:e.shiftKey||(e.preventDefault(),p())}b(r(e.target).val(),"cross")}),r(".cross-title, .cross-description-outer, .cross-date, .cross-place").bind("hover",function(e){var t=e.type;Editing&&Editing!=="rsvp"&&(t==="mouseenter"&&!r(this).attr("editable")?r(this).addClass("cross-hover"):r(this).removeClass("cross-hover"))});var e=0;r(".cross-description").bind("mousedown mouseup",function(t){t.type==="mousedown"?e=t.clientX+t.clientY:e-=t.clientX+t.clientY}),r(".cross-description").bind("click",function(t){if(!Editing&&!e){e=0;var n=r(this),i=!n.hasClass("more");n.toggleClass("more",i).find(".xbtn-more").toggleClass("xbtn-less",i)}}),r(".cross-description .xbtn-more").bind("click",function(e){e.stopPropagation();var t=!r(this).hasClass("xbtn-less");r(".cross-description").toggleClass("more",t),r(this).toggleClass("xbtn-less",t)}),r(".cross-rsvp").bind("mouseenter mouseover mouseleave",function(e){if(!readOnly)switch(e.type){case"mouseenter":case"mouseover":r(".cross-rsvp .show .accepted").hide(),r(".cross-rsvp .show .change").show(),r(".cross-rsvp .show .by strong").html()&&r(".cross-rsvp .show .by").show();break;case"mouseleave":r(".cross-rsvp .show .accepted").show(),r(".cross-rsvp .show .change").hide(),r(".cross-rsvp .show .by").hide()}}),r(".cross-rsvp .edit .accept").bind("click",function(){ExfeeWidget.rsvpMe("ACCEPTED"),P()}),r(".cross-rsvp .edit .decline").bind("click",function(){ExfeeWidget.rsvpMe("DECLINED"),P()}),r(".cross-rsvp .edit .interested").bind("click",function(){ExfeeWidget.rsvpMe("INTERESTED"),P()}),r(".cross-place .edit").bind("keydown",function(e){e.shiftKey&&e.which===13&&(e.which=4)}),r(".cross-place .xbtn-more").bind("click",function(e){e.stopPropagation();var t=!r(this).hasClass("xbtn-less");r(".cross-dp.cross-place > address").toggleClass("more",t),r(this).toggleClass("xbtn-less",t)}),r(".ids-popmenu > ol > li").live("mouseenter mousedown",function(e){switch(e.type){case"mouseenter":ExfeeWidget.selectCompleteItem(r(this).index());break;case"mousedown":ExfeeWidget.useCompleteItem(r(this).index())}})},v=function(){Cross.title.length||(Cross.title=curIdentity?"Meet "+curIdentity.name:"Gather a ·X·")},m=function(){var e=new Date,t=K.formatDate(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate());Cross.time={begin_at:{date_word:"",date:t,time_word:"",time:"",timezone:ExfeUtilities.getTimezone(),id:0,type:"EFTime"},origin:t,outputformat:0,id:0,type:"CrossTime"},r(".cross-date .edit").val(t)},g=function(e){var t=ExfeUtilities.clone(window._ENV_.backgrounds);t.push("");for(var n=0;n<Cross.widget.length;n++)if(Cross.widget[n].type==="Background")break;if(e)Cross.widget[n].image="";else{var r=Cross.widget[n].image;do Cross.widget[n].image=t[parseInt(Math.random()*t.length)];while(r===Cross.widget[n].image)}A()},y=function(){ExfeeWidget.addExfee(curIdentity,!0,"ACCEPTED")},b=function(e,t){Cross.title=ExfeUtilities.trim(e),x(t)},w=function(e){Cross.description=ExfeUtilities.trim(e),T()},E=function(e){Cross.place=ExfeUtilities.parsePlacestring(e),k(Cross.place)},S=function(){curIdentity&&r(".choose-identity").html('<img src="'+curIdentity.avatar_filename+'">')},x=function(e){Cross.title.length&&r(".choose-identity .placeholder").hasClass("text-error")&&(r(".choose-identity .placeholder").removeClass("text-error"),r(".add-identity").removeClass("hide"),r(".please-identity").addClass("hide"));var t=Cross.title.length?ExfeUtilities.escape(Cross.title):"Gathering for what?";r(".cross-title .show").html(t),r(".cross-title").removeClass("single-line").removeClass("double-line"),r(".cross-title h1").height()>50?r(".cross-title").addClass("double-line").removeClass("single-line"):r(".cross-title").addClass("single-line").removeClass("double-line"),document.title="EXFE - "+Cross.title;switch(e){case"gather":r(".cross-title .edit").val(Cross.title);break;case"cross":r("#gather-title").val(Cross.title);break;default:r(".cross-title .edit").val(Cross.title),r("#gather-title").val(Cross.title)}},T=function(){var e=r(".cross-description .xbtn-more").hasClass("xbtn-less"),t="";r(".cross-description").toggleClass("more",!0),r(".cross-description .xbtn-more").toggleClass("xbtn-less",!1),Cross.description?(t=ExfeUtilities.escape(Cross.description).replace(/\r\n|\r|\n/g,"<br>"),r(".cross-description .show").toggleClass("gray",!1).toggleClass("gsd",!1)):(t="Click here to describe something about this ·X·.",r(".cross-description .show").toggleClass("gray",!0).toggleClass("gsd",!Cross.id)),r(".cross-description .show").html()!==t&&r(".cross-description .show").html(t),r(".cross-description .show").height()>180?(r(".cross-description").toggleClass("more",!1),r(".cross-description .xbtn-more").show(),e&&(r(".cross-description").toggleClass("more",!0),r(".cross-description .xbtn-more").toggleClass("xbtn-less",!0))):r(".cross-description .xbtn-more").hide(),r(".cross-description .edit").val(Cross.description),Editing&&Editing!=="rsvp"||Cross.description||!Cross.id?r(".cross-description").show():r(".cross-description").hide()},N=function(){C(),D()},C=function(){function e(e){if(e=ExfeUtilities.trim(e)){var t=e.split(":");if(t.length===2){var n=parseInt(t[0],10)*60*60,r=parseInt(t[1],10)*60;return n+(n>0?r:-r)}}return null}var t=e(Cross.time.begin_at.timezone),n=e(ExfeUtilities.getTimezone()),i=t===n&&window._ENV_.timevalid,s="",o="",u="YYYY-MM-DD",a="Pick a time.",f=!1;if(Cross.time.origin){var l=K.printEFTime(Cross.time,"X");s=l.content,o=l.title}else s=a,o="Sometime",f=!0;r(".cross-date h2").html(o),r(".cross-time").html(s).toggleClass("gray",f)},k=function(e){r(".cross-dp.cross-place > h2").html(e.title?ExfeUtilities.escape(e.title):"Somewhere"),r(".cross-dp.cross-place > address").toggleClass("more",!0),r(".cross-dp.cross-place .xbtn-more").toggleClass("xbtn-less",!1),e.description?r(".cross-dp.cross-place > address").html(ExfeUtilities.escape(e.description).replace(/\r\n|\r|\n/g,"<br>")).toggleClass("gray",!1):r(".cross-dp.cross-place > address").html("Choose a place.").toggleClass("gray",!0),r(".cross-dp.cross-place > address").height()>80?(r(".cross-dp.cross-place > address").toggleClass("more",!1),r(".cross-dp.cross-place .xbtn-more").show()):r(".cross-dp.cross-place .xbtn-more").hide()},L=function(){window.GatherExfeeWidget.showAll(!0),window.CrossExfeeWidget.showAll(!1,!0)},A=function(){for(var e=0;e<Cross.widget.length;e++)if(Cross.widget[e].type==="Background")break;r(".x-gather").toggleClass("no-bg",!1),r(".cross-background").css("background-image","url(/static/img/xbg/"+(Cross.widget[e].image?Cross.widget[e].image:"default.jpg")+")")},O="",M=function(e,t){i=e;for(var n=i.length-1;n>=0;n--)n||(O=i[n].created_at),_(i[n],t)},_=function(e,t){var n=ExfeUtilities.escape(e.content).replace(/\r\n|\n\r|\r|\n/g,"\n"),i='<div class="avatar-comment"><span class="pull-left avatar"><img alt="" src="'+e.by_identity.avatar_filename+'" width="40" height="40" />'+"</span>"+'<div class="comment">'+"<p>"+'<span class="author"><strong>'+e.by_identity.name+"</strong>:&nbsp;</span>"+ExfeUtilities.escape(e.content).replace(/\r\n|\n\r|\r|\n/g,"<br>")+'<span class="pull-right date">'+'<time data-iso-time="'+K.toISO(e.created_at)+'"></time>'+"</span>"+"</p>"+"</div>"+"</div>";r(".conversation-timeline").prepend(i),t&&window.webkitNotifications&&window.webkitNotifications.checkPermission()===0&&window.webkitNotifications.createNotification(null,"EXFE - "+Cross.title,e.by_identity.name+": "+n).show()},D=function(){r("time[data-iso-time]").each(function(){var e=r(this);e.text(K(e.data("iso-time")))})},P=function(e){var t=ExfeeWidget.getMyInvitation();if(t){var n=t.by_identity?t.by_identity:curIdentity,i=t.identity.id===n.id;if(t.rsvp_status==="NORESPONSE"||t.rsvp_status==="IGNORED"||e){i?r(".cross-rsvp .edit .by").hide():(r(".cross-rsvp .edit .by .avatar img").attr("src",t.by_identity.avatar_filename),r(".cross-rsvp .edit .by strong").html(t.by_identity.name),r(".cross-rsvp .edit .by").show()),r(".cross-rsvp .show").hide(),r(".cross-rsvp .edit").fadeIn(233);return}if(t.rsvp_status==="ACCEPTED"||t.rsvp_status==="INTERESTED"||t.rsvp_status==="DECLINED"){var s="";switch(t.rsvp_status){case"ACCEPTED":s="Accepted";break;case"DECLINED":s="Unavailable";break;case"INTERESTED":s="Interested"}i||t.rsvp_status==="INTERESTED"?(r(".cross-rsvp .show .by").hide(),r(".cross-rsvp .show .by strong").html("")):(r(".cross-rsvp .show .by .avatar img").attr("src",t.by_identity.avatar_filename),r(".cross-rsvp .show .by strong").html(t.by_identity.name),r(".cross-rsvp .show .by").show());var o=ExfeeWidget.summary(),u="";for(var a=0;a<Math.min(o.accepted_invitations.length,5);a++)u+='<li><span class="avatar alt40"><img height="20" width="20" alt="" src="'+o.accepted_invitations[a].identity.avatar_filename+'">'+(o.accepted_invitations[a].mates?'<i class="icon10-plus-'+o.accepted_invitations[a].mates+'"></i>':"")+"</span></li>";u+=o.accepted?"<li><span>"+o.accepted+" accepted.</span></li>":"";var f=r(".cross-rsvp .show .accepted");f.text()!==r(u).text()&&f.html(u),r(".cross-rsvp .show .by").hide(),r(".cross-rsvp .show .change").hide(),r(".cross-rsvp .show .attendance").html(s),r(".cross-rsvp .show").fadeIn(233),r(".cross-rsvp .edit").hide();return}}r(".cross-rsvp .show").hide(),r(".cross-rsvp .edit").hide()},H=function(e){function i(t){var i=t.coords;n=n.replace(/\{\{lat\}\}/ig,i.latitude).replace(/\{\{lng\}\}/ig,i.longitude).replace(/\{\{title\}\}/ig,(e.provider===""?i.latitude+","+i.longitude+" ":"")+encodeURIComponent(e.title)),r(".cross-map").append(n)}r(".cross-map").empty();var t=e.lat.length&&e.lng.length,n='<a target="_blank" href="https://maps.google.com/maps?key='+_ENV_.MAP_KEY+'&q={{title}}&hl=en&ie=UTF8&sll={{lat}},{{lng}}&t=m&z=16"><img style="border-radius: 3px; box-shadow: 2px 2px 4px rgba(0, 0, 0, .25);" src="https://maps.googleapis.com/maps/api/staticmap?center={{lat}},{{lng}}&markers=icon%3a'+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+'%7C{{lat}},{{lng}}&zoom=13&size=280x140&maptype=road&sensor=false" alt="" width="280" height="140" /></a>';t&&i({coords:{latitude:e.lat,longitude:e.lng}})},B=function(){x(),T(),k(Cross.place),L(),A(),P(),H(Cross.place)},j=function(e){var t={resources:{exfee_id:Exfee.id}};O&&(t.params={updated_at:O}),Api.request("conversation",t,function(t){M(t.conversation,e)})},F=function(){j(!0)},I=function(){readOnly?r("#conversation-form").hide():(r("#conversation-form span.avatar img").attr("src",curIdentity.avatar_filename),r("#conversation-form").show()),r(".conversation-timeline").html(""),r(".cross-conversation").slideDown(233),j(),convTimer=setInterval(F,233e3)},q=function(e,t){Cross.id=e.id,Cross.title=e.title,Cross.description=e.description,Cross.time=e.time,Cross.place=e.place,Cross.widget=e.widget,Cross.exfee_id=e.exfee.id,Exfee=e.exfee,readOnly=t,G=V(),typeof Cross.time!="undefined"&&typeof Cross.time.begin_at!="undefined"&&!Cross.time.begin_at.timezone&&(Cross.time.begin_at.timezone=ExfeUtilities.getTimezone()),r(".cross-date  .edit").val(Cross.time.origin),r(".cross-place .edit").val(Cross.place.title+(Cross.place.description?"\n"+Cross.place.description:""));for(var n=0;n<Exfee.invitations.length;n++)if(ExfeeWidget.isMyIdentity(Exfee.invitations[n].identity)){curIdentity=ExfeUtilities.clone(Exfee.invitations[n].identity);break}B(),I()},R=function(e){Api.request("getCross",{resources:{cross_id:e}},function(e){q(e.cross,!1)},function(t){Q.emit("app:cross:forbidden",e)})},U=function(){window.Cross=ExfeUtilities.clone(s),window.Exfee=ExfeUtilities.clone(o)},z=function(){readOnly=!1,U(),g(),v(),m(),y(),B(),J()},W=function(){r(".cross-opts .saving").show();var e=ExfeUtilities.clone(Cross);e.exfee=ExfeUtilities.clone(Exfee),e.by_identity={id:curIdentity.id},Api.request("gather",{type:"POST",data:JSON.stringify(e)},function(e){r(".cross-opts .saving").hide(),document.location="/#!"+e.cross.id},function(e){r(".cross-opts .saving").hide(),r("#cross-form-gather").prop("disabled",!1).toggleClass("disabled",!1)})},X=function(){r(".cross-opts .saving").show();var e=ExfeUtilities.clone(Cross);e.by_identity={id:curIdentity.id},Api.request("editCross",{type:"POST",resources:{cross_id:Cross.id},data:JSON.stringify(e)},function(e){r(".cross-opts .saving").hide(),Q.emit("app:cross:edited")},function(e){r(".cross-opts .saving").hide();var t=!e.meta||e.meta.code!==401&&e.meta.code!==403?"":"no_permission";Q.emit("app:cross:edited",{error:t})})},V=function(){return JSON.stringify({id:Cross.id,title:Cross.title,description:Cross.description,time:Cross.time.origin+", "+Cross.time.begin_at.date+", "+Cross.time.begin_at.time,place:{title:Cross.place.title,description:Cross.place.description,lat:Cross.place.lat,lng:Cross.place.lng,updated_at:Cross.place.updated_at},background:Cross.widget[0].image})},$=function(){if(Cross.id){var e=V();G!==e&&(X(),G=e)}},J=function(e){e?(r(".cross-form").slideUp(233),r(".cross-edit").show(233)):(S(),r(".cross-form").slideDown(233),r(".cross-edit").hide(233),r("#gather-title").select(),r("#gather-title").focus())};window.Store=e("store"),window.Api=e("api"),window.webkitNotifications&&window.webkitNotifications.requestPermission(function(){});var K=e("humantime");window.curIdentity=null,window.readOnly=!1;var Q=e("bus"),G="";Q.on("xapp:cross:main",function(){var t=Store.get("authorization");window.User=t?Store.get("user"):null,User&&(Api.setToken(t.token),curIdentity=ExfeUtilities.clone(User.identities[0])),U(),f(),c(),h(),Editing="",d(),Marked=e("marked"),window.ExfeePanel=e("exfeepanel"),window.showtimeTimer=setInterval(N,50),window.convTimer=null}),Q.on("xapp:cross",function(t,n,i,s,o,u){if(t>0){R(t);var a=new(e("photoxwidget"))({options:{crossId:t,parentNode:r(".cross-photox")}});a.show()}else t===null?(n&&(curIdentity=n,Api.setToken(o)),q(i,s),u&&(ExfeeWidget.rsvpMe("ACCEPTED"),P())):z()}),Q.on("app:user:signin:after",function(){if(window.Cross&&!window.Cross.id){var e=Store.get("authorization");window.User=e?Store.get("user"):null,User&&(Api.setToken(e.token),curIdentity=ExfeUtilities.clone(User.identities[0]),S(),y())}}),Q.on("xapp:cross:end",function(){clearTimeout(window.showtimeTimer),clearTimeout(window.convTimer)}),r(document.body).on("hover","div.lock-tag",function(e){var t=e.type,n=r(this).offset();t==="mouseenter"?r('<div class="tooltip tip-lock" id="app-tip-lock"><div class="inner"><div>This <span class="x">·X·</span> is private.</div><div>Accessible to only attendees.</div></div></div>').css({left:n.left-135,top:n.top+25}).appendTo(document.body):r("#app-tip-lock").remove()})});var MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,i,s,o;return i=e&2147483648,s=t&2147483648,n=e&1073741824,r=t&1073741824,o=(e&1073741823)+(t&1073741823),n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s}function r(e,t,n){return e&t|~e&n}function i(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function u(e,i,s,o,u,a,f){return e=n(e,n(n(r(i,s,o),u),f)),n(t(e,a),i)}function a(e,r,s,o,u,a,f){return e=n(e,n(n(i(r,s,o),u),f)),n(t(e,a),r)}function f(e,r,i,o,u,a,f){return e=n(e,n(n(s(r,i,o),u),f)),n(t(e,a),r)}function l(e,r,i,s,u,a,f){return e=n(e,n(n(o(r,i,s),u),f)),n(t(e,a),r)}function c(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=Array(s-1),u=0,a=0;while(a<n)t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o}function h(e){var t="",n="",r,i;for(i=0;i<=3;i++)r=e>>>i*8&255,n="0"+r.toString(16),t+=n.substr(n.length-2,2);return t}function p(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t}var d=Array(),v,m,g,y,b,w,E,S,x,T=7,N=12,C=17,k=22,L=5,A=9,O=14,M=20,_=4,D=11,P=16,H=23,B=6,j=10,F=15,I=21;e=p(e),d=c(e),w=1732584193,E=4023233417,S=2562383102,x=271733878;for(v=0;v<d.length;v+=16)m=w,g=E,y=S,b=x,w=u(w,E,S,x,d[v+0],T,3614090360),x=u(x,w,E,S,d[v+1],N,3905402710),S=u(S,x,w,E,d[v+2],C,606105819),E=u(E,S,x,w,d[v+3],k,3250441966),w=u(w,E,S,x,d[v+4],T,4118548399),x=u(x,w,E,S,d[v+5],N,1200080426),S=u(S,x,w,E,d[v+6],C,2821735955),E=u(E,S,x,w,d[v+7],k,4249261313),w=u(w,E,S,x,d[v+8],T,1770035416),x=u(x,w,E,S,d[v+9],N,2336552879),S=u(S,x,w,E,d[v+10],C,4294925233),E=u(E,S,x,w,d[v+11],k,2304563134),w=u(w,E,S,x,d[v+12],T,1804603682),x=u(x,w,E,S,d[v+13],N,4254626195),S=u(S,x,w,E,d[v+14],C,2792965006),E=u(E,S,x,w,d[v+15],k,1236535329),w=a(w,E,S,x,d[v+1],L,4129170786),x=a(x,w,E,S,d[v+6],A,3225465664),S=a(S,x,w,E,d[v+11],O,643717713),E=a(E,S,x,w,d[v+0],M,3921069994),w=a(w,E,S,x,d[v+5],L,3593408605),x=a(x,w,E,S,d[v+10],A,38016083),S=a(S,x,w,E,d[v+15],O,3634488961),E=a(E,S,x,w,d[v+4],M,3889429448),w=a(w,E,S,x,d[v+9],L,568446438),x=a(x,w,E,S,d[v+14],A,3275163606),S=a(S,x,w,E,d[v+3],O,4107603335),E=a(E,S,x,w,d[v+8],M,1163531501),w=a(w,E,S,x,d[v+13],L,2850285829),x=a(x,w,E,S,d[v+2],A,4243563512),S=a(S,x,w,E,d[v+7],O,1735328473),E=a(E,S,x,w,d[v+12],M,2368359562),w=f(w,E,S,x,d[v+5],_,4294588738),x=f(x,w,E,S,d[v+8],D,2272392833),S=f(S,x,w,E,d[v+11],P,1839030562),E=f(E,S,x,w,d[v+14],H,4259657740),w=f(w,E,S,x,d[v+1],_,2763975236),x=f(x,w,E,S,d[v+4],D,1272893353),S=f(S,x,w,E,d[v+7],P,4139469664),E=f(E,S,x,w,d[v+10],H,3200236656),w=f(w,E,S,x,d[v+13],_,681279174),x=f(x,w,E,S,d[v+0],D,3936430074),S=f(S,x,w,E,d[v+3],P,3572445317),E=f(E,S,x,w,d[v+6],H,76029189),w=f(w,E,S,x,d[v+9],_,3654602809),x=f(x,w,E,S,d[v+12],D,3873151461),S=f(S,x,w,E,d[v+15],P,530742520),E=f(E,S,x,w,d[v+2],H,3299628645),w=l(w,E,S,x,d[v+0],B,4096336452),x=l(x,w,E,S,d[v+7],j,1126891415),S=l(S,x,w,E,d[v+14],F,2878612391),E=l(E,S,x,w,d[v+5],I,4237533241),w=l(w,E,S,x,d[v+12],B,1700485571),x=l(x,w,E,S,d[v+3],j,2399980690),S=l(S,x,w,E,d[v+10],F,4293915773),E=l(E,S,x,w,d[v+1],I,2240044497),w=l(w,E,S,x,d[v+8],B,1873313359),x=l(x,w,E,S,d[v+15],j,4264355552),S=l(S,x,w,E,d[v+6],F,2734768916),E=l(E,S,x,w,d[v+13],I,1309151649),w=l(w,E,S,x,d[v+4],B,4149444226),x=l(x,w,E,S,d[v+11],j,3174756917),S=l(S,x,w,E,d[v+2],F,718787259),E=l(E,S,x,w,d[v+9],I,3951481745),w=n(w,m),E=n(E,g),S=n(S,y),x=n(x,b);var q=h(w)+h(E)+h(S)+h(x);return q.toLowerCase()};