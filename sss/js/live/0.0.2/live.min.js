define("live",function(e){"use strict";function O(){navigator.geolocation.clearWatch(A)}function M(){A=navigator.geolocation.watchPosition(function(e){e&&e.coords&&e.coords.latitude&&e.coords.longitude&&e.coords.accuracy&&(c.latitude=e.coords.latitude.toString(),c.longitude=e.coords.longitude.toString(),c.accuracy=e.coords.accuracy.toString(),u=o-5,m("Location update: lat = "+c.latitude+", "+"lng = "+c.longitude+", "+"acu = "+c.accuracy))})}var t=window._ENV_,n=t.streaming_api_url,r=t.api_url,i=e("store"),s="",o=30,u=o,a=!1,f=null,l="",c={card:{id:"",name:"",avatar:"",bio:"",identities:[],timestamp:0},latitude:"",longitude:"",accuracy:"",traits:[]},h=Date.now||function(){return(new Date).getTime()},n=n,p=null,d=null,v=null,m=function(e,t){if(a){var n=Object.prototype.toString.call(e),r=(new Date).toString();n!=="[object String]"&&n!=="[object Number]"&&(e=JSON.stringify(e)),console.log(r.replace(/^.*(\d{2}:\d{2}:\d{2}).*$/,"$1")+" - "+e),t&&console.table&&console.table(t)}},g=function(){u=0,m("Breathe with"+(s?" token: "+s:"out token")),p&&p.abort(),p=$.ajax({type:"post",url:n+"/v3/live/cards"+(s?"?token="+s:""),data:JSON.stringify(c),success:function(e){var t=e;t&&t.length&&(u=0,s!==t[0]&&(m("Got new token: "+t[0]+", id: "+t[1]),E.live&&(E.kill(),m("Close current stream")),u=o),s=t[0],c.card.id=t[1])},error:function(e){e.status&&e.status>=400&&e.status<=499?(s&&m("Repeal token: "+s),s="",u=o):(u=o-5,m("Network error"))}}),!E.live&&s&&(E.init(n+"/v3/live/streaming?token="+s,y,b),m("Streaming with token: "+s))},y=function(e){if(e&&e.length){var t=JSON.parse(e[e.length-1]);if(t&&t.length){var n={};for(var i in t)t[i].id&&(t[i].id===c.card.id?(c.card.name=t[i].name,c.card.avatar=t[i].avatar,c.card.bio=t[i].bio,c.card.identities=t[i].identities,c.card.timestamp=t[i].timestamp):(t[i].avatar||(t[i].avatar=encodeURI(r+"/avatar/default?name="+t[i].name)),n[t[i].id]=t[i]));var s={me:N(c.card),others:n},o=JSON.stringify(s);m("Streaming pops: "+o,n),f&&l!==o&&(m("Callback"),f(s),l=o)}else m("Data error")}},b=function(){m("Streaming is dead")},w=function(){T(c.card)&&++u>=o&&g()},E={prvLen:null,nxtIdx:null,timer:null,http:null,pop:null,dead:null,live:!1,init:function(e,t,n){this.prvLen=0,this.nxtIdx=0,this.live=!0,this.pop=t,this.dead=n,this.http=new XMLHttpRequest,this.http.open("post",e),this.http.onreadystatechange=this.listen,this.http.send(),this.timer=setInterval(this.listen,1e3)},listen:function(){if(E.http.readyState!==4&&E.http.readyState!==3||E.http.readyState===3&&E.http.status!==200||E.http.responseText===null)return;E.http.readyState===4&&E.http.status!==200&&E.kill();while(E.prvLen!==E.http.responseText.length){if(E.http.readyState===4&&E.prvLen===E.http.responseText.length)break;E.prvLen=E.http.responseText.length;var e=E.http.responseText.substring(E.nxtIdx),t=e.split("\n");E.nxtIdx+=e.lastIndexOf("\n")+1,(e[e.length-1]!=="\n"||!t[t.length])&&t.pop(),E.pop&&E.pop(t)}E.http.readyState===4&&E.prvLen===E.http.responseText.length&&E.kill()},kill:function(){clearInterval(this.timer),this.http&&this.http.abort(),this.dead&&this.dead(),this.live=!1}},S=function(){if(typeof window.DeviceMotionEvent=="undefined")return null;var e=50,t=0,n=0,r=0,i=0,s=0,o=0;window.addEventListener("devicemotion",function(e){t=e.accelerationIncludingGravity.x,n=e.accelerationIncludingGravity.y,r=e.accelerationIncludingGravity.z},!1),setInterval(function(){var u=Math.abs(t-i+n-s+r-o);u>e&&(d&&d(),v&&setTimeout(v,1e3)),i=t,s=n,o=r},100)},x=function(e){return e&&e.external_username&&e.provider?!0:!1},T=function(e){if(e&&e.name&&e.identities&&e.identities.length){for(var t in e.identities)if(x(e.identities[t])===!1)return!1;return!0}},N=function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var n in e)t[n]=N(e[n]);break;case"[object Array]":t=[];for(n in e)t.push(N(e[n]));break;default:t=e}return t},C={init:function(e,t){T(e)?(E.kill(),c.card.name=e.name,c.card.avatar=e.avatar,c.card.bio=e.bio,c.card.identities=N(e.identities),c.card.timestamp=h(),m("Set my card: "+JSON.stringify(c.card))):m("Card error"),t&&(f=t,m("Set callback function")),u=o},shake:function(e,t){d=e,v=t},startGeo:M,stopGeo:O},k=setInterval(w,1e3),L=S(d,v),A;return window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,0)},0)}),C});