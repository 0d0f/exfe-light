define("mobileroutes",function(e,t,n){"use strict";var r=e("store"),i=e("handlebars"),s=e("humantime"),o=window._ENV_,u=function(e){var t=s.printEFTime(e,"X");return t},a=e("mobilecontroller"),f=a.HomeController,l=a.SetPasswordController,c=a.VerifyController,h=a.CrossController,p=a.LiveController,d=function(e,t,n,s,a,f){s||(s={}),$.ajax({type:"POST",url:o.api_url+"/Crosses/GetCrossByInvitationToken",data:n,success:function(n){var o=n.meta,l=o&&o.code;if(l&&l===200){var c=n.response,p=c.cross,d={id:p.id,title:p.title,description:p.description.replace(/\r\n|\r|\n/g,"<br />"),time:{title:"Sometime",content:"To be decided"},place:{title:"Somewhere",description:"To be decided"},background:"default.jpg",read_only:!!c.read_only},v=p.time;v&&v.begin_at&&v.begin_at.origin&&v.begin_at.timezone?d.time=u(v):d.time.tobe="tobe";var m=p.place;m&&m.title&&(d.place={title:m.title,description:m.description.replace(/\r\n|\r|\n/g,"<br />")});var g=m.lat,y=m.lng;if(g&&y){var b=window.devicePixelRatio>=2?2:1;d.place.map="https://maps.googleapis.com/maps/api/staticmap?center="+g+","+y+"&markers=icon%3a"+encodeURIComponent("http://img.exfe.com/web/map_pin_blue.png")+"%7C"+g+","+y+"&zoom=13&size=290x100&maptype=road&sensor=false&scale="+b,d.place.href="http://maps.google.com/maps?daddr="+encodeURIComponent(d.place.title)+"@"+g+","+y}else d.place.tobe="tobe";var w=p.widget,E;if(w&&(E=w.length))for(var S=0;S<E;++S)if(w[S].type==="Background"){d.background=w[S].image;break}var x=0,T=0,N=c.authorization;N?(x=N.user_id,c.browsing_identity&&(T=c.browsing_identity.id)):c.browsing_identity&&c.browsing_identity.connected_user_id&&(x=c.browsing_identity.connected_user_id,T=c.browsing_identity.id),c.cross_access_token&&(f=s[a]=c.cross_access_token,r.set("cats",s));var C=p.exfee.invitations,k=[],L={ACCEPTED:[],INTERESTED:[],NORESPONSE:[],IGNORED:[],DECLINED:[]};for(var A=0,O=C.length;A<O;++A){var M=C[A],_="pending",D=M.rsvp_status;D==="ACCEPTED"?_="accepted":D==="DECLINED"&&(_="declined"),M.rsvp_style=_,x&&x===M.identity.connected_user_id||T===M.identity.id?(M.is_me=!0,T=M.identity.id,T!==M.invited_by.id&&(d.inviter=M.invited_by),M.isphone=M.provider==="phone",d.identity=M.identity,L.ACCEPTED.unshift(M)):M.rsvp_status in L&&L[M.rsvp_status].push(M)}k=[].concat(L.ACCEPTED,L.INTERESTED,L.NORESPONSE,L.IGNORED,L.DECLINED),d.invitations=[],O=k.length;var P=0;while(P<O)d.invitations.push(k.splice(0,5)),P+=5;O=d.invitations.length;var H=d.invitations[O-1],B=H.length;if(B&&B<5)while(5-B++)H.push(void 0);var j="";x&&(N?(j=d.id+"?user_id="+x+"&token="+N.token+"&identity_id="+T,f=N.token,r.set("authorization",N)):(N=r.get("authorization"),N&&N.user_id===x&&(j=d.id+"?user_id="+x+"&token="+N.token+"&identity_id="+T,f=N.token)));var F=e.app,I=F.controllers,q=I.cross;q&&q.destory();var R=i.compile($("#cross-tmpl").html());q=F.controllers.cross=new h({options:{template:R(d)},cross:d,exfee_id:p.exfee.id,token:f}),q.emit("show"),F.controllers.footer.emit("show-from-cross",p.exfee.id,f,j)}else e.error={code:404},t.redirect("/")},error:function(){e.error={code:404},t.redirect("/")}})};n.exports={index:function(e){var t=e.error,n=e.app,r=n.controllers,i=r.home,s=r.footer,o=n.screen;i||(i=n.controllers.home=new f({options:{template:$("#home-tmpl").html()}})),document.title="EXFE - A utility for gathering with friends.",i.emit("show",o,t),s.emit("show",o,!1,!1,t===!0),delete e.error,n.currPageName="HOME"},verify:function(e,t){var n=e.session,r=n.resolveToken,i=e.app;if(r){$("#app-header").removeClass("hide");var s=new c({options:{template:$("#verify-tmpl").html()},resolveToken:r});s.emit("show",e,t)}else e.error=!0,t.redirect("/");i.currPageName="VERIFY"},setPassword:function(e,t){var n=e.session,r=n.resolveToken,i=e.app;if(r){$("#app-header").removeClass("hide");var s=new l({options:{template:$("#setpassword-tmpl").html()},resolveToken:r,token:r.origin_token});s.emit("show",e,t)}else e.error=!0,t.redirect("/");i.currPageName="SET_PASSWORD"},resolveToken:function(e,t){var n=e.app,r=e.params[0],i=function(e,t){e.error={code:404},t.redirect("/")};r?$.ajax({type:"POST",url:o.api_url+"/Users/ResolveToken",data:{token:r},success:function(n){if(n&&n.meta&&n.meta.code===200){var s=e.session;s.resolveToken=n.response;var o=s.resolveToken.action;o==="VERIFIED"?t.redirect("/#verify"):o==="INPUT_NEW_PASSWORD"&&(s.resolveToken.origin_token=r,t.redirect("/#set_password"))}else i(e,t)},error:function(){i(e,t)}}):i(e,t),n.currPageName="RESOLVE_TOKEN"},crossPhoneToken:function(e,t){var n=e.app,i=e.params,s=i[0],o=i[1],u=r.get("cats"),a,f;a={invitation_token:o,cross_id:s},u&&(f=u[o])&&(a.cross_access_token=f),d(e,t,a,u,o,f),n.currPageName="CROSS"},crossToken:function(e,t){var n=e.app,i=e.params[0],s=r.get("cats"),o={invitation_token:i},u;s&&(u=s[i])&&(o.cross_access_token=u),d(e,t,o,s,i,u),n.currPageName="CROSS"},live:function(e){var t=e.app,n=t.controllers,r=n.live;r&&r.destory(),r=t.controllers.live=new p({options:{template:$("#live-tmpl").html()}}),r.emit("show",t.screen,t.ios),t.currPageName="LIVE"}}});